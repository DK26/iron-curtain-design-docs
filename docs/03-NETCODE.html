<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Network Architecture - Iron Curtain — Design Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Design docs for a Rust-native Red Alert RTS engine">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-5d435b9e.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-6f79e187.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Iron Curtain — Design Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/DK26/iron-curtain-design-docs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>
                        <a href="https://github.com/DK26/iron-curtain-design-docs/edit/main/src/03-NETCODE.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <span class=fa-svg id="git-edit-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M421.7 220.3l-11.3 11.3-22.6 22.6-205 205c-6.6 6.6-14.8 11.5-23.8 14.1L30.8 511c-8.4 2.5-17.5 .2-23.7-6.1S-1.5 489.7 1 481.2L38.7 353.1c2.6-9 7.5-17.2 14.1-23.8l205-205 22.6-22.6 11.3-11.3 33.9 33.9 62.1 62.1 33.9 33.9zM96 353.9l-9.3 9.3c-.9 .9-1.6 2.1-2 3.4l-25.3 86 86-25.3c1.3-.4 2.5-1.1 3.4-2l9.3-9.3H112c-8.8 0-16-7.2-16-16V353.9zM453.3 19.3l39.4 39.4c25 25 25 65.5 0 90.5l-14.5 14.5-22.6 22.6-11.3 11.3-33.9-33.9-62.1-62.1L314.3 67.7l11.3-11.3 22.6-22.6 14.5-14.5c25-25 65.5-25 90.5 0z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="03--network-architecture"><a class="header" href="#03--network-architecture">03 — Network Architecture</a></h1>
<h2 id="core-design-pluggable-network-model"><a class="header" href="#core-design-pluggable-network-model">Core Design: Pluggable Network Model</a></h2>
<p>The network layer is fully abstracted behind a trait. The simulation and game loop never know which network model is running.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait NetworkModel: Send + Sync {
    /// Local player submits an order
    fn submit_order(&amp;mut self, order: TimestampedOrder);
    /// Poll for the next tick's confirmed orders (None = not ready yet)
    fn poll_tick(&amp;mut self) -&gt; Option&lt;TickOrders&gt;;
    /// Report local sim hash for desync detection
    fn report_sync_hash(&amp;mut self, tick: u64, hash: u64);
    /// Connection/sync status
    fn status(&amp;self) -&gt; NetworkStatus;
    /// Diagnostic info (latency, packet loss, etc.)
    fn diagnostics(&amp;self) -&gt; NetworkDiagnostics;
}
<span class="boring">}</span></code></pre>
<h3 id="planned-implementations"><a class="header" href="#planned-implementations">Planned Implementations</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Implementation</th><th>Use Case</th><th>Priority</th></tr>
</thead>
<tbody>
<tr><td><code>LocalNetwork</code></td><td>Single player, tests</td><td>Phase 2</td></tr>
<tr><td><code>ReplayPlayback</code></td><td>Watching replays</td><td>Phase 2</td></tr>
<tr><td><code>LockstepNetwork</code></td><td>OpenRA-style multiplayer</td><td>Phase 5</td></tr>
<tr><td><code>RelayLockstepNetwork</code></td><td>Relay server with time authority</td><td>Phase 5</td></tr>
<tr><td><code>FogAuthoritativeNetwork</code></td><td>Anti-maphack (server runs sim)</td><td>Future</td></tr>
<tr><td><code>RollbackNetwork</code></td><td>GGPO-style (requires sim snapshots)</td><td>Future</td></tr>
<tr><td><code>ProtocolAdapter&lt;N&gt;</code></td><td>Cross-engine compatibility wrapper</td><td>Future</td></tr>
</tbody>
</table>
</div>
<h3 id="benefits-of-trait-abstraction"><a class="header" href="#benefits-of-trait-abstraction">Benefits of Trait Abstraction</a></h3>
<ul>
<li>Sim never touches networking concerns</li>
<li>Full testability (run entire sim with <code>LocalNetwork</code>)</li>
<li>Community can contribute better netcode without understanding game logic</li>
<li>Players could choose network model in lobby (if both agree)</li>
<li>Cross-engine adapters wrap existing models transparently</li>
</ul>
<h2 id="shared-protocol-types"><a class="header" href="#shared-protocol-types">Shared Protocol Types</a></h2>
<p>Defined in <code>ra-protocol</code> crate — the ONLY shared dependency between sim and net:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Clone, Serialize, Deserialize, Hash)]
pub enum PlayerOrder {
    Move { unit_ids: Vec&lt;UnitId&gt;, target: CellPos },
    Attack { unit_ids: Vec&lt;UnitId&gt;, target: Target },
    Build { structure: StructureType, position: CellPos },
    SetRallyPoint { building: BuildingId, position: CellPos },
    Sell { building: BuildingId },
    // ... every possible player action
}

/// Sub-tick timestamp on every order (CS2-inspired)
#[derive(Clone, Serialize, Deserialize)]
pub struct TimestampedOrder {
    pub player: PlayerId,
    pub order: PlayerOrder,
    pub sub_tick_time: f64,  // fractional time within the tick window
}

pub struct TickOrders {
    pub tick: u64,
    pub orders: Vec&lt;TimestampedOrder&gt;,
}

impl TickOrders {
    /// CS2-style: process in chronological order within the tick
    pub fn chronological(&amp;self) -&gt; impl Iterator&lt;Item = &amp;TimestampedOrder&gt; {
        let mut sorted = self.orders.clone();
        sorted.sort_by(|a, b| a.sub_tick_time.partial_cmp(&amp;b.sub_tick_time).unwrap());
        sorted.into_iter()
    }
}
<span class="boring">}</span></code></pre>
<h2 id="cs2-sub-tick-what-we-borrow"><a class="header" href="#cs2-sub-tick-what-we-borrow">CS2 Sub-Tick: What We Borrow</a></h2>
<h3 id="what-cs2-does"><a class="header" href="#what-cs2-does">What CS2 Does</a></h3>
<p>Counter-Strike 2 introduced “sub-tick” architecture: instead of processing all actions at discrete tick boundaries, the client timestamps every input with sub-tick precision. The server collects inputs from all clients and processes them in chronological order within each tick window. The server still ticks at 64Hz, but events are ordered by their actual timestamps.</p>
<h3 id="whats-relevant-for-rts"><a class="header" href="#whats-relevant-for-rts">What’s Relevant for RTS</a></h3>
<p>The core idea — <strong>timestamped orders processed in chronological order within a tick</strong> — produces fairer results for edge cases:</p>
<ul>
<li>Two players grabbing the same crate → the one who clicked first gets it</li>
<li>Engineer vs engineer racing to capture a building → chronological winner</li>
<li>Simultaneous attack orders → processed in actual order, not arrival order</li>
</ul>
<h3 id="whats-not-relevant"><a class="header" href="#whats-not-relevant">What’s NOT Relevant</a></h3>
<p>CS2 is client-server authoritative with prediction and interpolation. An RTS with hundreds of units can’t afford server-authoritative simulation — the bandwidth would be enormous. We stay with deterministic lockstep (clients run identical sims), so CS2’s prediction/reconciliation doesn’t directly apply.</p>
<h2 id="network-model-details"><a class="header" href="#network-model-details">Network Model Details</a></h2>
<h3 id="model-1-lockstep-with-input-delay-starting-model"><a class="header" href="#model-1-lockstep-with-input-delay-starting-model">Model 1: Lockstep with Input Delay (starting model)</a></h3>
<pre><code>Local input at tick 50 → scheduled for tick 53 (3-tick delay)
Remote input has 3 ticks to arrive before we need it
Delay dynamically adjusted based on connection quality
</code></pre>
<p>This is what OpenRA and most RTS games use. The “lag” players feel is intentional input delay, not network stalling.</p>
<h3 id="model-2-relay-server-with-time-authority-recommended-default"><a class="header" href="#model-2-relay-server-with-time-authority-recommended-default">Model 2: Relay Server with Time Authority (recommended default)</a></h3>
<pre><code>┌────────┐         ┌──────────────┐         ┌────────┐
│Player A│────────▶│ Relay Server │◀────────│Player B│
│        │◀────────│  (timestamped│────────▶│        │
└────────┘         │   ordering)  │         └────────┘
                   └──────────────┘
</code></pre>
<p>The relay server does NOT run the sim. It:</p>
<ol>
<li>Receives timestamped orders from all players</li>
<li>Orders them chronologically (CS2 insight)</li>
<li>Broadcasts canonical tick order to all clients</li>
<li>Detects lag switches and cheating attempts</li>
<li>Handles NAT traversal (no port forwarding needed)</li>
</ol>
<p><strong>Anti-lag-switch mechanism:</strong></p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl RelayServer {
    fn process_tick(&amp;mut self, tick: u64) {
        let deadline = Instant::now() + self.tick_deadline; // e.g., 120ms
        
        for player in &amp;self.players {
            match self.receive_orders_from(player, deadline) {
                Ok(orders) =&gt; self.tick_orders.add(player, orders),
                Err(Timeout) =&gt; {
                    // Missed deadline → strikes system
                    // Game never stalls for honest players
                    self.tick_orders.add(player, PlayerOrder::Idle);
                }
            }
        }
        self.broadcast_tick_orders(tick);
    }
}
<span class="boring">}</span></code></pre>
<h3 id="model-3-fog-authoritative-server-anti-maphack"><a class="header" href="#model-3-fog-authoritative-server-anti-maphack">Model 3: Fog-Authoritative Server (anti-maphack)</a></h3>
<p>Server runs full sim, sends each client only entities they should see. Breaks pure lockstep (clients run partial sims), requires server compute per game. See <code>06-SECURITY.md</code> for details.</p>
<h3 id="model-4-rollback--ggpo-style-experimental-future"><a class="header" href="#model-4-rollback--ggpo-style-experimental-future">Model 4: Rollback / GGPO-style (experimental future)</a></h3>
<p>Requires snapshottable sim (already designed). Client predicts with local input, rolls back on misprediction. Expensive for RTS (re-simulating hundreds of entities), but feasible with Rust’s performance. See GGPO documentation for reference implementation.</p>
<h2 id="input-responsiveness-why-our-model-feels-faster"><a class="header" href="#input-responsiveness-why-our-model-feels-faster">Input Responsiveness: Why Our Model Feels Faster</a></h2>
<p>Every lockstep RTS has inherent input delay — the game must wait for all players’ orders before advancing. This is <strong>architectural</strong>, not a bug. But how much delay, and who pays for it, varies dramatically.</p>
<h3 id="openras-stalling-model"><a class="header" href="#openras-stalling-model">OpenRA’s Stalling Model</a></h3>
<p>OpenRA uses classic lockstep where the <strong>entire game freezes</strong> until the slowest client submits orders:</p>
<pre><code>Tick 50: waiting for Player A's orders... ✓ (10ms)
         waiting for Player B's orders... ✓ (15ms)
         waiting for Player C's orders... ⏳ (280ms — bad WiFi)
         → ALL players frozen for 280ms. Everyone suffers.
</code></pre>
<p>Additionally:</p>
<ul>
<li>Orders are batched every <code>NetFrameInterval</code> frames (not every tick), adding batching delay</li>
<li>The server adds <code>OrderLatency</code> frames to every order (typically 3 ticks into the future)</li>
<li><code>TickScale</code> dynamically slows the game to match the worst connection</li>
<li>Even in <strong>single player</strong>, <code>EchoConnection</code> projects orders 1 frame forward</li>
<li>C# GC pauses (5-50ms) add unpredictable jank on top of the architectural delay</li>
</ul>
<p>The perceived input lag when clicking units in OpenRA is ~100-200ms — a combination of intentional lockstep delay, order batching, and runtime overhead.</p>
<h3 id="our-relay-model-no-stalling"><a class="header" href="#our-relay-model-no-stalling">Our Relay Model: No Stalling</a></h3>
<p>The relay server owns the clock. It broadcasts tick orders on a fixed deadline — missed orders are replaced with <code>PlayerOrder::Idle</code>:</p>
<pre><code>Tick 50: relay deadline = 80ms
         Player A orders arrive at 10ms  → ✓ included
         Player B orders arrive at 15ms  → ✓ included  
         Player C orders arrive at 280ms → ✗ missed deadline → Idle
         → Relay broadcasts at 80ms. No stall. Player C's units idle.
</code></pre>
<p>Honest players on good connections always get responsive gameplay. A lagging player hurts only themselves.</p>
<h3 id="visual-prediction-cosmetic-not-sim"><a class="header" href="#visual-prediction-cosmetic-not-sim">Visual Prediction (Cosmetic, Not Sim)</a></h3>
<p>The render layer provides <strong>instant visual feedback</strong> on player input, before the order is confirmed by the network:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// ra-render: immediate visual response to click
fn on_move_order_issued(click_pos: WorldPos, selected_units: &amp;[Entity]) {
    // Show move marker immediately
    spawn_move_marker(click_pos);
    
    // Start unit turn animation toward target (cosmetic only)
    for unit in selected_units {
        start_turn_preview(unit, click_pos);
    }
    
    // Selection acknowledgement sound plays instantly
    play_unit_response_audio(selected_units);
    
    // The actual sim order is still in the network pipeline.
    // Units will begin real movement when the order is confirmed next tick.
    // The visual prediction bridges the gap so the game feels instant.
}
<span class="boring">}</span></code></pre>
<p>This is purely cosmetic — the sim doesn’t advance until the confirmed order arrives. But it eliminates the <strong>perceived</strong> lag that makes OpenRA feel sluggish. The selection ring snaps, the unit rotates, the acknowledgment voice plays — all before the network round-trip completes.</p>
<h3 id="input-latency-comparison"><a class="header" href="#input-latency-comparison">Input Latency Comparison</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Factor</th><th>OpenRA</th><th>Iron Curtain (Relay)</th><th>Improvement</th></tr>
</thead>
<tbody>
<tr><td>Waiting for slowest client</td><td>Yes — everyone freezes</td><td>No — relay drops late orders</td><td>Eliminates worst-case stalls entirely</td></tr>
<tr><td>Order batching interval</td><td>Every N frames (<code>NetFrameInterval</code>)</td><td>Every tick</td><td>No batching delay</td></tr>
<tr><td>Order scheduling delay</td><td>+3 ticks (<code>OrderLatency</code>)</td><td>+1 tick (next relay broadcast)</td><td>~2 ticks faster</td></tr>
<tr><td>Tick processing time</td><td>30-60ms (limits tick rate)</td><td>~8ms (allows higher tick rate)</td><td>4-8x faster per tick</td></tr>
<tr><td>Achievable tick rate</td><td>~15 tps</td><td>30+ tps</td><td>2x shorter lockstep window</td></tr>
<tr><td>GC pauses during processing</td><td>5-50ms random jank</td><td>0ms</td><td>Eliminates unpredictable hitches</td></tr>
<tr><td>Visual feedback on click</td><td>Waits for order confirmation</td><td>Immediate (cosmetic prediction)</td><td>Perceived lag drops to near-zero</td></tr>
<tr><td>Single-player order delay</td><td>1 projected frame (~66ms at 15 tps)</td><td>0 frames (<code>LocalNetwork</code> = next tick)</td><td>Zero delay</td></tr>
<tr><td>Worst connection impact</td><td>Freezes all players</td><td>Only affects the lagging player</td><td>Architectural fairness</td></tr>
<tr><td>Future: rollback prediction</td><td>Not possible (no snapshots)</td><td>Possible (D010 enables GGPO)</td><td>Could eliminate all perceived MP delay</td></tr>
</tbody>
</table>
</div>
<h3 id="single-player-zero-delay"><a class="header" href="#single-player-zero-delay">Single-Player: Zero Delay</a></h3>
<p><code>LocalNetwork</code> processes orders on the very next tick with zero scheduling delay:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl NetworkModel for LocalNetwork {
    fn submit_order(&amp;mut self, order: TimestampedOrder) {
        // Order goes directly into the next tick — no delay, no projection
        self.pending.push(order);
    }
    
    fn poll_tick(&amp;mut self) -&gt; Option&lt;TickOrders&gt; {
        // Always ready — no waiting for other clients
        Some(TickOrders {
            tick: self.tick,
            orders: std::mem::take(&amp;mut self.pending),
        })
    }
}
<span class="boring">}</span></code></pre>
<p>At 30 tps, a click-to-move in single player is confirmed within ~33ms — imperceptible to humans (reaction time is ~200ms). Combined with visual prediction, the game feels <strong>instant</strong>.</p>
<h2 id="desync-detection--debugging"><a class="header" href="#desync-detection--debugging">Desync Detection &amp; Debugging</a></h2>
<p>Every <code>NetworkModel</code> must accept <code>report_sync_hash()</code>. The system works:</p>
<ol>
<li>Each client hashes their sim state after each tick</li>
<li>Hashes are compared (by relay server, or exchanged P2P)</li>
<li>On mismatch → desync detected at specific tick</li>
<li>Because sim is snapshottable, dump full state and diff to pinpoint exact divergence</li>
</ol>
<p>This is a <strong>killer feature OpenRA lacks</strong>. OpenRA desyncs are common and nearly impossible to debug. Our architecture makes them diagnosable.</p>
<h2 id="ordercodec-wire-format-abstraction"><a class="header" href="#ordercodec-wire-format-abstraction">OrderCodec: Wire Format Abstraction</a></h2>
<p>For future cross-engine play and protocol versioning:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait OrderCodec: Send + Sync {
    fn encode(&amp;self, order: &amp;TimestampedOrder) -&gt; Result&lt;Vec&lt;u8&gt;&gt;;
    fn decode(&amp;self, bytes: &amp;[u8]) -&gt; Result&lt;TimestampedOrder&gt;;
    fn protocol_id(&amp;self) -&gt; ProtocolId;
}

/// Native format — fast, compact, versioned
pub struct NativeCodec { version: u32 }

/// Translates to/from OpenRA's wire format
pub struct OpenRACodec {
    order_map: OrderTranslationTable,
    coord_transform: CoordTransform,
}
<span class="boring">}</span></code></pre>
<p>See <code>07-CROSS-ENGINE.md</code> for full cross-engine compatibility design.</p>
<h2 id="replay-system"><a class="header" href="#replay-system">Replay System</a></h2>
<p>Replays are a natural byproduct of the architecture:</p>
<pre><code>Replay file = initial state + sequence of TickOrders
Playback = feed TickOrders through Simulation via ReplayPlayback NetworkModel
</code></pre>
<p>Replays are signed by the relay server for tamper-proofing (see <code>06-SECURITY.md</code>).</p>
<h2 id="connection-establishment"><a class="header" href="#connection-establishment">Connection Establishment</a></h2>
<p>Connection method is a concern <em>below</em> <code>NetworkModel</code>. By the time a <code>NetworkModel</code> is constructed, transport is already established. The discovery/connection flow:</p>
<pre><code>Discovery (tracking server / join code / direct IP / QR)
  → Connection establishment (hole-punch / direct TCP+UDP)
    → NetworkModel constructed (LockstepNetwork or RelayLockstepNetwork)
      → Game loop runs — sim doesn't know or care how connection happened
</code></pre>
<h3 id="direct-ip"><a class="header" href="#direct-ip">Direct IP</a></h3>
<p>Classic approach. Host shares <code>IP:port</code>, other player connects.</p>
<ul>
<li>Simplest to implement (TCP connect, done)</li>
<li>Requires host to have a reachable IP (port forwarding or same LAN)</li>
<li>Good for LAN parties, dedicated server setups, and power users</li>
</ul>
<h3 id="join-code-recommended-for-casual"><a class="header" href="#join-code-recommended-for-casual">Join Code (Recommended for Casual)</a></h3>
<p>Host contacts a lightweight rendezvous server. Server assigns a short code (e.g., <code>IRON-7K3M</code>). Joiner sends code to same server. Server brokers a UDP hole-punch between both players.</p>
<pre><code>┌────────┐     1. register     ┌──────────────┐     2. resolve    ┌────────┐
│  Host  │ ──────────────────▶ │  Rendezvous  │ ◀──────────────── │ Joiner │
│        │ ◀── code: IRON-7K3M│    Server     │  code: IRON-7K3M──▶       │
│        │     3. hole-punch   │  (stateless)  │  3. hole-punch   │        │
│        │ ◀═══════════════════╪══════════════════════════════════▶│        │
└────────┘    direct P2P conn  └──────────────┘                   └────────┘
</code></pre>
<ul>
<li>No port forwarding needed (UDP hole-punch works through most NATs)</li>
<li>Rendezvous server is stateless and trivial — it only brokers introductions, never sees game data</li>
<li>Codes are short-lived (expire after use or timeout)</li>
<li>Industry standard: Among Us, Deep Rock Galactic, It Takes Two</li>
</ul>
<h3 id="qr-code"><a class="header" href="#qr-code">QR Code</a></h3>
<p>Same as join code, encoded as QR. Player scans from phone → opens game client with code pre-filled. Ideal for couch play, LAN events, and streaming (viewers scan to join).</p>
<h3 id="via-relay-server"><a class="header" href="#via-relay-server">Via Relay Server</a></h3>
<p>When direct P2P fails (symmetric NAT, corporate firewalls), fall back to relay. The relay server is already designed for this (Model 2). Connection through relay also provides lag-switch protection and sub-tick ordering as a bonus.</p>
<h3 id="via-tracking-server"><a class="header" href="#via-tracking-server">Via Tracking Server</a></h3>
<p>Player browses public game listings, picks one, client connects directly to the host (or relay). See Tracking Servers section below.</p>
<h2 id="tracking-servers-game-browser"><a class="header" href="#tracking-servers-game-browser">Tracking Servers (Game Browser)</a></h2>
<p>A tracking server (also called master server) lets players discover and publish games. It is NOT a relay — no game data flows through it. It’s a directory.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Tracking server API — implemented by ra-net, consumed by ra-ui
pub trait TrackingServer: Send + Sync {
    /// Host publishes their game to the directory
    fn publish(&amp;self, listing: &amp;GameListing) -&gt; Result&lt;ListingId&gt;;
    /// Host updates their listing (player count, status)
    fn update(&amp;self, id: ListingId, listing: &amp;GameListing) -&gt; Result&lt;()&gt;;
    /// Host removes their listing (game started or cancelled)
    fn unpublish(&amp;self, id: ListingId) -&gt; Result&lt;()&gt;;
    /// Browser fetches current listings with optional filters
    fn browse(&amp;self, filter: &amp;BrowseFilter) -&gt; Result&lt;Vec&lt;GameListing&gt;&gt;;
}

pub struct GameListing {
    pub host: ConnectionInfo,     // IP:port, relay ID, or join code
    pub map: MapMeta,             // name, hash, player count
    pub rules: RulesMeta,         // mod, version, custom rules
    pub players: Vec&lt;PlayerInfo&gt;, // current players in lobby
    pub status: LobbyStatus,     // waiting, in_progress, full
    pub engine: EngineId,         // "iron-curtain" or "openra" (for cross-browser)
}
<span class="boring">}</span></code></pre>
<h3 id="official-tracking-server"><a class="header" href="#official-tracking-server">Official Tracking Server</a></h3>
<p>We run one. Games appear here by default. Free, community-operated, no account required to browse (account required to host, to prevent spam).</p>
<h3 id="custom-tracking-servers"><a class="header" href="#custom-tracking-servers">Custom Tracking Servers</a></h3>
<p>Communities, clans, and tournament organizers run their own. The client supports a list of tracking server URLs in settings. This is the Quake/Source master server model — decentralized, resilient.</p>
<pre><code class="language-yaml"># settings.yaml
tracking_servers:
  - url: "https://track.ironcurtain.gg"    # official
  - url: "https://rts.myclan.com/track"     # clan server
  - url: "https://openra.net/master"        # OpenRA shared browser (Level 0 compat)
</code></pre>
<h3 id="openra-shared-browser"><a class="header" href="#openra-shared-browser">OpenRA Shared Browser</a></h3>
<p>Implementing the OpenRA master server protocol means Iron Curtain games can appear in OpenRA’s game browser (and vice versa), tagged by engine. Players see the full community. This is the Level 0 cross-engine compatibility from <code>07-CROSS-ENGINE.md</code>.</p>
<h3 id="tracking-server-implementation"><a class="header" href="#tracking-server-implementation">Tracking Server Implementation</a></h3>
<p>The server itself is straightforward — a REST or WebSocket API backed by an in-memory store with TTL expiry. No database needed. Listings expire if the host stops sending heartbeats.</p>
<h2 id="backend-infrastructure-tracking--relay"><a class="header" href="#backend-infrastructure-tracking--relay">Backend Infrastructure (Tracking + Relay)</a></h2>
<p>Both the tracking server and relay server are <strong>standalone Rust binaries</strong>. The simplest deployment is running the executable on any computer — a home PC, a friend’s always-on machine, a €5 VPS, or a Raspberry Pi. No containers, no cloud, no special infrastructure required.</p>
<p>For larger-scale or production deployments, both services also ship as container images with docker-compose.yaml (one-command setup) and Helm charts (Kubernetes). But containers are an option, not a requirement.</p>
<p>There must never be a single point of failure that takes down the entire multiplayer ecosystem.</p>
<h3 id="architecture"><a class="header" href="#architecture">Architecture</a></h3>
<pre><code>                          ┌───────────────────────────────────┐
                          │         DNS / Load Balancer        │
                          │   (track.ironcurtain.gg)          │
                          └─────┬──────────┬──────────┬───────┘
                                │          │          │
                          ┌─────▼──┐ ┌─────▼──┐ ┌────▼───┐
                          │Tracking│ │Tracking│ │Tracking│   ← stateless replicas
                          │  Pod   │ │  Pod   │ │  Pod   │      (horizontal scale)
                          └────────┘ └────────┘ └────────┘
                                         │
                          ┌──────────────▼──────────────┐
                          │   Redis / in-memory store     │   ← game listings (ephemeral)
                          │   (TTL-based expiry)          │      no persistent DB needed
                          └───────────────────────────────┘

                          ┌───────────────────────────────────┐
                          │         DNS / Load Balancer        │
                          │   (relay.ironcurtain.gg)          │
                          └─────┬──────────┬──────────┬───────┘
                                │          │          │
                          ┌─────▼──┐ ┌─────▼──┐ ┌────▼───┐
                          │ Relay  │ │ Relay  │ │ Relay  │   ← stateless per-game
                          │  Pod   │ │  Pod   │ │  Pod   │      sessions (sticky)
                          └────────┘ └────────┘ └────────┘
</code></pre>
<h3 id="design-principles"><a class="header" href="#design-principles">Design Principles</a></h3>
<ol>
<li>
<p><strong>Just a binary.</strong> Each server is a single Rust executable with zero mandatory dependencies. Run it directly (<code>./tracking-server</code> or <code>./relay-server</code>), as a systemd service, in Docker, or in Kubernetes — whatever suits the operator. No database, no runtime, no JVM. Download, configure, run.</p>
</li>
<li>
<p><strong>Stateless processes.</strong> Each tracking server instance holds no critical state — for a single-instance deployment, listings live in memory with TTL expiry. For multi-instance deployments, listings are shared via Redis (or equivalent KV store). Killing the process loses nothing permanent. Relay servers hold per-game session state but games are short-lived; if a relay dies, the game reconnects or falls back to P2P.</p>
</li>
<li>
<p><strong>Community self-hosting is a first-class use case.</strong> A clan, tournament organizer, or hobbyist runs the same binary on their own machine. No cloud account needed. No Docker needed. The binary reads a config file or env vars and starts listening. For those who prefer containers, <code>docker-compose up</code> works too. For production scale, Helm charts are available.</p>
</li>
<li>
<p><strong>Federation, not centralization.</strong> The client aggregates listings from multiple tracking servers simultaneously (already designed — see <code>tracking_servers</code> list in settings). If the official server goes down, community servers still work. If all tracking servers go down, direct IP / join codes / QR still work. The architecture degrades gracefully, never fails completely.</p>
</li>
<li>
<p><strong>Relay servers are regional.</strong> Players connect to the nearest relay for lowest latency. The tracking server listing includes the relay region. Community relays in underserved regions improve the experience for everyone.</p>
</li>
</ol>
<h3 id="deployment-options"><a class="header" href="#deployment-options">Deployment Options</a></h3>
<p><strong>Option 1: Just run the binary (simplest)</strong></p>
<pre><code class="language-bash"># Download and run — no Docker, no cloud, no dependencies
./tracking-server --port 8080 --heartbeat-ttl 30s
./relay-server --port 9090 --region home --max-games 50
</code></pre>
<p>Works on any machine: home PC, spare laptop, Raspberry Pi, VPS. The tracking server uses in-memory storage by default — no Redis needed for a single instance.</p>
<p><strong>Option 2: Docker Compose (one-command setup)</strong></p>
<pre><code class="language-yaml"># docker-compose.yaml (community self-hosting)
services:
  tracking:
    image: ghcr.io/iron-curtain/tracking-server:latest
    ports:
      - "8080:8080"
    environment:
      - STORE=memory           # or STORE=redis://redis:6379 for multi-instance
      - HEARTBEAT_TTL=30s
      - MAX_LISTINGS=1000
      - RATE_LIMIT=10/min      # per IP — anti-spam
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]

  relay:
    image: ghcr.io/iron-curtain/relay-server:latest
    ports:
      - "9090:9090/udp"
      - "9090:9090/tcp"
    environment:
      - MAX_GAMES=100
      - MAX_PLAYERS_PER_GAME=16
      - TICK_TIMEOUT=5s         # drop orders after 5s — anti-lag-switch
      - REGION=eu-west          # reported to tracking server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]

  redis:
    image: redis:7-alpine       # only needed for multi-instance tracking
    profiles: ["scaled"]
</code></pre>
<p><strong>Option 3: Kubernetes / Helm (production scale)</strong></p>
<p>For the official deployment or large community servers that need horizontal scaling:</p>
<pre><code class="language-yaml"># helm/values.yaml (abbreviated)
tracking:
  replicas: 3
  resources:
    requests: { cpu: 100m, memory: 64Mi }
    limits: { cpu: 500m, memory: 128Mi }
  store: redis
  redis:
    url: redis://redis-master:6379

relay:
  replicas: 5                   # one pod per ~100 concurrent games
  resources:
    requests: { cpu: 200m, memory: 128Mi }
    limits: { cpu: 1000m, memory: 256Mi }
  sessionAffinity: ClientIP     # sticky sessions for relay game state
  regions:
    - name: eu-west
      replicas: 2
    - name: us-east
      replicas: 2
    - name: ap-southeast
      replicas: 1
</code></pre>
<h3 id="cost-profile"><a class="header" href="#cost-profile">Cost Profile</a></h3>
<p>Both services are lightweight — they forward small order packets, not game state:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Deployment</th><th>Cost</th><th>Serves</th><th>Requires</th></tr>
</thead>
<tbody>
<tr><td>Home PC / spare laptop</td><td>Free (electricity)</td><td>~50 concurrent games</td><td>Port forwarding</td></tr>
<tr><td>Raspberry Pi</td><td>~€50 one-time</td><td>~50 concurrent games</td><td>Port forwarding</td></tr>
<tr><td>Single VPS (community)</td><td>€5-10/month</td><td>~200 concurrent games</td><td>Nothing special</td></tr>
<tr><td>Small k8s cluster (official)</td><td>€30-50/month</td><td>~2000 concurrent games</td><td>Kubernetes knowledge</td></tr>
<tr><td>Scaled k8s (launch day spike)</td><td>€100-200/month</td><td>~10,000 concurrent games</td><td>Kubernetes + monitoring</td></tr>
</tbody>
</table>
</div>
<p>The relay server is the heavier service (per-game session state, UDP forwarding) but still tiny — each game session is a few KB of buffered orders. A single pod handles ~100 concurrent games easily.</p>
<h3 id="backend-language"><a class="header" href="#backend-language">Backend Language</a></h3>
<p>The tracking and relay servers are standalone Rust binaries (not Bevy — no ECS needed). They share <code>ra-protocol</code> for order serialization. The relay server implements the relay-side of <code>RelayLockstepNetwork</code>. Both are simple enough to be developed in Phase 5 alongside the multiplayer client code.</p>
<h3 id="failure-modes"><a class="header" href="#failure-modes">Failure Modes</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Failure</th><th>Impact</th><th>Recovery</th></tr>
</thead>
<tbody>
<tr><td>Tracking server dies</td><td>Browse requests fail; existing games unaffected</td><td>Restart process; multi-instance setups have other replicas</td></tr>
<tr><td>All tracking servers down</td><td>No game browser; existing games unaffected</td><td>Direct IP, join codes, QR still work</td></tr>
<tr><td>Relay server dies</td><td>Games on that instance disconnect</td><td>Clients reconnect to another instance or fall back to P2P</td></tr>
<tr><td>Official infra fully offline</td><td>Community tracking/relay servers still operational</td><td>Federation means no single operator is critical</td></tr>
</tbody>
</table>
</div>
<h2 id="multi-player-scaling-beyond-2-players"><a class="header" href="#multi-player-scaling-beyond-2-players">Multi-Player Scaling (Beyond 2 Players)</a></h2>
<p>The architecture supports N players with no structural changes. Every design element — deterministic lockstep, sub-tick ordering, relay server, desync detection — works for 2, 4, 8, or more players.</p>
<h3 id="how-each-component-scales"><a class="header" href="#how-each-component-scales">How Each Component Scales</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Component</th><th>2 players</th><th>N players</th><th>Bottleneck</th></tr>
</thead>
<tbody>
<tr><td><strong>Lockstep sim</strong></td><td>Both run identical sim</td><td>All N run identical sim</td><td>No change — sim processes <code>TickOrders</code> regardless of source count</td></tr>
<tr><td><strong>Sub-tick ordering</strong></td><td>Sort 2 players’ orders</td><td>Sort N players’ orders</td><td>Negligible — orders per tick is small (players issue ~0-5 orders/tick)</td></tr>
<tr><td><strong>Relay server</strong></td><td>Collects from 2, broadcasts to 2</td><td>Collects from N, broadcasts to N</td><td>Linear in N. Bandwidth is tiny (orders are small)</td></tr>
<tr><td><strong>Desync detection</strong></td><td>Compare 2 hashes</td><td>Compare N hashes</td><td>Trivial — one hash per player per tick</td></tr>
<tr><td><strong>Input delay</strong></td><td>Tuned to worst of 2 connections</td><td>Tuned to worst of N connections</td><td><strong>Real bottleneck</strong> — one laggy player affects everyone</td></tr>
<tr><td><strong>Direct P2P</strong></td><td>1 connection</td><td>N×(N-1)/2 mesh connections</td><td>Mesh doesn’t scale. Use star topology or relay for &gt;4 players</td></tr>
</tbody>
</table>
</div>
<h3 id="p2p-topology-for-multi-player"><a class="header" href="#p2p-topology-for-multi-player">P2P Topology for Multi-Player</a></h3>
<p>Direct P2P lockstep with 2-3 players uses a full mesh (everyone connects to everyone). Beyond that, use a star topology where one player acts as host:</p>
<pre><code>2-3 players: full mesh (every client sends to every other)
  A ↔ B ↔ C ↔ A

4+ players: star via host (one player collects and rebroadcasts)
  B → A ← C        A = host, collects orders, broadcasts canonical tick
      ↑
      D

4+ players: relay server (recommended)
  B → R ← C        R = relay, all benefits of Model 2
      ↑
      D
</code></pre>
<p>For 4+ players, the relay server is strongly recommended. It solves:</p>
<ul>
<li>NAT traversal for all players (not just host)</li>
<li>Lag-switch protection for all players (not just host-enforced)</li>
<li>No single player has hosting advantage (relay is neutral authority)</li>
<li>Sub-tick ordering is globally fair</li>
</ul>
<h3 id="the-real-scaling-limit-sim-cost-not-network"><a class="header" href="#the-real-scaling-limit-sim-cost-not-network">The Real Scaling Limit: Sim Cost, Not Network</a></h3>
<p>With N players, the sim has more units, more orders, and more state to process. This is a <strong>sim performance</strong> concern, not a network concern:</p>
<ul>
<li>2-player game: ~200-500 units typically</li>
<li>4-player FFA or 2v2: ~400-1000 units</li>
<li>8-player: ~800-2000 units</li>
</ul>
<p>The performance targets in <code>10-PERFORMANCE.md</code> already account for this. The efficiency pyramid (flowfields, spatial hash, sim LOD, amortized work) is designed for 2000+ units on mid-range hardware. An 8-player game is within budget.</p>
<h3 id="team-games-2v2-3v3-4v4"><a class="header" href="#team-games-2v2-3v3-4v4">Team Games (2v2, 3v3, 4v4)</a></h3>
<p>Team games work identically to FFA. Each player submits orders for their own units. The sim processes all orders from all players in sub-tick chronological order. Alliances, shared vision, and team chat are sim-layer and UI-layer concerns — the network model doesn’t distinguish between ally and enemy.</p>
<h3 id="observers--spectators"><a class="header" href="#observers--spectators">Observers / Spectators</a></h3>
<p>Observers receive <code>TickOrders</code> but never submit any. They run the sim locally (full state, all players’ perspective). In a relay server setup, the relay can optionally delay the observer feed by N ticks to prevent live coaching.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct ObserverConnection {
    pub delay_ticks: u64,        // e.g., 30 ticks (~2 seconds) for anti-coaching
    pub receive_only: bool,      // true — observer never submits orders
}
<span class="boring">}</span></code></pre>
<h3 id="player-limits"><a class="header" href="#player-limits">Player Limits</a></h3>
<p>No hard architectural limit. Practical limits:</p>
<ul>
<li><strong>Lockstep input delay</strong> — scales with the worst connection among N players. Beyond ~8 players, the slowest player’s latency dominates everyone’s experience.</li>
<li><strong>Order volume</strong> — N players generating orders simultaneously. Still tiny bandwidth (orders are small structs, not state).</li>
<li><strong>Sim cost</strong> — more players = more units = more computation. The efficiency pyramid handles this up to the hardware’s limit.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="02-ARCHITECTURE.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="04-MODDING.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="02-ARCHITECTURE.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="04-MODDING.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>

<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Core Architecture - Iron Curtain — Design Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Design docs for a Rust-native Red Alert RTS engine">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-669b8e99.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-678cb19b.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Iron Curtain — Design Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/DK26/iron-curtain-design-docs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>
                        <a href="https://github.com/DK26/iron-curtain-design-docs/edit/main/src/02-ARCHITECTURE.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <span class=fa-svg id="git-edit-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M421.7 220.3l-11.3 11.3-22.6 22.6-205 205c-6.6 6.6-14.8 11.5-23.8 14.1L30.8 511c-8.4 2.5-17.5 .2-23.7-6.1S-1.5 489.7 1 481.2L38.7 353.1c2.6-9 7.5-17.2 14.1-23.8l205-205 22.6-22.6 11.3-11.3 33.9 33.9 62.1 62.1 33.9 33.9zM96 353.9l-9.3 9.3c-.9 .9-1.6 2.1-2 3.4l-25.3 86 86-25.3c1.3-.4 2.5-1.1 3.4-2l9.3-9.3H112c-8.8 0-16-7.2-16-16V353.9zM453.3 19.3l39.4 39.4c25 25 25 65.5 0 90.5l-14.5 14.5-22.6 22.6-11.3 11.3-33.9-33.9-62.1-62.1L314.3 67.7l11.3-11.3 22.6-22.6 14.5-14.5c25-25 65.5-25 90.5 0z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="02--core-architecture"><a class="header" href="#02--core-architecture">02 — Core Architecture</a></h1>
<h2 id="decision-bevy"><a class="header" href="#decision-bevy">Decision: Bevy</a></h2>
<p><strong>Rationale (revised — see D002 in <code>src/09-DECISIONS.md</code>):</strong></p>
<ul>
<li>ECS <em>is</em> our architecture — Bevy gives it to us with scheduling, queries, and parallel system execution out of the box</li>
<li>Saves 2–4 months of engine plumbing (windowing, asset pipeline, audio, rendering scaffolding)</li>
<li>Plugin system maps naturally to pluggable networking (<code>NetworkModel</code> as a Bevy plugin)</li>
<li>Bevy’s 2D rendering pipeline handles classic isometric sprites; the 3D pipeline is available passively for modders (see “3D Rendering as a Mod”)</li>
<li><code>wgpu</code> is Bevy’s backend — we still get low-level control via custom render passes where profiling justifies it</li>
<li>Breaking API changes are manageable: pin Bevy version per development phase, upgrade between phases</li>
</ul>
<p><strong>Bevy provides:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Concern</th><th>Bevy Subsystem</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td>Windowing</td><td><code>bevy_winit</code></td><td>Cross-platform, handles lifecycle events</td></tr>
<tr><td>Rendering</td><td><code>bevy_render</code> + <code>wgpu</code></td><td>Custom isometric sprite passes; 3D pipeline available to modders</td></tr>
<tr><td>ECS</td><td><code>bevy_ecs</code></td><td>Archetypes, system scheduling, change detection</td></tr>
<tr><td>Asset I/O</td><td><code>bevy_asset</code></td><td>Hot-reloading, platform-agnostic (WASM/mobile-safe)</td></tr>
<tr><td>Audio</td><td><code>bevy_audio</code></td><td>Platform-routed; <code>ic-audio</code> wraps for .aud/.ogg/EVA</td></tr>
<tr><td>Dev tools</td><td><code>egui</code> via <code>bevy_egui</code></td><td>Immediate-mode debug overlays</td></tr>
<tr><td>Scripting</td><td><code>mlua</code> (Bevy resource)</td><td>Lua embedding, integrated as non-send resource</td></tr>
<tr><td>Mod runtime</td><td><code>wasmtime</code> / <code>wasmer</code></td><td>WASM sandboxed execution (Bevy system, not Bevy plugin)</td></tr>
</tbody>
</table>
</div>
<h2 id="simulation--render-split-critical-architecture"><a class="header" href="#simulation--render-split-critical-architecture">Simulation / Render Split (Critical Architecture)</a></h2>
<p>The simulation and renderer are completely decoupled from day one.</p>
<pre><code>┌─────────────────────────────────────────────┐
│             GameLoop&lt;N, I&gt;                  │
│                                             │
│  Input(I) → Network(N) → Sim (tick) → Render│
│                                             │
│  Sim runs at fixed tick rate (e.g., 15/sec) │
│  Renderer interpolates between sim states   │
│  Renderer can run at any FPS independently  │
└─────────────────────────────────────────────┘
</code></pre>
<h3 id="simulation-properties"><a class="header" href="#simulation-properties">Simulation Properties</a></h3>
<ul>
<li><strong>Deterministic:</strong> Same inputs → identical outputs on every platform</li>
<li><strong>Pure:</strong> No I/O, no floats in game logic, no network awareness</li>
<li><strong>Fixed-point math:</strong> <code>i32</code>/<code>i64</code> with known scale (never <code>f32</code>/<code>f64</code> in sim)</li>
<li><strong>Snapshottable:</strong> Full state serializable for replays, save games, desync debugging, rollback, campaign state persistence (D021)</li>
<li><strong>Headless-capable:</strong> Can run without renderer (dedicated servers, AI training, automated testing)</li>
</ul>
<h3 id="simulation-core-types"><a class="header" href="#simulation-core-types">Simulation Core Types</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// All sim-layer coordinates use fixed-point
pub type SimCoord = i32;  // 1 unit = 1/SCALE of a cell (see P002)

/// Position is 3D-aware from day one.
/// RA1 game module sets z = 0 everywhere (flat isometric).
/// RA2/TS game module uses z for terrain elevation, bridges, aircraft altitude.
pub struct WorldPos {
    pub x: SimCoord,
    pub y: SimCoord,
    pub z: SimCoord,  // 0 for flat games (RA1), meaningful for elevated terrain (RA2/TS)
}

/// Cell position on a discrete grid — convenience type for grid-based game modules.
/// NOT an engine-core requirement. Grid-based games (RA1, RA2, TS, TD, D2K) use CellPos
/// as their spatial primitive. Continuous-space game modules work with WorldPos directly.
/// The engine core operates on WorldPos; CellPos is a game-module-level concept.
pub struct CellPos {
    pub x: i32,
    pub y: i32,
    pub z: i32,  // layer / elevation level (0 for RA1)
}

/// The sim is a pure function: state + orders → new state
pub struct Simulation {
    world: World,          // ECS world (all entities + components)
    tick: u64,             // Current tick number
    rng: DeterministicRng, // Seeded, reproducible RNG
}

impl Simulation {
    /// THE critical function. Pure, deterministic, no I/O.
    pub fn apply_tick(&amp;mut self, orders: &amp;TickOrders) {
        // 1. Apply orders (sorted by sub-tick timestamp)
        for (player, order, timestamp) in orders.chronological() {
            self.execute_order(player, order);
        }
        // 2. Run systems: movement, combat, harvesting, AI, production
        self.run_systems();
        // 3. Advance tick
        self.tick += 1;
    }

    /// Snapshot for rollback / desync debugging / save games
    pub fn snapshot(&amp;self) -&gt; SimSnapshot { /* serialize everything */ }
    pub fn restore(&amp;mut self, snap: &amp;SimSnapshot) { /* deserialize */ }

    /// Hash for desync detection
    pub fn state_hash(&amp;self) -&gt; u64 { /* hash critical state */ }

    /// Surgical correction for cross-engine reconciliation
    pub fn apply_correction(&amp;mut self, correction: &amp;EntityCorrection) {
        // Directly set an entity's field — only used by reconciler
    }
}
<span class="boring">}</span></code></pre>
<h3 id="order-validation-inside-sim-deterministic"><a class="header" href="#order-validation-inside-sim-deterministic">Order Validation (inside sim, deterministic)</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Simulation {
    fn execute_order(&amp;mut self, player: PlayerId, order: &amp;PlayerOrder) {
        match self.validate_order(player, order) {
            OrderValidity::Valid =&gt; self.apply_order(player, order),
            OrderValidity::Rejected(reason) =&gt; {
                self.record_suspicious_activity(player, reason);
                // All honest clients also reject → stays in sync
            }
        }
    }
    
    fn validate_order(&amp;self, player: PlayerId, order: &amp;PlayerOrder) -&gt; OrderValidity {
        // Every order type validated: ownership, affordability, prerequisites, placement
        // This is deterministic — all clients agree on what to reject
    }
}
<span class="boring">}</span></code></pre>
<h2 id="ecs-design"><a class="header" href="#ecs-design">ECS Design</a></h2>
<p>ECS is a natural fit for RTS: hundreds of units with composable behaviors.</p>
<h3 id="component-model-mirrors-openra-traits"><a class="header" href="#component-model-mirrors-openra-traits">Component Model (mirrors OpenRA Traits)</a></h3>
<p>OpenRA’s “traits” are effectively components. Map them directly. The table below shows the <strong>RA1 game module’s</strong> default components. Other game modules (RA2, TD) register additional components — the ECS is open for extension without modifying the engine core.</p>
<p><strong>OpenRA vocabulary compatibility (D023):</strong> OpenRA trait names are accepted as YAML aliases. <code>Armament</code> and <code>combat</code> both resolve to the same component. This means existing OpenRA YAML definitions load without renaming.</p>
<p><strong>Canonical enum names (D027):</strong> Locomotor types (<code>Foot</code>, <code>Wheeled</code>, <code>Tracked</code>, <code>Float</code>, <code>Fly</code>), armor types (<code>None</code>, <code>Light</code>, <code>Medium</code>, <code>Heavy</code>, <code>Wood</code>, <code>Concrete</code>), target types, damage states, and stances match OpenRA’s names exactly. Versus tables and weapon definitions copy-paste without translation.</p>
<p>| OpenRA Trait | ECS Component | Purpose |
| <code>Health</code> | <code>Health { current: i32, max: i32 }</code> | Hit points |
| <code>Mobile</code> | <code>Mobile { speed: i32, locomotor: LocomotorType }</code> | Can move |
| <code>Attackable</code> | <code>Attackable { armor: ArmorType }</code> | Can be damaged |
| <code>Armament</code> | <code>Armament { weapon: WeaponId, cooldown: u32 }</code> | Can attack |
| <code>Building</code> | <code>Building { footprint: FootprintId }</code> | Occupies cells (footprint shapes stored in a shared <code>FootprintTable</code> resource, indexed by ID — zero per-entity heap allocation) |
| <code>Buildable</code> | <code>Buildable { cost: i32, time: u32, prereqs: Vec&lt;StructId&gt; }</code> | Can be built |
| <code>Selectable</code> | <code>Selectable { bounds: Rect, priority: u8 }</code> | Player can select |
| <code>Harvester</code> | <code>Harvester { capacity: i32, resource: ResourceType }</code> | Gathers ore |
| <code>Producible</code> | <code>Producible { queue: QueueType }</code> | Produced from building |</p>
<blockquote>
<p><strong>These 9 components are the core set.</strong> The full RA1 game module registers ~50 additional components for gameplay systems (power, transport, capture, stealth, veterancy, etc.). See <a href="#extended-gameplay-systems-ra1-module">Extended Gameplay Systems</a> below for the complete component catalog. The component table in <code>AGENTS.md</code> lists only the core set as a quick reference.</p>
</blockquote>
<h3 id="system-execution-order-deterministic-configurable-per-game-module"><a class="header" href="#system-execution-order-deterministic-configurable-per-game-module">System Execution Order (deterministic, configurable per game module)</a></h3>
<p>The <strong>RA1 game module</strong> registers this system execution order:</p>
<pre><code>Per tick:
  1.  apply_orders()          — Process all player commands (move, attack, build, sell, deploy, guard, etc.)
  2.  power_system()          — Recalculate player power balance, apply/remove outage penalties
  3.  production_system()     — Advance build queues, deduct costs, spawn completed units
  4.  harvester_system()      — Gather ore, navigate to refinery, deliver resources
  5.  docking_system()        — Manage dock queues (refinery, helipad, repair pad)
  6.  support_power_system()  — Advance superweapon charge timers
  7.  movement_system()       — Move all mobile entities (includes sub-cell for infantry)
  8.  crush_system()          — Check vehicle-over-infantry crush collisions
  9.  mine_system()           — Check mine trigger contacts
  10. combat_system()         — Target acquisition, fire weapons, create projectile entities
  11. projectile_system()     — Advance projectiles, check hits, apply warheads (Versus table + modifiers)
  12. capture_system()        — Advance engineer capture progress
  13. cloak_system()          — Update cloak/detection states, reveal-on-fire cooldowns
  14. condition_system()      — Evaluate condition grants/revocations (D028)
  15. veterancy_system()      — Award XP from kills, check level-up thresholds
  16. death_system()          — Remove destroyed entities, spawn husks, apply on-death warheads
  17. crate_system()          — Check crate pickups, apply random actions, spawn new crates
  18. transform_system()      — Process pending unit transformations (MCV ↔ ConYard, deploy/undeploy)
  19. trigger_system()        — Check mission/map triggers (Lua callbacks)
  20. notification_system()   — Queue audio/visual notifications (EVA, alerts), enforce cooldowns
  21. fog_system()            — Update visibility (staggered — not every tick, see 10-PERFORMANCE.md)
</code></pre>
<p>Order is fixed <em>per game module</em> and documented. Changing it changes gameplay and breaks replay compatibility.</p>
<p>A different game module (e.g., RA2) can insert additional systems (garrison, mind control, prism forwarding) at defined points. The engine runs whatever systems the active game module registers, in the order it specifies. The engine itself doesn’t know which game is running — it just executes the registered system pipeline deterministically.</p>
<h3 id="fogprovider-trait-d041"><a class="header" href="#fogprovider-trait-d041">FogProvider Trait (D041)</a></h3>
<p><code>fog_system()</code> delegates visibility computation to a <code>FogProvider</code> trait — like <code>Pathfinder</code> for pathfinding. Different game modules need different fog algorithms: radius-based (RA1), elevation line-of-sight (RA2/TS), or no fog (sandbox).</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Game modules implement this to define how visibility is computed.
pub trait FogProvider: Send + Sync {
    /// Recompute visibility for a player.
    fn update_visibility(
        &amp;mut self,
        player: PlayerId,
        sight_sources: &amp;[(WorldPos, SimCoord)],  // (position, sight_range) pairs
        terrain: &amp;TerrainData,
    );

    /// Is this position currently visible to this player?
    fn is_visible(&amp;self, player: PlayerId, pos: WorldPos) -&gt; bool;

    /// Has this player ever seen this position? (shroud vs fog distinction)
    fn is_explored(&amp;self, player: PlayerId, pos: WorldPos) -&gt; bool;

    /// All entity IDs visible to this player (for AI view filtering, render culling).
    fn visible_entities(&amp;self, player: PlayerId) -&gt; &amp;[EntityId];
}
<span class="boring">}</span></code></pre>
<p>RA1 registers <code>RadiusFogProvider</code> (circle-based, fast, matches original RA). RA2/TS would register <code>ElevationFogProvider</code> (raycasts against terrain heightmap). The future fog-authoritative <code>NetworkModel</code> reuses the same trait on the server side to determine which entities to send per client. See D041 in <code>09-DECISIONS.md</code> for full rationale.</p>
<h3 id="ordervalidator-trait-d041"><a class="header" href="#ordervalidator-trait-d041">OrderValidator Trait (D041)</a></h3>
<p>The engine enforces that ALL orders pass validation before <code>apply_orders()</code> executes them. This formalizes D012’s anti-cheat guarantee — game modules cannot accidentally skip validation:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Game modules implement this to define legal orders. The engine calls
/// validate() for every order, every tick — before the module's systems run.
pub trait OrderValidator: Send + Sync {
    fn validate(
        &amp;self,
        player: PlayerId,
        order: &amp;PlayerOrder,
        state: &amp;SimReadView,
    ) -&gt; OrderValidity;
}
<span class="boring">}</span></code></pre>
<p>RA1 registers <code>StandardOrderValidator</code> (ownership, affordability, prerequisites, placement, rate limits). See D041 in <code>09-DECISIONS.md</code> for full design and <code>GameModule</code> trait integration.</p>
<h2 id="extended-gameplay-systems-ra1-module"><a class="header" href="#extended-gameplay-systems-ra1-module">Extended Gameplay Systems (RA1 Module)</a></h2>
<p>The 9 core components above cover the skeleton. A playable Red Alert requires ~50 components and ~20 systems. This section designs every gameplay system identified in <code>11-OPENRA-FEATURES.md</code> § gap analysis, organized by functional domain.</p>
<h3 id="power-system"><a class="header" href="#power-system">Power System</a></h3>
<p>Every building generates or consumes power. Power deficit disables defenses and slows production — core C&amp;C economy.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Per-building power contribution.
pub struct Power {
    pub provides: i32,   // Power plants: positive
    pub consumes: i32,   // Defenses, production buildings: positive
}

/// Marker: this building goes offline during power outage.
pub struct AffectedByPowerOutage;

/// Player-level resource (not a component — stored in PlayerState).
pub struct PowerManager {
    pub total_capacity: i32,
    pub total_drain: i32,
    pub low_power: bool,  // drain &gt; capacity
}
<span class="boring">}</span></code></pre>
<p><strong><code>power_system()</code> logic:</strong> Sum all <code>Power</code> components per player → update <code>PowerManager</code>. When <code>low_power</code> is true, buildings with <code>AffectedByPowerOutage</code> have their production rates halved and defenses fire at reduced rate (via condition system, D028). Power bar UI reads <code>PowerManager</code> from <code>ic-ui</code>.</p>
<p><strong>YAML:</strong></p>
<pre><code class="language-yaml">power_plant:
  power: { provides: 100 }
tesla_coil:
  power: { consumes: 75 }
  affected_by_power_outage: true
</code></pre>
<h3 id="full-damage-pipeline-d028"><a class="header" href="#full-damage-pipeline-d028">Full Damage Pipeline (D028)</a></h3>
<p>The complete weapon → projectile → warhead chain:</p>
<pre><code>Armament fires → Projectile entity spawned → projectile_system() advances it
  → hit detection (range, homing, ballistic arc)
  → Warhead(s) applied at impact point
    → target validity (TargetTypes, stances)
    → spread/falloff calculation (distance from impact)
    → Versus table lookup (ArmorType × WarheadType → damage multiplier)
    → DamageMultiplier modifiers (veterancy, terrain, conditions)
    → Health reduced
</code></pre>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// A fired projectile — exists as its own entity during flight.
pub struct Projectile {
    pub weapon_id: WeaponId,
    pub source: EntityId,
    pub owner: PlayerId,
    pub target: ProjectileTarget,
    pub speed: i32,            // fixed-point
    pub warheads: Vec&lt;WarheadId&gt;,
    pub inaccuracy: i32,       // scatter radius at target
    pub projectile_type: ProjectileType,
}

pub enum ProjectileType {
    Bullet,         // instant-hit (hitscan)
    Missile { tracking: i32, rof_jitter: i32 },  // homing
    Ballistic { gravity: i32 },                    // arcing (artillery)
    Beam { duration: u32 },                        // continuous ray
}

pub enum ProjectileTarget {
    Entity(EntityId),
    Ground(WorldPos),
}

/// Warhead definition — loaded from YAML, shared (not per-entity).
pub struct WarheadDef {
    pub spread: i32,           // area of effect radius
    pub versus: VersusTable,   // ArmorType → damage percentage
    pub damage: i32,           // base damage value
    pub falloff: Vec&lt;i32&gt;,     // damage multiplier at distance steps
    pub valid_targets: Vec&lt;TargetType&gt;,
    pub invalid_targets: Vec&lt;TargetType&gt;,
    pub effects: Vec&lt;WarheadEffect&gt;,  // screen shake, spawn fire, etc.
}

/// ArmorType × WarheadType → percentage (100 = full damage)
/// Loaded from YAML Versus table — identical format to OpenRA.
pub struct VersusTable {
    pub modifiers: HashMap&lt;ArmorType, i32&gt;,
}
<span class="boring">}</span></code></pre>
<p><strong><code>projectile_system()</code> logic:</strong> For each <code>Projectile</code> entity: advance position by <code>speed</code>, check if arrived at target. On arrival, iterate <code>warheads</code>, apply each to entities in <code>spread</code> radius using <code>SpatialIndex::query_range()</code>. For each target: check <code>valid_targets</code>, look up <code>VersusTable</code>, apply <code>DamageMultiplier</code> conditions, reduce <code>Health</code>. If <code>Health.current &lt;= 0</code>, mark for <code>death_system()</code>.</p>
<p><strong>YAML (weapon + warhead, OpenRA-compatible):</strong></p>
<pre><code class="language-yaml">weapons:
  105mm:
    range: 5120          # in world units (fixed-point)
    rate_of_fire: 80     # ticks between shots
    projectile:
      type: bullet
      speed: 682
    warheads:
      - type: spread_damage
        damage: 60
        spread: 426
        versus:
          none: 100
          light: 80
          medium: 60
          heavy: 40
          wood: 120
          concrete: 30
        falloff: [100, 50, 25, 0]
</code></pre>
<h3 id="damageresolver-trait-d041"><a class="header" href="#damageresolver-trait-d041">DamageResolver Trait (D041)</a></h3>
<p>The damage pipeline above describes the RA1 resolution algorithm. The <em>data</em> (warheads, versus tables, modifiers) is YAML-configurable, but the <em>resolution order</em> — what happens between warhead impact and health reduction — varies between game modules. RA2 needs shield-first resolution; Generals-class games need sub-object targeting. The <code>DamageResolver</code> trait abstracts this step:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Game modules implement this to define damage resolution order.
/// Called by projectile_system() after hit detection and before health reduction.
pub trait DamageResolver: Send + Sync {
    fn resolve_damage(
        &amp;self,
        warhead: &amp;WarheadDef,
        target: &amp;DamageTarget,
        modifiers: &amp;StatModifiers,
        distance_from_impact: SimCoord,
    ) -&gt; DamageResult;
}

pub struct DamageTarget {
    pub entity: EntityId,
    pub armor_type: ArmorType,
    pub current_health: i32,
    pub shield: Option&lt;ShieldState&gt;,
    pub conditions: Conditions,
}

pub struct DamageResult {
    pub health_damage: i32,
    pub shield_damage: i32,
    pub conditions_applied: Vec&lt;(ConditionId, u32)&gt;,
    pub overkill: i32,
}
<span class="boring">}</span></code></pre>
<p>RA1 registers <code>StandardDamageResolver</code> (Versus table → falloff → multiplier stack → health). RA2 would register <code>ShieldFirstDamageResolver</code>. See D041 in <code>09-DECISIONS.md</code> for full rationale and alternative implementations.</p>
<h3 id="support-powers--superweapons"><a class="header" href="#support-powers--superweapons">Support Powers / Superweapons</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Attached to the building that provides the power (e.g., Chronosphere, Iron Curtain device).
pub struct SupportPower {
    pub power_type: SupportPowerType,
    pub charge_time: u32,          // ticks to fully charge
    pub current_charge: u32,       // ticks accumulated
    pub ready: bool,
    pub one_shot: bool,            // nukes: consumed on use; Chronosphere: recharges
    pub targeting: TargetingMode,
}

pub enum TargetingMode {
    Point,                   // click a cell (nuke)
    Area { radius: i32 },   // area selection (Iron Curtain effect)
    Directional,             // select origin + target cell (Chronoshift)
}

pub enum SupportPowerType {
    /// Defined by YAML — these are RA1 defaults, but the enum is data-driven.
    Named(String),
}

/// Player-level tracking.
pub struct SupportPowerManager {
    pub powers: Vec&lt;SupportPowerStatus&gt;, // one per owned support building
}
<span class="boring">}</span></code></pre>
<p><strong><code>support_power_system()</code> logic:</strong> For each entity with <code>SupportPower</code>: increment <code>current_charge</code> each tick. When <code>current_charge &gt;= charge_time</code>, set <code>ready = true</code>. UI shows charge bar. Activation comes via player order (sim validates ownership + readiness), then applies warheads/effects at target location.</p>
<h3 id="building-mechanics"><a class="header" href="#building-mechanics">Building Mechanics</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Build radius — buildings can only be placed near existing structures.
pub struct BuildArea {
    pub range: i32,   // cells from building edge
}

/// Primary building marker — determines which building produces (e.g., primary war factory).
pub struct PrimaryBuilding;

/// Rally point — newly produced units move here.
pub struct RallyPoint {
    pub target: WorldPos,
}

/// Building exit points — where produced units spawn.
pub struct Exit {
    pub offsets: Vec&lt;CellPos&gt;,   // spawn positions relative to building origin
}

/// Building can be sold.
pub struct Sellable {
    pub refund_percent: i32,  // typically 50
    pub sell_time: u32,       // ticks for sell animation
}

/// Building can be repaired (by player spending credits).
pub struct Repairable {
    pub repair_rate: i32,     // HP per tick while repairing
    pub repair_cost_per_hp: i32,
}

/// Gate — wall segment that opens for friendly units.
pub struct Gate {
    pub open_delay: u32,
    pub close_delay: u32,
    pub state: GateState,
}

pub enum GateState { Open, Closed, Opening, Closing }

/// Wall-specific: enables line-build placement.
pub struct LineBuild;
<span class="boring">}</span></code></pre>
<p><strong>Building placement validation</strong> (in <code>apply_orders()</code> → order validation):</p>
<ol>
<li>Check footprint fits terrain (no water, no cliffs, no existing buildings)</li>
<li>Check within build radius of at least one friendly <code>BuildArea</code> provider</li>
<li>Check prerequisites met (from <code>Buildable.prereqs</code>)</li>
<li>Deduct cost → start build animation → spawn building entity</li>
</ol>
<h3 id="production-queue"><a class="header" href="#production-queue">Production Queue</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// A production queue (each building type has its own queue).
pub struct ProductionQueue {
    pub queue_type: QueueType,
    pub items: Vec&lt;ProductionItem&gt;,
    pub parallel: bool,           // RA2: parallel production per factory
    pub paused: bool,
}

pub struct ProductionItem {
    pub actor_type: ActorId,
    pub remaining_cost: i32,
    pub remaining_time: u32,
    pub paid: i32,               // credits paid so far (for pause/resume)
    pub infinite: bool,          // repeat production (hold queue)
}
<span class="boring">}</span></code></pre>
<p><strong><code>production_system()</code> logic:</strong> For each <code>ProductionQueue</code>: if not paused and not empty, advance front item. Deduct credits incrementally (one tick’s worth per tick — production slows when credits run out). When <code>remaining_time == 0</code>, spawn unit at building’s <code>Exit</code> position, send to <code>RallyPoint</code> if set.</p>
<h3 id="resource--ore-model"><a class="header" href="#resource--ore-model">Resource / Ore Model</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Ore/gem cell data — stored per map cell (in a resource layer, not as entities).
pub struct ResourceCell {
    pub resource_type: ResourceType,
    pub amount: i32,     // depletes as harvested
    pub max_amount: i32,
    pub growth_rate: i32, // ore regrows; gems don't (YAML-configured)
}

/// Storage capacity — silos and refineries.
pub struct ResourceStorage {
    pub capacity: i32,
}
<span class="boring">}</span></code></pre>
<p><strong><code>harvester_system()</code> logic:</strong></p>
<ol>
<li>Harvester navigates to nearest <code>ResourceCell</code> with amount &gt; 0</li>
<li>Harvester mines: transfers resource from cell to <code>Harvester.capacity</code></li>
<li>When full (or cell depleted): navigate to nearest <code>DockHost</code> with <code>DockType::Refinery</code></li>
<li>Dock, transfer resources → credits (via resource value table)</li>
<li>If no refinery, wait. If no ore, scout for new fields.</li>
</ol>
<p>Player receives “silos needed” notification when total stored exceeds total <code>ResourceStorage.capacity</code>.</p>
<h3 id="transport--cargo"><a class="header" href="#transport--cargo">Transport / Cargo</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Cargo {
    pub max_weight: u32,
    pub current_weight: u32,
    pub passengers: Vec&lt;EntityId&gt;,
    pub unload_delay: u32,
}

pub struct Passenger {
    pub weight: u32,
    pub custom_pip: Option&lt;PipType&gt;,  // minimap/selection pip color
}

/// For carryall-style air transport.
pub struct Carryall {
    pub carry_target: Option&lt;EntityId&gt;,
}

/// Eject passengers on death (not all transports — YAML-configured).
pub struct EjectOnDeath;

/// ParaDrop capability — drop passengers from air.
pub struct ParaDrop {
    pub drop_interval: u32,  // ticks between each passenger exiting
}
<span class="boring">}</span></code></pre>
<p><strong>Load order:</strong> Player issues load order → <code>movement_system()</code> moves passenger to transport → when adjacent, remove passenger from world, add to <code>Cargo.passengers</code>. <strong>Unload order:</strong> Deploy order → eject passengers one by one at <code>Exit</code> positions, delay between each.</p>
<h3 id="capture--ownership"><a class="header" href="#capture--ownership">Capture / Ownership</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Capturable {
    pub capture_types: Vec&lt;CaptureType&gt;,  // engineer, proximity
    pub capture_threshold: i32,           // required capture points
    pub current_progress: i32,
    pub capturing_entity: Option&lt;EntityId&gt;,
}

pub struct Captures {
    pub speed: i32,              // capture points per tick
    pub capture_type: CaptureType,
    pub consumed: bool,          // engineer is consumed on capture (RA1 behavior)
}

pub enum CaptureType { Infantry, Proximity }
<span class="boring">}</span></code></pre>
<p><strong><code>capture_system()</code> logic:</strong> For each entity with <code>Capturable</code> being captured: increment <code>current_progress</code> by capturer’s <code>speed</code>. When <code>current_progress &gt;= capture_threshold</code>, transfer ownership to capturer’s player. If <code>consumed</code>, destroy capturer. Reset progress on interruption (capturer killed or moved away).</p>
<h3 id="stealth--cloak"><a class="header" href="#stealth--cloak">Stealth / Cloak</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Cloak {
    pub cloak_delay: u32,         // ticks after last action before cloaking
    pub cloak_types: Vec&lt;CloakType&gt;,
    pub ticks_since_action: u32,
    pub is_cloaked: bool,
    pub reveal_on_fire: bool,
    pub reveal_on_move: bool,
}

pub struct DetectCloaked {
    pub range: i32,
    pub detect_types: Vec&lt;CloakType&gt;,
}

pub enum CloakType { Stealth, Underwater, Disguise, GapGenerator }
<span class="boring">}</span></code></pre>
<p><strong><code>cloak_system()</code> logic:</strong> For each <code>Cloak</code> entity: if <code>reveal_on_fire</code> and fired this tick, reset <code>ticks_since_action</code>. If <code>reveal_on_move</code> and moved this tick, reset. Otherwise increment <code>ticks_since_action</code>. When above <code>cloak_delay</code>, set <code>is_cloaked = true</code>. Rendering: cloaked and no enemy <code>DetectCloaked</code> in range → invisible. Cloaked but detected → shimmer effect. Fog system integration: cloaked entities hidden from enemy even in explored area unless detector present.</p>
<h3 id="infantry-mechanics"><a class="header" href="#infantry-mechanics">Infantry Mechanics</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Infantry sub-cell positioning — up to 5 infantry per cell.
pub struct InfantryBody {
    pub sub_cell: SubCell,  // Center, TopLeft, TopRight, BottomLeft, BottomRight
}

pub enum SubCell { Center, TopLeft, TopRight, BottomLeft, BottomRight }

/// Panic flee behavior (e.g., civilians, dogs).
pub struct ScaredyCat {
    pub flee_range: i32,
    pub panic_ticks: u32,
}

/// Take cover / prone — reduces damage, reduces speed.
pub struct TakeCover {
    pub damage_modifier: i32,   // e.g., 50 (half damage)
    pub speed_modifier: i32,    // e.g., 50 (half speed)
    pub prone_delay: u32,       // ticks to transition to prone
}
<span class="boring">}</span></code></pre>
<p><strong><code>movement_system()</code> integration for infantry:</strong> When infantry moves into a cell, assigns <code>SubCell</code> based on available slots. Up to 5 infantry share one cell in different visual positions. When attacked, infantry with <code>TakeCover</code> auto-goes prone (grants condition “prone” → <code>DamageMultiplier</code> of 50%).</p>
<h3 id="death-mechanics"><a class="header" href="#death-mechanics">Death Mechanics</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Spawn an actor when this entity dies (husks, ejected pilots).
pub struct SpawnOnDeath {
    pub actor_type: ActorId,
    pub probability: i32,   // 0-100, default 100
}

/// Explode on death — apply warheads at position.
pub struct ExplodeOnDeath {
    pub warheads: Vec&lt;WarheadId&gt;,
}

/// Timed self-destruct (demo truck, C4 charge).
pub struct SelfDestruct {
    pub timer: u32,        // ticks remaining
    pub warheads: Vec&lt;WarheadId&gt;,
}

/// Damage visual states.
pub struct DamageStates {
    pub thresholds: Vec&lt;DamageThreshold&gt;,
}

pub struct DamageThreshold {
    pub hp_percent: i32,   // below this → enter this state
    pub state: DamageState,
}

pub enum DamageState { Undamaged, Light, Medium, Heavy, Critical }

/// Victory condition marker — this entity must be destroyed to win.
pub struct MustBeDestroyed;
<span class="boring">}</span></code></pre>
<p><strong><code>death_system()</code> logic:</strong> For entities with <code>Health.current &lt;= 0</code>: check <code>SpawnOnDeath</code> → spawn husk/pilot. Check <code>ExplodeOnDeath</code> → apply warheads at position. Remove entity from world and spatial index. For <code>SelfDestruct</code>: decrement timer each tick in a pre-death pass; when 0, kill the entity (triggers normal death path).</p>
<h3 id="transform--deploy"><a class="header" href="#transform--deploy">Transform / Deploy</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Actor can transform into another type (MCV ↔ ConYard, siege deploy/undeploy).
pub struct Transforms {
    pub into: ActorId,
    pub delay: u32,              // ticks for transformation
    pub facing: Option&lt;i32&gt;,     // required facing to transform
    pub condition: Option&lt;ConditionId&gt;,  // condition granted during transform
}
<span class="boring">}</span></code></pre>
<p><strong>Processing:</strong> Player issues deploy order → <code>transform_system()</code> starts countdown. During <code>delay</code>, entity is immobile (grants condition “deploying”). After delay, replace entity with <code>into</code> actor type, preserving health percentage, owner, and veterancy.</p>
<h3 id="docking-system"><a class="header" href="#docking-system">Docking System</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Building or unit that accepts docking (refinery, helipad, repair pad).
pub struct DockHost {
    pub dock_type: DockType,
    pub dock_position: CellPos,  // where the client unit sits
    pub queue: Vec&lt;EntityId&gt;,    // waiting to dock
    pub occupied: bool,
}

/// Unit that needs to dock (harvester, aircraft, damaged vehicle for repair pad).
pub struct DockClient {
    pub dock_type: DockType,
}

pub enum DockType { Refinery, Helipad, RepairPad }
<span class="boring">}</span></code></pre>
<p><strong><code>docking_system()</code> logic:</strong> For each <code>DockHost</code>: if not occupied and queue non-empty, pull front of queue, guide to <code>dock_position</code>. When docked: execute dock-type-specific logic (refinery → transfer resources; helipad → reload ammo; repair pad → heal). When done, release and advance queue.</p>
<h3 id="veterancy--experience"><a class="header" href="#veterancy--experience">Veterancy / Experience</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// This unit gains XP from kills.
pub struct GainsExperience {
    pub current_xp: i32,
    pub level: VeterancyLevel,
    pub thresholds: Vec&lt;i32&gt;,      // XP required for each level transition
    pub level_conditions: Vec&lt;ConditionId&gt;,  // conditions granted at each level
}

/// This unit awards XP when killed (based on its cost/value).
pub struct GivesExperience {
    pub value: i32,   // XP awarded to killer
}

pub enum VeterancyLevel { Rookie, Veteran, Elite, Heroic }
<span class="boring">}</span></code></pre>
<p><strong><code>veterancy_system()</code> logic:</strong> When <code>death_system()</code> removes an entity with <code>GivesExperience</code>, the killer (if it has <code>GainsExperience</code>) receives <code>value</code> XP. Check <code>thresholds</code>: if XP crosses a boundary, advance <code>level</code> and grant the corresponding condition. Conditions trigger multipliers: veteran = +25% firepower/+25% armor; elite = +50%/+50% + self-heal; heroic = +75%/+75% + faster fire rate (all values from YAML, not hardcoded).</p>
<p><strong>Campaign carry-over (D021):</strong> <code>GainsExperience.current_xp</code> and <code>level</code> are part of the roster snapshot saved between campaign missions.</p>
<h3 id="guard-command"><a class="header" href="#guard-command">Guard Command</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Guard {
    pub target: EntityId,
    pub leash_range: i32,   // max distance from target before returning
}

pub struct Guardable;  // marker: can be guarded
<span class="boring">}</span></code></pre>
<p><strong>Processing in <code>apply_orders()</code>:</strong> Guard order assigns <code>Guard</code> component. <code>combat_system()</code> integration: if a guarding unit’s target is attacked and attacker is within leash range, engage attacker. If target moves beyond leash range, follow.</p>
<h3 id="crush-mechanics"><a class="header" href="#crush-mechanics">Crush Mechanics</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Crushable {
    pub crush_class: CrushClass,
}

pub enum CrushClass { Infantry, Wall, Hedgehog }

/// Vehicles that auto-crush when moving over crushable entities.
pub struct Crusher {
    pub crush_classes: Vec&lt;CrushClass&gt;,
}
<span class="boring">}</span></code></pre>
<p><strong><code>crush_system()</code> logic:</strong> After <code>movement_system()</code>, for each entity with <code>Crusher</code> that moved this tick: query <code>SpatialIndex</code> at new position for entities with matching <code>Crushable.crush_class</code>. Apply instant kill to crushed entities.</p>
<h3 id="crate-system"><a class="header" href="#crate-system">Crate System</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Crate {
    pub action_pool: Vec&lt;CrateAction&gt;,  // weighted random selection
}

pub enum CrateAction {
    Cash { amount: i32 },
    Unit { actor_type: ActorId },
    Heal { percent: i32 },
    LevelUp,
    MapReveal,
    Explode { warhead: WarheadId },
    Cloak { duration: u32 },
    Speed { multiplier: i32, duration: u32 },
}

/// World-level system resource.
pub struct CrateSpawner {
    pub max_crates: u32,
    pub spawn_interval: u32,   // ticks between spawn attempts
    pub spawn_area: SpawnArea,
}
<span class="boring">}</span></code></pre>
<p><strong><code>crate_system()</code> logic:</strong> Periodically spawn crates (up to <code>max_crates</code>). When a unit moves onto a crate: pick random <code>CrateAction</code>, apply effect to collecting unit/player. Remove crate entity.</p>
<h3 id="mine-system"><a class="header" href="#mine-system">Mine System</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Mine {
    pub trigger_types: Vec&lt;TargetType&gt;,
    pub warhead: WarheadId,
    pub visible_to_owner: bool,
}

pub struct Minelayer {
    pub mine_type: ActorId,
    pub lay_delay: u32,
}
<span class="boring">}</span></code></pre>
<p><strong><code>mine_system()</code> logic:</strong> After <code>movement_system()</code>, for each <code>Mine</code>: query spatial index for entities at mine position matching <code>trigger_types</code>. On contact: apply warhead, destroy mine. Mines are invisible to enemy unless detected by mine-sweeper unit (uses <code>DetectCloaked</code> with <code>CloakType::Stealth</code>).</p>
<h3 id="notification-system"><a class="header" href="#notification-system">Notification System</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct NotificationEvent {
    pub event_type: NotificationType,
    pub position: Option&lt;WorldPos&gt;,  // for spatial notifications
    pub player: PlayerId,
}

pub enum NotificationType {
    UnitLost,
    BaseUnderAttack,
    HarvesterUnderAttack,
    BuildingCaptured,
    LowPower,
    SilosNeeded,
    InsufficientFunds,
    BuildingComplete,
    UnitReady,
    NuclearLaunchDetected,
    EnemySpotted,
    ReinforcementsArrived,
}

/// Per-notification-type cooldown (avoid spam).
pub struct NotificationCooldowns {
    pub cooldowns: HashMap&lt;NotificationType, u32&gt;,  // ticks remaining
    pub default_cooldown: u32,                       // typically 150 ticks (~10 sec)
}
<span class="boring">}</span></code></pre>
<p><strong><code>notification_system()</code> logic:</strong> Collects events from other systems (combat → “base under attack”, production → “building complete”, power → “low power”). Checks cooldown for each type. If not on cooldown, queues notification for <code>ic-audio</code> (EVA voice line) and <code>ic-ui</code> (text overlay). Audio mapping is YAML-driven:</p>
<pre><code class="language-yaml">notifications:
  base_under_attack: { audio: "BATL1.AUD", priority: high, cooldown: 300 }
  building_complete: { audio: "CONSTRU2.AUD", priority: normal, cooldown: 0 }
  low_power: { audio: "LOPOWER1.AUD", priority: high, cooldown: 600 }
</code></pre>
<h3 id="cursor-system"><a class="header" href="#cursor-system">Cursor System</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Determines which cursor shows when hovering over a target.
pub struct CursorProvider {
    pub cursor_map: HashMap&lt;CursorContext, CursorDef&gt;,
}

pub enum CursorContext {
    Default,
    Move,
    Attack,
    AttackForce,     // force-fire on ground
    Capture,
    Enter,           // enter transport/building
    Deploy,
    Sell,
    Repair,
    Guard,
    SupportPower(SupportPowerType),
    Chronoshift,
    Nuke,
    Harvest,
    Impassable,
}

pub struct CursorDef {
    pub sprite: SpriteId,
    pub hotspot: (i32, i32),
    pub sequence: Option&lt;AnimSequence&gt;,  // animated cursors
}
<span class="boring">}</span></code></pre>
<p><strong>Logic:</strong> Each frame (render-side, not sim), determine cursor context from: selected units, hovered entity/terrain, active command mode (sell, repair, support power), force modifiers (Ctrl = force-fire, Alt = force-move). Look up <code>CursorDef</code> from <code>CursorProvider</code>. Display.</p>
<h3 id="hotkey-system"><a class="header" href="#hotkey-system">Hotkey System</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct HotkeyConfig {
    pub bindings: HashMap&lt;ActionId, Vec&lt;KeyCombo&gt;&gt;,
    pub profiles: HashMap&lt;String, HotkeyProfile&gt;,
}

pub struct KeyCombo {
    pub key: KeyCode,
    pub modifiers: Modifiers,  // Ctrl, Shift, Alt
}
<span class="boring">}</span></code></pre>
<p><strong>Built-in profiles:</strong></p>
<ul>
<li><code>classic</code> — original RA1 keybindings</li>
<li><code>openra</code> — OpenRA defaults</li>
<li><code>modern</code> — WASD camera, common RTS conventions</li>
</ul>
<p>Fully rebindable in settings UI. Categories: unit commands, production, control groups, camera, chat, debug. Hotkeys produce <code>PlayerOrder</code>s through <code>InputSource</code> — the sim never sees key codes.</p>
<h3 id="game-speed"><a class="header" href="#game-speed">Game Speed</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Lobby-configurable game speed.
pub struct GameSpeed {
    pub preset: SpeedPreset,
    pub tick_interval_ms: u32,   // sim tick period
}

pub enum SpeedPreset {
    Slowest,   // 80ms per tick
    Slower,    // 67ms per tick (default)
    Normal,    // 50ms per tick
    Faster,    // 35ms per tick
    Fastest,   // 20ms per tick
}
<span class="boring">}</span></code></pre>
<p>Speed affects only the interval between sim ticks — system behavior is tick-count-based, so all game logic works identically at any speed. Single-player can change speed mid-game; multiplayer sets it in lobby (synced).</p>
<h3 id="faction-system"><a class="header" href="#faction-system">Faction System</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Faction identity — loaded from YAML.
pub struct Faction {
    pub internal_name: String,   // "allies", "soviet"
    pub display_name: String,    // "Allied Forces"
    pub side: String,            // "allies", "soviet" (for grouping subfactions)
    pub color: PlayerColor,
    pub tech_tree: TechTreeId,
    pub starting_units: Vec&lt;StartingUnit&gt;,
}
<span class="boring">}</span></code></pre>
<p>Factions determine: available tech tree (which units/buildings can be built), default player color, starting unit composition in skirmish, lobby selection, and <code>Buildable.prereqs</code> resolution. RA2 subfactions (e.g., Korea, Libya) share a <code>side</code> but differ in <code>tech_tree</code> (one unique unit each).</p>
<h3 id="auto-target--turret"><a class="header" href="#auto-target--turret">Auto-Target / Turret</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Unit auto-acquires targets within range.
pub struct AutoTarget {
    pub scan_range: i32,
    pub stance: Stance,
    pub prefer_priority: bool,   // prefer high-priority targets
}

pub enum Stance {
    HoldFire,      // never auto-attack
    ReturnFire,    // attack only if attacked
    Defend,        // attack enemies in range
    AttackAnything, // attack anything visible
}

/// Turreted weapon — rotates independently of body.
pub struct Turreted {
    pub turn_speed: i32,
    pub offset: WorldPos,      // turret mount point relative to body
    pub current_facing: i32,   // turret facing (0-255)
}

/// Weapon requires ammo — must reload at dock (helipad).
pub struct AmmoPool {
    pub max_ammo: u32,
    pub current_ammo: u32,
    pub reload_delay: u32,    // ticks per ammo at dock
}
<span class="boring">}</span></code></pre>
<p><strong><code>combat_system()</code> integration:</strong> For units with <code>AutoTarget</code> and no current attack order: scan <code>SpatialIndex</code> within <code>scan_range</code>. Filter by <code>Stance</code> rules. Pick highest-priority valid target. For <code>Turreted</code> units: rotate turret toward target at <code>turn_speed</code> per tick before firing. For <code>AmmoPool</code> units: decrement ammo on fire; when depleted, return to nearest <code>DockHost</code> with <code>DockType::Helipad</code> for reload.</p>
<h3 id="selection-details"><a class="header" href="#selection-details">Selection Details</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct SelectionPriority {
    pub priority: i32,         // higher = selected preferentially
    pub click_priority: i32,   // higher = wins click-through
}
<span class="boring">}</span></code></pre>
<p><strong>Selection features:</strong></p>
<ul>
<li><strong>Priority:</strong> When box-selecting 200 units, combat units are selected over harvesters (higher <code>priority</code>)</li>
<li><strong>Double-click:</strong> Select all units of the same type on screen</li>
<li><strong>Tab cycling:</strong> Cycle through unit types within a selection group</li>
<li><strong>Control groups:</strong> 0-9 control groups, Ctrl+# to assign, # to select, double-# to center camera</li>
<li><strong>Isometric selection box:</strong> Diamond-shaped box selection for proper isometric hit-testing</li>
</ul>
<h3 id="observer--spectator-ui"><a class="header" href="#observer--spectator-ui">Observer / Spectator UI</a></h3>
<p>Observer mode (separate from player mode) displays overlays not available to players:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct ObserverState {
    pub show_army: bool,       // unit composition per player
    pub show_production: bool, // what each player is building
    pub show_economy: bool,    // income rate, credits per player
    pub show_powers: bool,     // superweapon charge timers
    pub show_score: bool,      // strategic score tracker
    pub follow_player: Option&lt;PlayerId&gt;,  // lock camera to player's view
}
<span class="boring">}</span></code></pre>
<p><strong>Army overlay:</strong> Bar chart of unit counts per player, grouped by type. <strong>Production overlay:</strong> List of active queues per player. <strong>Economy overlay:</strong> Income rate graph. These are render-only — no sim interaction. Observer UI is an <code>ic-ui</code> concern.</p>
<h3 id="debug--developer-tools"><a class="header" href="#debug--developer-tools">Debug / Developer Tools</a></h3>
<p>Developer mode (toggled in settings, not available in ranked):</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct DeveloperMode {
    pub instant_build: bool,
    pub free_units: bool,
    pub reveal_map: bool,
    pub unlimited_power: bool,
    pub invincible: bool,
    pub give_cash_amount: i32,
}
<span class="boring">}</span></code></pre>
<p><strong>Debug overlays (via <code>bevy_egui</code>):</strong></p>
<ul>
<li>Combat: weapon ranges as circles, target lines, damage numbers floating</li>
<li>Pathfinding: flowfield visualization, path cost heat map, blocker highlight</li>
<li>Performance: per-system tick time bar chart, entity count, memory usage</li>
<li>Network: RTT graph, order latency, jitter, desync hash comparison</li>
<li>Asset browser: preview sprites, sounds, palettes inline</li>
</ul>
<p>Developer cheats issue special orders validated only when <code>DeveloperMode</code> is active. In multiplayer, all players must agree to enable dev mode (prevents cheating).</p>
<h3 id="localization-framework"><a class="header" href="#localization-framework">Localization Framework</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Localization {
    pub current_locale: String,         // "en", "de", "zh-CN"
    pub bundles: HashMap&lt;String, FluentBundle&gt;,  // locale → string bundle
}
<span class="boring">}</span></code></pre>
<p>Uses <strong>Project Fluent</strong> (same as OpenRA) for parameterized, pluralization-aware message formatting:</p>
<pre><code class="language-fluent"># en.ftl
unit-lost = Unit lost
base-under-attack = Our base is under attack!
building-complete = { $building } construction complete.
units-selected = { $count -&gt;
    [one] {$count} unit selected
   *[other] {$count} units selected
}
</code></pre>
<p>Mods provide their own <code>.ftl</code> files. Engine strings are localizable from Phase 3. Community translations publishable to Workshop.</p>
<h3 id="encyclopedia"><a class="header" href="#encyclopedia">Encyclopedia</a></h3>
<p>In-game unit/building/weapon reference browser:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct EncyclopediaEntry {
    pub actor_type: ActorId,
    pub display_name: String,
    pub description: String,
    pub stats: HashMap&lt;String, String&gt;,  // "Speed: 8", "Armor: Medium"
    pub preview_sprite: SpriteId,
    pub category: EncyclopediaCategory,
}

pub enum EncyclopediaCategory { Infantry, Vehicle, Aircraft, Naval, Structure, Defense, Support }
<span class="boring">}</span></code></pre>
<p>Auto-generated from YAML rule definitions + optional <code>encyclopedia:</code> block in YAML. Accessible from main menu and in-game sidebar. Mod-defined units automatically appear in the encyclopedia.</p>
<h3 id="palette-effects-runtime"><a class="header" href="#palette-effects-runtime">Palette Effects (Runtime)</a></h3>
<p>Beyond static <code>.pal</code> file loading (<code>ra-formats</code>), runtime palette manipulation for classic RA visual style:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum PaletteEffect {
    PlayerColorRemap { remap_range: (u8, u8), target_color: PlayerColor },
    Rotation { start_index: u8, end_index: u8, speed: u32 },  // water animation
    CloakShimmer { entity: EntityId },
    ScreenFlash { color: PaletteColor, duration: u32 },       // nuke, chronoshift
    DamageTint { entity: EntityId, state: DamageState },
}
<span class="boring">}</span></code></pre>
<p><strong>Modern implementation:</strong> These are shader effects in Bevy’s render pipeline, not literal palette index swaps. But the modder-facing YAML configuration matches the original palette effect names for familiarity. Shader implementations achieve the same visual result with modern GPU techniques (color lookup textures, screen-space post-processing).</p>
<h3 id="demolition--c4"><a class="header" href="#demolition--c4">Demolition / C4</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Demolition {
    pub delay: u32,               // ticks to detonation
    pub warhead: WarheadId,
    pub required_target: TargetType,  // buildings only
}
<span class="boring">}</span></code></pre>
<p>Engineer-type unit with <code>Demolition</code> places C4 on a building. After <code>delay</code> ticks, warhead detonates. Target building takes massive damage (usually fatal). Engineer is consumed.</p>
<h3 id="plug-system"><a class="header" href="#plug-system">Plug System</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Pluggable {
    pub plug_type: PlugType,
    pub max_plugs: u32,
    pub current_plugs: u32,
    pub effect_per_plug: ConditionId,
}

pub struct Plug {
    pub plug_type: PlugType,
}
<span class="boring">}</span></code></pre>
<p>Primarily RA2 (bio-reactor accepting infantry for extra power). Included for mod compatibility. When a <code>Plug</code> entity enters a <code>Pluggable</code> building, increment <code>current_plugs</code>, grant condition per plug (e.g., “+50 power per infantry in reactor”).</p>
<hr>
<h2 id="game-loop"><a class="header" href="#game-loop">Game Loop</a></h2>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct GameLoop&lt;N: NetworkModel, I: InputSource&gt; {
    sim: Simulation,
    renderer: Renderer,
    network: N,
    input: I,
    local_player: PlayerId,
    order_buf: Vec&lt;TimestampedOrder&gt;,  // reused across frames — zero allocation on hot path
}

impl&lt;N: NetworkModel, I: InputSource&gt; GameLoop&lt;N, I&gt; {
    fn frame(&amp;mut self) {
        // 1. Gather local input with sub-tick timestamps
        self.input.drain_orders(&amp;mut self.order_buf);
        for order in self.order_buf.drain(..) {
            self.network.submit_order(order);
        }

        // 2. Advance sim as far as confirmed orders allow
        while let Some(tick_orders) = self.network.poll_tick() {
            self.sim.apply_tick(&amp;tick_orders);
            self.network.report_sync_hash(
                self.sim.tick(),
                self.sim.state_hash(),
            );
        }

        // 3. Render always runs, interpolates between sim states
        self.renderer.draw(&amp;self.sim, self.interpolation_factor());
    }
}
<span class="boring">}</span></code></pre>
<p><strong>Key property:</strong> <code>GameLoop</code> is generic over <code>N: NetworkModel</code> and <code>I: InputSource</code>. It has zero knowledge of whether it’s running single-player or multiplayer, or whether input comes from a mouse, touchscreen, or gamepad. This is the central architectural guarantee.</p>
<h2 id="pathfinding--spatial-queries"><a class="header" href="#pathfinding--spatial-queries">Pathfinding &amp; Spatial Queries</a></h2>
<p><strong>Decision:</strong> Pathfinding and spatial queries are abstracted behind traits — like <code>NetworkModel</code>. A multi-layer hybrid pathfinder is the first implementation (RA1 game module). The engine core has no hardcoded assumption about grids vs. continuous space.</p>
<p>OpenRA uses hierarchical A* which struggles with large unit groups and lacks local avoidance. A multi-layer approach (hierarchical sectors + JPS/flowfield tiles + ORCA-lite avoidance) handles both small-group and mass unit movement. But pathfinding is a game-module concern, not an engine-core assumption.</p>
<h3 id="pathfinder-trait"><a class="header" href="#pathfinder-trait">Pathfinder Trait</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Game modules implement this to provide pathfinding.
/// Grid-based games use multi-layer hybrid (JPS + flowfield tiles + avoidance).
/// Continuous-space games would use navmesh.
/// The engine core calls this trait — never a specific algorithm.
pub trait Pathfinder: Send + Sync {
    /// Request a path from origin to destination.
    fn request_path(&amp;mut self, origin: WorldPos, dest: WorldPos, locomotor: LocomotorType) -&gt; PathId;

    /// Poll for completed path. Returns waypoints in WorldPos.
    fn get_path(&amp;self, id: PathId) -&gt; Option&lt;&amp;[WorldPos]&gt;;

    /// Can a unit with this locomotor pass through this position?
    fn is_passable(&amp;self, pos: WorldPos, locomotor: LocomotorType) -&gt; bool;

    /// Invalidate cached paths (e.g., building placed, bridge destroyed).
    fn invalidate_area(&amp;mut self, center: WorldPos, radius: SimCoord);
}
<span class="boring">}</span></code></pre>
<h3 id="spatialindex-trait"><a class="header" href="#spatialindex-trait">SpatialIndex Trait</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Game modules implement this for spatial queries (range checks, collision, targeting).
/// Grid-based games use a spatial hash grid. Continuous-space games could use BVH or R-tree.
/// The engine core queries this trait — never a specific data structure.
pub trait SpatialIndex: Send + Sync {
    /// Find all entities within range of a position.
    fn query_range(&amp;self, center: WorldPos, range: SimCoord, filter: EntityFilter) -&gt; &amp;[EntityId];

    /// Update entity position in the index.
    fn update_position(&amp;mut self, entity: EntityId, old: WorldPos, new: WorldPos);

    /// Remove entity from the index.
    fn remove(&amp;mut self, entity: EntityId);
}
<span class="boring">}</span></code></pre>
<h3 id="why-this-matters"><a class="header" href="#why-this-matters">Why This Matters</a></h3>
<p>This is the same philosophy as <code>WorldPos.z</code> — costs near-zero now, prevents rewrites later:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Abstraction</th><th>Costs Now</th><th>Saves Later</th></tr>
</thead>
<tbody>
<tr><td><code>WorldPos.z</code></td><td>One extra <code>i32</code> per position</td><td>RA2/TS elevation works without restructuring coordinates</td></tr>
<tr><td><code>NetworkModel</code></td><td>One trait + <code>LocalNetwork</code> impl</td><td>Multiplayer netcode slots in without touching sim</td></tr>
<tr><td><code>InputSource</code></td><td>One trait + mouse/keyboard impl</td><td>Touch/gamepad slot in without touching game loop</td></tr>
<tr><td><code>Pathfinder</code></td><td>One trait + multi-layer hybrid impl first</td><td>Navmesh pathfinding slots in; RA1 ships 3 impls (D045)</td></tr>
<tr><td><code>SpatialIndex</code></td><td>One trait + spatial hash impl</td><td>BVH/R-tree slots in without touching combat/targeting</td></tr>
<tr><td><code>FogProvider</code></td><td>One trait + radius fog impl</td><td>Elevation fog, fog-authoritative server slot in</td></tr>
<tr><td><code>DamageResolver</code></td><td>One trait + standard pipeline impl</td><td>Shield-first/sub-object damage models slot in</td></tr>
<tr><td><code>AiStrategy</code></td><td>One trait + personality-driven AI impl</td><td>Neural/planning/custom AI slots in without forking ic-ai</td></tr>
<tr><td><code>RankingProvider</code></td><td>One trait + Glicko-2 impl</td><td>Community servers choose their own rating algorithm</td></tr>
<tr><td><code>OrderValidator</code></td><td>One trait + standard validation impl</td><td>Engine enforces validation; modules can’t skip it silently</td></tr>
</tbody>
</table>
</div>
<p>The RA1 game module registers three <code>Pathfinder</code> implementations — <code>RemastersPathfinder</code>, <code>OpenRaPathfinder</code>, and <code>IcPathfinder</code> (D045) — plus <code>GridSpatialHash</code>. The active pathfinder is selected via experience profiles (D045). A future continuous-space game module registers <code>NavmeshPathfinder</code> and <code>BvhSpatialIndex</code>. The sim core calls the trait — it never knows which one is running. The same principle applies to fog, damage, AI, ranking, and validation — see D041 in <code>09-DECISIONS.md</code> for the full trait definitions and rationale.</p>
<h2 id="platform-portability"><a class="header" href="#platform-portability">Platform Portability</a></h2>
<p>The engine must not create obstacles for any platform. Desktop is the primary dev target, but every architectural choice must be portable to browser (WASM), mobile (Android/iOS), and consoles without rework.</p>
<h3 id="portability-design-rules"><a class="header" href="#portability-design-rules">Portability Design Rules</a></h3>
<ol>
<li>
<p><strong>Input is abstracted behind a trait.</strong> <code>InputSource</code> produces <code>PlayerOrder</code>s — it knows nothing about mice, keyboards, touchscreens, or gamepads. The game loop consumes orders, not raw input events. Each platform provides its own <code>InputSource</code> implementation.</p>
</li>
<li>
<p><strong>UI layout is responsive.</strong> No hardcoded pixel positions. The sidebar, minimap, and build queue use constraint-based layout that adapts to screen size and aspect ratio. Mobile/tablet may use a completely different layout (bottom bar instead of sidebar). <code>ic-ui</code> provides layout <em>profiles</em>, not a single fixed layout.</p>
</li>
<li>
<p><strong>Click-to-world is abstracted behind a trait.</strong> Isometric screen→world (desktop), touch→world (mobile), and raycast→world (3D mod) all implement the same <code>ScreenToWorld</code> trait, producing a <code>WorldPos</code>. Grid-based game modules convert to <code>CellPos</code> as needed. No isometric math or grid assumption hardcoded in the game loop.</p>
</li>
<li>
<p><strong>Render quality is configurable per device.</strong> FPS cap, particle density, post-FX toggles, resolution scaling, shadow quality — all runtime-configurable. Mobile caps at 30fps; desktop targets 60-240fps. The renderer reads a <code>RenderSettings</code> resource, not compile-time constants. Four render quality tiers (Baseline → Standard → Enhanced → Ultra) are auto-detected from <code>wgpu::Adapter</code> capabilities at startup. Tier 0 (Baseline) targets GL 3.3 / WebGL2 hardware — no compute shaders, no post-FX, CPU particle fallback, palette tinting for weather. See <code>10-PERFORMANCE.md</code> § “GPU &amp; Hardware Compatibility” for tier definitions and hardware floor analysis.</p>
</li>
<li>
<p><strong>No raw filesystem I/O.</strong> All asset loading goes through Bevy’s asset system, never <code>std::fs</code> directly. Mobile and browser have sandboxed filesystems; WASM has no filesystem at all. Save games use platform-appropriate storage (e.g., <code>localStorage</code> on web, app sandbox on mobile).</p>
</li>
<li>
<p><strong>App lifecycle is handled.</strong> Mobile and consoles require suspend/resume/save-on-background. The snapshottable sim makes this trivial — <code>snapshot()</code> on suspend, <code>restore()</code> on resume. This must be an engine-level lifecycle hook, not an afterthought.</p>
</li>
<li>
<p><strong>Audio backend is abstracted.</strong> Bevy handles this, but no code should assume a specific audio API. Platform-specific audio routing (e.g., phone speaker vs headphones, console audio mixing policies) is Bevy’s concern.</p>
</li>
</ol>
<h3 id="platform-target-matrix"><a class="header" href="#platform-target-matrix">Platform Target Matrix</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Platform</th><th>Graphics API</th><th>Input Model</th><th>Key Challenge</th><th>Phase</th></tr>
</thead>
<tbody>
<tr><td>Windows / macOS / Linux</td><td>Vulkan / Metal / DX12</td><td>Mouse + keyboard</td><td>Primary target</td><td>1</td></tr>
<tr><td>Steam Deck</td><td>Vulkan (native Linux)</td><td>Gamepad + touchpad</td><td>Gamepad UI controls</td><td>3</td></tr>
<tr><td>Browser (WASM)</td><td>WebGPU / WebGL2</td><td>Mouse + keyboard + touch</td><td>Download size, no filesystem</td><td>7</td></tr>
<tr><td>Android / iOS</td><td>Vulkan / Metal (via wgpu)</td><td>Touch + on-screen controls</td><td>Touch RTS controls, battery, screen size</td><td>8+</td></tr>
<tr><td>Xbox</td><td>DX12 (via GDK)</td><td>Gamepad</td><td>NDA SDK, certification</td><td>8+</td></tr>
<tr><td>PlayStation</td><td>AGC (proprietary)</td><td>Gamepad</td><td>wgpu doesn’t support AGC yet, NDA SDK</td><td>Future</td></tr>
<tr><td>Nintendo Switch</td><td>NVN / Vulkan</td><td>Gamepad + touch (handheld)</td><td>NDA SDK, limited GPU</td><td>Future</td></tr>
</tbody>
</table>
</div>
<h3 id="input-abstraction"><a class="header" href="#input-abstraction">Input Abstraction</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Platform-agnostic input source. Each platform implements this.
pub trait InputSource {
    /// Drain pending player orders from whatever input device is active.
    fn drain_orders(&amp;mut self, buf: &amp;mut Vec&lt;TimestampedOrder&gt;);
    // Caller provides the buffer (reused across ticks — zero allocation on hot path)

    /// Optional: hint about input capabilities for UI adaptation.
    fn capabilities(&amp;self) -&gt; InputCapabilities;
}

pub struct InputCapabilities {
    pub has_mouse: bool,
    pub has_keyboard: bool,
    pub has_touch: bool,
    pub has_gamepad: bool,
    pub screen_size: ScreenClass,  // Phone, Tablet, Desktop, TV
}

pub enum ScreenClass {
    Phone,    // &lt; 7" — bottom bar UI, large touch targets
    Tablet,   // 7-13" — sidebar OK, touch targets
    Desktop,  // 13"+ — full sidebar, mouse precision
    TV,       // 40"+ — large text, gamepad radial menus
}
<span class="boring">}</span></code></pre>
<p><code>ic-ui</code> reads <code>InputCapabilities</code> to choose the appropriate layout profile. The sim never sees any of this.</p>
<h2 id="ui-theme-system-d032"><a class="header" href="#ui-theme-system-d032">UI Theme System (D032)</a></h2>
<p>The UI is split into two orthogonal concerns:</p>
<ul>
<li><strong>Layout profiles</strong> — <em>where</em> things go. Driven by <code>ScreenClass</code> (Phone, Tablet, Desktop, TV). Handles sidebar vs bottom bar, touch target sizes, minimap placement. One per screen class.</li>
<li><strong>Themes</strong> — <em>how</em> things look. Driven by player preference. Handles colors, chrome sprites, fonts, animations, menu backgrounds. Switchable at any time.</li>
</ul>
<h3 id="theme-architecture"><a class="header" href="#theme-architecture">Theme Architecture</a></h3>
<p>Themes are <strong>YAML + sprite sheets</strong> — Tier 1 mods, no code required.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct UiTheme {
    pub name: String,
    pub chrome: ChromeAssets,    // 9-slice panels, button states, scrollbar sprites
    pub colors: ThemeColors,     // primary, secondary, text, highlights
    pub fonts: ThemeFonts,       // menu, body, HUD
    pub main_menu: MainMenuConfig,  // background image or shellmap, music, button layout
    pub ingame: IngameConfig,    // sidebar style, minimap border, build queue chrome
    pub lobby: LobbyConfig,     // panel styling, slot layout
}
<span class="boring">}</span></code></pre>
<h3 id="built-in-themes"><a class="header" href="#built-in-themes">Built-in Themes</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Theme</th><th>Aesthetic</th><th>Inspired By</th></tr>
</thead>
<tbody>
<tr><td>Classic</td><td>Military minimalism — bare buttons, static title screen, Soviet palette</td><td>Original RA1 (1996)</td></tr>
<tr><td>Remastered</td><td>Clean modern military — HD panels, sleek chrome, reverent refinement</td><td>Remastered Collection (2020)</td></tr>
<tr><td>Modern</td><td>Full Bevy UI — dynamic panels, animated transitions, modern game launcher feel</td><td>IC’s own design</td></tr>
</tbody>
</table>
</div>
<p>All art assets are <strong>original creations</strong> — no assets copied from EA or OpenRA. These themes capture aesthetic philosophy, not specific artwork.</p>
<h3 id="shellmap-system"><a class="header" href="#shellmap-system">Shellmap System</a></h3>
<p>Main menu backgrounds can be <strong>live battles</strong> — a real game map with scripted AI running behind the menu UI:</p>
<ul>
<li>Per-theme configuration: Classic uses a static image (faithful to 1996), Remastered/Modern use shellmaps</li>
<li>Maps tagged <code>visibility: shellmap</code> are eligible — random selection on each launch</li>
<li>Shellmaps define camera paths (pan, orbit, or fixed)</li>
<li>Mods automatically get their own shellmaps</li>
</ul>
<h3 id="per-game-module-defaults"><a class="header" href="#per-game-module-defaults">Per-Game-Module Defaults</a></h3>
<p>Each <code>GameModule</code> provides a <code>default_theme()</code> — RA1 defaults to Classic, future modules default to whatever fits their aesthetic. Players override in settings. This pairs naturally with D019 (switchable balance presets): Classic balance + Classic theme = feels like 1996.</p>
<h3 id="community-themes"><a class="header" href="#community-themes">Community Themes</a></h3>
<ul>
<li>Publishable to workshop (D030) as standalone resources</li>
<li>Stack with gameplay mods — a WWII total conversion ships its own olive-drab theme</li>
<li>An “OpenRA-inspired” community theme is a natural contribution</li>
</ul>
<p>See <code>09-DECISIONS.md</code> § D032 for full rationale, YAML schema, and legal notes on asset sourcing.</p>
<h2 id="qol--gameplay-behavior-toggles-d033"><a class="header" href="#qol--gameplay-behavior-toggles-d033">QoL &amp; Gameplay Behavior Toggles (D033)</a></h2>
<p>Every quality-of-life improvement from OpenRA and the Remastered Collection is <strong>individually toggleable</strong> — attack-move, multi-queue production, health bars, range circles, guard command, waypoint queuing, and dozens more. Built-in presets group toggles into coherent profiles:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Preset</th><th>Feel</th></tr>
</thead>
<tbody>
<tr><td><code>vanilla</code></td><td>Authentic 1996 — no modern QoL</td></tr>
<tr><td><code>openra</code></td><td>All OpenRA improvements enabled</td></tr>
<tr><td><code>remastered</code></td><td>Remastered Collection’s specific QoL set</td></tr>
<tr><td><code>iron_curtain</code> (default)</td><td>Best features cherry-picked from all eras</td></tr>
</tbody>
</table>
</div>
<p>Toggles are categorized as <strong>sim-affecting</strong> (production rules, unit commands — synced in lobby) or <strong>client-only</strong> (health bars, range circles — per-player preference). This split preserves determinism (invariant #1) while giving each player visual/UX freedom.</p>
<h3 id="experience-profiles"><a class="header" href="#experience-profiles">Experience Profiles</a></h3>
<p>D019 (balance), D032 (theme), D033 (behavior), D043 (AI behavior), D045 (pathfinding feel), and D048 (render mode) are six independent axes that compose into <strong>experience profiles</strong>. Selecting “Vanilla RA” sets all six to classic in one click. Selecting “Iron Curtain” sets classic balance + modern theme + best QoL + enhanced AI + modern movement + HD graphics. After selecting a profile, any individual setting can still be overridden.</p>
<p>See <code>09-DECISIONS.md</code> § D033 for the full toggle catalog, YAML schema, and sim/client split details. See D043 for AI behavior presets, D045 for pathfinding behavior presets, and D048 for switchable render modes.</p>
<h2 id="crate-dependency-graph"><a class="header" href="#crate-dependency-graph">Crate Dependency Graph</a></h2>
<pre><code>ic-protocol  (shared types: PlayerOrder, TimestampedOrder)
    ↑
    ├── ic-sim      (depends on: ic-protocol, ra-formats)
    ├── ic-net      (depends on: ic-protocol)
    ├── ra-formats  (standalone — .mix, .shp, .pal, YAML)
    ├── ic-render   (depends on: ic-sim for reading state)
    ├── ic-ui       (depends on: ic-sim, ic-render; reads SQLite for player analytics — D034)
    ├── ic-audio    (depends on: ra-formats)
    ├── ic-script   (depends on: ic-sim, ic-protocol)
    ├── ic-ai       (depends on: ic-sim, ic-protocol; reads SQLite for adaptive difficulty — D034)
    ├── ic-llm      (depends on: ic-sim, ic-script, ic-protocol; reads SQLite for personalization — D034)
    ├── ic-editor   (depends on: ic-render, ic-sim, ic-ui, ic-protocol, ra-formats; SDK binary — D038+D040)
    └── ic-game     (depends on: everything above EXCEPT ic-editor)
</code></pre>
<p><strong>Critical boundary:</strong> <code>ic-sim</code> never imports from <code>ic-net</code>. <code>ic-net</code> never imports from <code>ic-sim</code>. They only share <code>ic-protocol</code>. <code>ic-game</code> never imports from <code>ic-editor</code> — the game and SDK are separate binaries that share library crates.</p>
<p><strong>Storage boundary:</strong> <code>ic-sim</code> never reads or writes SQLite (invariant #1). Three crates are read-only consumers of the client-side SQLite database: <code>ic-ui</code> (post-game stats, career page, campaign dashboard), <code>ic-llm</code> (personalized missions, adaptive briefings, coaching), <code>ic-ai</code> (difficulty scaling, counter-strategy selection). Gameplay events are written by a Bevy observer system in <code>ic-game</code>, outside the deterministic sim. See D034 in <code>09-DECISIONS.md</code>.</p>
<h3 id="crate-design-notes"><a class="header" href="#crate-design-notes">Crate Design Notes</a></h3>
<p>Most crates are self-explanatory from the dependency graph, but three that appear in the graph without dedicated design doc sections are detailed here.</p>
<h4 id="ic-audio--sound-music-and-eva"><a class="header" href="#ic-audio--sound-music-and-eva"><code>ic-audio</code> — Sound, Music, and EVA</a></h4>
<p><code>ic-audio</code> is a Bevy audio plugin that handles all game sound: effects, EVA voice lines, music playback, and ambient audio.</p>
<p><strong>Responsibilities:</strong></p>
<ul>
<li><strong>Sound effects:</strong> Weapon fire, explosions, unit acknowledgments, UI clicks. Triggered by sim events (combat, production, movement) via Bevy observer systems.</li>
<li><strong>EVA voice system:</strong> Plays notification audio triggered by <code>notification_system()</code> events. Manages a priority queue — high-priority notifications (nuke launch, base under attack) interrupt low-priority ones. Respects per-notification cooldowns.</li>
<li><strong>Music playback:</strong> Jukebox system with playlist management, track shuffle, and cross-fade. Supports <code>.aud</code> (original RA format via <code>ra-formats</code>) and modern formats (OGG, WAV via Bevy). Theme-specific intro tracks (D032 — Hell March for Classic theme).</li>
<li><strong>Spatial audio:</strong> 3D positional audio for effects — explosions louder when camera is near. Uses Bevy’s spatial audio with listener at camera position.</li>
<li><strong>Ambient soundscapes:</strong> Per-biome ambient loops (waves for coastal maps, wind for snow maps). Weather system (D022) can modify ambient tracks.</li>
</ul>
<p><strong>Key types:</strong></p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct AudioEvent {
    pub sound: SoundId,
    pub position: Option&lt;WorldPos&gt;,  // None = non-positional (UI, EVA, music)
    pub volume: f32,
    pub priority: AudioPriority,
}

pub enum AudioPriority { Ambient, Effect, Voice, EVA, Music }

pub struct Jukebox {
    pub playlist: Vec&lt;TrackId&gt;,
    pub current: usize,
    pub shuffle: bool,
    pub repeat: bool,
    pub crossfade_ms: u32,
}
<span class="boring">}</span></code></pre>
<p><strong>Format support:</strong> <code>.aud</code> (IMA ADPCM, via <code>ra-formats</code> decoder), <code>.ogg</code>, <code>.wav</code>, <code>.mp3</code> (via Bevy/rodio). Audio backend is abstracted by Bevy — no platform-specific code in <code>ic-audio</code>.</p>
<p><strong>Phase:</strong> Core audio (effects, EVA, music) in Phase 3. Spatial audio and ambient soundscapes in Phase 3-4.</p>
<h4 id="ic-ai--skirmish-ai-and-adaptive-difficulty"><a class="header" href="#ic-ai--skirmish-ai-and-adaptive-difficulty"><code>ic-ai</code> — Skirmish AI and Adaptive Difficulty</a></h4>
<p><code>ic-ai</code> provides computer opponents for skirmish and campaign, plus adaptive difficulty scaling.</p>
<p><strong>Architecture:</strong> AI players run as Bevy systems that read visible game state and emit <code>PlayerOrder</code>s through <code>ic-protocol</code>. The sim processes AI orders identically to human orders — no special privileges. AI has no maphack by default (reads only fog-of-war-revealed state), though campaign scripts can grant omniscience for specific AI players via conditions.</p>
<p><strong>Internal structure — priority-based manager hierarchy:</strong> The default <code>PersonalityDrivenAi</code> (D043) uses the dominant pattern found across all surveyed open-source RTS AI implementations (see <code>research/rts-ai-implementation-survey.md</code>):</p>
<pre><code>PersonalityDrivenAi
├── EconomyManager       — harvester assignment, power monitoring, expansion timing
├── ProductionManager    — share-based unit composition, priority-queue build orders, influence-map building placement
├── MilitaryManager      — attack planning, event-driven defense, squad management
└── AiState (shared)     — threat map, resource map, scouting memory
</code></pre>
<p>Key techniques: priority-based resource allocation (from 0 A.D. Petra), share-based unit composition (from OpenRA), influence maps for building placement (from 0 A.D.), tick-gated evaluation (from Generals/Petra), fuzzy engagement logic (from OpenRA), Lanchester-inspired threat scoring (from MicroRTS research). Each manager runs on its own tick schedule — cheap decisions (defense) every tick, expensive decisions (strategic reassessment) every 60 ticks. Total amortized AI budget: &lt;0.5ms per tick for 500 units. All AI working memory is pre-allocated in <code>AiScratch</code> (zero per-tick allocation). Full implementation detail in D043 (<code>09-DECISIONS.md</code>).</p>
<p><strong>AI tiers (YAML-configured):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Tier</th><th>Behavior</th><th>Target Audience</th></tr>
</thead>
<tbody>
<tr><td>Easy</td><td>Slow build, no micro, predictable attacks, doesn’t rebuild</td><td>New players, campaign intro missions</td></tr>
<tr><td>Normal</td><td>Standard build order, basic army composition, attacks at intervals</td><td>Average players</td></tr>
<tr><td>Hard</td><td>Optimized build order, mixed composition, multi-prong attacks</td><td>Experienced players</td></tr>
<tr><td>Brutal</td><td>Near-optimal macro, active micro, expansion, adapts to player</td><td>Competitive practice</td></tr>
</tbody>
</table>
</div>
<p><strong>Key types:</strong></p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// AI personality — loaded from YAML, defines behavior parameters.
pub struct AiPersonality {
    pub name: String,
    pub build_order_priority: Vec&lt;ActorId&gt;,  // what to build first
    pub attack_threshold: i32,               // army value before attacking
    pub aggression: i32,                     // 0-100 scale
    pub expansion_tendency: i32,             // how eagerly AI expands
    pub micro_level: MicroLevel,             // None, Basic, Advanced
    pub tech_preference: TechPreference,     // Rush, Balanced, Tech
}

pub enum MicroLevel { None, Basic, Advanced }
pub enum TechPreference { Rush, Balanced, Tech }
<span class="boring">}</span></code></pre>
<p><strong>Adaptive difficulty (D034 integration):</strong> <code>ic-ai</code> reads the client-side SQLite database (match history, player performance metrics) to calibrate AI difficulty. If the player has lost 5 consecutive games against “Normal” AI, the AI subtly reduces its efficiency. If the player is winning easily, the AI tightens its build order. This is per-player, invisible, and optional (can be disabled in settings).</p>
<p><strong>Shellmap AI:</strong> A stripped-down AI profile specifically for menu background battles (D032 shellmaps). Prioritizes visually dramatic behavior over efficiency — large army clashes, diverse unit compositions, no early rushes. Runs with reduced tick budget since it shares CPU with the menu UI.</p>
<pre><code class="language-yaml"># ai/shellmap.yaml
shellmap_ai:
  personality:
    name: "Shellmap Director"
    aggression: 40
    attack_threshold: 5000     # build up large armies before engaging
    micro_level: basic
    tech_preference: balanced
    build_order_priority: [power_plant, barracks, war_factory, ore_refinery]
    dramatic_mode: true        # prefer diverse unit mixes, avoid cheese strategies
    max_tick_budget_us: 2000   # 2ms max per AI tick (shellmap is background)
</code></pre>
<p><strong>Lua/WASM AI mods:</strong> Community can implement custom AI via Lua (Tier 2) or WASM (Tier 3). Custom AI implements the <code>AiStrategy</code> trait (D041) and is selectable in the lobby. The engine provides <code>ic-ai</code>’s built-in <code>PersonalityDrivenAi</code> as the default; mods can replace or extend it.</p>
<p><strong>AiStrategy Trait (D041):</strong></p>
<p><code>AiPersonality</code> tunes parameters within a fixed decision algorithm. For modders who want to replace the algorithm entirely (neural net, GOAP planner, MCTS, scripted state machine), the <code>AiStrategy</code> trait abstracts the decision-making:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Game modules and mods implement this for AI opponents.
/// Default: PersonalityDrivenAi (behavior trees driven by AiPersonality YAML).
pub trait AiStrategy: Send + Sync {
    /// Called once per AI player per tick. Reads fog-filtered state, emits orders.
    fn decide(
        &amp;mut self,
        player: PlayerId,
        view: &amp;FogFilteredView,
        tick: u64,
    ) -&gt; Vec&lt;PlayerOrder&gt;;

    /// Human-readable name for lobby display.
    fn name(&amp;self) -&gt; &amp;str;

    /// Difficulty tier for UI categorization.
    fn difficulty(&amp;self) -&gt; AiDifficulty;

    /// Per-tick compute budget hint (microseconds). None = no limit.
    fn tick_budget_hint(&amp;self) -&gt; Option&lt;u64&gt;;
}
<span class="boring">}</span></code></pre>
<p><code>FogFilteredView</code> ensures AI honesty — the AI sees only what its units see, just like a human player. Campaign scripts can grant omniscience via conditions. AI strategies are selectable in the lobby: “IC Default (Normal)”, “Workshop: Neural Net v2.1”, etc. See D041 in <code>09-DECISIONS.md</code> for full rationale.</p>
<p><strong>Phase:</strong> Basic skirmish AI (Easy/Normal) in Phase 4. Hard/Brutal + adaptive difficulty in Phase 5-6a.</p>
<h4 id="ic-script--lua-and-wasm-mod-runtimes"><a class="header" href="#ic-script--lua-and-wasm-mod-runtimes"><code>ic-script</code> — Lua and WASM Mod Runtimes</a></h4>
<p><code>ic-script</code> hosts the Lua and WASM mod execution environments. It bridges the stable mod API surface to engine internals via a compatibility adapter layer.</p>
<p><strong>Architecture:</strong></p>
<pre><code>  Mod code (Lua / WASM)
        │
        ▼
  ┌─────────────────────────┐
  │  Mod API Surface        │  ← versioned, stable (D024 globals, WASM host fns)
  ├─────────────────────────┤
  │  ic-script              │  ← this crate: runtime management, sandboxing, adaptation
  ├─────────────────────────┤
  │  ic-sim + ic-protocol   │  ← engine internals (can change between versions)
  └─────────────────────────┘
</code></pre>
<p><strong>Responsibilities:</strong></p>
<ul>
<li><strong>Lua runtime management:</strong> Initializes <code>mlua</code> with deterministic seed, registers all API globals (D024), enforces <code>LuaExecutionLimits</code>, manages per-mod Lua states.</li>
<li><strong>WASM runtime management:</strong> Initializes <code>wasmtime</code> with fuel metering, registers WASM host functions, enforces <code>WasmExecutionLimits</code>, manages per-mod WASM instances.</li>
<li><strong>Mod lifecycle:</strong> Load → initialize → per-tick callbacks → unload. Mods are loaded at game start (not hot-reloaded mid-game in multiplayer — determinism).</li>
<li><strong>Compatibility adapter:</strong> Translates stable mod API calls to current engine internals. When engine internals change, this adapter is updated — mods don’t notice. See <code>04-MODDING.md</code> § “Compatibility Adapter Layer”.</li>
<li><strong>Sandbox enforcement:</strong> No filesystem, no network, no raw memory access. All mod I/O goes through the host API. Capability-based security per mod.</li>
<li><strong>Campaign state:</strong> Manages <code>Campaign.*</code> and <code>Var.*</code> state for branching campaigns (D021). Campaign variables are stored in save games.</li>
</ul>
<p><strong>Key types:</strong></p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct ScriptRuntime {
    pub lua_states: HashMap&lt;ModId, LuaState&gt;,
    pub wasm_instances: HashMap&lt;ModId, WasmInstance&gt;,
    pub api_version: ModApiVersion,
}

pub struct LuaState {
    pub vm: mlua::Lua,
    pub limits: LuaExecutionLimits,
    pub mod_id: ModId,
}

pub struct WasmInstance {
    pub instance: wasmtime::Instance,
    pub limits: WasmExecutionLimits,
    pub capabilities: ModCapabilities,
    pub mod_id: ModId,
}
<span class="boring">}</span></code></pre>
<p><strong>Determinism guarantee:</strong> Both Lua and WASM execute at a fixed point in the system pipeline (<code>trigger_system()</code> step). All clients run the same mod code with the same game state at the same tick. Lua’s string hash seed is fixed. WASM is inherently deterministic. <code>math.random()</code> is replaced with the sim’s deterministic PRNG.</p>
<p><strong>Phase:</strong> Lua runtime in Phase 4. WASM runtime in Phase 4-5. Mod API versioning in Phase 6a.</p>
<h2 id="multi-game-extensibility-game-modules"><a class="header" href="#multi-game-extensibility-game-modules">Multi-Game Extensibility (Game Modules)</a></h2>
<p>The engine is designed as a <strong>game-agnostic RTS framework</strong> (D039) that ships with Red Alert (default) and Tiberian Dawn as built-in game modules. The same engine can run RA2, Dune 2000, or an original game as additional game modules — like OpenRA runs TD, RA, and D2K on one engine.</p>
<h3 id="game-module-concept"><a class="header" href="#game-module-concept">Game Module Concept</a></h3>
<p>A game module is a bundle of:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Each supported game implements this trait.
pub trait GameModule {
    /// Register ECS components (unit types, mechanics) into the world.
    fn register_components(&amp;self, world: &amp;mut World);

    /// Return the ordered system pipeline for this game's simulation tick.
    fn system_pipeline(&amp;self) -&gt; Vec&lt;Box&lt;dyn System&gt;&gt;;

    /// Provide the pathfinding implementation (selected by lobby/experience profile, D045).
    fn pathfinder(&amp;self) -&gt; Box&lt;dyn Pathfinder&gt;;

    /// Provide the spatial index implementation (spatial hash, BVH, etc.).
    fn spatial_index(&amp;self) -&gt; Box&lt;dyn SpatialIndex&gt;;

    /// Provide the fog of war implementation (radius, elevation LOS, etc.).
    fn fog_provider(&amp;self) -&gt; Box&lt;dyn FogProvider&gt;;

    /// Provide the damage resolution algorithm (standard, shield-first, etc.).
    fn damage_resolver(&amp;self) -&gt; Box&lt;dyn DamageResolver&gt;;

    /// Provide order validation logic (D041 — engine enforces this before apply_orders).
    fn order_validator(&amp;self) -&gt; Box&lt;dyn OrderValidator&gt;;

    /// Register format loaders (e.g., .vxl for RA2, .shp for RA1).
    fn register_format_loaders(&amp;self, registry: &amp;mut FormatRegistry);

    /// Register render backends (sprite renderer, voxel renderer, etc.).
    fn register_renderers(&amp;self, registry: &amp;mut RenderRegistry);

    /// List available render modes — Classic, HD, 3D, etc. (D048).
    fn render_modes(&amp;self) -&gt; Vec&lt;RenderMode&gt;;

    /// YAML rule schema for this game's unit definitions.
    fn rule_schema(&amp;self) -&gt; RuleSchema;
}
<span class="boring">}</span></code></pre>
<h3 id="what-the-engine-provides-game-agnostic"><a class="header" href="#what-the-engine-provides-game-agnostic">What the engine provides (game-agnostic)</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Layer</th><th>Game-Agnostic</th><th>Game-Module-Specific</th></tr>
</thead>
<tbody>
<tr><td><strong>Sim core</strong></td><td><code>Simulation</code>, <code>apply_tick()</code>, <code>snapshot()</code>, state hashing, order validation pipeline</td><td>Components, systems, rules, resource types</td></tr>
<tr><td><strong>Positions</strong></td><td><code>WorldPos { x, y, z }</code></td><td><code>CellPos</code> (grid-based modules), coordinate mapping, z usage</td></tr>
<tr><td><strong>Pathfinding</strong></td><td><code>Pathfinder</code> trait, <code>SpatialIndex</code> trait</td><td>Remastered/OpenRA/IC flowfield (RA1, D045), navmesh (future), spatial hash vs BVH</td></tr>
<tr><td><strong>Fog of war</strong></td><td><code>FogProvider</code> trait</td><td>Radius fog (RA1), elevation LOS (RA2/TS), no fog (sandbox)</td></tr>
<tr><td><strong>Damage</strong></td><td><code>DamageResolver</code> trait</td><td>Standard pipeline (RA1), shield-first (RA2), sub-object (Generals)</td></tr>
<tr><td><strong>Validation</strong></td><td><code>OrderValidator</code> trait (engine-enforced)</td><td>Per-module validation rules (ownership, affordability, placement, etc.)</td></tr>
<tr><td><strong>Networking</strong></td><td><code>NetworkModel</code> trait, relay server, lockstep, replays</td><td><code>PlayerOrder</code> variants (game-specific commands)</td></tr>
<tr><td><strong>Rendering</strong></td><td>Camera, sprite batching, UI framework; post-FX pipeline available to modders</td><td>Sprite renderer (RA1), voxel renderer (RA2), mesh renderer (3D mod/future)</td></tr>
<tr><td><strong>Modding</strong></td><td>YAML loader, Lua runtime, WASM sandbox, workshop</td><td>Rule schemas, API surface exposed to scripts</td></tr>
<tr><td><strong>Formats</strong></td><td>Archive loading, format registry</td><td><code>.mix</code>/<code>.shp</code> (RA1), <code>.vxl</code>/<code>.hva</code> (RA2), <code>.big</code>/<code>.w3d</code> (future), map format</td></tr>
</tbody>
</table>
</div>
<h3 id="ra2-extension-points"><a class="header" href="#ra2-extension-points">RA2 Extension Points</a></h3>
<p>RA2 / Tiberian Sun would add these to the existing engine without modifying the core:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Extension</th><th>What It Adds</th><th>Engine Change Required</th></tr>
</thead>
<tbody>
<tr><td>Voxel models (<code>.vxl</code>, <code>.hva</code>)</td><td>New format parsers</td><td>None — additive to <code>ra-formats</code></td></tr>
<tr><td>Terrain elevation</td><td>Z-axis in pathfinding, ramps, cliffs</td><td>None — <code>WorldPos.z</code> and <code>CellPos.z</code> are already there</td></tr>
<tr><td>Voxel rendering</td><td>GPU voxel-to-sprite at runtime</td><td>New render backend in <code>RenderRegistry</code></td></tr>
<tr><td>Garrison mechanic</td><td><code>Garrisonable</code>, <code>Garrisoned</code> components + system</td><td>New components + system in pipeline</td></tr>
<tr><td>Mind control</td><td><code>MindController</code>, <code>MindControlled</code> components + system</td><td>New components + system in pipeline</td></tr>
<tr><td>IFV weapon swap</td><td><code>WeaponOverride</code> component</td><td>New component</td></tr>
<tr><td>Prism forwarding</td><td><code>PrismForwarder</code> component + chain calculation system</td><td>New component + system</td></tr>
<tr><td>Bridges / tunnels</td><td>Layered pathing with Z transitions</td><td>Uses existing <code>CellPos.z</code></td></tr>
</tbody>
</table>
</div>
<h3 id="current-target-the-isometric-cc-family"><a class="header" href="#current-target-the-isometric-cc-family">Current Target: The Isometric C&amp;C Family</a></h3>
<p>The <strong>first-party game modules</strong> target the <strong>isometric C&amp;C family</strong>: Red Alert, Red Alert 2, Tiberian Sun, Tiberian Dawn, and Dune 2000 (plus expansions and total conversions in the same visual paradigm). These games share:</p>
<ul>
<li>Fixed isometric camera</li>
<li>Grid-based terrain (with optional elevation for TS/RA2)</li>
<li>Sprite and/or voxel-to-sprite rendering</li>
<li><code>.mix</code> archives and related format lineage</li>
<li>Discrete cell-based pathfinding (flowfields, hierarchical A*)</li>
</ul>
<h3 id="architectural-openness-beyond-isometric"><a class="header" href="#architectural-openness-beyond-isometric">Architectural Openness: Beyond Isometric</a></h3>
<p>C&amp;C Generals and later 3D titles (C&amp;C3, RA3) are <strong>not current targets</strong> — we build only grid-based pathfinding and isometric rendering today. But the architecture deliberately avoids closing doors:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Engine Concern</th><th>Grid Assumption?</th><th>Trait-Abstracted?</th><th>3D/Continuous Game Needs…</th></tr>
</thead>
<tbody>
<tr><td>Coordinates</td><td>No (<code>WorldPos</code>)</td><td>N/A — universal</td><td>Nothing. <code>WorldPos</code> works for any spatial model.</td></tr>
<tr><td>Pathfinding</td><td>Implementation</td><td>Yes (<code>Pathfinder</code> trait)</td><td>A <code>NavmeshPathfinder</code> impl. Zero sim changes.</td></tr>
<tr><td>Spatial queries</td><td>Implementation</td><td>Yes (<code>SpatialIndex</code> trait)</td><td>A <code>BvhSpatialIndex</code> impl. Zero combat/targeting changes.</td></tr>
<tr><td>Fog of war</td><td>Implementation</td><td>Yes (<code>FogProvider</code> trait)</td><td>An <code>ElevationFogProvider</code> impl. Zero sim changes.</td></tr>
<tr><td>Damage resolution</td><td>Implementation</td><td>Yes (<code>DamageResolver</code> trait)</td><td>A <code>SubObjectDamageResolver</code> impl. Zero projectile changes.</td></tr>
<tr><td>Order validation</td><td>Implementation</td><td>Yes (<code>OrderValidator</code> trait)</td><td>Module-specific rules. Engine still enforces the contract.</td></tr>
<tr><td>AI strategy</td><td>Implementation</td><td>Yes (<code>AiStrategy</code> trait)</td><td>Module-specific AI. Same lobby selection UI.</td></tr>
<tr><td>Rendering</td><td>Implementation</td><td>Yes (<code>Renderable</code> trait)</td><td>A mesh renderer impl. Already documented (“3D Rendering as a Mod”).</td></tr>
<tr><td>Camera</td><td>Implementation</td><td>Yes (<code>ScreenToWorld</code> trait)</td><td>A perspective camera impl. Already documented.</td></tr>
<tr><td>Input</td><td>No (<code>InputSource</code>)</td><td>Yes</td><td>Nothing. Orders are orders.</td></tr>
<tr><td>Networking</td><td>No</td><td>Yes (<code>NetworkModel</code> trait)</td><td>Nothing. Lockstep works regardless of spatial model.</td></tr>
<tr><td>Format loaders</td><td>Implementation</td><td>Yes (<code>FormatRegistry</code>)</td><td>New parsers for <code>.big</code>, <code>.w3d</code>, etc. Additive.</td></tr>
<tr><td>Building placement</td><td>Data-driven</td><td>N/A — YAML rules + components</td><td>Different components (no <code>RequiresBuildableArea</code>). YAML change.</td></tr>
</tbody>
</table>
</div>
<p>The key insight: the engine core (<code>Simulation</code>, <code>apply_tick()</code>, <code>GameLoop</code>, <code>NetworkModel</code>, <code>Pathfinder</code>, <code>SpatialIndex</code>, <code>FogProvider</code>, <code>DamageResolver</code>, <code>OrderValidator</code>) is spatial-model-agnostic. Grid-based pathfinding is a <em>game module implementation</em>, not an engine assumption — the same way <code>LocalNetwork</code> is a network implementation, not the only possible one.</p>
<p>A Generals-class game module would provide its own <code>Pathfinder</code> (navmesh), <code>SpatialIndex</code> (BVH), <code>FogProvider</code> (elevation LOS), <code>DamageResolver</code> (sub-object targeting), <code>AiStrategy</code> (custom AI), <code>Renderable</code> (mesh), and format loaders — while reusing the sim core, networking, modding infrastructure, workshop, competitive infrastructure, and all shared systems (production, veterancy, replays, save games). See D041 in <code>09-DECISIONS.md</code> for the full trait-abstraction strategy.</p>
<p>This is not a current development target. We build only the grid implementations. But the trait seams exist from day one, so the door stays open — for us or for the community.</p>
<h3 id="3d-rendering-as-a-mod-not-a-game-module"><a class="header" href="#3d-rendering-as-a-mod-not-a-game-module">3D Rendering as a Mod (Not a Game Module)</a></h3>
<p>While 3D C&amp;C titles are not current development targets, the architecture explicitly supports <strong>3D rendering mods</strong> for any game module. A “3D Red Alert” mod replaces the visual presentation while the simulation, networking, pathfinding, and rules are completely unchanged.</p>
<p>This works because the sim/render split is absolute — the sim has no concept of camera, sprites, or visual style. Bevy already ships a full 3D pipeline (PBR materials, GLTF loading, skeletal animation, dynamic lighting, shadows), so a 3D render mod leverages existing infrastructure.</p>
<p><strong>What changes vs. what doesn’t:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Layer</th><th>3D Mod Changes?</th><th>Details</th></tr>
</thead>
<tbody>
<tr><td>Simulation</td><td>No</td><td>Same tick, same rules, same grid</td></tr>
<tr><td>Pathfinding</td><td>No</td><td>Grid-based flowfields still work (SC2 is 3D but uses grid pathing). A future game module could provide a <code>NavmeshPathfinder</code> instead — independent of the render mod.</td></tr>
<tr><td>Networking</td><td>No</td><td>Orders are orders</td></tr>
<tr><td>Rules / YAML</td><td>No</td><td>Tank still costs 800, has 400 HP</td></tr>
<tr><td>Rendering</td><td>Yes</td><td>Sprites → GLTF meshes, isometric camera → free 3D camera</td></tr>
<tr><td>Input mapping</td><td>Yes</td><td>Click-to-world changes from isometric transform to 3D raycast</td></tr>
</tbody>
</table>
</div>
<p><strong>Architectural requirements to enable this:</strong></p>
<ol>
<li><strong><code>Renderable</code> trait is mod-swappable.</strong> A WASM Tier 3 mod can register a 3D render backend that replaces the default sprite renderer.</li>
<li><strong>Camera system is configurable.</strong> Default is fixed isometric; a 3D mod substitutes a free-rotating perspective camera. The camera is purely a render concern — the sim has no camera concept.</li>
<li><strong>Asset pipeline accepts 3D models.</strong> Bevy natively loads GLTF/GLB. The mod maps unit IDs to 3D model paths in YAML:</li>
</ol>
<pre><code class="language-yaml"># Classic 2D (default)
rifle_infantry:
  render:
    type: sprite
    sequences: e1

# 3D mod override
rifle_infantry:
  render:
    type: mesh
    model: models/infantry/rifle.glb
    animations:
      idle: Idle
      move: Run
      attack: Shoot
</code></pre>
<ol start="4">
<li><strong>Click-to-world abstracted behind trait.</strong> Isometric screen→world is a linear transform. 3D perspective screen→world is a raycast. Both produce a <code>WorldPos</code>. Grid-based game modules convert to <code>CellPos</code> as needed.</li>
<li><strong>Terrain rendering decoupled from terrain data.</strong> The sim’s spatial representation is authoritative. A 3D mod provides visual terrain geometry that matches it.</li>
</ol>
<p><strong>Key benefits:</strong></p>
<ul>
<li><strong>Cross-view multiplayer.</strong> A player running 3D can play against a player running classic isometric — the sim is identical. Like StarCraft Remastered’s graphics toggle, but more radical.</li>
<li><strong>Cross-view replays.</strong> Watch any replay in 2D or 3D.</li>
<li><strong>Orthogonal to gameplay mods.</strong> A balance mod works in both views. A 3D graphics mod stacks with a gameplay mod.</li>
<li><strong>Toggleable, not permanent.</strong> D048 (Switchable Render Modes) formalizes this: a 3D render mod adds a render mode alongside the default 2D modes. F1 cycles between classic, HD, and 3D — the player isn’t locked into one view. See <code>09-DECISIONS.md</code> § D048.</li>
</ul>
<p>This is a <strong>Tier 3 (WASM) mod</strong> — it replaces a rendering backend, which is too deep for YAML or Lua. See <code>04-MODDING.md</code> for details.</p>
<h3 id="design-rules-for-multi-game-safety"><a class="header" href="#design-rules-for-multi-game-safety">Design Rules for Multi-Game Safety</a></h3>
<ol>
<li><strong>No game-specific enums in engine core.</strong> Don’t put <code>enum ResourceType { Ore, Gems }</code> in <code>ic-sim</code>. Resource types come from YAML rules / game module registration.</li>
<li><strong>Position is always 3D.</strong> <code>WorldPos</code> carries Z. RA1 sets it to 0. The cost is one extra <code>i32</code> per position — negligible. <code>CellPos</code> is a grid-game-module convenience type, not an engine-core requirement.</li>
<li><strong>Pathfinding and spatial queries are behind traits.</strong> <code>Pathfinder</code> and <code>SpatialIndex</code> — like <code>NetworkModel</code>. Grid implementations are the default; the engine core never calls grid-specific functions directly.</li>
<li><strong>System pipeline is data, not code.</strong> The game module returns its system list; the engine executes it. No hardcoded <code>harvester_system()</code> call in engine core.</li>
<li><strong>Render through <code>Renderable</code> trait.</strong> Sprites and voxels implement the same trait. The renderer doesn’t know what it’s drawing.</li>
<li><strong>Format loaders are pluggable.</strong> <code>ra-formats</code> provides parsers; the game module tells the asset pipeline which ones to use.</li>
<li><strong><code>PlayerOrder</code> is extensible.</strong> Use an enum with a <code>Custom(GameSpecificOrder)</code> variant, or make orders generic over the game module.</li>
<li><strong>Fog, damage, and validation are behind traits (D041).</strong> <code>FogProvider</code>, <code>DamageResolver</code>, and <code>OrderValidator</code> — each game module supplies its own implementation. The engine core calls trait methods, never game-specific fog/damage/validation logic directly.</li>
<li><strong>AI strategy is behind a trait (D041).</strong> <code>AiStrategy</code> lets each game module (or difficulty preset) supply different decision-making logic. The engine schedules AI ticks; the strategy decides what to do.</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="01-VISION.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="03-NETCODE.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="01-VISION.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="03-NETCODE.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>

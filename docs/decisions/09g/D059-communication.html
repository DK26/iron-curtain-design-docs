<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>D059 — Communication - Iron Curtain — Design Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Design docs for a Rust-native Red Alert RTS engine">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../../css/general-2459343d.css">
        <link rel="stylesheet" href="../../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex-61d2369b.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc-1553b04b.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Iron Curtain — Design Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/DK26/iron-curtain-design-docs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>
                        <a href="https://github.com/DK26/iron-curtain-design-docs/edit/main/src/decisions/09g/D059-communication.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <span class=fa-svg id="git-edit-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M421.7 220.3l-11.3 11.3-22.6 22.6-205 205c-6.6 6.6-14.8 11.5-23.8 14.1L30.8 511c-8.4 2.5-17.5 .2-23.7-6.1S-1.5 489.7 1 481.2L38.7 353.1c2.6-9 7.5-17.2 14.1-23.8l205-205 22.6-22.6 11.3-11.3 33.9 33.9 62.1 62.1 33.9 33.9zM96 353.9l-9.3 9.3c-.9 .9-1.6 2.1-2 3.4l-25.3 86 86-25.3c1.3-.4 2.5-1.1 3.4-2l9.3-9.3H112c-8.8 0-16-7.2-16-16V353.9zM453.3 19.3l39.4 39.4c25 25 25 65.5 0 90.5l-14.5 14.5-22.6 22.6-11.3 11.3-33.9-33.9-62.1-62.1L314.3 67.7l11.3-11.3 22.6-22.6 14.5-14.5c25-25 65.5-25 90.5 0z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h2 id="d059-in-game-communication--text-chat-voice-beacons-and-coordination"><a class="header" href="#d059-in-game-communication--text-chat-voice-beacons-and-coordination">D059: In-Game Communication — Text Chat, Voice, Beacons, and Coordination</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th></th><th></th></tr>
</thead>
<tbody>
<tr><td><strong>Status</strong></td><td>Accepted</td></tr>
<tr><td><strong>Phase</strong></td><td>Phase 3 (text chat, beacons), Phase 5 (VoIP, voice-in-replay)</td></tr>
<tr><td><strong>Depends on</strong></td><td>D006 (NetworkModel), D007 (Relay Server), D024 (Lua API), D033 (QoL Toggles), D054 (Transport), D058 (Chat/Command Console)</td></tr>
<tr><td><strong>Driver</strong></td><td>No open-source RTS has built-in VoIP. OpenRA has no voice chat. The Remastered Collection added basic lobby voice via Steam. This is a major opportunity for IC to set the standard.</td></tr>
</tbody>
</table>
</div>
<h3 id="problem"><a class="header" href="#problem">Problem</a></h3>
<p>RTS multiplayer requires three kinds of player coordination:</p>
<ol>
<li><strong>Text communication</strong> — chat channels (all, team, whisper), emoji, mod-registered phrases</li>
<li><strong>Voice communication</strong> — push-to-talk VoIP for real-time callouts during gameplay</li>
<li><strong>Spatial signaling</strong> — beacons, pings, map markers, tactical annotations that convey <em>where</em> and <em>what</em> without words</li>
</ol>
<p>D058 designed the text input/command system (chat box, <code>/</code> prefix routing, command dispatch). What D058 did NOT address:</p>
<ul>
<li>Chat <strong>channel routing</strong> — how messages reach the right recipients (all, team, whisper, observers)</li>
<li><strong>VoIP architecture</strong> — codec, transport, relay integration, bandwidth management</li>
<li><strong>Beacons and pings</strong> — the non-verbal coordination layer that Apex Legends proved is often more effective than voice</li>
<li><strong>Voice-in-replay</strong> — whether and how voice recordings are preserved for replay playback</li>
<li>How all three systems integrate with the existing <code>MessageLane</code> infrastructure (<code>03-NETCODE.md</code>) and <code>Transport</code> trait (D054)</li>
</ul>
<h3 id="decision"><a class="header" href="#decision">Decision</a></h3>
<p>Build a unified coordination system with three tiers: text chat channels, relay-forwarded VoIP, and a contextual ping/beacon system — plus novel coordination tools (chat wheel, minimap drawing, tactical markers). Voice is optionally recorded into replays as a separate stream with explicit consent.</p>
<p><strong>Revision note (2026-02-22):</strong> Revised platform guidance to define mobile minimap/bookmark coexistence (minimap cluster + adjacent bookmark dock) and explicit touch interaction precedence so future mobile coordination features (pings, chat wheel, minimap drawing) do not conflict with fast camera navigation. This revision was informed by mobile RTS UX research and touch-layout requirements (see <code>research/mobile-rts-ux-onboarding-community-platform-analysis.md</code>).</p>
<h3 id="decision-capsule-llmrag-summary"><a class="header" href="#decision-capsule-llmrag-summary">Decision Capsule (LLM/RAG Summary)</a></h3>
<ul>
<li><strong>Status:</strong> Accepted (Revised 2026-02-22)</li>
<li><strong>Phase:</strong> Phase 3 (text chat, beacons), Phase 5 (VoIP, voice-in-replay)</li>
<li><strong>Canonical for:</strong> In-game communication architecture (text chat, voice, pings/beacons, tactical coordination) and integration with commands/replay/network lanes</li>
<li><strong>Scope:</strong> <code>ic-ui</code> chat/voice/ping UX, <code>ic-net</code> message lanes/relay forwarding, replay voice stream policy, moderation/muting, mobile coordination input behavior</li>
<li><strong>Decision:</strong> IC provides a unified coordination system with <strong>text chat channels</strong>, <strong>relay-forwarded VoIP</strong>, and <strong>contextual pings/beacons/markers</strong>, with optional voice recording in replays via explicit consent.</li>
<li><strong>Why:</strong> RTS coordination needs verbal, textual, and spatial communication; open-source RTS projects under-serve VoIP and modern ping tooling; IC can set a higher baseline.</li>
<li><strong>Non-goals:</strong> Text-only communication as the sole coordination path; separate mobile and desktop communication rules that change gameplay semantics.</li>
<li><strong>Invariants preserved:</strong> Communication integrates with existing order/message infrastructure; D058 remains the input/command console foundation and D012 validation remains relevant for command-side actions.</li>
<li><strong>Defaults / UX behavior:</strong> Text chat channels are first-class and sticky; voice is optional; advanced coordination tools (chat wheel/minimap drawing/tactical markers) layer onto the same system.</li>
<li><strong>Mobile / accessibility impact:</strong> Mobile minimap and bookmark dock coexist in one cluster with explicit touch precedence rules to avoid conflicts between camera navigation and communication gestures.</li>
<li><strong>Security / Trust impact:</strong> Moderation, muting, observer restrictions, and replay/voice consent rules are part of the core communication design.</li>
<li><strong>Public interfaces / types / commands:</strong> <code>ChatChannel</code>, chat message orders/routing, voice packet/lane formats, beacon/ping/tactical marker events (see body sections)</li>
<li><strong>Affected docs:</strong> <code>src/03-NETCODE.md</code>, <code>src/06-SECURITY.md</code>, <code>src/17-PLAYER-FLOW.md</code>, <code>src/decisions/09g-interaction.md</code> (D058/D065)</li>
<li><strong>Revision note summary:</strong> Added mobile minimap/bookmark cluster coexistence and touch precedence so communication gestures do not break mobile camera navigation.</li>
<li><strong>Keywords:</strong> chat, voip, pings, beacons, minimap drawing, communication lanes, replay voice, mobile coordination, command console integration</li>
</ul>
<h3 id="1-text-chat--channel-architecture"><a class="header" href="#1-text-chat--channel-architecture">1. Text Chat — Channel Architecture</a></h3>
<p>D058 defined the chat <em>input</em> system. This section defines the chat <em>routing</em> system — how messages are delivered to the correct recipients.</p>
<h4 id="channel-model"><a class="header" href="#channel-model">Channel Model</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Chat channel identifiers. Sent as part of every ChatMessage order.
/// The channel determines who receives the message. Channel selection
/// is sticky — the player's last-used channel persists until changed.
#[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, Serialize, Deserialize)]
pub enum ChatChannel {
    /// All players and observers see the message.
    All,
    /// Only players on the same team (including shared-control allies).
    Team,
    /// Private message to a specific player. Not visible to others.
    /// Observers cannot whisper to players (anti-coaching, V41).
    Whisper { target: PlayerId },
    /// Observer-only channel. Players do not see these messages.
    /// Prevents spectator coaching during live games (V41).
    Observer,
}
<span class="boring">}</span></code></pre>
<h4 id="chat-message-order"><a class="header" href="#chat-message-order">Chat Message Order</a></h4>
<p>Chat messages flow through the order pipeline — they are <code>PlayerOrder</code> variants, validated by the sim (D012), and replayed deterministically:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Chat message as a player order. Part of the deterministic order stream.
/// This means chat is captured in replays and can be replayed alongside
/// gameplay — matching SC2's `replay.message.events` stream.
pub enum PlayerOrder {
    // ... existing variants ...
    ChatMessage {
        channel: ChatChannel,
        /// UTF-8 text, bounded by ProtocolLimits::max_chat_message_length (512 chars, V15).
        text: String,
    },
    /// Notification-only metadata marker: player started/stopped voice transmission.
    /// NOT the audio data itself — that flows outside the order pipeline
    /// via MessageLane::Voice (see D059 § VoIP Architecture). This order exists
    /// solely so the sim can record voice activity timestamps in the replay's
    /// analysis event stream. The sim DOES NOT process, decode, or relay any audio.
    /// "VoIP is not part of the simulation" — VoiceActivity is a timestamp marker,
    /// not audio data.
    VoiceActivity {
        active: bool,
    },
    /// Tactical ping placed on the map. Sim-side so it appears in replays.
    TacticalPing {
        ping_type: PingType,
        pos: WorldPos,
        /// Optional entity target (e.g., "attack this unit").
        target: Option&lt;UnitTag&gt;,
    },
    /// Chat wheel phrase selected. Sim-side for deterministic replay.
    ChatWheelPhrase {
        phrase_id: u16,
    },
    /// Minimap annotation stroke (batch of points). Sim-side for replay.
    MinimapDraw {
        points: Vec&lt;WorldPos&gt;,
        color: PlayerColor,
    },
}
<span class="boring">}</span></code></pre>
<p><strong>Why chat is in the order stream:</strong> SC2 stores chat in a separate <code>replay.message.events</code> stream alongside <code>replay.game.events</code> (orders) and <code>replay.tracker.events</code> (analysis). IC follows this model — <code>ChatMessage</code> orders are part of the tick stream, meaning replays preserve the full text conversation. During replay playback, the chat overlay shows messages at the exact tick they were sent. This is essential for tournament review and community content creation.</p>
<h4 id="channel-routing"><a class="header" href="#channel-routing">Channel Routing</a></h4>
<p>Chat routing is a relay server concern, not a sim concern. The relay inspects <code>ChatChannel</code> to determine forwarding:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Channel</th><th>Relay Forwards To</th><th>Replay Visibility</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td><code>All</code></td><td>All connected clients (players + observers)</td><td>Full</td><td>Standard all-chat</td></tr>
<tr><td><code>Team</code></td><td>Same-team players only</td><td>Full (after game)</td><td>Hidden from opponents during live game</td></tr>
<tr><td><code>Whisper { target }</code></td><td>Target player only + sender echo</td><td>Sender only</td><td>Private — not in shared replay</td></tr>
<tr><td><code>Observer</code></td><td>All observers only</td><td>Full</td><td>Players never see observer chat during live game</td></tr>
</tbody>
</table>
</div>
<p><strong>Anti-coaching:</strong> During a live game, observer messages are never forwarded to players. This prevents spectator coaching in competitive matches. In replay playback, all channels are visible (the information is historical).</p>
<p><strong>Chat cooldown:</strong> Rate-limited at the relay: max 5 messages per 3 seconds per player (configurable via server cvar). Exceeding the limit queues messages with a “slow mode” indicator. This prevents chat spam without blocking legitimate rapid communication during intense moments.</p>
<h4 id="channel-switching"><a class="header" href="#channel-switching">Channel Switching</a></h4>
<pre><code>Enter         → Open chat in last-used channel
Shift+Enter   → Open chat in All (if last-used was Team)
Tab           → Cycle: All → Team → Observer (if spectating)
/w &lt;name&gt;     → Switch to whisper channel targeting &lt;name&gt;
/all           → Switch to All channel (D058 command)
/team          → Switch to Team channel (D058 command)  
</code></pre>
<p>The active channel is displayed as a colored prefix in the chat input: <code>[ALL]</code>, <code>[TEAM]</code>, <code>[WHISPER → Alice]</code>, <code>[OBS]</code>.</p>
<h4 id="emoji-and-rich-text"><a class="header" href="#emoji-and-rich-text">Emoji and Rich Text</a></h4>
<p>Chat messages support a limited set of inline formatting:</p>
<ul>
<li><strong>Emoji shortcodes</strong> — <code>:gg:</code>, <code>:glhf:</code>, <code>:allied:</code>, <code>:soviet:</code> mapped to sprite-based emoji (not Unicode — ensures consistent rendering across platforms). Custom emoji can be registered by mods via YAML.</li>
<li><strong>Unit/building links</strong> — <code>[Tank]</code> auto-links to the unit’s encyclopedia entry (if <code>ic-ui</code> has one). Parsed client-side, not in the order stream.</li>
<li><strong>No markdown, no HTML, no BBCode.</strong> Chat is plain text with emoji shortcodes. This eliminates an entire class of injection attacks and keeps the parser trivial.</li>
</ul>
<h3 id="2-voice-over-ip--architecture"><a class="header" href="#2-voice-over-ip--architecture">2. Voice-over-IP — Architecture</a></h3>
<p>No open-source RTS engine has built-in VoIP. OpenRA relies on Discord/TeamSpeak. The Remastered Collection added lobby voice via Steam’s API (Steamworks <code>ISteamNetworkingMessages</code>). IC’s VoIP is engine-native — no external service dependency.</p>
<h4 id="design-principles"><a class="header" href="#design-principles">Design Principles</a></h4>
<ol>
<li>
<p><strong>VoIP is NOT part of the simulation.</strong> Voice data never enters <code>ic-sim</code>. It is pure I/O — captured, encoded, transmitted, decoded, and played back entirely in <code>ic-net</code> and <code>ic-audio</code>. The sim is unaware that voice exists (Invariant #1: simulation is pure and deterministic).</p>
</li>
<li>
<p><strong>Voice flows through the relay.</strong> Not P2P. This maintains D007’s architecture: the relay prevents IP exposure, provides consistent routing, and enables server-side mute enforcement. P2P voice would leak player IP addresses — a known harassment vector in competitive games.</p>
</li>
<li>
<p><strong>Push-to-talk is the default.</strong> Voice activation detection (VAD) is available as an option but not default. PTT prevents accidental transmission of background noise, private conversations, and keyboard/mouse sounds — problems that plague open-mic games.</p>
</li>
<li>
<p><strong>Voice is best-effort.</strong> Lost voice packets are not retransmitted. Human hearing tolerates ~5% packet loss with Opus’s built-in PLC (packet loss concealment). Retransmitting stale voice data adds latency without improving quality.</p>
</li>
<li>
<p><strong>Voice never delays gameplay.</strong> The <code>MessageLane::Voice</code> lane has lower priority than <code>Orders</code> and <code>Control</code> — voice packets are dropped before order packets under bandwidth pressure.</p>
</li>
<li>
<p><strong>End-to-end latency target: &lt;150ms.</strong> Mouth-to-ear latency must stay under 150ms for natural conversation. Budget: capture buffer ~5ms + encode ~2ms + network RTT/2 (typically 30-80ms) + jitter buffer (20-60ms) + decode ~1ms + playback buffer ~5ms = 63-153ms. CS2 and Valorant achieve ~100-150ms. Mumble achieves ~50-80ms on LAN, ~100-150ms on WAN. At &gt;200ms, conversation becomes turn-taking rather than natural overlap — unacceptable for real-time RTS callouts. The adaptive jitter buffer (see below) is the primary latency knob: on good networks it stays at 1 frame (20ms); on poor networks it expands up to 10 frames (200ms) as a tradeoff. Monitoring this budget is exposed via <code>VoiceDiagnostics</code> (see UI Indicators).</p>
</li>
</ol>
<h4 id="codec-opus"><a class="header" href="#codec-opus">Codec: Opus</a></h4>
<p><strong>Opus</strong> (RFC 6716) is the only viable choice. It is:</p>
<ul>
<li>Royalty-free and open-source (BSD license)</li>
<li>The standard game voice codec (used by Discord, Steam, ioquake3, Mumble, WebRTC)</li>
<li>Excellent at low bitrates (usable at 6 kbps, good at 16 kbps, transparent at 32 kbps)</li>
<li>Built-in forward error correction (FEC) and packet loss concealment (PLC)</li>
<li>Native Rust bindings available via <code>audiopus</code> crate (safe wrapper around libopus)</li>
</ul>
<p><strong>Encoding parameters:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Parameter</th><th>Default</th><th>Range</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td>Sample rate</td><td>48 kHz</td><td>Fixed</td><td>Opus native rate; input is resampled if needed</td></tr>
<tr><td>Channels</td><td>1 (mono)</td><td>Fixed</td><td>Voice chat is mono; stereo is wasted bandwidth</td></tr>
<tr><td>Frame size</td><td>20 ms</td><td>10, 20, 40 ms</td><td>20 ms is the standard balance of latency vs. overhead</td></tr>
<tr><td>Bitrate</td><td>32 kbps</td><td>8–64 kbps</td><td>Adaptive (see below). 32 kbps matches Discord/Mumble quality expectations</td></tr>
<tr><td>Application mode</td><td><code>VOIP</code></td><td>Fixed</td><td>Opus <code>OPUS_APPLICATION_VOIP</code> — optimized for speech, enables DTX</td></tr>
<tr><td>Complexity</td><td>7</td><td>0–10</td><td>Mumble uses 10, Discord similar; 7 is quality/CPU sweet spot</td></tr>
<tr><td>DTX (Discontinuous Tx)</td><td>Enabled</td><td>On/Off</td><td>Stops transmitting during silence — major bandwidth savings</td></tr>
<tr><td>In-band FEC</td><td>Enabled</td><td>On/Off</td><td>Encodes lower-bitrate redundancy of previous frame — helps packet loss</td></tr>
<tr><td>Packet loss percentage</td><td>Dynamic</td><td>0–100</td><td>Fed from <code>VoiceBitrateAdapter.loss_ratio</code> — adapts FEC to actual loss</td></tr>
</tbody>
</table>
</div>
<p><strong>Bandwidth budget per player:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Bitrate</th><th>Opus payload/frame (20ms)</th><th>+ overhead (per packet)</th><th>Per second</th><th>Quality</th></tr>
</thead>
<tbody>
<tr><td>8 kbps</td><td>20 bytes</td><td>~48 bytes</td><td>~2.4 KB/s</td><td>Intelligible</td></tr>
<tr><td>16 kbps</td><td>40 bytes</td><td>~68 bytes</td><td>~3.4 KB/s</td><td>Good</td></tr>
<tr><td>24 kbps</td><td>60 bytes</td><td>~88 bytes</td><td>~4.4 KB/s</td><td>Very good</td></tr>
<tr><td>32 kbps</td><td>80 bytes</td><td>~108 bytes</td><td>~5.4 KB/s</td><td><strong>Default</strong></td></tr>
<tr><td>64 kbps</td><td>160 bytes</td><td>~188 bytes</td><td>~9.4 KB/s</td><td>Music-grade</td></tr>
</tbody>
</table>
</div>
<p>Overhead = 28 bytes UDP/IP + lane header. With DTX enabled, actual bandwidth is ~60% of these figures (voice is ~60% activity, ~40% silence in typical conversation). An 8-player game where 2 players speak simultaneously at the default 32 kbps uses 2 × 5.4 KB/s = ~10.8 KB/s inbound — negligible compared to the order stream.</p>
<h4 id="adaptive-bitrate"><a class="header" href="#adaptive-bitrate">Adaptive Bitrate</a></h4>
<p>The relay monitors per-connection bandwidth using the same ack vector RTT measurements used for order delivery (<code>03-NETCODE.md</code> § Per-Ack RTT Measurement). When bandwidth is constrained:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Voice bitrate adaptation based on available bandwidth.
/// Runs on the sending client. The relay reports congestion via
/// a VoiceBitrateHint control message (not an order — control lane).
pub struct VoiceBitrateAdapter {
    /// Current target bitrate (Opus encoder parameter).
    pub current_bitrate: u32,
    /// Minimum acceptable bitrate. Below this, voice is suspended
    /// with a "low bandwidth" indicator to the UI.
    pub min_bitrate: u32,       // default: 8_000
    /// Maximum bitrate when bandwidth is plentiful.
    pub max_bitrate: u32,       // default: 32_000
    /// Smoothed trip time from ack vectors (updated every packet).
    pub srtt_us: u64,
    /// Packet loss ratio (0.0–1.0) from ack vector analysis.
    pub loss_ratio: f32,        // f32 OK — this is I/O, not sim
}

impl VoiceBitrateAdapter {
    /// Called each frame. Returns the bitrate to configure on the encoder.
    /// Also updates Opus's OPUS_SET_PACKET_LOSS_PERC hint dynamically
    /// (learned from Mumble/Discord — static loss hints under-optimize FEC).
    pub fn adapt(&amp;mut self) -&gt; u32 {
        if self.loss_ratio &gt; 0.15 {
            // Heavy loss: drop to minimum, prioritize intelligibility
            self.current_bitrate = self.min_bitrate;
        } else if self.loss_ratio &gt; 0.05 {
            // Moderate loss: reduce by 25%
            self.current_bitrate = (self.current_bitrate * 3 / 4).max(self.min_bitrate);
        } else if self.srtt_us &lt; 100_000 {
            // Low latency, low loss: increase toward max
            self.current_bitrate = (self.current_bitrate * 5 / 4).min(self.max_bitrate);
        }
        self.current_bitrate
    }

    /// Returns the packet loss percentage hint for OPUS_SET_PACKET_LOSS_PERC.
    /// Dynamic: fed from observed loss_ratio rather than a static 10% default.
    /// At higher loss hints, Opus allocates more bits to in-band FEC.
    pub fn opus_loss_hint(&amp;self) -&gt; i32 {
        // Quantize to 0, 5, 10, 15, 20, 25 — Opus doesn't need fine granularity
        ((self.loss_ratio * 100.0) as i32 / 5 * 5).clamp(0, 25)
    }
}
<span class="boring">}</span></code></pre>
<h4 id="message-lane-voice"><a class="header" href="#message-lane-voice">Message Lane: Voice</a></h4>
<p>Voice traffic uses a new <code>MessageLane::Voice</code> lane, positioned between <code>Chat</code> and <code>Bulk</code>:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum MessageLane {
    Orders = 0,
    Control = 1,
    Chat = 2,
    Voice = 3,    // NEW — voice frames
    Bulk = 4,     // was 3, renumbered
}
<span class="boring">}</span></code></pre>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Lane</th><th>Priority</th><th>Weight</th><th>Buffer</th><th>Reliability</th><th>Rationale</th></tr>
</thead>
<tbody>
<tr><td><code>Orders</code></td><td>0</td><td>1</td><td>4 KB</td><td>Reliable</td><td>Orders must arrive; missed = Idle (deadline is the cap)</td></tr>
<tr><td><code>Control</code></td><td>0</td><td>1</td><td>2 KB</td><td>Unreliable</td><td>Latest sync hash wins; stale hashes are useless</td></tr>
<tr><td><code>Chat</code></td><td>1</td><td>1</td><td>8 KB</td><td>Reliable</td><td>Chat messages should arrive but can wait</td></tr>
<tr><td><code>Voice</code></td><td>1</td><td>2</td><td>16 KB</td><td>Unreliable</td><td>Real-time voice; dropped frames use Opus PLC (not retransmit)</td></tr>
<tr><td><code>Bulk</code></td><td>2</td><td>1</td><td>64 KB</td><td>Unreliable</td><td>Telemetry/observer data uses spare bandwidth</td></tr>
</tbody>
</table>
</div>
<p><strong>Voice and Chat share priority tier 1</strong> with a 2:1 weight ratio — voice gets twice the bandwidth share because it’s time-sensitive. Under bandwidth pressure, Orders and Control are served first (tier 0), then Voice and Chat split the remainder (tier 1, 67%/33%), then Bulk gets whatever is left (tier 2). This ensures voice never delays order delivery, but voice frames are prioritized over chat messages within the non-critical tier.</p>
<p><strong>Buffer limit:</strong> 16 KB allows ~73ms of buffered voice at the default 32 kbps (~148 frames at 108 bytes each). If the buffer fills (severe congestion), the oldest voice frames are dropped — this is correct behavior for real-time audio (stale audio is worse than silence).</p>
<h4 id="voice-packet-format"><a class="header" href="#voice-packet-format">Voice Packet Format</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Voice data packet. Travels on MessageLane::Voice.
/// NOT a PlayerOrder — voice never enters the sim.
/// Encoded in the lane's framing, not the order TLV format.
pub struct VoicePacket {
    /// Which player is speaking. Set by relay (not client) to prevent spoofing.
    pub speaker: PlayerId,
    /// Monotonically increasing sequence number for ordering + loss detection.
    pub sequence: u32,
    /// Opus frame count in this packet (typically 1, max 3 for 60ms bundling).
    pub frame_count: u8,
    /// Voice routing target. The relay uses this to determine forwarding.
    pub target: VoiceTarget,
    /// Flags: SPATIAL (positional audio hint), FEC (frame contains FEC data).
    pub flags: VoiceFlags,
    /// Opus-encoded audio payload. Size determined by bitrate and frame_count.
    pub data: Vec&lt;u8&gt;,
}

/// Who should hear this voice transmission.
#[derive(Clone, Copy, Debug, PartialEq, Eq)]
pub enum VoiceTarget {
    /// All players and observers hear the transmission.
    All,
    /// Only same-team players.
    Team,
    /// Specific player (private voice — rare, but useful for coaching/tutoring).
    Player(PlayerId),
}

bitflags! {
    pub struct VoiceFlags: u8 {
        /// Positional audio hint — the listener should spatialize this
        /// voice based on the speaker's camera position or selected units.
        /// Opt-in via D033 QoL toggle. Disabled by default.
        const SPATIAL = 0x01;
        /// This packet contains Opus in-band FEC data for the previous frame.
        const FEC     = 0x02;
    }
}
<span class="boring">}</span></code></pre>
<p><strong>Speaker ID is relay-assigned.</strong> The client sends voice data; the relay stamps <code>speaker</code> before forwarding. This prevents voice spoofing — a client cannot impersonate another player’s voice. Same pattern as ioquake3’s server-side VoIP relay (where <code>sv_client.c</code> stamps the client number on forwarded voice packets).</p>
<h4 id="relay-voice-forwarding"><a class="header" href="#relay-voice-forwarding">Relay Voice Forwarding</a></h4>
<p>The relay server forwards voice packets with minimal processing:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Relay-side voice forwarding. Per-client, per-tick.
/// The relay does NOT decode Opus — it forwards opaque bytes.
/// This keeps relay CPU cost near zero for voice.
impl RelaySession {
    fn forward_voice(&amp;mut self, from: PlayerId, packet: &amp;VoicePacket) {
        // 1. Validate: is this player allowed to speak? (not muted, not observer in competitive)
        if self.is_muted(from) { return; }

        // 2. Rate limit: max voice_packets_per_second per player (default 50 = 1 per 20ms)
        if !self.voice_rate_limiter.check(from) { return; }

        // 3. Stamp speaker ID (overwrite whatever the client sent)
        let mut forwarded = packet.clone();
        forwarded.speaker = from;

        // 4. Route based on VoiceTarget
        match packet.target {
            VoiceTarget::All =&gt; {
                for client in &amp;self.clients {
                    if client.id != from &amp;&amp; !client.has_muted(from) {
                        client.send_voice(&amp;forwarded);
                    }
                }
            }
            VoiceTarget::Team =&gt; {
                for client in &amp;self.clients {
                    if client.id != from
                        &amp;&amp; client.team == self.clients[from].team
                        &amp;&amp; !client.has_muted(from)
                    {
                        client.send_voice(&amp;forwarded);
                    }
                }
            }
            VoiceTarget::Player(target) =&gt; {
                if let Some(client) = self.clients.get(target) {
                    if !client.has_muted(from) {
                        client.send_voice(&amp;forwarded);
                    }
                }
            }
        }
    }
}
<span class="boring">}</span></code></pre>
<p><strong>Relay bandwidth cost:</strong> The relay is a packet reflector for voice — it copies bytes without decoding. For an 8-player game where 2 players speak simultaneously at the default 32 kbps, the relay transmits: 2 speakers × 7 recipients × 5.4 KB/s = ~75.6 KB/s outbound. This is negligible for a server. The relay already handles order forwarding; voice adds proportionally small overhead.</p>
<h4 id="spatial-audio-optional"><a class="header" href="#spatial-audio-optional">Spatial Audio (Optional)</a></h4>
<p>Inspired by ioquake3’s <code>VOIP_SPATIAL</code> flag and Mumble’s positional audio plugin:</p>
<p>When <code>VoiceFlags::SPATIAL</code> is set, the receiving client spatializes the voice based on the speaker’s in-game position. The speaker’s position is derived from their primary selection or camera center — NOT transmitted in the voice packet (that would leak tactical information). The receiver’s client already knows all unit positions (lockstep sim), so it can compute relative direction and distance locally.</p>
<p><strong>Spatial audio is a D033 QoL toggle</strong> (<code>voice.spatial_audio: bool</code>, default <code>false</code>). When enabled, teammates’ voice is panned left/right based on where their units are on the map. This creates a natural “war room” effect — you hear your ally to your left when their base is left of yours.</p>
<p><strong>Why disabled by default:</strong> Spatial voice is disorienting if unexpected. Players accustomed to centered voice chat need to opt in. Additionally, it only makes sense in team games with distinct player positions — 1v1 games get no benefit.</p>
<h4 id="browser-wasm-voip"><a class="header" href="#browser-wasm-voip">Browser (WASM) VoIP</a></h4>
<p>Native desktop clients use raw Opus-over-UDP through the <code>UdpTransport</code> (D054). Browser clients cannot use raw UDP — they use WebRTC for voice transport.</p>
<p><strong>str0m</strong> (github.com/algesten/str0m) is the recommended Rust WebRTC library:</p>
<ul>
<li>Pure Rust, Sans I/O (no internal threads — matches IC’s architecture)</li>
<li>Frame-level and RTP-level APIs</li>
<li>Multiple crypto backends (aws-lc-rs, ring, OpenSSL, platform-native)</li>
<li>Bandwidth estimation (BWE), NACK, Simulcast support</li>
<li><code>&amp;mut self</code> pattern — no internal mutexes</li>
<li>515+ stars, 43+ contributors, 602 dependents</li>
</ul>
<p>For browser builds, VoIP uses str0m’s WebRTC data channels routed through the relay. The relay bridges WebRTC ↔ raw UDP voice packets, enabling cross-platform voice between native and browser clients. The Opus payload is identical — only the transport framing differs.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// VoIP transport selection — the INITIAL transport chosen per platform.
/// This is a static selection at connection time (platform-dependent).
/// Runtime transport adaptation (e.g., UDP→TCP fallback) is handled by
/// VoiceTransportState (see § "Connection Recovery" below), which is a
/// separate state machine that manages degraded-mode transitions without
/// changing the VoiceTransport enum.
pub enum VoiceTransport {
    /// Raw Opus frames on MessageLane::Voice over UdpTransport.
    /// Desktop default. Lowest latency, lowest overhead.
    Native,
    /// Opus frames via WebRTC data channel (str0m).
    /// Browser builds. Higher overhead but compatible with browser APIs.
    WebRtc,
}
<span class="boring">}</span></code></pre>
<h4 id="muting-and-moderation"><a class="header" href="#muting-and-moderation">Muting and Moderation</a></h4>
<p>Per-player mute is client-side AND relay-enforced:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Action</th><th>Scope</th><th>Mechanism</th></tr>
</thead>
<tbody>
<tr><td><strong>Player mutes</strong></td><td>Client-side</td><td>Receiver ignores voice from muted player. Also sends mute hint to relay.</td></tr>
<tr><td><strong>Relay mute hint</strong></td><td>Server-side</td><td>Relay skips forwarding to the muting player — saves bandwidth.</td></tr>
<tr><td><strong>Admin mute</strong></td><td>Server-side</td><td>Relay drops all voice from the muted player. Cannot be overridden.</td></tr>
<tr><td><strong>Self-mute</strong></td><td>Client-side</td><td>PTT disabled, mic input stopped. “Muted” icon shown to other players.</td></tr>
<tr><td><strong>Self-deafen</strong></td><td>Client-side</td><td>All incoming voice silenced. “Deafened” icon shown.</td></tr>
</tbody>
</table>
</div>
<p><strong>Mute persistence:</strong> Per-player mute decisions are stored in local SQLite (D034) keyed by the player’s Ed25519 public key (D052). Muting “Bob” in one game persists across future games with the same player. The relay does not store mute relationships — mute is a client preference, communicated to the relay as a routing hint.</p>
<p><strong>Scope split (social controls vs matchmaking vs moderation):</strong></p>
<ul>
<li><strong>Mute</strong> (D059): communication routing and local comfort (voice/text)</li>
<li><strong>Block</strong> (D059 + lobby/profile UI): social interaction preference (messages/invites/profile contact)</li>
<li><strong>Avoid Player</strong> (D055): matchmaking preference, best-effort only (not a communication feature)</li>
<li><strong>Report</strong> (D059 + D052 moderation): evidence-backed moderation signal for griefing/cheating/abuse</li>
</ul>
<p>This separation prevents UX confusion (“I blocked them, why did I still get matched?”) and avoids turning social tools into stealth matchmaking exploits.</p>
<p><strong>Hotmic protection:</strong> If PTT is held continuously for longer than <code>voice.max_ptt_duration</code> (default 120 seconds, configurable), transmission is automatically cut and the player sees a “PTT timeout — release and re-press to continue” notification. This prevents stuck-key scenarios where a player unknowingly broadcasts for an entire match (keyboard malfunction, key binding conflict, cat on keyboard). Discord implements similar detection; CS2 cuts after ~60 seconds continuous transmission. The timeout resets immediately on key release — there is no cooldown.</p>
<p><strong>Communication abuse penalties:</strong> Repeated mute/report actions against a player across multiple games trigger <strong>progressive communication restrictions</strong> on that player’s community profile (D052/D053). The community server (D052) tracks reports per player:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Threshold</th><th>Penalty</th><th>Duration</th><th>Scope</th></tr>
</thead>
<tbody>
<tr><td>3 reports in 24h</td><td>Warning displayed to player</td><td>Immediate</td><td>Informational only</td></tr>
<tr><td>5 reports in 72h</td><td>Voice-restricted: team-only voice, no all-chat voice</td><td>24 hours</td><td>Per community server</td></tr>
<tr><td>10 reports in 7 days</td><td>Voice-muted: cannot transmit voice</td><td>72 hours</td><td>Per community server</td></tr>
<tr><td>Repeated offenses</td><td>Escalated to community moderators (D037) for manual review</td><td>Until resolved</td><td>Per community server</td></tr>
</tbody>
</table>
</div>
<p>Thresholds are configurable per community server — tournament communities may be stricter. Penalties are community-scoped (D052 federation), not global. A player comm-banned on one community can still speak on others. Text chat follows the same escalation path. False report abuse is itself a reportable offense.</p>
<h4 id="player-reports-and-community-review-handoff-d052-integration"><a class="header" href="#player-reports-and-community-review-handoff-d052-integration">Player Reports and Community Review Handoff (D052 integration)</a></h4>
<p>D059 owns the <strong>reporting UX and event capture</strong>, but not final enforcement. Reports are routed to the community server’s moderation/review pipeline (D052).</p>
<p><strong>Report categories (minimum):</strong></p>
<ul>
<li><code>cheating</code></li>
<li><code>griefing / team sabotage</code></li>
<li><code>afk / intentional idle</code></li>
<li><code>harassment / abusive chat/voice</code></li>
<li><code>spam / disruptive comms</code></li>
<li><code>other</code> (freeform note)</li>
</ul>
<p><strong>Evidence attachment defaults (when available):</strong></p>
<ul>
<li>replay reference / signed replay ID (<code>.icrep</code>, D007)</li>
<li>match ID / <code>CertifiedMatchResult</code> reference</li>
<li>timestamps and player IDs</li>
<li>communication context (muted/report counts, voice/text events) for abuse reports</li>
<li>relay telemetry summary flags (disconnects/desyncs/timing anomalies) for cheating/griefing reports</li>
</ul>
<p><strong>UX and trust rules:</strong></p>
<ul>
<li>Reports are <strong>signals</strong>, not automatic guilt</li>
<li>The UI should communicate “submitted for review” rather than “player punished”</li>
<li>False/malicious reporting is itself sanctionable by the community server (D052/D037)</li>
<li>Community review (Overwatch-style, if enabled) is advisory input to moderators/anti-cheat workflows, not a replacement for evidence and thresholds</li>
</ul>
<h4 id="jitter-buffer"><a class="header" href="#jitter-buffer">Jitter Buffer</a></h4>
<p>Voice packets arrive with variable delay (network jitter). Without a jitter buffer, packets arriving late cause audio stuttering and packets arriving out-of-order cause gaps. Every production VoIP system uses a jitter buffer — Mumble, Discord, TeamSpeak, and WebRTC all implement one. D059 requires an <strong>adaptive jitter buffer</strong> per-speaker in <code>ic-audio</code>.</p>
<p><strong>Design rationale:</strong> A fixed jitter buffer (constant delay) wastes latency on good networks and is insufficient on bad networks. An adaptive buffer dynamically adjusts delay based on observed inter-arrival jitter — expanding when jitter increases (prevents drops) and shrinking when jitter decreases (minimizes latency). This is the universal approach in production VoIP systems (see <code>research/open-source-voip-analysis.md</code> § 6).</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Adaptive jitter buffer for voice playback.
/// Smooths variable packet arrival times into consistent playback.
/// One instance per speaker, managed by ic-audio.
///
/// Design informed by Mumble's audio pipeline and WebRTC's NetEq.
/// Mumble uses a similar approach with its Resynchronizer for echo
/// cancellation timing — IC generalizes this to all voice playback.
pub struct JitterBuffer {
    /// Ring buffer of received voice frames, indexed by sequence number.
    /// None entries represent lost or not-yet-arrived packets.
    frames: VecDeque&lt;Option&lt;VoiceFrame&gt;&gt;,
    /// Current playback delay in 20ms frame units.
    /// E.g., delay=3 means 60ms of buffered audio before playback starts.
    delay: u32,
    /// Minimum delay (frames). Default: 1 (20ms).
    min_delay: u32,
    /// Maximum delay (frames). Default: 10 (200ms).
    /// Above 200ms, voice feels too delayed for real-time conversation.
    max_delay: u32,
    /// Exponentially weighted moving average of inter-arrival jitter.
    jitter_estimate: f32,   // f32 OK — this is I/O, not sim
    /// Timestamp of last received frame for jitter calculation.
    last_arrival: Instant,
    /// Statistics: total frames received, lost, late, buffer expansions/contractions.
    stats: JitterStats,
}

impl JitterBuffer {
    /// Called when a voice packet arrives from the network.
    pub fn push(&amp;mut self, sequence: u32, opus_data: &amp;[u8], now: Instant) {
        // Update jitter estimate using EWMA
        let arrival_delta = now - self.last_arrival;
        let expected_delta = Duration::from_millis(20); // one frame period
        let jitter = (arrival_delta.as_secs_f32() - expected_delta.as_secs_f32()).abs();
        // Smoothing factor 0.9 — reacts within ~10 packets to jitter changes
        self.jitter_estimate = 0.9 * self.jitter_estimate + 0.1 * jitter;
        self.last_arrival = now;
        
        // Insert frame at correct position based on sequence number.
        // Handles out-of-order delivery by placing in the correct slot.
        self.insert_frame(sequence, opus_data);
        
        // Adapt buffer depth based on current jitter estimate
        self.adapt_delay();
    }
    
    /// Called every 20ms by the audio render thread.
    /// Returns the next frame to play, or None if the frame is missing.
    /// On None, the caller invokes Opus PLC (decoder with null input)
    /// to generate concealment audio from the previous frame's spectral envelope.
    pub fn pop(&amp;mut self) -&gt; Option&lt;VoiceFrame&gt; {
        self.frames.pop_front().flatten()
    }
    
    fn adapt_delay(&amp;mut self) {
        // Target: 2× jitter estimate + 1 frame covers ~95% of variance
        let target = ((2.0 * self.jitter_estimate * 50.0) as u32 + 1)
            .clamp(self.min_delay, self.max_delay);
        
        if target &gt; self.delay {
            // Increase delay: expand buffer immediately (insert silence frame)
            self.delay += 1;
        } else if target + 2 &lt; self.delay {
            // Decrease delay: only when significantly over-buffered
            // Hysteresis of 2 frames prevents oscillation on borderline networks
            self.delay -= 1;
        }
    }
}
<span class="boring">}</span></code></pre>
<p><strong>Packet Loss Concealment (PLC) integration:</strong> When <code>pop()</code> returns <code>None</code> (missing frame due to packet loss), the Opus decoder is called with null input (<code>opus_decode(null, 0, ...)</code>) to generate PLC audio. Opus’s built-in PLC extrapolates from the previous frame’s spectral envelope, producing a smooth fade-out over 3-5 lost frames. At 5% packet loss, PLC is barely audible. At 15% loss, artifacts become noticeable — this is where the <code>VoiceBitrateAdapter</code> reduces bitrate and increases FEC allocation. Combined with dynamic <code>OPUS_SET_PACKET_LOSS_PERC</code> (see Adaptive Bitrate above), the encoder and decoder cooperate: the encoder allocates more bits to FEC when loss is high, and the decoder conceals any remaining gaps.</p>
<h4 id="udp-connectivity-checks-and-tcp-tunnel-fallback"><a class="header" href="#udp-connectivity-checks-and-tcp-tunnel-fallback">UDP Connectivity Checks and TCP Tunnel Fallback</a></h4>
<p>Learned from Mumble’s protocol (see <code>research/open-source-voip-analysis.md</code> § 7): some networks block or heavily throttle UDP (corporate firewalls, restrictive NATs, aggressive ISP rate limiting). D059 must not assume voice always uses UDP.</p>
<p>Mumble solves this with a graceful fallback: the client sends periodic UDP ping packets; if responses stop, voice is tunneled through the TCP control connection transparently. IC adopts this pattern:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Voice transport state machine. Manages UDP/TCP fallback for voice.
/// Runs on each client independently. The relay accepts voice from
/// either transport — it doesn't care how the bytes arrived.
pub enum VoiceTransportState {
    /// UDP voice active. UDP pings succeeding.
    /// Default state when connection is established.
    UdpActive,
    /// UDP pings failing. Testing connectivity.
    /// Voice is tunneled through TCP/WebSocket during this state.
    /// UDP pings continue in background to detect recovery.
    UdpProbing {
        last_ping: Instant,
        consecutive_failures: u8,  // switch to TcpTunnel after 5 failures
    },
    /// UDP confirmed unavailable. Voice fully tunneled through TCP.
    /// Higher latency (~20-50ms from TCP queuing) but maintains connectivity.
    /// UDP pings continue every 5 seconds to detect recovery.
    TcpTunnel,
    /// UDP restored after tunnel period. Transitioning back.
    /// Requires 3 consecutive successful UDP pings before switching.
    UdpRestoring { consecutive_successes: u8 },
}
<span class="boring">}</span></code></pre>
<p><strong>How TCP tunneling works:</strong> Voice frames use the same <code>VoicePacket</code> binary format regardless of transport. When tunneled through TCP, voice packets are sent as a distinct message type on the existing control connection — the relay identifies the message type and forwards the voice payload normally. The relay doesn’t care whether voice arrived via UDP or TCP; it stamps the speaker ID and forwards to recipients.</p>
<p><strong>UI indicator:</strong> A small icon in the voice overlay shows the transport state — “Direct” (UDP, normal) or “Tunneled” (TCP, yellow warning icon). Tunneled voice has ~20-50ms additional latency from TCP head-of-line blocking but is preferable to no voice at all.</p>
<p><strong>Implementation phasing note (from Mumble documentation):</strong> “When implementing the protocol it is easier to ignore the UDP transfer layer at first and just tunnel the UDP data through the TCP tunnel. The TCP layer must be implemented for authentication in any case.” This matches IC’s phased approach — TCP-tunneled voice can ship in Phase 3 (alongside text chat), with UDP voice optimization in Phase 5.</p>
<h4 id="audio-preprocessing-pipeline"><a class="header" href="#audio-preprocessing-pipeline">Audio Preprocessing Pipeline</a></h4>
<p>The audio capture-to-encode pipeline in <code>ic-audio</code>. Order matters — this sequence is the standard across Mumble, Discord, WebRTC, and every production VoIP system (see <code>research/open-source-voip-analysis.md</code> § 8):</p>
<pre><code>Platform Capture (cpal) → Resample to 48kHz (rubato) →
  Echo Cancellation (optional, speaker users only) →
    Noise Suppression (nnnoiseless / RNNoise) →
      Voice Activity Detection (for VAD mode) →
        Opus Encode (audiopus, VOIP mode, FEC, DTX) →
          VoicePacket → MessageLane::Voice
</code></pre>
<p><strong>Recommended Rust crates for the pipeline:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Component</th><th>Crate</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td>Audio I/O</td><td><code>cpal</code></td><td>Cross-platform (WASAPI, CoreAudio, ALSA/PulseAudio, WASM AudioWorklet). Already used by Bevy’s audio ecosystem.</td></tr>
<tr><td>Resampler</td><td><code>rubato</code></td><td>Pure Rust, high quality async resampler. No C dependencies. Converts from mic sample rate to Opus’s 48kHz.</td></tr>
<tr><td>Noise suppression</td><td><code>nnnoiseless</code></td><td>Pure Rust port of Mozilla’s RNNoise. ML-based (GRU neural network). Dramatically better than DSP-based Speex preprocessing for non-stationary noise (keyboard clicks, fans, traffic). ~0.3% CPU cost per core — negligible.</td></tr>
<tr><td>Opus codec</td><td><code>audiopus</code></td><td>Safe Rust wrapper around libopus. Required. Handles encode/decode/PLC.</td></tr>
<tr><td>Echo cancellation</td><td>Speex AEC via <code>speexdsp-rs</code>, or browser-native</td><td>Full AEC only matters for speaker/laptop users (not headset). Mumble’s <code>Resynchronizer</code> shows this requires a ~20ms mic delay queue to ensure speaker data reaches the canceller first. Browser builds can use WebRTC’s built-in AEC.</td></tr>
</tbody>
</table>
</div>
<p><strong>Why RNNoise (<code>nnnoiseless</code>) over Speex preprocessing:</strong> Mumble supports both. RNNoise is categorically superior — it uses a recurrent neural network trained on 80+ hours of noise samples, whereas Speex uses traditional FFT-based spectral subtraction. RNNoise handles non-stationary noise (typing, mouse clicks — common in RTS gameplay) far better than Speex. The <code>nnnoiseless</code> crate is pure Rust (no C dependency), adding ~0.3% CPU per core versus Speex’s ~0.1%. This is negligible on any hardware that can run IC. Noise suppression is a D033 QoL toggle (<code>voice.noise_suppression: bool</code>, default <code>true</code>).</p>
<p><strong>Playback pipeline (receive side):</strong></p>
<pre><code>MessageLane::Voice → VoicePacket → JitterBuffer →
  Opus Decode (or PLC on missing frame) →
    Per-speaker gain (user volume setting) →
      Voice Effects Chain (if enabled — see below) →
        Spatial panning (if VoiceFlags::SPATIAL) →
          Mix with game audio → Platform Output (cpal/Bevy audio)
</code></pre>
<h4 id="voice-effects--enhancement"><a class="header" href="#voice-effects--enhancement">Voice Effects &amp; Enhancement</a></h4>
<p>Voice effects apply DSP processing to incoming voice on the <strong>receiver side</strong> — after Opus decode, before spatial panning and mixing. This is a deliberate architectural choice:</p>
<ul>
<li><strong>Receiver controls their experience.</strong> Alice hears radio-filtered voice; Bob hears clean audio. Neither imposes on the other.</li>
<li><strong>Clean audio preserved.</strong> The Opus-encoded stream in replays (voice-in-replay, D059 § 7) is unprocessed. Effects can be re-applied during replay playback with different presets — a caster might use clean voice while a viewer uses radio flavor.</li>
<li><strong>No codec penalty.</strong> Applying effects before Opus encoding wastes bits encoding the effect rather than the voice. Receiver-side effects are “free” from a compression perspective.</li>
<li><strong>Per-speaker effects.</strong> A player can assign different effects to different teammates (e.g., radio filter on ally A, clean for ally B) via per-speaker settings.</li>
</ul>
<h5 id="dsp-chain-architecture"><a class="header" href="#dsp-chain-architecture">DSP Chain Architecture</a></h5>
<p>Each voice effect preset is a composable chain of lightweight DSP stages:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// A single DSP processing stage. Implementations are stateful
/// (filters maintain internal buffers) but cheap — a biquad filter
/// processes 960 samples (20ms at 48kHz) in &lt;5 microseconds.
pub trait VoiceEffectStage: Send + 'static {
    /// Process samples in-place. Called on the audio thread.
    /// `sample_rate` is always 48000 (Opus output).
    fn process(&amp;mut self, samples: &amp;mut [f32], sample_rate: u32);

    /// Reset internal state. Called when a speaker stops and restarts
    /// (avoids filter ringing from stale state across transmissions).
    fn reset(&amp;mut self);

    /// Human-readable name for diagnostics.
    fn name(&amp;self) -&gt; &amp;str;
}

/// A complete voice effect preset — an ordered chain of DSP stages
/// plus optional transmission envelope effects (squelch tones).
pub struct VoiceEffectChain {
    pub stages: Vec&lt;Box&lt;dyn VoiceEffectStage&gt;&gt;,
    pub squelch: Option&lt;SquelchConfig&gt;,
    pub metadata: EffectMetadata,
}

/// Squelch tones — short audio cues on transmission start/end.
/// Classic military radio has a distinctive "roger beep."
pub struct SquelchConfig {
    pub start_tone_hz: u32,       // e.g., 1200 Hz
    pub end_tone_hz: u32,         // e.g., 800 Hz
    pub duration_ms: u32,         // e.g., 60ms
    pub volume: f32,              // 0.0-1.0, relative to voice
}

pub struct EffectMetadata {
    pub name: String,
    pub description: String,
    pub author: String,
    pub version: String,         // semver
    pub tags: Vec&lt;String&gt;,
}
<span class="boring">}</span></code></pre>
<p><strong>Built-in DSP stages</strong> (implemented in <code>ic-audio</code>, no external crate dependencies beyond <code>std</code> math):</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Stage</th><th>Parameters</th><th>Use</th><th>CPU Cost (960 samples)</th></tr>
</thead>
<tbody>
<tr><td><code>BiquadFilter</code></td><td><code>mode</code> (LP/HP/BP/notch/shelf), <code>freq_hz</code>, <code>q</code>, <code>gain</code></td><td>Band-pass for radio; high-shelf for presence; low-cut for clarity</td><td>~3 μs</td></tr>
<tr><td><code>Compressor</code></td><td><code>threshold_db</code>, <code>ratio</code>, <code>attack_ms</code>, <code>release_ms</code></td><td>Even out loud/quiet speakers; radio dynamic range control</td><td>~5 μs</td></tr>
<tr><td><code>SoftClipDistort</code></td><td><code>drive</code> (0.0-1.0), <code>mode</code> (soft_clip / tube / foldback)</td><td>Subtle harmonic warmth for vintage radio; tube saturation</td><td>~2 μs</td></tr>
<tr><td><code>NoiseGate</code></td><td><code>threshold_db</code>, <code>attack_ms</code>, <code>release_ms</code>, <code>hold_ms</code></td><td>Radio squelch — silence below threshold; clean up mic bleed</td><td>~3 μs</td></tr>
<tr><td><code>NoiseLayer</code></td><td><code>type</code> (static / crackle / hiss), <code>level_db</code>, <code>seed</code></td><td>Atmospheric static for radio presets; deterministic seed for consistency</td><td>~4 μs</td></tr>
<tr><td><code>SimpleReverb</code></td><td><code>decay_ms</code>, <code>mix</code> (0.0-1.0), <code>pre_delay_ms</code></td><td>Room/bunker ambiance; short decay for command post feel</td><td>~8 μs</td></tr>
<tr><td><code>DeEsser</code></td><td><code>frequency_hz</code>, <code>threshold_db</code>, <code>ratio</code></td><td>Sibilance reduction; tames harsh microphones</td><td>~5 μs</td></tr>
<tr><td><code>GainStage</code></td><td><code>gain_db</code></td><td>Level adjustment between stages; makeup gain after compression</td><td>~1 μs</td></tr>
<tr><td><code>FrequencyShift</code></td><td><code>shift_hz</code>, <code>mix</code> (0.0-1.0)</td><td>Subtle pitch shift for scrambled/encrypted effect</td><td>~6 μs</td></tr>
</tbody>
</table>
</div>
<p><strong>CPU budget:</strong> A 6-stage chain (typical for radio presets) costs ~25 μs per speaker per 20ms frame. With 8 simultaneous speakers, that’s 200 μs — well under 5% of the audio thread’s budget. Even aggressive 10-stage custom chains remain negligible.</p>
<p><strong>Why no external DSP crate:</strong> Audio DSP filter implementations are straightforward (a biquad is ~10 lines of Rust). External crates like <code>fundsp</code> or <code>dasp</code> are excellent for complex synthesis but add dependency weight for operations that IC needs in their simplest form. The built-in stages above total ~500 lines of Rust. If future effects need convolution reverb or FFT-based processing, <code>fundsp</code> becomes a justified dependency — but the Phase 3 built-in presets don’t require it.</p>
<h5 id="built-in-presets"><a class="header" href="#built-in-presets">Built-in Presets</a></h5>
<p>Six presets ship with IC, spanning practical enhancement to thematic immersion. All are defined in YAML — the same format modders use for custom presets.</p>
<p><strong>1. Clean Enhanced</strong> — <em>Practical voice clarity without character effects.</em></p>
<p>Noise gate removes mic bleed, gentle compression evens volume differences between speakers, de-esser tames harsh sibilance, and a subtle high-shelf adds presence. Recommended for competitive play where voice clarity matters more than atmosphere.</p>
<pre><code class="language-yaml">name: "Clean Enhanced"
description: "Improved voice clarity — compression, de-essing, noise gate"
tags: ["clean", "competitive", "clarity"]
chain:
  - type: noise_gate
    threshold_db: -42
    attack_ms: 1
    release_ms: 80
    hold_ms: 50
  - type: compressor
    threshold_db: -22
    ratio: 3.0
    attack_ms: 8
    release_ms: 60
  - type: de_esser
    frequency_hz: 6500
    threshold_db: -15
    ratio: 4.0
  - type: biquad_filter
    mode: high_shelf
    freq_hz: 3000
    q: 0.7
    gain_db: 2.0
</code></pre>
<p><strong>2. Military Radio</strong> — <em>NATO-standard HF radio. The signature IC effect.</em></p>
<p>Tight band-pass (300 Hz–3.4 kHz) matches real HF radio bandwidth. Compression squashes dynamic range like AGC circuitry. Subtle soft-clip distortion adds harmonic warmth. Noise gate creates a squelch effect. A faint static layer completes the illusion. Squelch tones mark transmission start/end — the distinctive “roger beep” of military comms.</p>
<pre><code class="language-yaml">name: "Military Radio"
description: "NATO HF radio — tight bandwidth, squelch, static crackle"
tags: ["radio", "military", "immersive", "cold-war"]
chain:
  - type: biquad_filter
    mode: high_pass
    freq_hz: 300
    q: 0.7
  - type: biquad_filter
    mode: low_pass
    freq_hz: 3400
    q: 0.7
  - type: compressor
    threshold_db: -18
    ratio: 6.0
    attack_ms: 3
    release_ms: 40
  - type: soft_clip_distortion
    drive: 0.12
    mode: tube
  - type: noise_gate
    threshold_db: -38
    attack_ms: 1
    release_ms: 100
    hold_ms: 30
  - type: noise_layer
    type: static_crackle
    level_db: -32
squelch:
  start_tone_hz: 1200
  end_tone_hz: 800
  duration_ms: 60
  volume: 0.25
</code></pre>
<p><strong>3. Field Radio</strong> — <em>Forward observer radio with environmental interference.</em></p>
<p>Wider band-pass than Military Radio (less “studio,” more “field”). Heavier static and occasional signal drift (subtle frequency wobble). No squelch tones — field conditions are rougher. The effect intensifies when <code>ConnectionQuality.quality_tier</code> drops (more static at lower quality) — adaptive degradation as a feature, not a bug.</p>
<pre><code class="language-yaml">name: "Field Radio"
description: "Frontline field radio — static interference, signal drift"
tags: ["radio", "military", "atmospheric", "cold-war"]
chain:
  - type: biquad_filter
    mode: high_pass
    freq_hz: 250
    q: 0.5
  - type: biquad_filter
    mode: low_pass
    freq_hz: 3800
    q: 0.5
  - type: compressor
    threshold_db: -20
    ratio: 4.0
    attack_ms: 5
    release_ms: 50
  - type: soft_clip_distortion
    drive: 0.20
    mode: soft_clip
  - type: noise_layer
    type: static_crackle
    level_db: -26
  - type: frequency_shift
    shift_hz: 0.3
    mix: 0.05
</code></pre>
<p><strong>4. Command Post</strong> — <em>Bunker-filtered comms with short reverb.</em></p>
<p>Short reverb (~180ms decay) creates the acoustic signature of a concrete command bunker. Slight band-pass and compression. No static — the command post has clean equipment. This is the “mission briefing room” voice.</p>
<pre><code class="language-yaml">name: "Command Post"
description: "Concrete bunker comms — short reverb, clean equipment"
tags: ["bunker", "military", "reverb", "cold-war"]
chain:
  - type: biquad_filter
    mode: high_pass
    freq_hz: 200
    q: 0.7
  - type: biquad_filter
    mode: low_pass
    freq_hz: 5000
    q: 0.7
  - type: compressor
    threshold_db: -20
    ratio: 3.5
    attack_ms: 5
    release_ms: 50
  - type: simple_reverb
    decay_ms: 180
    mix: 0.20
    pre_delay_ms: 8
</code></pre>
<p><strong>5. SIGINT Intercept</strong> — <em>Encrypted comms being decoded. For fun.</em></p>
<p>Frequency shifting, periodic glitch artifacts, and heavy processing create the effect of intercepted encrypted communications being partially decoded. Not practical for serious play — this is the “I’m playing a spy” preset.</p>
<pre><code class="language-yaml">name: "SIGINT Intercept"
description: "Intercepted encrypted communications — partial decode artifacts"
tags: ["scrambled", "spy", "fun", "cold-war"]
chain:
  - type: biquad_filter
    mode: band_pass
    freq_hz: 1500
    q: 2.0
  - type: frequency_shift
    shift_hz: 3.0
    mix: 0.15
  - type: soft_clip_distortion
    drive: 0.30
    mode: foldback
  - type: compressor
    threshold_db: -15
    ratio: 8.0
    attack_ms: 1
    release_ms: 30
  - type: noise_layer
    type: hiss
    level_db: -28
</code></pre>
<p><strong>6. Vintage Valve</strong> — <em>1940s vacuum tube radio warmth.</em></p>
<p>Warm tube saturation, narrower bandwidth than HF radio, gentle compression. Evokes WW2-era communications equipment. Pairs well with Tiberian Dawn’s earlier-era aesthetic.</p>
<pre><code class="language-yaml">name: "Vintage Valve"
description: "Vacuum tube radio — warm saturation, WW2-era bandwidth"
tags: ["radio", "vintage", "warm", "retro"]
chain:
  - type: biquad_filter
    mode: high_pass
    freq_hz: 350
    q: 0.5
  - type: biquad_filter
    mode: low_pass
    freq_hz: 2800
    q: 0.5
  - type: soft_clip_distortion
    drive: 0.25
    mode: tube
  - type: compressor
    threshold_db: -22
    ratio: 3.0
    attack_ms: 10
    release_ms: 80
  - type: gain_stage
    gain_db: -2.0
  - type: noise_layer
    type: hiss
    level_db: -30
squelch:
  start_tone_hz: 1000
  end_tone_hz: 600
  duration_ms: 80
  volume: 0.20
</code></pre>
<h5 id="enhanced-voice-isolation-background-voice-removal"><a class="header" href="#enhanced-voice-isolation-background-voice-removal">Enhanced Voice Isolation (Background Voice Removal)</a></h5>
<p>The user’s request for “getting rid of background voices” is addressed at two levels:</p>
<ol>
<li>
<p><strong>Sender-side (existing):</strong> <code>nnnoiseless</code> (RNNoise) already handles this on the capture side. RNNoise’s GRU neural network is trained specifically to isolate a primary speaker from background noise — including other voices. It performs well against TV audio, family conversations, and roommate speech because these register as non-stationary noise at lower amplitude than the primary mic input. This is already enabled by default (<code>voice.noise_suppression: true</code>).</p>
</li>
<li>
<p><strong>Receiver-side (new, optional):</strong> An enhanced isolation mode applies a second <code>nnnoiseless</code> pass on the decoded audio. This catches background voices that survived Opus compression (Opus preserves all audio above the encoding threshold — including faint background voices that RNNoise on the sender side left in). The double-pass is more aggressive but risks removing valid speaker audio in edge cases (e.g., two people talking simultaneously into one mic). Exposed as <code>voice.enhanced_isolation: bool</code> (D033 toggle, default <code>false</code>).</p>
</li>
</ol>
<p><strong>Why receiver-side isolation is optional:</strong> Double-pass noise suppression can create audible artifacts — “underwater” voice quality when the second pass is too aggressive. Most users will find sender-side RNNoise sufficient. Enhanced isolation is for environments where background voices are a persistent problem (shared rooms, open offices) and the speaker cannot control their environment.</p>
<h5 id="workshop-voice-effect-presets"><a class="header" href="#workshop-voice-effect-presets">Workshop Voice Effect Presets</a></h5>
<p>Voice effect presets are a Workshop resource type (D030), published and shared like any other mod resource:</p>
<p><strong>Resource type:</strong> <code>voice_effect</code> (Workshop category: “Voice Effects”)
<strong>File format:</strong> YAML with <code>.icvfx.yaml</code> extension (standard YAML — <code>serde_yaml</code> deserialization)
<strong>Version:</strong> Semver, following Workshop resource conventions (D030)</p>
<p><strong>Workshop preset structure:</strong></p>
<pre><code class="language-yaml"># File: radio_spetsnaz.icvfx.yaml
# Workshop metadata block (same as all Workshop resources)
workshop:
  name: "Spetsnaz Radio"
  description: "Soviet military radio — heavy static, narrow bandwidth, authentic squelch"
  author: "comrade_modder"
  version: "1.2.0"
  license: "CC-BY-4.0"
  tags: ["radio", "soviet", "military", "cold-war", "immersive"]
  # Optional LLM metadata (D016 narrative DNA)
  llm:
    tone: "Soviet military communications — terse, formal"
    era: "Cold War, 1980s"

# DSP chain — same format as built-in presets
chain:
  - type: biquad_filter
    mode: high_pass
    freq_hz: 400
    q: 0.8
  - type: biquad_filter
    mode: low_pass
    freq_hz: 2800
    q: 0.8
  - type: compressor
    threshold_db: -16
    ratio: 8.0
    attack_ms: 2
    release_ms: 30
  - type: soft_clip_distortion
    drive: 0.18
    mode: tube
  - type: noise_layer
    type: static_crackle
    level_db: -24
squelch:
  start_tone_hz: 1400
  end_tone_hz: 900
  duration_ms: 50
  volume: 0.30
</code></pre>
<p><strong>Preview before subscribing:</strong> The Workshop browser includes an “audition” feature — a 5-second sample voice clip (bundled with IC) is processed through the effect in real-time and played back. Players hear exactly what the effect sounds like before downloading. This uses the same DSP chain instantiation as live voice — no separate preview system.</p>
<p><strong>Validation:</strong> Workshop voice effects are pure data (YAML DSP parameters). The DSP stages are built-in engine code — presets cannot execute arbitrary code. Parameter values are clamped to safe ranges (e.g., <code>drive</code> 0.0-1.0, <code>freq_hz</code> 20-20000, <code>gain_db</code> -40 to +20). This is inherently sandboxed — a malicious preset can at worst produce unpleasant audio, never crash the engine or access the filesystem. If a <code>chain</code> stage references an unknown <code>type</code>, it is skipped with a warning log.</p>
<p><strong>CLI tooling:</strong> The <code>ic</code> CLI supports effect preset development:</p>
<pre><code class="language-bash">ic audio effect preview radio_spetsnaz.icvfx.yaml      # Preview with sample clip
ic audio effect validate radio_spetsnaz.icvfx.yaml      # Check YAML structure + param ranges
ic audio effect chain-info radio_spetsnaz.icvfx.yaml    # Print stage count, CPU estimate
ic workshop publish --type voice-effect radio_spetsnaz.icvfx.yaml
</code></pre>
<h5 id="voice-effect-settings-integration"><a class="header" href="#voice-effect-settings-integration">Voice Effect Settings Integration</a></h5>
<p>Updated <code>VoiceSettings</code> resource (additions in bold comments):</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Resource)]
pub struct VoiceSettings {
    pub noise_suppression: bool,       // D033 toggle, default true
    pub enhanced_isolation: bool,      // D033 toggle, default false — receiver-side double-pass
    pub spatial_audio: bool,           // D033 toggle, default false
    pub vad_mode: bool,                // false = PTT, true = VAD
    pub ptt_key: KeyCode,
    pub max_ptt_duration_secs: u32,    // hotmic protection, default 120
    pub effect_preset: Option&lt;String&gt;, // D033 setting — preset name or None for bypass
    pub effect_enabled: bool,          // D033 toggle, default false — master effect switch
    pub per_speaker_effects: HashMap&lt;PlayerId, String&gt;, // per-speaker override presets
}
<span class="boring">}</span></code></pre>
<p><strong>D033 QoL toggle pattern:</strong> Voice effects follow the same toggle pattern as spatial audio and noise suppression. The <code>effect_preset</code> name is a D033 setting (selectable in voice settings UI). Experience profiles (D033) can bundle a voice effect preset with other preferences — e.g., an “Immersive” profile might enable spatial audio + Military Radio effect + smart danger alerts.</p>
<p><strong>Audio thread sync:</strong> When <code>VoiceSettings</code> changes (user selects a new preset in the UI), the ECS → audio thread channel sends a <code>VoiceCommand::SetEffectPreset(chain)</code> message. The audio thread instantiates the new <code>VoiceEffectChain</code> and applies it starting from the next decoded frame. No glitch — the old chain’s state is discarded and the new chain processes from a clean <code>reset()</code> state.</p>
<h5 id="competitive-considerations"><a class="header" href="#competitive-considerations">Competitive Considerations</a></h5>
<p>Voice effects are <strong>cosmetic audio processing</strong> with no competitive implications:</p>
<ul>
<li><strong>Receiver-side only</strong> — what you hear is your choice, not imposed on others. No player gains information advantage from voice effects.</li>
<li><strong>No simulation interaction</strong> — effects run entirely in <code>ic-audio</code> on the playback thread. Zero contact with <code>ic-sim</code>.</li>
<li><strong>Tournament mode (D058):</strong> Tournament organizers can restrict voice effects via lobby settings (<code>voice_effects_allowed: bool</code>). Broadcast streams may want clean voice for professional production. The restriction is per-lobby, not global — community tournaments set their own rules.</li>
<li><strong>Replay casters:</strong> When casting replays with voice-in-replay, casters apply their own effect preset (or none). This means the same replay can sound like a military briefing or a clean podcast depending on the caster’s preference.</li>
</ul>
<h4 id="ecs-integration-and-audio-thread-architecture"><a class="header" href="#ecs-integration-and-audio-thread-architecture">ECS Integration and Audio Thread Architecture</a></h4>
<p>Voice state management uses Bevy ECS. The real-time audio pipeline runs on a dedicated thread. This follows the same pattern as Bevy’s own audio system — ECS components are the <em>control surface</em>; the audio thread is the <em>engine</em>.</p>
<p><strong>ECS components and resources</strong> (in <code>ic-audio</code> and <code>ic-net</code> systems, regular <code>Update</code> schedule — NOT in <code>ic-sim</code>’s <code>FixedUpdate</code>):</p>
<p><strong>Crate boundary note:</strong> <code>ic-audio</code> (voice processing, jitter buffer, Opus encode/decode) and <code>ic-net</code> (VoicePacket send/receive on <code>MessageLane::Voice</code>) do not depend on each other directly. The bridge is <code>ic-game</code>, which depends on both and wires them together at app startup: <code>ic-net</code> systems write incoming <code>VoicePacket</code> data to a crossbeam channel; <code>ic-audio</code> systems read from that channel to feed the jitter buffer. Outgoing voice follows the reverse path. This preserves crate independence while enabling data flow — the same integration pattern <code>ic-game</code> uses to wire <code>ic-sim</code> and <code>ic-net</code> via <code>ic-protocol</code>.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Attached to player entities. Updated by the voice network system
/// when VoicePackets arrive (or VoiceActivity orders are processed).
/// Queried by ic-ui to render speaker icons.
#[derive(Component)]
pub struct VoiceActivity {
    pub speaking: bool,
    pub last_transmission: Instant,
}

/// Per-player mute/deafen state. Written by UI and /mute commands.
/// Read by the voice network system to filter forwarding hints.
#[derive(Component)]
pub struct VoiceMuteState {
    pub self_mute: bool,
    pub self_deafen: bool,
    pub muted_players: HashSet&lt;PlayerId&gt;,
}

/// Per-player incoming voice volume (0.0–2.0). Written by UI slider.
/// Sent to the audio thread via channel for per-speaker gain.
#[derive(Component)]
pub struct VoiceVolume(pub f32);

/// Per-speaker diagnostics. Updated by the audio thread via channel.
/// Queried by ic-ui to render connection quality indicators.
#[derive(Component)]
pub struct VoiceDiagnostics {
    pub jitter_ms: f32,
    pub packet_loss_pct: f32,
    pub round_trip_ms: f32,
    pub buffer_depth_frames: u32,
    pub estimated_latency_ms: f32,
}

/// Global voice settings. Synced to audio thread on change.
#[derive(Resource)]
pub struct VoiceSettings {
    pub noise_suppression: bool,     // D033 toggle, default true
    pub enhanced_isolation: bool,    // D033 toggle, default false
    pub spatial_audio: bool,         // D033 toggle, default false
    pub vad_mode: bool,              // false = PTT, true = VAD
    pub ptt_key: KeyCode,
    pub max_ptt_duration_secs: u32,  // hotmic protection, default 120
    pub effect_preset: Option&lt;String&gt;, // D033 setting, None = bypass
    pub effect_enabled: bool,        // D033 toggle, default false
}
<span class="boring">}</span></code></pre>
<p><strong>ECS ↔ Audio thread communication</strong> via lock-free <code>crossbeam</code> channels:</p>
<pre><code>┌─────────────────────────────────────────────────────┐
│  ECS World (Bevy systems — ic-audio, ic-ui, ic-net) │
│                                                     │
│  Player entities:                                   │
│    VoiceActivity, VoiceMuteState, VoiceVolume,      │
│    VoiceDiagnostics                                 │
│                                                     │
│  Resources:                                         │
│    VoiceBitrateAdapter, VoiceTransportState,         │
│    PttState, VoiceSettings                          │
│                                                     │
│  Systems:                                           │
│    voice_ui_system — reads activity, renders icons  │
│    voice_settings_system — syncs settings to thread │
│    voice_network_system — sends/receives packets    │
│      via channels, updates diagnostics              │
└──────────┬──────────────────────────┬───────────────┘
           │ crossbeam channel        │ crossbeam channel
           │ (commands ↓)             │ (events ↑)
┌──────────▼──────────────────────────▼───────────────┐
│  Audio Thread (dedicated, NOT ECS-scheduled)        │
│                                                     │
│  Capture: cpal → resample → denoise → encode        │
│  Playback: jitter buffer → decode/PLC → mix → cpal  │
│                                                     │
│  Runs on OS audio callback cadence (~5-10ms)        │
└─────────────────────────────────────────────────────┘
</code></pre>
<p><strong>Why the audio pipeline cannot be an ECS system:</strong> ECS systems run on Bevy’s task pool at frame rate (16ms at 60fps, 33ms at 30fps). Audio capture/playback runs on OS audio threads with ~5ms deadlines via <code>cpal</code> callbacks. A jitter buffer that pops every 20ms cannot be driven by a system running at frame rate — the timing mismatch causes audible artifacts. The audio thread runs independently and communicates with ECS via channels: the ECS side sends commands (“PTT pressed”, “mute player X”, “change bitrate”) and receives events (“speaker X started”, “diagnostics update”, “encoded packet ready”).</p>
<p><strong>What lives where:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Concern</th><th>ECS?</th><th>Rationale</th></tr>
</thead>
<tbody>
<tr><td>Voice state (speaking, mute, volume)</td><td>Yes</td><td>Components on player entities, queried by UI systems</td></tr>
<tr><td>Voice settings (PTT key, noise suppress)</td><td>Yes</td><td>Bevy resource, synced to audio thread via channel</td></tr>
<tr><td>Voice effect preset selection</td><td>Yes</td><td>Part of VoiceSettings; chain instantiated on audio thread</td></tr>
<tr><td>Network send/receive (VoicePacket ↔ lane)</td><td>Yes</td><td>ECS system bridges network layer and audio thread</td></tr>
<tr><td>Voice UI (speaker icons, PTT indicator)</td><td>Yes</td><td>Standard Bevy UI systems querying voice components</td></tr>
<tr><td>Audio capture + encode pipeline</td><td>No</td><td>Dedicated audio thread, cpal callback timing</td></tr>
<tr><td>Jitter buffer + decode/PLC</td><td>No</td><td>Dedicated audio thread, 20ms frame cadence</td></tr>
<tr><td>Audio output + mixing</td><td>No</td><td>Bevy audio backend thread (existing)</td></tr>
</tbody>
</table>
</div>
<h4 id="ui-indicators"><a class="header" href="#ui-indicators">UI Indicators</a></h4>
<p>Voice activity is shown in the game UI:</p>
<ul>
<li><strong>In-game overlay:</strong> Small speaker icon next to the player’s name/color indicator when they are transmitting. Follows the same placement as SC2’s voice indicators (top-right player list).</li>
<li><strong>Lobby:</strong> Speaker icon pulses when a player is speaking. Volume slider per player.</li>
<li><strong>Chat log:</strong> <code>[VOICE] Alice is speaking</code> / <code>[VOICE] Alice stopped</code> timestamps in the chat log (optional, toggle via D033 QoL).</li>
<li><strong>PTT indicator:</strong> Small microphone icon in the bottom-right corner when PTT key is held. Red slash through it when self-muted.</li>
<li><strong>Connection quality:</strong> Per-speaker signal bars (1-4 bars) derived from <code>VoiceDiagnostics</code> — jitter, loss, and latency combined into a single quality score. Visible in the player list overlay next to the speaker icon. A player with consistently poor voice quality sees a tooltip: “Poor voice connection — high packet loss” to distinguish voice issues from game network issues. Transport state (“Direct” vs “Tunneled”) shown as a small icon when TCP fallback is active.</li>
<li><strong>Hotmic warning:</strong> If PTT exceeds 90 seconds (75% of the 120s auto-cut threshold), the PTT indicator turns yellow with a countdown. At 120s, it cuts and shows a brief “PTT timeout” notification.</li>
<li><strong>Voice diagnostics panel:</strong> <code>/voice diag</code> command opens a detailed overlay (developer/power-user tool) showing per-speaker jitter histogram, packet loss graph, buffer depth, estimated mouth-to-ear latency, and encode/decode CPU time. This is the equivalent of Discord’s “Voice &amp; Video Debug” panel.</li>
<li><strong>Voice effect indicator:</strong> When a voice effect preset is active, a small filter icon appears next to the microphone indicator. Hovering shows the active preset name (e.g., “Military Radio”). The icon uses the preset’s primary tag color (radio presets = olive drab, clean presets = blue, fun presets = purple).</li>
</ul>
<h4 id="competitive-voice-rules"><a class="header" href="#competitive-voice-rules">Competitive Voice Rules</a></h4>
<p>Voice behavior in competitive contexts requires explicit rules that D058’s tournament/ranked modes enforce:</p>
<p><strong>Voice during pause:</strong> Voice transmission continues during game pauses and tactical timeouts. Voice is I/O, not simulation — pausing the sim does not pause communication. This matches CS2 (voice continues during tactical timeout) and SC2 (voice unaffected by pause). Team coordination during pauses is a legitimate strategic activity.</p>
<p><strong>Eliminated player voice routing:</strong> When a player is eliminated (all units/structures destroyed), their voice routing depends on the game mode:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Mode</th><th>Eliminated player can…</th><th>Rationale</th></tr>
</thead>
<tbody>
<tr><td>Casual / unranked</td><td>Remain on team voice</td><td>Social experience; D021 eliminated-player roles (advisor, reinforcement controller) require voice</td></tr>
<tr><td>Ranked 1v1</td><td>N/A (game ends on elimination)</td><td>No team to talk to</td></tr>
<tr><td>Ranked team</td><td>Remain on team voice for 60 seconds, then observer-only</td><td>Brief window for handoff callouts, then prevents persistent backseat gaming. Configurable via tournament rules (D058)</td></tr>
<tr><td>Tournament</td><td>Configurable by organizer: permanent team voice, timed cutoff, or immediate observer-only</td><td>Tournament organizers decide the rule for their event</td></tr>
</tbody>
</table>
</div>
<p><strong>Ranked voice channel restrictions:</strong> In ranked matchmaking (D055), <code>VoiceTarget::All</code> (all-chat voice) is <strong>disabled</strong>. Players can only use <code>VoiceTarget::Team</code>. All-chat text remains available (for gg/glhf). This matches CS2 and Valorant’s competitive modes, which restrict voice to team-only. Rationale: cross-team voice is a toxicity vector and provides no competitive value. Tournament mode (D058) can re-enable all-voice if the organizer chooses (e.g., for show matches).</p>
<p><strong>Coach slot:</strong> Community servers (D052) can designate a <strong>coach slot</strong> per team — a non-playing participant who has team voice access but cannot issue orders. The coach sees the team’s shared vision (not full-map observer view). Coach voice routing uses <code>VoiceTarget::Team</code> but the coach’s <code>PlayerId</code> is flagged as <code>PlayerRole::Coach</code> in the lobby. Coaches are subject to the same mute/report system as players. For ranked, coach slots are disabled (pure player skill measurement). For tournaments, organizer configures per-event. This follows CS2’s coach system (voice during freezetime/timeouts, restricted during live rounds) but adapted for RTS where there are no freezetime rounds — the coach can speak at all times.</p>
<h3 id="3-beacons-and-tactical-pings"><a class="header" href="#3-beacons-and-tactical-pings">3. Beacons and Tactical Pings</a></h3>
<p>The non-verbal coordination layer. Research shows this is often more effective than voice for spatial RTS communication — Respawn Entertainment play-tested Apex Legends for a month with no voice chat and found their ping system “rendered voice chat with strangers largely unnecessary” (Polygon review). EA opened the underlying patent (US 11097189, “Contextually Aware Communications Systems”) for free use in August 2021.</p>
<h4 id="openra-beacon-compatibility-d024"><a class="header" href="#openra-beacon-compatibility-d024">OpenRA Beacon Compatibility (D024)</a></h4>
<p>OpenRA’s Lua API includes <code>Beacon</code> (map beacon management) and <code>Radar</code> (radar ping control) globals. IC must support these for mission script compatibility:</p>
<ul>
<li><code>Beacon.New(owner, pos, duration, palette, isPlayerPalette)</code> — create a map beacon</li>
<li><code>Radar.Ping(player, pos, color, duration)</code> — flash a radar ping on the minimap</li>
</ul>
<p>IC’s beacon system is a superset — OpenRA’s beacons are simple map markers with duration. IC adds contextual types, entity targeting, and the ping wheel (see below). OpenRA beacon/radar Lua calls map to <code>PingType::Generic</code> with appropriate visual parameters.</p>
<h4 id="ping-type-system"><a class="header" href="#ping-type-system">Ping Type System</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Contextual ping types. Each has a distinct visual, audio cue, and
/// minimap representation. The set is fixed at the engine level but
/// game modules can register additional types via YAML.
///
/// Inspired by Apex Legends' contextual ping system, adapted for RTS:
/// Apex pings communicate "what is here" for a shared 3D space.
/// RTS pings communicate "what should we do about this location" for
/// a top-down strategic view. The emphasis shifts from identification
/// to intent.
#[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, Serialize, Deserialize)]
pub enum PingType {
    /// General attention ping. "Look here."
    /// Default when no contextual modifier applies.
    Generic,
    /// Attack order suggestion. "Attack here / attack this unit."
    /// Shows crosshair icon. Red minimap flash.
    Attack,
    /// Defend order suggestion. "Defend this location."
    /// Shows shield icon. Blue minimap flash.
    Defend,
    /// Warning / danger alert. "Enemies here" or "be careful."
    /// Shows exclamation icon. Yellow minimap flash. Pulsing audio cue.
    Danger,
    /// Rally point. "Move units here" / "gather here."
    /// Shows flag icon. Green minimap flash.
    Rally,
    /// Request assistance. "I need help here."
    /// Shows SOS icon. Orange minimap flash with urgency pulse.
    Assist,
    /// Enemy spotted — marks a position where enemy units were seen.
    /// Auto-fades after the fog of war re-covers the area.
    /// Shows eye icon. Red blinking on minimap.
    EnemySpotted,
    /// Economic marker. "Expand here" / "ore field here."
    /// Shows resource icon. Green on minimap.
    Economy,
}
<span class="boring">}</span></code></pre>
<h4 id="contextual-ping-apex-legends-adaptation"><a class="header" href="#contextual-ping-apex-legends-adaptation">Contextual Ping (Apex Legends Adaptation)</a></h4>
<p>The ping type auto-selects based on what’s under the cursor when the ping key is pressed:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Cursor Target</th><th>Auto-Selected Ping</th><th>Visual</th></tr>
</thead>
<tbody>
<tr><td>Empty terrain (own territory)</td><td><code>Rally</code></td><td>Flag marker at position</td></tr>
<tr><td>Empty terrain (enemy territory)</td><td><code>Attack</code></td><td>Crosshair marker at position</td></tr>
<tr><td>Empty terrain (neutral/unexplored)</td><td><code>Generic</code></td><td>Diamond marker at position</td></tr>
<tr><td>Visible enemy unit</td><td><code>EnemySpotted</code></td><td>Eye icon tracking the unit briefly</td></tr>
<tr><td>Own damaged building</td><td><code>Assist</code></td><td>SOS icon on building</td></tr>
<tr><td>Ore field / resource</td><td><code>Economy</code></td><td>Resource icon at position</td></tr>
<tr><td>Fog-of-war edge</td><td><code>Danger</code></td><td>Exclamation at fog boundary</td></tr>
</tbody>
</table>
</div>
<p><strong>Override via ping wheel:</strong> Holding the ping key (default: <code>G</code>) opens a radial menu (ping wheel) showing all 8 ping types. Flick the mouse in the desired direction to select. Release to place. Quick-tap (no hold) uses the contextual default. This two-tier interaction (quick contextual + deliberate selection) follows Apex Legends’ proven UX pattern.</p>
<h4 id="ping-wheel-ui"><a class="header" href="#ping-wheel-ui">Ping Wheel UI</a></h4>
<pre><code>              Danger
         ╱            ╲
    Defend              Attack
       │    [cursor]     │
    Assist              Rally
         ╲            ╱
         Economy    EnemySpotted
              Generic
</code></pre>
<p>The ping wheel is a radial menu rendered by <code>ic-ui</code>. Each segment shows the ping type icon and name. The currently highlighted segment follows the mouse direction from center. Release places the selected ping type. Escape cancels.</p>
<p><strong>Controller support (Steam Deck / future console):</strong> Ping wheel opens on right stick click, direction selected via stick. Quick-ping on D-pad press.</p>
<h4 id="ping-properties"><a class="header" href="#ping-properties">Ping Properties</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// A placed ping marker. Managed by ic-ui (rendering) and forwarded
/// to the sim via PlayerOrder::TacticalPing for replay recording.
pub struct PingMarker {
    pub id: PingId,
    pub owner: PlayerId,
    pub ping_type: PingType,
    pub pos: WorldPos,
    /// If the ping was placed on a specific entity, track it.
    /// The marker follows the entity until it dies or the ping expires.
    pub tracked_entity: Option&lt;UnitTag&gt;,
    /// Ping lifetime. Default 8 seconds. Danger pings pulse.
    pub duration: Duration,
    /// Audio cue played on placement. Each PingType has a distinct sound.
    pub audio_cue: PingAudioCue,
    /// Optional short label for typed/role-aware pings (e.g., "AA", "LZ A").
    /// Empty by default for quick pings. Bounded and sanitized.
    pub label: Option&lt;String&gt;,
    /// Optional appearance override for scripted beacons / D070 typed markers.
    /// Core ping semantics still require shape/icon cues; color cannot be the
    /// only differentiator (accessibility and ranked readability).
    pub style: Option&lt;CoordinationMarkerStyle&gt;,
    /// Tick when placed (for expiration).
    pub placed_at: u64,
}
<span class="boring">}</span></code></pre>
<p><strong>Ping rate limiting:</strong> Max 3 pings per 5 seconds per player (configurable). Exceeding the limit suppresses pings with a cooldown indicator. This prevents ping spam, which is a known toxicity vector in games with ping systems (LoL’s “missing” ping spam problem).</p>
<p><strong>Ping persistence:</strong> Pings are ephemeral — they expire after <code>duration</code> (default 8 seconds). They do NOT persist in save games. They DO appear in replays (via <code>PlayerOrder::TacticalPing</code> in the order stream).</p>
<p><strong>Audio feedback:</strong> Each ping type has a distinct short audio cue (&lt; 300ms). Incoming pings from teammates play the cue with a minimap flash. Audio volume follows the <code>voice.ping_volume</code> cvar (D058). Repeated rapid pings from the same player have diminishing audio (third ping in 5 seconds is silent) to reduce annoyance.</p>
<h4 id="beaconmarker-colors-and-optional-labels-generalsopenra-style-clarity-explicit-in-ic"><a class="header" href="#beaconmarker-colors-and-optional-labels-generalsopenra-style-clarity-explicit-in-ic">Beacon/Marker Colors and Optional Labels (Generals/OpenRA-style clarity, explicit in IC)</a></h4>
<p>IC already supports pings and tactical markers; this section makes the <strong>appearance and text-label rules explicit</strong> so “colored beaconing with optional text” is a first-class, replay-safe communication feature (not an implied UI detail).</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Shared style metadata used by pings/beacons/tactical markers.
/// Presentation-only; gameplay semantics remain in ping/marker type.
pub struct CoordinationMarkerStyle {
    pub color: MarkerColorStyle,
    pub text_label: Option&lt;String&gt;,       // bounded/sanitized tactical label (normalized bytes + display width caps)
    pub visibility: MarkerVisibility,     // team/allies/observers/scripted
    pub ttl_ticks: Option&lt;u64&gt;,           // None = persistent until cleared
}

#[derive(Clone, Copy, Debug)]
pub enum MarkerColorStyle {
    /// Use the canonical color for the ping/marker type (default).
    Canonical,
    /// Use the sender's player color (for team readability / ownership).
    PlayerColor,
    /// Use a predefined semantic color override (`Purple`, `White`, etc.).
    /// Mods/scenarios can expose a safe palette, not arbitrary RGB strings.
    Preset(CoordinationColorPreset),
}

#[derive(Clone, Copy, Debug)]
pub enum CoordinationColorPreset {
    White,
    Cyan,
    Purple,
    Orange,
    Red,
    Blue,
    Green,
    Yellow,
}

#[derive(Clone, Copy, Debug)]
pub enum MarkerVisibility {
    Team,
    AlliedTeams,
    Observer,        // tournament/admin overlays
    ScriptedAudience // mission-authored overlays / tutorials
}
<span class="boring">}</span></code></pre>
<p><strong>Rules (normative):</strong></p>
<ul>
<li><strong>Core ping types keep canonical meaning.</strong> <code>Attack</code>, <code>Danger</code>, <code>Defend</code>, etc. retain distinct icons/shapes/audio, even if a style override adjusts accent color.</li>
<li><strong>Color is never the only signal.</strong> Icons, animation, shape, and text cues remain required (colorblind-safe requirement).</li>
<li><strong>Optional labels are short and tactical.</strong> Max 16 chars, sanitized, no markup; examples: <code>AA</code>, <code>LZ-A</code>, <code>Bridge</code>, <code>Push 1</code>.</li>
<li><strong>Rate limits still apply.</strong> Styled/labeled beacons count against the same ping/marker budgets (no spam bypass via labels/colors).</li>
<li><strong>Replay-safe.</strong> Label text and style metadata are preserved in replay coordination events (subject to replay stripping rules where applicable).</li>
<li><strong>Fog-of-war and audience scope still apply.</strong> Visibility follows team/observer/scripted rules; styling cannot leak hidden intel.</li>
</ul>
<p><strong>Recommended defaults:</strong></p>
<ul>
<li>Quick ping (<code>G</code> tap): no label, canonical color, ephemeral</li>
<li>Ping wheel (<code>Hold G</code>): no label by default, canonical color</li>
<li>Tactical marker/beacon (<code>/marker</code>, marker submenu): optional short label + optional preset color</li>
<li>D070 typed support markers (<code>lz</code>, <code>cas_target</code>, <code>recon_sector</code>): canonical type color by default, optional short label (<code>LZ B</code>, <code>CAS 2</code>)</li>
</ul>
<h4 id="rtl--bidi-support-for-chat-and-marker-labels-localization--safety-split"><a class="header" href="#rtl--bidi-support-for-chat-and-marker-labels-localization--safety-split">RTL / BiDi Support for Chat and Marker Labels (Localization + Safety Split)</a></h4>
<p>IC must support legitimate RTL (Arabic/Hebrew) communication text <strong>without</strong> weakening anti-spoof protections.</p>
<p><strong>Rules (normative):</strong></p>
<ul>
<li><strong>Display correctness:</strong> Chat messages, ping labels, and tactical marker labels use the shared UI text renderer with Unicode BiDi + shaping support (see <code>02-ARCHITECTURE.md</code> layout/text contract).</li>
<li><strong>Safety filtering is input-side, not display-side.</strong> D059 sanitization removes dangerous spoofing controls and abusive invisible characters before order injection, but it does <strong>not</strong> reject legitimate RTL script content.</li>
<li><strong>Bounds apply to display width and byte payload.</strong> Label limits are enforced on both normalized byte length and rendered width so short tactical labels remain readable across scripts.</li>
<li><strong>Direction does not replace semantics.</strong> Marker meaning remains icon/type-driven. RTL labels are additive and must not become the only differentiator (same accessibility rule as color).</li>
<li><strong>Replay preservation:</strong> Normalized label bytes are stored in replay events so cross-language moderation/review tooling can reconstruct the original tactical communication context.</li>
</ul>
<p><strong>Minimum test cases (required for <code>M7.UX.D059_RTL_CHAT_MARKER_TEXT_SAFETY</code>):</strong></p>
<ol>
<li><strong>Pure RTL chat message renders correctly</strong> (Arabic/Hebrew text displays in correct order; Arabic joins/shaping are preserved).</li>
<li><strong>Mixed-script chat renders correctly</strong> (<code>RTL + LTR + numerals</code>, e.g. <code>LZ-ב 2</code>, <code>CAS 2 هدف</code>) with punctuation/numerals placed by BiDi rules.</li>
<li><strong>RTL tactical marker labels remain readable under bounds</strong> (byte limit + rendered-width limit both enforced; truncation/ellipsis does not clip glyphs or hide marker semantics).</li>
<li><strong>Dangerous spoofing controls are filtered without breaking legitimate text</strong> (bidi override/invisible abuse stripped or rejected, while normal Arabic/Hebrew labels survive normalization).</li>
<li><strong>Replay preservation is deterministic</strong> (normalized chat/marker-label bytes record and replay identically across clients/platforms).</li>
<li><strong>Moderation/review surfaces render parity</strong> (review UI shows the same normalized RTL/mixed-script text as the original chat/marker context, without color-only reliance).</li>
</ol>
<p>Use the canonical test dataset in <code>src/tracking/rtl-bidi-qa-corpus.md</code> (especially categories <code>A</code>, <code>B</code>, <code>D</code>, <code>F</code>, and <code>G</code>) to keep runtime/replay/moderation behavior aligned across platforms and regressions reproducible.</p>
<p><strong>Examples (valid):</strong></p>
<ul>
<li><code>هدف</code> (Objective)</li>
<li><code>LZ-ب</code></li>
<li><code>גשר</code> (Bridge)</li>
<li><code>CAS 2</code></li>
</ul>
<h3 id="4-novel-coordination-mechanics"><a class="header" href="#4-novel-coordination-mechanics">4. Novel Coordination Mechanics</a></h3>
<p>Beyond standard chat/voice/pings, IC introduces coordination tools not found in other RTS games:</p>
<h4 id="4a-chat-wheel-dota-2--rocket-league-pattern"><a class="header" href="#4a-chat-wheel-dota-2--rocket-league-pattern">4a. Chat Wheel (Dota 2 / Rocket League Pattern)</a></h4>
<p>A radial menu of pre-defined phrases that are:</p>
<ul>
<li><strong>Instantly sent</strong> — no typing, one keypress + flick</li>
<li><strong>Auto-translated</strong> — each phrase has a <code>phrase_id</code> that maps to the recipient’s locale, enabling communication across language barriers</li>
<li><strong>Replayable</strong> — sent as <code>PlayerOrder::ChatWheelPhrase</code> in the order stream</li>
</ul>
<pre><code class="language-yaml"># chat_wheel_phrases.yaml — game module provides these
chat_wheel:
  phrases:
    - id: 1
      category: tactical
      label:
        en: "Attack now!"
        de: "Jetzt angreifen!"
        ru: "Атакуем!"
        zh: "现在进攻!"
      audio_cue: "eva_attack"  # optional EVA voice line

    - id: 2
      category: tactical
      label:
        en: "Fall back!"
        de: "Rückzug!"
        ru: "Отступаем!"
        zh: "撤退!"
      audio_cue: "eva_retreat"

    - id: 3
      category: tactical
      label:
        en: "Defend the base!"
        de: "Basis verteidigen!"
        ru: "Защищайте базу!"
        zh: "防守基地!"

    - id: 4
      category: economy
      label:
        en: "Need more ore"
        de: "Brauche mehr Erz"
        ru: "Нужна руда"
        zh: "需要更多矿石"

    - id: 5
      category: social
      label:
        en: "Good game!"
        de: "Gutes Spiel!"
        ru: "Хорошая игра!"
        zh: "打得好！"
      audio_cue: null

    - id: 6
      category: social
      label:
        en: "Well played"
        de: "Gut gespielt"
        ru: "Хорошо сыграно"
        zh: "打得漂亮"

    # ... 20-30 phrases per game module, community can add more via mods
</code></pre>
<p><strong>Chat wheel key:</strong> Default <code>V</code>. Hold to open, flick to select, release to send. The phrase appears in team chat (or all chat, depending on category — social phrases go to all). The phrase displays in the recipient’s language, but the chat log also shows <code>[wheel]</code> tag so observers know it’s a pre-defined phrase.</p>
<p><strong>Why this matters for RTS:</strong> International matchmaking means players frequently cannot communicate by text. The chat wheel solves this with zero typing — the same phrase ID maps to every supported language. Dota 2 proved this works at scale across a global player base. For IC’s Cold War setting, phrases use military communication style: “Affirmative,” “Negative,” “Enemy contact,” “Position compromised.”</p>
<p><strong>Mod-extensible:</strong> Game modules (RA1, TD, community mods) provide their own phrase sets via YAML. The engine provides the wheel UI and <code>ChatWheelPhrase</code> order — the phrases are data, not code.</p>
<h4 id="4b-minimap-drawing"><a class="header" href="#4b-minimap-drawing">4b. Minimap Drawing</a></h4>
<p>Players can draw directly on the minimap to communicate tactical plans:</p>
<ul>
<li><strong>Activation:</strong> Hold <code>Alt</code> + click-drag on minimap (or <code>/draw</code> command via D058)</li>
<li><strong>Visual:</strong> Freeform line drawn in the player’s team color. Visible to teammates only.</li>
<li><strong>Duration:</strong> Drawings fade after 8 seconds (same as pings).</li>
<li><strong>Persistence:</strong> Drawings are sent as <code>PlayerOrder::MinimapDraw</code> — they appear in replays.</li>
<li><strong>Rate limit:</strong> Max 3 drawing strokes per 10 seconds, max 32 points per stroke. Prevents minimap vandalism.</li>
</ul>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Minimap drawing stroke. Points are quantized to cell resolution
/// to keep order size small. A typical stroke is 8-16 points.
pub struct MinimapStroke {
    pub points: Vec&lt;CellPos&gt;,    // max 32 points
    pub color: PlayerColor,
    pub thickness: u8,           // 1-3 pixels on minimap
    pub placed_at: u64,          // tick for expiration
}
<span class="boring">}</span></code></pre>
<p><strong>Why this is novel for RTS:</strong> Most RTS games have no minimap drawing. Players resort to rapid pinging to trace paths, which is imprecise and annoying. Minimap drawing enables “draw the attack route” coordination naturally. Some MOBA games (LoL) have minimap drawing; no major RTS does.</p>
<h4 id="4c-tactical-markers-persistent-team-annotations"><a class="header" href="#4c-tactical-markers-persistent-team-annotations">4c. Tactical Markers (Persistent Team Annotations)</a></h4>
<p>Unlike pings (ephemeral, 8 seconds) and drawings (ephemeral, 8 seconds), tactical markers are persistent annotations placed by team leaders:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Persistent tactical marker. Lasts until manually removed or game ends.
/// Limited to 10 per player, 30 per team. Intended for strategic planning,
/// not moment-to-moment callouts (that's what pings are for).
pub struct TacticalMarker {
    pub id: MarkerId,
    pub owner: PlayerId,
    pub marker_type: MarkerType,
    pub pos: WorldPos,
    pub label: Option&lt;String&gt;,   // bounded/sanitized short tactical label (RTL/LTR supported)
    pub style: CoordinationMarkerStyle,
    pub placed_at: u64,
}

#[derive(Clone, Copy, Debug)]
pub enum MarkerType {
    /// Numbered waypoint (1-9). For coordinating multi-prong attacks.
    Waypoint(u8),
    /// Named objective marker. Shows label on the map.
    Objective,
    /// Hazard zone. Renders a colored radius indicating danger area.
    HazardZone { radius: u16 },
}
<span class="boring">}</span></code></pre>
<p><strong>Access:</strong> Place via ping wheel (hold longer to access marker submenu) or via commands (<code>/marker waypoint 1</code>, <code>/marker objective "Expand here"</code>, <code>/marker hazard 50</code>). Optional style arguments (preset color + short label) are available in the marker panel/console, but the marker type remains the authoritative gameplay meaning. Remove with <code>/marker clear</code> or right-click on existing marker.</p>
<p><strong>Use case:</strong> Before a coordinated push, the team leader places waypoint markers 1-3 showing the attack route, an objective marker on the target, and a hazard zone on the enemy’s defensive line. These persist until the push is complete, giving the team a shared tactical picture.</p>
<h4 id="4d-smart-danger-alerts-novel"><a class="header" href="#4d-smart-danger-alerts-novel">4d. Smart Danger Alerts (Novel)</a></h4>
<p>Automatic alerts that supplement manual pings with game-state-aware warnings:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Auto-generated alerts based on sim state. These are NOT orders —
/// they are client-side UI events computed locally from the shared sim state.
/// Each player's client generates its own alerts; no network traffic.
///
/// CRITICAL: All alerts involving enemy state MUST filter through the
/// player's current fog-of-war vision. In standard lockstep, each client
/// has the full sim state — querying enemy positions without vision
/// filtering would be a built-in maphack. The alert system calls
/// `FogProvider::is_visible(player, cell)` before considering any
/// enemy entity. Only enemies the player can currently see trigger alerts.
/// (In fog-authoritative relay mode per V26, this is solved at the data
/// level — the client simply doesn't have hidden enemy state.)
pub enum SmartAlert {
    /// Large enemy force detected moving toward the player's base.
    /// Triggered when &gt;= 5 **visible** enemy units are within N cells of
    /// the base and were not there on the previous check (debounced,
    /// 10-second cooldown). Units hidden by fog of war are excluded.
    IncomingAttack { direction: CompassDirection, unit_count: u32 },
    /// Ally's base is under sustained attack (&gt; 3 buildings damaged in
    /// 10 seconds). Only fires if the attacking units or damaged buildings
    /// are within the player's shared team vision.
    AllyUnderAttack { ally: PlayerId },
    /// Undefended expansion at a known resource location.
    /// Triggered when an ore field has no friendly structures or units nearby.
    /// This alert uses only friendly-side data, so no fog filtering is needed.
    UndefendedResource { pos: WorldPos },
    /// Enemy superweapon charging (if visible). RTS-specific high-urgency alert.
    /// Only fires if the superweapon structure is within the player's vision.
    SuperweaponWarning { weapon_type: String, estimated_ticks: u64 },
}
<span class="boring">}</span></code></pre>
<p><strong>Why client-side, not sim-side:</strong> Smart alerts are purely informational — they don’t affect gameplay. Computing them client-side means zero network cost and zero impact on determinism. Each client already has the full sim state (lockstep), but <strong>alerts must respect fog of war</strong> — only visible enemy units are considered. The <code>FogProvider</code> trait (D041) provides the vision query; alerts call <code>is_visible()</code> before evaluating any enemy entity. In fog-authoritative relay mode (V26 in <code>06-SECURITY.md</code>), this is inherently safe because the client never receives hidden enemy state. The alert thresholds are configurable via D033 QoL toggles.</p>
<p><strong>Why this is novel:</strong> No RTS engine has context-aware automatic danger alerts. Players currently rely on manual minimap scanning. Smart alerts reduce the cognitive load of map awareness without automating decision-making — they tell you <em>that</em> something is happening, not <em>what to do about it</em>. This is particularly valuable for newer players who haven’t developed the habit of constant minimap checking.</p>
<p><strong>Competitive consideration:</strong> Smart alerts are a D033 QoL toggle (<code>alerts.smart_danger: bool</code>, default <code>true</code>). Tournament hosts can disable them for competitive purity. Experience profiles (D033) bundle this toggle with other QoL settings.</p>
<h3 id="5-voice-in-replay--architecture--feasibility"><a class="header" href="#5-voice-in-replay--architecture--feasibility">5. Voice-in-Replay — Architecture &amp; Feasibility</a></h3>
<p>The user asked: “would it make sense technically speaking and otherwise, to keep player voice records in the replay?”</p>
<p><strong>Yes — technically feasible, precedented, and valuable. But: strictly opt-in with clear consent.</strong></p>
<h4 id="technical-approach"><a class="header" href="#technical-approach">Technical Approach</a></h4>
<p>Voice-in-replay follows ioquake3’s proven pattern (the only open-source game with this feature): inject Opus frames as tagged messages into the replay file alongside the order stream.</p>
<p>IC’s replay format (<code>05-FORMATS.md</code>) already separates streams:</p>
<ul>
<li><strong>Order stream</strong> — deterministic tick frames (for playback)</li>
<li><strong>Analysis event stream</strong> — sampled sim state (for stats tools)</li>
</ul>
<p>Voice adds a third stream:</p>
<ul>
<li><strong>Voice stream</strong> — timestamped Opus frames (for communication context)</li>
</ul>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Replay file structure with voice stream.
/// Voice is a separate section with its own offset in the header.
/// Tools that don't need voice skip it entirely — zero overhead.
///
/// The voice stream is NOT required for replay playback — it adds
/// communication context, not gameplay data.
pub struct ReplayVoiceStream {
    /// Per-player voice tracks, each independently seekable.
    pub tracks: Vec&lt;VoiceTrack&gt;,
}

pub struct VoiceTrack {
    pub player: PlayerId,
    /// Whether this player consented to voice recording.
    /// If false, this track is empty (header only, no frames).
    pub consented: bool,
    pub frames: Vec&lt;VoiceReplayFrame&gt;,
}

pub struct VoiceReplayFrame {
    /// Game tick when this audio was transmitted.
    pub tick: u64,
    /// Opus-encoded audio data. Same codec as live audio.
    pub opus_data: Vec&lt;u8&gt;,
    /// Original voice target (team/all). Preserved for replay filtering.
    pub target: VoiceTarget,
}
<span class="boring">}</span></code></pre>
<p><strong>Header extension:</strong> The replay header (<code>ReplayHeader</code>) gains a new field:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct ReplayHeader {
    // ... existing fields ...
    pub voice_offset: u32,       // 0 if no voice stream
    pub voice_length: u32,       // Compressed length of voice stream
}
<span class="boring">}</span></code></pre>
<p>The <code>flags</code> field gains a <code>HAS_VOICE</code> bit. Replay viewers check this flag before attempting to load voice data.</p>
<h4 id="storage-cost"><a class="header" href="#storage-cost">Storage Cost</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Game Duration</th><th>Players Speaking</th><th>Avg Bitrate</th><th>DTX Savings</th><th>Voice Stream Size</th></tr>
</thead>
<tbody>
<tr><td>20 min</td><td>2 of 4</td><td>32 kbps</td><td>~40%</td><td>~1.3 MB</td></tr>
<tr><td>45 min</td><td>3 of 8</td><td>32 kbps</td><td>~40%</td><td>~4.7 MB</td></tr>
<tr><td>60 min</td><td>4 of 8</td><td>32 kbps</td><td>~40%</td><td>~8.3 MB</td></tr>
</tbody>
</table>
</div>
<p>Compare to the order stream: a 60-minute game’s order stream (compressed) is ~2-5 MB. Voice roughly doubles the replay size when all players are recorded. For <code>Minimal</code> replays (the default), voice adds 1-8 MB — still well within reasonable file sizes for modern storage.</p>
<p><strong>Mitigation:</strong> Voice data is LZ4-compressed independently of the order stream. Opus is already compressed (it does not benefit much from generic compression), so LZ4 primarily helps with the framing overhead and silence gaps.</p>
<h4 id="consent-model"><a class="header" href="#consent-model">Consent Model</a></h4>
<p><strong>Recording voice in replays is a serious privacy decision.</strong> The design must make consent explicit, informed, and revocable:</p>
<ol>
<li>
<p><strong>Opt-in, not opt-out.</strong> Voice recording for replays is disabled by default. Players enable it via a settings toggle (<code>replay.record_voice: bool</code>, default <code>false</code>).</p>
</li>
<li>
<p><strong>Per-session consent display.</strong> When joining a game where ANY player has voice recording enabled, all players see a notification: “Voice may be recorded for replay by: Alice, Bob.” This ensures no one is unknowingly recorded.</p>
</li>
<li>
<p><strong>Per-player granularity.</strong> Each player independently decides whether THEIR voice is recorded. Alice can record her own voice while Bob opts out — Bob’s track in the replay is empty.</p>
</li>
<li>
<p><strong>Relay enforcement.</strong> The relay server tracks each player’s recording consent flag. The replay writer (each client) only writes voice frames for consenting players. Even if a malicious client records non-consenting voice locally, the <em>shared</em> replay file (relay-signed, D007) contains only consented tracks.</p>
</li>
<li>
<p><strong>Post-game stripping.</strong> The <code>/replay strip-voice</code> command (D058) removes the voice stream from a replay file, producing a voice-free copy. Players can share gameplay replays without voice.</p>
</li>
<li>
<p><strong>No voice in ranked replays by default.</strong> Ranked match replays submitted for ladder certification (D055) strip voice automatically. Voice is a communication channel, not a gameplay record — it has no bearing on match verification.</p>
</li>
<li>
<p><strong>Legal compliance.</strong> In jurisdictions requiring two-party consent for recording (e.g., California, Germany), the per-session notification + opt-in model satisfies the consent requirement. Players who haven’t enabled recording cannot have their voice captured.</p>
</li>
</ol>
<h4 id="replay-playback-with-voice"><a class="header" href="#replay-playback-with-voice">Replay Playback with Voice</a></h4>
<p>During replay playback, voice is synchronized to the game tick:</p>
<ul>
<li>Voice frames are played at the tick they were originally transmitted</li>
<li>Fast-forward/rewind seeks the voice stream to the nearest frame boundary</li>
<li>Voice is mixed into playback audio at a configurable volume (<code>replay.voice_volume</code> cvar)</li>
<li>Individual player voice tracks can be muted/soloed (useful for analysis: “what was Alice saying when she attacked?”)</li>
<li>Voice target filtering: viewer can choose to hear only <code>All</code> chat, only <code>Team</code> chat, or both</li>
</ul>
<p><strong>Use cases for voice-in-replay:</strong></p>
<ul>
<li><strong>Tournament commentary:</strong> Casters can hear team communication during featured replays (with player consent), adding depth to analysis</li>
<li><strong>Coaching:</strong> A coach reviews a student’s replay with voice to understand decision-making context</li>
<li><strong>Community content:</strong> YouTubers/streamers share replays with natural commentary intact</li>
<li><strong>Post-game review:</strong> Players review their own team communication for improvement</li>
</ul>
<h3 id="6-security-considerations"><a class="header" href="#6-security-considerations">6. Security Considerations</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Vulnerability</th><th>Risk</th><th>Mitigation</th></tr>
</thead>
<tbody>
<tr><td><strong>Voice spoofing</strong></td><td>HIGH</td><td>Relay stamps <code>speaker: PlayerId</code> on all forwarded voice packets. Client-submitted speaker ID is overwritten. Same pattern as ioquake3 server-side VoIP.</td></tr>
<tr><td><strong>Voice DDoS</strong></td><td>MEDIUM</td><td>Rate limit: max 50 voice packets/sec per player (relay-enforced). Bandwidth cap: <code>MessageLane::Voice</code> has a 16 KB buffer — overflow drops oldest frames. Exceeding rate limit triggers mute + warning.</td></tr>
<tr><td><strong>Voice data in replays</strong></td><td>HIGH</td><td>Opt-in consent model (see § 5). Voice tracks only written for consenting players. <code>/replay strip-voice</code> for post-hoc removal. No voice in ranked replays by default.</td></tr>
<tr><td><strong>Ping spam / toxicity</strong></td><td>MEDIUM</td><td>Max 3 pings per 5 seconds per player. Diminishing audio on rapid pings. Report pathway for ping abuse.</td></tr>
<tr><td><strong>Chat flood</strong></td><td>LOW</td><td>5 messages per 3 seconds (relay-enforced). Slow mode indicator. Already addressed by ProtocolLimits (V15).</td></tr>
<tr><td><strong>Minimap drawing abuse</strong></td><td>LOW</td><td>Max 3 strokes per 10 seconds, 32 points per stroke. Drawings are team-only. Report pathway.</td></tr>
<tr><td><strong>Whisper harassment</strong></td><td>MEDIUM</td><td>Player-level mute persists across sessions (SQLite, D034). Whisper requires mutual non-mute (if either party has muted the other, whisper is silently dropped). Report → admin mute pathway.</td></tr>
<tr><td><strong>Observer voice coaching</strong></td><td>HIGH</td><td>In competitive/ranked games, observers cannot transmit voice to players. Observer <code>VoiceTarget::All/Team</code> is restricted to observer-only routing. Same isolation as observer chat.</td></tr>
<tr><td><strong>Content in voice data</strong></td><td>MEDIUM</td><td>IC does not moderate voice content in real-time (no speech-to-text analysis). Moderation is reactive: player reports + replay review. Community server admins (D052) can review voice replays of reported games.</td></tr>
</tbody>
</table>
</div>
<p><strong>New ProtocolLimits fields:</strong></p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct ProtocolLimits {
    // ... existing fields (V15) ...
    pub max_voice_packets_per_second: u32,    // 50 (1 per 20ms frame)
    pub max_voice_packet_size: usize,         // 256 bytes (covers single-frame 64kbps Opus
                                              // = ~160 byte payload + headers. Multi-frame
                                              // bundles (frame_count &gt; 1) send multiple packets,
                                              // not one oversized packet.)
    pub max_pings_per_interval: u32,          // 3 per 5 seconds
    pub max_minimap_draw_points: usize,       // 32 per stroke
    pub max_tactical_markers_per_player: u8,  // 10
    pub max_tactical_markers_per_team: u8,    // 30
}
<span class="boring">}</span></code></pre>
<h3 id="7-platform-considerations"><a class="header" href="#7-platform-considerations">7. Platform Considerations</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Platform</th><th>Text Chat</th><th>VoIP</th><th>Pings</th><th>Chat Wheel</th><th>Minimap Draw</th></tr>
</thead>
<tbody>
<tr><td><strong>Desktop</strong></td><td>Full keyboard</td><td>PTT or VAD; Opus/UDP</td><td>G key + wheel</td><td>V key + wheel</td><td>Alt+drag</td></tr>
<tr><td><strong>Browser (WASM)</strong></td><td>Full keyboard</td><td>PTT; Opus/WebRTC (str0m)</td><td>Same</td><td>Same</td><td>Same</td></tr>
<tr><td><strong>Steam Deck</strong></td><td>On-screen KB</td><td>PTT on trigger/bumper</td><td>D-pad or touchpad</td><td>D-pad submenu</td><td>Touch minimap</td></tr>
<tr><td><strong>Mobile (future)</strong></td><td>On-screen KB</td><td>PTT button on screen</td><td>Tap-hold on minimap</td><td>Radial menu on hold</td><td>Finger draw</td></tr>
</tbody>
</table>
</div>
<p><strong>Mobile minimap + bookmark coexistence:</strong> On phone/tablet layouts, camera bookmarks sit in a <strong>bookmark dock adjacent to the minimap/radar cluster</strong> rather than overloading minimap gestures. This keeps minimap interactions free for camera jump, pings, and drawing (D059), while giving touch players a fast, visible “save/jump camera location” affordance similar to C&amp;C Generals. Gesture priority is explicit: touches that start on bookmark chips stay bookmark interactions; touches that start on the minimap stay minimap interactions.</p>
<p><strong>Layout and handedness:</strong> The minimap cluster (minimap + alerts + bookmark dock) mirrors with the player’s handedness setting. The command rail remains on the dominant-thumb side, so minimap communication and camera navigation stay on the opposite side and don’t fight for the same thumb.</p>
<p><strong>Official binding profile integration (D065):</strong> Communication controls in D059 are not a separate control scheme. They are semantic actions in D065’s canonical input action catalog (e.g., <code>open_chat</code>, <code>voice_ptt</code>, <code>ping_wheel</code>, <code>chat_wheel</code>, <code>minimap_draw</code>, <code>callvote</code>, <code>mute_player</code>) and are mapped through the same official profiles (<code>Classic RA</code>, <code>OpenRA</code>, <code>Modern RTS</code>, <code>Gamepad Default</code>, <code>Steam Deck Default</code>, <code>Touch Phone/Tablet</code>). This keeps tutorial prompts, Quick Reference, and “What’s Changed in Controls” updates consistent across devices and profile changes.</p>
<p><strong>Discoverability rule (controller/touch):</strong> Every D059 communication action must have a visible UI path in addition to any shortcut/button chord. Example: PTT may be on a shoulder button, but the voice panel still exposes the active binding and a test control; pings/chat wheel may use radial holds, but the pause/controls menu and Quick Reference must show how to trigger them on the current profile.</p>
<h3 id="8-lua-api-extensions-d024"><a class="header" href="#8-lua-api-extensions-d024">8. Lua API Extensions (D024)</a></h3>
<p>Building on the existing <code>Beacon</code> and <code>Radar</code> globals from OpenRA compatibility:</p>
<pre><code class="language-lua">-- Existing OpenRA globals (unchanged)
Beacon.New(owner, pos, duration, palette, isPlayerPalette)
Radar.Ping(player, pos, color, duration)

-- IC extensions
Ping.Place(player, pos, pingType)          -- Place a typed ping
Ping.PlaceOnTarget(player, target, pingType) -- Ping tracking an entity
Ping.Clear(player)                          -- Clear all pings from player
Ping.ClearAll()                             -- Clear all pings (mission use)

ChatWheel.Send(player, phraseId)           -- Trigger a chat wheel phrase
ChatWheel.RegisterPhrase(id, translations) -- Register a custom phrase

Marker.Place(player, pos, markerType, label)       -- Place tactical marker (default style)
Marker.PlaceStyled(player, pos, markerType, label, style) -- Optional color/TTL/visibility style
Marker.Remove(player, markerId)                    -- Remove a marker
Marker.ClearAll(player)                            -- Clear all markers

Chat.Send(player, channel, message)        -- Send a chat message
Chat.SendToAll(player, message)            -- Convenience: all-chat
Chat.SendToTeam(player, message)           -- Convenience: team-chat
</code></pre>
<p><strong>Mission scripting use cases:</strong> Lua mission scripts can place scripted pings (“attack this target”), send narrated chat messages (briefing text during gameplay), and manage tactical markers (pre-placed waypoints for mission objectives). The <code>Chat.Send</code> function enables bot-style NPC communication in co-op scenarios.</p>
<h3 id="9-console-commands-d058-integration"><a class="header" href="#9-console-commands-d058-integration">9. Console Commands (D058 Integration)</a></h3>
<p>All coordination features are accessible via the command console:</p>
<pre><code>/all &lt;message&gt;           # Send to all-chat
/team &lt;message&gt;          # Send to team chat  
/w &lt;player&gt; &lt;message&gt;    # Whisper to player
/mute &lt;player&gt;           # Mute player (voice + text)
/unmute &lt;player&gt;         # Unmute player
/mutelist                # Show muted players
/block &lt;player&gt;          # Block player socially (messages/invites/profile contact)
/unblock &lt;player&gt;        # Remove social block
/blocklist               # Show blocked players
/report &lt;player&gt; &lt;category&gt; [note] # Submit moderation report (D052 review pipeline)
/avoid &lt;player&gt;          # Add best-effort matchmaking avoid preference (D055; queue feature)
/unavoid &lt;player&gt;        # Remove matchmaking avoid preference
/voice volume &lt;0-100&gt;    # Set incoming voice volume
/voice ptt &lt;key&gt;         # Set push-to-talk key
/voice toggle            # Toggle voice on/off
/voice diag              # Open voice diagnostics overlay
/voice effect list       # List available effect presets (built-in + Workshop)
/voice effect set &lt;name&gt; # Apply effect preset (e.g., "Military Radio")
/voice effect off        # Disable voice effects
/voice effect preview &lt;name&gt;  # Play sample clip with effect applied
/voice effect info &lt;name&gt;     # Show preset details (stages, CPU estimate, author)
/voice isolation toggle  # Toggle enhanced voice isolation (receiver-side double-pass)
/ping &lt;type&gt; [x] [y] [label] [color] # Place a ping (optional short label/preset color)
/ping clear              # Clear your pings
/draw                    # Toggle minimap drawing mode
/marker &lt;type&gt; [label] [color] [ttl] [scope] # Place tactical marker/beacon at cursor
/marker clear [id|all]   # Remove marker(s)
/wheel &lt;phrase_id&gt;       # Send chat wheel phrase by ID
/support request &lt;type&gt; [target] [note] # D070 support/requisition request
/support respond &lt;id&gt; &lt;approve|deny|eta|hold&gt; [reason] # D070 commander response
/replay strip-voice &lt;file&gt; # Remove voice from replay file
</code></pre>
<h3 id="10-role-aware-coordination-presets-d070-commander--field-ops-co-op"><a class="header" href="#10-role-aware-coordination-presets-d070-commander--field-ops-co-op">10. Role-Aware Coordination Presets (D070 Commander &amp; Field Ops Co-op)</a></h3>
<p>D070’s asymmetric co-op mode (<code>Commander &amp; Field Ops</code>) extends D059 with a <strong>standardized request/response coordination layer</strong>. This is a D059 communication feature, not a separate subsystem.</p>
<p><strong>Scope split:</strong></p>
<ul>
<li><strong>D059 owns</strong> request/response UX, typed markers, status vocabulary, shortcuts, and replay-visible coordination events</li>
<li><strong>D070/D038 scenarios own</strong> gameplay meaning (which support exists, costs/cooldowns, what happens on approval)</li>
</ul>
<h4 id="support-request-lifecycle-d070-extension"><a class="header" href="#support-request-lifecycle-d070-extension">Support request lifecycle (D070 extension)</a></h4>
<p>For D070 scenarios, D059 supports a visible lifecycle for role-aware support requests:</p>
<ul>
<li><code>Pending</code></li>
<li><code>Approved</code></li>
<li><code>Denied</code></li>
<li><code>Queued</code></li>
<li><code>Inbound</code></li>
<li><code>Completed</code></li>
<li><code>Failed</code></li>
<li><code>CooldownBlocked</code></li>
</ul>
<p>These statuses appear in role-specific HUD panels (Commander queue, Field Ops request feedback) and can be mirrored to chat/log output for accessibility and replay review.</p>
<h4 id="role-aware-coordination-surfaces-minimum-v1"><a class="header" href="#role-aware-coordination-surfaces-minimum-v1">Role-aware coordination surfaces (minimum v1)</a></h4>
<ul>
<li>Field Ops request wheel / quick actions (<code>Need CAS</code>, <code>Need Recon</code>, <code>Need Reinforcements</code>, <code>Need Extraction</code>, <code>Need Funds</code>, <code>Objective Complete</code>)</li>
<li>Commander response shortcuts (<code>Approved</code>, <code>Denied</code>, <code>On Cooldown</code>, <code>ETA</code>, <code>Marking LZ</code>, <code>Hold Position</code>)</li>
<li>Typed support markers/pings (<code>lz</code>, <code>cas_target</code>, <code>recon_sector</code>, <code>extraction</code>, <code>fallback</code>)</li>
<li>Request queue + status panel on Commander HUD</li>
<li>Request status feedback on Field Ops HUD (not chat-only)</li>
</ul>
<h4 id="request-economy--anti-spam-ux-requirements-d070"><a class="header" href="#request-economy--anti-spam-ux-requirements-d070">Request economy / anti-spam UX requirements (D070)</a></h4>
<p>D059 must support D070’s request economy by providing UI and status affordances for:</p>
<ul>
<li>duplicate-request collapse (“same request already pending”)</li>
<li>cooldown/availability reasons (<code>On Cooldown</code>, <code>Insufficient Budget</code>, <code>Not Unlocked</code>, <code>Out of Range</code>, etc.)</li>
<li>queue ordering / urgency visibility on the Commander side</li>
<li>fast Commander acknowledgments that reduce chat/voice load under pressure</li>
<li>typed support-marker labels and color accents (optional) without replacing marker-type semantics</li>
</ul>
<p>This keeps the communication layer useful when commandos/spec-ops become high-impact enough that both teams may counter with their own special units.</p>
<h4 id="replay--determinism-policy"><a class="header" href="#replay--determinism-policy">Replay / determinism policy</a></h4>
<p>Request creation/response actions and typed coordination markers should be represented as deterministic coordination events/orders (same design intent as pings/chat wheel) so replays preserve the teamwork context. Actual support execution remains normal gameplay orders validated by the sim (D012).</p>
<h4 id="discoverability--accessibility-rule-reinforced-for-d070"><a class="header" href="#discoverability--accessibility-rule-reinforced-for-d070">Discoverability / accessibility rule (reinforced for D070)</a></h4>
<p>Every D070 role-critical coordination action must have:</p>
<ul>
<li>a shortcut path (keyboard/controller/touch quick access)</li>
<li>a visible UI path</li>
<li>non-color-only status signaling for request states</li>
</ul>
<h3 id="alternatives-considered"><a class="header" href="#alternatives-considered">Alternatives Considered</a></h3>
<ul>
<li><strong>External voice only (Discord/TeamSpeak/Mumble)</strong> (rejected — external voice is the status quo for OpenRA and it’s the #1 friction point for new players. Forcing third-party voice excludes casual players, fragments the community, and makes beacons/pings impossible to synchronize with voice. Built-in voice is table stakes for a modern multiplayer game. However, deep analysis of Mumble’s protocol, Janus SFU, and str0m’s sans-I/O WebRTC directly informed IC’s VoIP design — see <code>research/open-source-voip-analysis.md</code> for the full survey.)</li>
<li><strong>P2P voice instead of relay-forwarded</strong> (rejected — P2P voice exposes player IP addresses to all participants. This is a known harassment vector: competitive players have been DDoS’d via IPs obtained from game voice. Relay-forwarded voice maintains D007’s IP privacy guarantee. The bandwidth cost is negligible for the relay.)</li>
<li><strong>WebRTC for all platforms</strong> (rejected — WebRTC’s complexity (ICE negotiation, STUN/TURN, DTLS) is unnecessary overhead for native desktop clients that already have a UDP connection to the relay. Raw Opus-over-UDP is simpler, lower latency, and sufficient. WebRTC is used only for browser builds where raw UDP is unavailable.)</li>
<li><strong>Voice activation (VAD) as default</strong> (rejected — VAD transmits background noise, keyboard sounds, and private conversations. Every competitive game that tried VAD-by-default reverted to PTT-by-default. VAD remains available as a user preference for casual play.)</li>
<li><strong>Voice moderation via speech-to-text</strong> (rejected — real-time STT is compute-intensive, privacy-invasive, unreliable across accents/languages, and creates false positive moderation actions. Reactive moderation via reports + voice replay review is more appropriate. IC is not a social platform with tens of millions of users — community-scale moderation (D037/D052) is sufficient.)</li>
<li><strong>Always-on voice recording in replays</strong> (rejected — recording without consent is a privacy violation in many jurisdictions. Even with consent, always-on recording creates storage overhead for every game. Opt-in recording is the correct default. ioquake3 records voice in demos by default, but ioquake3 predates modern privacy law.)</li>
<li><strong>Opus alternative: Lyra/Codec2</strong> (rejected — Lyra is a Google ML-based codec with excellent compression (3 kbps) but requires ML model distribution, is not WASM-friendly, and has no Rust bindings. Codec2 is designed for amateur radio with lower quality than Opus at comparable bitrates. Opus is the industry standard, has mature Rust bindings, and is universally supported.)</li>
<li><strong>Custom ping types per mod</strong> (partially accepted — the engine defines the 8 core ping types; game modules can register additional types via YAML. This avoids UI inconsistency while allowing mod creativity. Custom ping types inherit the rate-limiting and visual framework.)</li>
<li><strong>Sender-side voice effects</strong> (rejected — applying DSP effects before Opus encoding wastes codec bits on the effect rather than the voice, degrades quality, and forces the sender’s aesthetic choice on all listeners. Receiver-side effects let each player choose their own experience while preserving clean audio for replays and broadcast.)</li>
<li><strong>External DSP library (fundsp/dasp) for voice effects</strong> (deferred to <code>M11</code> / Phase 7+, <code>P-Optional</code> — the built-in DSP stages (biquad, compressor, soft-clip, noise gate, reverb, de-esser) are ~500 lines of straightforward Rust. External libraries add dependency weight for operations that don’t need their generality. Validation trigger: convolution reverb / FFT-based effects become part of accepted scope.)</li>
<li><strong>Voice morphing / pitch shifting</strong> (deferred to <code>M11</code> / Phase 7+, <code>P-Optional</code> — AI-powered voice morphing (deeper voice, gender shifting, character voices) is technically feasible but raises toxicity concerns: voice morphing enables identity manipulation in team games. Competitive games that implemented voice morphing (Fortnite’s party effects) limit it to cosmetic fun modes. If adopted, it is a Workshop resource type with social guardrails, not a competitive baseline feature.)</li>
<li><strong>Shared audio channels / proximity voice</strong> (deferred to <code>M11</code> / Phase 7+, <code>P-Optional</code> — proximity voice where you hear players based on their units’ positions is interesting for immersive scenarios but confusing for competitive play. The <code>SPATIAL</code> flag provides spatial panning as a toggle-able approximation. Full proximity voice is outside the current competitive baseline and requires game-mode-specific validation.)</li>
</ul>
<h3 id="integration-with-existing-decisions"><a class="header" href="#integration-with-existing-decisions">Integration with Existing Decisions</a></h3>
<ul>
<li><strong>D006 (NetworkModel):</strong> Voice is not a NetworkModel concern — it is an <code>ic-net</code> service that sits alongside <code>NetworkModel</code>, using the same <code>Transport</code> connection but on a separate <code>MessageLane</code>. <code>NetworkModel</code> handles orders; voice forwarding is independent.</li>
<li><strong>D007 (Relay Server):</strong> Voice packets are relay-forwarded, maintaining IP privacy and consistent routing. The relay’s voice forwarding is stateless — it copies bytes without decoding Opus. The relay’s rate limiting (per-player voice packet cap) defends against voice DDoS.</li>
<li><strong>D024 (Lua API):</strong> IC extends Beacon and Radar globals with <code>Ping</code>, <code>ChatWheel</code>, <code>Marker</code>, and <code>Chat</code> globals. OpenRA beacon/radar calls map to IC’s ping system with <code>PingType::Generic</code>.</li>
<li><strong>D033 (QoL Toggles):</strong> Spatial audio, voice effects (preset selection), enhanced voice isolation, smart danger alerts, ping sounds, voice recording are individually toggleable. Experience profiles (D033) bundle communication preferences — e.g., an “Immersive” profile enables spatial audio + Military Radio voice effect + smart danger alerts.</li>
<li><strong>D054 (Transport):</strong> On native builds, voice uses the same <code>Transport</code> trait connection as orders — Opus frames are sent on <code>MessageLane::Voice</code> over <code>UdpTransport</code>. On browser builds, voice uses a parallel <code>str0m</code> WebRTC session <em>alongside</em> (not through) the <code>Transport</code> trait, because browser audio capture/playback requires WebRTC media APIs. The relay bridges between the two: it receives voice from native clients on <code>MessageLane::Voice</code> and from browser clients via WebRTC, then forwards to each recipient using their respective transport. The <code>VoiceTransport</code> enum (<code>Native</code> / <code>WebRtc</code>) selects the appropriate path per platform.</li>
<li><strong>D055 (Ranked Matchmaking):</strong> Voice is stripped from ranked replay submissions. Chat and pings are preserved (they are orders in the deterministic stream).</li>
<li><strong>D058 (Chat/Command Console):</strong> All coordination features are accessible via console commands. D058 defined the input system; D059 defines the routing, voice, spatial signaling, and voice effect selection that D058’s commands control. The <code>/all</code>, <code>/team</code>, <code>/w</code> commands were placeholder in D058 — D059 specifies their routing implementation. Voice effect commands (<code>/voice effect list</code>, <code>/voice effect set</code>, <code>/voice effect preview</code>) give console-first access to the voice effects system.</li>
<li><strong>D070 (Asymmetric Commander &amp; Field Ops Co-op):</strong> D059 provides the standardized request/response coordination UX, typed support markers, and status vocabulary for D070 scenarios. D070 defines gameplay meaning and authoring; D059 defines the communication surfaces and feedback loops.</li>
<li><strong>05-FORMATS.md (Replay Format):</strong> Voice stream extends the replay file format with a new section. The replay header gains <code>voice_offset</code>/<code>voice_length</code> fields and a <code>HAS_VOICE</code> flag bit. Voice is independent of the order and analysis streams — tools that don’t process voice ignore it.</li>
<li><strong>06-SECURITY.md:</strong> New <code>ProtocolLimits</code> fields for voice, ping, and drawing rate limits. Voice spoofing prevention (relay-stamped speaker ID). Voice-in-replay consent model addresses privacy requirements.</li>
<li><strong>D010 (Snapshots) / Analysis Event Stream:</strong> The replay analysis event stream now includes <strong>camera position samples</strong> (<code>CameraPositionSample</code>), <strong>selection tracking</strong> (<code>SelectionChanged</code>), <strong>control group events</strong> (<code>ControlGroupEvent</code>), <strong>ability usage</strong> (<code>AbilityUsed</code>), <strong>pause events</strong> (<code>PauseEvent</code>), and <strong>match end events</strong> (<code>MatchEnded</code>) — see <code>05-FORMATS.md</code> § “Analysis Event Stream” for the full enum. Camera samples are lightweight (~8 bytes per player per sample at 2 Hz = ~1 KB/min for 8 players). D059 notes this integration because voice-in-replay is most valuable when combined with camera tracking — hearing what a player said while seeing what they were looking at.</li>
<li><strong>03-NETCODE.md (Match Lifecycle):</strong> D059’s competitive voice rules (pause behavior, eliminated player routing, ranked restrictions, coach slot) integrate with the match lifecycle protocol defined in <code>03-NETCODE.md</code> § “Match Lifecycle.” Voice pause behavior follows the game pause state — voice continues during pause per D059’s competitive voice rules. Surrender and disconnect events affect voice routing (eliminated-to-observer transition). The <strong>In-Match Vote Framework</strong> (<code>03-NETCODE.md</code> § “In-Match Vote Framework”) extends D059’s tactical coordination: tactical polls build on the chat wheel phrase system (<code>poll: true</code> phrases in <code>chat_wheel_phrases.yaml</code>), and <code>/callvote</code> commands are registered via D058’s Brigadier command tree. See vote framework research: <code>research/vote-callvote-system-analysis.md</code>.</li>
</ul>
<h3 id="shared-infrastructure-voice-game-netcode--workshop-cross-pollination"><a class="header" href="#shared-infrastructure-voice-game-netcode--workshop-cross-pollination">Shared Infrastructure: Voice, Game Netcode &amp; Workshop Cross-Pollination</a></h3>
<p>IC’s voice system (D059), game netcode (<code>03-NETCODE.md</code>), and Workshop distribution (D030/D049/D050) share underlying networking patterns. This section documents concrete improvements that flow between them — shared infrastructure that avoids duplicate work and strengthens all three systems.</p>
<h4 id="unified-connection-quality-monitor"><a class="header" href="#unified-connection-quality-monitor">Unified Connection Quality Monitor</a></h4>
<p>Both voice (D059’s <code>VoiceBitrateAdapter</code>) and game netcode (<code>03-NETCODE.md</code> § Adaptive Run-Ahead) independently monitor connection quality to adapt their behavior. Voice adjusts Opus bitrate based on packet loss and RTT. Game adjusts order submission timing based on relay timing feedback. Both systems need the same measurements — yet without coordination, they probe independently.</p>
<p><strong>Improvement:</strong> A single <code>ConnectionQuality</code> resource in <code>ic-net</code>, updated by the relay connection, feeds both systems:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Shared connection quality state — updated by the relay connection,
/// consumed by voice, game netcode, and Workshop download scheduler.
#[derive(Resource)]
pub struct ConnectionQuality {
    pub rtt_ms: u32,                  // smoothed RTT (EWMA)
    pub rtt_variance_ms: u32,         // jitter estimate
    pub packet_loss_pct: u8,          // 0-100, rolling window
    pub bandwidth_estimate_kbps: u32, // estimated available bandwidth
    pub quality_tier: QualityTier,    // derived summary for quick decisions
}

pub enum QualityTier {
    Excellent,  // &lt;30ms RTT, &lt;1% loss
    Good,       // &lt;80ms RTT, &lt;3% loss
    Fair,       // &lt;150ms RTT, &lt;5% loss  
    Poor,       // &lt;300ms RTT, &lt;10% loss
    Critical,   // &gt;300ms RTT or &gt;10% loss
}
<span class="boring">}</span></code></pre>
<p><strong>Who benefits:</strong></p>
<ul>
<li><strong>Voice:</strong> <code>VoiceBitrateAdapter</code> reads <code>ConnectionQuality</code> instead of maintaining its own RTT/loss measurements. Bitrate decisions align with the game connection’s actual state.</li>
<li><strong>Game netcode:</strong> Adaptive run-ahead uses the same smoothed RTT that voice uses, ensuring consistent latency estimation across systems.</li>
<li><strong>Workshop downloads:</strong> Large package downloads (D049) can throttle based on <code>bandwidth_estimate_kbps</code> during gameplay — never competing with order delivery or voice. Downloads pause automatically when <code>quality_tier</code> drops to <code>Poor</code> or <code>Critical</code>.</li>
</ul>
<h4 id="voice-jitter-buffer--game-order-buffering"><a class="header" href="#voice-jitter-buffer--game-order-buffering">Voice Jitter Buffer ↔ Game Order Buffering</a></h4>
<p>D059’s adaptive jitter buffer (EWMA-based target depth, packet loss concealment) solves the same fundamental problem as game order delivery: variable-latency packet arrival that must be smoothed into regular consumption.</p>
<p><strong>Voice → Game improvement:</strong> The jitter buffer’s adaptive EWMA algorithm can inform the game’s run-ahead calculation. Currently, adaptive run-ahead adjusts order submission timing based on relay feedback. The voice jitter buffer’s <code>target_depth</code> — computed from the same connection’s actual packet arrival variance — provides a more responsive signal: if voice packets are arriving with high jitter, game order submission should also pad its timing.</p>
<p><strong>Game → Voice improvement:</strong> The game netcode’s token-based liveness check (nonce echo, <code>03-NETCODE.md</code> § Anti-Lag-Switch) detects frozen clients within one missed token. The voice system should use the same liveness signal — if the game connection’s token check fails (client frozen), the voice system can immediately switch to PLC (Opus Packet Loss Concealment) rather than waiting for voice packet timeouts. This reduces the detection-to-concealment latency from ~200ms (voice timeout) to ~33ms (one game tick).</p>
<h4 id="lane-priority--voiceorder-bandwidth-arbitration"><a class="header" href="#lane-priority--voiceorder-bandwidth-arbitration">Lane Priority &amp; Voice/Order Bandwidth Arbitration</a></h4>
<p>D059 uses <code>MessageLane::Voice</code> (priority tier 1, weight 2) alongside game orders (<code>MessageLane::Orders</code>, priority tier 0). The lane system already prevents voice from starving orders. But the interaction can be tighter:</p>
<p><strong>Improvement:</strong> When <code>ConnectionQuality.quality_tier</code> drops to <code>Poor</code>, the voice system should proactively reduce bitrate <em>before</em> the lane system needs to drop voice packets. The sequence:</p>
<ol>
<li><code>ConnectionQuality</code> detects degradation</li>
<li><code>VoiceBitrateAdapter</code> drops to minimum bitrate (16 kbps) preemptively</li>
<li>Lane scheduler sees reduced voice traffic, allocates freed bandwidth to order reliability (retransmits)</li>
<li>When quality recovers, voice ramps back up over 2 seconds</li>
</ol>
<p>This is better than the current design where voice and orders compete reactively — the voice system cooperates proactively because it reads the same quality signal.</p>
<h4 id="workshop-p2p-distribution--spectator-feeds"><a class="header" href="#workshop-p2p-distribution--spectator-feeds">Workshop P2P Distribution ↔ Spectator Feeds</a></h4>
<p>D049’s BitTorrent/WebTorrent infrastructure for Workshop package distribution can serve double duty:</p>
<p><strong>Spectator feed fan-out:</strong> When a popular tournament match has 500+ spectators, the relay server becomes a bandwidth bottleneck (broadcasting delayed <code>TickOrders</code> to all spectators). Workshop’s P2P distribution pattern solves this: the relay sends the spectator feed to N seed peers, who redistribute to other spectators via WebTorrent. The feed is chunked by tick range (matching the replay format’s 256-tick LZ4 blocks) — each chunk is a small torrent piece that peers can share immediately after receiving it.</p>
<p><strong>Replay distribution:</strong> Tournament replays often see thousands of downloads in the first hour. Instead of serving from a central server, popular <code>.icrep</code> files can use Workshop’s BitTorrent distribution — the replay file format’s block structure (header + per-256-tick LZ4 chunks) maps naturally to torrent pieces.</p>
<h4 id="unified-cryptographic-identity"><a class="header" href="#unified-cryptographic-identity">Unified Cryptographic Identity</a></h4>
<p>Five systems independently use Ed25519 signing:</p>
<ol>
<li><strong>Game netcode</strong> — relay server signs <code>CertifiedMatchResult</code> (D007)</li>
<li><strong>Voice</strong> — relay stamps speaker ID on forwarded voice packets (D059)</li>
<li><strong>Replay</strong> — signature chain hashes each tick (05-FORMATS.md)</li>
<li><strong>Workshop</strong> — package signatures (D049)</li>
<li><strong>Community servers</strong> — SCR credential records (D052)</li>
</ol>
<p><strong>Improvement:</strong> A single <code>IdentityProvider</code> in <code>ic-net</code> manages the relay’s signing key and exposes a <code>sign(payload: &amp;[u8])</code> method. All five systems call this instead of independently managing <code>ed25519_dalek</code> instances. Key rotation (required for long-running servers) happens in one place. The <code>SignatureScheme</code> enum (D054) gates algorithm selection for all five systems uniformly.</p>
<h4 id="voice-preprocessing--workshop-audio-content"><a class="header" href="#voice-preprocessing--workshop-audio-content">Voice Preprocessing ↔ Workshop Audio Content</a></h4>
<p>D059’s audio preprocessing pipeline (noise suppression via <code>nnnoiseless</code>, echo cancellation via <code>speexdsp-rs</code>, Opus encoding via <code>audiopus</code>) is a complete audio processing chain that has value beyond real-time voice:</p>
<p><strong>Workshop audio quality tool:</strong> Content creators producing voice packs, announcer mods, and sound effect packs for the Workshop can use the same preprocessing pipeline as a quality normalization tool (<code>ic audio normalize</code>). This ensures Workshop audio content meets consistent quality standards (sample rate, loudness, noise floor) without requiring creators to own professional audio software.</p>
<p><strong>Workshop voice effect presets:</strong> The DSP stages used in voice effects (biquad filters, compressors, reverb, distortion) are shared infrastructure between the real-time voice effects chain and the <code>ic audio effect</code> CLI tools. Content creators developing custom voice effect presets use the same <code>ic audio effect preview</code> and <code>ic audio effect validate</code> commands that the engine uses to instantiate chains at runtime. The YAML preset format is a Workshop resource type — presets are published, versioned, rated, and discoverable through the same Workshop browser as maps and mods.</p>
<h4 id="adaptive-quality-is-the-shared-pattern"><a class="header" href="#adaptive-quality-is-the-shared-pattern">Adaptive Quality Is the Shared Pattern</a></h4>
<p>The meta-pattern across all three systems is <strong>adaptive quality degradation</strong> — gracefully reducing fidelity when resources are constrained, rather than failing:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>System</th><th>Constrained Resource</th><th>Degradation Response</th><th>Recovery</th></tr>
</thead>
<tbody>
<tr><td><strong>Voice</strong></td><td>Bandwidth/loss</td><td>Reduce Opus bitrate (32→16 kbps), increase FEC</td><td>Ramp back over 2s</td></tr>
<tr><td><strong>Game</strong></td><td>Latency</td><td>Increase run-ahead, pad order submission</td><td>Reduce run-ahead as RTT improves</td></tr>
<tr><td><strong>Workshop</strong></td><td>Bandwidth during gameplay</td><td>Pause/throttle downloads</td><td>Resume at full speed post-game</td></tr>
<tr><td><strong>Spectator feed</strong></td><td>Relay bandwidth</td><td>Switch to P2P fan-out, reduce feed rate</td><td>Return to relay-direct when load drops</td></tr>
<tr><td><strong>Replay</strong></td><td>Storage</td><td><code>Minimal</code> embedding mode (no map/assets)</td><td><code>SelfContained</code> when storage allows</td></tr>
</tbody>
</table>
</div>
<p>All five responses share the same trigger signal (<code>ConnectionQuality</code>), the same reaction pattern (reduce → adapt → recover), and the same design philosophy (D015’s efficiency pyramid — better algorithms before more resources). Building them on shared infrastructure ensures they cooperate rather than compete.</p>
<hr>
<hr>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../decisions/09g/D058-command-console.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../../decisions/09g/D065-tutorial.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../decisions/09g/D058-command-console.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../../decisions/09g/D065-tutorial.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../../mark-09e88c2c.min.js"></script>
        <script src="../../searcher-c2a407aa.js"></script>

        <script src="../../clipboard-1626706a.min.js"></script>
        <script src="../../highlight-abc7f01d.js"></script>
        <script src="../../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>

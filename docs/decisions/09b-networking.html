<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Networking &amp; Multiplayer - Iron Curtain — Design Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Design docs for a Rust-native Red Alert RTS engine">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-1e683dcc.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-a0d63c9c.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Iron Curtain — Design Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/DK26/iron-curtain-design-docs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>
                        <a href="https://github.com/DK26/iron-curtain-design-docs/edit/main/src/decisions/09b-networking.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <span class=fa-svg id="git-edit-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M421.7 220.3l-11.3 11.3-22.6 22.6-205 205c-6.6 6.6-14.8 11.5-23.8 14.1L30.8 511c-8.4 2.5-17.5 .2-23.7-6.1S-1.5 489.7 1 481.2L38.7 353.1c2.6-9 7.5-17.2 14.1-23.8l205-205 22.6-22.6 11.3-11.3 33.9 33.9 62.1 62.1 33.9 33.9zM96 353.9l-9.3 9.3c-.9 .9-1.6 2.1-2 3.4l-25.3 86 86-25.3c1.3-.4 2.5-1.1 3.4-2l9.3-9.3H112c-8.8 0-16-7.2-16-16V353.9zM453.3 19.3l39.4 39.4c25 25 25 65.5 0 90.5l-14.5 14.5-22.6 22.6-11.3 11.3-33.9-33.9-62.1-62.1L314.3 67.7l11.3-11.3 22.6-22.6 14.5-14.5c25-25 65.5-25 90.5 0z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="decision-log--networking--multiplayer"><a class="header" href="#decision-log--networking--multiplayer">Decision Log — Networking &amp; Multiplayer</a></h1>
<p>Network model, relay server, sub-tick ordering, community servers, ranked play, and matchmaking.</p>
<hr>
<h2 id="d006-networking--pluggable-via-trait"><a class="header" href="#d006-networking--pluggable-via-trait">D006: Networking — Pluggable via Trait</a></h2>
<p><strong>Revision note (2026-02-22):</strong> Revised to clarify product-vs-architecture scope. IC ships one default/recommended multiplayer netcode for normal play, but the <code>NetworkModel</code> abstraction remains a hard requirement so the project can (a) support future compatibility/bridge experiments with other engines or legacy games where a different network/protocol adapter is needed, and (b) replace the default netcode later if a serious flaw or better architecture is discovered.</p>
<p><strong>Decision:</strong> Abstract all networking behind a <code>NetworkModel</code> trait. Game loop is generic over it.</p>
<p><strong>Rationale:</strong></p>
<ul>
<li>Sim never touches networking concerns (clean boundary)</li>
<li>Full testability (run sim with <code>LocalNetwork</code>)</li>
<li>Community can contribute netcode without understanding game logic</li>
<li>Enables future models: rollback, client-server, cross-engine adapters</li>
<li>Enables bridge/proxy adapters for cross-version/community interoperability experiments without touching <code>ic-sim</code></li>
<li>De-risks future netcode replacement (better default / serious flaw response) behind a stable game-loop boundary</li>
<li>Selection is a deployment/profile/compatibility policy by default, not a generic “choose any netcode” player-facing lobby toggle</li>
</ul>
<p><strong>Key invariant:</strong> <code>ic-sim</code> has zero imports from <code>ic-net</code>. They only share <code>ic-protocol</code>.</p>
<p><strong>Cross-engine validation:</strong> Godot’s <code>MultiplayerAPI</code> trait follows the same pattern — an abstract multiplayer interface with a default <code>SceneMultiplayer</code> implementation and a null <code>OfflineMultiplayerPeer</code> for single-player/testing (which validates IC’s <code>LocalNetwork</code> concept). O3DE’s separate <code>AzNetworking</code> (transport layer: TCP, UDP, serialization) and <code>Multiplayer</code> Gem (game-level replication, authority, entity migration) validates IC’s <code>ic-net</code> / <code>ic-protocol</code> separation. Both engines prove that trait-abstracted networking with a null/offline implementation is the industry-standard pattern for testable game networking. See <code>research/godot-o3de-engine-analysis.md</code>.</p>
<hr>
<hr>
<h2 id="d007-networking--relay-server-as-default"><a class="header" href="#d007-networking--relay-server-as-default">D007: Networking — Relay Server as Default</a></h2>
<p><strong>Revision note (2026-02-22):</strong> Revised to clarify failure-policy expectations: relay remains the default and ranked authority path, but relay failure handling is mode-specific. Ranked follows degraded-certification / void policy (see <code>06-SECURITY.md</code> V32) rather than automatic P2P failover; casual/custom games may offer unranked continuation or fallback paths.</p>
<p><strong>Decision:</strong> Default multiplayer uses relay server with time authority, not pure P2P. The relay logic (<code>RelayCore</code>) is a library component in <code>ic-net</code> — it can be deployed as a standalone binary (dedicated server for hosting, server rooms, Raspberry Pi) or embedded inside a game client (listen server — “Host Game” button, zero external infrastructure). Clients connecting to either deployment use the same protocol and cannot distinguish between them.</p>
<p><strong>Rationale:</strong></p>
<ul>
<li>Blocks lag switches (server owns the clock)</li>
<li>Enables sub-tick chronological ordering (CS2 insight)</li>
<li>Handles NAT traversal (no port forwarding — dedicated server mode)</li>
<li>Enables order validation before broadcast (anti-cheat)</li>
<li>Signed replays</li>
<li>Cheap to run (doesn’t run sim, just forwards orders — ~2-10 KB memory per game)</li>
<li><strong>Listen server mode:</strong> embedded relay lets any player host a game with full sub-tick ordering and anti-lag-switch, no external server needed. Host’s own orders go through the same <code>RelayCore</code> pipeline — no host advantage in order processing.</li>
<li><strong>Dedicated server mode:</strong> standalone binary for competitive/ranked play, community hosting, and multi-game capacity on cheap hardware.</li>
</ul>
<p><strong>Trust boundary:</strong> For ranked/competitive play, the matchmaking system requires connection to an official or community-verified dedicated relay (untrusted host can’t be allowed relay authority). For casual/LAN/custom games, the embedded relay is preferred — zero setup, full relay quality.</p>
<p><strong>Relay failure policy:</strong> If a relay dies mid-match, ranked/competitive matches do <strong>not</strong> silently fail over to a different authority path (e.g., ad-hoc P2P) because that breaks certification and trust assumptions. Ranked follows the degraded-certification / void policy in <code>06-SECURITY.md</code> (V32). Casual/custom games may offer unranked continuation via reconnect or fallback if all participants support it.</p>
<p><strong>Validated by:</strong> C&amp;C Generals/Zero Hour’s “packet router” — a client-side star topology where one player collected and rebroadcast all commands. IC’s embedded relay improves on this pattern: the host’s orders go through <code>RelayCore</code>‘s sub-tick pipeline like everyone else’s (no peeking, no priority), eliminating the host advantage that Generals had. The dedicated server mode further eliminates any hosting-related advantage. See <code>research/generals-zero-hour-netcode-analysis.md</code>. Further validated by Valve’s GameNetworkingSockets (GNS), which defaults to relay (Valve SDR — Steam Datagram Relay) for all connections, including P2P-capable scenarios. GNS’s rationale mirrors ours: relay eliminates NAT traversal headaches, provides consistent latency measurement, and blocks IP-level attacks. The GNS architecture also validates encrypting all relay traffic (AES-GCM-256 + Curve25519) — see D054 § Transport encryption. See <code>research/valve-github-analysis.md</code>. Additionally validated by Embark Studios’ <strong>Quilkin</strong> — a production Rust UDP proxy for game servers (1,510★, Apache 2.0, co-developed with Google Cloud Gaming). Quilkin provides a concrete implementation of relay-as-filter-chain: session routing via token-based connection IDs, QCMP latency measurement for server selection, composable filter pipeline (Capture → Firewall → RateLimit → TokenRouter), and full OTEL observability. Quilkin’s production deployment on Tokio + tonic confirms that async Rust handles game relay traffic at scale. See <code>research/embark-studios-rust-gamedev-analysis.md</code>.</p>
<p><strong>Alternatives available:</strong> Pure P2P lockstep, fog-authoritative server, rollback — all implementable as <code>NetworkModel</code> variants.</p>
<hr>
<hr>
<h2 id="d008-sub-tick-timestamps-on-orders"><a class="header" href="#d008-sub-tick-timestamps-on-orders">D008: Sub-Tick Timestamps on Orders</a></h2>
<p><strong>Revision note (2026-02-22):</strong> Revised to clarify trust semantics. Client-submitted sub-tick timestamps are treated as timing hints. In relay modes, the relay normalizes/clamps them into canonical sub-tick timestamps before broadcast using relay-owned timing calibration and skew bounds. In P2P mode, peers deterministically order by <code>(sub_tick_time, player_id)</code> with known fairness limitations.</p>
<p><strong>Decision:</strong> Every order carries a sub-tick timestamp hint. Orders within a tick are processed in chronological order using a canonical timestamp ordering rule for the active <code>NetworkModel</code>.</p>
<p><strong>Rationale (inspired by CS2):</strong></p>
<ul>
<li>Fairer results for edge cases (two players competing for same resource/building)</li>
<li>Simple protocol shape (attach integer timestamp hint at input layer); enforcement/canonicalization happens in the network model</li>
<li>Network model preserves but doesn’t depend on timestamps</li>
<li>If a future model ignores timestamps, no breakage</li>
</ul>
<hr>
<hr>
<h2 id="d011-cross-engine-play--community-layer-not-sim-layer"><a class="header" href="#d011-cross-engine-play--community-layer-not-sim-layer">D011: Cross-Engine Play — Community Layer, Not Sim Layer</a></h2>
<p><strong>Decision:</strong> Cross-engine compatibility targets data/community layer. NOT bit-identical simulation.</p>
<p><strong>Rationale:</strong></p>
<ul>
<li>Bit-identical sim requires bug-for-bug reimplementation (that’s a port, not our engine)</li>
<li>Community interop is valuable and achievable: shared server browser, maps, mod format</li>
<li>Applies equally to OpenRA and CnCNet — both are <code>CommunityBridge</code> targets (shared game browser, community discovery)</li>
<li>CnCNet integration is discovery-layer only: IC games use IC relay servers (not CnCNet tunnels), IC rankings are separate (different balance, anti-cheat, match certification)</li>
<li>Architecture keeps the door open for deeper interop later (OrderCodec, SimReconciler, ProtocolAdapter)</li>
<li>Progressive levels: shared lobby → replay viewing → casual cross-play → competitive cross-play</li>
</ul>
<hr>
<hr>
<h2 id="d012-security--validate-orders-in-sim"><a class="header" href="#d012-security--validate-orders-in-sim">D012: Security — Validate Orders in Sim</a></h2>
<p><strong>Decision:</strong> Every order is validated inside the simulation before execution. Validation is deterministic.</p>
<p><strong>Rationale:</strong></p>
<ul>
<li>All clients run same validation → agree on rejections → no desync</li>
<li>Defense in depth with relay server validation</li>
<li>Repeated rejections indicate cheating (loggable)</li>
<li>No separate “anti-cheat” system — validation IS anti-cheat</li>
</ul>
<p><strong>Dual error reporting:</strong> Validation produces two categories of rejection, following the pattern used by SC2’s order system (see <code>research/blizzard-github-analysis.md</code> § Part 4):</p>
<ol>
<li>
<p><strong>Immediate rejection</strong> — the order is structurally invalid or fails preconditions that can be checked at submission time (unit doesn’t exist, player doesn’t own the unit, ability on cooldown, insufficient resources). The sim rejects the order before it enters the execution pipeline. All clients agree on the rejection deterministically.</p>
</li>
<li>
<p><strong>Late failure</strong> — the order was valid when submitted but fails during execution (target died between order and execution, path became blocked, build site was occupied by the time construction starts). The order entered the pipeline but the action could not complete. Late failures are normal gameplay, not cheating indicators.</p>
</li>
</ol>
<p>Only <em>immediate rejections</em> count toward suspicious-activity tracking. Late failures happen to legitimate players constantly (e.g., two allies both target the same enemy, one kills it before the other’s attack lands). SC2 defines 214 distinct <code>ActionResult</code> codes for this taxonomy — IC uses a smaller set grouped by category:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum OrderRejectionCategory {
    Ownership,      // unit doesn't belong to this player
    Resources,      // can't afford
    Prerequisites,  // tech tree not met
    Targeting,      // invalid target type
    Placement,      // can't build there
    Cooldown,       // ability not ready
    Transport,      // transport full / wrong passenger type
    Custom,         // game-module-defined rejection
}
<span class="boring">}</span></code></pre>
<hr>
<hr>
<h2 id="d052-community-servers-with-portable-signed-credentials"><a class="header" href="#d052-community-servers-with-portable-signed-credentials">D052: Community Servers with Portable Signed Credentials</a></h2>
<h3 id="decision-capsule-llmrag-summary"><a class="header" href="#decision-capsule-llmrag-summary">Decision Capsule (LLM/RAG Summary)</a></h3>
<ul>
<li><strong>Status:</strong> Accepted</li>
<li><strong>Phase:</strong> Multi-phase (community services, matchmaking/ranked integration, portable credentials)</li>
<li><strong>Canonical for:</strong> Community server federation, portable signed player credentials, and ranking authority trust chain</li>
<li><strong>Scope:</strong> <code>ic-net</code> relay/community integration, <code>ic-server</code>, ranking/matchmaking services, client credential storage, community federation</li>
<li><strong>Decision:</strong> Multiplayer ranking and competitive identity are hosted by self-hostable <strong>Community Servers</strong> that issue <strong>Ed25519-signed portable credential records</strong> stored locally by the player and presented on join.</li>
<li><strong>Why:</strong> Low server operating cost, federation/self-hosting, local-first privacy, and reuse of relay-certified match results as the trust anchor.</li>
<li><strong>Non-goals:</strong> Mandatory centralized ranking database; JWT-based token design; always-online master account dependency for every ranked/community interaction.</li>
<li><strong>Invariants preserved:</strong> Relay remains the multiplayer time/order authority (D007) but not the long-term ranking database; local-first data philosophy (D034/D042) remains intact.</li>
<li><strong>Defaults / UX behavior:</strong> Players can join multiple communities with separate credentials/rankings; the official IC community is just one community, not a privileged singleton.</li>
<li><strong>Security / Trust impact:</strong> SCR format uses Ed25519 only, no algorithm negotiation, monotonic sequence numbers for replay/revocation handling, and community-key identity binding.</li>
<li><strong>Performance / Ops impact:</strong> Community servers can run on low-cost infrastructure because long-term player history is carried by the player, not stored centrally.</li>
<li><strong>Public interfaces / types / commands:</strong> <code>CertifiedMatchResult</code>, <code>RankingProvider</code>, Signed Credential Records (SCR), community key rotation / revocation records</li>
<li><strong>Affected docs:</strong> <code>src/03-NETCODE.md</code>, <code>src/06-SECURITY.md</code>, <code>src/decisions/09e-community.md</code>, <code>src/15-SERVER-GUIDE.md</code></li>
<li><strong>Revision note summary:</strong> None</li>
<li><strong>Keywords:</strong> community server, signed credentials, SCR, ed25519, ranking federation, portable rating, self-hosted matchmaking</li>
</ul>
<p><strong>Decision:</strong> Multiplayer ranking, matchmaking, and competitive history are managed through <strong>Community Servers</strong> — self-hostable services that federate like Workshop sources (D030/D050). Player skill data is stored <strong>locally</strong> in a per-community SQLite credential file, with each record individually signed by the community server using Ed25519. The player presents the credential file when joining games; the server verifies its signature without needing to look up a central database. This is architecturally equivalent to JWT-style portable tokens, but uses a purpose-built binary format (<strong>Signed Credential Records</strong>, SCR) that eliminates the entire class of JWT vulnerabilities.</p>
<p><strong>Rationale:</strong></p>
<ul>
<li><strong>Server-side storage is expensive and fragile.</strong> A traditional ranking server must store every player’s rating, match history, and achievements — growing linearly with player count. A Community Server that only issues signed credentials can serve thousands of players from a $5/month VPS because it stores almost nothing. Player data lives on the player’s machine (in SQLite, per D034).</li>
<li><strong>Federation is already the architecture.</strong> D030/D050 proved that federated sources work for the Workshop. The same model works for multiplayer: players join communities like they subscribe to Workshop sources. Multiple communities coexist — an “Official IC” community, a clan community, a tournament community, a local LAN community. Each tracks its own independent rankings.</li>
<li><strong>Local-first matches the privacy design.</strong> D042 already stores player behavioral profiles locally. D034 uses SQLite for all persistent state. Keeping credential files local is the natural extension — players own their data, carry it between machines, and decide who sees it.</li>
<li><strong>The relay server already certifies match results.</strong> D007’s relay architecture produces <code>CertifiedMatchResult</code> (relay-signed match outcomes). The community server receives these, computes rating updates, and signs new credential records. The trust chain is: relay certifies the match happened → community server certifies the rating change.</li>
<li><strong>Self-hosting is a core principle.</strong> Any community can run its own server with its own ranking rules, its own matchmaking criteria, and its own competitive identity. The official IC community is just one of many, not a privileged singleton.</li>
</ul>
<h3 id="what-is-a-community-server"><a class="header" href="#what-is-a-community-server">What Is a Community Server?</a></h3>
<p>A Community Server is a unified service endpoint that provides any combination of:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Capability</th><th>Description</th><th>Existing Design</th></tr>
</thead>
<tbody>
<tr><td><strong>Workshop source</strong></td><td>Hosts and distributes mods</td><td>D030 federation, D050 library</td></tr>
<tr><td><strong>Game relay</strong></td><td>Hosts multiplayer game sessions</td><td>D007 relay server</td></tr>
<tr><td><strong>Ranking authority</strong></td><td>Tracks player ratings, signs credential records</td><td>D041 <code>RankingProvider</code> trait, <strong>this decision</strong></td></tr>
<tr><td><strong>Matchmaking service</strong></td><td>Matches players by skill, manages lobbies</td><td>P004 (partially resolved by this decision)</td></tr>
<tr><td><strong>Achievement authority</strong></td><td>Signs achievement unlock records</td><td>D036 achievement system</td></tr>
</tbody>
</table>
</div>
<p>Operators enable/disable each capability independently. A small clan community might run only relay + ranking. A large competitive community runs everything. The official IC community runs all five. The <code>ic-server</code> binary (see D049 § “Netcode ↔ Workshop Cross-Pollination”) bundles all capabilities into a single process with feature flags.</p>
<h3 id="signed-credential-records-scr--not-jwt"><a class="header" href="#signed-credential-records-scr--not-jwt">Signed Credential Records (SCR) — Not JWT</a></h3>
<p>Every player interaction with a community produces a <strong>Signed Credential Record</strong>: a compact binary blob signed by the community server’s Ed25519 private key. These records are stored in the player’s local SQLite credential file and presented to servers for verification.</p>
<p><strong>Why not JWT?</strong></p>
<p>JWT (RFC 7519) is the obvious choice for portable signed credentials, but it carries a decade of known vulnerabilities that IC deliberately avoids:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>JWT Vulnerability</th><th>How It Works</th><th>IC’s SCR Design</th></tr>
</thead>
<tbody>
<tr><td>Algorithm confusion (CVE-2015-9235)</td><td><code>alg</code> header tricks verifier into using wrong algorithm (e.g., RS256 key as HS256 secret)</td><td><strong>No algorithm field.</strong> Always Ed25519. Hardcoded in verifier, not read from token.</td></tr>
<tr><td><code>alg: none</code> bypass</td><td>JWT spec allows unsigned tokens; broken implementations accept them</td><td><strong>No algorithm negotiation.</strong> Signature always required, always Ed25519.</td></tr>
<tr><td>JWKS injection / <code>jku</code> redirect</td><td>Attacker injects keys via URL-based key discovery endpoints</td><td><strong>No URL-based key discovery.</strong> Community public key stored locally at join time. Key rotation uses signed rotation records.</td></tr>
<tr><td>Token replay</td><td>JWT has no built-in replay protection</td><td><strong>Monotonic sequence number</strong> per player per record type. Old sequences rejected.</td></tr>
<tr><td>No revocation</td><td>JWT valid until expiry; requires external blacklists</td><td><strong>Sequence-based revocation.</strong> “Revoke all sequences before N” = one integer per player. Tiny revocation list, not a full token blacklist.</td></tr>
<tr><td>Payload bloat</td><td>Base64(JSON) is verbose. Large payloads inflate HTTP headers.</td><td><strong>Binary format.</strong> No base64, no JSON. Typical record: ~200 bytes.</td></tr>
<tr><td>Signature stripping</td><td>Dot-separated <code>header.payload.signature</code> is trivially separable</td><td><strong>Opaque binary blob.</strong> Signature embedded at fixed offset after payload.</td></tr>
<tr><td>JSON parsing ambiguity</td><td>Duplicate keys, unicode escapes, number precision vary across parsers</td><td><strong>Not JSON.</strong> Deterministic binary serialization. Zero parsing ambiguity.</td></tr>
<tr><td>Cross-service confusion</td><td>JWT from Service A accepted by Service B</td><td><strong>Community key fingerprint embedded.</strong> Record signed by Community A verifiably differs from Community B.</td></tr>
<tr><td>Weak key / HMAC secrets</td><td>HS256 with short secrets is brute-forceable</td><td><strong>Ed25519 only.</strong> Asymmetric, 128-bit security level. No shared secrets.</td></tr>
</tbody>
</table>
</div>
<p><strong>SCR binary format:</strong></p>
<pre><code>┌─────────────────────────────────────────────────────┐
│  version          1 byte     (0x01)                 │
│  record_type      1 byte     (rating|match|ach|rev|keyrot) │
│  community_key    32 bytes   (Ed25519 public key)   │
│  player_key       32 bytes   (Ed25519 public key)   │
│  sequence         8 bytes    (u64 LE, monotonic)    │
│  issued_at        8 bytes    (i64 LE, Unix seconds) │
│  expires_at       8 bytes    (i64 LE, Unix seconds) │
│  payload_len      4 bytes    (u32 LE)               │
│  payload          variable   (record-type-specific)  │
│  signature        64 bytes   (Ed25519)              │
├─────────────────────────────────────────────────────┤
│  Total: 158 + payload_len bytes                     │
│  Signature covers: all bytes before signature       │
└─────────────────────────────────────────────────────┘
</code></pre>
<ul>
<li><strong><code>version</code></strong> — format version for forward compatibility. Start at 1. Version changes require reissuance.</li>
<li><strong><code>record_type</code></strong> — <code>0x01</code> = rating snapshot, <code>0x02</code> = match result, <code>0x03</code> = achievement, <code>0x04</code> = revocation, <code>0x05</code> = key rotation.</li>
<li><strong><code>community_key</code></strong> — the community server’s Ed25519 public key. Binds the record to exactly one community. Verification uses this key.</li>
<li><strong><code>player_key</code></strong> — the player’s Ed25519 public key. This IS the player’s identity within the community.</li>
<li><strong><code>sequence</code></strong> — monotonic per-player counter. Each new record increments it. Revocation is “reject all sequences below N.” This replaces JWT’s lack of revocation with an O(1) check.</li>
<li><strong><code>issued_at</code> / <code>expires_at</code></strong> — timestamps. Expired records require a server sync to refresh. Default expiry: 7 days for rating records, never for match/achievement records.</li>
<li><strong><code>payload</code></strong> — record-type-specific binary data (see below).</li>
<li><strong><code>signature</code></strong> — Ed25519 signature over all preceding bytes. Community server’s private key never leaves the server.</li>
</ul>
<h3 id="community-credential-store-sqlite"><a class="header" href="#community-credential-store-sqlite">Community Credential Store (SQLite)</a></h3>
<p>Each community a player belongs to gets a separate SQLite file in the player’s data directory:</p>
<pre><code>&lt;data_dir&gt;/communities/
  ├── official-ic.db          # Official community
  ├── clan-wolfpack.db        # Clan community
  └── tournament-2026.db      # Tournament community
</code></pre>
<p><strong>Schema:</strong></p>
<pre><code class="language-sql">-- Community identity (one row)
CREATE TABLE community_info (
    community_key   BLOB NOT NULL,     -- Current SK Ed25519 public key (32 bytes)
    recovery_key    BLOB NOT NULL,     -- RK Ed25519 public key (32 bytes) — cached at join
    community_name  TEXT NOT NULL,
    server_url      TEXT NOT NULL,      -- Community server endpoint
    key_fingerprint TEXT NOT NULL,      -- hex(SHA-256(community_key)[0..8])
    rk_fingerprint  TEXT NOT NULL,      -- hex(SHA-256(recovery_key)[0..8])
    sk_rotated_at   INTEGER,           -- when current SK was activated (null = original)
    joined_at       INTEGER NOT NULL,   -- Unix timestamp
    last_sync       INTEGER NOT NULL    -- Last successful server contact
);

-- Key rotation history (for audit trail and chain verification)
CREATE TABLE key_rotations (
    sequence        INTEGER PRIMARY KEY,
    old_key         BLOB NOT NULL,     -- retired SK public key
    new_key         BLOB NOT NULL,     -- replacement SK public key
    signed_by       TEXT NOT NULL,     -- 'signing_key' or 'recovery_key'
    reason          TEXT NOT NULL,     -- 'scheduled', 'migration', 'compromise', 'precautionary'
    effective_at    INTEGER NOT NULL,  -- Unix timestamp
    grace_until     INTEGER NOT NULL,  -- old key accepted until this time
    rotation_record BLOB NOT NULL      -- full signed rotation record bytes
);

-- Player identity within this community (one row)
CREATE TABLE player_info (
    player_key      BLOB NOT NULL,     -- Ed25519 public key (32 bytes)
    display_name    TEXT,
    avatar_hash     TEXT,              -- SHA-256 of avatar image (for cache / fetch)
    bio             TEXT,              -- short self-description (max 500 chars)
    title           TEXT,              -- earned/selected title (e.g., "Iron Commander")
    registered_at   INTEGER NOT NULL
);

-- Current ratings (latest signed snapshot per rating type)
CREATE TABLE ratings (
    game_module     TEXT NOT NULL,      -- 'ra', 'td', etc.
    rating_type     TEXT NOT NULL,      -- algorithm_id() from RankingProvider
    rating          INTEGER NOT NULL,   -- Fixed-point (e.g., 1500000 = 1500.000)
    deviation       INTEGER NOT NULL,   -- Glicko-2 RD, fixed-point
    volatility      INTEGER NOT NULL,   -- Glicko-2 σ, fixed-point
    games_played    INTEGER NOT NULL,
    sequence        INTEGER NOT NULL,
    scr_blob        BLOB NOT NULL,      -- Full signed SCR
    PRIMARY KEY (game_module, rating_type)
);

-- Match history (append-only, each row individually signed)
CREATE TABLE matches (
    match_id        BLOB PRIMARY KEY,   -- SHA-256 of match data
    sequence        INTEGER NOT NULL,
    played_at       INTEGER NOT NULL,
    game_module     TEXT NOT NULL,
    map_name        TEXT,
    duration_ticks  INTEGER,
    result          TEXT NOT NULL,       -- 'win', 'loss', 'draw', 'disconnect'
    rating_before   INTEGER,
    rating_after    INTEGER,
    opponents       BLOB,               -- Serialized: [{key, name, rating}]
    scr_blob        BLOB NOT NULL       -- Full signed SCR
);

-- Achievements (each individually signed)
CREATE TABLE achievements (
    achievement_id  TEXT NOT NULL,
    game_module     TEXT NOT NULL,
    unlocked_at     INTEGER NOT NULL,
    match_id        BLOB,               -- Which match triggered it (nullable)
    sequence        INTEGER NOT NULL,
    scr_blob        BLOB NOT NULL,
    PRIMARY KEY (achievement_id, game_module)
);

-- Revocation records (tiny — one per record type at most)
CREATE TABLE revocations (
    record_type         INTEGER NOT NULL,
    min_valid_sequence  INTEGER NOT NULL,
    scr_blob            BLOB NOT NULL,
    PRIMARY KEY (record_type)
);

-- Indexes for common queries
CREATE INDEX idx_matches_played_at ON matches(played_at DESC);
CREATE INDEX idx_matches_module ON matches(game_module);
</code></pre>
<p><strong>What the Community Server stores vs. what the player stores:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Data</th><th>Player’s SQLite</th><th>Community Server</th></tr>
</thead>
<tbody>
<tr><td>Player public key</td><td>Yes</td><td>Yes (registered members list)</td></tr>
<tr><td>Current rating</td><td>Yes (signed SCR)</td><td>Optionally cached for matchmaking</td></tr>
<tr><td>Full match history</td><td>Yes (signed SCRs)</td><td>No — only recent results queue for signing</td></tr>
<tr><td>Achievements</td><td>Yes (signed SCRs)</td><td>No</td></tr>
<tr><td>Revocation list</td><td>Yes (signed SCRs)</td><td>Yes (one integer per player per type)</td></tr>
<tr><td>Opponent profiles (D042)</td><td>Yes (local analysis)</td><td>No</td></tr>
<tr><td>Replay files</td><td>Yes (local)</td><td>No</td></tr>
</tbody>
</table>
</div>
<p>The community server’s persistent storage is approximately: <code>(player_count × 32 bytes key) + (player_count × 8 bytes revocation)</code> = ~40 bytes per player. A community of 10,000 players needs ~400KB of server storage. The matchmaking cache adds more, but it’s volatile (RAM only, rebuilt from player connections).</p>
<h3 id="verification-flow"><a class="header" href="#verification-flow">Verification Flow</a></h3>
<p>When a player joins a community game:</p>
<pre><code>┌──────────┐                              ┌──────────────────┐
│  Player  │  1. Connect + present        │  Community       │
│          │     latest rating SCR  ────► │  Server          │
│          │                              │                  │
│          │  2. Verify:                  │  • Ed25519 sig ✓ │
│          │     - signature valid?       │  • sequence ≥    │
│          │     - community_key = ours?  │    min_valid? ✓  │
│          │     - not expired?           │  • not expired ✓ │
│          │     - sequence ≥ min_valid?  │                  │
│          │                              │                  │
│          │  3. Accept into matchmaking  │  Place in pool   │
│          │     with verified rating ◄── │  at rating 1500  │
│          │                              │                  │
│          │  ... match plays out ...     │  Relay hosts game │
│          │                              │                  │
│          │  4. Match ends, relay        │  CertifiedMatch  │
│          │     certifies result   ────► │  Result received │
│          │                              │                  │
│          │  5. Server computes rating   │  RankingProvider  │
│          │     update, signs new SCRs   │  .update_ratings()│
│          │                              │                  │
│          │  6. Receive signed SCRs ◄──  │  New rating SCR  │
│          │     Store in local SQLite    │  + match SCR     │
└──────────┘                              └──────────────────┘
</code></pre>
<p><strong>Verification is O(1):</strong> One Ed25519 signature check (fast — ~15,000 verifications/sec on modern hardware), one integer comparison (sequence ≥ min_valid), one timestamp comparison (expires_at &gt; now). No database lookup required for the common case.</p>
<p><strong>Expired credentials:</strong> If a player’s rating SCR has expired (default 7 days since last server sync), the server reissues a fresh SCR after verifying the player’s identity (challenge-response with the player’s Ed25519 private key). This prevents indefinitely using stale ratings.</p>
<p><strong>New player flow:</strong> First connection to a community → server generates initial rating SCR (Glicko-2 default: 1500 ± 350) → player stores it locally. No pre-existing data needed.</p>
<p><strong>Offline play:</strong> Local games and LAN matches can proceed without a community server. Results are unsigned. When the player reconnects, unsigned match data can optionally be submitted for retroactive signing (server decides whether to honor it — tournament communities may reject unsigned results).</p>
<h3 id="server-side-validation-what-the-community-server-signs-and-why"><a class="header" href="#server-side-validation-what-the-community-server-signs-and-why">Server-Side Validation: What the Community Server Signs and Why</a></h3>
<p>A critical question: why should a community server sign anything? What prevents a player from feeding the server fake data and getting a signed credential for a match they didn’t play or a rating they didn’t earn?</p>
<p><strong>The answer: the community server never signs data it didn’t produce or verify itself.</strong> A player cannot walk up to the server with a claim (“I’m 1800 rated”) and get it signed. Every signed credential is the server’s own output — computed from inputs it trusts. This is analogous to a university signing a diploma: the university doesn’t sign because the student claims they graduated. It signs because it has records of every class the student passed.</p>
<p>Here is the full trust chain for every type of signed credential:</p>
<p><strong>Rating SCRs — the server computes the rating, not the player:</strong></p>
<pre><code>Player claims nothing about their rating. The flow is:

1. Two players connect to the relay for a match.
2. The relay (D007) forwards all orders between players (lockstep).
3. The match ends. Both clients report the outcome to the relay.
   - The relay requires BOTH clients to agree on the outcome
     (winner, loser, draw, disconnection). If they disagree,
     the relay flags the match as disputed and does not certify it.
   - For additional integrity, the relay can optionally run a headless
     sim (same deterministic code — Invariant #1) to independently
     verify the outcome. This is expensive but available for ranked
     matches on well-resourced servers.
4. The relay produces a CertifiedMatchResult:
   - Signed by the relay's own key
   - Contains: player keys, game module, map, duration,
     outcome (who won), order hashes, desync status
5. The community server receives the CertifiedMatchResult.
   - Verifies the relay signature (the community server trusts its
     own relay — they're the same process in the bundled deployment,
     or the operator explicitly configures which relay keys to trust).
6. The community server feeds the CertifiedMatchResult into
   RankingProvider::update_ratings() (D041).
7. The RankingProvider computes new Glicko-2 ratings from the
   match outcome + previous ratings.
8. The community server signs the new rating as an SCR.
9. The signed SCR is returned to both players.

At no point does the player provide rating data to the server.
The server computed the rating. The server signs its own computation.
</code></pre>
<p><strong>Match SCRs — the relay certifies the match happened:</strong></p>
<p>The community server signs a match record SCR containing the match metadata (players, map, outcome, duration). This data comes from the <code>CertifiedMatchResult</code> which the relay produced. The server doesn’t trust the player’s claim about the match — it trusts the relay’s attestation, because the relay was the network intermediary that observed every order in real time.</p>
<p><strong>Achievement SCRs — verification depends on context:</strong></p>
<p>Achievements are more nuanced because they can be earned in different contexts:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Context</th><th>How the server validates</th><th>Trust level</th></tr>
</thead>
<tbody>
<tr><td><strong>Multiplayer match</strong></td><td>Achievement condition cross-referenced with <code>CertifiedMatchResult</code> data. E.g., “Win 50 matches” — server counts its own signed match SCRs for this player. “Win under 5 minutes” — server checks match duration from the relay’s certified result.</td><td><strong>High</strong> — server validates against its own records</td></tr>
<tr><td><strong>Multiplayer in-game</strong></td><td>Relay attests that the achievement trigger fired during a live match (the trigger is part of the deterministic sim, so the relay can verify by running headless). Alternatively, both clients attest the trigger fired (same as match outcome consensus).</td><td><strong>High</strong> — relay-attested or consensus-verified</td></tr>
<tr><td><strong>Single-player (online)</strong></td><td>Player submits a replay file. Community server can fast-forward the replay (deterministic sim) to verify the achievement condition was met. Expensive but possible.</td><td><strong>Medium</strong> — replay-verified, but replay submission is voluntary</td></tr>
<tr><td><strong>Single-player (offline)</strong></td><td>Player claims the achievement with no server involvement. When reconnecting, the claim can be submitted with the replay for retroactive verification. Community policy decides whether to accept: casual communities may accept on trust, competitive communities may require replay proof.</td><td><strong>Low</strong> — self-reported unless replay-backed</td></tr>
</tbody>
</table>
</div>
<p>The community server’s policy for achievement signing is configurable per community:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum AchievementPolicy {
    /// Sign any achievement reported by the client (casual community).
    TrustClient,
    /// Sign immediately, but any player can submit a fraud proof
    /// (replay segment) to challenge. If the challenge verifies,
    /// the achievement SCR is revoked via sequence-based revocation.
    /// Inspired by Optimistic Rollup fraud proofs (Optimism, Arbitrum).
    OptimisticWithChallenge {
        challenge_window_hours: u32,  // default: 72
    },
    /// Sign only achievements backed by a CertifiedMatchResult
    /// or relay attestation (competitive community).
    RequireRelayAttestation,
    /// Sign only if a replay is submitted and server-side verification
    /// confirms the achievement condition (strictest, most expensive).
    RequireReplayVerification,
}
<span class="boring">}</span></code></pre>
<p><strong><code>OptimisticWithChallenge</code> explained:</strong> This policy borrows the core insight from Optimistic Rollups (Optimism, Arbitrum) in the Web3 ecosystem: execute optimistically (assume valid), and only do expensive verification if someone challenges. The server signs the achievement SCR immediately — same speed as <code>TrustClient</code>. But a challenge window opens (default 72 hours, configurable) during which any player who was in the same match can submit a <strong>fraud proof</strong>: a replay segment showing the achievement condition wasn’t met. The community server fast-forwards the replay (deterministic sim — Invariant #1) to verify the challenge. If the challenge is valid, the achievement SCR is revoked via the existing sequence-based revocation mechanism. If no challenge arrives within the window, the achievement is final.</p>
<p>In practice, most achievements are legitimate, so the challenge rate is near zero — the expensive replay verification almost never runs. This gives the speed of <code>TrustClient</code> with the security guarantees of <code>RequireReplayVerification</code>. The pattern works because IC’s deterministic sim means any disputed claim can be objectively verified from the replay — there’s no ambiguity about what happened.</p>
<p>Most communities will use <code>RequireRelayAttestation</code> for multiplayer achievements and <code>TrustClient</code> or <code>OptimisticWithChallenge</code> for single-player achievements. The achievement SCR includes a <code>verification_level</code> field so viewers know how the achievement was validated. SCRs issued under <code>OptimisticWithChallenge</code> carry a <code>verification_level: "optimistic"</code> tag that upgrades to <code>"verified"</code> after the challenge window closes without dispute.</p>
<p><strong>Player registration — identity binding and Sybil resistance:</strong></p>
<p>When a player first connects to a community, the community server must decide: should I register this person? What stops one person from creating 100 accounts to game the rating system?</p>
<p>Registration is the one area where the community server does NOT have a relay to vouch for the data. The player is presenting themselves for the first time. The server’s defenses are layered:</p>
<p><strong>Layer 1 — Cryptographic identity (always):</strong></p>
<p>The player presents their Ed25519 public key. The server challenges them to sign a nonce, proving they hold the private key. This establishes <em>key ownership</em>, not <em>personhood</em>. One person can generate infinite keypairs.</p>
<p><strong>Layer 2 — Rate limiting (always):</strong></p>
<p>The server rate-limits new registrations by IP address (e.g., max 3 new accounts per IP per day). This slows mass account creation without requiring any identity verification.</p>
<p><strong>Layer 3 — Reputation bootstrapping (always):</strong></p>
<p>New accounts start at the default rating (Glicko-2: 1500 ± 350) with zero match history. The high deviation (± 350) means the system is uncertain about their skill — it will adjust rapidly over the first ~20 matches. A smurf creating a new account to grief low-rated players will be rated out of the low bracket within a few matches.</p>
<p>Fresh accounts carry no weight in the trust system (D053): they have no signed credentials, no community memberships, no achievement history. The “Verified only” lobby filter (D053 trust-based filtering) excludes players without established credential history — exactly the accounts a Sybil attacker would create.</p>
<p><strong>Layer 4 — Platform binding (optional, configurable per community):</strong></p>
<p>Community servers can require linking a platform account (Steam, GOG, etc.) at registration. This provides real Sybil resistance — Steam accounts have purchase history, play time, and cost money. The community server doesn’t verify the platform directly (it’s not a Steam partner). Instead, it asks the player’s IC client to provide a platform-signed attestation of account ownership (e.g., a Steam Auth Session Ticket). The server verifies the ticket against the platform’s public API.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum RegistrationPolicy {
    /// Anyone with a valid keypair can register. Lowest friction.
    Open,
    /// Require a valid platform account (Steam, GOG, etc.).
    RequirePlatform(Vec&lt;PlatformId&gt;),
    /// Require a vouching invite from an existing member.
    RequireInvite,
    /// Require solving a challenge (CAPTCHA, email verification, etc.).
    RequireChallenge(ChallengeType),
    /// Combination: e.g., platform OR invite.
    AnyOf(Vec&lt;RegistrationPolicy&gt;),
}
<span class="boring">}</span></code></pre>
<p><strong>Layer 5 — Community-specific policies (optional):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Policy</th><th>Description</th><th>Use case</th></tr>
</thead>
<tbody>
<tr><td><strong>Email verification</strong></td><td>Player provides email, server sends confirmation link. One account per email.</td><td>Medium-security communities</td></tr>
<tr><td><strong>Invite-only</strong></td><td>Existing members generate invite codes. New players must have a code.</td><td>Clan servers, private communities</td></tr>
<tr><td><strong>Vouching</strong></td><td>An existing member in good standing (e.g., 100+ matches, no bans) vouches for the new player. If the new player cheats, the voucher’s reputation is penalized too.</td><td>Competitive leagues</td></tr>
<tr><td><strong>Probation period</strong></td><td>New accounts are marked “probationary” for their first N matches (e.g., 10). Probationary players can’t play ranked, can’t join “Verified only” rooms, and their achievements aren’t signed until probation ends.</td><td>Balances accessibility with fraud prevention</td></tr>
</tbody>
</table>
</div>
<p>These policies are <strong>per-community</strong>. The Official IC Community might use <code>RequirePlatform(Steam) + Probation(10 matches)</code>. A clan server uses <code>RequireInvite</code>. A casual LAN community uses <code>Open</code>. IC doesn’t impose a single registration policy — it provides the building blocks and lets community operators assemble the policy that fits their community’s threat model.</p>
<p><strong>Summary — what the server validates before signing each SCR type:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>SCR Type</th><th>Server validates…</th><th>Trust anchor</th></tr>
</thead>
<tbody>
<tr><td>Rating</td><td>Computed by the server itself from relay-certified match results</td><td>Server’s own computation</td></tr>
<tr><td>Match result</td><td>Relay-signed <code>CertifiedMatchResult</code> (both clients agreed on outcome)</td><td>Relay attestation</td></tr>
<tr><td>Achievement (MP)</td><td>Cross-referenced with match data or relay attestation</td><td>Relay + server records</td></tr>
<tr><td>Achievement (SP)</td><td>Replay verification (if required by community policy)</td><td>Replay determinism</td></tr>
<tr><td>Membership</td><td>Registration policy (platform binding, invite, challenge, etc.)</td><td>Community policy</td></tr>
</tbody>
</table>
</div>
<p>The community server is <strong>not</strong> a rubber stamp. It is a <strong>validation authority</strong> that only signs credentials it can independently verify or that it computed itself. The player never provides the data that gets signed — the data comes from the relay, the ranking algorithm, or the community’s own registration policy.</p>
<h3 id="community-transparency-log"><a class="header" href="#community-transparency-log">Community Transparency Log</a></h3>
<p>The trust model above establishes that the community server only signs credentials it computed or verified. But who watches the server? A malicious or compromised operator could inflate a friend’s rating, issue contradictory records to different players (equivocation), or silently revoke and reissue credentials. Players trust the community, but have no way to <em>audit</em> it.</p>
<p>IC solves this with a <strong>transparency log</strong> — an append-only Merkle tree of every SCR the community server has ever issued. This is the same technique Google deployed at scale for <a href="https://certificate.transparency.dev/">Certificate Transparency</a> (CT, RFC 6962) to prevent certificate authorities from issuing rogue TLS certificates. CT has been mandatory for all publicly-trusted certificates since 2018 and processes billions of entries. The insight transfers directly: a community server is a credential authority, and the same accountability mechanism that works for CAs works here.</p>
<p><strong>How it works:</strong></p>
<ol>
<li>Every time the community server signs an SCR, it appends <code>SHA-256(scr_bytes)</code> as a leaf in an append-only Merkle tree.</li>
<li>The server returns an <strong>inclusion proof</strong> alongside the SCR — a set of O(log N) hashes that proves the SCR exists in the tree at a specific index. The player stores this proof alongside the SCR in their local credential file.</li>
<li>The server publishes its current <strong>Signed Tree Head</strong> (STH) — the root hash + tree size + a timestamp + the server’s signature — at a well-known endpoint (e.g., <code>GET /transparency/sth</code>). This is a single ~128-byte value.</li>
<li><strong>Auditors</strong> (any interested party — players, other community operators, automated monitors) periodically fetch the STH and verify <strong>consistency</strong>: that each new STH is an extension of the previous one (no entries removed or rewritten). This is a single O(log N) consistency proof per check.</li>
<li>Players can verify their personal inclusion proofs against the published STH — confirming their SCRs are in the same tree everyone else sees.</li>
</ol>
<pre><code>                    Merkle Tree (append-only)
                    ┌───────────────────────┐
                    │      Root Hash        │  ← Published as 
                    │   (Signed Tree Head)  │    STH every hour
                    └───────────┬───────────┘
                   ┌────────────┴────────────┐
                   │                         │
              ┌────┴────┐              ┌─────┴────┐
              │  H(0,1) │              │  H(2,3)  │
              └────┬────┘              └────┬─────┘
           ┌───────┴───────┐        ┌──────┴───────┐
           │               │        │              │
       ┌───┴───┐     ┌────┴───┐ ┌──┴───┐    ┌────┴───┐
       │ SCR 0 │     │ SCR 1  │ │ SCR 2│    │ SCR 3  │
       │(alice │     │(bob    │ │(alice│    │(carol  │
       │rating)│     │match)  │ │achv) │    │rating) │
       └───────┘     └────────┘ └──────┘    └────────┘

Inclusion proof for SCR 2: [H(SCR 3), H(0,1)]
→ Verifier recomputes: H(2,3) = H(H(SCR 2) || H(SCR 3)),
   Root = H(H(0,1) || H(2,3)) → must match published STH root.
</code></pre>
<p><strong>What this catches:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Attack</th><th>How the transparency log detects it</th></tr>
</thead>
<tbody>
<tr><td><strong>Rating inflation</strong></td><td>Auditor sees a rating SCR that doesn’t follow from prior match results in the log. The Merkle tree includes every SCR — match SCRs and rating SCRs are interleaved, so the full causal chain is visible.</td></tr>
<tr><td><strong>Equivocation</strong> (different records for different players)</td><td>Two players comparing inclusion proofs against the same STH would find one proof fails — the tree can’t contain two contradictory entries at the same index. An auditor monitoring the log catches this directly.</td></tr>
<tr><td><strong>Silent revocation</strong></td><td>Revocation SCRs are logged like any other record. A player whose credential was revoked can see the revocation in the log and verify it was issued by the server, not fabricated.</td></tr>
<tr><td><strong>History rewriting</strong></td><td>Consistency proofs between successive STHs detect any modification to past entries. The append-only structure means the server can’t edit history without publishing a new root that’s inconsistent with the previous one.</td></tr>
</tbody>
</table>
</div>
<p><strong>What this does NOT provide:</strong></p>
<ul>
<li><strong>Correctness of game outcomes.</strong> The log proves the server issued a particular SCR. It doesn’t prove the underlying match was played fairly — that’s the relay’s job (<code>CertifiedMatchResult</code>). The log is an accountability layer over the signing layer.</li>
<li><strong>Real-time fraud prevention.</strong> A compromised server can still issue a bad SCR. The transparency log ensures the bad SCR is <em>visible</em> — it can’t be quietly slipped in. Detection is retrospective (auditors find it later), not preventive.</li>
</ul>
<p><strong>Operational model:</strong></p>
<ul>
<li><strong>STH publish frequency:</strong> Configurable per community, default hourly. More frequent = faster detection, more bandwidth. Tournament communities might publish every minute during events.</li>
<li><strong>Auditor deployment:</strong> The <code>ic community audit</code> CLI command fetches and verifies consistency of a community’s transparency log. Players can run this manually. Automated monitors (a cron job, a GitHub Action, a community-run service) provide continuous monitoring. IC provides the tooling; communities decide how to deploy it.</li>
<li><strong>Log storage:</strong> The Merkle tree is append-only and grows at ~32 bytes per SCR issued (one hash per leaf). A community that issues 100,000 SCRs has a ~3.2 MB log. This is stored server-side in SQLite alongside the existing community state.</li>
<li><strong>Inclusion proof size:</strong> O(log N) hashes. For 100,000 SCRs, that’s ~17 hashes × 32 bytes = ~544 bytes per proof. Added to the SCR response, this is negligible.</li>
</ul>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Signed Tree Head — published periodically by the community server.
pub struct SignedTreeHead {
    pub tree_size: u64,            // Number of SCRs in the log
    pub root_hash: [u8; 32],       // SHA-256 Merkle root
    pub timestamp: i64,            // Unix seconds
    pub community_key: [u8; 32],   // Ed25519 public key
    pub signature: [u8; 64],       // Ed25519 signature over the above
}

/// Inclusion proof returned alongside each SCR.
pub struct InclusionProof {
    pub leaf_index: u64,           // Position in the tree
    pub tree_size: u64,            // Tree size at time of inclusion
    pub path: Vec&lt;[u8; 32]&gt;,      // O(log N) sibling hashes
}

/// Consistency proof between two tree heads.
pub struct ConsistencyProof {
    pub old_size: u64,
    pub new_size: u64,
    pub path: Vec&lt;[u8; 32]&gt;,      // O(log N) hashes
}
<span class="boring">}</span></code></pre>
<p><strong>Phase:</strong> The transparency log ships with the community server in <strong>Phase 5</strong>. It’s an integral part of community accountability, not an afterthought. The <code>ic community audit</code> CLI command ships in the same phase. Automated monitoring tooling is Phase 6a.</p>
<p><strong>Why this isn’t blockchain:</strong> A transparency log is a cryptographic data structure maintained by a single authority (the community server), auditable by anyone. It provides non-equivocation and append-only guarantees without distributed consensus, proof-of-work, tokens, or peer-to-peer gossip. The server runs it unilaterally; auditors verify it externally. This is orders of magnitude simpler and cheaper than any blockchain — and it’s exactly what’s needed. Certificate Transparency protects the entire web’s TLS infrastructure using this pattern. It works.</p>
<h3 id="matchmaking-design"><a class="header" href="#matchmaking-design">Matchmaking Design</a></h3>
<p>The community server’s matchmaking uses verified ratings from presented SCRs:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Matchmaking pool entry — one per connected player seeking a game.
pub struct MatchmakingEntry {
    pub player_key: Ed25519PublicKey,
    pub verified_rating: PlayerRating,    // From verified SCR
    pub game_module: GameModuleId,        // What game they want to play
    pub preferences: MatchPreferences,    // Map pool, team size, etc.
    pub queue_time: Instant,              // When they started searching
}

/// Server-side matchmaking loop (simplified).
fn matchmaking_tick(pool: &amp;mut Vec&lt;MatchmakingEntry&gt;, provider: &amp;dyn RankingProvider) {
    // Sort by queue time (longest-waiting first)
    pool.sort_by_key(|e| e.queue_time);
    
    for candidate_pair in pool.windows(2) {
        let quality = provider.match_quality(
            &amp;[candidate_pair[0].verified_rating],
            &amp;[candidate_pair[1].verified_rating],
        );
        
        if quality.fairness &gt; FAIRNESS_THRESHOLD || queue_time_exceeded(candidate_pair) {
            // Accept match — create lobby
            create_lobby(candidate_pair);
        }
    }
}
<span class="boring">}</span></code></pre>
<p><strong>Matchmaking widens over time:</strong> Initial search window is tight (±100 rating). After 30 seconds, widens to ±200. After 60 seconds, ±400. After 120 seconds, accepts any match. This prevents indefinite queues for players at rating extremes.</p>
<p><strong>Team games:</strong> For 2v2+ matchmaking, the server balances team average ratings. Each player’s SCR is individually verified. Team rating = average of individual Glicko-2 ratings.</p>
<h3 id="lobby--room-discovery"><a class="header" href="#lobby--room-discovery">Lobby &amp; Room Discovery</a></h3>
<p>Matchmaking (above) handles competitive/ranked play. But most RTS games are casual — “join my friend’s game,” “let’s play a LAN match,” “come watch my stream and play.” These need a room-based lobby with low-friction discovery. IC provides five discovery tiers, from zero-infrastructure to full game browser. Every tier works on every platform (desktop, browser, mobile — Invariant #10).</p>
<p><strong>Tier 0 — Direct Connect (IP:port)</strong></p>
<p>Always available, zero external dependency. Type an IP address and port, connect. Works on LAN, works over internet with port forwarding. This is the escape hatch — if every server is down, two players with IP addresses can still play.</p>
<pre><code>ic play connect 192.168.1.42:7400
</code></pre>
<p>For P2P lockstep (no relay), the host IS the connection target. For relay-hosted games, this is the relay’s address. No discovery mechanism needed — you already know where to go.</p>
<p><strong>Tier 1 — Room Codes (Among Us pattern, decentralized)</strong></p>
<p>When a host creates a room on any relay or community server, the server assigns a short alphanumeric code. Share it verbally, paste it in Discord, text it to a friend.</p>
<pre><code>Room code: TKR-4N7
</code></pre>
<p><strong>Code format:</strong></p>
<ul>
<li>6 characters from an unambiguous set: <code>23456789ABCDEFGHJKMNPQRSTUVWXYZ</code> (30 chars, excludes 0/O, 1/I/L)</li>
<li>Displayed as <code>XXX-XXX</code> for readability</li>
<li>30^6 ≈ 729 million combinations — more than enough</li>
<li>Case-insensitive input (the UI uppercases automatically)</li>
<li>Codes are ephemeral — exist only in server memory, expire when the room closes + 5-minute grace</li>
</ul>
<p><strong>Resolution:</strong> Player enters the code in-game. The client queries all configured community servers in parallel (typically 1–3 HTTP requests). Whichever server recognizes the code responds with connection info (relay address + room ID + required resources). No central “code directory” — every community server manages its own code namespace. Collision across communities is fine because clients verify the code against the responding server.</p>
<pre><code>ic play join TKR-4N7
</code></pre>
<p><strong>Why Among Us-style codes?</strong> Among Us popularized this pattern because it works for exactly the scenario IC targets: you’re in a voice call, someone says “join TKR-4N7,” everyone types it in 3 seconds. No URLs, no IP addresses, no friend lists. The friction is nearly zero. For an RTS with 2–8 players, this is the sweet spot.</p>
<p><strong>Tier 2 — QR Code</strong></p>
<p>The host’s client generates a QR code that encodes a deep link URI:</p>
<pre><code>ironcurtain://join/community.example.com/TKR-4N7
</code></pre>
<p>Scanning the QR code opens the IC client (or the browser version on mobile) and auto-joins the room. Perfect for:</p>
<ul>
<li><strong>LAN parties:</strong> Display QR on the host’s screen. Everyone scans with their phone/tablet to join via browser client.</li>
<li><strong>Couch co-op:</strong> Scan from a phone to open the WASM browser client on a second device.</li>
<li><strong>Streaming:</strong> Overlay QR on stream → viewers scan to join or spectate.</li>
<li><strong>In-person events / tournaments:</strong> Print QR on table tents.</li>
</ul>
<p>The QR code is regenerated if the room code changes (e.g., room migrates to a different relay). The deep link URI scheme (<code>ironcurtain://</code>) is registered on desktop; on platforms without scheme registration, the QR can encode an HTTPS URL (<code>https://play.ironcurtain.gg/join/TKR-4N7</code>) that redirects to the client or browser version.</p>
<p><strong>Tier 3 — Game Browser</strong></p>
<p>Community servers publish their active rooms to a room listing API. The in-game browser aggregates listings from all configured communities — the same federation model as Workshop source aggregation.</p>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│  Game Browser                                    [Refresh]  │
├──────────────┬──────┬─────────┬────────┬──────┬─────────────┤
│ Room Name    │ Host │ Players │ Map    │ Ping │ Mods        │
├──────────────┼──────┼─────────┼────────┼──────┼─────────────┤
│ Casual 1v1   │ cmdr │ 1/2     │ Arena  │ 23ms │ none        │
│ HD Mod Game  │ alice│ 3/4     │ Europe │ 45ms │ hd-pack 2.1 │
│ Newbies Only │ bob  │ 2/6     │ Desert │ 67ms │ none        │
└──────────────┴──────┴─────────┴────────┴──────┴─────────────┘
</code></pre>
<p>Filter by: game module (RA/TD), map, player count, ping, mods required, community, password protected. Sort by any column. Auto-refresh on configurable interval.</p>
<p>This is the traditional server browser experience (OpenRA has this, Quake had this, every classic RTS had this). It coexists with room codes — a room visible in the browser also has a room code.</p>
<p><strong>Tier 4 — Matchmaking Queue (D052)</strong></p>
<p>Already designed above. Player enters a queue; community server matches by rating. This creates rooms automatically — the player never sees a room code or browser.</p>
<p><strong>Tier 5 — Deep Links / Invites</strong></p>
<p>The <code>ironcurtain://join/...</code> URI scheme works as a clickable link anywhere that supports URI schemes:</p>
<ul>
<li>Discord: paste <code>ironcurtain://join/official.ironcurtain.gg/TKR-4N7</code> → click to join</li>
<li>Browser: HTTPS fallback URL redirects to client or opens browser WASM version</li>
<li>Steam: Steam rich presence integration → “Join Game” button on friend’s profile</li>
<li>In-game friends list (if implemented): one-click invite sends a deep link</li>
</ul>
<p><strong>Discovery summary:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Tier</th><th>Mechanism</th><th>Requires Server?</th><th>Best For</th><th>Friction</th></tr>
</thead>
<tbody>
<tr><td>0</td><td>Direct IP:port</td><td>No</td><td>LAN, development, fallback</td><td>High (must know IP)</td></tr>
<tr><td>1</td><td>Room codes</td><td>Yes (any relay/community)</td><td>Friends, voice chat, casual</td><td>Very low (6 chars)</td></tr>
<tr><td>2</td><td>QR code</td><td>Yes (same as room code)</td><td>LAN parties, streaming, mobile</td><td>Near zero (scan)</td></tr>
<tr><td>3</td><td>Game browser</td><td>Yes (community servers)</td><td>Finding public games</td><td>Low (browse + click)</td></tr>
<tr><td>4</td><td>Matchmaking</td><td>Yes (community server)</td><td>Competitive/ranked</td><td>Zero (press “Play”)</td></tr>
<tr><td>5</td><td>Deep links</td><td>Yes (same as room code)</td><td>Discord, web, social</td><td>Near zero (click)</td></tr>
</tbody>
</table>
</div>
<p>Tiers 0–2 work with a single self-hosted relay (a $5 VPS or even localhost). No official infrastructure required. Tiers 3–4 require community servers. Tier 5 requires URI scheme registration (desktop) or an HTTPS redirect service (browser).</p>
<h3 id="lobby-communication"><a class="header" href="#lobby-communication">Lobby Communication</a></h3>
<p>Once players are in a room, they need to communicate — coordinate strategy before the game, socialize, discuss map picks, or just talk. IC provides text chat, voice chat, and visible player identity in every lobby.</p>
<p><strong>Text Chat</strong></p>
<p>All lobby text messages are routed through the relay server (or host in P2P mode) — the same path as game orders. This keeps the trust model consistent: the relay timestamps and sequences messages, making chat moderation actions deterministic and auditable.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Lobby chat message — part of the room protocol, not the sim protocol.
/// Routed through the relay alongside PlayerOrders but on a separate
/// logical channel (not processed by ic-sim).
pub struct LobbyMessage {
    pub sender: PlayerId,
    pub channel: ChatChannel,
    pub content: String,         // UTF-8, max 500 bytes
    pub timestamp: u64,          // relay-assigned, not client-claimed
}

pub enum ChatChannel {
    All,                         // Everyone in the room sees it
    Team(TeamId),                // Team-only (pre-game team selection)
    Whisper(PlayerId),           // Private message to one player
    System,                      // Join/leave/kick notifications (server-generated)
}
<span class="boring">}</span></code></pre>
<p><strong>Chat features:</strong></p>
<ul>
<li><strong>Rate limiting:</strong> Max 5 messages per 3 seconds per player. Prevents spam flooding.</li>
<li><strong>Message length:</strong> Max 500 bytes UTF-8. Long enough for tactical callouts, short enough to prevent wall-of-text abuse.</li>
<li><strong>Host moderation:</strong> Room host can mute individual players (host sends a <code>MutePlayer</code> command; relay enforces). Muted players’ messages are silently dropped by the relay — other clients never receive them.</li>
<li><strong>Persistent for room lifetime:</strong> Chat history is available to newly joining players (last 50 messages). When the room closes, chat is discarded — no server-side chat logging.</li>
<li><strong>In-game chat:</strong> During gameplay, the same chat system operates. <code>All</code> channel becomes <code>Spectator</code> for observers. <code>Team</code> channel carries strategic communication. A configurable <code>AllChat</code> toggle (default: disabled in ranked) controls whether opponents can see your messages during a match.</li>
<li><strong>Links and formatting:</strong> URLs are clickable (opens external browser). No rich text — plain text only. This prevents injection attacks and keeps the UI simple.</li>
<li><strong>Emoji:</strong> Standard Unicode emoji are rendered natively. No custom emoji system — keep it simple.</li>
<li><strong>Block list:</strong> Players can block others locally. Blocked players’ messages are filtered client-side (not server-enforced — the relay doesn’t need to know your block list). Block persists across sessions in local SQLite (D034).</li>
</ul>
<p><strong>In-game chat UI:</strong></p>
<pre><code>┌──────────────────────────────────────────────┐
│ [All] [Team]                          [Hide] │
├──────────────────────────────────────────────┤
│ [SYS] alice joined the room                  │
│ [cmdr] gg ready when you are                 │
│ [alice] let's go desert map?                 │
│ [bob] 👍                                      │
│                                              │
├──────────────────────────────────────────────┤
│ [Type message...]                    [Send]  │
└──────────────────────────────────────────────┘
</code></pre>
<p>The chat panel is collapsible (hotkey: Enter to open, Escape to close — standard RTS convention). During gameplay, it overlays transparently so it doesn’t obscure the battlefield.</p>
<p><strong>Voice Chat</strong></p>
<p>IC includes built-in voice communication using relay-forwarded Opus audio. Voice data never touches the sim — it’s a purely transport-layer feature with zero determinism impact.</p>
<p><strong>Architecture:</strong></p>
<pre><code>┌────────┐              ┌─────────────┐              ┌────────┐
│Player A│─── Opus ────►│ Room Server │─── Opus ────►│Player B│
│        │◄── Opus ─────│  (D052)     │◄── Opus ─────│        │
└────────┘              │             │              └────────┘
                        │  Stateless  │
┌────────┐              │  forwarding │
│Player C│─── Opus ────►│             │
│        │◄── Opus ─────│             │
└────────┘              └─────────────┘
</code></pre>
<ul>
<li><strong>Relay-forwarded audio:</strong> Voice data flows through the room server (D052), maintaining IP privacy — the same principle as D059’s in-game voice design. The room server performs stateless Opus packet forwarding (copies bytes without decoding). This prevents IP exposure, which is a known harassment vector even in the pre-game lobby phase.</li>
<li><strong>Lobby → game transition:</strong> When the match starts and clients connect to the game relay, voice seamlessly transitions from the room server to the game relay. No reconnection is needed — the relay assumes voice forwarding from the room server’s role. If the room server and game relay are the same process (common for community servers), the transition is a no-op.</li>
<li><strong>Push-to-talk (default):</strong> RTS players need both hands on mouse/keyboard during games. Push-to-talk avoids accidental transmission of keyboard clatter, breathing, and background noise. Default keybind: <code>V</code>. Voice activation mode available in settings for players who prefer it.</li>
<li><strong>Per-player volume:</strong> Each player’s voice volume is adjustable independently (right-click their name in the player list → volume slider). Mute individual players with one click.</li>
<li><strong>Voice channels:</strong> Mirror text chat channels — All, Team. During gameplay, voice defaults to Team-only to prevent leaking strategy to opponents. Spectators have their own voice channel.</li>
<li><strong>Codec:</strong> Opus (standard WebRTC codec). 32 kbps mono is sufficient for clear voice in a game context. Total bandwidth for a full 8-player lobby: ~224 kbps (7 incoming streams × 32 kbps) — negligible compared to game traffic.</li>
<li><strong>Browser (WASM) support:</strong> Browser builds use WebRTC via <code>str0m</code> for voice (see D059 § VoiceTransport). Desktop builds send Opus packets directly on the <code>Transport</code> connection’s <code>MessageLane::Voice</code>.</li>
</ul>
<p><strong>Voice UI indicators:</strong></p>
<pre><code>┌────────────────────────┐
│ Players:               │
│  🔊 cmdr (host)   1800 │  ← speaking indicator
│  🔇 alice         1650 │  ← muted by self
│  🎤 bob           1520 │  ← has mic, not speaking
│  📵 carol         ---- │  ← voice disabled
└────────────────────────┘
</code></pre>
<p>Speaking indicators appear next to player names in the lobby and during gameplay (small icon on the player’s color bar in the sidebar). This lets players see who’s talking at a glance.</p>
<p><strong>Privacy and safety:</strong></p>
<ul>
<li>Voice is opt-in. Players can disable voice entirely in settings. The client never activates the microphone without explicit user action (push-to-talk press or voice activation toggle).</li>
<li>No voice recording by the relay or community server during normal operation. Voice streams are ephemeral in the relay pipeline. (Note: D059 adds opt-in voice-in-replay where consenting players’ voice is captured client-side during gameplay — this is client-local recording with consent, not relay-side recording.)</li>
<li>Abusive voice users can be muted by any player (locally) or by the host (server-enforced kick from voice channel).</li>
<li>Ranked/competitive rooms can enforce “no voice” or “team-voice-only” policies.</li>
</ul>
<p><strong>When external voice is better:</strong> IC’s built-in voice is designed for casual lobbies, LAN parties, and pickup games where players don’t have a pre-existing Discord/TeamSpeak. Competitive teams will continue using external voice (lower latency, better quality, persistent channels). IC doesn’t try to replace Discord — it provides a frictionless default for when Discord isn’t set up.</p>
<p><strong>Player Identity in Lobby</strong></p>
<p>Every player in a lobby is visible with their profile identity — not just a text name. The lobby player list shows:</p>
<ul>
<li><strong>Avatar:</strong> Small profile image (32×32 in list, 64×64 on hover/click). Sourced from the player’s profile (see D053).</li>
<li><strong>Display name:</strong> The player’s chosen name. If the player has a community-verified identity (D052 SCR), a small badge appears next to the name indicating which community verified them.</li>
<li><strong>Rating badge:</strong> If the room is on a community server, the player’s verified rating for the relevant game module is shown (from their presented SCR). Unranked players show “—”.</li>
<li><strong>Presence indicators:</strong> Microphone status, ready state, download progress (if syncing resources).</li>
</ul>
<p>Clicking a player’s name in the lobby opens a <strong>profile card</strong> — a compact view of their player profile (D053) showing avatar, bio, recent achievements, win rate, and community memberships. This lets players gauge each other before a match without leaving the lobby.</p>
<p><strong>Updated lobby UI with communication:</strong></p>
<pre><code>┌──────────────────────────────────────────────────────────────────────┐
│  Room: TKR-4N7  —  Map: Desert Arena  —  RA1 Classic Balance       │
├──────────────────────────────────┬───────────────────────────────────┤
│  Players                         │  Chat [All ▾]                    │
│  ┌──┐ 🔊 cmdr (host)   ⭐ 1800  │  [SYS] Room created              │
│  │🎖│ Ready                      │  [cmdr] hey all, gg              │
│  └──┘                            │  [alice] glhf!                   │
│  ┌──┐ 🎤 alice         ⭐ 1650  │  [SYS] bob joined                │
│  │👤│ Ready                      │  [bob] yo what map?              │
│  └──┘                            │  [cmdr] desert arena, classic    │
│  ┌──┐ 🎤 bob           ⭐ 1520  │  [bob] 👍                         │
│  │👤│ ⬇️ Syncing 67%             │                                  │
│  └──┘                            │                                  │
│  ┌──┐ 📵 carol          ----    │                                  │
│  │👤│ Connecting...              ├───────────────────────────────────┤
│  └──┘                            │ [Type message...]        [Send]  │
├──────────────────────────────────┴───────────────────────────────────┤
│  Mods: alice/hd-sprites@2.0, bob/desert-map@1.1                     │
│  [Settings]  [Invite]  [Start Game] (waiting for all players)       │
└──────────────────────────────────────────────────────────────────────┘
</code></pre>
<p>The left panel shows players with avatars (small square icons), voice status, community rating badges, and ready state. The right panel is the chat. The layout adapts to screen size (D032 responsive UI) — on narrow screens, chat slides below the player list.</p>
<p><strong>Phase:</strong> Text chat ships with lobby implementation (Phase 5). Voice chat Phase 5–6a. Profile images in lobby require D053 (Player Profile, Phase 3–5).</p>
<h3 id="in-lobby-p2p-resource-sharing"><a class="header" href="#in-lobby-p2p-resource-sharing">In-Lobby P2P Resource Sharing</a></h3>
<p>When a player joins a room that requires resources (mods, maps, resource packs) they don’t have locally, the lobby becomes a P2P swarm for those resources. The relay server (or host in P2P mode) acts as the tracker. This is the existing D049 P2P protocol scoped to a single lobby’s resource list.</p>
<p><strong>Flow:</strong></p>
<pre><code>Host creates room
  → declares required: [alice/hd-sprites@2.0, bob/desert-map@1.1]
  → host seeds both resources

Player joins room
  → receives resource list with SHA-256 from Workshop index
  → checks local cache: has alice/hd-sprites@2.0 ✓, missing bob/desert-map@1.1 ✗

  → Step 1: Verify resource exists in a known Workshop source
    Client fetches manifest for bob/desert-map@1.1 from Workshop index
    (git-index HTTP fetch or Workshop server API)
    Gets: SHA-256, manifest_hash, size, dependencies
    If resource NOT in any configured Workshop source → REFUSE download
    (prevents arbitrary file transfer — Workshop index is the trust anchor)

  → Step 2: Join lobby resource swarm
    Relay/host announces available peers for bob/desert-map@1.1
    Download via BitTorrent protocol from:
      Priority 1: Other lobby players who already have it (lowest latency)
      Priority 2: Workshop P2P swarm (general seeders)
      Priority 3: Workshop HTTP fallback (CDN/GitHub Releases)

  → Step 3: Verify
    SHA-256 of downloaded .icpkg matches Workshop index manifest ✓
    manifest_hash of internal manifest.yaml matches index ✓
    (Same verification chain as regular Workshop install — see V20)

  → Step 4: Report ready
    Client signals lobby: "all resources verified, ready to play"

All players ready → countdown → game starts
</code></pre>
<p><strong>Lobby UI during resource sync:</strong></p>
<pre><code>┌────────────────────────────────────────────────┐
│  Room: TKR-4N7  —  Waiting for players...      │
├────────────────────────────────────────────────┤
│  ✅ cmdr (host)     Ready                       │
│  ✅ alice           Ready                        │
│  ⬇️ bob             Downloading 2/3 resources   │
│     └─ bob/desert-map@1.1  [████░░░░] 67%  P2P │
│     └─ alice/hd-dialog@1.0 [██████░░] 82%  P2P │
│  ⏳ carol           Connecting...                │
├────────────────────────────────────────────────┤
│  Required: alice/hd-sprites@2.0, bob/desert-    │
│  map@1.1, alice/hd-dialog@1.0                   │
│  [Start Game]  (waiting for all players)        │
└────────────────────────────────────────────────┘
</code></pre>
<p><strong>The host-as-tracker model:</strong></p>
<p>For relay-hosted games (the default), the relay IS the tracker — it already manages all connections in the room. It maintains an in-memory peer table: which players have which resources. When a new player joins and needs resources, the relay tells them which peers can seed. This is trivial — a <code>HashMap&lt;ResourceId, Vec&lt;PeerId&gt;&gt;</code> that lives only as long as the room exists.</p>
<p>For P2P games (no relay, LAN): the host’s game client runs a minimal tracker. Same data structure, same protocol, just embedded in the game client instead of a separate relay process. The host was already acting as the game’s connection coordinator — adding resource tracking is marginal.</p>
<p><strong>Security model — preventing malicious content transfer:</strong></p>
<p>The critical constraint: <strong>only Workshop-published resources can be shared in a lobby.</strong> The lobby declares resources by their Workshop identity (<code>publisher/package@version</code>), not by arbitrary file paths. The security chain:</p>
<ol>
<li><strong>Workshop index is the trust anchor.</strong> Every resource has a SHA-256 and <code>manifest_hash</code> recorded in a Workshop index (git-index with signed commits or Workshop server API). The client must be able to look up the resource in a known Workshop source before downloading.</li>
<li><strong>Content verification is mandatory.</strong> After download, the client verifies SHA-256 (full package) and <code>manifest_hash</code> (internal manifest) against the Workshop index — not against the host’s claim. Even if every other player in the lobby is malicious, a single honest Workshop index protects the downloading player.</li>
<li><strong>Unknown resources are refused.</strong> If a room requires <code>evil/malware@1.0</code> and that doesn’t exist in any Workshop source the player has configured, the client refuses to download and warns: “Resource not found in any configured Workshop source. Add the community’s Workshop source or leave the lobby.”</li>
<li><strong>No arbitrary file transfer.</strong> The P2P protocol only transfers <code>.icpkg</code> archives that match Workshop-published checksums. There is no mechanism for peers to push arbitrary files — the protocol is pull-only and content-addressed.</li>
<li><strong>Mod sandbox limits blast radius.</strong> Even a resource that passes all integrity checks is still subject to WASM capability sandbox (D005), Lua execution limits (D004), and YAML schema validation (D003). A malicious mod that sneaks past Workshop review can at most affect gameplay within its declared capabilities.</li>
<li><strong>Post-install scanning (Phase 6a+).</strong> When a resource is auto-downloaded in a lobby, the client checks for Workshop security advisories (V18) before loading it. If the resource version has a known advisory → warn the player before proceeding.</li>
</ol>
<p><strong>What about custom maps not on the Workshop?</strong></p>
<p>For early phases (before Workshop exists) or for truly private content: the host can share a map file by embedding it in the room’s initial payload (small maps are &lt;1MB). The receiving client:</p>
<ul>
<li>Must explicitly accept (“Host wants to share a custom map not published on Workshop. Accept? [Yes/No]”)</li>
<li>The file is verified for format validity (must parse as a valid IC map) but has no Workshop-grade integrity chain</li>
<li>These maps are quarantined (loaded but not added to the player’s Workshop cache)</li>
<li>This is the “developer/testing” escape hatch — not the normal flow</li>
</ul>
<p>This escape hatch is disabled by default in competitive/ranked rooms (community servers can enforce “Workshop-only” policies).</p>
<p><strong>Bandwidth and timing:</strong></p>
<p>The lobby applies D049’s <code>lobby-urgent</code> priority tier — auto-downloads preempt background Workshop activity and get full available bandwidth. Combined with the lobby swarm (host + ready players all seeding), typical resource downloads complete in seconds for common mods (&lt;50MB). The download timer can be configured per-community: tournament servers might set a 60-second download window, casual rooms wait indefinitely.</p>
<p>If a player’s download is too slow (configurable threshold, e.g., 5 minutes), the lobby UI offers: “Download taking too long. [Keep waiting] [Download in background and spectate] [Leave lobby]”.</p>
<p><strong>Local resource lifecycle:</strong> Resources downloaded via lobby P2P are tagged as <strong>transient</strong> (not pinned). They remain fully functional but auto-clean after <code>transient_ttl_days</code> (default 30 days) of non-use. After the session, a post-match toast offers: “[Pin] [Auto-clean in 30 days] [Remove now]”. Frequently-used lobby resources (3+ sessions) are automatically promoted to pinned. See D030 § “Local Resource Management” for the full lifecycle.</p>
<p>Default: <strong>Glicko-2</strong> (already specified in D041 as <code>Glicko2Provider</code>).</p>
<p>Why Glicko-2 over alternatives:</p>
<ul>
<li><strong>Rating deviation</strong> naturally models uncertainty. New players have wide confidence intervals (RD ~350); experienced players have narrow ones (RD ~50). Matchmaking can use RD to avoid matching a highly uncertain new player against a stable veteran.</li>
<li><strong>Inactivity decay:</strong> RD increases over time without play. A player who hasn’t played in months is correctly modeled as “uncertain” — their first few games back will move their rating significantly, then stabilize.</li>
<li><strong>Open and unpatented.</strong> TrueSkill (Microsoft) and TrueSkill 2 are patented. Glicko-2 is published freely by Mark Glickman.</li>
<li><strong>Lichess uses it.</strong> Proven at scale in a competitive community with similar dynamics (skill-based 1v1 with occasional team play).</li>
<li><strong>RankingProvider trait (D041)</strong> makes this swappable. Communities that want Elo, or a league/tier system, or a custom algorithm, implement the trait.</li>
</ul>
<p><strong>Rating storage in SCR payload</strong> (record_type = 0x01, rating snapshot):</p>
<pre><code>rating payload:
  game_module_len   1 byte
  game_module       variable (UTF-8)
  algorithm_id_len  1 byte
  algorithm_id      variable (UTF-8, e.g., "glicko2")
  rating            8 bytes (i64 LE, fixed-point × 1000)
  deviation         8 bytes (i64 LE, fixed-point × 1000)
  volatility        8 bytes (i64 LE, fixed-point × 1000000)
  games_played      4 bytes (u32 LE)
  wins              4 bytes (u32 LE)
  losses            4 bytes (u32 LE)
  draws             4 bytes (u32 LE)
  streak_current    2 bytes (i16 LE, positive = win streak)
  rank_position     4 bytes (u32 LE, 0 = unranked)
  percentile        2 bytes (u16 LE, 0-1000 = 0.0%-100.0%)
</code></pre>
<h3 id="key-lifecycle"><a class="header" href="#key-lifecycle">Key Lifecycle</a></h3>
<h4 id="key-identification"><a class="header" href="#key-identification">Key Identification</a></h4>
<p>Every Ed25519 public key — player or community — has a <strong>key fingerprint</strong> for human reference:</p>
<pre><code>Fingerprint = SHA-256(public_key)[0..8], displayed as 16 hex chars
Example:     3f7a2b91e4d08c56
</code></pre>
<p>The fingerprint is a display convenience. Internally, the full 32-byte public key is the canonical identifier (stored in SCRs, credential tables, etc.). Fingerprints appear in the UI for key verification dialogs, rotation notices, and trust management screens.</p>
<p>Why 8 bytes (64 bits) instead of GPG-style 4-byte short IDs? GPG short key IDs (32 bits) famously suffered birthday-attack collisions — an attacker could generate a key with the same 4-byte fingerprint in minutes. 8 bytes requires ~2^32 key generations to find a collision — far beyond practical for the hobbyist community operators IC targets. For cryptographic operations, the full 32-byte key is always used; the fingerprint is only for human eyeball verification.</p>
<h4 id="player-keys"><a class="header" href="#player-keys">Player Keys</a></h4>
<ul>
<li>Generated on first community join. Ed25519 keypair stored encrypted (AEAD with user passphrase) in the player’s local config.</li>
<li>The same keypair CAN be reused across communities (simpler) or the player CAN generate per-community keypairs (more private). Player’s choice in settings.</li>
<li><strong>Key recovery via mnemonic seed (D061):</strong> The keypair is derived from a 24-word BIP-39 mnemonic phrase. If the player saved the phrase, they can regenerate the identical keypair on any machine via <code>ic identity recover</code>. Existing SCRs validate automatically — the recovered key matches the old public key.</li>
<li><strong>Key loss without mnemonic:</strong> If the player lost both the keypair AND the recovery phrase, they re-register with the community (new key = new player with fresh rating). This is intentional — unrecoverable key loss resets reputation, preventing key selling.</li>
<li><strong>Key export:</strong> <code>ic player export-key --encrypted</code> exports the keypair as an encrypted file (AEAD, user passphrase). The mnemonic seed phrase is the preferred backup mechanism; encrypted key export is an alternative for users who prefer file-based backup.</li>
</ul>
<h4 id="community-keys-two-key-architecture"><a class="header" href="#community-keys-two-key-architecture">Community Keys: Two-Key Architecture</a></h4>
<p>Every community server has <strong>two</strong> Ed25519 keypairs, inspired by DNSSEC’s Zone Signing Key (ZSK) / Key Signing Key (KSK) pattern:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Key</th><th>Purpose</th><th>Storage</th><th>Usage Frequency</th></tr>
</thead>
<tbody>
<tr><td><strong>Signing Key (SK)</strong></td><td>Signs all day-to-day SCRs (ratings, matches, achievements)</td><td>On the server, encrypted at rest</td><td>Every match result, every rating update</td></tr>
<tr><td><strong>Recovery Key (RK)</strong></td><td>Signs key rotation records and emergency revocations only</td><td><strong>Offline</strong> — operator saves it, never stored on the server</td><td>Rare: only for key rotation or compromise recovery</td></tr>
</tbody>
</table>
</div>
<p><strong>Why two keys?</strong> A single-key system has a catastrophic failure mode: if the key is lost, the community dies (no way to rotate to a new key). If the key is stolen, the attacker can forge credentials <em>and</em> the operator can’t prove they’re the real owner (both parties have the same key). The two-key pattern solves both:</p>
<ul>
<li><strong>Key loss:</strong> Operator uses the RK (stored offline) to sign a rotation to a new SK. Community survives.</li>
<li><strong>Key theft:</strong> Operator uses the RK to revoke the compromised SK and rotate to a new one. Attacker has the SK but not the RK, so they can’t forge rotation records. Community recovers.</li>
<li><strong>Both lost:</strong> Nuclear option — community is dead, players re-register. But losing both requires extraordinary negligence (the RK was specifically generated for offline backup).</li>
</ul>
<p>This is the same pattern used by DNSSEC (ZSK + KSK), hardware security modules (operational key + root key), cryptocurrency validators (signing key + withdrawal key), and Certificate Authorities (intermediate + root certificates).</p>
<p><strong>Key generation flow:</strong></p>
<pre><code>$ ic community init --name "Clan Wolfpack" --url "https://wolfpack.example.com"

  Generating community Signing Key (SK)...
  SK fingerprint: 3f7a2b91e4d08c56
  SK stored encrypted at: /etc/ironcurtain/server/signing-key.enc

  Generating community Recovery Key (RK)...
  RK fingerprint: 9c4d17e3f28a6b05

  ╔══════════════════════════════════════════════════════════════╗
  ║  SAVE YOUR RECOVERY KEY NOW                                 ║
  ║                                                             ║
  ║  This key will NOT be stored on the server.                 ║
  ║  You need it to recover if your signing key is lost or      ║
  ║  stolen. Without it, a lost key means your community dies.  ║
  ║                                                             ║
  ║  Recovery Key (base64):                                     ║
  ║  rk-ed25519:MC4CAQAwBQYDK2VwBCIEIGXu5Mw8N3...             ║
  ║                                                             ║
  ║  Options:                                                   ║
  ║    1. Copy to clipboard                                     ║
  ║    2. Save to encrypted file                                ║
  ║    3. Display QR code (for paper backup)                    ║
  ║                                                             ║
  ║  Store it in a password manager, a safe, or a USB drive     ║
  ║  in a drawer. Treat it like a master password.              ║
  ╚══════════════════════════════════════════════════════════════╝

  [1/2/3/I saved it, continue]: 
</code></pre>
<p>The RK private key is shown exactly once during <code>ic community init</code>. The server stores only the RK’s <em>public</em> key (so clients can verify rotation records signed by the RK). The RK private key is never written to disk by the server.</p>
<p><strong>Key backup and retrieval:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Operation</th><th>Command</th><th>What It Does</th></tr>
</thead>
<tbody>
<tr><td>Export SK (encrypted)</td><td><code>ic community export-signing-key</code></td><td>Exports the SK private key in an encrypted file (AEAD, operator passphrase). For backup or server migration.</td></tr>
<tr><td>Import SK</td><td><code>ic community import-signing-key &lt;file&gt;</code></td><td>Restores the SK from an encrypted export. For server migration or disaster recovery.</td></tr>
<tr><td>Rotate SK (voluntary)</td><td><code>ic community rotate-signing-key</code></td><td>Generates a new SK, signs a rotation record with the old SK: “old_SK → new_SK”. Graceful, no disruption.</td></tr>
<tr><td>Emergency rotation (SK lost/stolen)</td><td><code>ic community emergency-rotate --recovery-key &lt;rk&gt;</code></td><td>Generates a new SK, signs a rotation record with the RK: “RK revokes old_SK, authorizes new_SK”. The only operation that uses the RK.</td></tr>
<tr><td>Regenerate RK</td><td><code>ic community regenerate-recovery-key --recovery-key &lt;old_rk&gt;</code></td><td>Generates a new RK, signs a rotation record: “old_RK → new_RK”. The old RK authorizes the new one.</td></tr>
</tbody>
</table>
</div>
<h4 id="key-rotation-voluntary"><a class="header" href="#key-rotation-voluntary">Key Rotation (Voluntary)</a></h4>
<p>Good security hygiene is to rotate signing keys periodically — not because Ed25519 keys weaken over time, but to limit the blast radius of an undetected compromise. IC makes voluntary rotation seamless:</p>
<ol>
<li>Operator runs <code>ic community rotate-signing-key</code>.</li>
<li>Server generates a new SK keypair.</li>
<li>Server signs a <strong>key rotation record</strong> with the OLD SK:</li>
</ol>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct KeyRotationRecord {
    pub record_type: u8,          // 0x05 = key rotation
    pub old_key: [u8; 32],        // SK being retired
    pub new_key: [u8; 32],        // replacement SK
    pub signed_by: KeyRole,       // SK (voluntary) or RK (emergency)
    pub reason: RotationReason,
    pub effective_at: i64,        // Unix timestamp
    pub old_key_valid_until: i64, // grace period end (default: +30 days)
    pub signature: [u8; 64],      // signed by old_key or recovery_key
}

pub enum KeyRole {
    SigningKey,    // voluntary rotation — signed by old SK
    RecoveryKey,   // emergency rotation — signed by RK
}

pub enum RotationReason {
    Scheduled,         // periodic rotation (good hygiene)
    ServerMigration,   // moving to new hardware
    Compromise,        // SK compromised, emergency revocation
    PrecautionaryRevoke, // SK might be compromised, revoking as precaution
}
<span class="boring">}</span></code></pre>
<ol start="4">
<li>Server starts signing new SCRs with the new SK immediately.</li>
<li>Clients encountering the rotation record verify it (against the old SK for voluntary rotation, or against the RK for emergency rotation).</li>
<li>Clients update their stored community key.</li>
<li><strong>Grace period (30 days default):</strong> During the grace period, clients accept SCRs signed by EITHER the old or new SK. This handles players who cached credentials signed by the old key and haven’t synced yet.</li>
<li>After the grace period, only the new SK is accepted.</li>
</ol>
<h4 id="key-compromise-recovery"><a class="header" href="#key-compromise-recovery">Key Compromise Recovery</a></h4>
<p>If a community operator discovers (or suspects) their SK has been compromised:</p>
<ol>
<li><strong>Immediate response:</strong> Run <code>ic community emergency-rotate --recovery-key &lt;rk&gt;</code>.</li>
<li>Server generates a new SK.</li>
<li>Server signs an <strong>emergency rotation record</strong> with the <strong>Recovery Key</strong>:
<ul>
<li><code>signed_by: RecoveryKey</code></li>
<li><code>reason: Compromise</code> (or <code>PrecautionaryRevoke</code>)</li>
<li><code>old_key_valid_until: now</code> (no grace period for compromised keys — immediate revocation)</li>
</ul>
</li>
<li>Clients encountering this record verify it against the RK public key (cached since community join).</li>
<li><strong>Compromise window SCRs:</strong> SCRs issued between the compromise and the rotation are potentially forged. The rotation record includes the <code>effective_at</code> timestamp. Clients can flag SCRs signed by the old key after this timestamp as “potentially compromised” (⚠️ in the UI). SCRs signed before the compromise window remain valid — the key was legitimate when they were issued.</li>
<li><strong>Attacker is locked out:</strong> The attacker has the old SK but not the RK. They cannot forge rotation records, so clients who receive the legitimate RK-signed rotation will reject the attacker’s old-SK-signed SCRs going forward.</li>
</ol>
<p><strong>What about third-party compromise reports?</strong> (“Someone told me community X’s key was stolen.”)</p>
<p>IC does <strong>not</strong> support third-party key revocation. Only the RK holder can revoke an SK. This is the same model as PGP — only the key owner can issue a revocation certificate. If you suspect a community’s key is compromised but they haven’t rotated:</p>
<ul>
<li>Remove them from your trusted communities list (D053). This is your defense.</li>
<li>Contact the community operator out-of-band (Discord, email, their website) to alert them.</li>
<li>The community appears as ⚠️ Untrusted in profiles of players who removed them.</li>
</ul>
<p>Central revocation authorities (CRLs, OCSP) require central infrastructure — exactly what IC’s federated model avoids. The tradeoff is that compromise propagation depends on the operator’s responsiveness. This is acceptable: IC communities are run by the same people who already manage Discord servers, game servers, and community websites. They’re reachable.</p>
<h4 id="key-expiry-policy"><a class="header" href="#key-expiry-policy">Key Expiry Policy</a></h4>
<p><strong>Community keys (SK and RK) do NOT expire.</strong> This is an explicit design choice.</p>
<p>Arguments for expiry (and why they don’t apply):</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Argument</th><th>Counterpoint</th></tr>
</thead>
<tbody>
<tr><td>“Limits damage from silent compromise”</td><td>SCRs already have per-record <code>expires_at</code> (7 days default for ratings). A silently compromised key can only forge SCRs that expire in a week. Voluntary key rotation provides the same benefit without forced expiry.</td></tr>
<tr><td>“Forces rotation hygiene”</td><td>IC’s community operators are hobbyists running $5 VPSes. Forced expiry creates an operational burden that causes more harm (communities dying from forgotten renewal) than good. Let rotation be voluntary.</td></tr>
<tr><td>“TLS certs expire”</td><td>TLS operates in a CA trust model with automated renewal (ACME/Let’s Encrypt). IC has no CA and no automated renewal infrastructure. The analogy doesn’t hold.</td></tr>
<tr><td>“What if the operator disappears?”</td><td>SCR <code>expires_at</code> handles this naturally. If the server goes offline, rating SCRs expire within 7 days and become un-refreshable. The community dies gracefully — players’ old match/achievement SCRs (which have <code>expires_at: never</code>) remain verifiable, but ratings go stale. No key expiry needed.</td></tr>
</tbody>
</table>
</div>
<p>The correct analogy is SSH host keys (never expire, TOFU model) and PGP keys (no forced expiry, voluntary rotation or revocation), not TLS certificates.</p>
<p><strong>However, IC nudges operators toward good hygiene:</strong></p>
<ul>
<li>The server logs a warning if the SK hasn’t been rotated in 12 months: “Consider rotating your signing key. Run <code>ic community rotate-signing-key</code>.” This is a reminder, not an enforcement.</li>
<li>The client shows a subtle indicator if a community’s SK is older than 24 months: small 🕐 icon next to the community name. This is informational, not blocking.</li>
</ul>
<h4 id="client-side-key-storage"><a class="header" href="#client-side-key-storage">Client-Side Key Storage</a></h4>
<p>When a player joins a community, the client receives and caches both public keys:</p>
<pre><code class="language-sql">-- In the community credential store (community_info table)
CREATE TABLE community_info (
    community_key       BLOB NOT NULL,     -- Current SK public key (32 bytes)
    recovery_key        BLOB NOT NULL,     -- RK public key (32 bytes) — cached at join
    community_name      TEXT NOT NULL,
    server_url          TEXT NOT NULL,
    key_fingerprint     TEXT NOT NULL,     -- hex(SHA-256(community_key)[0..8])
    rk_fingerprint      TEXT NOT NULL,     -- hex(SHA-256(recovery_key)[0..8])
    sk_rotated_at       INTEGER,           -- when current SK was activated
    joined_at           INTEGER NOT NULL,
    last_sync           INTEGER NOT NULL
);

-- Key rotation history (for audit trail)
CREATE TABLE key_rotations (
    sequence        INTEGER PRIMARY KEY,
    old_key         BLOB NOT NULL,         -- retired SK public key
    new_key         BLOB NOT NULL,         -- replacement SK public key
    signed_by       TEXT NOT NULL,         -- 'signing_key' or 'recovery_key'
    reason          TEXT NOT NULL,
    effective_at    INTEGER NOT NULL,
    grace_until     INTEGER NOT NULL,      -- old key accepted until this time
    rotation_record BLOB NOT NULL          -- full signed rotation record bytes
);
</code></pre>
<p>The <code>key_rotations</code> table provides an audit trail: the client can verify the entire chain of key rotations from the original key (cached at join time) to the current key. This means even if a client was offline for months and missed several rotations, they can verify the chain: “original_SK → SK2 (signed by original_SK) → SK3 (signed by SK2) → current_SK (signed by SK3).” If any link in the chain breaks, the client alerts the user.</p>
<h4 id="revocation-player-level"><a class="header" href="#revocation-player-level">Revocation (Player-Level)</a></h4>
<ul>
<li>The community server signs a revocation record: <code>(record_type, min_valid_sequence, signature)</code>.</li>
<li>Clients encountering a revocation update their local <code>revocations</code> table.</li>
<li>Verification checks: <code>scr.sequence &gt;= revocations[scr.record_type].min_valid_sequence</code>.</li>
<li>Use case: player caught cheating → server issues revocation for all their records below a new sequence → player’s cached credentials become unverifiable → they must re-authenticate, and the server can refuse.</li>
</ul>
<p>Revocations are distinct from key rotations. Revocations invalidate a specific player’s credentials. Key rotations replace the community’s signing key. Both use signed records; they solve different problems.</p>
<h4 id="social-recovery-optional-for-large-communities"><a class="header" href="#social-recovery-optional-for-large-communities">Social Recovery (Optional, for Large Communities)</a></h4>
<p>The two-key system has one remaining single point of failure: the RK itself. If the sole operator loses the RK private key (hardware failure, lost USB drive) AND the SK is also compromised, the community is dead. For small clan servers this is acceptable — the operator is one person who backs up their key. For large communities (1,000+ members, years of match history), the stakes are higher.</p>
<p><strong>Social recovery</strong> eliminates this single point by distributing the RK across multiple trusted people using <strong>Shamir’s Secret Sharing</strong> (SSS). Instead of one person holding the RK, the community designates N <strong>recovery guardians</strong> — trusted community members who each hold a shard. A threshold of K shards (e.g., 3 of 5) is required to reconstruct the RK and sign an emergency rotation.</p>
<p>This pattern comes from Ethereum’s account abstraction ecosystem (ERC-4337, Argent wallet, Vitalik Buterin’s 2021 social recovery proposal), adapted for IC’s community key model. The Web3 ecosystem spent years refining social recovery UX because key loss destroyed real value — IC benefits from those lessons without needing a blockchain.</p>
<p><strong>Setup:</strong></p>
<pre><code>$ ic community setup-social-recovery --guardians 5 --threshold 3

  Social Recovery Setup
  ─────────────────────
  Your Recovery Key will be split into 5 shards.
  Any 3 shards can reconstruct it.

  Enter guardian identities (player keys or community member names):
    Guardian 1: alice   (player_key: 3f7a2b91...)
    Guardian 2: bob     (player_key: 9c4d17e3...)
    Guardian 3: carol   (player_key: a1b2c3d4...)
    Guardian 4: dave    (player_key: e5f6a7b8...)
    Guardian 5: eve     (player_key: 12345678...)

  Generating shards...
  Each guardian will receive their shard encrypted to their player key.
  Shards are transmitted via the community server's secure channel.

  ⚠️  Store the guardian list securely. You need 3 of these 5 people
     to recover your community if the Recovery Key is lost.

  [Confirm and distribute shards]
</code></pre>
<p><strong>How it works:</strong></p>
<ol>
<li>The RK private key is split into N shards using Shamir’s Secret Sharing over the Ed25519 scalar field.</li>
<li>Each shard is encrypted to the guardian’s player public key (X25519 key agreement + AEAD) and transmitted.</li>
<li>Guardians store their shard locally (in their player credential SQLite, encrypted at rest).</li>
<li>The operator’s server stores only the guardian list (public keys + shard indices) — never the shards themselves.</li>
<li>To perform emergency rotation, K guardians each decrypt and submit their shard to a recovery coordinator (can be the operator’s new server, or any guardian). The coordinator reconstructs the RK, signs the rotation record, and discards the reconstructed key.</li>
<li>After recovery, new shards should be generated (the old shards reconstructed the old RK; a fresh <code>setup-social-recovery</code> generates shards for a new RK).</li>
</ol>
<p><strong>Guardian management:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Operation</th><th>Command</th></tr>
</thead>
<tbody>
<tr><td>Set up social recovery</td><td><code>ic community setup-social-recovery --guardians N --threshold K</code></td></tr>
<tr><td>Replace a guardian</td><td><code>ic community replace-guardian &lt;old&gt; &lt;new&gt; --recovery-key &lt;rk&gt;</code> (requires RK to re-shard)</td></tr>
<tr><td>Check guardian status</td><td><code>ic community guardian-status</code> (pings guardians, verifies they still hold valid shards)</td></tr>
<tr><td>Initiate recovery</td><td><code>ic community social-recover</code> (collects K shards, reconstructs RK, rotates SK)</td></tr>
</tbody>
</table>
</div>
<p><strong>Guardian liveness:</strong> <code>ic community guardian-status</code> periodically checks (opt-in, configurable interval) whether guardians are still reachable and their shards are intact (guardians sign a challenge with their player key; possession of the shard is verified via a zero-knowledge proof of shard validity, not by revealing the shard). If a guardian is unreachable for 90+ days, the operator is warned: “Guardian dave has been unreachable for 94 days. Consider replacing them.”</p>
<p><strong>Why not just use N independent RKs?</strong> With N independent RKs, any single compromise recovers the full key — the security level degrades as N increases. With Shamir’s threshold scheme, compromising K-1 guardians reveals <em>zero information</em> about the RK. This is information-theoretically secure, not just computationally secure.</p>
<p><strong>Rust crate:</strong> <code>sharks</code> (Shamir’s Secret Sharing, permissively licensed, well-audited). Alternatively <code>vsss-rs</code> (Verifiable Secret Sharing — adds the property that each guardian can verify their shard is valid without learning the secret, preventing a malicious dealer from distributing fake shards).</p>
<p><strong>Phase:</strong> Social recovery is optional and ships in Phase 6a. The two-key system (Phase 5) works without it. Communities that want social recovery enable it as an upgrade — it doesn’t change any existing key management flows, just adds a recovery path.</p>
<h4 id="summary-failure-mode-comparison"><a class="header" href="#summary-failure-mode-comparison">Summary: Failure Mode Comparison</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Scenario</th><th>Single-Key System</th><th>IC Two-Key System</th><th>IC Two-Key + Social Recovery</th></tr>
</thead>
<tbody>
<tr><td>SK lost, operator has no backup</td><td>Community dead. All credentials permanently unverifiable. Players start over.</td><td>Operator uses RK to rotate to new SK. Community survives. All existing SCRs remain valid.</td><td>Same as two-key.</td></tr>
<tr><td>SK stolen</td><td>Attacker can forge credentials AND operator can’t prove legitimacy (both hold same key). Community dead.</td><td>Operator uses RK to revoke stolen SK, rotate to new SK. Attacker locked out. Community recovers.</td><td>Same as two-key.</td></tr>
<tr><td>SK stolen + operator doesn’t notice for weeks</td><td>Unlimited forgery window. No recovery.</td><td>SCR <code>expires_at</code> limits forgery to 7-day windows. RK-signed rotation locks out attacker retroactively.</td><td>Same as two-key.</td></tr>
<tr><td>Both SK and RK lost</td><td>—</td><td>Community dead. But this requires losing both an online server key AND an offline backup. Extraordinary negligence.</td><td><strong>K guardians reconstruct RK → rotate SK. Community survives.</strong> This is the upgrade.</td></tr>
<tr><td>Operator disappears (burnout, health, life)</td><td>Community dead.</td><td>Community dead (unless operator shared RK with a trusted successor).</td><td><strong>K guardians reconstruct RK → transfer operations to new operator. Community survives.</strong></td></tr>
<tr><td>RK stolen (but SK is fine)</td><td>—</td><td>No immediate impact — RK isn’t used for day-to-day operations. Operator should regenerate RK immediately: <code>ic community regenerate-recovery-key</code>.</td><td>Same as two-key — but after regeneration, resharding is recommended.</td></tr>
</tbody>
</table>
</div>
<h3 id="cross-community-interoperability"><a class="header" href="#cross-community-interoperability">Cross-Community Interoperability</a></h3>
<p>Communities are independent ranking domains — a 1500 rating on “Official IC” means nothing on “Clan Wolfpack.” This is intentional: different communities can run different game modules, balance presets (D019), and matchmaking rules.</p>
<p><strong>However, portable proofs are useful:</strong></p>
<ul>
<li>“I have 500+ matches on the official community” — provable by presenting signed match SCRs.</li>
<li>“I achieved ‘Iron Curtain’ achievement on Official IC” — provable by presenting the signed achievement SCR.</li>
<li>A tournament community can require “minimum 50 rated matches on any community with verifiable SCRs” as an entry requirement.</li>
</ul>
<p><strong>Cross-domain credential principle:</strong> Cross-community credential presentation is architecturally a “bridge” — data signed in Domain A is presented in Domain B. The most expensive lessons in Web3 were bridge hacks (Ronin $625M, Wormhole $325M, Nomad $190M), all caused by trusting cross-domain data without sufficient validation at the boundary. IC’s design is already better than most Web3 bridges (each verifier independently checks Ed25519 signatures locally, no intermediary trusted), but the following principle should be explicit:</p>
<blockquote>
<p><strong>Cross-domain credentials are read-only.</strong> Community Y can <em>display</em> and <em>verify</em> credentials signed by Community X, but must never <em>update its own state</em> based on them without independent re-verification. If Community Y grants a privilege based on Community X membership (e.g., “skip probation if you have 100+ matches on Official IC”), it must re-verify the SCR at the moment the privilege is exercised — not cache the check from an earlier session. Stale cached trust checks are the root cause of bridge exploits: the external state changed (key rotated, credential revoked), but the receiving domain still trusted its cached approval.</p>
</blockquote>
<p>In practice, this means:</p>
<ul>
<li>Trust requirements (D053 <code>TrustRequirement</code>) re-verify SCRs on every room join, not once per session.</li>
<li>Matchmaking checks re-verify rating SCRs before each match, not at queue entry.</li>
<li>Tournament entry requirements re-verify all credential conditions at match start, not at registration.</li>
<li>The <code>expires_at</code> field on SCRs (default 7 days for ratings) provides a natural staleness bound, but point-of-use re-verification catches revocations within the validity window.</li>
</ul>
<p>This costs one Ed25519 signature check (~65μs) per verification — negligible even at thousands of verifications per second.</p>
<p><strong>Cross-community rating display (V29):</strong></p>
<p>Foreign credentials displayed in lobbies and profiles must be visually distinct from the current community’s ratings to prevent misrepresentation:</p>
<ul>
<li><strong>Full-color</strong> tier badge for the current community’s rating. <strong>Desaturated/outlined</strong> badge for credentials from other communities, with the issuing community name in small text.</li>
<li>Matchmaking always uses the <strong>current community’s</strong> rating. Foreign ratings never influence matchmaking — a “Supreme Commander” from another server starts at default rating + placement deviation when joining a new community.</li>
<li><strong>Optional seeding hint:</strong> Community operators MAY configure foreign credentials as a seeding signal during placement (weighted at 30% — a foreign 2400 seeds at ~1650, not 2400). Disabled by default. This is a convenience, not a trust assertion.</li>
</ul>
<p><strong>Leaderboards:</strong></p>
<ul>
<li>Each community maintains its own leaderboard, compiled from the rating SCRs it has issued.</li>
<li>The community server caches current ratings (in RAM or SQLite) for leaderboard display.</li>
<li>Players can view their own full match history locally (from their SQLite credential file) without server involvement.</li>
</ul>
<h3 id="community-server-operational-requirements"><a class="header" href="#community-server-operational-requirements">Community Server Operational Requirements</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Metric</th><th>Estimate</th></tr>
</thead>
<tbody>
<tr><td>Storage per player</td><td>~40 bytes persistent (key + revocation). ~200 bytes cached (rating for matchmaking)</td></tr>
<tr><td>Storage for 10,000 players</td><td>~2.3 MB</td></tr>
<tr><td>RAM for matchmaking (1,000 concurrent)</td><td>~200 KB</td></tr>
<tr><td>CPU per match result signing</td><td>~1ms (Ed25519 sign is ~60μs; rest is rating computation)</td></tr>
<tr><td>Bandwidth per match result</td><td>~500 bytes (2 SCRs returned: rating + match)</td></tr>
<tr><td>Monthly VPS cost (small community, &lt;1000 players)</td><td>$5–10</td></tr>
<tr><td>Monthly VPS cost (large community, 10,000+ players)</td><td>$20–50</td></tr>
</tbody>
</table>
</div>
<p>This is cheaper than any centralized ranking service. Operating a community is within reach of a single motivated community member — the same people who already run OpenRA servers and Discord bots.</p>
<h3 id="relationship-to-existing-decisions"><a class="header" href="#relationship-to-existing-decisions">Relationship to Existing Decisions</a></h3>
<ul>
<li><strong>D007 (Relay server):</strong> The relay produces <code>CertifiedMatchResult</code> — the input to rating computation. A Community Server bundles relay + ranking in one process.</li>
<li><strong>D030/D050 (Workshop federation):</strong> Community Servers federate like Workshop sources. <code>settings.toml</code> lists communities the same way it lists Workshop sources.</li>
<li><strong>D034 (SQLite):</strong> The credential file IS SQLite. The community server’s small state IS SQLite.</li>
<li><strong>D036 (Achievements):</strong> Achievement records are SCRs stored in the credential file. The community server is the signing authority.</li>
<li><strong>D041 (RankingProvider trait):</strong> Matchmaking uses <code>RankingProvider</code> implementations. Community operators choose their algorithm.</li>
<li><strong>D042 (Player profiles):</strong> Behavioral profiles remain local-only (D042). The credential file holds signed competitive data (ratings, matches, achievements). They complement each other: D042 = private local analytics, D052 = portable signed reputation.</li>
<li><strong>P004 (Lobby/matchmaking):</strong> This decision partially resolves P004. Room discovery (5 tiers), lobby P2P resource sharing, and matchmaking are now designed. The remaining Phase 5 work is wire format specifics (message framing, serialization, state machine transitions).</li>
</ul>
<h3 id="alternatives-considered"><a class="header" href="#alternatives-considered">Alternatives Considered</a></h3>
<ul>
<li><strong>Centralized ranking database</strong> (rejected — expensive to host, single point of failure, doesn’t match IC’s federation model, violates local-first privacy principle)</li>
<li><strong>JWT for credentials</strong> (rejected — algorithm confusion attacks, <code>alg: none</code> bypass, JSON parsing ambiguity, no built-in replay protection, no built-in revocation. See comparison table above)</li>
<li><strong>Blockchain/DLT for rankings</strong> (rejected — massively overcomplicated for this use case, environmental concerns, no benefit over Ed25519 signed records)</li>
<li><strong>Per-player credential chaining (prev_hash linking)</strong> (evaluated, rejected — would add a 32-byte <code>prev_hash</code> field to each SCR, linking each record to its predecessor in a per-player hash chain. Goal: guarantee completeness of match history presentation, preventing players from hiding losses. Rejected because: the server-computed rating already reflects all matches — the rating IS the ground truth, and a player hiding individual match SCRs can’t change their verified rating. The chain also creates false positives when legitimate credential file loss/corruption breaks the chain, requires the server to track per-player chain heads adding state proportional to <code>N_players × N_record_types</code>, and complicates the clean “verify signature, check sequence” flow for a primarily cosmetic concern. The transparency log — which audits the <em>server</em>, not the player — is the higher-value accountability mechanism.)</li>
<li><strong>Web-of-trust (players sign each other’s match results)</strong> (rejected — Sybil attacks trivially game this; a trusted community server as signing authority is simpler and more resistant)</li>
<li><strong>PASETO (Platform-Agnostic Security Tokens)</strong> (considered — fixes many JWT flaws, mandates modern algorithms. Rejected because: still JSON-based, still has header/payload/footer structure that invites parsing issues, and IC’s binary SCR format is more compact and purpose-built. PASETO is good; SCR is better for this niche.)</li>
</ul>
<h3 id="phase"><a class="header" href="#phase">Phase</a></h3>
<p>Community Server infrastructure ships in <strong>Phase 5</strong> (Multiplayer &amp; Competitive, Months 20–26). The SCR format and credential SQLite schema are defined early (Phase 2) to support local testing with mock community servers.</p>
<ul>
<li><strong>Phase 2:</strong> SCR format crate, local credential store, mock community server for testing.</li>
<li><strong>Phase 5:</strong> Full community server (relay + ranking + matchmaking + achievement signing). <code>ic community join/leave/status</code> CLI commands. In-game community browser.</li>
<li><strong>Phase 6a:</strong> Federation between communities. Community discovery. Cross-community credential presentation. Community reputation.</li>
</ul>
<h3 id="cross-pollination-lessons-flowing-between-d052d053-workshop-and-netcode"><a class="header" href="#cross-pollination-lessons-flowing-between-d052d053-workshop-and-netcode">Cross-Pollination: Lessons Flowing Between D052/D053, Workshop, and Netcode</a></h3>
<p>The work on community servers, trust chains, and player profiles produced patterns that strengthen Workshop and netcode designs — and vice versa. This section catalogues the cross-system lessons beyond the four shared infrastructure opportunities already documented in D049 (unified <code>ic-server</code> binary, federation library, auth/identity layer, EWMA scoring).</p>
<h4 id="d052d053--workshop-d030d049d050"><a class="header" href="#d052d053--workshop-d030d049d050">D052/D053 → Workshop (D030/D049/D050)</a></h4>
<p><strong>1. Two-key architecture for Workshop index signing.</strong></p>
<p>The Workshop’s git-index security (D049) plans a single Ed25519 key for signing <code>index.yaml</code>. That’s the same single-point-of-failure the two-key architecture (§ Key Lifecycle above) was designed to eliminate. CI pipeline compromise is one of the most common supply-chain attack vectors (SolarWinds, Codecov, ua-parser-js). The SK+RK pattern maps directly:</p>
<ul>
<li><strong>Index Signing Key (SK):</strong> Held by CI, used to sign every <code>index.yaml</code> build. Rotated periodically or on compromise.</li>
<li><strong>Index Recovery Key (RK):</strong> Held offline by ≥2 project maintainers (threshold signing or independent copies). Used solely to sign a <code>KeyRotationRecord</code> that re-anchors trust to a new SK.</li>
</ul>
<p>If CI is compromised, the attacker gets SK but not RK. Maintainers rotate via RK — clients that verify the rotation chain continue trusting the index. Without two-key, CI compromise means either (a) the attacker signs malicious indexes indefinitely, or (b) the project mints a new key and every client must manually re-trust it. The rotation chain avoids both.</p>
<p><strong>2. Publisher two-key identity.</strong></p>
<p>Individual mod publishers currently authenticate via GitHub account (Phase 0–3) or Workshop server credentials (Phase 4+). If alice’s account is compromised, her packages can be poisoned. The two-key pattern extends to publishers:</p>
<ul>
<li><strong>Publisher Signing Key (SK):</strong> Used to sign each <code>.icpkg</code> manifest on publish. Stored on the publisher’s development machine.</li>
<li><strong>Publisher Recovery Key (RK):</strong> Generated at first publish. Stored offline (e.g., USB key, password manager). Used only to rotate the SK if compromised.</li>
</ul>
<p>Clients that cache alice’s public key can verify her packages remain authentic through key rotations. The <code>KeyRotationRecord</code> struct from D052 is reusable — same format, same verification logic, different context. This also enables package pinning: <code>ic mod pin alice/tanks --key &lt;fingerprint&gt;</code> refuses installs signed by any other key, even if alice’s Workshop account is hijacked.</p>
<p><strong>3. Trust-based Workshop source filtering.</strong></p>
<p>D053’s <code>TrustRequirement</code> model (None / AnyCommunityVerified / SpecificCommunities) maps to Workshop sources. Currently, <code>settings.toml</code> implicitly trusts all configured sources equally. Applying D053’s trust tiers:</p>
<ul>
<li><strong>Trusted source:</strong> <code>ic mod install</code> proceeds silently.</li>
<li><strong>Known source:</strong> Install proceeds with an informational note.</li>
<li><strong>Unknown source:</strong> <code>ic mod install</code> warns and requires <code>--allow-untrusted</code> flag (or interactive confirmation).</li>
</ul>
<p>This is the same UX pattern as the game browser trust badges — ✅/⚠️/❌ — applied to the <code>ic</code> CLI and in-game mod browser. When a dependency chain pulls a package from an untrusted source, the solver surfaces this clearly before proceeding.</p>
<p><strong>4. Server-side validation principle as shared invariant.</strong></p>
<p>D052’s explicit principle — “never sign data you didn’t produce or verify” — should be a shared invariant across all IC server components. For the Workshop server, this means:</p>
<ul>
<li>Never accept a publish without verifying: SHA-256 matches, manifest is valid YAML, version doesn’t already exist, publisher key matches the namespace, no path traversal in file entries.</li>
<li>Never sign a package listing without recomputing checksums from the stored <code>.icpkg</code>.</li>
<li>Workshop server attestation: a <code>CertifiedPublishResult</code> (analogous to the relay’s <code>CertifiedMatchResult</code>) signed by the server, proving the publish was validated. Stored in the publisher’s local credential file — portable proof that “this package was accepted by Workshop server X at time T.”</li>
</ul>
<p><strong>5. Registration policies → Workshop publisher policies.</strong></p>
<p>D052’s <code>RegistrationPolicy</code> enum (Open / RequirePlatform / RequireInvite / RequireChallenge / AnyOf) maps to Workshop publisher onboarding. A community-hosted Workshop server can configure who may publish:</p>
<ul>
<li><code>Open</code> — anyone can publish (appropriate for experimental/testing servers)</li>
<li><code>RequirePlatform</code> — must have a linked Steam/platform account</li>
<li><code>RequireInvite</code> — existing publisher must vouch (prevents spam/typosquat floods)</li>
</ul>
<p>This is already implicit in the git-index phase (GitHub account = identity), but should be explicit in the Workshop server design for Phase 4+.</p>
<h4 id="d052d053--netcode-d007d003"><a class="header" href="#d052d053--netcode-d007d003">D052/D053 → Netcode (D007/D003)</a></h4>
<p><strong>6. Relay server two-key pattern.</strong></p>
<p>Relay servers produce signed <code>CertifiedMatchResult</code> records — the trust anchor for all competitive data. If a relay’s signing key leaks, all match results are forgeable. Same SK+RK solution: relay operators generate a signing key (used by the running relay binary) and a recovery key (stored offline). On compromise, the operator rotates via RK without invalidating the community’s entire match history.</p>
<p>Currently D052 says a community server “trusts its own relay” — but this trust should be cryptographically verifiable: the community server knows the relay’s public key (registered in <code>community_info</code>), and the <code>CertifiedMatchResult</code> carries the relay’s signature. Key rotation propagates through the same <code>KeyRotationRecord</code> chain.</p>
<p><strong>7. Trust-verified P2P peer selection.</strong></p>
<p>D049’s P2P peer scoring selects peers by capacity, locality, seed status, and lobby context. D053’s trust model adds a fifth dimension: when downloading mods from lobby peers, prefer peers with verified profiles from trusted communities. A verified player is less likely to serve malicious content (Sybil nodes have no community history). The scoring formula gains an optional trust component:</p>
<pre><code>PeerScore = Capacity(0.35) + Locality(0.25) + SeedStatus(0.2) + Trust(0.1) + LobbyContext(0.1)
</code></pre>
<p>Trust scoring: verified by a trusted community = 1.0, verified by any community = 0.5, unverified = 0. This is opt-in — communities that don’t care about trust verification keep the original 4-factor formula.</p>
<h4 id="workshopnetcode--d052d053"><a class="header" href="#workshopnetcode--d052d053">Workshop/Netcode → D052/D053</a></h4>
<p><strong>8. Profile fetch rate control.</strong></p>
<p>Netcode uses three-layer rate control (per-connection, per-IP, global). Profile fetching in lobbies is susceptible to the same abuse patterns — a malicious client could spam profile requests to exhaust server bandwidth or enumerate player data. The same rate-control architecture applies: per-IP rate limits on profile fetch requests, exponential backoff on repeated fetches of the same profile, and a TTL cache that makes duplicate requests a local cache hit.</p>
<p><strong>9. Content integrity hashing for composite profiles.</strong></p>
<p>The Workshop uses SHA-256 checksums plus <code>manifest_hash</code> for double verification. When a player assembles their composite profile (identity + SCRs from multiple communities), the assembled profile can include a composite hash — enabling cache invalidation without re-fetching every individual SCR. When a profile is requested, the server returns the composite hash first; if it matches the cached version, no further transfer is needed. This is the same “content-addressed fetch” pattern the Workshop uses for <code>.icpkg</code> files.</p>
<p><strong>10. EWMA scoring for community member standing.</strong></p>
<p>The Workshop’s EWMA (Exponentially Weighted Moving Average) peer scoring — already identified as shared infrastructure in D049 — has a concrete consumer in D052/D053: community member standing. A community server can track per-member quality signals (connection stability, disconnect rate, desync frequency, report count) using time-decaying EWMA scores. Recent behavior weighs more than ancient history. This feeds into matchmaking preferences (D052) and the profile’s community standing display (D053) without requiring a separate scoring system.</p>
<h4 id="shared-pattern-key-management-as-reusable-infrastructure"><a class="header" href="#shared-pattern-key-management-as-reusable-infrastructure">Shared pattern: key management as reusable infrastructure</a></h4>
<p>The two-key architecture now appears in three contexts: community servers, relay servers, and Workshop (index + publishers). This suggests extracting it as a shared <code>ic-crypto</code> module (or section of <code>ic-protocol</code>) that provides:</p>
<ul>
<li><code>SigningKeypair</code> + <code>RecoveryKeypair</code> generation</li>
<li><code>KeyRotationRecord</code> creation and chain verification</li>
<li>Fingerprint computation and display formatting</li>
<li>Common serialization for the rotation chain</li>
</ul>
<p>All three consumers use Ed25519, the same rotation record format, and the same verification logic. The only difference is context (what the key signs). This is a Phase 2 deliverable — the crypto primitives must exist before community servers, relays, or Workshop servers use them.</p>
<hr>
<hr>
<h2 id="d055-ranked-tiers-seasons--matchmaking-queue"><a class="header" href="#d055-ranked-tiers-seasons--matchmaking-queue">D055: Ranked Tiers, Seasons &amp; Matchmaking Queue</a></h2>
<p><strong>Status:</strong> Settled
<strong>Phase:</strong> Phase 5 (Multiplayer &amp; Competitive)
<strong>Depends on:</strong> D041 (RankingProvider), D052 (Community Servers), D053 (Player Profile), D037 (Competitive Governance), D034 (SQLite Storage), D019 (Balance Presets)</p>
<h3 id="decision-capsule-llmrag-summary-1"><a class="header" href="#decision-capsule-llmrag-summary-1">Decision Capsule (LLM/RAG Summary)</a></h3>
<ul>
<li><strong>Status:</strong> Settled</li>
<li><strong>Phase:</strong> Phase 5 (Multiplayer &amp; Competitive)</li>
<li><strong>Canonical for:</strong> Ranked player experience design (tiers, seasons, placement flow, queue behavior) built on the D052/D053 competitive infrastructure</li>
<li><strong>Scope:</strong> ranked ladders/tiers/seasons, matchmaking queue behavior, player-facing competitive UX, ranked-specific policies and displays</li>
<li><strong>Decision:</strong> IC defines a full ranked experience with <strong>named tiers</strong>, <strong>season structure</strong>, <strong>placement flow</strong>, <strong>small-population matchmaking degradation</strong>, and <strong>faction-aware rating presentation</strong>, layered on top of D041/D052/D053 foundations.</li>
<li><strong>Why:</strong> Raw ratings alone are poor motivation/UX, RTS populations are small and need graceful queue behavior, and competitive retention depends on seasonal structure and clear milestones.</li>
<li><strong>Non-goals:</strong> A raw-number-only ladder UX; assuming FPS/MOBA-scale populations; one-size-fits-all ranked rules across all communities/balance presets.</li>
<li><strong>Invariants preserved:</strong> Rating authority remains community-server based (D052); rating algorithms remain trait-backed (<code>RankingProvider</code>, D041); ranked flow reuses generic netcode/match lifecycle mechanisms where possible.</li>
<li><strong>Defaults / UX behavior:</strong> Tier names/badges are YAML-driven per game module; seasons are explicit; ranked queue constraints and degradation behavior are product-defined rather than ad hoc.</li>
<li><strong>Security / Trust impact:</strong> Ranked relies on the existing relay + signed credential trust chain and integrates with governance/moderation decisions rather than bypassing them.</li>
<li><strong>Performance / Ops impact:</strong> Queue degradation rules and small-population design reduce matchmaking failures and waiting dead-ends in niche RTS communities.</li>
<li><strong>Public interfaces / types / commands:</strong> tier configuration YAML, <code>RankingProvider</code> display integration, ranked queue/lobby settings and vote constraints (see body)</li>
<li><strong>Affected docs:</strong> <code>src/03-NETCODE.md</code>, <code>src/decisions/09e-community.md</code> (D052/D053/D037), <code>src/17-PLAYER-FLOW.md</code>, <code>src/decisions/09g-interaction.md</code></li>
<li><strong>Revision note summary:</strong> None</li>
<li><strong>Keywords:</strong> ranked tiers, seasons, matchmaking queue, placement matches, faction rating, small population matchmaking, competitive ladder</li>
</ul>
<h3 id="problem"><a class="header" href="#problem">Problem</a></h3>
<p>The existing competitive infrastructure (D041’s <code>RankingProvider</code>, D052’s signed credentials, D053’s profile) provides the <em>foundational layer</em> — a pluggable rating algorithm, cryptographic verification, and display system. But it doesn’t define the <em>player-facing competitive experience</em>:</p>
<ol>
<li><strong>No rank tiers.</strong> <code>display_rating()</code> outputs “1500 ± 200” — useful for analytically-minded players but lacking the motivational milestones that named ranks provide. CS2’s transition from hidden MMR to visible CS Rating (with color bands) was universally praised but showed that even visible numbers benefit from tier mapping for casual engagement. SC2’s league system proved this for RTS specifically.</li>
<li><strong>No season structure.</strong> Without seasons, leaderboards stagnate — top players stop playing and retain positions indefinitely, exactly the problem C&amp;C Remastered experienced (see <code>research/ranked-matchmaking-analysis.md</code> § 3.3).</li>
<li><strong>No placement flow.</strong> D041 defines new-player seeding formula but doesn’t specify the user-facing placement match experience.</li>
<li><strong>No small-population matchmaking degradation.</strong> RTS communities are 10–100× smaller than FPS/MOBA populations. The matchmaking queue must handle 100-player populations gracefully, not just 100,000-player populations.</li>
<li><strong>No faction-specific rating.</strong> IC has asymmetric factions. A player who is strong with Allies may be weak with Soviets — one rating doesn’t capture this.</li>
<li><strong>No map selection for ranked.</strong> Competitive map pool curation is mentioned in Phase 5 and D037 but the in-queue selection mechanism (veto/ban) isn’t defined.</li>
</ol>
<h3 id="solution"><a class="header" href="#solution">Solution</a></h3>
<h4 id="tier-configuration-yaml-driven-per-game-module"><a class="header" href="#tier-configuration-yaml-driven-per-game-module">Tier Configuration (YAML-Driven, Per Game Module)</a></h4>
<p>Rank tier names, thresholds, and visual assets are defined in the game module’s YAML configuration — not in engine code. The engine provides the tier resolution logic; the game module provides the theme.</p>
<pre><code class="language-yaml"># ra/rules/ranked-tiers.yaml
# Red Alert game module — Cold War military rank theme
ranked_tiers:
  format_version: "1.0.0"
  divisions_per_tier: 3          # III → II → I within each tier
  division_labels: ["III", "II", "I"]  # lowest to highest

  tiers:
    - name: Cadet
      min_rating: 0
      icon: "icons/ranks/cadet.png"
      color: "#8B7355"            # Brown — officer trainee

    - name: Lieutenant
      min_rating: 1000
      icon: "icons/ranks/lieutenant.png"
      color: "#A0A0A0"            # Silver-grey — junior officer

    - name: Captain
      min_rating: 1250
      icon: "icons/ranks/captain.png"
      color: "#FFD700"            # Gold — company commander

    - name: Major
      min_rating: 1425
      icon: "icons/ranks/major.png"
      color: "#4169E1"            # Royal blue — battalion level

    - name: Lt. Colonel
      min_rating: 1575
      icon: "icons/ranks/lt_colonel.png"
      color: "#9370DB"            # Purple — senior field officer

    - name: Colonel
      min_rating: 1750
      icon: "icons/ranks/colonel.png"
      color: "#DC143C"            # Crimson — regimental command

    - name: Brigadier
      min_rating: 1975
      icon: "icons/ranks/brigadier.png"
      color: "#FF4500"            # Red-orange — brigade command

  elite_tiers:
    - name: General
      min_rating: 2250
      icon: "icons/ranks/general.png"
      color: "#FFD700"            # Gold — general staff
      show_rating: true           # Display actual rating number alongside tier

    - name: Supreme Commander
      type: top_n                 # Fixed top-N, not rating threshold
      count: 200                  # Top 200 players per community server
      icon: "icons/ranks/supreme-commander.png"
      color: "#FFFFFF"            # White/platinum — pinnacle
      show_rating: true
      show_leaderboard_position: true
</code></pre>
<p><strong>Why military ranks for Red Alert:</strong></p>
<ul>
<li>Players command armies — military rank progression IS the core fantasy</li>
<li>All ranks are officer-grade (Cadet through General) because the player is always commanding, never a foot soldier</li>
<li>Proper military hierarchy — every rank is real and in correct sequential order: Cadet → Lieutenant → Captain → Major → Lt. Colonel → Colonel → Brigadier → General</li>
<li>“Supreme Commander” crowns the hierarchy — a title earned, not a rank given. It carries the weight of Cold War authority (STAVKA, NATO Supreme Allied Commander) and the unmistakable identity of the RTS genre itself</li>
</ul>
<p><strong>Why 7 + 2 = 9 tiers (23 ranked positions):</strong></p>
<ul>
<li>SC2 proved 7+2 works for RTS community sizes (~100K peak, ~10K sustained)</li>
<li>Fewer than LoL’s 10 tiers (designed for 100M+ players — IC won’t have that)</li>
<li>More than AoE4’s 6 tiers (too few for meaningful progression)</li>
<li>3 divisions per tier (matching SC2/AoE4/Valorant convention) provides intra-tier goals</li>
<li>Lt. Colonel fills the gap between Major and Colonel — the most natural compound rank, universally understood</li>
<li>Elite tiers (General, Supreme Commander) create aspirational targets even with small populations</li>
</ul>
<p><strong>Game-module replaceability:</strong> Tiberian Dawn could use GDI/Nod themed rank names. A fantasy RTS mod can define completely different tier sets. Community mods define their own via YAML. The engine resolves <code>PlayerRating.rating → tier name + division</code> using whatever tier configuration the active game module provides.</p>
<h4 id="dual-display-tier--rating"><a class="header" href="#dual-display-tier--rating">Dual Display: Tier + Rating</a></h4>
<p>Every ranked player sees BOTH:</p>
<ul>
<li><strong>Tier badge:</strong> “Captain II” with icon and color — milestone-driven motivation</li>
<li><strong>Rating number:</strong> “1847 ± 45” — transparency, eliminates “why didn’t I rank up?” frustration</li>
</ul>
<p>This follows the industry trend toward transparency: CS2’s shift from hidden MMR to visible CS Rating was universally praised, SC2 made MMR visible in 2020 to positive reception, and Dota 2 shows raw MMR at Immortal tier. IC does this from day one — no hidden intermediary layers (unlike LoL’s LP system, which creates MMR/LP disconnects that frustrate players).</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Tier resolution — lives in ic-ui, reads from game module YAML config.
/// NOT in ic-sim (tiers are display-only, not gameplay).
pub struct RankedTierDisplay {
    pub tier_name: String,         // e.g., "Captain"
    pub division: u8,              // e.g., 2 (for "Captain II")
    pub division_label: String,    // e.g., "II"
    pub icon_path: String,
    pub color: [u8; 3],            // RGB
    pub rating: i64,               // actual rating number (always shown)
    pub deviation: i64,            // uncertainty (shown as ±)
    pub is_elite: bool,            // General/Supreme Commander
    pub leaderboard_position: Option&lt;u32&gt;,  // only for elite tiers
    pub peak_tier: Option&lt;String&gt;, // highest tier this season (e.g., "Colonel I")
}
<span class="boring">}</span></code></pre>
<h4 id="rating-details-panel-expanded-stats"><a class="header" href="#rating-details-panel-expanded-stats">Rating Details Panel (Expanded Stats)</a></h4>
<p>The compact display (“Captain II — 1847 ± 45”) covers most players’ needs. But analytically-minded players — and anyone who watched a “What is Glicko-2?” explainer — want to inspect their full rating parameters. The <strong>Rating Details</strong> panel expands from the Statistics Card’s <code>[Rating Graph →]</code> link and provides complete transparency into every number the system tracks.</p>
<pre><code>┌──────────────────────────────────────────────────────────────────┐
│ 📈 Rating Details — Official IC Community (RA1)                  │
│                                                                  │
│  ┌─ Current Rating ────────────────────────────────────────┐     │
│  │  ★ Colonel I                                           │     │
│  │  Rating (μ):     1971          Peak: 2023 (S3 Week 5)  │     │
│  │  Deviation (RD):   45          Range: 1881 – 2061       │     │
│  │  Volatility (σ): 0.041         Trend: Stable ──         │     │
│  └─────────────────────────────────────────────────────────┘     │
│                                                                  │
│  ┌─ What These Numbers Mean ───────────────────────────────┐     │
│  │  Rating: Your estimated skill. Higher = stronger.       │     │
│  │  Deviation: How certain the system is. Lower = more     │     │
│  │    confident. Increases if you don't play for a while.  │     │
│  │  Volatility: How consistent your results are. Low means │     │
│  │    you perform predictably. High means recent upsets.   │     │
│  │  Range: 95% confidence interval — your true skill is    │     │
│  │    almost certainly between 1881 and 2061.              │     │
│  └─────────────────────────────────────────────────────────┘     │
│                                                                  │
│  ┌─ Rating History (last 50 matches) ──────────────────────┐     │
│  │  2050 ┤                                                 │     │
│  │       │        ╭──╮                    ╭──╮             │     │
│  │  2000 ┤   ╭──╮╯    ╰╮  ╭╮       ╭──╮╯    ╰──●         │     │
│  │       │╭─╯           ╰──╯╰──╮╭─╯                       │     │
│  │  1950 ┤                      ╰╯                         │     │
│  │       │                                                 │     │
│  │  1900 ┤─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─  │     │
│  │       └──────────────────────────────────────── Match #  │     │
│  │  [Confidence band] [Per-faction] [Deviation overlay]    │     │
│  └─────────────────────────────────────────────────────────┘     │
│                                                                  │
│  ┌─ Recent Matches (rating impact) ────────────────────────┐     │
│  │  #342  W  vs alice (1834)    Allies   +14  RD -1  │▓▓▓ │     │
│  │  #341  W  vs bob (2103)      Soviet   +31  RD -2  │▓▓▓▓│     │
│  │  #340  L  vs carol (1956)    Soviet   -18  RD -1  │▓▓  │     │
│  │  #339  W  vs dave (1712)     Allies    +8  RD -1  │▓   │     │
│  │  #338  L  vs eve (2201)      Soviet    -6  RD -2  │▓   │     │
│  │                                                         │     │
│  │  Rating impact depends on opponent strength:            │     │
│  │    Beat alice (lower rated):  small gain (+14)          │     │
│  │    Beat bob (higher rated):   large gain (+31)          │     │
│  │    Lose to carol (similar):   moderate loss (-18)       │     │
│  │    Lose to eve (much higher): small loss (-6)           │     │
│  └─────────────────────────────────────────────────────────┘     │
│                                                                  │
│  ┌─ Faction Breakdown ─────────────────────────────────────┐     │
│  │  ☭ Soviet:   1983 ± 52   (168 matches, 59% win rate)   │     │
│  │  ★ Allied:   1944 ± 61   (154 matches, 56% win rate)   │     │
│  │  ? Random:   ─            (20 matches, 55% win rate)    │     │
│  │                                                         │     │
│  │  (Faction ratings shown only if faction tracking is on) │     │
│  └─────────────────────────────────────────────────────────┘     │
│                                                                  │
│  ┌─ Rating Distribution (your position) ───────────────────┐     │
│  │  Players                                                │     │
│  │  ▓▓▓                                                    │     │
│  │  ▓▓▓▓▓▓                                                 │     │
│  │  ▓▓▓▓▓▓▓▓▓▓▓                                            │     │
│  │  ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓                                     │     │
│  │  ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓                             │     │
│  │  ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓△▓▓▓▓▓                 │     │
│  │  ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓          │     │
│  │  └──────────────────────────────────────────── Rating    │     │
│  │  800   1000  1200  1400  1600  1800  △YOU  2200  2400   │     │
│  │                                                         │     │
│  │  You are in the top 5% of rated players.                │     │
│  │  122 players are rated higher than you.                 │     │
│  └─────────────────────────────────────────────────────────┘     │
│                                                                  │
│  [Export Rating History (CSV)]  [View Leaderboard]               │
└──────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>Panel components:</strong></p>
<ol>
<li>
<p><strong>Current Rating box:</strong> All three Glicko-2 parameters displayed with plain names. The “Range” line shows the 95% confidence interval ($\mu \pm 2 \times RD$). The “Trend” indicator compares current volatility to the player’s 20-match average: ↑ Rising (recent upsets), ── Stable, ↓ Settling (consistent results).</p>
</li>
<li>
<p><strong>Plain-language explainer:</strong> Collapsible on repeat visits (state stored in <code>preferences.db</code>). Uses no jargon — “how certain the system is” instead of “rating deviation.” Players who watch Glicko-2 explainer videos will recognize the terms; players who don’t will understand the meaning.</p>
</li>
<li>
<p><strong>Rating history graph:</strong> Client-side chart (Bevy 2D line renderer) from match SCR data. Toggle overlays: confidence band (±2·RD as shaded region around the rating line), per-faction line split, deviation history. Hoverable data points show match details.</p>
</li>
<li>
<p><strong>Recent matches with rating impact:</strong> Each match shows the rating delta, deviation change, and a bar indicating relative impact magnitude. Explanatory text contextualizes why gains/losses vary — teaching the player how Glicko-2 works through their own data.</p>
</li>
<li>
<p><strong>Faction breakdown:</strong> Per-faction rating (if faction tracking is enabled, D055 § Faction-Specific Ratings). Shows each faction’s independent rating, deviation, match count, and win rate. Random-faction matches contribute to all faction ratings equally.</p>
</li>
<li>
<p><strong>Rating distribution histogram:</strong> Shows where the player falls in the community’s population. The △ marker shows “you are here.” Population percentile and count of higher-rated players give concrete context. Data sourced from the community server’s leaderboard endpoint (cached locally, refreshed hourly).</p>
</li>
<li>
<p><strong>CSV export:</strong> Exports full rating history (match date, opponent rating, result, rating change, deviation change, volatility) as a CSV file — consistent with the “player data is a platform” philosophy (D034). Community stat tools, spreadsheet analysts, and researchers can work with the raw data.</p>
</li>
</ol>
<p><strong>Where this lives in the UI:</strong></p>
<ul>
<li><strong>In-game path:</strong> Main Menu → Profile → Statistics Card → <code>[Rating Graph →]</code> → Rating Details Panel</li>
<li><strong>Post-game:</strong> The match result screen includes a compact rating change widget (“1957 → 1971, +14”) that links to the full panel</li>
<li><strong>Tooltip:</strong> Hovering over anyone’s rank badge in lobbies, match results, or friends list shows a compact version (rating ± deviation, tier, percentile)</li>
<li><strong>Console command:</strong> <code>/rating</code> or <code>/stats rating</code> opens the panel. <code>/rating &lt;player&gt;</code> shows another player’s public rating details.</li>
</ul>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Data backing the Rating Details panel. Computed in ic-ui from local SQLite.
/// NOT in ic-sim (display-only).
pub struct RatingDetailsView {
    pub current: RankedTierDisplay,
    pub confidence_interval: (i64, i64),      // (lower, upper) = μ ± 2·RD
    pub volatility: i64,                       // fixed-point Glicko-2 σ
    pub volatility_trend: VolatilityTrend,
    pub history: Vec&lt;RatingHistoryPoint&gt;,      // last N matches
    pub faction_ratings: Option&lt;Vec&lt;FactionRating&gt;&gt;,
    pub population_percentile: Option&lt;f32&gt;,    // 0.0–100.0, from cached leaderboard
    pub players_above: Option&lt;u32&gt;,            // count of higher-rated players
    pub season_peak: PeakRecord,
    pub all_time_peak: PeakRecord,
}

pub struct RatingHistoryPoint {
    pub match_id: String,
    pub timestamp: u64,
    pub opponent_rating: i64,
    pub result: MatchResult,                   // Win, Loss, Draw
    pub rating_before: i64,
    pub rating_after: i64,
    pub deviation_before: i64,
    pub deviation_after: i64,
    pub faction_played: String,
    pub opponent_faction: String,
    pub match_duration_ticks: u64,
    pub information_content: i32,              // 0-1000, how much this match "counted"
}

pub struct FactionRating {
    pub faction_id: String,
    pub faction_name: String,
    pub rating: i64,
    pub deviation: i64,
    pub matches_played: u32,
    pub win_rate: i32,                         // 0-1000 fixed-point
}

pub struct PeakRecord {
    pub rating: i64,
    pub tier_name: String,
    pub division: u8,
    pub achieved_at: u64,                      // timestamp
    pub match_id: Option&lt;String&gt;,              // the match where peak was reached
}

pub enum VolatilityTrend {
    Rising,     // σ increased over last 20 matches — inconsistent results
    Stable,     // σ roughly unchanged
    Settling,   // σ decreased — consistent performance
}
<span class="boring">}</span></code></pre>
<h4 id="glicko-2-rts-adaptations"><a class="header" href="#glicko-2-rts-adaptations">Glicko-2 RTS Adaptations</a></h4>
<p>Standard Glicko-2 was designed for chess: symmetric, no map variance, no faction asymmetry, large populations, frequent play. IC’s competitive environment differs on every axis. The <code>Glicko2Provider</code> (D041) implements standard Glicko-2 with the following RTS-specific parameter tuning:</p>
<p><strong>Parameter configuration (YAML-driven, per community server):</strong></p>
<pre><code class="language-yaml"># Server-side Glicko-2 configuration
glicko2:
  # Standard Glicko-2 parameters
  default_rating: 1500            # New player starting rating
  default_deviation: 350          # New player RD (high = fast convergence)
  system_constant_tau: 0.5        # Volatility constraint (standard range: 0.3–1.2)

  # IC RTS adaptations
  rd_floor: 45                    # Minimum RD — prevents rating "freezing"
  rd_ceiling: 350                 # Maximum RD (equals placement-level uncertainty)
  inactivity_c: 34.6              # RD growth constant for inactive players
  rating_period_days: 0           # 0 = per-match updates (no batch periods)

  # Match quality weighting
  match_duration_weight:
    min_ticks: 3600               # 2 minutes at 30 tps — below this, reduced weight
    full_weight_ticks: 18000      # 10 minutes — at or above this, full weight
    short_game_factor: 300        # 0-1000 fixed-point weight for games &lt; min_ticks
  
  # Team game handling (2v2, 3v3)
  team_rating_method: "weighted_average"  # or "max_rating", "trueskill"
  team_individual_share: true     # distribute rating change by contribution weight
</code></pre>
<p><strong>Adaptation 1 — RD floor (min deviation = 45):</strong></p>
<p>Standard Glicko-2 allows RD to approach zero for highly active players, making their rating nearly immovable. This is problematic for competitive games where skill fluctuates with meta shifts, patch changes, and life circumstances. An RD floor of 45 ensures that even the most active player’s rating responds meaningfully to results.</p>
<p>Why 45: Valve’s CS Regional Standings uses RD = 75 for 5v5 team play. In 1v1 RTS, each match provides more information per player (no teammates to attribute results to), so a lower floor is appropriate. At RD = 45, the 95% confidence interval is ±90 rating points — enough precision to distinguish skill while remaining responsive.</p>
<p>The RD floor is enforced after each rating update: <code>rd = max(rd_floor, computed_rd)</code>. This is the simplest adaptation and has the largest impact on player experience.</p>
<p><strong>Adaptation 2 — Per-match rating periods:</strong></p>
<p>Standard Glicko-2 groups matches into “rating periods” (typically a fixed time window) and updates ratings once per period. This made sense for postal chess where you complete a few games per month. RTS players play 2–5 games per session and want immediate feedback.</p>
<p>IC updates ratings after every individual match — each match is its own rating period with $m = 1$. This is mathematically equivalent to running Glicko-2 Step 1–8 with a single game per period. The deviation update (Step 3) and rating update (Step 7) reflect one result, then the new rating becomes the input for the next match.</p>
<p>This means the post-game screen shows the exact rating change from that match, not a batched update. Players see “+14” or “-18” and understand immediately what happened.</p>
<p><strong>Adaptation 3 — Information content weighting by match duration:</strong></p>
<p>A 90-second game where one player disconnects during load provides almost no skill information. A 20-minute game with multiple engagements provides rich skill signal. Standard Glicko-2 treats all results equally.</p>
<p>IC scales the rating impact of each match by an <code>information_content</code> factor (already defined in D041’s <code>MatchQuality</code>). Match duration is one input:</p>
<ul>
<li>Games shorter than <code>min_ticks</code> (2 minutes): weight = <code>short_game_factor</code> (default 0.3×)</li>
<li>Games between <code>min_ticks</code> and <code>full_weight_ticks</code> (2–10 minutes): linearly interpolated</li>
<li>Games at or above <code>full_weight_ticks</code> (10+ minutes): full weight (1.0×)</li>
</ul>
<p>Implementation: the <code>g(RD)</code> function in Glicko-2 Step 3 is not modified. Instead, the expected outcome $E$ is scaled by the information content factor before computing the rating update. This preserves the mathematical properties of Glicko-2 while reducing the impact of low-quality matches.</p>
<p>Other <code>information_content</code> inputs (from D041): game mode weight (ranked = 1.0, casual = 0.5), player count balance (1v1 = 1.0, 1v2 = 0.3), and opponent rematching penalty (V26: <code>weight = base × 0.5^(n-1)</code> for repeated opponents).</p>
<p><strong>Adaptation 4 — Inactivity RD growth targeting seasonal cadence:</strong></p>
<p>Standard Glicko-2 increases RD over time when a player is inactive: $RD_{new} = \sqrt{RD^2 + c^2 \cdot t}$ where $c$ is calibrated and $t$ is the number of rating periods elapsed. IC tunes $c$ so that a player who is inactive for one full season (91 days) reaches RD ≈ 250 — high enough that their first few matches back converge quickly, but not reset to placement level (350).</p>
<p>With <code>c = 34.6</code> and daily periods: after 91 days, $RD = \sqrt{45^2 + 34.6^2 \times 91} \approx 250$. This means returning players re-stabilize in ~5–10 matches rather than the 25+ that a full reset would require.</p>
<p><strong>Adaptation 5 — Team game rating distribution:</strong></p>
<p>Glicko-2 is designed for 1v1. For team games (2v2, 3v3), IC uses a weighted-average team rating for matchmaking quality assessment, then distributes rating changes individually based on the result:</p>
<ul>
<li>Team rating for matchmaking: weighted average of member ratings (weights = 1/RD, so more-certain players count more)</li>
<li>Post-match: each player’s rating updates as if they played a 1v1 against the opposing team’s weighted average</li>
<li>Deviation updates independently per player</li>
</ul>
<p>This is a pragmatic adaptation, not a theoretically optimal one. For communities that want better team rating, D041’s <code>RankingProvider</code> trait allows substituting TrueSkill (designed specifically for team games) or any custom algorithm.</p>
<p><strong>What IC does NOT modify:</strong></p>
<ul>
<li><strong>Glicko-2 Steps 1–8 core algorithm:</strong> The mathematical update procedure is standard. No custom “performance bonus” adjustments for APM, eco score, or unit efficiency. Win/loss/draw is the only result input. This prevents metric-gaming (players optimizing for stats instead of winning) and keeps the system simple and auditable.</li>
<li><strong>Volatility calculation:</strong> The iterative Illinois algorithm for computing new σ is unmodified. The <code>system_constant_tau</code> parameter controls sensitivity — community servers can tune this, but the formula is standard.</li>
<li><strong>Rating scale:</strong> Standard Glicko-2 rating range (~800–2400, centered at 1500). No artificial scaling or normalization.</li>
</ul>
<h4 id="why-ranks-not-leagues"><a class="header" href="#why-ranks-not-leagues">Why Ranks, Not Leagues</a></h4>
<p>IC uses <strong>military ranks</strong> (Cadet → Supreme Commander), not <strong>leagues</strong> (Bronze → Grandmaster). This is a deliberate thematic and structural choice.</p>
<p><strong>Thematic alignment:</strong> Players command armies. Military rank progression <em>is</em> the fantasy — you’re not “placed in Gold league,” you <em>earned the rank of Colonel</em>. The Cold War military theme matches IC’s identity (the engine is named “Iron Curtain”). Every rank implies command authority: even Cadet (officer trainee) is on the path to leading troops, not a foot soldier following orders. The hierarchy follows actual military rank order through General — then transcends it: “Supreme Commander” isn’t a rank you’re promoted to, it’s a title you <em>earn</em> by being one of the top 200. Real military parallels exist (STAVKA’s Supreme Commander-in-Chief, NATO’s Supreme Allied Commander), and the name carries instant genre recognition.</p>
<p><strong>Structural reasons:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Dimension</th><th>Ranks (IC approach)</th><th>Leagues (SC2 approach)</th></tr>
</thead>
<tbody>
<tr><td>Assignment</td><td>Rating threshold → rank label</td><td>Placement → league group of ~100 players</td></tr>
<tr><td>Population requirement</td><td>Works at any scale (50 or 50,000 players)</td><td>Needs thousands to fill meaningful groups</td></tr>
<tr><td>Progression feel</td><td>Continuous — every match moves you toward the next rank</td><td>Grouped — you’re placed once per season, then grind within the group</td></tr>
<tr><td>Identity language</td><td>“I’m a Colonel” (personal achievement)</td><td>“I’m in Diamond” (group membership)</td></tr>
<tr><td>Demotion</td><td>Immediate if rating drops below threshold (honest)</td><td>Often delayed or hidden to avoid frustration (dishonest)</td></tr>
<tr><td>Cross-community portability</td><td>Rating → rank mapping is deterministic from YAML config</td><td>League placement requires server-side group management</td></tr>
</tbody>
</table>
</div>
<p><strong>The naming decision:</strong> The tier names themselves carry weight. “Cadet” is where everyone starts — you’re an officer-in-training, unproven. “Major” means you’ve earned mid-level command authority. “Supreme Commander” is the pinnacle — a title that evokes both Cold War gravitas (the Supreme Commander-in-Chief of the Soviet Armed Forces was the head of STAVKA) and the RTS genre itself. These names are IC’s brand, not generic color bands.</p>
<p>For other game modules, the rank names change to match the theme — Tiberian Dawn might use GDI/Nod military ranks, a fantasy mod might use feudal titles — but the <em>structure</em> (rating thresholds → named ranks × divisions) stays the same. The YAML configuration in <code>ranked-tiers.yaml</code> makes this trivially customizable.</p>
<p><strong>Why not both?</strong> SC2’s system was technically a hybrid: leagues (groups of players) with tier labels (Bronze, Silver, Gold). IC’s approach is simpler: there are no player groups or league divisions. Your rank is a pure function of your rating — deterministic, portable, and verifiable from the YAML config alone. If you know the tier thresholds and your rating, you know your rank. No server-side group assignment needed. This is critical for D052’s federated model, where community servers may have different populations but should be able to resolve the same rating to the same rank label.</p>
<h4 id="season-structure"><a class="header" href="#season-structure">Season Structure</a></h4>
<pre><code class="language-yaml"># Server configuration (community server operators can customize)
season:
  duration_days: 91              # ~3 months (matching SC2, CS2, AoE4)
  placement_matches: 10          # Required before rank is assigned
  soft_reset:
    # At season start, compress all ratings toward default:
    # new_rating = default + (old_rating - default) * compression_factor
    compression_factor: 700       # 0-1000 fixed-point (0.7 = keep 70% of distance from default)
    default_rating: 1500          # Center point
    reset_deviation: true         # Set deviation to placement level (fast convergence)
    placement_deviation: 350      # High deviation during placement (ratings move fast)
  rewards:
    # Per-tier season-end rewards (cosmetic only — no gameplay advantage)
    enabled: true
    # Specific rewards defined per-season by competitive committee (D037)
  leaderboard:
    min_matches: 5                # Minimum matches to appear on leaderboard
    min_distinct_opponents: 5     # Must have played at least 5 different opponents (V26)
</code></pre>
<p><strong>Season lifecycle:</strong></p>
<ol>
<li><strong>Season start:</strong> All player ratings compressed toward 1500 (soft reset). Deviation set to placement level (350). Players lose their tier badge until placement completes.</li>
<li><strong>Placement (10 matches):</strong> High deviation means rating moves fast. Uses D041’s seeding formula for brand-new players. Returning players converge quickly because their pre-reset rating provides a strong prior. <strong>Hidden matchmaking rating (V30):</strong> during placement, matchmaking searches near the player’s pre-reset rating (not the compressed value), preventing cross-skill mismatches in the first few days of each season. Placement also requires <strong>10 distinct opponents</strong> (soft requirement — degrades gracefully to <code>max(3, available * 0.5)</code> on small servers) to prevent win-trading (V26).</li>
<li><strong>Active season:</strong> Normal Glicko-2 rating updates. Deviation decreases with more matches (rating stabilizes). Tier badge updates immediately after every match (no delayed batches — avoiding OW2’s mistake).</li>
<li><strong>Season end:</strong> Peak tier badge saved to profile (D053). Season statistics archived. Season rewards distributed. Leaderboard frozen for display.</li>
<li><strong>Inter-season:</strong> Short transition period (~1 week) with unranked competitive practice queue.</li>
</ol>
<p><strong>Why 3-month seasons:</strong></p>
<ul>
<li>Matches SC2’s proven cadence for RTS</li>
<li>Long enough for ratings to stabilize and leaderboards to mature</li>
<li>Short enough to prevent stagnation (the C&amp;C Remastered problem)</li>
<li>Aligns naturally with quarterly balance patches and competitive map pool rotations</li>
</ul>
<h4 id="faction-specific-ratings-optional"><a class="header" href="#faction-specific-ratings-optional">Faction-Specific Ratings (Optional)</a></h4>
<pre><code class="language-yaml"># Player opted into faction tracking:
faction_ratings:
  enabled: true                  # Player's choice — optional
  # Separate rating tracked per faction played
  # Matchmaking uses the rating for the selected faction
  # Profile shows all faction ratings
</code></pre>
<p>Inspired by SC2’s per-race MMR. When enabled:</p>
<ul>
<li>Each faction (e.g., Allies, Soviets) has a separate <code>PlayerRating</code></li>
<li>Matchmaking uses the rating for the faction the player queues with</li>
<li>Profile displays all faction ratings (D053 statistics card)</li>
<li>If disabled, one unified rating is used regardless of faction choice</li>
</ul>
<p><strong>Why optional:</strong> Some players want one rating that represents their overall skill. Others want per-faction tracking because they’re “Diamond Allies but Gold Soviets.” Making it opt-in respects both preferences without splitting the matchmaking pool (matchmaking always uses the relevant rating — either faction-specific or unified).</p>
<h4 id="matchmaking-queue-design"><a class="header" href="#matchmaking-queue-design">Matchmaking Queue Design</a></h4>
<p><strong>Queue modes:</strong></p>
<ul>
<li><strong>Ranked 1v1:</strong> Primary competitive mode. Map veto from seasonal pool.</li>
<li><strong>Ranked Team:</strong> 2v2, 3v3 (match size defined by game module). Separate team rating. Party restrictions: maximum 1 tier difference between party members (anti-boosting, same as LoL’s duo restrictions).</li>
<li><strong>Unranked Competitive:</strong> Same rules as ranked but no rating impact. For practice, warm-up, or playing with friends across wide skill gaps.</li>
</ul>
<p><strong>Map selection (ranked 1v1):</strong>
Both players alternately ban maps from the competitive map pool (curated per-season by competitive committee, D037). The remaining map is played — similar to CS2 Premier’s pick/ban system but adapted for 1v1 RTS.</p>
<p><strong>Map pool curation guidelines:</strong> The competitive committee should evaluate maps for competitive suitability beyond layout and balance. Relevant considerations include:</p>
<ul>
<li><strong>Weather sim effects (D022):</strong> Maps with <code>sim_effects: true</code> introduce movement variance from dynamic weather (snow slowing units, ice enabling water crossing, mud bogging vehicles). The committee may include weather-active maps if the weather schedule is deterministic and strategically interesting, or exclude them if the variance is deemed unfair. Tournament organizers can override this via lobby settings.</li>
<li><strong>Map symmetry and spawn fairness:</strong> Standard competitive map criteria — positional balance, resource distribution, rush distance equity.</li>
<li><strong>Performance impact:</strong> Maps with extreme cell counts, excessive weather particles, or complex terrain should be tested against the 500-unit performance target (10-PERFORMANCE.md) before inclusion.</li>
</ul>
<p><strong>Anonymous veto (V27):</strong> During the veto sequence, opponents are shown as “Opponent” — no username, rating, or tier badge. Identity is revealed only after the final map is determined and both players confirm ready. Leaving during the veto sequence counts as a loss (escalating cooldown: 5min → 30min → 2hr). This prevents identity-based queue dodging while preserving strategic map bans.</p>
<pre><code>Seasonal pool: 7 maps
Player A bans 1 → 6 remain
Player B bans 1 → 5 remain
Player A bans 1 → 4 remain
Player B bans 1 → 3 remain
Player A bans 1 → 2 remain
Player B bans 1 → 1 remains → this map is played
</code></pre>
<p><strong>Small-population matchmaking degradation:</strong></p>
<p>Critical for RTS communities. The queue must work with 50 players as well as 5,000.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Matchmaking search parameters — widen over time.
/// These are server-configurable defaults.
pub struct MatchmakingConfig {
    /// Initial rating search range (one-sided).
    /// A player at 1500 searches 1500 ± initial_range.
    pub initial_range: i64,           // default: 100

    /// Range widens by this amount every `widen_interval` seconds.
    pub widen_step: i64,              // default: 50

    /// How often (seconds) to widen the search range.
    pub widen_interval_secs: u32,     // default: 30

    /// Maximum search range before matching with anyone available.
    pub max_range: i64,               // default: 500

    /// After this many seconds, match with any available player.
    /// Only activates if ≥3 players are in queue (V31).
    pub desperation_timeout_secs: u32, // default: 300 (5 minutes)

    /// Minimum match quality (fairness score from D041).
    /// Matches below this threshold are not created even at desperation (V30).
    pub min_match_quality: f64,       // default: 0.3
}
<span class="boring">}</span></code></pre>
<p>The UI displays estimated queue time based on current population and the player’s rating position. At low population, the UI shows “~2 min (12 players in queue)” transparently rather than hiding the reality.</p>
<p><strong>New account anti-smurf measures:</strong></p>
<ul>
<li>First 10 ranked matches have high deviation (fast convergence to true skill)</li>
<li>New accounts with extremely high win rates in placement are fast-tracked to higher ratings (D041 seeding formula)</li>
<li>Relay server behavioral analysis (Phase 5 anti-cheat) detects mechanical skill inconsistent with account age</li>
<li>Optional: phone verification for ranked queue access (configurable by community server operator)</li>
<li>Diminishing <code>information_content</code> for repeated pairings: <code>weight = base * 0.5^(n-1)</code> where n = recent rematches within 30 days (V26)</li>
<li>Desperation matches (created after search widening) earn reduced rating change proportional to skill gap (V31)</li>
<li>Collusion detection: accounts with &gt;50% matches against the same opponent in a 14-day window are flagged for review (V26)</li>
</ul>
<h4 id="peak-rank-display"><a class="header" href="#peak-rank-display">Peak Rank Display</a></h4>
<p>Each player’s profile (D053) shows:</p>
<ul>
<li><strong>Current rank:</strong> The tier + division where the player stands right now</li>
<li><strong>Peak rank (this season):</strong> The highest tier achieved this season — never decreases within a season</li>
</ul>
<p>This is inspired by Valorant’s act rank and Dota 2’s medal system. It answers “what’s the best I reached?” without the full one-way-medal problem (Dota 2’s medals never drop, making them meaningless by season end). IC’s approach: current rank is always accurate, but peak rank is preserved as an achievement.</p>
<h3 id="community-replaceability"><a class="header" href="#community-replaceability">Community Replaceability</a></h3>
<p>Per D052’s federated model, ranked matchmaking is <strong>community-owned:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Component</th><th>Official IC default</th><th>Community can customize?</th></tr>
</thead>
<tbody>
<tr><td>Rating algorithm</td><td>Glicko-2 (<code>Glicko2Provider</code>)</td><td>Yes — <code>RankingProvider</code> trait (D041)</td></tr>
<tr><td>Tier names &amp; icons</td><td>Cold War military (RA module)</td><td>Yes — YAML per game module/mod</td></tr>
<tr><td>Tier thresholds</td><td>Defined in <code>ranked-tiers.yaml</code></td><td>Yes — YAML per game module/community</td></tr>
<tr><td>Number of tiers</td><td>7 + 2 elite = 9</td><td>Yes — YAML-configurable</td></tr>
<tr><td>Season duration</td><td>91 days</td><td>Yes — server configuration</td></tr>
<tr><td>Placement match count</td><td>10</td><td>Yes — server configuration</td></tr>
<tr><td>Map pool</td><td>Curated by competitive committee</td><td>Yes — per-community</td></tr>
<tr><td>Queue modes</td><td>1v1, team</td><td>Yes — game module defines available modes</td></tr>
<tr><td>Anti-smurf measures</td><td>Behavioral analysis + fast convergence</td><td>Yes — server operator toggles</td></tr>
<tr><td>Balance preset per queue</td><td>Classic RA (D019)</td><td>Yes — community chooses per-queue</td></tr>
</tbody>
</table>
</div>
<p><strong>What is NOT community-customizable</strong> (hard requirements):</p>
<ul>
<li>Match certification must use relay-signed <code>CertifiedMatchResult</code> (D007) — no self-reported results</li>
<li>Rating records must use D052’s SCR format — portable credentials require standardized format</li>
<li>Tier resolution logic is engine-provided — communities customize the YAML data, not the resolution code</li>
</ul>
<h3 id="alternatives-considered-1"><a class="header" href="#alternatives-considered-1">Alternatives Considered</a></h3>
<ul>
<li><strong>Raw rating only, no tiers</strong> (rejected — C&amp;C Remastered showed that numbers alone lack motivational hooks. The research clearly shows that named milestones drive engagement in every successful ranked system)</li>
<li><strong>LoL-style LP system with promotion series</strong> (rejected — LP/MMR disconnect is the most complained-about feature in LoL. Promotion series were so unpopular that Riot removed them in 2024. IC should not repeat this error)</li>
<li><strong>Dota 2-style one-way medals</strong> (rejected — medals that never decrease within a season become meaningless by season end. A “Divine” player who dropped to “Archon” MMR still shows Divine — misleading, not motivating)</li>
<li><strong>OW2-style delayed rank updates</strong> (rejected — rank updating only after 5 wins or 15 losses was universally criticized. Players want immediate feedback after every match)</li>
<li><strong>CS2-style per-map ranking</strong> (rejected for launch — fragments an already-small RTS population. Per-map statistics can be tracked without separate per-map ratings. Could be reconsidered if IC’s population is large enough)</li>
<li><strong>Elo instead of Glicko-2</strong> (rejected as default — Glicko-2 handles uncertainty better, which is critical for players who play infrequently. D041’s <code>RankingProvider</code> trait allows communities to use Elo if they prefer)</li>
<li><strong>10+ named tiers</strong> (rejected — too many tiers for expected RTS population size. Adjacent tiers become meaningless when population is small. 7+2 matches SC2’s proven structure)</li>
<li><strong>Single global ranking across all community servers</strong> (rejected — violates D052’s federated model. Each community owns its rankings. Cross-community credential verification via SCR ensures portability without centralization)</li>
<li><strong>Mandatory phone verification for ranked</strong> (rejected as mandatory — makes ranked inaccessible in regions without phone access, on WASM builds, and for privacy-conscious users. Available as opt-in toggle for community operators)</li>
<li><strong>Performance-based rating adjustments</strong> (deferred — Valorant uses individual stats to adjust RR gains. For RTS this would be complex: which metrics predict skill beyond win/loss? Economy score, APM, unit efficiency? Risks encouraging stat-chasing over winning. Could be a future <code>RankingProvider</code> enhancement if the community wants it)</li>
<li><strong>SC2-style leagues with player groups</strong> (rejected — SC2’s league system places players into divisions of ~100 who compete against each other within a tier. This requires thousands of concurrent players to fill meaningful groups. IC’s expected population — hundreds to low thousands — can’t sustain this. Ranks are pure rating thresholds: deterministic, portable across federated communities (D052), and functional with 50 players or 50,000. See § “Why Ranks, Not Leagues” above)</li>
<li><strong>Color bands instead of named ranks</strong> (rejected — CS2 Premier uses color bands (Grey → Gold) which are universal but generic. Military rank names are IC’s thematic identity: “Colonel” means something in an RTS where you command armies. Color bands could be a community-provided alternative via YAML, but the default should carry the Cold War fantasy)</li>
<li><strong>Enlisted ranks as lower tiers</strong> (rejected — having “Private” or “Corporal” as the lowest ranks breaks the RTS fantasy: the player is always commanding armies, not following orders as a foot soldier. All tiers are officer-grade because the player is always in a command role. “Cadet” as the lowest tier signals “unproven officer” rather than “infantry grunt”)</li>
<li><strong>Naval rank names</strong> (rejected — “Commander” is a naval rank, not army. “Commodore” and “Admiral” belong at sea. IC’s default is an army hierarchy: Lieutenant → Captain → Major → Colonel → General. A naval mod could define its own tier names via YAML)</li>
<li><strong>Modified Glicko-2 with performance bonuses</strong> (rejected — some systems (Valorant, CS2) adjust rating gains based on individual performance metrics like K/D or round impact. For RTS this creates perverse incentives: optimizing eco score or APM instead of winning. The result (Win/Loss/Draw) is the only input to Glicko-2. Match duration weighting through <code>information_content</code> is the extent of non-result adjustment)</li>
</ul>
<h4 id="ranked-match-lifecycle"><a class="header" href="#ranked-match-lifecycle">Ranked Match Lifecycle</a></h4>
<p>D055 defines the rating system and matchmaking queue. The full competitive match lifecycle — ready-check, game pause, surrender, disconnect penalties, spectator delay, and post-game flow — is specified in <code>03-NETCODE.md</code> § “Match Lifecycle.” This separation is deliberate: the match lifecycle is a network protocol concern that applies to all game modes (with ranked-specific constraints), while D055 is specifically about the rating and tier system.</p>
<p><strong>Key ranked-specific constraints</strong> (enforced by the relay server based on lobby mode):</p>
<ul>
<li>Ready-check accept timeout: 30 seconds. Declining = escalating queue cooldown.</li>
<li>Pause: 2 per player, 120 seconds max total per player, 30-second grace before opponent can unpause.</li>
<li>Surrender: Immediate in 1v1 (<code>/gg</code> or surrender button). Vote in team games. No surrender before 5 minutes.</li>
<li>Kick: Kicked player receives full loss + queue cooldown (same as abandon). Team’s units redistributed.</li>
<li>Remake: Voided match, no rating change. Only available in first 5 minutes.</li>
<li>Draw: Treated as Glicko-2 draw (0.5 result). Both players’ deviations decrease.</li>
<li>Disconnect: Full loss + escalating queue cooldown (5min → 30min → 2hr). Reconnection within 60s = no penalty. Grace period voiding for early abandons (&lt;2 min, &lt;5% game progress).</li>
<li>Spectator delay: 2 minutes (3,600 ticks). Players cannot disable spectating in ranked (needed for anti-cheat review).</li>
<li>Post-game: 30-second lobby with stats, rating change display, report button, instant re-queue option.</li>
</ul>
<p>See <code>03-NETCODE.md</code> § “Match Lifecycle” for the full protocol, data structures, rationale, and the In-Match Vote Framework that generalizes surrender/kick/remake/draw into a unified callvote system.</p>
<h3 id="integration-with-existing-decisions"><a class="header" href="#integration-with-existing-decisions">Integration with Existing Decisions</a></h3>
<ul>
<li><strong>D041 (RankingProvider):</strong> <code>display_rating()</code> method implementations use the tier configuration YAML to resolve rating → tier name. The trait’s existing interface supports D055 without modification — tier resolution is a display concern in <code>ic-ui</code>, not a trait responsibility.</li>
<li><strong>D052 (Community Servers):</strong> Each community server’s ranking authority stores tier configuration alongside its <code>RankingProvider</code> implementation. SCR records store the raw rating; tier resolution is display-side.</li>
<li><strong>D053 (Player Profile):</strong> The statistics card (rating ± deviation, peak rating, match count, win rate, streak, faction distribution) now includes tier badge, peak tier this season, and season history. The <code>[Rating Graph →]</code> link opens the Rating Details panel — full Glicko-2 parameter visibility, rating history chart, faction breakdown, confidence interval, and population distribution.</li>
<li><strong>D037 (Competitive Governance):</strong> The competitive committee curates the seasonal map pool, recommends tier threshold adjustments based on population distribution, and proposes balance preset selections for ranked queues.</li>
<li><strong>D019 (Balance Presets):</strong> Ranked queues can be tied to specific balance presets — e.g., “Classic RA” ranked vs. “IC Balance” ranked as separate queues with separate ratings.</li>
<li><strong>D036 (Achievements):</strong> Seasonal achievements: “Reach Captain,” “Place in top 100,” “Win 50 ranked matches this season,” etc.</li>
<li><strong>D034 (SQLite Storage):</strong> <code>MatchmakingStorage</code> trait’s existing methods (<code>update_rating()</code>, <code>record_match()</code>, <code>get_leaderboard()</code>) handle all ranked data persistence. Season history added as new tables.</li>
<li><strong>03-NETCODE.md (Match Lifecycle):</strong> Ready-check, pause, surrender, disconnect penalties, spectator delay, and post-game flow. D055 sets ranked-specific parameters; the match lifecycle protocol is game-mode-agnostic. The <strong>In-Match Vote Framework</strong> (<code>03-NETCODE.md</code> § “In-Match Vote Framework”) generalizes the surrender vote into a generic callvote system (surrender, kick, remake, draw, mod-defined) with per-vote-type ranked constraints.</li>
<li><strong>05-FORMATS.md (Analysis Event Stream):</strong> <code>PauseEvent</code>, <code>MatchEnded</code>, and <code>VoteEvent</code> analysis events record match lifecycle moments in the replay for tooling without re-simulation.</li>
</ul>
<h3 id="relationship-to-researchranked-matchmaking-analysismd"><a class="header" href="#relationship-to-researchranked-matchmaking-analysismd">Relationship to <code>research/ranked-matchmaking-analysis.md</code></a></h3>
<p>This decision is informed by cross-game analysis of CS2/CSGO, StarCraft 2, League of Legends, Valorant, Dota 2, Overwatch 2, Age of Empires IV, and C&amp;C Remastered Collection’s competitive systems. Key takeaways incorporated:</p>
<ol>
<li><strong>Transparency trend</strong> (§ 4.2): dual display of tier + rating from day one</li>
<li><strong>Tier count sweet spot</strong> (§ 4.3): 7+2 = 9 tiers for RTS population sizes</li>
<li><strong>3-month seasons</strong> (§ 4.4): RTS community standard (SC2), prevents stagnation</li>
<li><strong>Small-population design</strong> (§ 4.5): graceful matchmaking degradation, configurable widening</li>
<li><strong>C&amp;C Remastered lessons</strong> (§ 3.4): community server ownership, named milestones &gt; raw numbers, seasonal structure prevents stagnation</li>
<li><strong>Faction-specific ratings</strong> (§ 2.1): SC2’s per-race MMR adapted for IC’s faction system</li>
</ol>
<hr>
<hr>
<h2 id="d060-netcode-parameter-philosophy--automate-everything-expose-almost-nothing"><a class="header" href="#d060-netcode-parameter-philosophy--automate-everything-expose-almost-nothing">D060: Netcode Parameter Philosophy — Automate Everything, Expose Almost Nothing</a></h2>
<p><strong>Status:</strong> Settled
<strong>Decided:</strong> 2026-02
<strong>Scope:</strong> <code>ic-net</code>, <code>ic-game</code> (lobby), D058 (console)
<strong>Phase:</strong> Phase 5 (Multiplayer)</p>
<h3 id="decision-capsule-llmrag-summary-2"><a class="header" href="#decision-capsule-llmrag-summary-2">Decision Capsule (LLM/RAG Summary)</a></h3>
<ul>
<li><strong>Status:</strong> Settled</li>
<li><strong>Phase:</strong> Phase 5 (Multiplayer)</li>
<li><strong>Canonical for:</strong> Netcode parameter exposure policy (what is automated vs player/admin-visible) and multiplayer UX philosophy for netcode tuning</li>
<li><strong>Scope:</strong> <code>ic-net</code>, lobby/settings UI in <code>ic-game</code>, D058 command/cvar exposure policy</li>
<li><strong>Decision:</strong> IC automates nearly all netcode parameters and exposes only a minimal, player-comprehensible surface, with adaptive systems handling most tuning internally.</li>
<li><strong>Why:</strong> Manual netcode tuning hurts usability and fairness, successful games hide this complexity, and IC’s sub-tick/adaptive systems are designed to self-tune.</li>
<li><strong>Non-goals:</strong> A comprehensive player-facing “advanced netcode settings” panel; exposing internal transport/latency/debug knobs as normal gameplay UX.</li>
<li><strong>Invariants preserved:</strong> D006 pluggable netcode architecture remains intact; automation policy does not prevent internal default changes or future netcode replacement.</li>
<li><strong>Defaults / UX behavior:</strong> Players see only understandable controls (e.g., game speed where applicable); admin/operator controls remain narrowly scoped; developer/debug knobs stay non-player-facing.</li>
<li><strong>Security / Trust impact:</strong> Fewer exposed knobs reduces misconfiguration and exploit/abuse surface in competitive play.</li>
<li><strong>Performance / Ops impact:</strong> Adaptive tuning lowers support burden and avoids brittle hand-tuned presets across diverse network conditions.</li>
<li><strong>Public interfaces / types / commands:</strong> D058 cvar/command exposure policy, lobby parameter surfaces, internal adaptive tuning systems (see body for exact parameters)</li>
<li><strong>Affected docs:</strong> <code>src/03-NETCODE.md</code>, <code>src/17-PLAYER-FLOW.md</code>, <code>src/06-SECURITY.md</code>, <code>src/decisions/09g-interaction.md</code></li>
<li><strong>Revision note summary:</strong> None</li>
<li><strong>Keywords:</strong> netcode parameters, automate everything, expose almost nothing, run-ahead, command delay, tick rate, cvars, multiplayer settings</li>
</ul>
<h3 id="context"><a class="header" href="#context">Context</a></h3>
<p>Every lockstep RTS has tunable netcode parameters: tick rate, command delay (run-ahead), game speed, sync check frequency, stall policy, and more. The question is which parameters to expose to players, which to expose to server admins, and which to keep as fixed engine constants.</p>
<p>This decision was informed by a cross-game survey of configurable netcode parameters — covering both RTS (C&amp;C Generals, StarCraft/Brood War, Spring Engine, 0 A.D., OpenTTD, Factorio, Age of Empires II, original Red Alert) and FPS (Counter-Strike 2) — plus analysis of IC’s own sub-tick and adaptive run-ahead systems.</p>
<h3 id="the-pattern-successful-games-automate"><a class="header" href="#the-pattern-successful-games-automate">The Pattern: Successful Games Automate</a></h3>
<p>Every commercially successful game in the survey converged on the same answer: <strong>automate netcode parameters, expose almost nothing to players.</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Game / Engine</th><th>Player-Facing Netcode Controls</th><th>Automatic Systems</th><th>Outcome</th></tr>
</thead>
<tbody>
<tr><td><strong>C&amp;C Generals/ZH</strong></td><td>Game speed only</td><td>Adaptive run-ahead (200-sample rolling RTT + FPS), synchronized <code>RUNAHEAD</code> command</td><td>Players never touch latency settings; game adapts silently</td></tr>
<tr><td><strong>Factorio</strong></td><td>None (game speed implicit)</td><td>Latency hiding (always-on since 0.14.0, toggle removed), server never waits for slow clients</td><td>Removed the only toggle because “always on” was always better</td></tr>
<tr><td><strong>Counter-Strike 2</strong></td><td>None</td><td>Sub-tick always-on; fixed 64 Hz tick (removed 64/128 choice from CS:GO)</td><td>Removed tick rate choice because sub-tick made it irrelevant</td></tr>
<tr><td><strong>AoE II: DE</strong></td><td>Game speed only</td><td>Auto-adapts command delay based on connection quality</td><td>No exposed latency controls in ranked</td></tr>
<tr><td><strong>Original Red Alert</strong></td><td>Game speed only</td><td>MaxAhead adapts automatically every 128 frames via host <code>TIMING</code> events</td><td>Players never interact with MaxAhead; formula-driven</td></tr>
<tr><td><strong>StarCraft: Brood War</strong></td><td>Game speed + latency setting (Low/High/Extra High)</td><td>None (static command delay per setting)</td><td>Latency setting confuses new players; competitive play mandates “Low Latency”</td></tr>
<tr><td><strong>Spring Engine</strong></td><td>Game speed (host) + LagProtection mode (server admin)</td><td>Dynamic speed adjustment based on CPU reporting; two speed control modes</td><td>More controls → more community complaints about netcode</td></tr>
<tr><td><strong>0 A.D.</strong></td><td>None</td><td>None (hardcoded 200ms turns, no adaptive run-ahead, stalls for everyone)</td><td>Least adaptive → most stalling complaints</td></tr>
</tbody>
</table>
</div>
<p><strong>The correlation is clear:</strong> games that expose fewer netcode controls and invest in automatic adaptation have fewer player complaints and better perceived netcode quality. Games that expose latency settings (BW) or lack automatic adaptation (0 A.D.) have worse player experiences.</p>
<h3 id="decision"><a class="header" href="#decision">Decision</a></h3>
<p>IC adopts a <strong>three-tier exposure model</strong> for netcode parameters:</p>
<h4 id="tier-1-player-facing-lobby-gui"><a class="header" href="#tier-1-player-facing-lobby-gui">Tier 1: Player-Facing (Lobby GUI)</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Setting</th><th>Values</th><th>Default</th><th>Who Sets</th><th>Scope</th></tr>
</thead>
<tbody>
<tr><td><strong>Game Speed</strong></td><td>Slowest / Slower / Normal / Faster / Fastest</td><td>Slower (~15 tps)</td><td>Host (lobby)</td><td>Synced — all clients</td></tr>
</tbody>
</table>
</div>
<p>One setting. Game speed is the only parameter where player preference is legitimate (“I like slower, more strategic games” vs. “I prefer fast-paced gameplay”). In ranked play, game speed is server-enforced and not configurable.</p>
<p>Game speed affects only the interval between sim ticks — system behavior is tick-count-based, so all game logic works identically at any speed. Single-player can change speed mid-game; multiplayer sets it in lobby. This matches how every C&amp;C game handled speed (see <code>02-ARCHITECTURE.md</code> § Game Speed).</p>
<p><strong>Mobile tempo advisor compatibility (D065):</strong> Touch-specific “tempo comfort” recommendations are <strong>client/UI advisory only</strong>. They may highlight a recommended band (<code>slower</code>-<code>normal</code>, etc.) or warn a host that touch players may be overloaded, but they do not create a new authority path for speed selection. The host/queue-selected game speed remains the only synced value, and ranked speed remains server-enforced.</p>
<h4 id="tier-2-advanced--console-power-users-d058"><a class="header" href="#tier-2-advanced--console-power-users-d058">Tier 2: Advanced / Console (Power Users, D058)</a></h4>
<p>Available via console commands or <code>config.toml</code>. Not in the main GUI. Flagged with appropriate cvar flags:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Cvar</th><th>Type</th><th>Default</th><th>Flags</th><th>What It Does</th></tr>
</thead>
<tbody>
<tr><td><code>net.sync_frequency</code></td><td>int</td><td>120</td><td><code>SERVER</code></td><td>Ticks between full state hash checks</td></tr>
<tr><td><code>net.desync_debug_level</code></td><td>int</td><td>0</td><td><code>DEV_ONLY</code></td><td>0-3, controls desync diagnosis overhead (see <code>03-NETCODE.md</code> § Debug Levels)</td></tr>
<tr><td><code>net.show_diagnostics</code></td><td>bool</td><td>false</td><td><code>PERSISTENT</code></td><td>Toggle network overlay (latency, jitter, packet loss, tick timing)</td></tr>
<tr><td><code>net.visual_prediction</code></td><td>bool</td><td>true</td><td><code>DEV_ONLY</code></td><td>Client-side visual prediction; disabling useful only for testing perceived latency</td></tr>
<tr><td><code>net.simulate_latency</code></td><td>int</td><td>0</td><td><code>DEV_ONLY</code></td><td>Artificial one-way latency in ms (debug builds only)</td></tr>
<tr><td><code>net.simulate_loss</code></td><td>float</td><td>0.0</td><td><code>DEV_ONLY</code></td><td>Artificial packet loss percentage (debug builds only)</td></tr>
<tr><td><code>net.simulate_jitter</code></td><td>int</td><td>0</td><td><code>DEV_ONLY</code></td><td>Artificial jitter in ms (debug builds only)</td></tr>
</tbody>
</table>
</div>
<p>These are diagnostic and testing tools, not gameplay knobs. The <code>DEV_ONLY</code> flag prevents them from affecting ranked play. The <code>SERVER</code> flag on <code>sync_frequency</code> ensures all clients use the same value.</p>
<h4 id="tier-3-engine-constants-not-configurable-at-runtime"><a class="header" href="#tier-3-engine-constants-not-configurable-at-runtime">Tier 3: Engine Constants (Not Configurable at Runtime)</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Parameter</th><th>Value</th><th>Why Fixed</th></tr>
</thead>
<tbody>
<tr><td><strong>Sim tick rate</strong></td><td>30 tps (33ms/tick)</td><td>In lockstep, ticks are synchronization barriers (collect orders → process → advance sim → exchange hashes), not just simulation steps. Higher rates multiply CPU cost (full ECS update per tick for 500+ units), network overhead (more sync barriers, larger run-ahead in ticks), and late-arrival risk — with no gameplay benefit. RTS units move cell-to-cell, not sub-millimeter. Visual interpolation makes 30 tps smooth at 60+ FPS render. Game speed multiplies the tick <em>interval</em>, not the tick <em>rate</em>. See <code>03-NETCODE.md</code> § “Why Sub-Tick Instead of a Higher Tick Rate”</td></tr>
<tr><td><strong>Sub-tick ordering</strong></td><td>Always on</td><td>Zero cost (~4 bytes/order + one sort of ≤5 items); produces visibly fairer outcomes in simultaneous-action edge cases; CS2 proved universal acceptance; no reason to toggle</td></tr>
<tr><td><strong>Adaptive run-ahead</strong></td><td>Always on</td><td>Generals proved this works over 20 years; adapts to both RTT and FPS; synchronized via network command</td></tr>
<tr><td><strong>Timing feedback</strong></td><td>Always on</td><td>Client self-calibrates order submission timing based on relay feedback; DDNet-proven pattern</td></tr>
<tr><td><strong>Stall policy</strong></td><td>Never stall (relay drops late orders)</td><td>Core architectural decision; stalling punishes honest players for one player’s bad connection</td></tr>
<tr><td><strong>Anti-lag-switch</strong></td><td>Always on</td><td>Relay owns the clock; non-negotiable for competitive integrity</td></tr>
<tr><td><strong>Visual prediction</strong></td><td>Always on</td><td>Factorio lesson — removed the toggle in 0.14.0 because always-on was always better; cosmetic only (sim unchanged)</td></tr>
</tbody>
</table>
</div>
<h3 id="sub-tick-is-not-optional"><a class="header" href="#sub-tick-is-not-optional">Sub-Tick Is Not Optional</a></h3>
<p>Sub-tick order fairness (D008) is <strong>always-on</strong> — not a configurable feature:</p>
<ul>
<li><strong>Cost:</strong> ~4 bytes per order (<code>sub_tick_time: u32</code>) + one stable sort per tick of the orders array (typically 0-5 orders — negligible).</li>
<li><strong>Benefit:</strong> Fairer resolution of simultaneous events (engineer races, crate grabs, simultaneous attacks). “I clicked first, I won” matches player intuition.</li>
<li><strong>Player experience:</strong> The mechanism is automatic (players don’t configure timestamps), but the outcome is <strong>very visible</strong> — who wins the engineer race, who grabs the contested crate, whose attack order resolves first. These moments define close games. Without sub-tick, ties are broken by player ID (always unfair to higher-numbered players) or packet arrival order (network-dependent randomness). With sub-tick, the player who acted first wins. That’s a gameplay experience players notice and care about.</li>
<li><strong>If made optional:</strong> Would require two code paths in the sim (sorted vs. unsorted order processing), a deterministic fallback that’s always unfair to higher-numbered players (player ID tiebreak), and a lobby setting nobody understands. Ranked would mandate one mode anyway. CS2 faced zero community backlash — no one asked for “the old random tie-breaking.”</li>
</ul>
<h3 id="rationale"><a class="header" href="#rationale">Rationale</a></h3>
<p><strong>Netcode parameters are not like graphics settings.</strong> Graphics preferences are subjective (some players prefer performance over visual quality). Netcode parameters have objectively correct values — or correct adaptive algorithms. Exposing the knob creates confusion:</p>
<ol>
<li><strong>Support burden:</strong> “My game feels laggy” → “What’s your tick rate set to?” → “I changed some settings and now I don’t know which one broke it.”</li>
<li><strong>False blame:</strong> Players blame netcode settings when the real issue is their WiFi or ISP. Exposing knobs gives them something to fiddle with instead of addressing the root cause.</li>
<li><strong>Competitive fragmentation:</strong> If netcode parameters are configurable, tournaments must mandate specific values. Different communities pick different values. Replays from one community don’t feel the same on another’s settings.</li>
<li><strong>Testing matrix explosion:</strong> Every configurable parameter multiplies the QA matrix. Sub-tick on/off × 5 sync frequencies × 3 debug levels = 30 configurations to test.</li>
</ol>
<p>The games that got this right — Generals, Factorio, CS2 — all converged on the same philosophy: <strong>invest in adaptive algorithms, not exposed knobs.</strong></p>
<h3 id="alternatives-considered-2"><a class="header" href="#alternatives-considered-2">Alternatives Considered</a></h3>
<ul>
<li><strong>Expose tick rate as a lobby setting</strong> (rejected — unlike game speed, tick rate affects CPU cost, bandwidth, and netcode timing in ways players can’t reason about. If 30 tps causes issues on low-end hardware, that’s a game speed problem (lower speed = lower effective tps), not a tick rate problem.)</li>
<li><strong>Expose latency setting like StarCraft BW</strong> (rejected — BW’s Low/High/Extra High was necessary because the game had no adaptive run-ahead. IC has adaptive run-ahead from Generals. The manual setting is replaced by a better automatic system.)</li>
<li><strong>Expose sub-tick as a toggle</strong> (rejected — see analysis above. Zero-cost, always-fairer, produces visibly better outcomes in contested actions, CS2 precedent.)</li>
<li><strong>Expose everything in “Advanced Network Settings” panel</strong> (rejected — the Spring Engine approach. More controls correlate with more complaints, not fewer.)</li>
</ul>
<h3 id="integration-with-existing-decisions-1"><a class="header" href="#integration-with-existing-decisions-1">Integration with Existing Decisions</a></h3>
<ul>
<li><strong>D006 (Pluggable Networking):</strong> The <code>NetworkModel</code> trait encapsulates all netcode behavior. Parameters are internal to each implementation, not exposed through the trait interface. <code>LocalNetwork</code> ignores network parameters entirely (zero delay, no adaptation needed). <code>RelayLockstepNetwork</code> manages run-ahead, timing feedback, and anti-lag-switch internally.</li>
<li><strong>D007 (Relay Server):</strong> The relay’s tick deadline, strike thresholds, and session limits are server admin configuration, not player settings. These map to relay config files, not lobby GUI.</li>
<li><strong>D008 (Sub-Tick Timestamps):</strong> Explicitly non-optional per this decision.</li>
<li><strong>D015 (Efficiency-First Performance):</strong> Adaptive algorithms (run-ahead, timing feedback) are the “better algorithms” tier of the efficiency pyramid — they solve the problem before reaching for brute-force approaches.</li>
<li><strong>D033 (Toggleable QoL):</strong> Game speed is the one netcode-adjacent setting that fits D033’s toggle model. All other netcode parameters are engineering constants, not user preferences.</li>
<li><strong>D058 (Console):</strong> The <code>net.*</code> cvars defined above follow D058’s cvar system with appropriate flags. The diagnostic overlay (<code>net_diag</code>) is a console command, not a GUI setting.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../decisions/09a-foundation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../decisions/09c-modding.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../decisions/09a-foundation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../decisions/09c-modding.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>

<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>In-Game Interaction - Iron Curtain — Design Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Design docs for a Rust-native Red Alert RTS engine">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-928fa1a5.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-a0d63c9c.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Iron Curtain — Design Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/DK26/iron-curtain-design-docs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>
                        <a href="https://github.com/DK26/iron-curtain-design-docs/edit/main/src/decisions/09g-interaction.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <span class=fa-svg id="git-edit-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M421.7 220.3l-11.3 11.3-22.6 22.6-205 205c-6.6 6.6-14.8 11.5-23.8 14.1L30.8 511c-8.4 2.5-17.5 .2-23.7-6.1S-1.5 489.7 1 481.2L38.7 353.1c2.6-9 7.5-17.2 14.1-23.8l205-205 22.6-22.6 11.3-11.3 33.9 33.9 62.1 62.1 33.9 33.9zM96 353.9l-9.3 9.3c-.9 .9-1.6 2.1-2 3.4l-25.3 86 86-25.3c1.3-.4 2.5-1.1 3.4-2l9.3-9.3H112c-8.8 0-16-7.2-16-16V353.9zM453.3 19.3l39.4 39.4c25 25 25 65.5 0 90.5l-14.5 14.5-22.6 22.6-11.3 11.3-33.9-33.9-62.1-62.1L314.3 67.7l11.3-11.3 22.6-22.6 14.5-14.5c25-25 65.5-25 90.5 0z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="decision-log--in-game-interaction"><a class="header" href="#decision-log--in-game-interaction">Decision Log — In-Game Interaction</a></h1>
<p>Command console, communication systems (chat, voice, pings), and tutorial/new player experience.</p>
<hr>
<h2 id="d058-in-game-command-console--unified-chat-and-command-system"><a class="header" href="#d058-in-game-command-console--unified-chat-and-command-system">D058: In-Game Command Console — Unified Chat and Command System</a></h2>
<p><strong>Status:</strong> Settled
<strong>Scope:</strong> <code>ic-ui</code> (chat input, dev console UI), <code>ic-game</code> (CommandDispatcher, wiring), <code>ic-sim</code> (order pipeline), <code>ic-script</code> (Lua execution)
<strong>Phase:</strong> Phase 3 (Game Chrome — chat + basic commands), Phase 4 (Lua console), Phase 6a (mod-registered commands)
<strong>Depends on:</strong> D004 (Lua Scripting), D006 (Pluggable Networking — commands produce PlayerOrders that flow through NetworkModel), D007 (Relay Server — server-enforced rate limits), D012 (Order Validation), D033 (QoL Toggles), D036 (Achievements), D055 (Ranked Matchmaking — competitive integrity)</p>
<p><strong>Crate ownership:</strong> The <code>CommandDispatcher</code> lives in <code>ic-game</code> — it cannot live in <code>ic-sim</code> (would violate Invariant #1: no I/O in the simulation) and is too cross-cutting for <code>ic-ui</code> (CLI and scripts also use it). <code>ic-game</code> is the wiring crate that depends on all library crates, making it the natural home for the dispatcher.
<strong>Inspired by:</strong> Mojang’s Brigadier (command tree architecture), Factorio (unified chat+command UX), Source Engine (developer console + cvars)</p>
<p><strong>Revision note (2026-02-22):</strong> Revised to formalize camera bookmarks (<code>/bookmark_set</code>, <code>/bookmark</code>) as a first-class cross-platform navigation feature with explicit desktop/touch UI affordances, and to clarify that mobile tempo comfort guidance around <code>/speed</code> is advisory UI only (no new simulation/network authority path). This revision was driven by mobile/touch UX design work and cross-device tutorial integration (see D065 and <code>research/mobile-rts-ux-onboarding-community-platform-analysis.md</code>).</p>
<h3 id="decision-capsule-llmrag-summary"><a class="header" href="#decision-capsule-llmrag-summary">Decision Capsule (LLM/RAG Summary)</a></h3>
<ul>
<li><strong>Status:</strong> Settled (Revised 2026-02-22)</li>
<li><strong>Phase:</strong> Phase 3 (chat + basic commands), Phase 4 (Lua console), Phase 6a (mod-registered commands)</li>
<li><strong>Canonical for:</strong> Unified chat/command console design, command dispatch model, cvar/command UX, and competitive-integrity command policy</li>
<li><strong>Scope:</strong> <code>ic-ui</code> text input/dev console UI, <code>ic-game</code> command dispatcher, command→order routing, Lua console integration, mod command registration</li>
<li><strong>Decision:</strong> IC uses a <strong>unified chat/command input</strong> (Brigadier-style command tree) as the primary interface, plus an optional developer console overlay for power users; both share the same dispatcher and permission/rule system.</li>
<li><strong>Why:</strong> Unified input is more discoverable and portable, while a separate power-user console still serves advanced workflows (multi-line input, cvars, debugging, admin tasks).</li>
<li><strong>Non-goals:</strong> Chat-only magic-string commands with no structured parser; a desktop-only tilde-console model that excludes touch/console platforms.</li>
<li><strong>Invariants preserved:</strong> <code>CommandDispatcher</code> lives outside <code>ic-sim</code>; commands affecting gameplay flow through normal validated order/network paths; competitive integrity is enforced by permissions/rules, not hidden UI.</li>
<li><strong>Defaults / UX behavior:</strong> Enter opens the primary text field; <code>/</code> routes to commands; command/help/autocomplete behavior is shared across unified input and console overlay.</li>
<li><strong>Mobile / accessibility impact:</strong> Command access has GUI/touch-friendly paths; camera bookmarks are first-class across desktop and touch; mobile tempo guidance around <code>/speed</code> is advisory UI only.</li>
<li><strong>Security / Trust impact:</strong> Rate limits, permissions, anti-trolling measures, and ranked restrictions are part of the command system design.</li>
<li><strong>Public interfaces / types / commands:</strong> Brigadier-style command tree, cvars, <code>/bookmark_set</code>, <code>/bookmark</code>, <code>/speed</code>, mod-registered commands (<code>.iccmd</code>, Lua registration as defined in body)</li>
<li><strong>Affected docs:</strong> <code>src/03-NETCODE.md</code>, <code>src/06-SECURITY.md</code>, <code>src/17-PLAYER-FLOW.md</code>, <code>src/decisions/09g-interaction.md</code> (D059/D065)</li>
<li><strong>Revision note summary:</strong> Added formal camera bookmark command/UI semantics and clarified mobile tempo guidance is advisory-only with no new authority path.</li>
<li><strong>Keywords:</strong> command console, unified chat commands, brigadier, cvars, bookmarks, speed command, mod commands, competitive integrity, mobile command UX</li>
</ul>
<h3 id="problem"><a class="header" href="#problem">Problem</a></h3>
<p>IC needs two text-input capabilities during gameplay:</p>
<ol>
<li><strong>Player chat</strong> — team messages, all-chat, whispers in multiplayer</li>
<li><strong>Commands</strong> — developer cheats, server administration, configuration tweaks, Lua scripting, mod-injected commands</li>
</ol>
<p>These could be separate systems (Source Engine’s tilde console vs. in-game chat) or unified (Factorio’s <code>/</code> prefix in chat, Minecraft’s Brigadier-powered <code>/</code> system). The choice affects UX, security, trolling surface, modding ergonomics, and platform portability.</p>
<h3 id="how-other-games-handle-this"><a class="header" href="#how-other-games-handle-this">How Other Games Handle This</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Game/Engine</th><th>Architecture</th><th>Console Type</th><th>Cheat Consequence</th><th>Mod Commands</th></tr>
</thead>
<tbody>
<tr><td><strong>Factorio</strong></td><td>Unified: chat + <code>/command</code> + <code>/c lua</code></td><td>Same input field, <code>/</code> prefix routes to commands</td><td><code>/c</code> permanently disables achievements for the save</td><td>Mods register Lua commands via <code>commands.add_command()</code></td></tr>
<tr><td><strong>Minecraft</strong></td><td>Unified: chat + Brigadier <code>/command</code></td><td>Same input field, Brigadier tree parser</td><td>Commands in survival may disable advancements</td><td>Mods inject nodes into the Brigadier command tree</td></tr>
<tr><td><strong>Source Engine (CS2, HL2)</strong></td><td>Separate: <code>~</code> developer console + team chat</td><td>Dedicated half-screen overlay (tilde key)</td><td><code>sv_cheats 1</code> flags match</td><td>Server plugins register ConCommands</td></tr>
<tr><td><strong>StarCraft 2</strong></td><td>No text console; debug tools = GUI</td><td>Chat only; no command input</td><td>N/A (no player-accessible console)</td><td>Limited custom UI via Galaxy editor</td></tr>
<tr><td><strong>OpenRA</strong></td><td>GUI-only: DevMode checkbox menu</td><td>No text console; toggle flags in GUI panel</td><td>Flags replay as cheated</td><td>No mod-injected commands</td></tr>
<tr><td><strong>Age of Empires 2/4</strong></td><td>Chat-embedded: type codes in chat box</td><td>Same input field, magic strings</td><td>Flags game; disables achievements</td><td>No mod commands</td></tr>
<tr><td><strong>Arma 3 / OFP</strong></td><td>Separate: debug console (editor) + chat</td><td>Dedicated windowed Lua/SQF console</td><td>Editor-only; not in normal gameplay</td><td>Full SQF/Lua API access</td></tr>
</tbody>
</table>
</div>
<p><strong>Key patterns observed:</strong></p>
<ol>
<li>
<p><strong>Unified wins for UX.</strong> Factorio and Minecraft prove that a single input field with prefix routing (<code>/</code> = command, no prefix = chat) is more discoverable and less jarring than a separate overlay. Players don’t need to remember two different keybindings. Tab completion works everywhere.</p>
</li>
<li>
<p><strong>Separate console wins for power users.</strong> Source Engine’s tilde console supports multi-line input, scrollback history, cvar browsing, and autocomplete — features that are awkward in a single-line chat field. Power users (modders, server admins, developers) need this.</p>
</li>
<li>
<p><strong>Achievement/ranking consequences are universal.</strong> Every game that supports both commands and competitive play permanently marks saves/matches when cheats are used. No exceptions.</p>
</li>
<li>
<p><strong>Trolling via chat is a solved problem.</strong> Muting, ignoring, rate limiting, and admin tools handle chat abuse. The command system introduces a new trolling surface only if commands can affect other players — which is controlled by permissions, not by hiding the console.</p>
</li>
<li>
<p><strong>Platform portability matters.</strong> A tilde console assumes a physical keyboard. Mobile and console platforms need command access through a GUI or touch-friendly interface.</p>
</li>
</ol>
<h3 id="decision"><a class="header" href="#decision">Decision</a></h3>
<p>IC uses a <strong>unified chat/command system</strong> with a <strong>Brigadier-style command tree</strong>, plus an optional <strong>developer console overlay</strong> for power users. The two interfaces share the same command dispatcher — they differ only in presentation.</p>
<h4 id="the-unified-input-primary"><a class="header" href="#the-unified-input-primary">The Unified Input (Primary)</a></h4>
<p>A single text input field, opened by pressing Enter (configurable). Prefix routing:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Input</th><th>Behavior</th></tr>
</thead>
<tbody>
<tr><td><code>hello team</code></td><td>Team chat message (default)</td></tr>
<tr><td><code>/help</code></td><td>Execute command</td></tr>
<tr><td><code>/give 5000</code></td><td>Execute command with arguments</td></tr>
<tr><td><code>/s hello everyone</code></td><td>Shout to all players (all-chat)</td></tr>
<tr><td><code>/w PlayerName msg</code></td><td>Whisper to specific player</td></tr>
<tr><td><code>/c game.player.print(42)</code></td><td>Execute Lua (if permitted)</td></tr>
</tbody>
</table>
</div>
<p><strong><code>/s</code> vs <code>/all</code> distinction:</strong> <code>/s &lt;message&gt;</code> is a <strong>one-shot</strong> all-chat message — it sends the rest of the line to all players without changing your active channel. <code>/all</code> (D059 § Channel Switching) is a <strong>sticky</strong> channel switch — it changes your default channel to All so subsequent messages go to all-chat until you switch back. Same distinction as IRC’s <code>/say</code> vs <code>/join</code>.</p>
<p>This matches Factorio’s model exactly — proven UX with millions of users. The <code>/</code> prefix is universal (Minecraft, Factorio, Discord, IRC, MMOs). No learning curve.</p>
<p><strong>Tab completion</strong> powered by the command tree. Typing <code>/he</code> and pressing Tab suggests <code>/help</code>. Typing <code>/give </code> suggests valid argument types. The Brigadier-style tree generates completions automatically — mods that register commands get tab completion for free.</p>
<p><strong>Command visibility.</strong> Following Factorio’s principle: by default, all commands executed by any player are visible to all players in the chat log. This prevents covert cheating in multiplayer. Players see <code>[Admin] /give 5000</code> or <code>[Player] /reveal_map</code>. Lua commands (<code>/c</code>) can optionally use <code>/sc</code> (silent command) — but only for the host/admin, and the fact that a silent command was executed is still logged (the output is hidden, not the execution).</p>
<h4 id="the-developer-console-secondary-power-users"><a class="header" href="#the-developer-console-secondary-power-users">The Developer Console (Secondary, Power Users)</a></h4>
<p>Toggled by <code>~</code> (tilde/grave, configurable). A half-screen overlay rendered via <code>bevy_egui</code>, inspired by Source Engine:</p>
<ul>
<li><strong>Multi-line input</strong> with syntax highlighting for Lua</li>
<li><strong>Scrollable output history</strong> with filtering (errors, warnings, info, chat)</li>
<li><strong>Cvar browser</strong> — searchable list of all configuration variables with current values, types, and descriptions</li>
<li><strong>Autocomplete</strong> — same Brigadier tree, but with richer display (argument types, descriptions, permission requirements)</li>
<li><strong>Command history</strong> — up/down arrow scrolls through previous commands, persisted across sessions in SQLite (D034)</li>
</ul>
<p>The developer console dispatches commands through the <strong>same <code>CommandDispatcher</code></strong> as the chat input. It provides a better interface for the same underlying system — not a separate system with different commands.</p>
<p><strong>Compile-gated sections:</strong> The Lua console (<code>/c</code>, <code>/sc</code>, <code>/mc</code>) and debug commands are behind <code>#[cfg(feature = "dev-tools")]</code> in release builds. Regular players see only the chat/command interface. The tilde console is always available but shows only non-dev commands unless dev-tools is enabled.</p>
<h4 id="command-tree-architecture-brigadier-style"><a class="header" href="#command-tree-architecture-brigadier-style">Command Tree Architecture (Brigadier-Style)</a></h4>
<p>Already identified in <code>04-MODDING.md</code> as the design target. Formalized here:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// The source of a command — who is executing it and in what context.
pub struct CommandSource {
    pub origin: CommandOrigin,
    pub permissions: PermissionLevel,
    pub player_id: Option&lt;PlayerId&gt;,
}

pub enum CommandOrigin {
    /// Typed in the in-game chat/command input
    ChatInput,
    /// Typed in the developer console overlay
    DevConsole,
    /// Executed from the CLI tool (`ic` binary)
    Cli,
    /// Executed from a Lua script (mission/mod)
    LuaScript { script_id: String },
    /// Executed from a WASM module
    WasmModule { module_id: String },
    /// Executed from a configuration file
    ConfigFile { path: String },
}

/// How the player physically invoked the action — the hardware/UI input method.
/// Attached to PlayerOrder (not CommandSource) for replay analysis and APM tracking.
/// This is a SEPARATE concept from CommandOrigin: CommandOrigin tracks WHERE the
/// command was dispatched (chat input, dev console, Lua script); InputSource tracks
/// HOW the player physically triggered it (keyboard shortcut, mouse click, etc.).
///
/// NOTE: InputSource is client-reported and advisory only. A modified open-source
/// client can fake any InputSource value. Replay analysis tools should treat it as
/// a hint, not proof. The relay server can verify ORDER VOLUME (spoofing-proof)
/// but not input source (client-reported). See "Competitive Integrity Principles"
/// § CI-3 below.
pub enum InputSource {
    /// Triggered via a keyboard shortcut / hotkey
    Keybinding,
    /// Triggered via mouse click on the game world or GUI button
    MouseClick,
    /// Typed as a chat/console command (e.g., `/move 120,80`)
    ChatCommand,
    /// Loaded from a config file or .iccmd script on startup
    ConfigFile,
    /// Issued by a Lua or WASM script (mission/mod automation)
    Script,
    /// Touchscreen input (mobile/tablet)
    Touch,
    /// Controller input (Steam Deck, console)
    Controller,
}

pub enum PermissionLevel {
    /// Regular player — chat, help, basic status commands
    Player,
    /// Game host — server config, kick/ban, dev mode toggle
    Host,
    /// Server administrator — full server management
    Admin,
    /// Developer — debug commands, Lua console, fault injection
    Developer,
}

/// A typed argument parser — Brigadier's `ArgumentType&lt;T&gt;` in Rust.
pub trait ArgumentType: Send + Sync {
    type Output;
    fn parse(&amp;self, reader: &amp;mut StringReader) -&gt; Result&lt;Self::Output, CommandError&gt;;
    fn suggest(&amp;self, context: &amp;CommandContext, builder: &amp;mut SuggestionBuilder);
    fn examples(&amp;self) -&gt; &amp;[&amp;str];
}

/// Built-in argument types.
pub struct IntegerArg { pub min: Option&lt;i64&gt;, pub max: Option&lt;i64&gt; }
pub struct FloatArg { pub min: Option&lt;f64&gt;, pub max: Option&lt;f64&gt; }
pub struct StringArg { pub kind: StringKind }  // Word, Quoted, Greedy
pub struct BoolArg;
pub struct PlayerArg;           // autocompletes to connected player names
pub struct UnitTypeArg;         // autocompletes to valid unit type names from YAML rules
pub struct PositionArg;         // parses "x,y" or "x,y,z" coordinates
pub struct ColorArg;            // named color or R,G,B

/// The command dispatcher — shared by chat input, dev console, CLI, and scripts.
pub struct CommandDispatcher {
    root: CommandNode,
}

impl CommandDispatcher {
    /// Register a command. Mods call this via Lua/WASM API.
    pub fn register(&amp;mut self, node: CommandNode);

    /// Parse input into a command + arguments. Does NOT execute.
    pub fn parse(&amp;self, input: &amp;str, source: &amp;CommandSource) -&gt; ParseResult;

    /// Execute a previously parsed command.
    pub fn execute(&amp;self, parsed: &amp;ParseResult) -&gt; CommandResult;

    /// Generate tab-completion suggestions at cursor position.
    pub fn suggest(&amp;self, input: &amp;str, cursor: usize, source: &amp;CommandSource) -&gt; Vec&lt;Suggestion&gt;;

    /// Generate human-readable usage string for a command.
    pub fn usage(&amp;self, command: &amp;str, source: &amp;CommandSource) -&gt; String;
}
<span class="boring">}</span></code></pre>
<p><strong>Permission filtering:</strong> Commands whose root node’s permission requirement exceeds the source’s level are invisible — not shown in <code>/help</code>, not tab-completed, not executable. A regular player never sees <code>/kick</code> or <code>/c</code>. This is Brigadier’s <code>requirement</code> predicate.</p>
<p><strong>Append-only registration:</strong> Mods register commands by adding children to the root node. A mod can also extend existing commands by adding new sub-nodes. Two mods adding <code>/spawn</code> would conflict — the second registration merges into the first’s node, following Brigadier’s merge semantics.</p>
<h4 id="configuration-variables-cvars"><a class="header" href="#configuration-variables-cvars">Configuration Variables (Cvars)</a></h4>
<p>Runtime-configurable values, inspired by Source Engine’s ConVar system but adapted for IC’s YAML-first philosophy:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// A runtime-configurable variable with type, default, bounds, and metadata.
pub struct Cvar {
    pub name: String,                    // dot-separated: "render.shadows", "sim.fog_enabled"
    pub description: String,
    pub value: CvarValue,
    pub default: CvarValue,
    pub flags: CvarFlags,
    pub category: String,                // for grouping in the cvar browser
}

pub enum CvarValue {
    Bool(bool),
    Int(i64),
    Float(f64),
    String(String),
}

bitflags! {
    pub struct CvarFlags: u32 {
        /// Persisted to config file on change
        const PERSISTENT = 0b0001;
        /// Requires dev mode to modify (gameplay-affecting)
        const DEV_ONLY   = 0b0010;
        /// Server-authoritative in multiplayer (clients can't override)
        const SERVER     = 0b0100;
        /// Read-only — informational, cannot be set by commands
        const READ_ONLY  = 0b1000;
    }
}
<span class="boring">}</span></code></pre>
<p><strong>Loading from config file:</strong></p>
<pre><code class="language-toml"># config.toml (user configuration — loaded at startup, saved on change)
[render]
shadows = true
shadow_quality = 2          # 0=off, 1=low, 2=medium, 3=high
vsync = true
max_fps = 144

[audio]
master_volume = 80
music_volume = 60
eva_volume = 100

[gameplay]
scroll_speed = 5
control_group_steal = false
auto_rally_harvesters = true

[net]
show_diagnostics = false        # toggle network overlay (latency, jitter, tick timing)
sync_frequency = 120            # ticks between full state hash checks (SERVER)
# DEV_ONLY parameters — debug builds only:
# desync_debug_level = 0        # 0-3, see 03-NETCODE.md § Debug Levels
# visual_prediction = true       # cosmetic prediction; disable for latency testing
# simulate_latency = 0           # artificial one-way latency (ms)
# simulate_loss = 0.0            # artificial packet loss (%)
# simulate_jitter = 0            # artificial jitter (ms)

[debug]
show_fps = true
show_network_stats = false
</code></pre>
<p>Cvars are the runtime mirror of <code>config.toml</code>. Changing a cvar with <code>PERSISTENT</code> flag writes back to <code>config.toml</code>. Cvars map to the same keys as the TOML config — <code>render.shadows</code> in the cvar system corresponds to <code>[render] shadows</code> in the file. This means <code>config.toml</code> is both the startup configuration file and the serialized cvar state.</p>
<p><strong>Cvar commands:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th><th>Example</th></tr>
</thead>
<tbody>
<tr><td><code>/set &lt;cvar&gt; &lt;value&gt;</code></td><td>Set a cvar</td><td><code>/set render.shadows false</code></td></tr>
<tr><td><code>/get &lt;cvar&gt;</code></td><td>Display current value</td><td><code>/get render.max_fps</code></td></tr>
<tr><td><code>/reset &lt;cvar&gt;</code></td><td>Reset to default</td><td><code>/reset render.shadows</code></td></tr>
<tr><td><code>/find &lt;pattern&gt;</code></td><td>Search cvars by name/description</td><td><code>/find shadow</code></td></tr>
<tr><td><code>/cvars [category]</code></td><td>List all cvars (optionally filtered)</td><td><code>/cvars audio</code></td></tr>
<tr><td><code>/toggle &lt;cvar&gt;</code></td><td>Toggle boolean cvar</td><td><code>/toggle render.vsync</code></td></tr>
</tbody>
</table>
</div>
<p><strong>Sim-affecting cvars</strong> (like fog of war, game speed) use the <code>DEV_ONLY</code> flag and flow through the order pipeline as <code>PlayerOrder::SetCvar(name, value)</code> — deterministic, validated, visible to all clients. Client-only cvars (render settings, audio) take effect immediately without going through the sim.</p>
<h4 id="built-in-commands"><a class="header" href="#built-in-commands">Built-In Commands</a></h4>
<p><strong>Always available (all players):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/help [command]</code></td><td>List commands or show detailed usage for one command</td></tr>
<tr><td><code>/set</code>, <code>/get</code>, <code>/reset</code>, <code>/find</code>, <code>/toggle</code>, <code>/cvars</code></td><td>Cvar manipulation (non-dev cvars only)</td></tr>
<tr><td><code>/version</code></td><td>Display engine version, game module, build info</td></tr>
<tr><td><code>/ping</code></td><td>Show current latency to server</td></tr>
<tr><td><code>/fps</code></td><td>Toggle FPS counter overlay</td></tr>
<tr><td><code>/stats</code></td><td>Show current game statistics (score, resources, etc.)</td></tr>
<tr><td><code>/time</code></td><td>Display current game time (sim tick + wall clock)</td></tr>
<tr><td><code>/clear</code></td><td>Clear chat/console history</td></tr>
<tr><td><code>/players</code></td><td>List connected players</td></tr>
<tr><td><code>/mods</code></td><td>List active mods with versions</td></tr>
</tbody>
</table>
</div>
<p><strong>Chat commands (multiplayer):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td>(no prefix)</td><td>Team chat (default)</td></tr>
<tr><td><code>/s &lt;message&gt;</code></td><td>Shout — all-chat visible to all players and observers</td></tr>
<tr><td><code>/w &lt;player&gt; &lt;message&gt;</code></td><td>Whisper — private message to specific player</td></tr>
<tr><td><code>/r &lt;message&gt;</code></td><td>Reply to last whisper sender</td></tr>
<tr><td><code>/ignore &lt;player&gt;</code></td><td>Hide messages from a player (client-side)</td></tr>
<tr><td><code>/unignore &lt;player&gt;</code></td><td>Restore messages from a player</td></tr>
<tr><td><code>/mute &lt;player&gt;</code></td><td>Admin: prevent player from chatting</td></tr>
<tr><td><code>/unmute &lt;player&gt;</code></td><td>Admin: restore player chat</td></tr>
</tbody>
</table>
</div>
<p><strong>Host/Admin commands (multiplayer):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/kick &lt;player&gt; [reason]</code></td><td>Remove player from game</td></tr>
<tr><td><code>/ban &lt;player&gt; [reason]</code></td><td>Ban player from rejoining</td></tr>
<tr><td><code>/unban &lt;player&gt;</code></td><td>Remove ban</td></tr>
<tr><td><code>/pause</code></td><td>Pause game (requires consent in ranked)</td></tr>
<tr><td><code>/speed &lt;multiplier&gt;</code></td><td>Set game speed (non-ranked only)</td></tr>
<tr><td><code>/config &lt;key&gt; &lt;value&gt;</code></td><td>Change server settings at runtime</td></tr>
</tbody>
</table>
</div>
<p><strong>Developer commands (dev-tools feature flag + DeveloperMode active):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/c &lt;lua&gt;</code></td><td>Execute Lua code (Factorio-style)</td></tr>
<tr><td><code>/sc &lt;lua&gt;</code></td><td>Silent Lua execution (output hidden from other players)</td></tr>
<tr><td><code>/mc &lt;lua&gt;</code></td><td>Measured Lua execution (prints execution time)</td></tr>
<tr><td><code>/give &lt;amount&gt;</code></td><td>Grant credits to your player</td></tr>
<tr><td><code>/spawn &lt;unit_type&gt; [count] [player]</code></td><td>Create units at cursor position</td></tr>
<tr><td><code>/kill</code></td><td>Destroy selected entities</td></tr>
<tr><td><code>/reveal</code></td><td>Remove fog of war</td></tr>
<tr><td><code>/instant_build</code></td><td>Toggle instant construction</td></tr>
<tr><td><code>/invincible</code></td><td>Toggle invincibility for selected units</td></tr>
<tr><td><code>/tp &lt;x,y&gt;</code></td><td>Teleport camera to coordinates</td></tr>
<tr><td><code>/weather &lt;type&gt;</code></td><td>Force weather state (D022). Valid types defined by D022’s weather state machine — e.g., <code>clear</code>, <code>rain</code>, <code>snow</code>, <code>storm</code>, <code>sandstorm</code>; exact set is game-module-specific.</td></tr>
<tr><td><code>/desync_check</code></td><td>Force full-state hash comparison across all clients</td></tr>
<tr><td><code>/save_snapshot</code></td><td>Write sim state snapshot to disk</td></tr>
</tbody>
</table>
</div>
<p><strong>Note on DeveloperMode interaction:</strong> Dev commands check <code>DeveloperMode</code> sim state (V44). In multiplayer, dev mode must be unanimously enabled in the lobby before game start. Dev commands issued without active dev mode are rejected by the sim with an error message. This is enforced at the order validation layer (D012), not the UI layer.</p>
<h4 id="comprehensive-command-catalog"><a class="header" href="#comprehensive-command-catalog">Comprehensive Command Catalog</a></h4>
<p>The design principle: <strong>anything the GUI can do, the console can do.</strong> Every button, menu, slider, and toggle in the game UI has a console command equivalent. This enables scripting via <code>autoexec.cfg</code>, accessibility for players who prefer keyboard-driven interfaces, and full remote control for tournament administration. Commands are organized by functional domain — matching the system categories in <code>02-ARCHITECTURE.md</code>.</p>
<p><strong>Engine-core vs. game-module commands:</strong> Per Invariant #9, the engine core is game-agnostic. Commands are split into two registration layers:</p>
<ul>
<li><strong>Engine commands</strong> (registered by the engine, available to all game modules): <code>/help</code>, <code>/set</code>, <code>/get</code>, <code>/version</code>, <code>/fps</code>, <code>/volume</code>, <code>/screenshot</code>, <code>/camera</code>, <code>/zoom</code>, <code>/ui_scale</code>, <code>/ui_theme</code>, <code>/locale</code>, <code>/save_game</code>, <code>/load_game</code>, <code>/clear</code>, <code>/players</code>, etc. These operate on engine-level concepts (rendering, audio, camera, files, cvars) and exist regardless of game module.</li>
<li><strong>Game-module commands</strong> (registered by the RA1 module via <code>GameModule::register_commands()</code>): <code>/build</code>, <code>/sell</code>, <code>/deploy</code>, <code>/rally</code>, <code>/stance</code>, <code>/guard</code>, <code>/patrol</code>, <code>/power</code>, <code>/credits</code>, <code>/surrender</code>, <code>/power_activate</code>, etc. These operate on RA1-specific gameplay systems — a Dune II module or tower defense total conversion would register different commands. The tables below include both layers; game-module commands are marked with <strong>(RA1)</strong> where the command is game-module-specific rather than engine-generic.</li>
</ul>
<p><strong>Implementation phasing:</strong> This catalog is a <strong>reference target</strong>, not a Phase 3 deliverable. Commands are added incrementally as the systems they control are built — unit commands arrive with Phase 2 (simulation), production/building UI commands with Phase 3 (game chrome), observer commands with Phase 5 (multiplayer), etc. The Brigadier <code>CommandDispatcher</code> and cvar system are Phase 3; the full catalog grows across Phases 3–6.</p>
<p><strong>Unit commands (require selection unless noted) (RA1):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/move &lt;x,y&gt;</code></td><td>Move selected units to world position</td></tr>
<tr><td><code>/attack &lt;x,y&gt;</code></td><td>Attack-move to position</td></tr>
<tr><td><code>/attack_unit &lt;unit_id&gt;</code></td><td>Attack specific target</td></tr>
<tr><td><code>/force_fire &lt;x,y&gt;</code></td><td>Force-fire at ground position (Ctrl+click equivalent)</td></tr>
<tr><td><code>/force_move &lt;x,y&gt;</code></td><td>Force-move, crushing obstacles in path (Alt+click equivalent)</td></tr>
<tr><td><code>/stop</code></td><td>Stop all selected units</td></tr>
<tr><td><code>/guard [unit_id]</code></td><td>Guard selected unit or target unit</td></tr>
<tr><td><code>/patrol &lt;x1,y1&gt; [x2,y2] ...</code></td><td>Set patrol route through waypoints</td></tr>
<tr><td><code>/scatter</code></td><td>Scatter selected units from current position</td></tr>
<tr><td><code>/deploy</code></td><td>Deploy/undeploy selected units (MCV, siege units)</td></tr>
<tr><td><code>/stance &lt;hold_fire|return_fire|defend|attack_anything&gt;</code></td><td>Set engagement stance</td></tr>
<tr><td><code>/load</code></td><td>Load selected infantry into selected transport</td></tr>
<tr><td><code>/unload</code></td><td>Unload all passengers from selected transport</td></tr>
</tbody>
</table>
</div>
<p><strong>Selection commands:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/select &lt;filter&gt;</code></td><td>Select units by filter: <code>all</code>, <code>idle</code>, <code>military</code>, <code>harvesters</code>, <code>damaged</code>, <code>type:&lt;actor_type&gt;</code></td></tr>
<tr><td><code>/deselect</code></td><td>Clear selection</td></tr>
<tr><td><code>/select_all_type</code></td><td>Select all on-screen units matching the currently selected type (double-click equivalent)</td></tr>
<tr><td><code>/group &lt;0-9&gt;</code></td><td>Select control group</td></tr>
<tr><td><code>/group_set &lt;0-9&gt;</code></td><td>Assign current selection to control group (Ctrl+number equivalent)</td></tr>
<tr><td><code>/group_add &lt;0-9&gt;</code></td><td>Add current selection to existing control group (Shift+Ctrl+number)</td></tr>
<tr><td><code>/tab</code></td><td>Cycle through unit types within current selection</td></tr>
<tr><td><code>/find_unit &lt;actor_type&gt;</code></td><td>Center camera on next unit of type (cycles through matches)</td></tr>
<tr><td><code>/find_idle</code></td><td>Center on next idle unit (factory, harvester)</td></tr>
</tbody>
</table>
</div>
<p><strong>Production commands (RA1):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/build &lt;actor_type&gt; [count]</code></td><td>Queue production (default count: 1, or <code>inf</code> for infinite)</td></tr>
<tr><td><code>/cancel &lt;actor_type|all&gt;</code></td><td>Cancel queued production</td></tr>
<tr><td><code>/place &lt;actor_type&gt; &lt;x,y&gt;</code></td><td>Place completed building at position</td></tr>
<tr><td><code>/set_primary [building_id]</code></td><td>Set selected or specified building as primary factory</td></tr>
<tr><td><code>/rally &lt;x,y&gt;</code></td><td>Set rally point for selected production building</td></tr>
<tr><td><code>/pause_production</code></td><td>Pause production queue on selected building</td></tr>
<tr><td><code>/resume_production</code></td><td>Resume paused production queue</td></tr>
<tr><td><code>/queue</code></td><td>Display current production queue contents</td></tr>
</tbody>
</table>
</div>
<p><strong>Building commands (RA1):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/sell</code></td><td>Sell selected building</td></tr>
<tr><td><code>/sell_mode</code></td><td>Toggle sell cursor mode (click buildings to sell)</td></tr>
<tr><td><code>/repair_mode</code></td><td>Toggle repair cursor mode (click buildings to repair)</td></tr>
<tr><td><code>/repair</code></td><td>Toggle auto-repair on selected building</td></tr>
<tr><td><code>/power_down</code></td><td>Toggle power on selected building (disable to save power)</td></tr>
<tr><td><code>/gate_open</code></td><td>Force gate open/closed</td></tr>
</tbody>
</table>
</div>
<p><strong>Economy / resource commands (RA1):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/credits</code></td><td>Display current credits and storage capacity</td></tr>
<tr><td><code>/income</code></td><td>Display income rate, expenditure rate, net flow</td></tr>
<tr><td><code>/power</code></td><td>Display power capacity, drain, and status</td></tr>
<tr><td><code>/silos</code></td><td>Display storage utilization and warn if near capacity</td></tr>
</tbody>
</table>
</div>
<p><strong>Support power commands (RA1):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/power_activate &lt;power_name&gt; &lt;x,y&gt; [target_x,target_y]</code></td><td>Activate support power at position (second position for Chronoshift origin)</td></tr>
<tr><td><code>/paradrop &lt;x,y&gt;</code></td><td>Activate Airfield paradrop at position (plane flies over, drops paratroopers)</td></tr>
<tr><td><code>/powers</code></td><td>List all available support powers with charge status</td></tr>
</tbody>
</table>
</div>
<p><strong>Camera and navigation commands:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/camera &lt;x,y&gt;</code></td><td>Move camera to world position</td></tr>
<tr><td><code>/camera_follow [unit_id]</code></td><td>Follow selected or specified unit</td></tr>
<tr><td><code>/camera_follow_stop</code></td><td>Stop following</td></tr>
<tr><td><code>/bookmark_set &lt;1-9&gt;</code></td><td>Save current camera position to bookmark slot</td></tr>
<tr><td><code>/bookmark &lt;1-9&gt;</code></td><td>Jump to bookmarked camera position</td></tr>
<tr><td><code>/zoom &lt;in|out|level&gt;</code></td><td>Adjust zoom (level: 0.5–4.0, default 1.0; see <code>02-ARCHITECTURE.md</code> § Camera). In ranked/tournament, clamped to the competitive zoom range (default: 0.75–2.0). Zoom-toward-cursor when used with mouse wheel; zoom-toward-center when used via command</td></tr>
<tr><td><code>/center</code></td><td>Center camera on current selection</td></tr>
<tr><td><code>/base</code></td><td>Center camera on construction yard</td></tr>
<tr><td><code>/alert</code></td><td>Jump to last alert position (base under attack, etc.)</td></tr>
</tbody>
</table>
</div>
<p><strong>Camera bookmarks (Generals-style navigation, client-local):</strong> IC formalizes camera bookmarks as a first-class navigation feature on all platforms. Slots <code>1-9</code> are <strong>local UI state only</strong> (not synced, not part of replay determinism, no simulation effect). Desktop exposes quick slots through hotkeys (see <code>17-PLAYER-FLOW.md</code>), while touch layouts expose a minimap-adjacent bookmark dock (tap = jump, long-press = save). The <code>/bookmark_set</code> and <code>/bookmark</code> commands remain the canonical full-slot interface and work consistently across desktop, touch, observer, replay, and editor playtest contexts. Local-only D031 telemetry events (<code>camera_bookmark.set</code>, <code>camera_bookmark.jump</code>) support UX tuning and tutorial hint validation.</p>
<p><strong>Game state commands:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/save_game [name]</code></td><td>Save game (default: auto-named with timestamp)</td></tr>
<tr><td><code>/load_game &lt;name&gt;</code></td><td>Load saved game</td></tr>
<tr><td><code>/restart</code></td><td>Restart current mission/skirmish</td></tr>
<tr><td><code>/surrender</code></td><td>Forfeit current match (alias for <code>/callvote surrender</code> in team games, immediate in 1v1)</td></tr>
<tr><td><code>/gg</code></td><td>Alias for <code>/surrender</code></td></tr>
<tr><td><code>/ff</code></td><td>Alias for <code>/surrender</code> (LoL/Valorant convention)</td></tr>
<tr><td><code>/speed &lt;slowest|slower|normal|faster|fastest&gt;</code></td><td>Set game speed (single-player or host-only)</td></tr>
<tr><td><code>/pause</code></td><td>Toggle pause (single-player instant; multiplayer requires consent)</td></tr>
<tr><td><code>/score</code></td><td>Display current match score (units killed, resources, etc.)</td></tr>
</tbody>
</table>
</div>
<p><strong>Game speed and mobile tempo guidance:</strong> <code>/speed</code> remains the authoritative gameplay command surface for single-player and host-controlled matches. Any mobile “Tempo Advisor” or comfort warning UI is <strong>advisory only</strong> — it may recommend a range (for touch usability) but never changes or blocks the requested speed by itself. Ranked multiplayer continues to use server-enforced speed (see D055/D064 and <code>09b-networking.md</code>).</p>
<p><strong>Vote commands (multiplayer — see <code>03-NETCODE.md</code> § “In-Match Vote Framework”):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/callvote surrender</code></td><td>Propose a surrender vote (team games) or surrender immediately (1v1)</td></tr>
<tr><td><code>/callvote kick &lt;player&gt; &lt;reason&gt;</code></td><td>Propose to kick a teammate (team games only)</td></tr>
<tr><td><code>/callvote remake</code></td><td>Propose to void the match (early game only)</td></tr>
<tr><td><code>/callvote draw</code></td><td>Propose a mutual draw (requires cross-team unanimous agreement)</td></tr>
<tr><td><code>/vote yes</code> (or <code>/vote y</code>)</td><td>Vote yes on the active vote (equivalent to F1)</td></tr>
<tr><td><code>/vote no</code> (or <code>/vote n</code>)</td><td>Vote no on the active vote (equivalent to F2)</td></tr>
<tr><td><code>/vote cancel</code></td><td>Cancel a vote you proposed</td></tr>
<tr><td><code>/vote status</code></td><td>Display the current active vote (if any)</td></tr>
<tr><td><code>/poll &lt;phrase_id|phrase_text&gt;</code></td><td>Propose a tactical poll (non-binding team coordination)</td></tr>
<tr><td><code>/poll agree</code> (or <code>/poll yes</code>)</td><td>Agree with the active tactical poll</td></tr>
<tr><td><code>/poll disagree</code> (or <code>/poll no</code>)</td><td>Disagree with the active tactical poll</td></tr>
</tbody>
</table>
</div>
<p><strong>Audio commands:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/volume &lt;master|music|sfx|voice&gt; &lt;0-100&gt;</code></td><td>Set volume level</td></tr>
<tr><td><code>/mute [master|music|sfx|voice]</code></td><td>Toggle mute (no argument = master)</td></tr>
<tr><td><code>/music_next</code></td><td>Skip to next music track</td></tr>
<tr><td><code>/music_prev</code></td><td>Skip to previous music track</td></tr>
<tr><td><code>/music_stop</code></td><td>Stop music playback</td></tr>
<tr><td><code>/music_play [track_name]</code></td><td>Play specific track (no argument = resume)</td></tr>
<tr><td><code>/eva &lt;on|off&gt;</code></td><td>Toggle EVA voice notifications</td></tr>
<tr><td><code>/music_list</code></td><td>List available music tracks</td></tr>
<tr><td><code>/voice effect list</code></td><td>List available voice effect presets</td></tr>
<tr><td><code>/voice effect set &lt;name&gt;</code></td><td>Apply voice effect preset</td></tr>
<tr><td><code>/voice effect off</code></td><td>Disable voice effects</td></tr>
<tr><td><code>/voice effect preview &lt;name&gt;</code></td><td>Play sample clip with effect applied</td></tr>
<tr><td><code>/voice effect info &lt;name&gt;</code></td><td>Show DSP stages and parameters for preset</td></tr>
<tr><td><code>/voice volume &lt;0-100&gt;</code></td><td>Set incoming voice volume</td></tr>
<tr><td><code>/voice ptt &lt;key&gt;</code></td><td>Set push-to-talk keybind</td></tr>
<tr><td><code>/voice toggle</code></td><td>Toggle voice on/off</td></tr>
<tr><td><code>/voice diag</code></td><td>Open voice diagnostics overlay</td></tr>
<tr><td><code>/voice isolation toggle</code></td><td>Toggle enhanced voice isolation</td></tr>
</tbody>
</table>
</div>
<p><strong>Render and display commands:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/render_mode &lt;classic|remastered|modern&gt;</code></td><td>Switch render mode (D048)</td></tr>
<tr><td><code>/screenshot [filename]</code></td><td>Capture screenshot</td></tr>
<tr><td><code>/shadows &lt;on|off&gt;</code></td><td>Toggle shadow rendering</td></tr>
<tr><td><code>/healthbars &lt;always|selected|damaged|never&gt;</code></td><td>Health bar visibility mode</td></tr>
<tr><td><code>/names &lt;on|off&gt;</code></td><td>Toggle unit name labels</td></tr>
<tr><td><code>/grid &lt;on|off&gt;</code></td><td>Toggle terrain grid overlay</td></tr>
<tr><td><code>/palette &lt;name&gt;</code></td><td>Switch color palette (for classic render mode)</td></tr>
<tr><td><code>/camera_shake &lt;on|off&gt;</code></td><td>Toggle screen shake effects</td></tr>
<tr><td><code>/weather_fx &lt;on|off&gt;</code></td><td>Toggle weather visual effects (rain, snow particles)</td></tr>
<tr><td><code>/post_fx &lt;on|off&gt;</code></td><td>Toggle post-processing effects (bloom, color grading)</td></tr>
</tbody>
</table>
</div>
<p><strong>Observer/spectator commands (observer mode only):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/observe [player_name]</code></td><td>Enter observer mode / follow specific player’s view</td></tr>
<tr><td><code>/observe_free</code></td><td>Free camera (not following any player)</td></tr>
<tr><td><code>/show army</code></td><td>Toggle army composition overlay</td></tr>
<tr><td><code>/show production</code></td><td>Toggle production overlay (what each player is building)</td></tr>
<tr><td><code>/show economy</code></td><td>Toggle economy overlay (income graph)</td></tr>
<tr><td><code>/show powers</code></td><td>Toggle superweapon charge overlay</td></tr>
<tr><td><code>/show score</code></td><td>Toggle score tracker</td></tr>
</tbody>
</table>
</div>
<p><strong>UI control commands:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/minimap &lt;on|off&gt;</code></td><td>Toggle minimap visibility</td></tr>
<tr><td><code>/sidebar &lt;on|off&gt;</code></td><td>Toggle sidebar visibility</td></tr>
<tr><td><code>/tooltip &lt;on|off&gt;</code></td><td>Toggle unit/building tooltips</td></tr>
<tr><td><code>/clock &lt;on|off&gt;</code></td><td>Toggle game clock display</td></tr>
<tr><td><code>/ui_scale &lt;50-200&gt;</code></td><td>Set UI scale percentage</td></tr>
<tr><td><code>/ui_theme &lt;classic|remastered|modern|name&gt;</code></td><td>Switch UI theme (D032)</td></tr>
<tr><td><code>/encyclopedia [actor_type]</code></td><td>Open encyclopedia (optionally to a specific entry)</td></tr>
<tr><td><code>/hotkeys [profile]</code></td><td>Switch hotkey profile (classic, openra, modern) or list current bindings</td></tr>
</tbody>
</table>
</div>
<p><strong>Map interaction commands:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/map_ping &lt;x,y&gt; [color]</code></td><td>Place a map ping visible to allies (with optional color)</td></tr>
<tr><td><code>/map_draw &lt;on|off&gt;</code></td><td>Toggle minimap drawing mode for tactical markup</td></tr>
<tr><td><code>/map_info</code></td><td>Display current map name, size, author, and game mode</td></tr>
</tbody>
</table>
</div>
<p><strong>Localization commands:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>/locale &lt;code&gt;</code></td><td>Switch language (e.g., <code>en</code>, <code>de</code>, <code>zh-CN</code>)</td></tr>
<tr><td><code>/locale_list</code></td><td>List available locales</td></tr>
</tbody>
</table>
</div>
<p><strong>Note:</strong> Commands that affect simulation state (<code>/move</code>, <code>/attack</code>, <code>/build</code>, <code>/sell</code>, <code>/deploy</code>, <code>/stance</code>, <code>/surrender</code>, <code>/callvote</code>, <code>/vote</code>, <code>/poll</code>, etc.) produce <code>PlayerOrder</code> variants and flow through the deterministic order pipeline — they are functionally identical to clicking the GUI button. Commands that affect only the local client (<code>/volume</code>, <code>/shadows</code>, <code>/zoom</code>, <code>/ui_scale</code>, etc.) take effect immediately without touching the sim. This distinction mirrors the cvar split: sim-affecting cvars require <code>DEV_ONLY</code> or <code>SERVER</code> flags and use the order pipeline; client-only cvars are immediate. In multiplayer, sim-affecting commands also respect D033 QoL toggle state — if a toggle is disabled in the lobby, the corresponding console command is rejected. See “Competitive Integrity in Multiplayer” below for the full framework.</p>
<p><strong>PlayerOrder variant taxonomy:</strong> Commands map to <code>PlayerOrder</code> variants as follows:</p>
<ul>
<li><strong>GUI-equivalent commands</strong> (<code>/move</code>, <code>/attack</code>, <code>/build</code>, <code>/sell</code>, <code>/deploy</code>, <code>/stance</code>, <code>/select</code>, <code>/place</code>, etc.) produce the <strong>same native <code>PlayerOrder</code> variant</strong> as their GUI counterpart — e.g., <code>/move 120,80</code> produces <code>PlayerOrder::Move { target: WorldPos(120,80) }</code>, identical to right-clicking the map.</li>
<li><strong>Cvar mutations</strong> (<code>/set &lt;name&gt; &lt;value&gt;</code>) produce <code>PlayerOrder::SetCvar(name, value)</code> when the cvar has <code>DEV_ONLY</code> or <code>SERVER</code> flags — these flow through order validation.</li>
<li><strong>Cheat codes</strong> (hidden phrases typed in chat) produce <code>PlayerOrder::CheatCode(CheatId)</code> — see “Hidden Cheat Codes” below.</li>
<li><strong>Chat messages</strong> (<code>/s</code>, <code>/w</code>, unprefixed text) produce <code>PlayerOrder::ChatMessage { channel, text }</code> — see D059 § Text Chat.</li>
<li><strong>Coordination actions</strong> (pings, chat wheel, minimap drawing) produce their respective <code>PlayerOrder</code> variants (<code>TacticalPing</code>, <code>ChatWheelPhrase</code>, <code>MinimapDraw</code>) — see D059 § Coordination.</li>
<li><strong>Meta-commands</strong> (<code>/help</code>, <code>/locale</code>, <code>/hotkeys</code>, <code>/voice diag</code>, etc.) are <strong>local-only</strong> — they produce no <code>PlayerOrder</code> and never touch the sim.</li>
<li><strong><code>PlayerOrder::ChatCommand(cmd, args)</code></strong> is used only for mod-registered commands that produce custom sim-side effects not covered by a native variant. Engine commands never use <code>ChatCommand</code>.</li>
</ul>
<p><strong>Game-module registration example (RA1):</strong> The RA1 game module registers all RA1-specific commands during <code>GameModule::register_commands()</code>. A Tiberian Dawn module would register similar but distinct commands (e.g., <code>/sell</code> exists in both, but <code>/power_activate</code> with different superweapon names). A total conversion could register entirely novel commands (<code>/mutate</code>, <code>/terraform</code>, etc.) using the same <code>CommandDispatcher</code> infrastructure. This follows the “game is a mod” principle (13-PHILOSOPHY.md § Principle 4) — the base game uses the same registration API available to external modules.</p>
<h4 id="mod-registered-commands"><a class="header" href="#mod-registered-commands">Mod-Registered Commands</a></h4>
<p>Mods register commands via the Lua API (D004) or WASM host functions (D005):</p>
<pre><code class="language-lua">-- Lua mod registration example
Commands.register("spawn_reinforcements", {
    description = "Spawn reinforcements at a location",
    permission = "host",       -- only host can use
    arguments = {
        { name = "faction", type = "string", suggestions = {"allies", "soviet"} },
        { name = "count",   type = "integer", min = 1, max = 50 },
        { name = "location", type = "position" },
    },
    execute = function(source, args)
        -- Mod logic here
        SpawnReinforcements(args.faction, args.count, args.location)
        return "Spawned " .. args.count .. " " .. args.faction .. " reinforcements"
    end
})
</code></pre>
<p><strong>Sandboxing:</strong> Mod commands execute within the same Lua sandbox as mission scripts. A mod command cannot access the filesystem, network, or memory outside its sandbox. The <code>CommandSource</code> tracks which mod registered the command — if a mod command crashes or times out, the error is attributed to the mod, not the engine.</p>
<p><strong>Namespace collision:</strong> Mod commands are prefixed with the mod name by default: a mod named <code>cool_units</code> registering <code>spawn</code> creates <code>/cool_units:spawn</code>. Mods can request unprefixed registration (<code>/spawn</code>) but collisions are resolved by load order — last mod wins, with a warning logged. The convention follows Minecraft’s <code>namespace:command</code> pattern.</p>
<h4 id="anti-trolling-measures"><a class="header" href="#anti-trolling-measures">Anti-Trolling Measures</a></h4>
<p>Chat and commands create trolling surfaces. IC addresses each:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Trolling Vector</th><th>Mitigation</th></tr>
</thead>
<tbody>
<tr><td><strong>Chat spam</strong></td><td>Rate limit: max 5 messages per 3 seconds, relay-enforced (see D059 § Text Chat). Client applies the same limit locally to avoid round-trip rejection. Exceeding the limit queues messages with a cooldown warning. Configurable by server.</td></tr>
<tr><td><strong>Chat harassment</strong></td><td><code>/ignore</code> is client-side and instant. <code>/mute</code> is admin-enforced and server-side. Ignored players can’t whisper you.</td></tr>
<tr><td><strong>Unicode abuse</strong> (oversized chars, RTL overrides, invisible chars, zalgo)</td><td>Chat input is sanitized <strong>before</strong> order injection: strip control characters, normalize Unicode to NFC, cap display width. Normalization happens on the sending client before the text enters <code>PlayerOrder::ChatMessage</code> — ensuring all clients receive identical normalized bytes (determinism requirement). Homoglyph detection warns admins of impersonation attempts.</td></tr>
<tr><td><strong>Command abuse</strong> (admin runs <code>/kill</code> on all players)</td><td>Admin commands that affect other players are logged as telemetry events (D031). Community server governance (D037) allows reputation consequences.</td></tr>
<tr><td><strong>Lua injection</strong> via chat</td><td>Chat messages never touch the command parser unless they start with <code>/</code>. A message like <code>hello /c game.destroy()</code> is plain text, not a command. Only the first <code>/</code> at position 0 triggers command parsing.</td></tr>
<tr><td><strong>Fake command output</strong></td><td>System messages (command results, join/leave notifications) use a distinct visual style (color, icon) that players cannot replicate through chat.</td></tr>
<tr><td><strong>Command spam</strong></td><td>Commands have the same rate limit as chat. Dev commands additionally logged with timestamps for abuse review.</td></tr>
<tr><td><strong>Programmable spam</strong> (Factorio’s speaker problem)</td><td>IC doesn’t have programmable speakers, but any future mod-driven notification system should respect the same per-player mute controls.</td></tr>
</tbody>
</table>
</div>
<h4 id="achievement-and-ranking-interaction"><a class="header" href="#achievement-and-ranking-interaction">Achievement and Ranking Interaction</a></h4>
<p>Following the universal convention (Factorio, AoE, OpenRA):</p>
<ul>
<li><strong>Using any dev command permanently flags the match/save</strong> as using cheats. This is recorded in the replay metadata and sim state.</li>
<li><strong>Flagged games cannot count toward ranked matchmaking (D055)</strong> or achievements (D036).</li>
<li><strong>The flag is irreversible</strong> for that save/match — even if you toggle dev mode off.</li>
<li><strong>Non-dev commands</strong> (<code>/help</code>, <code>/set render.shadows false</code>, chat, <code>/ping</code>) do NOT flag the game. Only commands that affect simulation state through <code>DevCommand</code> orders trigger the flag.</li>
<li><strong>Saved game cheated flag:</strong> The snapshot (D010) includes <code>cheats_used: bool</code> and <code>cosmetic_cheats_used: bool</code> fields. Loading a save with <code>cheats_used = true</code> displays a permanent “cheats used” indicator and disables achievements. Loading a save with only <code>cosmetic_cheats_used = true</code> displays a subtle “cosmetic mods active” indicator but achievements remain enabled. Both flags are irreversible per save and recorded in replay metadata.</li>
</ul>
<p>This follows Factorio’s model — the Lua console is immensely useful for testing and debugging, but using it has clear consequences for competitive integrity — while refining it with a proportional response: gameplay cheats carry full consequences, cosmetic cheats are recorded but don’t punish the player for having fun.</p>
<h4 id="competitive-integrity-in-multiplayer"><a class="header" href="#competitive-integrity-in-multiplayer">Competitive Integrity in Multiplayer</a></h4>
<p>Dev commands and cheat codes are handled. But what about the ~120 <em>normal</em> commands available to every player in multiplayer — <code>/move</code>, <code>/attack</code>, <code>/build</code>, <code>/select</code>, <code>/place</code>? These produce the same <code>PlayerOrder</code> variants as clicking the GUI, but they make external automation trivially easy. A script that sends <code>/select idle</code> → <code>/build harvester</code> → <code>/rally 120,80</code> every 3 seconds is functionally a perfect macro player. Does this create an unfair advantage for scripters?</p>
<h5 id="the-open-source-competitive-dilemma"><a class="header" href="#the-open-source-competitive-dilemma">The Open-Source Competitive Dilemma</a></h5>
<p>This section documents a fundamental, irreconcilable tension that shapes every competitive integrity decision in IC. It is written as a permanent reference for future contributors, so the reasoning does not need to be re-derived.</p>
<p><strong>The dilemma in one sentence:</strong> An open-source game engine cannot prevent client-side cheating, but a competitive community demands competitive integrity.</p>
<p>In a closed-source game (StarCraft 2, CS2, Valorant), the developer controls the client binary. They can:</p>
<ul>
<li>Obfuscate the protocol and memory layout so reverse-engineering is expensive</li>
<li>Deploy kernel-level anti-cheat (Warden, VAC, Vanguard) to detect modified clients</li>
<li>Ban players whose clients fail integrity checks</li>
<li>Update obfuscation faster than hackers can reverse-engineer</li>
</ul>
<p><strong>What commercial anti-cheat products actually do:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Product</th><th>Technique</th><th>How It Works</th><th>Why It Fails for Open-Source GPL</th></tr>
</thead>
<tbody>
<tr><td><strong>VAC</strong> (Valve Anti-Cheat)</td><td>Memory scanning + process hashing</td><td>Scans client RAM for known cheat signatures; hashes game binaries to detect tampering; delayed bans to obscure detection vectors</td><td>Source is public — cheaters know exactly what memory layouts to avoid. Binary hashing is meaningless when every user compiles from source. Delayed bans rely on secrecy of detection methods; GPL eliminates that secrecy.</td></tr>
<tr><td><strong>PunkBuster</strong> (Even Balance)</td><td>Screenshot capture + hash checks + memory scanning</td><td>Takes periodic screenshots to detect overlays/wallhacks; hashes client files; scans process memory for known cheat DLLs</td><td>Screenshots assume a single canonical renderer — IC’s switchable render modes (D048) make “correct” screenshots undefined. Client file hashing fails when users compile their own binaries. GPL means the scanning logic itself is public, trivially bypassed.</td></tr>
<tr><td><strong>EAC / BattlEye</strong></td><td>Kernel-mode driver (ring-0)</td><td>Loads a kernel driver at boot that monitors all system calls, blocks known cheat tools from loading, detects memory manipulation from outside the game process</td><td>Kernel drivers are incompatible with Linux (where they’d need custom kernel modules), impossible on WASM, antithetical to user trust in open-source software, and unenforceable when users can simply remove the driver from source and recompile. Ring-0 access also creates security liability — EAC and BattlEye vulnerabilities have been exploited as privilege escalation vectors.</td></tr>
<tr><td><strong>Vanguard</strong> (Riot Games)</td><td>Always-on kernel driver + client integrity</td><td>Runs from system boot (not just during gameplay); deep system introspection; hardware fingerprinting; client binary attestation</td><td>The most invasive model — requires the developer to be more trusted than the user’s OS. Fundamentally incompatible with GPL’s guarantee that users control their own software. Also requires a dedicated security team maintaining driver compatibility across OS versions — organizations like Riot spend millions annually on this infrastructure.</td></tr>
</tbody>
</table>
</div>
<p>The common thread: every commercial anti-cheat product depends on <strong>information asymmetry</strong> (the developer knows things the cheater doesn’t) or <strong>privilege asymmetry</strong> (the anti-cheat has deeper system access than the cheat). GPL v3 eliminates both. The source code is public. The user controls the binary. These are features, not flaws — but they make client-side anti-cheat a solved impossibility.</p>
<p>None of these are available to IC:</p>
<ul>
<li>The engine is GPL v3 (D051). The source code is public. There is nothing to reverse-engineer — anyone can read the protocol, the order format, and the sim logic directly.</li>
<li>Kernel-level anti-cheat is antithetical to GPL, Linux support, user privacy, and community trust. It is also unenforceable when users can compile their own client.</li>
<li>Client integrity checks are meaningless when the “legitimate” client is whatever the user compiled from source.</li>
<li>Obfuscation is impossible — the source repository IS the documentation.</li>
</ul>
<p><strong>What a malicious player can do</strong> (and no client-side measure can prevent):</p>
<ul>
<li>Read the source to understand exactly what <code>PlayerOrder</code> variants exist and what the sim accepts</li>
<li>Build a modified client that sends orders directly to the relay server, bypassing all GUI and console input</li>
<li>Fake any <code>CommandOrigin</code> tag (<code>Keybinding</code>, <code>MouseClick</code>) to disguise scripted input as human</li>
<li>Automate any action the game allows: perfect split micro, instant building placement, zero-delay production cycling</li>
<li>Implement maphack if fog-of-war is client-side (which is why fog-authoritative mode via the relay is critical — see <code>06-SECURITY.md</code>)</li>
</ul>
<p><strong>What a malicious player cannot do</strong> (architectural defenses that work regardless of client modification):</p>
<ul>
<li>Send orders that fail validation (D012). The sim rejects invalid orders deterministically — every client agrees on the rejection. Modified clients can send orders faster, but they can’t send orders the sim wouldn’t accept from any client.</li>
<li>Spoof their order volume at the relay server (D007). The relay counts orders per player per tick server-side. A modified client can lie about <code>CommandOrigin</code>, but it can’t hide the fact that it sent 500 orders in one tick.</li>
<li>Avoid replay evidence. Every order, every tick, is recorded in the deterministic replay (D010). Post-match analysis can detect inhuman patterns regardless of what the client reported as its input source.</li>
<li>Bypass server-side fog-authoritative mode. When enabled, the relay only forwards entity data within each player’s vision — the client physically doesn’t receive information about units it shouldn’t see.</li>
</ul>
<p><strong>The resolution — what IC chooses:</strong></p>
<p>IC does not fight this arms race. Instead, it adopts a four-part strategy modeled on the most successful open-source competitive platforms (Lichess, FAF, DDNet):</p>
<ol>
<li><strong>Architectural defense.</strong> Make cheating impossible where we can (order validation, relay integrity, fog authority) rather than improbable (obfuscation, anti-tamper). These defenses work even against a fully modified client.</li>
<li><strong>Equalization through features.</strong> When automation provides an advantage, build it into the game as a D033 QoL toggle available to everyone. The script advantage disappears when everyone has the feature.</li>
<li><strong>Total transparency.</strong> Record everything. Expose everything. Every order, every input source, every APM metric, every active script — in the replay and in the lobby. Make scripting visible, not secret.</li>
<li><strong>Community governance.</strong> Let communities enforce their own competitive norms (D037, D052). Engine-enforced rules are minimal and architectural. Social rules — what level of automation is acceptable, what APM patterns trigger investigation — belong to the community.</li>
</ol>
<p>This is the Lichess model applied to RTS. Lichess is fully open-source, cannot prevent engine-assisted play through client-side measures, and is the most successful competitive gaming platform in its genre. Its defense is behavioral analysis (Irwin + Kaladin AI systems), statistical pattern matching, community reporting, and permanent reputation consequences — not client-side policing. IC adapts this approach for real-time strategy: server-side order analysis replaces move-time analysis, APM patterns replace centipawn-loss metrics, and replay review replaces PGN review. See <code>research/minetest-lichess-analysis.md</code> § Lichess for detailed analysis of Lichess’s anti-cheat architecture.</p>
<p><strong>Why documenting this matters:</strong> Without this explicit rationale, future contributors will periodically propose “just add anti-cheat” or “just disable the console in ranked” or “just detect scripts.” These proposals are not wrong because they’re technically difficult — they’re wrong because they’re architecturally impossible in an open-source engine and create a false sense of security that is worse than no protection at all. This dilemma is settled. The resolution is the six principles below.</p>
<h5 id="what-other-games-teach-us"><a class="header" href="#what-other-games-teach-us">What Other Games Teach Us</a></h5>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Game</th><th>Console in MP</th><th>Automation Stance</th><th>Anti-Cheat Model</th><th>Key Lesson for IC</th></tr>
</thead>
<tbody>
<tr><td><strong>StarCraft 2</strong></td><td>No console</td><td>APM is competitive skill — manual micro required</td><td>Warden (kernel, closed-source)</td><td>Works for closed-source; impossible for GPL. SC2 treats mechanical speed as a competitive dimension. IC must decide if it does too</td></tr>
<tr><td><strong>AoE2 DE</strong></td><td>No console</td><td>Added auto-reseed farms, auto-queue — initially controversial, now widely accepted</td><td>Server-side + reporting</td><td>Give automation AS a feature (QoL toggle), not as a script advantage. Community will accept it when everyone has it</td></tr>
<tr><td><strong>SupCom / FAF</strong></td><td>UI mods, SimMods</td><td>Strategy &gt; APM — extensive automation accepted</td><td>Lobby-agreed mods, all visible</td><td>If mods automate, require lobby consent. FAF’s community embraces this because SupCom’s identity is strategic, not mechanical. <strong>All UI mods are listed in the lobby</strong> — every player sees what every other player is running</td></tr>
<tr><td><strong>Factorio</strong></td><td><code>/c</code> Lua in MP — visible to all, flags game</td><td>Blueprints, logistics bots, and circuit networks ARE the automation</td><td>Peer transparency</td><td>Build automation INTO the game as first-class systems. When the game provides it, scripts are unnecessary</td></tr>
<tr><td><strong>CS2</strong></td><td>Full console + autoexec.cfg</td><td>Config/preference commands fine; gameplay macros banned</td><td>VAC (kernel)</td><td>Distinguish <strong>personalization</strong> (sensitivity, crosshair) from <strong>automation</strong> (playing the game for you)</td></tr>
<tr><td><strong>OpenRA</strong></td><td>No console beyond chat</td><td>No scripting API; community self-policing</td><td>Trust + reports</td><td>Works at small scale; doesn’t scale. IC aims larger</td></tr>
<tr><td><strong>Minecraft</strong></td><td>Operator-only in MP</td><td>Redstone and command blocks ARE the automation</td><td>Permission system</td><td>Gate powerful commands behind roles/permissions</td></tr>
<tr><td><strong>Lichess</strong></td><td>N/A (turn-based)</td><td>Cannot prevent engine use — fully open source</td><td>Dual AI analysis (Irwin + Kaladin) + statistical flags + community reports</td><td><strong>The gold standard for open-source competitive integrity.</strong> No client-side anti-cheat at all. Detection is entirely behavioral and server-side. 100M+ games played. Proves the model works at massive scale</td></tr>
<tr><td><strong>DDNet</strong></td><td>No console</td><td>Cooperative game — no adversarial scripting problem</td><td>Optional antibot plugin (relay-side, swappable ABI)</td><td>Server-side behavioral hooks with a swappable plugin architecture. IC’s relay server should support similar pluggable analysis</td></tr>
<tr><td><strong>Minetest</strong></td><td>Server-controlled</td><td>CSM (Client-Side Mod) restriction flags sent by server</td><td>LagPool time-budget + server-side validation</td><td>Server tells client which capabilities are allowed. IC’s WASM capability model is architecturally stronger (capabilities are enforced, not requested), but the flag-based transparency is a good UX pattern</td></tr>
</tbody>
</table>
</div>
<p><strong>The lesson across all of these:</strong> The most successful approach is the Factorio/FAF/Lichess model — build the automation people want INTO the game as features available to everyone, make all actions transparent and auditable, and let communities enforce their own competitive norms. The open-source projects (Lichess, FAF, DDNet, Minetest) all converge on the same insight: <strong>you cannot secure the client, so secure the server and empower the community.</strong></p>
<h5 id="ics-competitive-integrity-principles"><a class="header" href="#ics-competitive-integrity-principles">IC’s Competitive Integrity Principles</a></h5>
<p><strong>CI-1: Console = GUI parity, never superiority.</strong></p>
<p>Every console command must produce exactly the same <code>PlayerOrder</code> as its GUI equivalent. No command may provide capability that the GUI doesn’t offer. This is already the design (noted at the end of the Command Catalog) — this principle makes it an explicit invariant.</p>
<p>Specific implications:</p>
<ul>
<li><code>/select all</code> selects everything in the current <strong>screen viewport</strong>, matching box-select behavior — NOT all units globally, unless the player has them in a control group (which the GUI also supports via D033’s <code>control_group_limit</code>).</li>
<li><code>/build &lt;type&gt; inf</code> (infinite queue) is only available when D033’s <code>multi_queue</code> toggle is enabled in the lobby. If the lobby uses the vanilla preset (<code>multi_queue: false</code>), infinite queuing is rejected.</li>
<li><code>/attack &lt;x,y&gt;</code> (attack-move) is only available when D033’s <code>attack_move</code> toggle is enabled. A vanilla preset lobby rejects it.</li>
<li>Every console command respects the D033 QoL toggle state. <strong>The console is an alternative input method, not a QoL override.</strong></li>
</ul>
<p><strong>CI-2: D033 QoL toggles govern console commands.</strong></p>
<p>Console commands are bound by the same lobby-agreed QoL configuration as GUI actions. When a D033 toggle is disabled:</p>
<ul>
<li>The corresponding console command is rejected with: <code>"[feature] is disabled in this lobby's rule set."</code></li>
<li>The command does not produce a <code>PlayerOrder</code>. It is rejected at the command dispatcher layer, before reaching the order pipeline.</li>
<li>The help text for disabled commands shows their disabled status: <code>"/attack — Attack-move to position [DISABLED: attack_move toggle off]"</code>.</li>
</ul>
<p>This ensures the console cannot bypass lobby agreements. If the lobby chose the vanilla preset, console users get the vanilla feature set.</p>
<p><strong>CI-3: Order rate monitoring, not blocking.</strong></p>
<p>Hard-blocking input rates punishes legitimately fast players (competitive RTS players regularly exceed 300 APM). Instead, IC monitors and exposes:</p>
<ul>
<li><strong>Orders-per-tick tracking.</strong> The sim records orders-per-tick per player in replay metadata. This is always recorded, not opt-in.</li>
<li><strong>Input source tagging.</strong> Each <code>PlayerOrder</code> in the replay includes an <code>InputSource</code> tag: <code>Keybinding</code>, <code>MouseClick</code>, <code>ChatCommand</code>, <code>ConfigFile</code>, <code>Script</code>, <code>Touch</code>, <code>Controller</code>. A player issuing 300 orders/minute via <code>Keybinding</code> and <code>MouseClick</code> is playing fast. A player issuing 300 orders/minute via <code>ChatCommand</code> or <code>Script</code> is scripting. Note: <code>InputSource</code> is client-reported and advisory only — see the <code>InputSource</code> enum definition above.</li>
<li><strong>APM display.</strong> Observers and replay viewers see per-player APM, broken down by input source. This is standard competitive RTS practice (SC2, AoE2, OpenRA all display APM).</li>
<li><strong>Community-configurable thresholds.</strong> Community servers (D052) can define APM alerts or investigation triggers for ranked play. The engine does not hard-enforce these — communities set their own competitive norms. A community that values APM skill sets no cap. A community that values strategy over speed sets a 200 APM soft cap with admin review.</li>
</ul>
<p><strong>Why not hard-block:</strong> In an open-source engine, a modified client can send orders with any <code>CommandOrigin</code> tag — faking <code>Keybinding</code> when actually scripted. Hard-blocking based on unverifiable client-reported data gives a false sense of security. The relay server (D007) can count order volume server-side (where it can’t be spoofed), but the input source tag is client-reported and advisory only.</p>
<p><strong>Note on V17 transport-layer caps:</strong> The <code>ProtocolLimits</code> hard ceilings (256 orders/tick, 4 KB/order — see <code>06-SECURITY.md</code> § V17) still apply as anti-flooding protection at the relay layer. These are not APM caps — they’re DoS prevention. Normal RTS play peaks at 5–10 orders/tick even at professional APM levels, so the 256/tick ceiling is never reached by legitimate play. The distinction: V17 prevents network flooding (relay-enforced, spoofing-proof); Principle 3 here addresses <em>gameplay</em> APM policy (community-governed, not engine-enforced).</p>
<p><strong>CI-4: Automate the thing, not the workaround.</strong></p>
<p>When the community discovers that a script provides an advantage, the correct response is not to ban the script — it’s to build the scripted behavior into the game as a D033 QoL toggle, making it available to everyone with a single checkbox in the lobby settings. Not buried in a config file. Not requiring a Workshop download. Not needing technical knowledge. <strong>A toggle in the settings menu that any player can find and enable.</strong></p>
<p>This is the most important competitive integrity principle for an open-source engine: <strong>if someone has to script it, the game’s UX has failed.</strong> Every popular script is evidence of a feature the game should have provided natively. The script author identified a need; the game should absorb the solution.</p>
<p>The AoE2 DE lesson is the clearest example: auto-reseed farms were a popular mod/script for years. Players who knew about it had an economic advantage — their farms never went idle. Players who didn’t know the script existed fell behind. Forgotten Empires eventually built it into the game as a toggle. Controversy faded immediately. Everyone uses it now. The automation advantage disappeared because it stopped being an advantage — it became a baseline feature.</p>
<p>This principle applies proactively, not just reactively:</p>
<p><strong>Reactive (minimum):</strong> When a Workshop script becomes popular, evaluate it for D033 promotion. The criteria: (a) widely used by script authors, (b) not controversial when available to everyone, (c) reduces tedious repetition without removing strategic decision-making. D037’s governance process (community RFCs) is the mechanism.</p>
<p><strong>Proactive (better):</strong> When designing any system, ask: “will players script this?” If the answer is yes — if there’s a repetitive task that rewards automation — build the automation in from the start. Don’t wait for the scripting community to solve it. Design the feature with a D033 toggle so lobbies can enable or disable it as they see fit.</p>
<p>Examples of automation candidates for IC:</p>
<ul>
<li><strong>Auto-harvest:</strong> Idle harvesters automatically return to the nearest ore field → D033 toggle <code>auto_harvest</code>. Without this, scripts that re-dispatch idle harvesters provide a measurable economic advantage. With the toggle, every player gets perfect harvester management.</li>
<li><strong>Auto-repair:</strong> Damaged buildings near repair facilities automatically start repairing → D033 toggle <code>auto_repair</code>. Eliminates the tedious click-each-damaged-building loop that scripts handle perfectly.</li>
<li><strong>Production auto-repeat:</strong> Re-queue the last built unit type automatically → D033 toggle <code>production_repeat</code>. Prevents the “forgot to queue another tank” problem that scripts never have.</li>
<li><strong>Idle unit alert:</strong> Notification when production buildings have been idle for N seconds → D033 toggle <code>idle_alert</code>. A script can monitor every building simultaneously; a player can’t. The alert makes the information accessible to everyone.</li>
<li><strong>Smart rally:</strong> Rally points that automatically assign new units to the nearest control group → D033 toggle <code>smart_rally</code>. Avoids the need for scripts that intercept newly produced units.</li>
</ul>
<p>These are NOT currently in D033’s catalog — they are examples of both the reactive adoption process and the proactive design mindset. The game should be designed so that someone who has never heard of console scripts or the Workshop has the same access to automation as someone who writes custom <code>.iccmd</code> files.</p>
<p><strong>The accessibility test:</strong> For any automation feature, ask: “Can a player who doesn’t know what a script is get this benefit?” If the answer is no — if the only path to the automation is technical knowledge — the game has created an unfair advantage that favors technical literacy over strategic skill. IC should always be moving toward yes.</p>
<p><strong>CI-5: If you can’t beat them, host them.</strong></p>
<p>Console scripts are shareable on the Workshop (D030) as a first-class resource category. Not reluctantly tolerated — actively supported with the same publishing, versioning, dependency, and discovery infrastructure as maps, mods, and music.</p>
<p>The reasoning is simple: players WILL write automation scripts. In a closed-source engine, that happens underground — in forums, Discord servers, private AutoHotKey configs. The developers can’t see what’s being shared, can’t ensure quality or safety, can’t help users find good scripts, and can’t detect which automations are becoming standard practice. In an open-source engine, the underground is even more pointless — anyone can read the source and write a script trivially.</p>
<p>So instead of pretending scripts don’t exist, IC makes them a Workshop resource:</p>
<ul>
<li><strong>Published scripts are visible.</strong> The development team (and community) can see which automations are popular — direct signal for which behaviors to promote to D033 QoL toggles.</li>
<li><strong>Published scripts are versioned.</strong> When the engine updates, script authors can update their packages. Users get notified of compatibility issues.</li>
<li><strong>Published scripts are sandboxed.</strong> Workshop console scripts are sequences of console commands (<code>.iccmd</code> files), not arbitrary executables. They run through the same <code>CommandDispatcher</code> — they can’t do anything the console can’t do. They’re macros, not programs.</li>
<li><strong>Published scripts are rated and reviewed.</strong> Community quality filtering applies — same as maps, mods, and balance presets.</li>
<li><strong>Published scripts carry lobby disclosure.</strong> In multiplayer, active Workshop scripts are listed in the lobby alongside active mods. All players see what automations each player is running. This is the FAF model — UI mods are visible to all players in the lobby.</li>
<li><strong>Published scripts respect D033 toggles.</strong> A script that issues <code>/attack</code> commands is rejected in a vanilla-preset lobby where <code>attack_move</code> is disabled — just like typing the command manually.</li>
</ul>
<p><strong>Script format — <code>.iccmd</code> files:</strong></p>
<pre><code># auto-harvest.iccmd — Auto-queue harvesters when income drops
# Workshop: community/auto-harvest@1.0.0
# Category: Script Libraries &gt; Economy Automation
# Lobby visibility: shown as active script to all players

@on income_below 500
  /select type:war_factory idle
  /build harvester 1
@end

@on building_idle war_factory 10s
  /build harvester 1
@end
</code></pre>
<p>The <code>.iccmd</code> format is deliberately limited — event triggers + console commands, not a programming language. Complex automation belongs in Lua mods (D004), not console scripts. <strong>Boundary with Lua:</strong> <code>.iccmd</code> triggers are pre-defined patterns (event name + threshold), not arbitrary conditionals. If a script needs <code>if/else</code>, loops, variables, or access to game state beyond trigger parameters, it should be a Lua mod. The triggers shown above (<code>@on income_below</code>, <code>@on building_idle</code>) are the <em>ceiling</em> of <code>.iccmd</code> expressiveness — they fire when a named condition crosses a threshold, nothing more. Event triggers must have a per-trigger cooldown (minimum interval between firings) to prevent rapid-fire order generation — without cooldowns, a trigger that fires every tick could consume the player’s entire order budget (V17: 256 orders/tick hard ceiling) and crowd out intentional commands. The format details are illustrative — final syntax is a Phase 5+ design task.</p>
<p><strong>The promotion pipeline:</strong> Workshop script popularity directly feeds the D033 adoption process:</p>
<ol>
<li><strong>Community creates</strong> — someone publishes <code>auto-harvest.iccmd</code> on the Workshop</li>
<li><strong>Community adopts</strong> — it becomes the most-downloaded script in its category</li>
<li><strong>Community discusses</strong> — D037 RFC: “should auto-harvest be a built-in QoL toggle?”</li>
<li><strong>Design team evaluates</strong> — does it reduce tedium without removing decisions?</li>
<li><strong>Engine absorbs</strong> — if yes, it becomes <code>D033 toggle auto_harvest</code>, the Workshop script becomes redundant, and the community moves on to the next automation frontier</li>
</ol>
<p>This is how healthy open-source ecosystems work. npm packages become Node.js built-ins. Popular Vim plugins become Neovim defaults. Community Firefox extensions become browser features. The Workshop is IC’s proving ground for automation features.</p>
<p><strong>CI-6: Transparency over restriction.</strong></p>
<p>Every action a player takes is recorded in the replay — including the commands they used and their input source. The community can see exactly how each player played. This is the most powerful competitive integrity tool available to an open-source project:</p>
<ul>
<li>Post-match replays show full APM breakdown with input source tags</li>
<li>Tournament casters can display “console commands used” alongside APM</li>
<li>Community server admins can review flagged matches</li>
<li>The community decides what level of automation is acceptable for their competitive scene</li>
</ul>
<p>This mirrors how chess handles engine cheating online: no client can be fully trusted, so the detection is behavioral/statistical, reviewed by humans or automated analysis, and enforced by the community.</p>
<h5 id="player-transparency--what-players-see"><a class="header" href="#player-transparency--what-players-see">Player Transparency — What Players See</a></h5>
<p>Principle 6 states transparency over restriction. This subsection specifies exactly what players see — the concrete UX that makes automation visible rather than hidden.</p>
<p><strong>Lobby (pre-game):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Element</th><th>Visibility</th></tr>
</thead>
<tbody>
<tr><td><strong>Active mods</strong></td><td>All loaded mods listed per player (name + version). Mismatches highlighted. Same model as Factorio/FAF</td></tr>
<tr><td><strong>Active <code>.iccmd</code> scripts</strong></td><td>Workshop scripts listed by name with link to Workshop page. Custom (non-Workshop) scripts show “Local script”</td></tr>
<tr><td><strong>QoL preset</strong></td><td>Player’s active experience profile (D033) displayed — e.g., “OpenRA Purist,” “IC Standard,” or custom</td></tr>
<tr><td><strong>D033 toggles summary</strong></td><td>Expandable panel: which automations are enabled (auto-harvest, auto-repair, production repeat, idle alerts, etc.)</td></tr>
<tr><td><strong>Input devices</strong></td><td>Not shown — input hardware is private. Only the <em>commands issued</em> are tracked, not the device</td></tr>
</tbody>
</table>
</div>
<p>The lobby is the first line of defense against surprise: if your opponent has auto-repair and production repeat enabled, you see that <em>before</em> clicking Ready. This is the FAF model — every UI mod is listed in the lobby, and opponents can inspect the full list.</p>
<p><strong>In-game HUD:</strong></p>
<ul>
<li><strong>No real-time script indicators for opponents.</strong> Showing “Player 2 is using a script” mid-game would be distracting, potentially misleading (is auto-harvest a “script” or a QoL toggle?), and would create incentive to game the indicator. The lobby disclosure is sufficient.</li>
<li><strong>Own-player indicators:</strong> Your own enabled automations appear as small icons near the minimap (same UI surface as stance icons). You see what <em>you</em> have active, always.</li>
<li><strong>Observer/caster mode:</strong> Observers and casters see a per-player APM counter with source breakdown (GUI clicks vs. console commands vs. script-issued orders). This is a spectating feature, not a player-facing one — competitive players don’t get distracted, but casters can narrate automation differences.</li>
</ul>
<p><strong>Post-match score screen:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Metric</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><strong>APM (total)</strong></td><td>Raw actions per minute, standard RTS metric</td></tr>
<tr><td><strong>APM by source</strong></td><td>Breakdown: GUI / console / <code>.iccmd</code> script / config file. Shows how each player issued orders</td></tr>
<tr><td><strong>D033 toggles active</strong></td><td>Which automations were enabled during the match</td></tr>
<tr><td><strong>Workshop scripts active</strong></td><td>Named list of <code>.iccmd</code> scripts used, with Workshop links</td></tr>
<tr><td><strong>Order volume graph</strong></td><td>Timeline of orders-per-second, color-coded by source — spikes from scripts are visually obvious</td></tr>
</tbody>
</table>
</div>
<p>The post-match screen answers “how did they play?” without judgment. A player who used auto-repair and a build-order script can be distinguished from one who micro’d everything manually — but neither is labeled “cheater.” The community decides what level of automation they respect.</p>
<p><strong>Replay viewer:</strong></p>
<ul>
<li>Full command log with <code>CommandOrigin</code> tags (GUI, Console, Script, ConfigFile)</li>
<li>APM timeline graph with source-coded coloring</li>
<li>Script execution markers on the timeline (when each <code>.iccmd</code> trigger fired)</li>
<li>Exportable match data (JSON/CSV) for community statistical analysis tools</li>
<li>Same observer APM overlay available during replay playback</li>
</ul>
<p><strong>Why no “script detected” warnings?</strong></p>
<p>The user asked: “should we do something to let players know scripts are in use?” The answer is: yes — <em>before the game starts</em> (lobby) and <em>after it ends</em> (score screen, replay), but <em>not during the game</em>. Mid-game warnings create three problems:</p>
<ol>
<li><strong>Classification ambiguity.</strong> Where is the line between “D033 QoL toggle” and “script”? Auto-harvest is engine-native. A <code>.iccmd</code> that does the same thing is functionally identical. Warning about one but not the other is arbitrary.</li>
<li><strong>False security.</strong> A warning that says “no scripts detected” when running an open-source client is meaningless — any modified client can suppress the flag. The lobby disclosure is opt-in honesty backed by replay verification, not a trust claim.</li>
<li><strong>Distraction.</strong> Players should focus on playing, not monitoring opponent automation status. Post-match review is the right time for analysis.</li>
</ol>
<p><strong>Lessons from open-source games on client trust:</strong></p>
<p>The comparison table above includes Lichess, DDNet, and Minetest. The cross-cutting lesson from all open-source competitive games:</p>
<ul>
<li><strong>You cannot secure the client.</strong> Any GPL codebase can be modified to lie about anything client-side. Lichess knows this — their entire anti-cheat (Irwin + Kaladin) is server-side behavioral analysis. DDNet’s antibot plugin runs server-side. Minetest’s CSM restriction flags are server-enforced.</li>
<li><strong>Embrace the openness.</strong> Rather than fighting modifications, make the <em>legitimate</em> automation excellent so there’s no incentive to use shady external tools. Factorio’s mod system is so good that cheating is culturally irrelevant. FAF’s sim mod system is so transparent that the community self-polices.</li>
<li><strong>The server is the only trust boundary.</strong> Order validation (D012), relay-side order counting (D007), and replay signing (D052) are the real anti-cheat. Client-side anything is theater.</li>
</ul>
<p>IC’s position: we don’t pretend the client is trustworthy. We make automation visible, accessible, and community-governed — then let the server and the replay be the source of truth.</p>
<h5 id="ranked-mode-restrictions"><a class="header" href="#ranked-mode-restrictions">Ranked Mode Restrictions</a></h5>
<p>Ranked matchmaking (D055) enforces additional constraints beyond casual play:</p>
<ul>
<li><strong>DeveloperMode is unavailable.</strong> The lobby option is hidden in ranked queue — dev commands cannot be enabled.</li>
<li><strong>Mod commands require ranked certification.</strong> Community servers (D052) maintain a whitelist of mod commands approved for ranked play. Uncertified mod commands are rejected in ranked matches. The default: only engine-core commands are permitted; game-module commands (those registered by the built-in game module, e.g., RA1) are permitted; third-party mod commands require explicit whitelist entry.</li>
<li><strong>Order volume is recorded server-side.</strong> The relay server counts orders per player per tick. This data is included in match certification (D055) and available for community review. It cannot be spoofed by modified clients.</li>
<li><strong><code>autoexec.cfg</code> commands execute normally.</strong> Cvar-setting commands (<code>/set</code>, <code>/get</code>, <code>/toggle</code>) from autoexec execute as preferences. Gameplay commands (<code>/build</code>, <code>/move</code>, etc.) from autoexec are rejected in ranked — <code>CommandOrigin::ConfigFile</code> is not a valid origin for sim-affecting orders in ranked mode. You can set your sensitivity in autoexec; you can’t script your build order.</li>
<li><strong>Zoom range is clamped.</strong> The competitive zoom range (default: 0.75–2.0) overrides the render mode’s <code>CameraConfig.zoom_min/zoom_max</code> (see <code>02-ARCHITECTURE.md</code> § “Camera System”) in ranked matches. This prevents extreme zoom-out from providing disproportionate map awareness. The default range is configured per ranked queue by the competitive committee (D037) and stored in the seasonal ranked configuration YAML. Tournament organizers can set their own zoom range via <code>TournamentConfig</code>. The <code>/zoom</code> command respects these bounds.</li>
</ul>
<h5 id="tournament-mode"><a class="header" href="#tournament-mode">Tournament Mode</a></h5>
<p>Tournament organizers (via community server administration, D052) can enable a stricter <strong>tournament mode</strong> in the lobby:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Restriction</th><th>Effect</th><th>Rationale</th></tr>
</thead>
<tbody>
<tr><td><strong>Command whitelist</strong></td><td>Only whitelisted commands accepted; all others rejected</td><td>Organizers control exactly which console commands are legal</td></tr>
<tr><td><strong>ConfigFile gameplay rejection</strong></td><td><code>autoexec.cfg</code> sim-affecting commands rejected (same as ranked)</td><td>Level playing field — no pre-scripted build orders</td></tr>
<tr><td><strong>Input source logging</strong></td><td>All <code>CommandOrigin</code> tags recorded in match data, visible to admins</td><td>Post-match review for scripting investigation</td></tr>
<tr><td><strong>APM cap (optional)</strong></td><td>Configurable orders-per-minute soft cap; exceeding triggers admin alert, not hard block</td><td>Communities that value strategy over APM can set limits</td></tr>
<tr><td><strong>Forced replay recording</strong></td><td>Match replay saved automatically; both players receive copies</td><td>Evidence for dispute resolution</td></tr>
<tr><td><strong>No mod commands</strong></td><td>Third-party mod commands disabled entirely</td><td>Pure vanilla/IC experience for competition</td></tr>
<tr><td><strong>Workshop scripts (configurable)</strong></td><td>Organizer chooses: allow all, whitelist specific scripts, or disable all <code>.iccmd</code> scripts</td><td>Some tournaments embrace automation (FAF-style); others require pure manual play. Organizer’s call</td></tr>
</tbody>
</table>
</div>
<p>Tournament mode is a superset of ranked restrictions — it’s ranked plus organizer-defined rules. The <code>CommandDispatcher</code> checks a <code>TournamentConfig</code> resource (if present) before executing any command.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Additional Tournament Option</th><th>Effect</th><th>Default</th></tr>
</thead>
<tbody>
<tr><td><strong>Zoom range override</strong></td><td>Custom min/max zoom bounds</td><td>Same as ranked (0.75–2.0)</td></tr>
<tr><td><strong>Resolution cap</strong></td><td>Maximum horizontal resolution for game viewport</td><td>Disabled (no cap)</td></tr>
<tr><td><strong>Weather sim effects</strong></td><td>Force <code>sim_effects: false</code> on all maps</td><td>Off (use map’s setting)</td></tr>
</tbody>
</table>
</div>
<h5 id="visual-settings--competitive-fairness"><a class="header" href="#visual-settings--competitive-fairness">Visual Settings &amp; Competitive Fairness</a></h5>
<p>Client-side visual settings — <code>/weather_fx</code>, <code>/shadows</code>, graphics quality presets, and render quality tiers — can affect battlefield visibility. A player who disables weather particles sees more clearly during a storm; a player on Low shadows has cleaner unit silhouettes.</p>
<p>This is a <strong>conscious design choice, not an oversight.</strong> Nearly every competitive game exhibits this pattern: CS2 players play on low settings for visibility, SC2 players minimize effects for performance. The access is symmetric (every player can toggle the same settings), the tradeoff is aesthetics vs. clarity, and restricting visual preferences would be hostile to players on lower-end hardware who <em>need</em> reduced effects to maintain playable frame rates.</p>
<p><strong>Resolution and aspect ratio</strong> follow the same principle. A 32:9 ultrawide player sees more horizontal area than a 16:9 player. In an isometric RTS, this advantage is modest — the sidebar and minimap consume significant screen space, and the critical information (unit positions, fog of war) is available to all players via the minimap regardless of viewport size. Restricting resolution would punish players for their hardware. Tournament organizers can set resolution caps via <code>TournamentConfig</code> if their ruleset demands hardware parity, but engine-level ranked play does not restrict this.</p>
<p><strong>Principle:</strong> Visual settings that are universally accessible, symmetrically available, and involve a meaningful aesthetic tradeoff are not restricted. Settings that provide information not available to other players (hypothetical: a shader that reveals cloaked units) would be restricted. The line is <strong>information equivalence</strong>, not visual equivalence.</p>
<h5 id="what-we-explicitly-do-not-do"><a class="header" href="#what-we-explicitly-do-not-do">What We Explicitly Do NOT Do</a></h5>
<ul>
<li><strong>No kernel anti-cheat.</strong> Warden, VAC, Vanguard, EasyAntiCheat — none of these are compatible with GPL, Linux, community trust, or open-source principles. We accept that the client cannot be trusted and design our competitive integrity around server-side verification and community governance instead.</li>
<li><strong>No hard APM cap for all players.</strong> Fast players exist. Punishing speed punishes skill. APM is monitored and exposed, not limited (except in tournament mode where organizers opt in).</li>
<li><strong>No “you used the console, achievements disabled” for non-dev commands.</strong> Typing <code>/move 100,200</code> instead of right-clicking is a UX preference, not cheating. Only dev commands trigger the cheat flag.</li>
<li><strong>No script detection heuristics in the engine.</strong> Attempting to distinguish “human typing fast” from “script typing” is an arms race the open-source side always loses. Detection belongs to the community layer (replay review, statistical analysis), not the engine layer.</li>
<li><strong>No removal of the console in multiplayer.</strong> The console is an accessibility and power-user feature. Removing it doesn’t prevent scripting (external tools exist); it just removes a legitimate interface. The answer to automation isn’t removing tools — it’s making the automation available to everyone (D033) and transparent to the community (replays).</li>
</ul>
<h5 id="cross-reference-summary"><a class="header" href="#cross-reference-summary">Cross-Reference Summary</a></h5>
<ul>
<li><strong>D012 (Order Validation):</strong> The architectural defense — every <code>PlayerOrder</code> is validated by the sim regardless of origin. Invalid orders are rejected deterministically.</li>
<li><strong>D007 (Relay Server):</strong> Server-side order counting cannot be spoofed by modified clients. The relay sees the real order volume.</li>
<li><strong>D030 (Workshop):</strong> Console scripts are a first-class Workshop resource category. Visibility, versioning, and community review make underground scripting unnecessary. Popular scripts feed the D033 promotion pipeline.</li>
<li><strong>D033 (QoL Toggles):</strong> The great equalizer — when automation becomes standard community practice, promote it to a QoL toggle so everyone benefits equally. Workshop script popularity is the primary signal for which automations to promote.</li>
<li><strong>D037 (Community Governance):</strong> Communities define their own competitive norms via RFCs. APM policies, script policies, and tournament rules are community decisions, not engine-enforced mandates.</li>
<li><strong>D052 (Community Servers):</strong> Server operators configure ranked restrictions, tournament mode, and mod command whitelists.</li>
<li><strong>D055 (Ranked Tiers):</strong> Ranked mode automatically applies the competitive integrity restrictions described above.</li>
<li><strong>D048 (Render Modes):</strong> Information equivalence guarantee — all render modes display identical game-state information. See D048 § “Information Equivalence Across Render Modes.”</li>
<li><strong>D022 (Weather):</strong> Weather sim effects on ranked maps are a map pool curation concern — see D055 § “Map pool curation guidelines.”</li>
<li><strong>D018 (Experience Profiles):</strong> Profile locking table specifies which axes are fixed in ranked. See D018 § profile locking table.</li>
</ul>
<h4 id="classic-cheat-codes-single-player-easter-egg"><a class="header" href="#classic-cheat-codes-single-player-easter-egg">Classic Cheat Codes (Single-Player Easter Egg)</a></h4>
<p><strong>Phase:</strong> Phase 3+ (requires command system; trivial to implement once <code>CheatCodeHandler</code> and <code>PlayerOrder::CheatCode</code> exist — each cheat reuses existing dev command effects).</p>
<p>A hidden, undocumented homage to the golden age of cheat codes and trainers. In single-player, the player can type certain phrases into the chat input — no <code>/</code> prefix needed — and trigger hidden effects. These are never listed in <code>/help</code>, never mentioned in any in-game documentation, and never exposed through the UI. They exist for the community to discover, share, and enjoy — exactly like AoE2’s “how do you turn this on” or StarCraft’s “power overwhelming.”</p>
<p><strong>Design principles:</strong></p>
<ol>
<li>
<p><strong>Single-player only.</strong> Cheat phrases are ignored entirely in multiplayer — the <code>CheatCodeHandler</code> is not even registered as a system when <code>NetworkModel</code> is anything other than <code>LocalNetwork</code>. No server-side processing, no network traffic, no possibility of multiplayer exploitation.</p>
</li>
<li>
<p><strong>Undocumented.</strong> Not in <code>/help</code>. Not in the encyclopedia. Not in any in-game tooltip or tutorial. The game’s official documentation does not acknowledge their existence. Community wikis and word-of-mouth are the discovery mechanism — just like the originals.</p>
</li>
<li>
<p><strong>Hashed, not plaintext.</strong> Cheat phrase strings are stored as pre-computed hashes in the binary, not as plaintext string literals. Casual inspection of the binary or source code does not trivially reveal all cheats. This is a speed bump, not cryptographic security — determined data-miners will find them, and that’s fine. The goal is to preserve the discovery experience, not to make them impossible to find.</p>
</li>
<li>
<p><strong>Two-tier achievement-flagging.</strong> Not all cheats are equal — disco palette cycling doesn’t affect competitive integrity the same way infinite credits does. IC uses a two-tier cheat classification:</p>
<ul>
<li><strong>Gameplay cheats</strong> (invincibility, instant build, free credits, reveal map, etc.) permanently set <code>cheats_used = true</code> on the save/match. Achievements (D036) are disabled. Same rules as dev commands.</li>
<li><strong>Cosmetic cheats</strong> (palette effects, visual gags, camera tricks, audio swaps) set <code>cosmetic_cheats_used = true</code> but do NOT disable achievements or flag the save as “cheated.” They are recorded in replay metadata for transparency but carry no competitive consequence.</li>
</ul>
<p>The litmus test: <strong>does this cheat change the simulation state in a way that affects win/loss outcomes?</strong> If yes → gameplay cheat. If it only touches rendering, audio, or visual effects with zero sim impact → cosmetic cheat. Edge cases default to gameplay (conservative). The classification is per-cheat, defined in the game module’s cheat table (the <code>CheatFlags</code> field below).</p>
<p>This is more honest than a blanket flag. Punishing a player for typing “kilroy was here” the same way you punish them for infinite credits is disproportionate — it discourages the fun, low-stakes cheats that are the whole point of the system.</p>
</li>
<li>
<p><strong>Thematic.</strong> Phrases are Cold War themed, fitting the Red Alert setting, and extend to C&amp;C franchise cultural moments and cross-game nostalgia. Each cheat has a brief, in-character confirmation message displayed as an EVA notification — no generic “cheat activated” text. Naming follows the narrative identity principle: earnest commitment, never ironic distance (Principle #20, <a href="13-PHILOSOPHY.html">13-PHILOSOPHY.md</a>). Even hidden mechanisms carry the world’s flavor.</p>
</li>
<li>
<p><strong>Fun first.</strong> Some cheats are practical (infinite credits, invincibility). Others are purely cosmetic silliness (visual effects, silly unit behavior). The two-tier flagging (principle 4 above) ensures cosmetic cheats don’t carry disproportionate consequences — players can enjoy visual gags without losing achievement progress.</p>
</li>
</ol>
<p><strong>Implementation:</strong></p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Handles hidden cheat code activation in single-player.
/// Registered ONLY when NetworkModel is LocalNetwork (single-player / skirmish vs AI).
/// Checked BEFORE the CommandDispatcher — if input matches a known cheat hash,
/// the cheat is activated and the input is consumed (never reaches chat or command parser).
pub struct CheatCodeHandler {
    /// Pre-computed FNV-1a hashes of cheat phrases (lowercased, trimmed).
    /// Using hashes instead of plaintext prevents casual string extraction from the binary.
    /// Map: hash → CheatEntry (id + flags).
    known_hashes: HashMap&lt;u64, CheatEntry&gt;,
    /// Currently active toggle cheats (invincibility, instant build, etc.).
    active_toggles: HashSet&lt;CheatId&gt;,
}

pub struct CheatEntry {
    pub id: CheatId,
    pub flags: CheatFlags,
}

bitflags! {
    /// Per-cheat classification. Determines achievement/ranking consequences.
    pub struct CheatFlags: u8 {
        /// Affects simulation state (credits, health, production, fog, victory).
        /// Sets `cheats_used = true` — disables achievements and ranked submission.
        const GAMEPLAY = 0b01;
        /// Affects only rendering, audio, or camera — zero sim impact.
        /// Sets `cosmetic_cheats_used = true` — recorded in replay but no competitive consequence.
        const COSMETIC = 0b10;
    }
}

impl CheatCodeHandler {
    /// Called from InputSource processing pipeline, BEFORE command dispatch.
    /// Returns true if input was consumed as a cheat code.
    pub fn try_activate(&amp;mut self, input: &amp;str) -&gt; Option&lt;CheatActivation&gt; {
        let normalized = input.trim().to_lowercase();
        let hash = fnv1a_hash(normalized.as_bytes());
        if let Some(&amp;cheat_id) = self.known_hashes.get(&amp;hash) {
            Some(CheatActivation {
                cheat_id,
                // Produces a PlayerOrder::CheatCode(cheat_id) that flows through
                // the sim's order pipeline — deterministic, snapshottable, replayable.
                order: PlayerOrder::CheatCode(cheat_id),
            })
        } else {
            None
        }
    }
}

/// Cheat activation produces a PlayerOrder — the sim handles it deterministically.
/// This means cheats are: (a) snapshottable (D010), (b) replayable, (c) validated
/// (the sim rejects CheatCode orders when not in single-player mode).
pub enum PlayerOrder {
    // ... existing variants ...
    CheatCode(CheatId),
}
<span class="boring">}</span></code></pre>
<p><strong>Processing flow:</strong> Chat input → <code>CheatCodeHandler::try_activate()</code> → if match, produce <code>PlayerOrder::CheatCode</code> → order pipeline → sim validates (single-player only) → check <code>CheatFlags</code>: if <code>GAMEPLAY</code>, set <code>cheats_used = true</code>; if <code>COSMETIC</code>, set <code>cosmetic_cheats_used = true</code> → apply effect → EVA confirmation notification. If no match, input falls through to normal chat/command dispatch.</p>
<p><strong>Note on chat swallowing:</strong> If a player types a cheat phrase (e.g., “iron curtain”) as normal chat, it is consumed as a cheat activation — the text is NOT sent as a chat message. This is <strong>intentional and by design</strong>: cheat codes only activate in single-player mode (multiplayer rejects <code>CheatCode</code> orders), and the hidden-phrase discovery mechanic requires that the input be consumed on match. Players in single-player who accidentally trigger a cheat receive an EVA confirmation that makes the activation obvious, and all cheats are toggleable (can be deactivated by typing the phrase again).</p>
<p><strong>Cheat codes (RA1 game module examples):</strong></p>
<p><em>Trainer-style cheats (gameplay-affecting — <code>GAMEPLAY</code> flag, disables achievements):</em></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Phrase</th><th>Effect</th><th>Type</th><th>Flags</th><th>Confirmation</th></tr>
</thead>
<tbody>
<tr><td><code>perestroika</code></td><td>Reveal entire map permanently</td><td>One-shot</td><td><code>GAMEPLAY</code></td><td>“Transparency achieved.”</td></tr>
<tr><td><code>glasnost</code></td><td>Remove fog of war permanently (live vision of all units)</td><td>One-shot</td><td><code>GAMEPLAY</code></td><td>“Nothing to hide, comrade.”</td></tr>
<tr><td><code>iron curtain</code></td><td>Toggle invincibility for all your units</td><td>Toggle</td><td><code>GAMEPLAY</code></td><td>“Your forces are shielded.” / “Shield lowered.”</td></tr>
<tr><td><code>five year plan</code></td><td>Toggle instant build (all production completes in 1 tick)</td><td>Toggle</td><td><code>GAMEPLAY</code></td><td>“Plan accelerated.” / “Plan normalized.”</td></tr>
<tr><td><code>surplus</code></td><td>Grant 10,000 credits (repeatable)</td><td>Repeatable</td><td><code>GAMEPLAY</code></td><td>“Economic stimulus approved.”</td></tr>
<tr><td><code>marshall plan</code></td><td>Max out credits + complete all queued production instantly</td><td>One-shot</td><td><code>GAMEPLAY</code></td><td>“Full economic mobilization.”</td></tr>
<tr><td><code>mutual assured destruction</code></td><td>All superweapons fully charged</td><td>Repeatable</td><td><code>GAMEPLAY</code></td><td>“Launch readiness confirmed.”</td></tr>
<tr><td><code>arms race</code></td><td>All current units gain elite veterancy</td><td>One-shot</td><td><code>GAMEPLAY</code></td><td>“Accelerated training complete.”</td></tr>
<tr><td><code>not a step back</code></td><td>Toggle +100% fire rate and +50% damage for all your units</td><td>Toggle</td><td><code>GAMEPLAY</code></td><td>“Order 227 issued.” / “Order rescinded.”</td></tr>
<tr><td><code>containment</code></td><td>All enemy units frozen in place for 30 seconds</td><td>Repeatable</td><td><code>GAMEPLAY</code></td><td>“Enemies contained.”</td></tr>
<tr><td><code>scorched earth</code></td><td>Next click drops a nuke at cursor position (one-use per activation)</td><td>One-use</td><td><code>GAMEPLAY</code></td><td>“Strategic asset available. Select target.”</td></tr>
<tr><td><code>red october</code></td><td>Spawn a submarine fleet at nearest water body</td><td>One-shot</td><td><code>GAMEPLAY</code></td><td>“The fleet has arrived.”</td></tr>
<tr><td><code>from russia with love</code></td><td>Spawn a Tanya at cursor position</td><td>Repeatable</td><td><code>GAMEPLAY</code></td><td>“Special operative deployed.”</td></tr>
<tr><td><code>new world order</code></td><td>Instant victory</td><td>One-shot</td><td><code>GAMEPLAY</code></td><td>“Strategic dominance achieved.”</td></tr>
<tr><td><code>better dead than red</code></td><td>Instant defeat (you lose)</td><td>One-shot</td><td><code>GAMEPLAY</code></td><td>“Surrender accepted.”</td></tr>
<tr><td><code>dead hand</code></td><td>Automated retaliation: when your last building dies, all enemy units on the map take massive damage</td><td>Persistent</td><td><code>GAMEPLAY</code></td><td>“Automated retaliation system armed. They cannot win without losing.”</td></tr>
<tr><td><code>mr gorbachev</code></td><td>Destroys every wall segment on the map (yours and the enemy’s)</td><td>One-shot</td><td><code>GAMEPLAY</code></td><td>“Tear down this wall!”</td></tr>
<tr><td><code>domino theory</code></td><td>When an enemy unit dies, adjacent enemies take 25% of the killed unit’s max HP. Chain reactions possible</td><td>Toggle</td><td><code>GAMEPLAY</code></td><td>“One falls, they all fall.” / “Containment restored.”</td></tr>
<tr><td><code>wolverines</code></td><td>All infantry deal +50% damage (Red Dawn, 1984)</td><td>Toggle</td><td><code>GAMEPLAY</code></td><td>“WOLVERINES!” / “Stand down, guerrillas.”</td></tr>
<tr><td><code>berlin airlift</code></td><td>A cargo plane drops 5 random crates across your base</td><td>Repeatable</td><td><code>GAMEPLAY</code></td><td>“Supply drop inbound.”</td></tr>
<tr><td><code>how about a nice game of chess</code></td><td>AI difficulty drops to minimum (WarGames, 1983)</td><td>One-shot</td><td><code>GAMEPLAY</code></td><td>“A strange game. The only winning move is not to play. …But let’s play anyway.”</td></tr>
<tr><td><code>trojan horse</code></td><td>Your next produced unit appears with enemy colors. Enemies ignore it until it fires</td><td>One-use</td><td><code>GAMEPLAY</code></td><td>“Infiltrator ready. They won’t see it coming.”</td></tr>
</tbody>
</table>
</div>
<p><em>Cosmetic / fun cheats (visual-only — <code>COSMETIC</code> flag, achievements remain enabled):</em></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Phrase</th><th>Effect</th><th>Type</th><th>Flags</th><th>Confirmation</th></tr>
</thead>
<tbody>
<tr><td><code>party like its 1946</code></td><td>Disco palette cycling on all units</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“♪ Boogie Woogie Bugle Boy ♪”</td></tr>
<tr><td><code>space race</code></td><td>Unlock maximum camera zoom-out (full map view). Fog of war still renders at all zoom levels — unexplored/fogged terrain is hidden regardless of altitude. This is purely a camera unlock, not a vision cheat (compare <code>perestroika</code>/<code>glasnost</code> which ARE <code>GAMEPLAY</code>)</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“Orbital altitude reached.” / “Returning to ground.”</td></tr>
<tr><td><code>propaganda</code></td><td>EVA voice lines replaced with exaggerated patriotic variants</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“For the motherland!” / “Standard communications restored.”</td></tr>
<tr><td><code>kilroy was here</code></td><td>All infantry units display a tiny “Kilroy” graffiti sprite above their head</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“He was here.” / “He left.”</td></tr>
<tr><td><code>hell march</code></td><td>Force Hell March to play on infinite loop, overriding all other music. The definitive RA experience</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“♪ Die Waffen, legt an! ♪” / “Standard playlist restored.”</td></tr>
<tr><td><code>kirov reporting</code></td><td>A massive Kirov airship shadow slowly drifts across the map every few minutes. No actual unit — pure atmospheric dread</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“Kirov reporting.” / “Airspace cleared.”</td></tr>
<tr><td><code>conscript reporting</code></td><td>Every single unit — tanks, ships, planes, buildings — uses Conscript voice lines when selected or ordered</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“Conscript reporting!” / “Specialized communications restored.”</td></tr>
<tr><td><code>rubber shoes in motion</code></td><td>All units crackle with Tesla electricity visual effects when moving</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“Charging up!” / “Discharge complete.”</td></tr>
<tr><td><code>silos needed</code></td><td>EVA says “silos needed” every 5 seconds regardless of actual silo status. The classic annoyance, weaponized as nostalgia</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“You asked for this.” / “Sanity restored.”</td></tr>
<tr><td><code>big head mode</code></td><td>All unit sprites and turrets rendered at 200% head/turret size. Classic Goldeneye DK Mode homage</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“Cranial expansion complete.” / “Normal proportions restored.”</td></tr>
<tr><td><code>crab rave</code></td><td>All idle units slowly rotate in place in synchronized circles</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“🦀” / “Units have regained their sense of purpose.”</td></tr>
<tr><td><code>dr strangelove</code></td><td>Units occasionally shout “YEEEEHAW!” when attacking. Nuclear explosions display riding-the-bomb animation overlay</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“Gentlemen, you can’t fight in here! This is the War Room!” / “Decorum restored.”</td></tr>
<tr><td><code>sputnik</code></td><td>A tiny satellite sprite orbits your cursor wherever it goes</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“Beep… beep… beep…” / “Satellite deorbited.”</td></tr>
<tr><td><code>duck and cover</code></td><td>All infantry periodically go prone for 1 second at random, as if practicing civil defense drills (purely animation — no combat effect)</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“This is a drill. This is only a drill.” / “All clear.”</td></tr>
<tr><td><code>enigma</code></td><td>All AI chat/notification text is displayed as scrambled cipher characters</td><td>Toggle</td><td><code>COSMETIC</code></td><td>“XJFKQ ZPMWV ROTBG.” / “Decryption restored.”</td></tr>
</tbody>
</table>
</div>
<p><em>Cross-game easter eggs (meta-references — <code>COSMETIC</code> flag):</em></p>
<p>These recognize cheat codes from other iconic games and respond with in-character humor. <strong>None of them do anything mechanically</strong> — the witty EVA response IS the entire easter egg. They reward gaming cultural knowledge with a knowing wink, not a gameplay advantage. They’re love letters to the genre.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Phrase</th><th>Recognized From</th><th>Type</th><th>Flags</th><th>Response</th></tr>
</thead>
<tbody>
<tr><td><code>power overwhelming</code></td><td>StarCraft</td><td>One-shot</td><td><code>COSMETIC</code></td><td>“Protoss technologies are not available in this theater of operations.”</td></tr>
<tr><td><code>show me the money</code></td><td>StarCraft</td><td>One-shot</td><td><code>COSMETIC</code></td><td>“This is a command economy, Commander. Fill out the proper requisition forms.”</td></tr>
<tr><td><code>there is no cow level</code></td><td>Diablo / StarCraft</td><td>One-shot</td><td><code>COSMETIC</code></td><td>“Correct.”</td></tr>
<tr><td><code>how do you turn this on</code></td><td>Age of Empires II</td><td>One-shot</td><td><code>COSMETIC</code></td><td>“Motorpool does not stock that vehicle. Try a Mammoth Tank.”</td></tr>
<tr><td><code>rosebud</code></td><td>The Sims</td><td>One-shot</td><td><code>COSMETIC</code></td><td>“§;§;§;§;§;§;§;§;§;”</td></tr>
<tr><td><code>iddqd</code></td><td>DOOM</td><td>One-shot</td><td><code>COSMETIC</code></td><td>“Wrong engine. This one uses Bevy.”</td></tr>
<tr><td><code>impulse 101</code></td><td>Half-Life</td><td>One-shot</td><td><code>COSMETIC</code></td><td>“Requisition denied. This isn’t Black Mesa.”</td></tr>
<tr><td><code>greedisgood</code></td><td>Warcraft III</td><td>One-shot</td><td><code>COSMETIC</code></td><td>“Wrong franchise. We use credits here, not gold.”</td></tr>
<tr><td><code>up up down down</code></td><td>Konami Code</td><td>One-shot</td><td><code>COSMETIC</code></td><td>“30 extra lives. …But this isn’t that kind of game.”</td></tr>
<tr><td><code>cheese steak jimmys</code></td><td>Age of Empires II</td><td>One-shot</td><td><code>COSMETIC</code></td><td>“The mess hall is closed, Commander.”</td></tr>
<tr><td><code>black sheep wall</code></td><td>StarCraft</td><td>One-shot</td><td><code>COSMETIC</code></td><td>“Try ‘perestroika’ instead. We have our own words for that.”</td></tr>
<tr><td><code>operation cwal</code></td><td>StarCraft</td><td>One-shot</td><td><code>COSMETIC</code></td><td>“Try ‘five year plan’. Same idea, different ideology.”</td></tr>
</tbody>
</table>
</div>
<p><strong>Why meta-references are <code>COSMETIC</code>:</strong> They have zero game effect. The reconnaissance value of knowing “<code>black sheep wall</code> doesn’t work but <code>perestroika</code> does” is part of the discovery fun — the game is training you to find the real cheats. The last two entries deliberately point players toward IC’s actual cheat codes, rewarding cross-game knowledge with a hint.</p>
<p><strong>Mod-defined cheats:</strong> Game modules register their own cheat code tables — the engine provides the <code>CheatCodeHandler</code> infrastructure, the game module supplies the phrase hashes and effect implementations. A Tiberian Dawn module would have different themed phrases than RA1. Total conversion mods can define entirely custom cheat tables via YAML:</p>
<pre><code class="language-yaml"># Custom cheat codes (mod.yaml)
cheat_codes:
  - phrase_hash: 0x7a3f2e1d   # hash of the phrase — not the phrase itself
    effect: give_credits
    amount: 50000
    flags: gameplay          # disables achievements
    confirmation: "Tiberium dividend received."
  - phrase_hash: 0x4b8c9d0e
    effect: toggle_invincible
    flags: gameplay
    confirmation_on: "Blessed by Kane."
    confirmation_off: "Mortality restored."
  - phrase_hash: 0x9e2f1a3b
    effect: toggle_visual
    flags: cosmetic           # achievements unaffected
    confirmation_on: "The world changes."
    confirmation_off: "Reality restored."
</code></pre>
<p><strong>Relationship to dev commands:</strong> Cheat codes and dev commands are complementary, not redundant. Dev commands (<code>/give</code>, <code>/spawn</code>, <code>/reveal</code>, <code>/instant_build</code>) are the precise, documented, power-user interface — visible in <code>/help</code>, discoverable, parameterized. Cheat codes are the thematic, hidden, fun interface — no parameters, no documentation, themed phrases with in-character responses. Under the hood, many cheats produce the same <code>PlayerOrder</code> variants as their dev command counterparts. The difference is entirely in the surface: how the player discovers, invokes, and experiences them.</p>
<p><strong>Why hashed phrases, not encrypted:</strong> We are preserving a nostalgic discovery experience, not implementing DRM. Hashing makes cheats non-obvious to casual inspection but deliberately yields to determined community effort. Within weeks of release, every cheat will be on a wiki — and that’s the intended outcome. The joy is in the initial community discovery process, not in permanent secrecy.</p>
<h4 id="security-considerations"><a class="header" href="#security-considerations">Security Considerations</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Risk</th><th>Mitigation</th></tr>
</thead>
<tbody>
<tr><td><strong>Arbitrary Lua execution</strong></td><td>Lua runs in the D004 sandbox — no filesystem, no network, no <code>os.*</code>. <code>loadstring()</code> disabled. Execution timeout (100ms default). Memory limit per invocation.</td></tr>
<tr><td><strong>Cvar manipulation for cheating</strong></td><td>Sim-affecting cvars require <code>DEV_ONLY</code> flag and flow through order validation. Render/audio cvars cannot affect gameplay. A <code>/set</code> command for a <code>DEV_ONLY</code> cvar without dev mode active is rejected.</td></tr>
<tr><td><strong>Chat message buffer overflow</strong></td><td>Chat messages are bounded (512 chars, same as <code>ProtocolLimits::max_chat_message_length</code> from <code>06-SECURITY.md</code> § V15). Command input bounded similarly. The <code>StringReader</code> parser rejects input exceeding the limit before parsing.</td></tr>
<tr><td><strong>Command injection in multiplayer</strong></td><td>Commands execute locally on the issuing client. Sim-affecting commands go through the order pipeline as <code>PlayerOrder::ChatCommand(cmd, args)</code> — validated by the sim like any other order. A malicious client cannot execute commands on another client’s behalf.</td></tr>
<tr><td><strong>Denial of service via expensive Lua</strong></td><td>Lua execution has a tick budget. <code>/c</code> commands that exceed the budget are interrupted with an error. The chat/console remains responsive because Lua runs in the script system’s time slice, not the UI thread.</td></tr>
<tr><td><strong>Cvar persistence tampering</strong></td><td><code>config.toml</code> is local — tampering only affects the local client. Server-authoritative cvars (<code>SERVER</code> flag) cannot be overridden by client-side config.</td></tr>
</tbody>
</table>
</div>
<h4 id="platform-considerations"><a class="header" href="#platform-considerations">Platform Considerations</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Platform</th><th>Chat Input</th><th>Developer Console</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td><strong>Desktop</strong></td><td>Enter opens input, <code>/</code> prefix for commands</td><td><code>~</code> toggles overlay</td><td>Full keyboard; best experience</td></tr>
<tr><td><strong>Browser (WASM)</strong></td><td>Same</td><td>Same (tilde might conflict with browser shortcuts — configurable)</td><td>Virtual keyboard on mobile browsers</td></tr>
<tr><td><strong>Steam Deck</strong></td><td>On-screen keyboard when input focused</td><td>Touchscreen or controller shortcut</td><td>Steam’s built-in OSK works</td></tr>
<tr><td><strong>Mobile (future)</strong></td><td>Tap chat icon → OS keyboard</td><td>Not exposed (use GUI settings instead)</td><td>Commands via chat input; no tilde console</td></tr>
<tr><td><strong>Console (future)</strong></td><td>D-pad/bumper to open, OS keyboard</td><td>Not exposed</td><td>Controller-friendly command browser as alternative</td></tr>
</tbody>
</table>
</div>
<p>For non-desktop platforms, the cvar browser in the developer console is replaced by the <strong>Settings UI</strong> — a GUI-based equivalent that exposes the same cvars through menus and sliders. The command system is accessible via chat input on all platforms; the developer console overlay is a desktop convenience, not a requirement.</p>
<h3 id="config-file-on-startup"><a class="header" href="#config-file-on-startup">Config File on Startup</a></h3>
<p>Cvars are loadable from <code>config.toml</code> on startup and optionally from a per-game-module override:</p>
<pre><code>config.toml                   # global defaults
config.ra1.toml               # RA1-specific overrides (optional)
config.td.toml                # TD-specific overrides (optional)
</code></pre>
<p><strong>Load order:</strong> <code>config.toml</code> → <code>config.&lt;game_module&gt;.toml</code> → command-line arguments → in-game <code>/set</code> commands. Each layer overrides the previous. Changes made via <code>/set</code> on <code>PERSISTENT</code> cvars write back to the appropriate config file.</p>
<p><strong>Autoexec:</strong> An optional <code>autoexec.cfg</code> file (Source Engine convention) runs commands on startup:</p>
<pre><code># autoexec.cfg — runs on game startup
/set render.max_fps 144
/set audio.master_volume 80
/set gameplay.scroll_speed 7
</code></pre>
<p>This is a convenience for power users who prefer text files over GUI settings. The format is one command per line, <code>#</code> for comments. Parsed by the same <code>CommandDispatcher</code> with <code>CommandOrigin::ConfigFile</code>.</p>
<h3 id="what-this-is-not"><a class="header" href="#what-this-is-not">What This Is NOT</a></h3>
<ul>
<li><strong>NOT a replacement for the Settings UI.</strong> Most players change settings through the GUI. The command system and cvars are the power-user interface to the same underlying settings. Both read and write the same <code>config.toml</code>.</li>
<li><strong>NOT a scripting environment.</strong> The <code>/c</code> Lua console is for quick testing and debugging, not for writing mods. Mods belong in proper <code>.lua</code> files loaded through the mod system (D004). The console is a REPL — one-liners and quick experiments.</li>
<li><strong>NOT available in competitive/ranked play.</strong> Dev commands are gated behind DeveloperMode (V44). The chat system and non-dev commands work in ranked; the Lua console and dev commands do not. Normal console commands (<code>/move</code>, <code>/build</code>, etc.) are treated as GUI-equivalent inputs — they produce the same <code>PlayerOrder</code> and are governed by D033 QoL toggles. See “Competitive Integrity in Multiplayer” above for the full framework: order rate monitoring, input source tracking, ranked restrictions, and tournament mode.</li>
<li><strong>NOT a server management panel.</strong> Server administration beyond kick/ban/config should use external tools (web panels, RCON protocol). The in-game commands cover in-match operations only.</li>
</ul>
<h3 id="alternatives-considered"><a class="header" href="#alternatives-considered">Alternatives Considered</a></h3>
<ul>
<li><strong>Separate console only, no chat integration</strong> (rejected — Source Engine’s model works for FPS games where chat is secondary, but RTS players use chat heavily during matches; forcing tilde-switch for commands is friction. Factorio and Minecraft prove unified is better for games where chat and commands coexist.)</li>
<li><strong>Chat only, no developer console</strong> (rejected — power users need multi-line Lua input, scrollback, cvar browsing, and syntax highlighting. A single-line chat field can’t provide this. The developer console is a thin UI layer over the same dispatcher — minimal implementation cost.)</li>
<li><strong>GUI-only commands like OpenRA</strong> (rejected — checkbox menus are fine for 7 dev mode flags but don’t scale to dozens of commands, mod-injected commands, or Lua execution. A text interface is necessary for extensibility.)</li>
<li><strong>Custom command syntax instead of <code>/</code> prefix</strong> (rejected — <code>/</code> is the universal standard across Minecraft, Factorio, Discord, IRC, MMOs, and dozens of other games. Any other prefix would surprise users.)</li>
<li><strong>RCON protocol for remote administration</strong> (deferred — useful for dedicated servers but out of scope for Phase 3. Can be added later as a <code>CommandOrigin::Rcon</code> variant with <code>Admin</code> permission level. The command dispatcher is origin-agnostic by design.)</li>
<li><strong>Unrestricted Lua console without achievement consequences</strong> (rejected — every game that has tried this has created a split community where “did you use the console?” is a constant question. Factorio’s model — use it freely, but achievements are permanently disabled — is honest and universally understood.)</li>
<li><strong>Disable console commands in multiplayer to prevent scripting</strong> (rejected — console commands produce the same <code>PlayerOrder</code> as GUI actions. Removing them doesn’t prevent scripting — external tools like AutoHotKey can automate mouse/keyboard input. Worse, a modified open-source client can send orders directly, bypassing all input methods. Removing the console punishes legitimate power users and accessibility needs while providing zero security benefit. The correct defense is D033 equalization, input source tracking, and community governance — see “Competitive Integrity in Multiplayer.”)</li>
</ul>
<h3 id="integration-with-existing-decisions"><a class="header" href="#integration-with-existing-decisions">Integration with Existing Decisions</a></h3>
<ul>
<li><strong>D004 (Lua Scripting):</strong> The <code>/c</code> command executes Lua in the same sandbox as mission scripts. The <code>CommandSource</code> passed to Lua commands provides the execution context (<code>CommandOrigin::ChatInput</code> vs <code>LuaScript</code> vs <code>ConfigFile</code>).</li>
<li><strong>D005 (WASM):</strong> WASM modules register commands through the same <code>CommandDispatcher</code> host function API. WASM commands have the same permission model and sandboxing guarantees.</li>
<li><strong>D012 (Order Validation):</strong> Sim-affecting commands produce <code>PlayerOrder</code> variants. The order validator rejects dev commands when dev mode is inactive, and logs repeated rejections for anti-cheat analysis.</li>
<li><strong>D031 (Observability):</strong> Command execution events (who, what, when) are telemetry events. Admin actions, dev mode usage, and Lua console invocations are all observable.</li>
<li><strong>D033 (QoL Toggles):</strong> Many QoL settings map directly to cvars. The QoL toggle UI and the cvar system read/write the same underlying values.</li>
<li><strong>D034 (SQLite):</strong> Console command history is persisted in SQLite. The cvar browser’s search index uses the same FTS5 infrastructure.</li>
<li><strong>D036 (Achievements):</strong> The <code>cheats_used</code> flag in sim state is set when any dev command or gameplay cheat executes. Achievement checks respect this flag. Cosmetic cheats (<code>cosmetic_cheats_used</code>) do not affect achievements — only <code>cheats_used</code> does.</li>
<li><strong>D055 (Ranked Matchmaking):</strong> Games with <code>cheats_used = true</code> are excluded from ranked submission. The relay server verifies this flag in match certification. <code>cosmetic_cheats_used</code> alone does not affect ranked eligibility (cosmetic cheats are single-player only regardless).</li>
<li><strong>03-NETCODE.md (In-Match Vote Framework):</strong> The <code>/callvote</code>, <code>/vote</code>, <code>/poll</code> commands are registered in the Brigadier command tree. <code>/gg</code> and <code>/ff</code> are aliases for <code>/callvote surrender</code>. Vote commands produce <code>PlayerOrder::Vote</code> variants — processed by the sim like any other order. Tactical polls extend the chat wheel phrase system.</li>
<li><strong>V44 (06-SECURITY.md):</strong> <code>DeveloperMode</code> is sim state, toggled in lobby only, with unanimous consent in multiplayer. The command system enforces this — dev commands are rejected at the order validation layer, not the UI layer.</li>
</ul>
<hr>
<hr>
<h2 id="d059-in-game-communication--text-chat-voice-beacons-and-coordination"><a class="header" href="#d059-in-game-communication--text-chat-voice-beacons-and-coordination">D059: In-Game Communication — Text Chat, Voice, Beacons, and Coordination</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th></th><th></th></tr>
</thead>
<tbody>
<tr><td><strong>Status</strong></td><td>Accepted</td></tr>
<tr><td><strong>Phase</strong></td><td>Phase 3 (text chat, beacons), Phase 5 (VoIP, voice-in-replay)</td></tr>
<tr><td><strong>Depends on</strong></td><td>D006 (NetworkModel), D007 (Relay Server), D024 (Lua API), D033 (QoL Toggles), D054 (Transport), D058 (Chat/Command Console)</td></tr>
<tr><td><strong>Driver</strong></td><td>No open-source RTS has built-in VoIP. OpenRA has no voice chat. The Remastered Collection added basic lobby voice via Steam. This is a major opportunity for IC to set the standard.</td></tr>
</tbody>
</table>
</div>
<h3 id="problem-1"><a class="header" href="#problem-1">Problem</a></h3>
<p>RTS multiplayer requires three kinds of player coordination:</p>
<ol>
<li><strong>Text communication</strong> — chat channels (all, team, whisper), emoji, mod-registered phrases</li>
<li><strong>Voice communication</strong> — push-to-talk VoIP for real-time callouts during gameplay</li>
<li><strong>Spatial signaling</strong> — beacons, pings, map markers, tactical annotations that convey <em>where</em> and <em>what</em> without words</li>
</ol>
<p>D058 designed the text input/command system (chat box, <code>/</code> prefix routing, command dispatch). What D058 did NOT address:</p>
<ul>
<li>Chat <strong>channel routing</strong> — how messages reach the right recipients (all, team, whisper, observers)</li>
<li><strong>VoIP architecture</strong> — codec, transport, relay integration, bandwidth management</li>
<li><strong>Beacons and pings</strong> — the non-verbal coordination layer that Apex Legends proved is often more effective than voice</li>
<li><strong>Voice-in-replay</strong> — whether and how voice recordings are preserved for replay playback</li>
<li>How all three systems integrate with the existing <code>MessageLane</code> infrastructure (<code>03-NETCODE.md</code>) and <code>Transport</code> trait (D054)</li>
</ul>
<h3 id="decision-1"><a class="header" href="#decision-1">Decision</a></h3>
<p>Build a unified coordination system with three tiers: text chat channels, relay-forwarded VoIP, and a contextual ping/beacon system — plus novel coordination tools (chat wheel, minimap drawing, tactical markers). Voice is optionally recorded into replays as a separate stream with explicit consent.</p>
<p><strong>Revision note (2026-02-22):</strong> Revised platform guidance to define mobile minimap/bookmark coexistence (minimap cluster + adjacent bookmark dock) and explicit touch interaction precedence so future mobile coordination features (pings, chat wheel, minimap drawing) do not conflict with fast camera navigation. This revision was informed by mobile RTS UX research and touch-layout requirements (see <code>research/mobile-rts-ux-onboarding-community-platform-analysis.md</code>).</p>
<h3 id="decision-capsule-llmrag-summary-1"><a class="header" href="#decision-capsule-llmrag-summary-1">Decision Capsule (LLM/RAG Summary)</a></h3>
<ul>
<li><strong>Status:</strong> Accepted (Revised 2026-02-22)</li>
<li><strong>Phase:</strong> Phase 3 (text chat, beacons), Phase 5 (VoIP, voice-in-replay)</li>
<li><strong>Canonical for:</strong> In-game communication architecture (text chat, voice, pings/beacons, tactical coordination) and integration with commands/replay/network lanes</li>
<li><strong>Scope:</strong> <code>ic-ui</code> chat/voice/ping UX, <code>ic-net</code> message lanes/relay forwarding, replay voice stream policy, moderation/muting, mobile coordination input behavior</li>
<li><strong>Decision:</strong> IC provides a unified coordination system with <strong>text chat channels</strong>, <strong>relay-forwarded VoIP</strong>, and <strong>contextual pings/beacons/markers</strong>, with optional voice recording in replays via explicit consent.</li>
<li><strong>Why:</strong> RTS coordination needs verbal, textual, and spatial communication; open-source RTS projects under-serve VoIP and modern ping tooling; IC can set a higher baseline.</li>
<li><strong>Non-goals:</strong> Text-only communication as the sole coordination path; separate mobile and desktop communication rules that change gameplay semantics.</li>
<li><strong>Invariants preserved:</strong> Communication integrates with existing order/message infrastructure; D058 remains the input/command console foundation and D012 validation remains relevant for command-side actions.</li>
<li><strong>Defaults / UX behavior:</strong> Text chat channels are first-class and sticky; voice is optional; advanced coordination tools (chat wheel/minimap drawing/tactical markers) layer onto the same system.</li>
<li><strong>Mobile / accessibility impact:</strong> Mobile minimap and bookmark dock coexist in one cluster with explicit touch precedence rules to avoid conflicts between camera navigation and communication gestures.</li>
<li><strong>Security / Trust impact:</strong> Moderation, muting, observer restrictions, and replay/voice consent rules are part of the core communication design.</li>
<li><strong>Public interfaces / types / commands:</strong> <code>ChatChannel</code>, chat message orders/routing, voice packet/lane formats, beacon/ping/tactical marker events (see body sections)</li>
<li><strong>Affected docs:</strong> <code>src/03-NETCODE.md</code>, <code>src/06-SECURITY.md</code>, <code>src/17-PLAYER-FLOW.md</code>, <code>src/decisions/09g-interaction.md</code> (D058/D065)</li>
<li><strong>Revision note summary:</strong> Added mobile minimap/bookmark cluster coexistence and touch precedence so communication gestures do not break mobile camera navigation.</li>
<li><strong>Keywords:</strong> chat, voip, pings, beacons, minimap drawing, communication lanes, replay voice, mobile coordination, command console integration</li>
</ul>
<h3 id="1-text-chat--channel-architecture"><a class="header" href="#1-text-chat--channel-architecture">1. Text Chat — Channel Architecture</a></h3>
<p>D058 defined the chat <em>input</em> system. This section defines the chat <em>routing</em> system — how messages are delivered to the correct recipients.</p>
<h4 id="channel-model"><a class="header" href="#channel-model">Channel Model</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Chat channel identifiers. Sent as part of every ChatMessage order.
/// The channel determines who receives the message. Channel selection
/// is sticky — the player's last-used channel persists until changed.
#[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, Serialize, Deserialize)]
pub enum ChatChannel {
    /// All players and observers see the message.
    All,
    /// Only players on the same team (including shared-control allies).
    Team,
    /// Private message to a specific player. Not visible to others.
    /// Observers cannot whisper to players (anti-coaching, V41).
    Whisper { target: PlayerId },
    /// Observer-only channel. Players do not see these messages.
    /// Prevents spectator coaching during live games (V41).
    Observer,
}
<span class="boring">}</span></code></pre>
<h4 id="chat-message-order"><a class="header" href="#chat-message-order">Chat Message Order</a></h4>
<p>Chat messages flow through the order pipeline — they are <code>PlayerOrder</code> variants, validated by the sim (D012), and replayed deterministically:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Chat message as a player order. Part of the deterministic order stream.
/// This means chat is captured in replays and can be replayed alongside
/// gameplay — matching SC2's `replay.message.events` stream.
pub enum PlayerOrder {
    // ... existing variants ...
    ChatMessage {
        channel: ChatChannel,
        /// UTF-8 text, bounded by ProtocolLimits::max_chat_message_length (512 chars, V15).
        text: String,
    },
    /// Notification-only metadata marker: player started/stopped voice transmission.
    /// NOT the audio data itself — that flows outside the order pipeline
    /// via MessageLane::Voice (see D059 § VoIP Architecture). This order exists
    /// solely so the sim can record voice activity timestamps in the replay's
    /// analysis event stream. The sim DOES NOT process, decode, or relay any audio.
    /// "VoIP is not part of the simulation" — VoiceActivity is a timestamp marker,
    /// not audio data.
    VoiceActivity {
        active: bool,
    },
    /// Tactical ping placed on the map. Sim-side so it appears in replays.
    TacticalPing {
        ping_type: PingType,
        pos: WorldPos,
        /// Optional entity target (e.g., "attack this unit").
        target: Option&lt;UnitTag&gt;,
    },
    /// Chat wheel phrase selected. Sim-side for deterministic replay.
    ChatWheelPhrase {
        phrase_id: u16,
    },
    /// Minimap annotation stroke (batch of points). Sim-side for replay.
    MinimapDraw {
        points: Vec&lt;WorldPos&gt;,
        color: PlayerColor,
    },
}
<span class="boring">}</span></code></pre>
<p><strong>Why chat is in the order stream:</strong> SC2 stores chat in a separate <code>replay.message.events</code> stream alongside <code>replay.game.events</code> (orders) and <code>replay.tracker.events</code> (analysis). IC follows this model — <code>ChatMessage</code> orders are part of the tick stream, meaning replays preserve the full text conversation. During replay playback, the chat overlay shows messages at the exact tick they were sent. This is essential for tournament review and community content creation.</p>
<h4 id="channel-routing"><a class="header" href="#channel-routing">Channel Routing</a></h4>
<p>Chat routing is a relay server concern, not a sim concern. The relay inspects <code>ChatChannel</code> to determine forwarding:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Channel</th><th>Relay Forwards To</th><th>Replay Visibility</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td><code>All</code></td><td>All connected clients (players + observers)</td><td>Full</td><td>Standard all-chat</td></tr>
<tr><td><code>Team</code></td><td>Same-team players only</td><td>Full (after game)</td><td>Hidden from opponents during live game</td></tr>
<tr><td><code>Whisper { target }</code></td><td>Target player only + sender echo</td><td>Sender only</td><td>Private — not in shared replay</td></tr>
<tr><td><code>Observer</code></td><td>All observers only</td><td>Full</td><td>Players never see observer chat during live game</td></tr>
</tbody>
</table>
</div>
<p><strong>Anti-coaching:</strong> During a live game, observer messages are never forwarded to players. This prevents spectator coaching in competitive matches. In replay playback, all channels are visible (the information is historical).</p>
<p><strong>Chat cooldown:</strong> Rate-limited at the relay: max 5 messages per 3 seconds per player (configurable via server cvar). Exceeding the limit queues messages with a “slow mode” indicator. This prevents chat spam without blocking legitimate rapid communication during intense moments.</p>
<h4 id="channel-switching"><a class="header" href="#channel-switching">Channel Switching</a></h4>
<pre><code>Enter         → Open chat in last-used channel
Shift+Enter   → Open chat in All (if last-used was Team)
Tab           → Cycle: All → Team → Observer (if spectating)
/w &lt;name&gt;     → Switch to whisper channel targeting &lt;name&gt;
/all           → Switch to All channel (D058 command)
/team          → Switch to Team channel (D058 command)  
</code></pre>
<p>The active channel is displayed as a colored prefix in the chat input: <code>[ALL]</code>, <code>[TEAM]</code>, <code>[WHISPER → Alice]</code>, <code>[OBS]</code>.</p>
<h4 id="emoji-and-rich-text"><a class="header" href="#emoji-and-rich-text">Emoji and Rich Text</a></h4>
<p>Chat messages support a limited set of inline formatting:</p>
<ul>
<li><strong>Emoji shortcodes</strong> — <code>:gg:</code>, <code>:glhf:</code>, <code>:allied:</code>, <code>:soviet:</code> mapped to sprite-based emoji (not Unicode — ensures consistent rendering across platforms). Custom emoji can be registered by mods via YAML.</li>
<li><strong>Unit/building links</strong> — <code>[Tank]</code> auto-links to the unit’s encyclopedia entry (if <code>ic-ui</code> has one). Parsed client-side, not in the order stream.</li>
<li><strong>No markdown, no HTML, no BBCode.</strong> Chat is plain text with emoji shortcodes. This eliminates an entire class of injection attacks and keeps the parser trivial.</li>
</ul>
<h3 id="2-voice-over-ip--architecture"><a class="header" href="#2-voice-over-ip--architecture">2. Voice-over-IP — Architecture</a></h3>
<p>No open-source RTS engine has built-in VoIP. OpenRA relies on Discord/TeamSpeak. The Remastered Collection added lobby voice via Steam’s API (Steamworks <code>ISteamNetworkingMessages</code>). IC’s VoIP is engine-native — no external service dependency.</p>
<h4 id="design-principles"><a class="header" href="#design-principles">Design Principles</a></h4>
<ol>
<li>
<p><strong>VoIP is NOT part of the simulation.</strong> Voice data never enters <code>ic-sim</code>. It is pure I/O — captured, encoded, transmitted, decoded, and played back entirely in <code>ic-net</code> and <code>ic-audio</code>. The sim is unaware that voice exists (Invariant #1: simulation is pure and deterministic).</p>
</li>
<li>
<p><strong>Voice flows through the relay.</strong> Not P2P. This maintains D007’s architecture: the relay prevents IP exposure, provides consistent routing, and enables server-side mute enforcement. P2P voice would leak player IP addresses — a known harassment vector in competitive games.</p>
</li>
<li>
<p><strong>Push-to-talk is the default.</strong> Voice activation detection (VAD) is available as an option but not default. PTT prevents accidental transmission of background noise, private conversations, and keyboard/mouse sounds — problems that plague open-mic games.</p>
</li>
<li>
<p><strong>Voice is best-effort.</strong> Lost voice packets are not retransmitted. Human hearing tolerates ~5% packet loss with Opus’s built-in PLC (packet loss concealment). Retransmitting stale voice data adds latency without improving quality.</p>
</li>
<li>
<p><strong>Voice never delays gameplay.</strong> The <code>MessageLane::Voice</code> lane has lower priority than <code>Orders</code> and <code>Control</code> — voice packets are dropped before order packets under bandwidth pressure.</p>
</li>
<li>
<p><strong>End-to-end latency target: &lt;150ms.</strong> Mouth-to-ear latency must stay under 150ms for natural conversation. Budget: capture buffer ~5ms + encode ~2ms + network RTT/2 (typically 30-80ms) + jitter buffer (20-60ms) + decode ~1ms + playback buffer ~5ms = 63-153ms. CS2 and Valorant achieve ~100-150ms. Mumble achieves ~50-80ms on LAN, ~100-150ms on WAN. At &gt;200ms, conversation becomes turn-taking rather than natural overlap — unacceptable for real-time RTS callouts. The adaptive jitter buffer (see below) is the primary latency knob: on good networks it stays at 1 frame (20ms); on poor networks it expands up to 10 frames (200ms) as a tradeoff. Monitoring this budget is exposed via <code>VoiceDiagnostics</code> (see UI Indicators).</p>
</li>
</ol>
<h4 id="codec-opus"><a class="header" href="#codec-opus">Codec: Opus</a></h4>
<p><strong>Opus</strong> (RFC 6716) is the only viable choice. It is:</p>
<ul>
<li>Royalty-free and open-source (BSD license)</li>
<li>The standard game voice codec (used by Discord, Steam, ioquake3, Mumble, WebRTC)</li>
<li>Excellent at low bitrates (usable at 6 kbps, good at 16 kbps, transparent at 32 kbps)</li>
<li>Built-in forward error correction (FEC) and packet loss concealment (PLC)</li>
<li>Native Rust bindings available via <code>audiopus</code> crate (safe wrapper around libopus)</li>
</ul>
<p><strong>Encoding parameters:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Parameter</th><th>Default</th><th>Range</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td>Sample rate</td><td>48 kHz</td><td>Fixed</td><td>Opus native rate; input is resampled if needed</td></tr>
<tr><td>Channels</td><td>1 (mono)</td><td>Fixed</td><td>Voice chat is mono; stereo is wasted bandwidth</td></tr>
<tr><td>Frame size</td><td>20 ms</td><td>10, 20, 40 ms</td><td>20 ms is the standard balance of latency vs. overhead</td></tr>
<tr><td>Bitrate</td><td>32 kbps</td><td>8–64 kbps</td><td>Adaptive (see below). 32 kbps matches Discord/Mumble quality expectations</td></tr>
<tr><td>Application mode</td><td><code>VOIP</code></td><td>Fixed</td><td>Opus <code>OPUS_APPLICATION_VOIP</code> — optimized for speech, enables DTX</td></tr>
<tr><td>Complexity</td><td>7</td><td>0–10</td><td>Mumble uses 10, Discord similar; 7 is quality/CPU sweet spot</td></tr>
<tr><td>DTX (Discontinuous Tx)</td><td>Enabled</td><td>On/Off</td><td>Stops transmitting during silence — major bandwidth savings</td></tr>
<tr><td>In-band FEC</td><td>Enabled</td><td>On/Off</td><td>Encodes lower-bitrate redundancy of previous frame — helps packet loss</td></tr>
<tr><td>Packet loss percentage</td><td>Dynamic</td><td>0–100</td><td>Fed from <code>VoiceBitrateAdapter.loss_ratio</code> — adapts FEC to actual loss</td></tr>
</tbody>
</table>
</div>
<p><strong>Bandwidth budget per player:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Bitrate</th><th>Opus payload/frame (20ms)</th><th>+ overhead (per packet)</th><th>Per second</th><th>Quality</th></tr>
</thead>
<tbody>
<tr><td>8 kbps</td><td>20 bytes</td><td>~48 bytes</td><td>~2.4 KB/s</td><td>Intelligible</td></tr>
<tr><td>16 kbps</td><td>40 bytes</td><td>~68 bytes</td><td>~3.4 KB/s</td><td>Good</td></tr>
<tr><td>24 kbps</td><td>60 bytes</td><td>~88 bytes</td><td>~4.4 KB/s</td><td>Very good</td></tr>
<tr><td>32 kbps</td><td>80 bytes</td><td>~108 bytes</td><td>~5.4 KB/s</td><td><strong>Default</strong></td></tr>
<tr><td>64 kbps</td><td>160 bytes</td><td>~188 bytes</td><td>~9.4 KB/s</td><td>Music-grade</td></tr>
</tbody>
</table>
</div>
<p>Overhead = 28 bytes UDP/IP + lane header. With DTX enabled, actual bandwidth is ~60% of these figures (voice is ~60% activity, ~40% silence in typical conversation). An 8-player game where 2 players speak simultaneously at the default 32 kbps uses 2 × 5.4 KB/s = ~10.8 KB/s inbound — negligible compared to the order stream.</p>
<h4 id="adaptive-bitrate"><a class="header" href="#adaptive-bitrate">Adaptive Bitrate</a></h4>
<p>The relay monitors per-connection bandwidth using the same ack vector RTT measurements used for order delivery (<code>03-NETCODE.md</code> § Per-Ack RTT Measurement). When bandwidth is constrained:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Voice bitrate adaptation based on available bandwidth.
/// Runs on the sending client. The relay reports congestion via
/// a VoiceBitrateHint control message (not an order — control lane).
pub struct VoiceBitrateAdapter {
    /// Current target bitrate (Opus encoder parameter).
    pub current_bitrate: u32,
    /// Minimum acceptable bitrate. Below this, voice is suspended
    /// with a "low bandwidth" indicator to the UI.
    pub min_bitrate: u32,       // default: 8_000
    /// Maximum bitrate when bandwidth is plentiful.
    pub max_bitrate: u32,       // default: 32_000
    /// Smoothed trip time from ack vectors (updated every packet).
    pub srtt_us: u64,
    /// Packet loss ratio (0.0–1.0) from ack vector analysis.
    pub loss_ratio: f32,        // f32 OK — this is I/O, not sim
}

impl VoiceBitrateAdapter {
    /// Called each frame. Returns the bitrate to configure on the encoder.
    /// Also updates Opus's OPUS_SET_PACKET_LOSS_PERC hint dynamically
    /// (learned from Mumble/Discord — static loss hints under-optimize FEC).
    pub fn adapt(&amp;mut self) -&gt; u32 {
        if self.loss_ratio &gt; 0.15 {
            // Heavy loss: drop to minimum, prioritize intelligibility
            self.current_bitrate = self.min_bitrate;
        } else if self.loss_ratio &gt; 0.05 {
            // Moderate loss: reduce by 25%
            self.current_bitrate = (self.current_bitrate * 3 / 4).max(self.min_bitrate);
        } else if self.srtt_us &lt; 100_000 {
            // Low latency, low loss: increase toward max
            self.current_bitrate = (self.current_bitrate * 5 / 4).min(self.max_bitrate);
        }
        self.current_bitrate
    }

    /// Returns the packet loss percentage hint for OPUS_SET_PACKET_LOSS_PERC.
    /// Dynamic: fed from observed loss_ratio rather than a static 10% default.
    /// At higher loss hints, Opus allocates more bits to in-band FEC.
    pub fn opus_loss_hint(&amp;self) -&gt; i32 {
        // Quantize to 0, 5, 10, 15, 20, 25 — Opus doesn't need fine granularity
        ((self.loss_ratio * 100.0) as i32 / 5 * 5).clamp(0, 25)
    }
}
<span class="boring">}</span></code></pre>
<h4 id="message-lane-voice"><a class="header" href="#message-lane-voice">Message Lane: Voice</a></h4>
<p>Voice traffic uses a new <code>MessageLane::Voice</code> lane, positioned between <code>Chat</code> and <code>Bulk</code>:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum MessageLane {
    Orders = 0,
    Control = 1,
    Chat = 2,
    Voice = 3,    // NEW — voice frames
    Bulk = 4,     // was 3, renumbered
}
<span class="boring">}</span></code></pre>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Lane</th><th>Priority</th><th>Weight</th><th>Buffer</th><th>Reliability</th><th>Rationale</th></tr>
</thead>
<tbody>
<tr><td><code>Orders</code></td><td>0</td><td>1</td><td>4 KB</td><td>Reliable</td><td>Orders must arrive; missed = Idle (deadline is the cap)</td></tr>
<tr><td><code>Control</code></td><td>0</td><td>1</td><td>2 KB</td><td>Unreliable</td><td>Latest sync hash wins; stale hashes are useless</td></tr>
<tr><td><code>Chat</code></td><td>1</td><td>1</td><td>8 KB</td><td>Reliable</td><td>Chat messages should arrive but can wait</td></tr>
<tr><td><code>Voice</code></td><td>1</td><td>2</td><td>16 KB</td><td>Unreliable</td><td>Real-time voice; dropped frames use Opus PLC (not retransmit)</td></tr>
<tr><td><code>Bulk</code></td><td>2</td><td>1</td><td>64 KB</td><td>Unreliable</td><td>Telemetry/observer data uses spare bandwidth</td></tr>
</tbody>
</table>
</div>
<p><strong>Voice and Chat share priority tier 1</strong> with a 2:1 weight ratio — voice gets twice the bandwidth share because it’s time-sensitive. Under bandwidth pressure, Orders and Control are served first (tier 0), then Voice and Chat split the remainder (tier 1, 67%/33%), then Bulk gets whatever is left (tier 2). This ensures voice never delays order delivery, but voice frames are prioritized over chat messages within the non-critical tier.</p>
<p><strong>Buffer limit:</strong> 16 KB allows ~73ms of buffered voice at the default 32 kbps (~148 frames at 108 bytes each). If the buffer fills (severe congestion), the oldest voice frames are dropped — this is correct behavior for real-time audio (stale audio is worse than silence).</p>
<h4 id="voice-packet-format"><a class="header" href="#voice-packet-format">Voice Packet Format</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Voice data packet. Travels on MessageLane::Voice.
/// NOT a PlayerOrder — voice never enters the sim.
/// Encoded in the lane's framing, not the order TLV format.
pub struct VoicePacket {
    /// Which player is speaking. Set by relay (not client) to prevent spoofing.
    pub speaker: PlayerId,
    /// Monotonically increasing sequence number for ordering + loss detection.
    pub sequence: u32,
    /// Opus frame count in this packet (typically 1, max 3 for 60ms bundling).
    pub frame_count: u8,
    /// Voice routing target. The relay uses this to determine forwarding.
    pub target: VoiceTarget,
    /// Flags: SPATIAL (positional audio hint), FEC (frame contains FEC data).
    pub flags: VoiceFlags,
    /// Opus-encoded audio payload. Size determined by bitrate and frame_count.
    pub data: Vec&lt;u8&gt;,
}

/// Who should hear this voice transmission.
#[derive(Clone, Copy, Debug, PartialEq, Eq)]
pub enum VoiceTarget {
    /// All players and observers hear the transmission.
    All,
    /// Only same-team players.
    Team,
    /// Specific player (private voice — rare, but useful for coaching/tutoring).
    Player(PlayerId),
}

bitflags! {
    pub struct VoiceFlags: u8 {
        /// Positional audio hint — the listener should spatialize this
        /// voice based on the speaker's camera position or selected units.
        /// Opt-in via D033 QoL toggle. Disabled by default.
        const SPATIAL = 0x01;
        /// This packet contains Opus in-band FEC data for the previous frame.
        const FEC     = 0x02;
    }
}
<span class="boring">}</span></code></pre>
<p><strong>Speaker ID is relay-assigned.</strong> The client sends voice data; the relay stamps <code>speaker</code> before forwarding. This prevents voice spoofing — a client cannot impersonate another player’s voice. Same pattern as ioquake3’s server-side VoIP relay (where <code>sv_client.c</code> stamps the client number on forwarded voice packets).</p>
<h4 id="relay-voice-forwarding"><a class="header" href="#relay-voice-forwarding">Relay Voice Forwarding</a></h4>
<p>The relay server forwards voice packets with minimal processing:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Relay-side voice forwarding. Per-client, per-tick.
/// The relay does NOT decode Opus — it forwards opaque bytes.
/// This keeps relay CPU cost near zero for voice.
impl RelaySession {
    fn forward_voice(&amp;mut self, from: PlayerId, packet: &amp;VoicePacket) {
        // 1. Validate: is this player allowed to speak? (not muted, not observer in competitive)
        if self.is_muted(from) { return; }

        // 2. Rate limit: max voice_packets_per_second per player (default 50 = 1 per 20ms)
        if !self.voice_rate_limiter.check(from) { return; }

        // 3. Stamp speaker ID (overwrite whatever the client sent)
        let mut forwarded = packet.clone();
        forwarded.speaker = from;

        // 4. Route based on VoiceTarget
        match packet.target {
            VoiceTarget::All =&gt; {
                for client in &amp;self.clients {
                    if client.id != from &amp;&amp; !client.has_muted(from) {
                        client.send_voice(&amp;forwarded);
                    }
                }
            }
            VoiceTarget::Team =&gt; {
                for client in &amp;self.clients {
                    if client.id != from
                        &amp;&amp; client.team == self.clients[from].team
                        &amp;&amp; !client.has_muted(from)
                    {
                        client.send_voice(&amp;forwarded);
                    }
                }
            }
            VoiceTarget::Player(target) =&gt; {
                if let Some(client) = self.clients.get(target) {
                    if !client.has_muted(from) {
                        client.send_voice(&amp;forwarded);
                    }
                }
            }
        }
    }
}
<span class="boring">}</span></code></pre>
<p><strong>Relay bandwidth cost:</strong> The relay is a packet reflector for voice — it copies bytes without decoding. For an 8-player game where 2 players speak simultaneously at the default 32 kbps, the relay transmits: 2 speakers × 7 recipients × 5.4 KB/s = ~75.6 KB/s outbound. This is negligible for a server. The relay already handles order forwarding; voice adds proportionally small overhead.</p>
<h4 id="spatial-audio-optional"><a class="header" href="#spatial-audio-optional">Spatial Audio (Optional)</a></h4>
<p>Inspired by ioquake3’s <code>VOIP_SPATIAL</code> flag and Mumble’s positional audio plugin:</p>
<p>When <code>VoiceFlags::SPATIAL</code> is set, the receiving client spatializes the voice based on the speaker’s in-game position. The speaker’s position is derived from their primary selection or camera center — NOT transmitted in the voice packet (that would leak tactical information). The receiver’s client already knows all unit positions (lockstep sim), so it can compute relative direction and distance locally.</p>
<p><strong>Spatial audio is a D033 QoL toggle</strong> (<code>voice.spatial_audio: bool</code>, default <code>false</code>). When enabled, teammates’ voice is panned left/right based on where their units are on the map. This creates a natural “war room” effect — you hear your ally to your left when their base is left of yours.</p>
<p><strong>Why disabled by default:</strong> Spatial voice is disorienting if unexpected. Players accustomed to centered voice chat need to opt in. Additionally, it only makes sense in team games with distinct player positions — 1v1 games get no benefit.</p>
<h4 id="browser-wasm-voip"><a class="header" href="#browser-wasm-voip">Browser (WASM) VoIP</a></h4>
<p>Native desktop clients use raw Opus-over-UDP through the <code>UdpTransport</code> (D054). Browser clients cannot use raw UDP — they use WebRTC for voice transport.</p>
<p><strong>str0m</strong> (github.com/algesten/str0m) is the recommended Rust WebRTC library:</p>
<ul>
<li>Pure Rust, Sans I/O (no internal threads — matches IC’s architecture)</li>
<li>Frame-level and RTP-level APIs</li>
<li>Multiple crypto backends (aws-lc-rs, ring, OpenSSL, platform-native)</li>
<li>Bandwidth estimation (BWE), NACK, Simulcast support</li>
<li><code>&amp;mut self</code> pattern — no internal mutexes</li>
<li>515+ stars, 43+ contributors, 602 dependents</li>
</ul>
<p>For browser builds, VoIP uses str0m’s WebRTC data channels routed through the relay. The relay bridges WebRTC ↔ raw UDP voice packets, enabling cross-platform voice between native and browser clients. The Opus payload is identical — only the transport framing differs.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// VoIP transport selection — the INITIAL transport chosen per platform.
/// This is a static selection at connection time (platform-dependent).
/// Runtime transport adaptation (e.g., UDP→TCP fallback) is handled by
/// VoiceTransportState (see § "Connection Recovery" below), which is a
/// separate state machine that manages degraded-mode transitions without
/// changing the VoiceTransport enum.
pub enum VoiceTransport {
    /// Raw Opus frames on MessageLane::Voice over UdpTransport.
    /// Desktop default. Lowest latency, lowest overhead.
    Native,
    /// Opus frames via WebRTC data channel (str0m).
    /// Browser builds. Higher overhead but compatible with browser APIs.
    WebRtc,
}
<span class="boring">}</span></code></pre>
<h4 id="muting-and-moderation"><a class="header" href="#muting-and-moderation">Muting and Moderation</a></h4>
<p>Per-player mute is client-side AND relay-enforced:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Action</th><th>Scope</th><th>Mechanism</th></tr>
</thead>
<tbody>
<tr><td><strong>Player mutes</strong></td><td>Client-side</td><td>Receiver ignores voice from muted player. Also sends mute hint to relay.</td></tr>
<tr><td><strong>Relay mute hint</strong></td><td>Server-side</td><td>Relay skips forwarding to the muting player — saves bandwidth.</td></tr>
<tr><td><strong>Admin mute</strong></td><td>Server-side</td><td>Relay drops all voice from the muted player. Cannot be overridden.</td></tr>
<tr><td><strong>Self-mute</strong></td><td>Client-side</td><td>PTT disabled, mic input stopped. “Muted” icon shown to other players.</td></tr>
<tr><td><strong>Self-deafen</strong></td><td>Client-side</td><td>All incoming voice silenced. “Deafened” icon shown.</td></tr>
</tbody>
</table>
</div>
<p><strong>Mute persistence:</strong> Per-player mute decisions are stored in local SQLite (D034) keyed by the player’s Ed25519 public key (D052). Muting “Bob” in one game persists across future games with the same player. The relay does not store mute relationships — mute is a client preference, communicated to the relay as a routing hint.</p>
<p><strong>Hotmic protection:</strong> If PTT is held continuously for longer than <code>voice.max_ptt_duration</code> (default 120 seconds, configurable), transmission is automatically cut and the player sees a “PTT timeout — release and re-press to continue” notification. This prevents stuck-key scenarios where a player unknowingly broadcasts for an entire match (keyboard malfunction, key binding conflict, cat on keyboard). Discord implements similar detection; CS2 cuts after ~60 seconds continuous transmission. The timeout resets immediately on key release — there is no cooldown.</p>
<p><strong>Communication abuse penalties:</strong> Repeated mute/report actions against a player across multiple games trigger <strong>progressive communication restrictions</strong> on that player’s community profile (D052/D053). The community server (D052) tracks reports per player:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Threshold</th><th>Penalty</th><th>Duration</th><th>Scope</th></tr>
</thead>
<tbody>
<tr><td>3 reports in 24h</td><td>Warning displayed to player</td><td>Immediate</td><td>Informational only</td></tr>
<tr><td>5 reports in 72h</td><td>Voice-restricted: team-only voice, no all-chat voice</td><td>24 hours</td><td>Per community server</td></tr>
<tr><td>10 reports in 7 days</td><td>Voice-muted: cannot transmit voice</td><td>72 hours</td><td>Per community server</td></tr>
<tr><td>Repeated offenses</td><td>Escalated to community moderators (D037) for manual review</td><td>Until resolved</td><td>Per community server</td></tr>
</tbody>
</table>
</div>
<p>Thresholds are configurable per community server — tournament communities may be stricter. Penalties are community-scoped (D052 federation), not global. A player comm-banned on one community can still speak on others. Text chat follows the same escalation path. False report abuse is itself a reportable offense.</p>
<h4 id="jitter-buffer"><a class="header" href="#jitter-buffer">Jitter Buffer</a></h4>
<p>Voice packets arrive with variable delay (network jitter). Without a jitter buffer, packets arriving late cause audio stuttering and packets arriving out-of-order cause gaps. Every production VoIP system uses a jitter buffer — Mumble, Discord, TeamSpeak, and WebRTC all implement one. D059 requires an <strong>adaptive jitter buffer</strong> per-speaker in <code>ic-audio</code>.</p>
<p><strong>Design rationale:</strong> A fixed jitter buffer (constant delay) wastes latency on good networks and is insufficient on bad networks. An adaptive buffer dynamically adjusts delay based on observed inter-arrival jitter — expanding when jitter increases (prevents drops) and shrinking when jitter decreases (minimizes latency). This is the universal approach in production VoIP systems (see <code>research/open-source-voip-analysis.md</code> § 6).</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Adaptive jitter buffer for voice playback.
/// Smooths variable packet arrival times into consistent playback.
/// One instance per speaker, managed by ic-audio.
///
/// Design informed by Mumble's audio pipeline and WebRTC's NetEq.
/// Mumble uses a similar approach with its Resynchronizer for echo
/// cancellation timing — IC generalizes this to all voice playback.
pub struct JitterBuffer {
    /// Ring buffer of received voice frames, indexed by sequence number.
    /// None entries represent lost or not-yet-arrived packets.
    frames: VecDeque&lt;Option&lt;VoiceFrame&gt;&gt;,
    /// Current playback delay in 20ms frame units.
    /// E.g., delay=3 means 60ms of buffered audio before playback starts.
    delay: u32,
    /// Minimum delay (frames). Default: 1 (20ms).
    min_delay: u32,
    /// Maximum delay (frames). Default: 10 (200ms).
    /// Above 200ms, voice feels too delayed for real-time conversation.
    max_delay: u32,
    /// Exponentially weighted moving average of inter-arrival jitter.
    jitter_estimate: f32,   // f32 OK — this is I/O, not sim
    /// Timestamp of last received frame for jitter calculation.
    last_arrival: Instant,
    /// Statistics: total frames received, lost, late, buffer expansions/contractions.
    stats: JitterStats,
}

impl JitterBuffer {
    /// Called when a voice packet arrives from the network.
    pub fn push(&amp;mut self, sequence: u32, opus_data: &amp;[u8], now: Instant) {
        // Update jitter estimate using EWMA
        let arrival_delta = now - self.last_arrival;
        let expected_delta = Duration::from_millis(20); // one frame period
        let jitter = (arrival_delta.as_secs_f32() - expected_delta.as_secs_f32()).abs();
        // Smoothing factor 0.9 — reacts within ~10 packets to jitter changes
        self.jitter_estimate = 0.9 * self.jitter_estimate + 0.1 * jitter;
        self.last_arrival = now;
        
        // Insert frame at correct position based on sequence number.
        // Handles out-of-order delivery by placing in the correct slot.
        self.insert_frame(sequence, opus_data);
        
        // Adapt buffer depth based on current jitter estimate
        self.adapt_delay();
    }
    
    /// Called every 20ms by the audio render thread.
    /// Returns the next frame to play, or None if the frame is missing.
    /// On None, the caller invokes Opus PLC (decoder with null input)
    /// to generate concealment audio from the previous frame's spectral envelope.
    pub fn pop(&amp;mut self) -&gt; Option&lt;VoiceFrame&gt; {
        self.frames.pop_front().flatten()
    }
    
    fn adapt_delay(&amp;mut self) {
        // Target: 2× jitter estimate + 1 frame covers ~95% of variance
        let target = ((2.0 * self.jitter_estimate * 50.0) as u32 + 1)
            .clamp(self.min_delay, self.max_delay);
        
        if target &gt; self.delay {
            // Increase delay: expand buffer immediately (insert silence frame)
            self.delay += 1;
        } else if target + 2 &lt; self.delay {
            // Decrease delay: only when significantly over-buffered
            // Hysteresis of 2 frames prevents oscillation on borderline networks
            self.delay -= 1;
        }
    }
}
<span class="boring">}</span></code></pre>
<p><strong>Packet Loss Concealment (PLC) integration:</strong> When <code>pop()</code> returns <code>None</code> (missing frame due to packet loss), the Opus decoder is called with null input (<code>opus_decode(null, 0, ...)</code>) to generate PLC audio. Opus’s built-in PLC extrapolates from the previous frame’s spectral envelope, producing a smooth fade-out over 3-5 lost frames. At 5% packet loss, PLC is barely audible. At 15% loss, artifacts become noticeable — this is where the <code>VoiceBitrateAdapter</code> reduces bitrate and increases FEC allocation. Combined with dynamic <code>OPUS_SET_PACKET_LOSS_PERC</code> (see Adaptive Bitrate above), the encoder and decoder cooperate: the encoder allocates more bits to FEC when loss is high, and the decoder conceals any remaining gaps.</p>
<h4 id="udp-connectivity-checks-and-tcp-tunnel-fallback"><a class="header" href="#udp-connectivity-checks-and-tcp-tunnel-fallback">UDP Connectivity Checks and TCP Tunnel Fallback</a></h4>
<p>Learned from Mumble’s protocol (see <code>research/open-source-voip-analysis.md</code> § 7): some networks block or heavily throttle UDP (corporate firewalls, restrictive NATs, aggressive ISP rate limiting). D059 must not assume voice always uses UDP.</p>
<p>Mumble solves this with a graceful fallback: the client sends periodic UDP ping packets; if responses stop, voice is tunneled through the TCP control connection transparently. IC adopts this pattern:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Voice transport state machine. Manages UDP/TCP fallback for voice.
/// Runs on each client independently. The relay accepts voice from
/// either transport — it doesn't care how the bytes arrived.
pub enum VoiceTransportState {
    /// UDP voice active. UDP pings succeeding.
    /// Default state when connection is established.
    UdpActive,
    /// UDP pings failing. Testing connectivity.
    /// Voice is tunneled through TCP/WebSocket during this state.
    /// UDP pings continue in background to detect recovery.
    UdpProbing {
        last_ping: Instant,
        consecutive_failures: u8,  // switch to TcpTunnel after 5 failures
    },
    /// UDP confirmed unavailable. Voice fully tunneled through TCP.
    /// Higher latency (~20-50ms from TCP queuing) but maintains connectivity.
    /// UDP pings continue every 5 seconds to detect recovery.
    TcpTunnel,
    /// UDP restored after tunnel period. Transitioning back.
    /// Requires 3 consecutive successful UDP pings before switching.
    UdpRestoring { consecutive_successes: u8 },
}
<span class="boring">}</span></code></pre>
<p><strong>How TCP tunneling works:</strong> Voice frames use the same <code>VoicePacket</code> binary format regardless of transport. When tunneled through TCP, voice packets are sent as a distinct message type on the existing control connection — the relay identifies the message type and forwards the voice payload normally. The relay doesn’t care whether voice arrived via UDP or TCP; it stamps the speaker ID and forwards to recipients.</p>
<p><strong>UI indicator:</strong> A small icon in the voice overlay shows the transport state — “Direct” (UDP, normal) or “Tunneled” (TCP, yellow warning icon). Tunneled voice has ~20-50ms additional latency from TCP head-of-line blocking but is preferable to no voice at all.</p>
<p><strong>Implementation phasing note (from Mumble documentation):</strong> “When implementing the protocol it is easier to ignore the UDP transfer layer at first and just tunnel the UDP data through the TCP tunnel. The TCP layer must be implemented for authentication in any case.” This matches IC’s phased approach — TCP-tunneled voice can ship in Phase 3 (alongside text chat), with UDP voice optimization in Phase 5.</p>
<h4 id="audio-preprocessing-pipeline"><a class="header" href="#audio-preprocessing-pipeline">Audio Preprocessing Pipeline</a></h4>
<p>The audio capture-to-encode pipeline in <code>ic-audio</code>. Order matters — this sequence is the standard across Mumble, Discord, WebRTC, and every production VoIP system (see <code>research/open-source-voip-analysis.md</code> § 8):</p>
<pre><code>Platform Capture (cpal) → Resample to 48kHz (rubato) →
  Echo Cancellation (optional, speaker users only) →
    Noise Suppression (nnnoiseless / RNNoise) →
      Voice Activity Detection (for VAD mode) →
        Opus Encode (audiopus, VOIP mode, FEC, DTX) →
          VoicePacket → MessageLane::Voice
</code></pre>
<p><strong>Recommended Rust crates for the pipeline:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Component</th><th>Crate</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td>Audio I/O</td><td><code>cpal</code></td><td>Cross-platform (WASAPI, CoreAudio, ALSA/PulseAudio, WASM AudioWorklet). Already used by Bevy’s audio ecosystem.</td></tr>
<tr><td>Resampler</td><td><code>rubato</code></td><td>Pure Rust, high quality async resampler. No C dependencies. Converts from mic sample rate to Opus’s 48kHz.</td></tr>
<tr><td>Noise suppression</td><td><code>nnnoiseless</code></td><td>Pure Rust port of Mozilla’s RNNoise. ML-based (GRU neural network). Dramatically better than DSP-based Speex preprocessing for non-stationary noise (keyboard clicks, fans, traffic). ~0.3% CPU cost per core — negligible.</td></tr>
<tr><td>Opus codec</td><td><code>audiopus</code></td><td>Safe Rust wrapper around libopus. Required. Handles encode/decode/PLC.</td></tr>
<tr><td>Echo cancellation</td><td>Speex AEC via <code>speexdsp-rs</code>, or browser-native</td><td>Full AEC only matters for speaker/laptop users (not headset). Mumble’s <code>Resynchronizer</code> shows this requires a ~20ms mic delay queue to ensure speaker data reaches the canceller first. Browser builds can use WebRTC’s built-in AEC.</td></tr>
</tbody>
</table>
</div>
<p><strong>Why RNNoise (<code>nnnoiseless</code>) over Speex preprocessing:</strong> Mumble supports both. RNNoise is categorically superior — it uses a recurrent neural network trained on 80+ hours of noise samples, whereas Speex uses traditional FFT-based spectral subtraction. RNNoise handles non-stationary noise (typing, mouse clicks — common in RTS gameplay) far better than Speex. The <code>nnnoiseless</code> crate is pure Rust (no C dependency), adding ~0.3% CPU per core versus Speex’s ~0.1%. This is negligible on any hardware that can run IC. Noise suppression is a D033 QoL toggle (<code>voice.noise_suppression: bool</code>, default <code>true</code>).</p>
<p><strong>Playback pipeline (receive side):</strong></p>
<pre><code>MessageLane::Voice → VoicePacket → JitterBuffer →
  Opus Decode (or PLC on missing frame) →
    Per-speaker gain (user volume setting) →
      Voice Effects Chain (if enabled — see below) →
        Spatial panning (if VoiceFlags::SPATIAL) →
          Mix with game audio → Platform Output (cpal/Bevy audio)
</code></pre>
<h4 id="voice-effects--enhancement"><a class="header" href="#voice-effects--enhancement">Voice Effects &amp; Enhancement</a></h4>
<p>Voice effects apply DSP processing to incoming voice on the <strong>receiver side</strong> — after Opus decode, before spatial panning and mixing. This is a deliberate architectural choice:</p>
<ul>
<li><strong>Receiver controls their experience.</strong> Alice hears radio-filtered voice; Bob hears clean audio. Neither imposes on the other.</li>
<li><strong>Clean audio preserved.</strong> The Opus-encoded stream in replays (voice-in-replay, D059 § 7) is unprocessed. Effects can be re-applied during replay playback with different presets — a caster might use clean voice while a viewer uses radio flavor.</li>
<li><strong>No codec penalty.</strong> Applying effects before Opus encoding wastes bits encoding the effect rather than the voice. Receiver-side effects are “free” from a compression perspective.</li>
<li><strong>Per-speaker effects.</strong> A player can assign different effects to different teammates (e.g., radio filter on ally A, clean for ally B) via per-speaker settings.</li>
</ul>
<h5 id="dsp-chain-architecture"><a class="header" href="#dsp-chain-architecture">DSP Chain Architecture</a></h5>
<p>Each voice effect preset is a composable chain of lightweight DSP stages:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// A single DSP processing stage. Implementations are stateful
/// (filters maintain internal buffers) but cheap — a biquad filter
/// processes 960 samples (20ms at 48kHz) in &lt;5 microseconds.
pub trait VoiceEffectStage: Send + 'static {
    /// Process samples in-place. Called on the audio thread.
    /// `sample_rate` is always 48000 (Opus output).
    fn process(&amp;mut self, samples: &amp;mut [f32], sample_rate: u32);

    /// Reset internal state. Called when a speaker stops and restarts
    /// (avoids filter ringing from stale state across transmissions).
    fn reset(&amp;mut self);

    /// Human-readable name for diagnostics.
    fn name(&amp;self) -&gt; &amp;str;
}

/// A complete voice effect preset — an ordered chain of DSP stages
/// plus optional transmission envelope effects (squelch tones).
pub struct VoiceEffectChain {
    pub stages: Vec&lt;Box&lt;dyn VoiceEffectStage&gt;&gt;,
    pub squelch: Option&lt;SquelchConfig&gt;,
    pub metadata: EffectMetadata,
}

/// Squelch tones — short audio cues on transmission start/end.
/// Classic military radio has a distinctive "roger beep."
pub struct SquelchConfig {
    pub start_tone_hz: u32,       // e.g., 1200 Hz
    pub end_tone_hz: u32,         // e.g., 800 Hz
    pub duration_ms: u32,         // e.g., 60ms
    pub volume: f32,              // 0.0-1.0, relative to voice
}

pub struct EffectMetadata {
    pub name: String,
    pub description: String,
    pub author: String,
    pub version: String,         // semver
    pub tags: Vec&lt;String&gt;,
}
<span class="boring">}</span></code></pre>
<p><strong>Built-in DSP stages</strong> (implemented in <code>ic-audio</code>, no external crate dependencies beyond <code>std</code> math):</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Stage</th><th>Parameters</th><th>Use</th><th>CPU Cost (960 samples)</th></tr>
</thead>
<tbody>
<tr><td><code>BiquadFilter</code></td><td><code>mode</code> (LP/HP/BP/notch/shelf), <code>freq_hz</code>, <code>q</code>, <code>gain</code></td><td>Band-pass for radio; high-shelf for presence; low-cut for clarity</td><td>~3 μs</td></tr>
<tr><td><code>Compressor</code></td><td><code>threshold_db</code>, <code>ratio</code>, <code>attack_ms</code>, <code>release_ms</code></td><td>Even out loud/quiet speakers; radio dynamic range control</td><td>~5 μs</td></tr>
<tr><td><code>SoftClipDistort</code></td><td><code>drive</code> (0.0-1.0), <code>mode</code> (soft_clip / tube / foldback)</td><td>Subtle harmonic warmth for vintage radio; tube saturation</td><td>~2 μs</td></tr>
<tr><td><code>NoiseGate</code></td><td><code>threshold_db</code>, <code>attack_ms</code>, <code>release_ms</code>, <code>hold_ms</code></td><td>Radio squelch — silence below threshold; clean up mic bleed</td><td>~3 μs</td></tr>
<tr><td><code>NoiseLayer</code></td><td><code>type</code> (static / crackle / hiss), <code>level_db</code>, <code>seed</code></td><td>Atmospheric static for radio presets; deterministic seed for consistency</td><td>~4 μs</td></tr>
<tr><td><code>SimpleReverb</code></td><td><code>decay_ms</code>, <code>mix</code> (0.0-1.0), <code>pre_delay_ms</code></td><td>Room/bunker ambiance; short decay for command post feel</td><td>~8 μs</td></tr>
<tr><td><code>DeEsser</code></td><td><code>frequency_hz</code>, <code>threshold_db</code>, <code>ratio</code></td><td>Sibilance reduction; tames harsh microphones</td><td>~5 μs</td></tr>
<tr><td><code>GainStage</code></td><td><code>gain_db</code></td><td>Level adjustment between stages; makeup gain after compression</td><td>~1 μs</td></tr>
<tr><td><code>FrequencyShift</code></td><td><code>shift_hz</code>, <code>mix</code> (0.0-1.0)</td><td>Subtle pitch shift for scrambled/encrypted effect</td><td>~6 μs</td></tr>
</tbody>
</table>
</div>
<p><strong>CPU budget:</strong> A 6-stage chain (typical for radio presets) costs ~25 μs per speaker per 20ms frame. With 8 simultaneous speakers, that’s 200 μs — well under 5% of the audio thread’s budget. Even aggressive 10-stage custom chains remain negligible.</p>
<p><strong>Why no external DSP crate:</strong> Audio DSP filter implementations are straightforward (a biquad is ~10 lines of Rust). External crates like <code>fundsp</code> or <code>dasp</code> are excellent for complex synthesis but add dependency weight for operations that IC needs in their simplest form. The built-in stages above total ~500 lines of Rust. If future effects need convolution reverb or FFT-based processing, <code>fundsp</code> becomes a justified dependency — but the Phase 3 built-in presets don’t require it.</p>
<h5 id="built-in-presets"><a class="header" href="#built-in-presets">Built-in Presets</a></h5>
<p>Six presets ship with IC, spanning practical enhancement to thematic immersion. All are defined in YAML — the same format modders use for custom presets.</p>
<p><strong>1. Clean Enhanced</strong> — <em>Practical voice clarity without character effects.</em></p>
<p>Noise gate removes mic bleed, gentle compression evens volume differences between speakers, de-esser tames harsh sibilance, and a subtle high-shelf adds presence. Recommended for competitive play where voice clarity matters more than atmosphere.</p>
<pre><code class="language-yaml">name: "Clean Enhanced"
description: "Improved voice clarity — compression, de-essing, noise gate"
tags: ["clean", "competitive", "clarity"]
chain:
  - type: noise_gate
    threshold_db: -42
    attack_ms: 1
    release_ms: 80
    hold_ms: 50
  - type: compressor
    threshold_db: -22
    ratio: 3.0
    attack_ms: 8
    release_ms: 60
  - type: de_esser
    frequency_hz: 6500
    threshold_db: -15
    ratio: 4.0
  - type: biquad_filter
    mode: high_shelf
    freq_hz: 3000
    q: 0.7
    gain_db: 2.0
</code></pre>
<p><strong>2. Military Radio</strong> — <em>NATO-standard HF radio. The signature IC effect.</em></p>
<p>Tight band-pass (300 Hz–3.4 kHz) matches real HF radio bandwidth. Compression squashes dynamic range like AGC circuitry. Subtle soft-clip distortion adds harmonic warmth. Noise gate creates a squelch effect. A faint static layer completes the illusion. Squelch tones mark transmission start/end — the distinctive “roger beep” of military comms.</p>
<pre><code class="language-yaml">name: "Military Radio"
description: "NATO HF radio — tight bandwidth, squelch, static crackle"
tags: ["radio", "military", "immersive", "cold-war"]
chain:
  - type: biquad_filter
    mode: high_pass
    freq_hz: 300
    q: 0.7
  - type: biquad_filter
    mode: low_pass
    freq_hz: 3400
    q: 0.7
  - type: compressor
    threshold_db: -18
    ratio: 6.0
    attack_ms: 3
    release_ms: 40
  - type: soft_clip_distortion
    drive: 0.12
    mode: tube
  - type: noise_gate
    threshold_db: -38
    attack_ms: 1
    release_ms: 100
    hold_ms: 30
  - type: noise_layer
    type: static_crackle
    level_db: -32
squelch:
  start_tone_hz: 1200
  end_tone_hz: 800
  duration_ms: 60
  volume: 0.25
</code></pre>
<p><strong>3. Field Radio</strong> — <em>Forward observer radio with environmental interference.</em></p>
<p>Wider band-pass than Military Radio (less “studio,” more “field”). Heavier static and occasional signal drift (subtle frequency wobble). No squelch tones — field conditions are rougher. The effect intensifies when <code>ConnectionQuality.quality_tier</code> drops (more static at lower quality) — adaptive degradation as a feature, not a bug.</p>
<pre><code class="language-yaml">name: "Field Radio"
description: "Frontline field radio — static interference, signal drift"
tags: ["radio", "military", "atmospheric", "cold-war"]
chain:
  - type: biquad_filter
    mode: high_pass
    freq_hz: 250
    q: 0.5
  - type: biquad_filter
    mode: low_pass
    freq_hz: 3800
    q: 0.5
  - type: compressor
    threshold_db: -20
    ratio: 4.0
    attack_ms: 5
    release_ms: 50
  - type: soft_clip_distortion
    drive: 0.20
    mode: soft_clip
  - type: noise_layer
    type: static_crackle
    level_db: -26
  - type: frequency_shift
    shift_hz: 0.3
    mix: 0.05
</code></pre>
<p><strong>4. Command Post</strong> — <em>Bunker-filtered comms with short reverb.</em></p>
<p>Short reverb (~180ms decay) creates the acoustic signature of a concrete command bunker. Slight band-pass and compression. No static — the command post has clean equipment. This is the “mission briefing room” voice.</p>
<pre><code class="language-yaml">name: "Command Post"
description: "Concrete bunker comms — short reverb, clean equipment"
tags: ["bunker", "military", "reverb", "cold-war"]
chain:
  - type: biquad_filter
    mode: high_pass
    freq_hz: 200
    q: 0.7
  - type: biquad_filter
    mode: low_pass
    freq_hz: 5000
    q: 0.7
  - type: compressor
    threshold_db: -20
    ratio: 3.5
    attack_ms: 5
    release_ms: 50
  - type: simple_reverb
    decay_ms: 180
    mix: 0.20
    pre_delay_ms: 8
</code></pre>
<p><strong>5. SIGINT Intercept</strong> — <em>Encrypted comms being decoded. For fun.</em></p>
<p>Frequency shifting, periodic glitch artifacts, and heavy processing create the effect of intercepted encrypted communications being partially decoded. Not practical for serious play — this is the “I’m playing a spy” preset.</p>
<pre><code class="language-yaml">name: "SIGINT Intercept"
description: "Intercepted encrypted communications — partial decode artifacts"
tags: ["scrambled", "spy", "fun", "cold-war"]
chain:
  - type: biquad_filter
    mode: band_pass
    freq_hz: 1500
    q: 2.0
  - type: frequency_shift
    shift_hz: 3.0
    mix: 0.15
  - type: soft_clip_distortion
    drive: 0.30
    mode: foldback
  - type: compressor
    threshold_db: -15
    ratio: 8.0
    attack_ms: 1
    release_ms: 30
  - type: noise_layer
    type: hiss
    level_db: -28
</code></pre>
<p><strong>6. Vintage Valve</strong> — <em>1940s vacuum tube radio warmth.</em></p>
<p>Warm tube saturation, narrower bandwidth than HF radio, gentle compression. Evokes WW2-era communications equipment. Pairs well with Tiberian Dawn’s earlier-era aesthetic.</p>
<pre><code class="language-yaml">name: "Vintage Valve"
description: "Vacuum tube radio — warm saturation, WW2-era bandwidth"
tags: ["radio", "vintage", "warm", "retro"]
chain:
  - type: biquad_filter
    mode: high_pass
    freq_hz: 350
    q: 0.5
  - type: biquad_filter
    mode: low_pass
    freq_hz: 2800
    q: 0.5
  - type: soft_clip_distortion
    drive: 0.25
    mode: tube
  - type: compressor
    threshold_db: -22
    ratio: 3.0
    attack_ms: 10
    release_ms: 80
  - type: gain_stage
    gain_db: -2.0
  - type: noise_layer
    type: hiss
    level_db: -30
squelch:
  start_tone_hz: 1000
  end_tone_hz: 600
  duration_ms: 80
  volume: 0.20
</code></pre>
<h5 id="enhanced-voice-isolation-background-voice-removal"><a class="header" href="#enhanced-voice-isolation-background-voice-removal">Enhanced Voice Isolation (Background Voice Removal)</a></h5>
<p>The user’s request for “getting rid of background voices” is addressed at two levels:</p>
<ol>
<li>
<p><strong>Sender-side (existing):</strong> <code>nnnoiseless</code> (RNNoise) already handles this on the capture side. RNNoise’s GRU neural network is trained specifically to isolate a primary speaker from background noise — including other voices. It performs well against TV audio, family conversations, and roommate speech because these register as non-stationary noise at lower amplitude than the primary mic input. This is already enabled by default (<code>voice.noise_suppression: true</code>).</p>
</li>
<li>
<p><strong>Receiver-side (new, optional):</strong> An enhanced isolation mode applies a second <code>nnnoiseless</code> pass on the decoded audio. This catches background voices that survived Opus compression (Opus preserves all audio above the encoding threshold — including faint background voices that RNNoise on the sender side left in). The double-pass is more aggressive but risks removing valid speaker audio in edge cases (e.g., two people talking simultaneously into one mic). Exposed as <code>voice.enhanced_isolation: bool</code> (D033 toggle, default <code>false</code>).</p>
</li>
</ol>
<p><strong>Why receiver-side isolation is optional:</strong> Double-pass noise suppression can create audible artifacts — “underwater” voice quality when the second pass is too aggressive. Most users will find sender-side RNNoise sufficient. Enhanced isolation is for environments where background voices are a persistent problem (shared rooms, open offices) and the speaker cannot control their environment.</p>
<h5 id="workshop-voice-effect-presets"><a class="header" href="#workshop-voice-effect-presets">Workshop Voice Effect Presets</a></h5>
<p>Voice effect presets are a Workshop resource type (D030), published and shared like any other mod resource:</p>
<p><strong>Resource type:</strong> <code>voice_effect</code> (Workshop category: “Voice Effects”)
<strong>File format:</strong> YAML with <code>.icvfx.yaml</code> extension (standard YAML — <code>serde_yaml</code> deserialization)
<strong>Version:</strong> Semver, following Workshop resource conventions (D030)</p>
<p><strong>Workshop preset structure:</strong></p>
<pre><code class="language-yaml"># File: radio_spetsnaz.icvfx.yaml
# Workshop metadata block (same as all Workshop resources)
workshop:
  name: "Spetsnaz Radio"
  description: "Soviet military radio — heavy static, narrow bandwidth, authentic squelch"
  author: "comrade_modder"
  version: "1.2.0"
  license: "CC-BY-4.0"
  tags: ["radio", "soviet", "military", "cold-war", "immersive"]
  # Optional LLM metadata (D016 narrative DNA)
  llm:
    tone: "Soviet military communications — terse, formal"
    era: "Cold War, 1980s"

# DSP chain — same format as built-in presets
chain:
  - type: biquad_filter
    mode: high_pass
    freq_hz: 400
    q: 0.8
  - type: biquad_filter
    mode: low_pass
    freq_hz: 2800
    q: 0.8
  - type: compressor
    threshold_db: -16
    ratio: 8.0
    attack_ms: 2
    release_ms: 30
  - type: soft_clip_distortion
    drive: 0.18
    mode: tube
  - type: noise_layer
    type: static_crackle
    level_db: -24
squelch:
  start_tone_hz: 1400
  end_tone_hz: 900
  duration_ms: 50
  volume: 0.30
</code></pre>
<p><strong>Preview before subscribing:</strong> The Workshop browser includes an “audition” feature — a 5-second sample voice clip (bundled with IC) is processed through the effect in real-time and played back. Players hear exactly what the effect sounds like before downloading. This uses the same DSP chain instantiation as live voice — no separate preview system.</p>
<p><strong>Validation:</strong> Workshop voice effects are pure data (YAML DSP parameters). The DSP stages are built-in engine code — presets cannot execute arbitrary code. Parameter values are clamped to safe ranges (e.g., <code>drive</code> 0.0-1.0, <code>freq_hz</code> 20-20000, <code>gain_db</code> -40 to +20). This is inherently sandboxed — a malicious preset can at worst produce unpleasant audio, never crash the engine or access the filesystem. If a <code>chain</code> stage references an unknown <code>type</code>, it is skipped with a warning log.</p>
<p><strong>CLI tooling:</strong> The <code>ic</code> CLI supports effect preset development:</p>
<pre><code class="language-bash">ic audio effect preview radio_spetsnaz.icvfx.yaml      # Preview with sample clip
ic audio effect validate radio_spetsnaz.icvfx.yaml      # Check YAML structure + param ranges
ic audio effect chain-info radio_spetsnaz.icvfx.yaml    # Print stage count, CPU estimate
ic workshop publish --type voice-effect radio_spetsnaz.icvfx.yaml
</code></pre>
<h5 id="voice-effect-settings-integration"><a class="header" href="#voice-effect-settings-integration">Voice Effect Settings Integration</a></h5>
<p>Updated <code>VoiceSettings</code> resource (additions in bold comments):</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Resource)]
pub struct VoiceSettings {
    pub noise_suppression: bool,       // D033 toggle, default true
    pub enhanced_isolation: bool,      // D033 toggle, default false — receiver-side double-pass
    pub spatial_audio: bool,           // D033 toggle, default false
    pub vad_mode: bool,                // false = PTT, true = VAD
    pub ptt_key: KeyCode,
    pub max_ptt_duration_secs: u32,    // hotmic protection, default 120
    pub effect_preset: Option&lt;String&gt;, // D033 setting — preset name or None for bypass
    pub effect_enabled: bool,          // D033 toggle, default false — master effect switch
    pub per_speaker_effects: HashMap&lt;PlayerId, String&gt;, // per-speaker override presets
}
<span class="boring">}</span></code></pre>
<p><strong>D033 QoL toggle pattern:</strong> Voice effects follow the same toggle pattern as spatial audio and noise suppression. The <code>effect_preset</code> name is a D033 setting (selectable in voice settings UI). Experience profiles (D033) can bundle a voice effect preset with other preferences — e.g., an “Immersive” profile might enable spatial audio + Military Radio effect + smart danger alerts.</p>
<p><strong>Audio thread sync:</strong> When <code>VoiceSettings</code> changes (user selects a new preset in the UI), the ECS → audio thread channel sends a <code>VoiceCommand::SetEffectPreset(chain)</code> message. The audio thread instantiates the new <code>VoiceEffectChain</code> and applies it starting from the next decoded frame. No glitch — the old chain’s state is discarded and the new chain processes from a clean <code>reset()</code> state.</p>
<h5 id="competitive-considerations"><a class="header" href="#competitive-considerations">Competitive Considerations</a></h5>
<p>Voice effects are <strong>cosmetic audio processing</strong> with no competitive implications:</p>
<ul>
<li><strong>Receiver-side only</strong> — what you hear is your choice, not imposed on others. No player gains information advantage from voice effects.</li>
<li><strong>No simulation interaction</strong> — effects run entirely in <code>ic-audio</code> on the playback thread. Zero contact with <code>ic-sim</code>.</li>
<li><strong>Tournament mode (D058):</strong> Tournament organizers can restrict voice effects via lobby settings (<code>voice_effects_allowed: bool</code>). Broadcast streams may want clean voice for professional production. The restriction is per-lobby, not global — community tournaments set their own rules.</li>
<li><strong>Replay casters:</strong> When casting replays with voice-in-replay, casters apply their own effect preset (or none). This means the same replay can sound like a military briefing or a clean podcast depending on the caster’s preference.</li>
</ul>
<h4 id="ecs-integration-and-audio-thread-architecture"><a class="header" href="#ecs-integration-and-audio-thread-architecture">ECS Integration and Audio Thread Architecture</a></h4>
<p>Voice state management uses Bevy ECS. The real-time audio pipeline runs on a dedicated thread. This follows the same pattern as Bevy’s own audio system — ECS components are the <em>control surface</em>; the audio thread is the <em>engine</em>.</p>
<p><strong>ECS components and resources</strong> (in <code>ic-audio</code> and <code>ic-net</code> systems, regular <code>Update</code> schedule — NOT in <code>ic-sim</code>’s <code>FixedUpdate</code>):</p>
<p><strong>Crate boundary note:</strong> <code>ic-audio</code> (voice processing, jitter buffer, Opus encode/decode) and <code>ic-net</code> (VoicePacket send/receive on <code>MessageLane::Voice</code>) do not depend on each other directly. The bridge is <code>ic-game</code>, which depends on both and wires them together at app startup: <code>ic-net</code> systems write incoming <code>VoicePacket</code> data to a crossbeam channel; <code>ic-audio</code> systems read from that channel to feed the jitter buffer. Outgoing voice follows the reverse path. This preserves crate independence while enabling data flow — the same integration pattern <code>ic-game</code> uses to wire <code>ic-sim</code> and <code>ic-net</code> via <code>ic-protocol</code>.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Attached to player entities. Updated by the voice network system
/// when VoicePackets arrive (or VoiceActivity orders are processed).
/// Queried by ic-ui to render speaker icons.
#[derive(Component)]
pub struct VoiceActivity {
    pub speaking: bool,
    pub last_transmission: Instant,
}

/// Per-player mute/deafen state. Written by UI and /mute commands.
/// Read by the voice network system to filter forwarding hints.
#[derive(Component)]
pub struct VoiceMuteState {
    pub self_mute: bool,
    pub self_deafen: bool,
    pub muted_players: HashSet&lt;PlayerId&gt;,
}

/// Per-player incoming voice volume (0.0–2.0). Written by UI slider.
/// Sent to the audio thread via channel for per-speaker gain.
#[derive(Component)]
pub struct VoiceVolume(pub f32);

/// Per-speaker diagnostics. Updated by the audio thread via channel.
/// Queried by ic-ui to render connection quality indicators.
#[derive(Component)]
pub struct VoiceDiagnostics {
    pub jitter_ms: f32,
    pub packet_loss_pct: f32,
    pub round_trip_ms: f32,
    pub buffer_depth_frames: u32,
    pub estimated_latency_ms: f32,
}

/// Global voice settings. Synced to audio thread on change.
#[derive(Resource)]
pub struct VoiceSettings {
    pub noise_suppression: bool,     // D033 toggle, default true
    pub enhanced_isolation: bool,    // D033 toggle, default false
    pub spatial_audio: bool,         // D033 toggle, default false
    pub vad_mode: bool,              // false = PTT, true = VAD
    pub ptt_key: KeyCode,
    pub max_ptt_duration_secs: u32,  // hotmic protection, default 120
    pub effect_preset: Option&lt;String&gt;, // D033 setting, None = bypass
    pub effect_enabled: bool,        // D033 toggle, default false
}
<span class="boring">}</span></code></pre>
<p><strong>ECS ↔ Audio thread communication</strong> via lock-free <code>crossbeam</code> channels:</p>
<pre><code>┌─────────────────────────────────────────────────────┐
│  ECS World (Bevy systems — ic-audio, ic-ui, ic-net) │
│                                                     │
│  Player entities:                                   │
│    VoiceActivity, VoiceMuteState, VoiceVolume,      │
│    VoiceDiagnostics                                 │
│                                                     │
│  Resources:                                         │
│    VoiceBitrateAdapter, VoiceTransportState,         │
│    PttState, VoiceSettings                          │
│                                                     │
│  Systems:                                           │
│    voice_ui_system — reads activity, renders icons  │
│    voice_settings_system — syncs settings to thread │
│    voice_network_system — sends/receives packets    │
│      via channels, updates diagnostics              │
└──────────┬──────────────────────────┬───────────────┘
           │ crossbeam channel        │ crossbeam channel
           │ (commands ↓)             │ (events ↑)
┌──────────▼──────────────────────────▼───────────────┐
│  Audio Thread (dedicated, NOT ECS-scheduled)        │
│                                                     │
│  Capture: cpal → resample → denoise → encode        │
│  Playback: jitter buffer → decode/PLC → mix → cpal  │
│                                                     │
│  Runs on OS audio callback cadence (~5-10ms)        │
└─────────────────────────────────────────────────────┘
</code></pre>
<p><strong>Why the audio pipeline cannot be an ECS system:</strong> ECS systems run on Bevy’s task pool at frame rate (16ms at 60fps, 33ms at 30fps). Audio capture/playback runs on OS audio threads with ~5ms deadlines via <code>cpal</code> callbacks. A jitter buffer that pops every 20ms cannot be driven by a system running at frame rate — the timing mismatch causes audible artifacts. The audio thread runs independently and communicates with ECS via channels: the ECS side sends commands (“PTT pressed”, “mute player X”, “change bitrate”) and receives events (“speaker X started”, “diagnostics update”, “encoded packet ready”).</p>
<p><strong>What lives where:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Concern</th><th>ECS?</th><th>Rationale</th></tr>
</thead>
<tbody>
<tr><td>Voice state (speaking, mute, volume)</td><td>Yes</td><td>Components on player entities, queried by UI systems</td></tr>
<tr><td>Voice settings (PTT key, noise suppress)</td><td>Yes</td><td>Bevy resource, synced to audio thread via channel</td></tr>
<tr><td>Voice effect preset selection</td><td>Yes</td><td>Part of VoiceSettings; chain instantiated on audio thread</td></tr>
<tr><td>Network send/receive (VoicePacket ↔ lane)</td><td>Yes</td><td>ECS system bridges network layer and audio thread</td></tr>
<tr><td>Voice UI (speaker icons, PTT indicator)</td><td>Yes</td><td>Standard Bevy UI systems querying voice components</td></tr>
<tr><td>Audio capture + encode pipeline</td><td>No</td><td>Dedicated audio thread, cpal callback timing</td></tr>
<tr><td>Jitter buffer + decode/PLC</td><td>No</td><td>Dedicated audio thread, 20ms frame cadence</td></tr>
<tr><td>Audio output + mixing</td><td>No</td><td>Bevy audio backend thread (existing)</td></tr>
</tbody>
</table>
</div>
<h4 id="ui-indicators"><a class="header" href="#ui-indicators">UI Indicators</a></h4>
<p>Voice activity is shown in the game UI:</p>
<ul>
<li><strong>In-game overlay:</strong> Small speaker icon next to the player’s name/color indicator when they are transmitting. Follows the same placement as SC2’s voice indicators (top-right player list).</li>
<li><strong>Lobby:</strong> Speaker icon pulses when a player is speaking. Volume slider per player.</li>
<li><strong>Chat log:</strong> <code>[VOICE] Alice is speaking</code> / <code>[VOICE] Alice stopped</code> timestamps in the chat log (optional, toggle via D033 QoL).</li>
<li><strong>PTT indicator:</strong> Small microphone icon in the bottom-right corner when PTT key is held. Red slash through it when self-muted.</li>
<li><strong>Connection quality:</strong> Per-speaker signal bars (1-4 bars) derived from <code>VoiceDiagnostics</code> — jitter, loss, and latency combined into a single quality score. Visible in the player list overlay next to the speaker icon. A player with consistently poor voice quality sees a tooltip: “Poor voice connection — high packet loss” to distinguish voice issues from game network issues. Transport state (“Direct” vs “Tunneled”) shown as a small icon when TCP fallback is active.</li>
<li><strong>Hotmic warning:</strong> If PTT exceeds 90 seconds (75% of the 120s auto-cut threshold), the PTT indicator turns yellow with a countdown. At 120s, it cuts and shows a brief “PTT timeout” notification.</li>
<li><strong>Voice diagnostics panel:</strong> <code>/voice diag</code> command opens a detailed overlay (developer/power-user tool) showing per-speaker jitter histogram, packet loss graph, buffer depth, estimated mouth-to-ear latency, and encode/decode CPU time. This is the equivalent of Discord’s “Voice &amp; Video Debug” panel.</li>
<li><strong>Voice effect indicator:</strong> When a voice effect preset is active, a small filter icon appears next to the microphone indicator. Hovering shows the active preset name (e.g., “Military Radio”). The icon uses the preset’s primary tag color (radio presets = olive drab, clean presets = blue, fun presets = purple).</li>
</ul>
<h4 id="competitive-voice-rules"><a class="header" href="#competitive-voice-rules">Competitive Voice Rules</a></h4>
<p>Voice behavior in competitive contexts requires explicit rules that D058’s tournament/ranked modes enforce:</p>
<p><strong>Voice during pause:</strong> Voice transmission continues during game pauses and tactical timeouts. Voice is I/O, not simulation — pausing the sim does not pause communication. This matches CS2 (voice continues during tactical timeout) and SC2 (voice unaffected by pause). Team coordination during pauses is a legitimate strategic activity.</p>
<p><strong>Eliminated player voice routing:</strong> When a player is eliminated (all units/structures destroyed), their voice routing depends on the game mode:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Mode</th><th>Eliminated player can…</th><th>Rationale</th></tr>
</thead>
<tbody>
<tr><td>Casual / unranked</td><td>Remain on team voice</td><td>Social experience; D021 eliminated-player roles (advisor, reinforcement controller) require voice</td></tr>
<tr><td>Ranked 1v1</td><td>N/A (game ends on elimination)</td><td>No team to talk to</td></tr>
<tr><td>Ranked team</td><td>Remain on team voice for 60 seconds, then observer-only</td><td>Brief window for handoff callouts, then prevents persistent backseat gaming. Configurable via tournament rules (D058)</td></tr>
<tr><td>Tournament</td><td>Configurable by organizer: permanent team voice, timed cutoff, or immediate observer-only</td><td>Tournament organizers decide the rule for their event</td></tr>
</tbody>
</table>
</div>
<p><strong>Ranked voice channel restrictions:</strong> In ranked matchmaking (D055), <code>VoiceTarget::All</code> (all-chat voice) is <strong>disabled</strong>. Players can only use <code>VoiceTarget::Team</code>. All-chat text remains available (for gg/glhf). This matches CS2 and Valorant’s competitive modes, which restrict voice to team-only. Rationale: cross-team voice is a toxicity vector and provides no competitive value. Tournament mode (D058) can re-enable all-voice if the organizer chooses (e.g., for show matches).</p>
<p><strong>Coach slot:</strong> Community servers (D052) can designate a <strong>coach slot</strong> per team — a non-playing participant who has team voice access but cannot issue orders. The coach sees the team’s shared vision (not full-map observer view). Coach voice routing uses <code>VoiceTarget::Team</code> but the coach’s <code>PlayerId</code> is flagged as <code>PlayerRole::Coach</code> in the lobby. Coaches are subject to the same mute/report system as players. For ranked, coach slots are disabled (pure player skill measurement). For tournaments, organizer configures per-event. This follows CS2’s coach system (voice during freezetime/timeouts, restricted during live rounds) but adapted for RTS where there are no freezetime rounds — the coach can speak at all times.</p>
<h3 id="3-beacons-and-tactical-pings"><a class="header" href="#3-beacons-and-tactical-pings">3. Beacons and Tactical Pings</a></h3>
<p>The non-verbal coordination layer. Research shows this is often more effective than voice for spatial RTS communication — Respawn Entertainment play-tested Apex Legends for a month with no voice chat and found their ping system “rendered voice chat with strangers largely unnecessary” (Polygon review). EA opened the underlying patent (US 11097189, “Contextually Aware Communications Systems”) for free use in August 2021.</p>
<h4 id="openra-beacon-compatibility-d024"><a class="header" href="#openra-beacon-compatibility-d024">OpenRA Beacon Compatibility (D024)</a></h4>
<p>OpenRA’s Lua API includes <code>Beacon</code> (map beacon management) and <code>Radar</code> (radar ping control) globals. IC must support these for mission script compatibility:</p>
<ul>
<li><code>Beacon.New(owner, pos, duration, palette, isPlayerPalette)</code> — create a map beacon</li>
<li><code>Radar.Ping(player, pos, color, duration)</code> — flash a radar ping on the minimap</li>
</ul>
<p>IC’s beacon system is a superset — OpenRA’s beacons are simple map markers with duration. IC adds contextual types, entity targeting, and the ping wheel (see below). OpenRA beacon/radar Lua calls map to <code>PingType::Generic</code> with appropriate visual parameters.</p>
<h4 id="ping-type-system"><a class="header" href="#ping-type-system">Ping Type System</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Contextual ping types. Each has a distinct visual, audio cue, and
/// minimap representation. The set is fixed at the engine level but
/// game modules can register additional types via YAML.
///
/// Inspired by Apex Legends' contextual ping system, adapted for RTS:
/// Apex pings communicate "what is here" for a shared 3D space.
/// RTS pings communicate "what should we do about this location" for
/// a top-down strategic view. The emphasis shifts from identification
/// to intent.
#[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, Serialize, Deserialize)]
pub enum PingType {
    /// General attention ping. "Look here."
    /// Default when no contextual modifier applies.
    Generic,
    /// Attack order suggestion. "Attack here / attack this unit."
    /// Shows crosshair icon. Red minimap flash.
    Attack,
    /// Defend order suggestion. "Defend this location."
    /// Shows shield icon. Blue minimap flash.
    Defend,
    /// Warning / danger alert. "Enemies here" or "be careful."
    /// Shows exclamation icon. Yellow minimap flash. Pulsing audio cue.
    Danger,
    /// Rally point. "Move units here" / "gather here."
    /// Shows flag icon. Green minimap flash.
    Rally,
    /// Request assistance. "I need help here."
    /// Shows SOS icon. Orange minimap flash with urgency pulse.
    Assist,
    /// Enemy spotted — marks a position where enemy units were seen.
    /// Auto-fades after the fog of war re-covers the area.
    /// Shows eye icon. Red blinking on minimap.
    EnemySpotted,
    /// Economic marker. "Expand here" / "ore field here."
    /// Shows resource icon. Green on minimap.
    Economy,
}
<span class="boring">}</span></code></pre>
<h4 id="contextual-ping-apex-legends-adaptation"><a class="header" href="#contextual-ping-apex-legends-adaptation">Contextual Ping (Apex Legends Adaptation)</a></h4>
<p>The ping type auto-selects based on what’s under the cursor when the ping key is pressed:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Cursor Target</th><th>Auto-Selected Ping</th><th>Visual</th></tr>
</thead>
<tbody>
<tr><td>Empty terrain (own territory)</td><td><code>Rally</code></td><td>Flag marker at position</td></tr>
<tr><td>Empty terrain (enemy territory)</td><td><code>Attack</code></td><td>Crosshair marker at position</td></tr>
<tr><td>Empty terrain (neutral/unexplored)</td><td><code>Generic</code></td><td>Diamond marker at position</td></tr>
<tr><td>Visible enemy unit</td><td><code>EnemySpotted</code></td><td>Eye icon tracking the unit briefly</td></tr>
<tr><td>Own damaged building</td><td><code>Assist</code></td><td>SOS icon on building</td></tr>
<tr><td>Ore field / resource</td><td><code>Economy</code></td><td>Resource icon at position</td></tr>
<tr><td>Fog-of-war edge</td><td><code>Danger</code></td><td>Exclamation at fog boundary</td></tr>
</tbody>
</table>
</div>
<p><strong>Override via ping wheel:</strong> Holding the ping key (default: <code>G</code>) opens a radial menu (ping wheel) showing all 8 ping types. Flick the mouse in the desired direction to select. Release to place. Quick-tap (no hold) uses the contextual default. This two-tier interaction (quick contextual + deliberate selection) follows Apex Legends’ proven UX pattern.</p>
<h4 id="ping-wheel-ui"><a class="header" href="#ping-wheel-ui">Ping Wheel UI</a></h4>
<pre><code>              Danger
         ╱            ╲
    Defend              Attack
       │    [cursor]     │
    Assist              Rally
         ╲            ╱
         Economy    EnemySpotted
              Generic
</code></pre>
<p>The ping wheel is a radial menu rendered by <code>ic-ui</code>. Each segment shows the ping type icon and name. The currently highlighted segment follows the mouse direction from center. Release places the selected ping type. Escape cancels.</p>
<p><strong>Controller support (Steam Deck / future console):</strong> Ping wheel opens on right stick click, direction selected via stick. Quick-ping on D-pad press.</p>
<h4 id="ping-properties"><a class="header" href="#ping-properties">Ping Properties</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// A placed ping marker. Managed by ic-ui (rendering) and forwarded
/// to the sim via PlayerOrder::TacticalPing for replay recording.
pub struct PingMarker {
    pub id: PingId,
    pub owner: PlayerId,
    pub ping_type: PingType,
    pub pos: WorldPos,
    /// If the ping was placed on a specific entity, track it.
    /// The marker follows the entity until it dies or the ping expires.
    pub tracked_entity: Option&lt;UnitTag&gt;,
    /// Ping lifetime. Default 8 seconds. Danger pings pulse.
    pub duration: Duration,
    /// Audio cue played on placement. Each PingType has a distinct sound.
    pub audio_cue: PingAudioCue,
    /// Tick when placed (for expiration).
    pub placed_at: u64,
}
<span class="boring">}</span></code></pre>
<p><strong>Ping rate limiting:</strong> Max 3 pings per 5 seconds per player (configurable). Exceeding the limit suppresses pings with a cooldown indicator. This prevents ping spam, which is a known toxicity vector in games with ping systems (LoL’s “missing” ping spam problem).</p>
<p><strong>Ping persistence:</strong> Pings are ephemeral — they expire after <code>duration</code> (default 8 seconds). They do NOT persist in save games. They DO appear in replays (via <code>PlayerOrder::TacticalPing</code> in the order stream).</p>
<p><strong>Audio feedback:</strong> Each ping type has a distinct short audio cue (&lt; 300ms). Incoming pings from teammates play the cue with a minimap flash. Audio volume follows the <code>voice.ping_volume</code> cvar (D058). Repeated rapid pings from the same player have diminishing audio (third ping in 5 seconds is silent) to reduce annoyance.</p>
<h3 id="4-novel-coordination-mechanics"><a class="header" href="#4-novel-coordination-mechanics">4. Novel Coordination Mechanics</a></h3>
<p>Beyond standard chat/voice/pings, IC introduces coordination tools not found in other RTS games:</p>
<h4 id="4a-chat-wheel-dota-2--rocket-league-pattern"><a class="header" href="#4a-chat-wheel-dota-2--rocket-league-pattern">4a. Chat Wheel (Dota 2 / Rocket League Pattern)</a></h4>
<p>A radial menu of pre-defined phrases that are:</p>
<ul>
<li><strong>Instantly sent</strong> — no typing, one keypress + flick</li>
<li><strong>Auto-translated</strong> — each phrase has a <code>phrase_id</code> that maps to the recipient’s locale, enabling communication across language barriers</li>
<li><strong>Replayable</strong> — sent as <code>PlayerOrder::ChatWheelPhrase</code> in the order stream</li>
</ul>
<pre><code class="language-yaml"># chat_wheel_phrases.yaml — game module provides these
chat_wheel:
  phrases:
    - id: 1
      category: tactical
      label:
        en: "Attack now!"
        de: "Jetzt angreifen!"
        ru: "Атакуем!"
        zh: "现在进攻!"
      audio_cue: "eva_attack"  # optional EVA voice line

    - id: 2
      category: tactical
      label:
        en: "Fall back!"
        de: "Rückzug!"
        ru: "Отступаем!"
        zh: "撤退!"
      audio_cue: "eva_retreat"

    - id: 3
      category: tactical
      label:
        en: "Defend the base!"
        de: "Basis verteidigen!"
        ru: "Защищайте базу!"
        zh: "防守基地!"

    - id: 4
      category: economy
      label:
        en: "Need more ore"
        de: "Brauche mehr Erz"
        ru: "Нужна руда"
        zh: "需要更多矿石"

    - id: 5
      category: social
      label:
        en: "Good game!"
        de: "Gutes Spiel!"
        ru: "Хорошая игра!"
        zh: "打得好！"
      audio_cue: null

    - id: 6
      category: social
      label:
        en: "Well played"
        de: "Gut gespielt"
        ru: "Хорошо сыграно"
        zh: "打得漂亮"

    # ... 20-30 phrases per game module, community can add more via mods
</code></pre>
<p><strong>Chat wheel key:</strong> Default <code>V</code>. Hold to open, flick to select, release to send. The phrase appears in team chat (or all chat, depending on category — social phrases go to all). The phrase displays in the recipient’s language, but the chat log also shows <code>[wheel]</code> tag so observers know it’s a pre-defined phrase.</p>
<p><strong>Why this matters for RTS:</strong> International matchmaking means players frequently cannot communicate by text. The chat wheel solves this with zero typing — the same phrase ID maps to every supported language. Dota 2 proved this works at scale across a global player base. For IC’s Cold War setting, phrases use military communication style: “Affirmative,” “Negative,” “Enemy contact,” “Position compromised.”</p>
<p><strong>Mod-extensible:</strong> Game modules (RA1, TD, community mods) provide their own phrase sets via YAML. The engine provides the wheel UI and <code>ChatWheelPhrase</code> order — the phrases are data, not code.</p>
<h4 id="4b-minimap-drawing"><a class="header" href="#4b-minimap-drawing">4b. Minimap Drawing</a></h4>
<p>Players can draw directly on the minimap to communicate tactical plans:</p>
<ul>
<li><strong>Activation:</strong> Hold <code>Alt</code> + click-drag on minimap (or <code>/draw</code> command via D058)</li>
<li><strong>Visual:</strong> Freeform line drawn in the player’s team color. Visible to teammates only.</li>
<li><strong>Duration:</strong> Drawings fade after 8 seconds (same as pings).</li>
<li><strong>Persistence:</strong> Drawings are sent as <code>PlayerOrder::MinimapDraw</code> — they appear in replays.</li>
<li><strong>Rate limit:</strong> Max 3 drawing strokes per 10 seconds, max 32 points per stroke. Prevents minimap vandalism.</li>
</ul>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Minimap drawing stroke. Points are quantized to cell resolution
/// to keep order size small. A typical stroke is 8-16 points.
pub struct MinimapStroke {
    pub points: Vec&lt;CellPos&gt;,    // max 32 points
    pub color: PlayerColor,
    pub thickness: u8,           // 1-3 pixels on minimap
    pub placed_at: u64,          // tick for expiration
}
<span class="boring">}</span></code></pre>
<p><strong>Why this is novel for RTS:</strong> Most RTS games have no minimap drawing. Players resort to rapid pinging to trace paths, which is imprecise and annoying. Minimap drawing enables “draw the attack route” coordination naturally. Some MOBA games (LoL) have minimap drawing; no major RTS does.</p>
<h4 id="4c-tactical-markers-persistent-team-annotations"><a class="header" href="#4c-tactical-markers-persistent-team-annotations">4c. Tactical Markers (Persistent Team Annotations)</a></h4>
<p>Unlike pings (ephemeral, 8 seconds) and drawings (ephemeral, 8 seconds), tactical markers are persistent annotations placed by team leaders:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Persistent tactical marker. Lasts until manually removed or game ends.
/// Limited to 10 per player, 30 per team. Intended for strategic planning,
/// not moment-to-moment callouts (that's what pings are for).
pub struct TacticalMarker {
    pub id: MarkerId,
    pub owner: PlayerId,
    pub marker_type: MarkerType,
    pub pos: WorldPos,
    pub label: Option&lt;String&gt;,   // max 16 chars, e.g., "Expand", "Ambush"
    pub placed_at: u64,
}

#[derive(Clone, Copy, Debug)]
pub enum MarkerType {
    /// Numbered waypoint (1-9). For coordinating multi-prong attacks.
    Waypoint(u8),
    /// Named objective marker. Shows label on the map.
    Objective,
    /// Hazard zone. Renders a colored radius indicating danger area.
    HazardZone { radius: u16 },
}
<span class="boring">}</span></code></pre>
<p><strong>Access:</strong> Place via ping wheel (hold longer to access marker submenu) or via commands (<code>/marker waypoint 1</code>, <code>/marker objective "Expand here"</code>, <code>/marker hazard 50</code>). Remove with <code>/marker clear</code> or right-click on existing marker.</p>
<p><strong>Use case:</strong> Before a coordinated push, the team leader places waypoint markers 1-3 showing the attack route, an objective marker on the target, and a hazard zone on the enemy’s defensive line. These persist until the push is complete, giving the team a shared tactical picture.</p>
<h4 id="4d-smart-danger-alerts-novel"><a class="header" href="#4d-smart-danger-alerts-novel">4d. Smart Danger Alerts (Novel)</a></h4>
<p>Automatic alerts that supplement manual pings with game-state-aware warnings:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Auto-generated alerts based on sim state. These are NOT orders —
/// they are client-side UI events computed locally from the shared sim state.
/// Each player's client generates its own alerts; no network traffic.
///
/// CRITICAL: All alerts involving enemy state MUST filter through the
/// player's current fog-of-war vision. In standard lockstep, each client
/// has the full sim state — querying enemy positions without vision
/// filtering would be a built-in maphack. The alert system calls
/// `FogProvider::is_visible(player, cell)` before considering any
/// enemy entity. Only enemies the player can currently see trigger alerts.
/// (In fog-authoritative relay mode per V26, this is solved at the data
/// level — the client simply doesn't have hidden enemy state.)
pub enum SmartAlert {
    /// Large enemy force detected moving toward the player's base.
    /// Triggered when &gt;= 5 **visible** enemy units are within N cells of
    /// the base and were not there on the previous check (debounced,
    /// 10-second cooldown). Units hidden by fog of war are excluded.
    IncomingAttack { direction: CompassDirection, unit_count: u32 },
    /// Ally's base is under sustained attack (&gt; 3 buildings damaged in
    /// 10 seconds). Only fires if the attacking units or damaged buildings
    /// are within the player's shared team vision.
    AllyUnderAttack { ally: PlayerId },
    /// Undefended expansion at a known resource location.
    /// Triggered when an ore field has no friendly structures or units nearby.
    /// This alert uses only friendly-side data, so no fog filtering is needed.
    UndefendedResource { pos: WorldPos },
    /// Enemy superweapon charging (if visible). RTS-specific high-urgency alert.
    /// Only fires if the superweapon structure is within the player's vision.
    SuperweaponWarning { weapon_type: String, estimated_ticks: u64 },
}
<span class="boring">}</span></code></pre>
<p><strong>Why client-side, not sim-side:</strong> Smart alerts are purely informational — they don’t affect gameplay. Computing them client-side means zero network cost and zero impact on determinism. Each client already has the full sim state (lockstep), but <strong>alerts must respect fog of war</strong> — only visible enemy units are considered. The <code>FogProvider</code> trait (D041) provides the vision query; alerts call <code>is_visible()</code> before evaluating any enemy entity. In fog-authoritative relay mode (V26 in <code>06-SECURITY.md</code>), this is inherently safe because the client never receives hidden enemy state. The alert thresholds are configurable via D033 QoL toggles.</p>
<p><strong>Why this is novel:</strong> No RTS engine has context-aware automatic danger alerts. Players currently rely on manual minimap scanning. Smart alerts reduce the cognitive load of map awareness without automating decision-making — they tell you <em>that</em> something is happening, not <em>what to do about it</em>. This is particularly valuable for newer players who haven’t developed the habit of constant minimap checking.</p>
<p><strong>Competitive consideration:</strong> Smart alerts are a D033 QoL toggle (<code>alerts.smart_danger: bool</code>, default <code>true</code>). Tournament hosts can disable them for competitive purity. Experience profiles (D033) bundle this toggle with other QoL settings.</p>
<h3 id="5-voice-in-replay--architecture--feasibility"><a class="header" href="#5-voice-in-replay--architecture--feasibility">5. Voice-in-Replay — Architecture &amp; Feasibility</a></h3>
<p>The user asked: “would it make sense technically speaking and otherwise, to keep player voice records in the replay?”</p>
<p><strong>Yes — technically feasible, precedented, and valuable. But: strictly opt-in with clear consent.</strong></p>
<h4 id="technical-approach"><a class="header" href="#technical-approach">Technical Approach</a></h4>
<p>Voice-in-replay follows ioquake3’s proven pattern (the only open-source game with this feature): inject Opus frames as tagged messages into the replay file alongside the order stream.</p>
<p>IC’s replay format (<code>05-FORMATS.md</code>) already separates streams:</p>
<ul>
<li><strong>Order stream</strong> — deterministic tick frames (for playback)</li>
<li><strong>Analysis event stream</strong> — sampled sim state (for stats tools)</li>
</ul>
<p>Voice adds a third stream:</p>
<ul>
<li><strong>Voice stream</strong> — timestamped Opus frames (for communication context)</li>
</ul>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Replay file structure with voice stream.
/// Voice is a separate section with its own offset in the header.
/// Tools that don't need voice skip it entirely — zero overhead.
///
/// The voice stream is NOT required for replay playback — it adds
/// communication context, not gameplay data.
pub struct ReplayVoiceStream {
    /// Per-player voice tracks, each independently seekable.
    pub tracks: Vec&lt;VoiceTrack&gt;,
}

pub struct VoiceTrack {
    pub player: PlayerId,
    /// Whether this player consented to voice recording.
    /// If false, this track is empty (header only, no frames).
    pub consented: bool,
    pub frames: Vec&lt;VoiceReplayFrame&gt;,
}

pub struct VoiceReplayFrame {
    /// Game tick when this audio was transmitted.
    pub tick: u64,
    /// Opus-encoded audio data. Same codec as live audio.
    pub opus_data: Vec&lt;u8&gt;,
    /// Original voice target (team/all). Preserved for replay filtering.
    pub target: VoiceTarget,
}
<span class="boring">}</span></code></pre>
<p><strong>Header extension:</strong> The replay header (<code>ReplayHeader</code>) gains a new field:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct ReplayHeader {
    // ... existing fields ...
    pub voice_offset: u32,       // 0 if no voice stream
    pub voice_length: u32,       // Compressed length of voice stream
}
<span class="boring">}</span></code></pre>
<p>The <code>flags</code> field gains a <code>HAS_VOICE</code> bit. Replay viewers check this flag before attempting to load voice data.</p>
<h4 id="storage-cost"><a class="header" href="#storage-cost">Storage Cost</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Game Duration</th><th>Players Speaking</th><th>Avg Bitrate</th><th>DTX Savings</th><th>Voice Stream Size</th></tr>
</thead>
<tbody>
<tr><td>20 min</td><td>2 of 4</td><td>32 kbps</td><td>~40%</td><td>~1.3 MB</td></tr>
<tr><td>45 min</td><td>3 of 8</td><td>32 kbps</td><td>~40%</td><td>~4.7 MB</td></tr>
<tr><td>60 min</td><td>4 of 8</td><td>32 kbps</td><td>~40%</td><td>~8.3 MB</td></tr>
</tbody>
</table>
</div>
<p>Compare to the order stream: a 60-minute game’s order stream (compressed) is ~2-5 MB. Voice roughly doubles the replay size when all players are recorded. For <code>Minimal</code> replays (the default), voice adds 1-8 MB — still well within reasonable file sizes for modern storage.</p>
<p><strong>Mitigation:</strong> Voice data is LZ4-compressed independently of the order stream. Opus is already compressed (it does not benefit much from generic compression), so LZ4 primarily helps with the framing overhead and silence gaps.</p>
<h4 id="consent-model"><a class="header" href="#consent-model">Consent Model</a></h4>
<p><strong>Recording voice in replays is a serious privacy decision.</strong> The design must make consent explicit, informed, and revocable:</p>
<ol>
<li>
<p><strong>Opt-in, not opt-out.</strong> Voice recording for replays is disabled by default. Players enable it via a settings toggle (<code>replay.record_voice: bool</code>, default <code>false</code>).</p>
</li>
<li>
<p><strong>Per-session consent display.</strong> When joining a game where ANY player has voice recording enabled, all players see a notification: “Voice may be recorded for replay by: Alice, Bob.” This ensures no one is unknowingly recorded.</p>
</li>
<li>
<p><strong>Per-player granularity.</strong> Each player independently decides whether THEIR voice is recorded. Alice can record her own voice while Bob opts out — Bob’s track in the replay is empty.</p>
</li>
<li>
<p><strong>Relay enforcement.</strong> The relay server tracks each player’s recording consent flag. The replay writer (each client) only writes voice frames for consenting players. Even if a malicious client records non-consenting voice locally, the <em>shared</em> replay file (relay-signed, D007) contains only consented tracks.</p>
</li>
<li>
<p><strong>Post-game stripping.</strong> The <code>/replay strip-voice</code> command (D058) removes the voice stream from a replay file, producing a voice-free copy. Players can share gameplay replays without voice.</p>
</li>
<li>
<p><strong>No voice in ranked replays by default.</strong> Ranked match replays submitted for ladder certification (D055) strip voice automatically. Voice is a communication channel, not a gameplay record — it has no bearing on match verification.</p>
</li>
<li>
<p><strong>Legal compliance.</strong> In jurisdictions requiring two-party consent for recording (e.g., California, Germany), the per-session notification + opt-in model satisfies the consent requirement. Players who haven’t enabled recording cannot have their voice captured.</p>
</li>
</ol>
<h4 id="replay-playback-with-voice"><a class="header" href="#replay-playback-with-voice">Replay Playback with Voice</a></h4>
<p>During replay playback, voice is synchronized to the game tick:</p>
<ul>
<li>Voice frames are played at the tick they were originally transmitted</li>
<li>Fast-forward/rewind seeks the voice stream to the nearest frame boundary</li>
<li>Voice is mixed into playback audio at a configurable volume (<code>replay.voice_volume</code> cvar)</li>
<li>Individual player voice tracks can be muted/soloed (useful for analysis: “what was Alice saying when she attacked?”)</li>
<li>Voice target filtering: viewer can choose to hear only <code>All</code> chat, only <code>Team</code> chat, or both</li>
</ul>
<p><strong>Use cases for voice-in-replay:</strong></p>
<ul>
<li><strong>Tournament commentary:</strong> Casters can hear team communication during featured replays (with player consent), adding depth to analysis</li>
<li><strong>Coaching:</strong> A coach reviews a student’s replay with voice to understand decision-making context</li>
<li><strong>Community content:</strong> YouTubers/streamers share replays with natural commentary intact</li>
<li><strong>Post-game review:</strong> Players review their own team communication for improvement</li>
</ul>
<h3 id="6-security-considerations"><a class="header" href="#6-security-considerations">6. Security Considerations</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Vulnerability</th><th>Risk</th><th>Mitigation</th></tr>
</thead>
<tbody>
<tr><td><strong>Voice spoofing</strong></td><td>HIGH</td><td>Relay stamps <code>speaker: PlayerId</code> on all forwarded voice packets. Client-submitted speaker ID is overwritten. Same pattern as ioquake3 server-side VoIP.</td></tr>
<tr><td><strong>Voice DDoS</strong></td><td>MEDIUM</td><td>Rate limit: max 50 voice packets/sec per player (relay-enforced). Bandwidth cap: <code>MessageLane::Voice</code> has a 16 KB buffer — overflow drops oldest frames. Exceeding rate limit triggers mute + warning.</td></tr>
<tr><td><strong>Voice data in replays</strong></td><td>HIGH</td><td>Opt-in consent model (see § 5). Voice tracks only written for consenting players. <code>/replay strip-voice</code> for post-hoc removal. No voice in ranked replays by default.</td></tr>
<tr><td><strong>Ping spam / toxicity</strong></td><td>MEDIUM</td><td>Max 3 pings per 5 seconds per player. Diminishing audio on rapid pings. Report pathway for ping abuse.</td></tr>
<tr><td><strong>Chat flood</strong></td><td>LOW</td><td>5 messages per 3 seconds (relay-enforced). Slow mode indicator. Already addressed by ProtocolLimits (V15).</td></tr>
<tr><td><strong>Minimap drawing abuse</strong></td><td>LOW</td><td>Max 3 strokes per 10 seconds, 32 points per stroke. Drawings are team-only. Report pathway.</td></tr>
<tr><td><strong>Whisper harassment</strong></td><td>MEDIUM</td><td>Player-level mute persists across sessions (SQLite, D034). Whisper requires mutual non-mute (if either party has muted the other, whisper is silently dropped). Report → admin mute pathway.</td></tr>
<tr><td><strong>Observer voice coaching</strong></td><td>HIGH</td><td>In competitive/ranked games, observers cannot transmit voice to players. Observer <code>VoiceTarget::All/Team</code> is restricted to observer-only routing. Same isolation as observer chat.</td></tr>
<tr><td><strong>Content in voice data</strong></td><td>MEDIUM</td><td>IC does not moderate voice content in real-time (no speech-to-text analysis). Moderation is reactive: player reports + replay review. Community server admins (D052) can review voice replays of reported games.</td></tr>
</tbody>
</table>
</div>
<p><strong>New ProtocolLimits fields:</strong></p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct ProtocolLimits {
    // ... existing fields (V15) ...
    pub max_voice_packets_per_second: u32,    // 50 (1 per 20ms frame)
    pub max_voice_packet_size: usize,         // 256 bytes (covers single-frame 64kbps Opus
                                              // = ~160 byte payload + headers. Multi-frame
                                              // bundles (frame_count &gt; 1) send multiple packets,
                                              // not one oversized packet.)
    pub max_pings_per_interval: u32,          // 3 per 5 seconds
    pub max_minimap_draw_points: usize,       // 32 per stroke
    pub max_tactical_markers_per_player: u8,  // 10
    pub max_tactical_markers_per_team: u8,    // 30
}
<span class="boring">}</span></code></pre>
<h3 id="7-platform-considerations"><a class="header" href="#7-platform-considerations">7. Platform Considerations</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Platform</th><th>Text Chat</th><th>VoIP</th><th>Pings</th><th>Chat Wheel</th><th>Minimap Draw</th></tr>
</thead>
<tbody>
<tr><td><strong>Desktop</strong></td><td>Full keyboard</td><td>PTT or VAD; Opus/UDP</td><td>G key + wheel</td><td>V key + wheel</td><td>Alt+drag</td></tr>
<tr><td><strong>Browser (WASM)</strong></td><td>Full keyboard</td><td>PTT; Opus/WebRTC (str0m)</td><td>Same</td><td>Same</td><td>Same</td></tr>
<tr><td><strong>Steam Deck</strong></td><td>On-screen KB</td><td>PTT on trigger/bumper</td><td>D-pad or touchpad</td><td>D-pad submenu</td><td>Touch minimap</td></tr>
<tr><td><strong>Mobile (future)</strong></td><td>On-screen KB</td><td>PTT button on screen</td><td>Tap-hold on minimap</td><td>Radial menu on hold</td><td>Finger draw</td></tr>
</tbody>
</table>
</div>
<p><strong>Mobile minimap + bookmark coexistence:</strong> On phone/tablet layouts, camera bookmarks sit in a <strong>bookmark dock adjacent to the minimap/radar cluster</strong> rather than overloading minimap gestures. This keeps minimap interactions free for camera jump, pings, and drawing (D059), while giving touch players a fast, visible “save/jump camera location” affordance similar to C&amp;C Generals. Gesture priority is explicit: touches that start on bookmark chips stay bookmark interactions; touches that start on the minimap stay minimap interactions.</p>
<p><strong>Layout and handedness:</strong> The minimap cluster (minimap + alerts + bookmark dock) mirrors with the player’s handedness setting. The command rail remains on the dominant-thumb side, so minimap communication and camera navigation stay on the opposite side and don’t fight for the same thumb.</p>
<h3 id="8-lua-api-extensions-d024"><a class="header" href="#8-lua-api-extensions-d024">8. Lua API Extensions (D024)</a></h3>
<p>Building on the existing <code>Beacon</code> and <code>Radar</code> globals from OpenRA compatibility:</p>
<pre><code class="language-lua">-- Existing OpenRA globals (unchanged)
Beacon.New(owner, pos, duration, palette, isPlayerPalette)
Radar.Ping(player, pos, color, duration)

-- IC extensions
Ping.Place(player, pos, pingType)          -- Place a typed ping
Ping.PlaceOnTarget(player, target, pingType) -- Ping tracking an entity
Ping.Clear(player)                          -- Clear all pings from player
Ping.ClearAll()                             -- Clear all pings (mission use)

ChatWheel.Send(player, phraseId)           -- Trigger a chat wheel phrase
ChatWheel.RegisterPhrase(id, translations) -- Register a custom phrase

Marker.Place(player, pos, markerType, label) -- Place tactical marker
Marker.Remove(player, markerId)              -- Remove a marker
Marker.ClearAll(player)                      -- Clear all markers

Chat.Send(player, channel, message)        -- Send a chat message
Chat.SendToAll(player, message)            -- Convenience: all-chat
Chat.SendToTeam(player, message)           -- Convenience: team-chat
</code></pre>
<p><strong>Mission scripting use cases:</strong> Lua mission scripts can place scripted pings (“attack this target”), send narrated chat messages (briefing text during gameplay), and manage tactical markers (pre-placed waypoints for mission objectives). The <code>Chat.Send</code> function enables bot-style NPC communication in co-op scenarios.</p>
<h3 id="9-console-commands-d058-integration"><a class="header" href="#9-console-commands-d058-integration">9. Console Commands (D058 Integration)</a></h3>
<p>All coordination features are accessible via the command console:</p>
<pre><code>/all &lt;message&gt;           # Send to all-chat
/team &lt;message&gt;          # Send to team chat  
/w &lt;player&gt; &lt;message&gt;    # Whisper to player
/mute &lt;player&gt;           # Mute player (voice + text)
/unmute &lt;player&gt;         # Unmute player
/mutelist                # Show muted players
/voice volume &lt;0-100&gt;    # Set incoming voice volume
/voice ptt &lt;key&gt;         # Set push-to-talk key
/voice toggle            # Toggle voice on/off
/voice diag              # Open voice diagnostics overlay
/voice effect list       # List available effect presets (built-in + Workshop)
/voice effect set &lt;name&gt; # Apply effect preset (e.g., "Military Radio")
/voice effect off        # Disable voice effects
/voice effect preview &lt;name&gt;  # Play sample clip with effect applied
/voice effect info &lt;name&gt;     # Show preset details (stages, CPU estimate, author)
/voice isolation toggle  # Toggle enhanced voice isolation (receiver-side double-pass)
/ping &lt;type&gt; [x] [y]     # Place a ping (type: attack, defend, danger, etc.)
/ping clear              # Clear your pings
/draw                    # Toggle minimap drawing mode
/marker &lt;type&gt; [label]   # Place tactical marker at cursor
/marker clear [id|all]   # Remove marker(s)
/wheel &lt;phrase_id&gt;       # Send chat wheel phrase by ID
/replay strip-voice &lt;file&gt; # Remove voice from replay file
</code></pre>
<h3 id="alternatives-considered-1"><a class="header" href="#alternatives-considered-1">Alternatives Considered</a></h3>
<ul>
<li><strong>External voice only (Discord/TeamSpeak/Mumble)</strong> (rejected — external voice is the status quo for OpenRA and it’s the #1 friction point for new players. Forcing third-party voice excludes casual players, fragments the community, and makes beacons/pings impossible to synchronize with voice. Built-in voice is table stakes for a modern multiplayer game. However, deep analysis of Mumble’s protocol, Janus SFU, and str0m’s sans-I/O WebRTC directly informed IC’s VoIP design — see <code>research/open-source-voip-analysis.md</code> for the full survey.)</li>
<li><strong>P2P voice instead of relay-forwarded</strong> (rejected — P2P voice exposes player IP addresses to all participants. This is a known harassment vector: competitive players have been DDoS’d via IPs obtained from game voice. Relay-forwarded voice maintains D007’s IP privacy guarantee. The bandwidth cost is negligible for the relay.)</li>
<li><strong>WebRTC for all platforms</strong> (rejected — WebRTC’s complexity (ICE negotiation, STUN/TURN, DTLS) is unnecessary overhead for native desktop clients that already have a UDP connection to the relay. Raw Opus-over-UDP is simpler, lower latency, and sufficient. WebRTC is used only for browser builds where raw UDP is unavailable.)</li>
<li><strong>Voice activation (VAD) as default</strong> (rejected — VAD transmits background noise, keyboard sounds, and private conversations. Every competitive game that tried VAD-by-default reverted to PTT-by-default. VAD remains available as a user preference for casual play.)</li>
<li><strong>Voice moderation via speech-to-text</strong> (rejected — real-time STT is compute-intensive, privacy-invasive, unreliable across accents/languages, and creates false positive moderation actions. Reactive moderation via reports + voice replay review is more appropriate. IC is not a social platform with tens of millions of users — community-scale moderation (D037/D052) is sufficient.)</li>
<li><strong>Always-on voice recording in replays</strong> (rejected — recording without consent is a privacy violation in many jurisdictions. Even with consent, always-on recording creates storage overhead for every game. Opt-in recording is the correct default. ioquake3 records voice in demos by default, but ioquake3 predates modern privacy law.)</li>
<li><strong>Opus alternative: Lyra/Codec2</strong> (rejected — Lyra is a Google ML-based codec with excellent compression (3 kbps) but requires ML model distribution, is not WASM-friendly, and has no Rust bindings. Codec2 is designed for amateur radio with lower quality than Opus at comparable bitrates. Opus is the industry standard, has mature Rust bindings, and is universally supported.)</li>
<li><strong>Custom ping types per mod</strong> (partially accepted — the engine defines the 8 core ping types; game modules can register additional types via YAML. This avoids UI inconsistency while allowing mod creativity. Custom ping types inherit the rate-limiting and visual framework.)</li>
<li><strong>Sender-side voice effects</strong> (rejected — applying DSP effects before Opus encoding wastes codec bits on the effect rather than the voice, degrades quality, and forces the sender’s aesthetic choice on all listeners. Receiver-side effects let each player choose their own experience while preserving clean audio for replays and broadcast.)</li>
<li><strong>External DSP library (fundsp/dasp) for voice effects</strong> (deferred — the built-in DSP stages (biquad, compressor, soft-clip, noise gate, reverb, de-esser) are ~500 lines of straightforward Rust. External libraries add dependency weight for operations that don’t need their generality. If future effects require convolution reverb or FFT-based processing, <code>fundsp</code> becomes a justified addition.)</li>
<li><strong>Voice morphing / pitch shifting</strong> (deferred — AI-powered voice morphing (deeper voice, gender shifting, character voices) is technically feasible but raises toxicity concerns: voice morphing enables identity manipulation in team games. Competitive games that implemented voice morphing (Fortnite’s party effects) limit it to cosmetic fun modes. IC could add this as a Phase 7 Workshop resource type with appropriate social guardrails — deferred, not rejected.)</li>
<li><strong>Shared audio channels / proximity voice</strong> (deferred — proximity voice where you hear players based on their units’ positions is interesting for immersive scenarios but confusing for competitive play. The <code>SPATIAL</code> flag provides spatial panning as a toggle-able approximation. Full proximity voice could be added in Phase 7 as an optional game mode feature.)</li>
</ul>
<h3 id="integration-with-existing-decisions-1"><a class="header" href="#integration-with-existing-decisions-1">Integration with Existing Decisions</a></h3>
<ul>
<li><strong>D006 (NetworkModel):</strong> Voice is not a NetworkModel concern — it is an <code>ic-net</code> service that sits alongside <code>NetworkModel</code>, using the same <code>Transport</code> connection but on a separate <code>MessageLane</code>. <code>NetworkModel</code> handles orders; voice forwarding is independent.</li>
<li><strong>D007 (Relay Server):</strong> Voice packets are relay-forwarded, maintaining IP privacy and consistent routing. The relay’s voice forwarding is stateless — it copies bytes without decoding Opus. The relay’s rate limiting (per-player voice packet cap) defends against voice DDoS.</li>
<li><strong>D024 (Lua API):</strong> IC extends Beacon and Radar globals with <code>Ping</code>, <code>ChatWheel</code>, <code>Marker</code>, and <code>Chat</code> globals. OpenRA beacon/radar calls map to IC’s ping system with <code>PingType::Generic</code>.</li>
<li><strong>D033 (QoL Toggles):</strong> Spatial audio, voice effects (preset selection), enhanced voice isolation, smart danger alerts, ping sounds, voice recording are individually toggleable. Experience profiles (D033) bundle communication preferences — e.g., an “Immersive” profile enables spatial audio + Military Radio voice effect + smart danger alerts.</li>
<li><strong>D054 (Transport):</strong> On native builds, voice uses the same <code>Transport</code> trait connection as orders — Opus frames are sent on <code>MessageLane::Voice</code> over <code>UdpTransport</code>. On browser builds, voice uses a parallel <code>str0m</code> WebRTC session <em>alongside</em> (not through) the <code>Transport</code> trait, because browser audio capture/playback requires WebRTC media APIs. The relay bridges between the two: it receives voice from native clients on <code>MessageLane::Voice</code> and from browser clients via WebRTC, then forwards to each recipient using their respective transport. The <code>VoiceTransport</code> enum (<code>Native</code> / <code>WebRtc</code>) selects the appropriate path per platform.</li>
<li><strong>D055 (Ranked Matchmaking):</strong> Voice is stripped from ranked replay submissions. Chat and pings are preserved (they are orders in the deterministic stream).</li>
<li><strong>D058 (Chat/Command Console):</strong> All coordination features are accessible via console commands. D058 defined the input system; D059 defines the routing, voice, spatial signaling, and voice effect selection that D058’s commands control. The <code>/all</code>, <code>/team</code>, <code>/w</code> commands were placeholder in D058 — D059 specifies their routing implementation. Voice effect commands (<code>/voice effect list</code>, <code>/voice effect set</code>, <code>/voice effect preview</code>) give console-first access to the voice effects system.</li>
<li><strong>05-FORMATS.md (Replay Format):</strong> Voice stream extends the replay file format with a new section. The replay header gains <code>voice_offset</code>/<code>voice_length</code> fields and a <code>HAS_VOICE</code> flag bit. Voice is independent of the order and analysis streams — tools that don’t process voice ignore it.</li>
<li><strong>06-SECURITY.md:</strong> New <code>ProtocolLimits</code> fields for voice, ping, and drawing rate limits. Voice spoofing prevention (relay-stamped speaker ID). Voice-in-replay consent model addresses privacy requirements.</li>
<li><strong>D010 (Snapshots) / Analysis Event Stream:</strong> The replay analysis event stream now includes <strong>camera position samples</strong> (<code>CameraPositionSample</code>), <strong>selection tracking</strong> (<code>SelectionChanged</code>), <strong>control group events</strong> (<code>ControlGroupEvent</code>), <strong>ability usage</strong> (<code>AbilityUsed</code>), <strong>pause events</strong> (<code>PauseEvent</code>), and <strong>match end events</strong> (<code>MatchEnded</code>) — see <code>05-FORMATS.md</code> § “Analysis Event Stream” for the full enum. Camera samples are lightweight (~8 bytes per player per sample at 2 Hz = ~1 KB/min for 8 players). D059 notes this integration because voice-in-replay is most valuable when combined with camera tracking — hearing what a player said while seeing what they were looking at.</li>
<li><strong>03-NETCODE.md (Match Lifecycle):</strong> D059’s competitive voice rules (pause behavior, eliminated player routing, ranked restrictions, coach slot) integrate with the match lifecycle protocol defined in <code>03-NETCODE.md</code> § “Match Lifecycle.” Voice pause behavior follows the game pause state — voice continues during pause per D059’s competitive voice rules. Surrender and disconnect events affect voice routing (eliminated-to-observer transition). The <strong>In-Match Vote Framework</strong> (<code>03-NETCODE.md</code> § “In-Match Vote Framework”) extends D059’s tactical coordination: tactical polls build on the chat wheel phrase system (<code>poll: true</code> phrases in <code>chat_wheel_phrases.yaml</code>), and <code>/callvote</code> commands are registered via D058’s Brigadier command tree. See vote framework research: <code>research/vote-callvote-system-analysis.md</code>.</li>
</ul>
<h3 id="shared-infrastructure-voice-game-netcode--workshop-cross-pollination"><a class="header" href="#shared-infrastructure-voice-game-netcode--workshop-cross-pollination">Shared Infrastructure: Voice, Game Netcode &amp; Workshop Cross-Pollination</a></h3>
<p>IC’s voice system (D059), game netcode (<code>03-NETCODE.md</code>), and Workshop distribution (D030/D049/D050) share underlying networking patterns. This section documents concrete improvements that flow between them — shared infrastructure that avoids duplicate work and strengthens all three systems.</p>
<h4 id="unified-connection-quality-monitor"><a class="header" href="#unified-connection-quality-monitor">Unified Connection Quality Monitor</a></h4>
<p>Both voice (D059’s <code>VoiceBitrateAdapter</code>) and game netcode (<code>03-NETCODE.md</code> § Adaptive Run-Ahead) independently monitor connection quality to adapt their behavior. Voice adjusts Opus bitrate based on packet loss and RTT. Game adjusts order submission timing based on relay timing feedback. Both systems need the same measurements — yet without coordination, they probe independently.</p>
<p><strong>Improvement:</strong> A single <code>ConnectionQuality</code> resource in <code>ic-net</code>, updated by the relay connection, feeds both systems:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Shared connection quality state — updated by the relay connection,
/// consumed by voice, game netcode, and Workshop download scheduler.
#[derive(Resource)]
pub struct ConnectionQuality {
    pub rtt_ms: u32,                  // smoothed RTT (EWMA)
    pub rtt_variance_ms: u32,         // jitter estimate
    pub packet_loss_pct: u8,          // 0-100, rolling window
    pub bandwidth_estimate_kbps: u32, // estimated available bandwidth
    pub quality_tier: QualityTier,    // derived summary for quick decisions
}

pub enum QualityTier {
    Excellent,  // &lt;30ms RTT, &lt;1% loss
    Good,       // &lt;80ms RTT, &lt;3% loss
    Fair,       // &lt;150ms RTT, &lt;5% loss  
    Poor,       // &lt;300ms RTT, &lt;10% loss
    Critical,   // &gt;300ms RTT or &gt;10% loss
}
<span class="boring">}</span></code></pre>
<p><strong>Who benefits:</strong></p>
<ul>
<li><strong>Voice:</strong> <code>VoiceBitrateAdapter</code> reads <code>ConnectionQuality</code> instead of maintaining its own RTT/loss measurements. Bitrate decisions align with the game connection’s actual state.</li>
<li><strong>Game netcode:</strong> Adaptive run-ahead uses the same smoothed RTT that voice uses, ensuring consistent latency estimation across systems.</li>
<li><strong>Workshop downloads:</strong> Large package downloads (D049) can throttle based on <code>bandwidth_estimate_kbps</code> during gameplay — never competing with order delivery or voice. Downloads pause automatically when <code>quality_tier</code> drops to <code>Poor</code> or <code>Critical</code>.</li>
</ul>
<h4 id="voice-jitter-buffer--game-order-buffering"><a class="header" href="#voice-jitter-buffer--game-order-buffering">Voice Jitter Buffer ↔ Game Order Buffering</a></h4>
<p>D059’s adaptive jitter buffer (EWMA-based target depth, packet loss concealment) solves the same fundamental problem as game order delivery: variable-latency packet arrival that must be smoothed into regular consumption.</p>
<p><strong>Voice → Game improvement:</strong> The jitter buffer’s adaptive EWMA algorithm can inform the game’s run-ahead calculation. Currently, adaptive run-ahead adjusts order submission timing based on relay feedback. The voice jitter buffer’s <code>target_depth</code> — computed from the same connection’s actual packet arrival variance — provides a more responsive signal: if voice packets are arriving with high jitter, game order submission should also pad its timing.</p>
<p><strong>Game → Voice improvement:</strong> The game netcode’s token-based liveness check (nonce echo, <code>03-NETCODE.md</code> § Anti-Lag-Switch) detects frozen clients within one missed token. The voice system should use the same liveness signal — if the game connection’s token check fails (client frozen), the voice system can immediately switch to PLC (Opus Packet Loss Concealment) rather than waiting for voice packet timeouts. This reduces the detection-to-concealment latency from ~200ms (voice timeout) to ~33ms (one game tick).</p>
<h4 id="lane-priority--voiceorder-bandwidth-arbitration"><a class="header" href="#lane-priority--voiceorder-bandwidth-arbitration">Lane Priority &amp; Voice/Order Bandwidth Arbitration</a></h4>
<p>D059 uses <code>MessageLane::Voice</code> (priority tier 1, weight 2) alongside game orders (<code>MessageLane::Orders</code>, priority tier 0). The lane system already prevents voice from starving orders. But the interaction can be tighter:</p>
<p><strong>Improvement:</strong> When <code>ConnectionQuality.quality_tier</code> drops to <code>Poor</code>, the voice system should proactively reduce bitrate <em>before</em> the lane system needs to drop voice packets. The sequence:</p>
<ol>
<li><code>ConnectionQuality</code> detects degradation</li>
<li><code>VoiceBitrateAdapter</code> drops to minimum bitrate (16 kbps) preemptively</li>
<li>Lane scheduler sees reduced voice traffic, allocates freed bandwidth to order reliability (retransmits)</li>
<li>When quality recovers, voice ramps back up over 2 seconds</li>
</ol>
<p>This is better than the current design where voice and orders compete reactively — the voice system cooperates proactively because it reads the same quality signal.</p>
<h4 id="workshop-p2p-distribution--spectator-feeds"><a class="header" href="#workshop-p2p-distribution--spectator-feeds">Workshop P2P Distribution ↔ Spectator Feeds</a></h4>
<p>D049’s BitTorrent/WebTorrent infrastructure for Workshop package distribution can serve double duty:</p>
<p><strong>Spectator feed fan-out:</strong> When a popular tournament match has 500+ spectators, the relay server becomes a bandwidth bottleneck (broadcasting delayed <code>TickOrders</code> to all spectators). Workshop’s P2P distribution pattern solves this: the relay sends the spectator feed to N seed peers, who redistribute to other spectators via WebTorrent. The feed is chunked by tick range (matching the replay format’s 256-tick LZ4 blocks) — each chunk is a small torrent piece that peers can share immediately after receiving it.</p>
<p><strong>Replay distribution:</strong> Tournament replays often see thousands of downloads in the first hour. Instead of serving from a central server, popular <code>.icrep</code> files can use Workshop’s BitTorrent distribution — the replay file format’s block structure (header + per-256-tick LZ4 chunks) maps naturally to torrent pieces.</p>
<h4 id="unified-cryptographic-identity"><a class="header" href="#unified-cryptographic-identity">Unified Cryptographic Identity</a></h4>
<p>Five systems independently use Ed25519 signing:</p>
<ol>
<li><strong>Game netcode</strong> — relay server signs <code>CertifiedMatchResult</code> (D007)</li>
<li><strong>Voice</strong> — relay stamps speaker ID on forwarded voice packets (D059)</li>
<li><strong>Replay</strong> — signature chain hashes each tick (05-FORMATS.md)</li>
<li><strong>Workshop</strong> — package signatures (D049)</li>
<li><strong>Community servers</strong> — SCR credential records (D052)</li>
</ol>
<p><strong>Improvement:</strong> A single <code>IdentityProvider</code> in <code>ic-net</code> manages the relay’s signing key and exposes a <code>sign(payload: &amp;[u8])</code> method. All five systems call this instead of independently managing <code>ed25519_dalek</code> instances. Key rotation (required for long-running servers) happens in one place. The <code>SignatureScheme</code> enum (D054) gates algorithm selection for all five systems uniformly.</p>
<h4 id="voice-preprocessing--workshop-audio-content"><a class="header" href="#voice-preprocessing--workshop-audio-content">Voice Preprocessing ↔ Workshop Audio Content</a></h4>
<p>D059’s audio preprocessing pipeline (noise suppression via <code>nnnoiseless</code>, echo cancellation via <code>speexdsp-rs</code>, Opus encoding via <code>audiopus</code>) is a complete audio processing chain that has value beyond real-time voice:</p>
<p><strong>Workshop audio quality tool:</strong> Content creators producing voice packs, announcer mods, and sound effect packs for the Workshop can use the same preprocessing pipeline as a quality normalization tool (<code>ic audio normalize</code>). This ensures Workshop audio content meets consistent quality standards (sample rate, loudness, noise floor) without requiring creators to own professional audio software.</p>
<p><strong>Workshop voice effect presets:</strong> The DSP stages used in voice effects (biquad filters, compressors, reverb, distortion) are shared infrastructure between the real-time voice effects chain and the <code>ic audio effect</code> CLI tools. Content creators developing custom voice effect presets use the same <code>ic audio effect preview</code> and <code>ic audio effect validate</code> commands that the engine uses to instantiate chains at runtime. The YAML preset format is a Workshop resource type — presets are published, versioned, rated, and discoverable through the same Workshop browser as maps and mods.</p>
<h4 id="adaptive-quality-is-the-shared-pattern"><a class="header" href="#adaptive-quality-is-the-shared-pattern">Adaptive Quality Is the Shared Pattern</a></h4>
<p>The meta-pattern across all three systems is <strong>adaptive quality degradation</strong> — gracefully reducing fidelity when resources are constrained, rather than failing:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>System</th><th>Constrained Resource</th><th>Degradation Response</th><th>Recovery</th></tr>
</thead>
<tbody>
<tr><td><strong>Voice</strong></td><td>Bandwidth/loss</td><td>Reduce Opus bitrate (32→16 kbps), increase FEC</td><td>Ramp back over 2s</td></tr>
<tr><td><strong>Game</strong></td><td>Latency</td><td>Increase run-ahead, pad order submission</td><td>Reduce run-ahead as RTT improves</td></tr>
<tr><td><strong>Workshop</strong></td><td>Bandwidth during gameplay</td><td>Pause/throttle downloads</td><td>Resume at full speed post-game</td></tr>
<tr><td><strong>Spectator feed</strong></td><td>Relay bandwidth</td><td>Switch to P2P fan-out, reduce feed rate</td><td>Return to relay-direct when load drops</td></tr>
<tr><td><strong>Replay</strong></td><td>Storage</td><td><code>Minimal</code> embedding mode (no map/assets)</td><td><code>SelfContained</code> when storage allows</td></tr>
</tbody>
</table>
</div>
<p>All five responses share the same trigger signal (<code>ConnectionQuality</code>), the same reaction pattern (reduce → adapt → recover), and the same design philosophy (D015’s efficiency pyramid — better algorithms before more resources). Building them on shared infrastructure ensures they cooperate rather than compete.</p>
<hr>
<hr>
<h2 id="d065-tutorial--new-player-experience--five-layer-onboarding-system"><a class="header" href="#d065-tutorial--new-player-experience--five-layer-onboarding-system">D065: Tutorial &amp; New Player Experience — Five-Layer Onboarding System</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th></th><th></th></tr>
</thead>
<tbody>
<tr><td><strong>Status</strong></td><td>Accepted</td></tr>
<tr><td><strong>Phase</strong></td><td>Phase 3 (contextual hints, new player pipeline, progressive discovery), Phase 4 (Commander School campaign, skill assessment, post-game learning, tutorial achievements)</td></tr>
<tr><td><strong>Depends on</strong></td><td>D004 (Lua Scripting), D021 (Branching Campaigns), D033 (QoL Toggles — experience profiles), D034 (SQLite — hint history, skill estimate), D036 (Achievements), D038 (Scenario Editor — tutorial modules), D043 (AI Behavior Presets — tutorial AI tier)</td></tr>
<tr><td><strong>Driver</strong></td><td>OpenRA’s new player experience is a wiki link to a YouTube video. The Remastered Collection added basic tooltips. No open-source RTS has a structured onboarding system. The genre’s complexity is the #1 barrier to new players — players who bounce from one failed match never return.</td></tr>
</tbody>
</table>
</div>
<p><strong>Revision note (2026-02-22):</strong> Revised D065 to support a single cross-device tutorial curriculum with semantic prompt rendering (<code>InputCapabilities</code>/<code>ScreenClass</code> aware), a skippable first-run controls walkthrough, camera bookmark instruction, and a touch-focused Tempo Advisor (advisory only). This revision incorporates confirmatory prior-art research on mobile strategy UX, platform adaptation, and community distribution friction (<code>research/mobile-rts-ux-onboarding-community-platform-analysis.md</code>).</p>
<h3 id="decision-capsule-llmrag-summary-2"><a class="header" href="#decision-capsule-llmrag-summary-2">Decision Capsule (LLM/RAG Summary)</a></h3>
<ul>
<li><strong>Status:</strong> Accepted (Revised 2026-02-22)</li>
<li><strong>Phase:</strong> Phase 3 (pipeline, hints, progressive discovery), Phase 4 (Commander School, assessment, post-game learning)</li>
<li><strong>Canonical for:</strong> Tutorial/new-player onboarding architecture, cross-device tutorial prompt model, controls walkthrough, and onboarding-related adaptive pacing</li>
<li><strong>Scope:</strong> <code>ic-ui</code> onboarding systems, tutorial Lua APIs, hint history + skill estimate persistence (SQLite/D034), cross-device prompt rendering, player-facing tutorial UX</li>
<li><strong>Decision:</strong> IC uses a <strong>five-layer onboarding system</strong> (campaign tutorial + contextual hints + first-run pipeline + skill assessment + adaptive pacing) integrated across the product rather than a single tutorial screen/mode.</li>
<li><strong>Why:</strong> RTS newcomers, veterans, and experienced OpenRA/Remastered players have different onboarding needs; one fixed tutorial path either overwhelms or bores large groups.</li>
<li><strong>Non-goals:</strong> Separate desktop and mobile tutorial campaigns; forced full tutorial completion before normal play; mouse-only prompt wording in shared tutorial content.</li>
<li><strong>Invariants preserved:</strong> Input remains abstracted (<code>InputCapabilities</code>/<code>ScreenClass</code> and core <code>InputSource</code> design); tutorial pacing/advisory systems are UI/client-level and do not alter simulation determinism.</li>
<li><strong>Defaults / UX behavior:</strong> Commander School is a first-class campaign; controls walkthrough is short and skippable; tutorial prompts are semantic and rendered per device/input mode.</li>
<li><strong>Mobile / accessibility impact:</strong> Touch platforms use the same curriculum with device-specific prompt text/UI anchors; Tempo Advisor is advisory-only and warns without blocking player choice (except existing ranked authority rules elsewhere).</li>
<li><strong>Public interfaces / types / commands:</strong> <code>InputPromptAction</code>, <code>TutorialPromptContext</code>, <code>ResolvedInputPrompt</code>, <code>UiAnchorAlias</code>, <code>LayoutAnchorResolver</code>, <code>TempoAdvisorContext</code></li>
<li><strong>Affected docs:</strong> <code>src/17-PLAYER-FLOW.md</code>, <code>src/02-ARCHITECTURE.md</code>, <code>src/decisions/09b-networking.md</code>, <code>src/decisions/09d-gameplay.md</code></li>
<li><strong>Revision note summary:</strong> Added cross-device semantic prompts, skippable controls walkthrough, camera bookmark teaching, and touch tempo advisory hooks based on researched mobile UX constraints.</li>
<li><strong>Keywords:</strong> tutorial, commander school, onboarding, cross-device prompts, controls walkthrough, tempo advisor, mobile tutorial, semantic action prompts</li>
</ul>
<h3 id="problem-2"><a class="header" href="#problem-2">Problem</a></h3>
<p>Classic RTS games are notoriously hostile to new players. The original Red Alert’s “tutorial” was Mission 1 of the Allied campaign, which assumed the player already understood control groups, attack-move, and ore harvesting. OpenRA offers no in-game tutorial at all. The Remastered Collection added tooltips and a training mode but no structured curriculum.</p>
<p>IC targets three distinct player populations and must serve all of them:</p>
<ol>
<li><strong>Complete RTS newcomers</strong> — never played any RTS. Need camera, selection, movement, and minimap/radar concepts before anything else.</li>
<li><strong>Lapsed RA veterans</strong> — played in the 90s, remember concepts vaguely, need a refresher on specific mechanics and new IC features.</li>
<li><strong>OpenRA / Remastered players</strong> — know RA well but may not know IC-specific features (weather, experience profiles, campaign persistence, console commands).</li>
</ol>
<p>A single-sized tutorial serves none of them well. Veterans resent being forced through basics. Newcomers drown in information presented too fast. The system must adapt.</p>
<h3 id="decision-2"><a class="header" href="#decision-2">Decision</a></h3>
<p>A five-layer tutorial system that integrates throughout the player experience rather than existing as a single screen or mode. Each layer operates independently — players benefit from whichever layers they encounter, in any order.</p>
<p><strong>Cross-device curriculum rule:</strong> IC ships one tutorial curriculum (Commander School + hints + skill assessment), not separate desktop and mobile tutorial campaigns. Tutorial content defines <strong>semantic actions</strong> (“move command”, “assign control group”, “save camera bookmark”) and the UI layer renders device-specific instructions and highlights using <code>InputCapabilities</code> and <code>ScreenClass</code>.</p>
<p><strong>Controls walkthrough addition (Layer 3):</strong> A short, skippable controls walkthrough (60-120s) is offered during first-run onboarding. It teaches camera pan/zoom, selection, context commands, minimap/radar, control groups, build UI basics, and camera bookmarks for the active platform before the player enters Commander School or regular play.</p>
<h3 id="layer-1--commander-school-tutorial-campaign"><a class="header" href="#layer-1--commander-school-tutorial-campaign">Layer 1 — Commander School (Tutorial Campaign)</a></h3>
<p>A dedicated 10-mission tutorial campaign using the D021 branching graph system, accessible from <code>Main Menu → Campaign → Commander School</code>. This is a first-class campaign, not a popup sequence — it has briefings, EVA voice lines, map variety, and a branching graph with remedial branches for players who struggle. It is shared across desktop and touch platforms; only prompt wording and UI highlight anchors differ by platform.</p>
<h4 id="mission-structure"><a class="header" href="#mission-structure">Mission Structure</a></h4>
<pre><code>                    ┌─────────────────┐
                    │  01: First Steps │  Camera, selection, movement
                    │  (Movement Only) │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │ pass         │ struggle     │
              ▼              ▼              │
    ┌─────────────────┐  ┌──────────────┐  │
    │  02: First Blood │  │  01r: Camera  │  │  Remedial: just camera + selection
    │  (Basic Combat)  │  │  Basics      │──┘
    └────────┬────────┘  └──────────────┘
             │
             ▼
    ┌─────────────────┐
    │  03: Base Camp   │  Build a power plant + barracks
    │  (Construction)  │
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │  04: Supply Line │  Build a refinery, protect harvesters
    │  (Economy)       │
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │  05: Hold the    │  Walls, turrets, repair
    │  Line (Defense)  │
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │  06: Command     │  Control groups, hotkeys, camera bookmarks,
    │  Basics          │  queue commands
    │  (Controls)      │
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │  07: Combined    │  Rock-paper-scissors: infantry vs vehicles
    │  Arms            │  vs air; counter units
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │  08: Iron        │  Full skirmish vs tutorial AI; apply
    │  Curtain Rising  │  everything learned
    │  (First Skirmish)│
    └────────┬────────┘
             │
       ┌─────┴─────┐
       │ victory    │ defeat
       ▼            ▼
    ┌────────┐  ┌──────────────┐
    │  09:   │  │  08r: Second │  Retry with hints enabled
    │  Multi │  │  Chance      │──► loops back to 09
    │  player│  └──────────────┘
    │  Intro │
    └───┬────┘
        │
        ▼
    ┌─────────────────┐
    │  10: Advanced    │  Tech tree, superweapons, naval,
    │  Tactics         │  weather effects (optional)
    └─────────────────┘
</code></pre>
<p>Every mission is <strong>skippable</strong>. Players can jump to any unlocked mission from the Commander School menu. Completing mission N unlocks mission N+1 (and its remedial branch, if any). Veterans can skip directly to Mission 08 (First Skirmish) or 10 (Advanced Tactics) after a brief skill check.</p>
<h4 id="tutorial-ai-difficulty-tier"><a class="header" href="#tutorial-ai-difficulty-tier">Tutorial AI Difficulty Tier</a></h4>
<p>Commander School uses a dedicated tutorial AI difficulty tier below D043’s Easy:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>AI Tier</th><th>Behavior</th></tr>
</thead>
<tbody>
<tr><td><strong>Tutorial</strong></td><td>Scripted responses only. Attacks on cue. Does not exploit weaknesses. Builds at fixed timing.</td></tr>
<tr><td><strong>Easy</strong> (D043)</td><td>Priority-based; slow reactions; limited tech tree; no harassment</td></tr>
<tr><td><strong>Normal</strong> (D043)</td><td>Full priority-based; moderate aggression; uses counters</td></tr>
<tr><td><strong>Hard+</strong> (D043)</td><td>Full AI with aggression/strategy axes</td></tr>
</tbody>
</table>
</div>
<p>The Tutorial tier is <strong>Lua-scripted per mission</strong>, not a general-purpose AI. Mission 02’s AI sends two rifle squads after 3 minutes. Mission 08’s AI builds a base and attacks after 5 minutes. The behavior is pedagogically tuned — the AI exists to teach, not to win.</p>
<h4 id="experience-profile-awareness"><a class="header" href="#experience-profile-awareness">Experience-Profile Awareness</a></h4>
<p>Commander School adapts to the player’s experience profile (D033):</p>
<ul>
<li><strong>New to RTS:</strong> Full hints, slower pacing, EVA narration on every new concept</li>
<li><strong>RA veteran / OpenRA player:</strong> Skip basic missions, focus on IC-specific features (weather, console, experience profiles)</li>
<li><strong>Custom:</strong> Player chose which missions to unlock via the skill assessment (Layer 3)</li>
</ul>
<p>The experience profile is read from the first-launch self-identification (see <code>17-PLAYER-FLOW.md</code>). It is not a difficulty setting — it controls <em>what is taught</em>, not <em>how hard the AI fights</em>. On touch devices, “slower pacing” also informs the default tutorial tempo recommendation (<code>slower</code> on phone/tablet, advisory only and overridable by the player).</p>
<h4 id="campaign-yaml-definition"><a class="header" href="#campaign-yaml-definition">Campaign YAML Definition</a></h4>
<pre><code class="language-yaml"># campaigns/tutorial/campaign.yaml
campaign:
  id: commander_school
  title: "Commander School"
  description: "Learn to command — from basic movement to full-scale warfare"
  start_mission: tutorial_01
  category: tutorial  # displayed under Campaign → Tutorial, not Campaign → Allied/Soviet
  icon: tutorial_icon
  badge: commander_school  # shown on campaign menu for players who haven't started

  persistent_state:
    unit_roster: false        # tutorial missions don't carry units forward
    veterancy: false
    resources: false
    equipment: false
    custom_flags:
      skills_demonstrated: []  # tracks which skills the player has shown

  missions:
    tutorial_01:
      map: missions/tutorial/01-first-steps
      briefing: briefings/tutorial/01.yaml
      skip_allowed: true
      experience_profiles: [new_to_rts, all]  # shown to these profiles
      outcomes:
        pass:
          description: "Mission complete"
          next: tutorial_02
          state_effects:
            append_flag: { skills_demonstrated: [camera, selection, movement] }
        struggle:
          description: "Player struggled with camera/selection"
          next: tutorial_01r
        skip:
          description: "Player skipped"
          next: tutorial_02
          state_effects:
            append_flag: { skills_demonstrated: [camera, selection, movement] }

    tutorial_01r:
      map: missions/tutorial/01r-camera-basics
      briefing: briefings/tutorial/01r.yaml
      remedial: true  # UI shows this as a "practice" mission, not a setback
      outcomes:
        pass:
          next: tutorial_02
          state_effects:
            append_flag: { skills_demonstrated: [camera, selection] }

    tutorial_02:
      map: missions/tutorial/02-first-blood
      briefing: briefings/tutorial/02.yaml
      skip_allowed: true
      outcomes:
        pass:
          next: tutorial_03
          state_effects:
            append_flag: { skills_demonstrated: [attack, force_fire] }
        skip:
          next: tutorial_03

    # ... missions 03–10 follow the same pattern ...

    tutorial_08:
      map: missions/tutorial/08-first-skirmish
      briefing: briefings/tutorial/08.yaml
      skip_allowed: false  # this one is the capstone — encourage completion
      outcomes:
        victory:
          next: tutorial_09
          state_effects:
            append_flag: { skills_demonstrated: [full_skirmish] }
        defeat:
          next: tutorial_08r
          debrief: briefings/tutorial/08-debrief-defeat.yaml

    tutorial_08r:
      map: missions/tutorial/08-first-skirmish
      briefing: briefings/tutorial/08r.yaml
      remedial: true
      adaptive:
        on_previous_defeat:
          bonus_resources: 3000
          bonus_units: [medium_tank, medium_tank]
          enable_tutorial_hints: true  # force hints on for retry
      outcomes:
        victory:
          next: tutorial_09
        defeat:
          next: tutorial_08r  # can retry indefinitely

    tutorial_09:
      map: missions/tutorial/09-multiplayer-intro
      briefing: briefings/tutorial/09.yaml
      skip_allowed: true
      outcomes:
        pass:
          next: tutorial_10
        skip:
          next: tutorial_10

    tutorial_10:
      map: missions/tutorial/10-advanced-tactics
      briefing: briefings/tutorial/10.yaml
      optional: true  # not required for "Graduate" achievement
      experience_profiles: [all]
      outcomes:
        pass:
          description: "Commander School complete"
</code></pre>
<h4 id="tutorial-mission-lua-script-pattern"><a class="header" href="#tutorial-mission-lua-script-pattern">Tutorial Mission Lua Script Pattern</a></h4>
<p>Each tutorial mission uses the <code>Tutorial</code> Lua global to manage the teaching flow:</p>
<pre><code class="language-lua">-- missions/tutorial/02-first-blood.lua
-- Mission 02: First Blood — introduces basic combat

-- Mission setup
function OnMissionStart()
    -- Disable sidebar building (not taught yet)
    Tutorial.RestrictSidebar(true)

    -- Spawn player units
    local player = Player.GetPlayer("GoodGuy")
    local rifles = Actor.Create("e1", player, entry_south, { count = 5 })

    -- Spawn enemy patrol (tutorial AI — scripted, not general AI)
    local enemy = Player.GetPlayer("BadGuy")
    local patrol = Actor.Create("e1", enemy, patrol_start, { count = 3 })

    -- Step 1: Introduce the enemy
    Tutorial.SetStep("spot_enemy", {
        title = "Enemy Contact",
        hint = "Red units are hostile. Select your soldiers and right-click an enemy to attack.",
        focus_area = patrol_start,       -- camera pans here
        highlight_ui = nil,              -- no UI highlight needed
        eva_line = "enemy_units_detected",
        completion = { type = "kill", count = 1 }  -- complete when player kills any enemy
    })
end

-- Step progression
function OnStepComplete(step_id)
    if step_id == "spot_enemy" then
        Tutorial.SetStep("attack_move", {
            title = "Attack-Move",
            hint = "Hold Ctrl and right-click to attack-move. Your units will engage enemies along the way.",
            highlight_ui = "attack_move_button",  -- highlights the A-move button on the command bar
            eva_line = "commander_tip_attack_move",
            completion = { type = "action", action = "attack_move" }
        })

    elseif step_id == "attack_move" then
        Tutorial.SetStep("clear_area", {
            title = "Clear the Area",
            hint = "Destroy all remaining enemies to complete the mission.",
            completion = { type = "kill_all", faction = "BadGuy" }
        })

    elseif step_id == "clear_area" then
        -- Mission complete
        Campaign.complete("pass")
    end
end

-- Detect struggle: if player hasn't killed anyone after 2 minutes
Trigger.AfterDelay(DateTime.Minutes(2), function()
    if Tutorial.GetCurrentStep() == "spot_enemy" then
        Tutorial.ShowHint("Try selecting your units (click + drag) then right-clicking on an enemy.")
        -- If still stuck after 4 minutes total, the campaign graph routes to a remedial mission
    end
end)

-- Detect struggle: player lost most units without killing enemies
Trigger.OnAllKilledOrCaptured(Player.GetPlayer("GoodGuy"):GetActors(), function()
    Campaign.complete("struggle")
end)
</code></pre>
<h3 id="layer-2--contextual-hints-yaml-driven-always-on"><a class="header" href="#layer-2--contextual-hints-yaml-driven-always-on">Layer 2 — Contextual Hints (YAML-Driven, Always-On)</a></h3>
<p>Contextual hints appear as translucent overlay callouts during gameplay, triggered by game state. They are NOT part of Commander School — they work in any game mode (skirmish, multiplayer, custom campaigns). Modders can author custom hints for their mods.</p>
<h4 id="hint-pipeline"><a class="header" href="#hint-pipeline">Hint Pipeline</a></h4>
<pre><code>  HintTrigger          HintFilter           HintRenderer
  (game state     →    (suppression,    →   (overlay, fade,
   evaluation)          cooldowns,           positioning,
                        experience           dismiss)
                        profile)
</code></pre>
<ol>
<li><strong>HintTrigger</strong> evaluates conditions against the current game state every N ticks (configurable, default: every 150 ticks / 5 seconds). Triggers are YAML-defined — no Lua required for standard hints.</li>
<li><strong>HintFilter</strong> suppresses hints the player doesn’t need: already dismissed, demonstrated mastery (performed the action N times), cooldown not expired, experience profile excludes this hint.</li>
<li><strong>HintRenderer</strong> displays the hint as a UI overlay — positioned near the relevant screen element, with fade-in/fade-out, dismiss button, and “don’t show again” toggle.</li>
</ol>
<h4 id="hint-definition-schema-hintsyaml"><a class="header" href="#hint-definition-schema-hintsyaml">Hint Definition Schema (<code>hints.yaml</code>)</a></h4>
<pre><code class="language-yaml"># hints/base-game.yaml — ships with the game
# Modders create their own hints.yaml in their mod directory

hints:
  - id: idle_harvester
    title: "Idle Harvester"
    text: "Your harvester is sitting idle. Click it and right-click an ore field to start collecting."
    category: economy
    icon: hint_harvester
    trigger:
      type: unit_idle
      unit_type: "harvester"
      idle_duration_seconds: 15    # only triggers after 15s of idling
    suppression:
      mastery_action: harvest_command      # stop showing after player has issued 5 harvest commands
      mastery_threshold: 5
      cooldown_seconds: 120               # don't repeat more than once every 2 minutes
      max_shows: 10                       # never show more than 10 times total
    experience_profiles: [new_to_rts, ra_veteran]  # show to these profiles, not openra_player
    priority: high     # high priority hints interrupt low priority ones
    position: near_unit  # position hint near the idle harvester
    eva_line: null       # no EVA voice for this hint (too frequent)
    dismiss_action: got_it  # "Got it" button only — no "don't show again" on high-priority hints

  - id: negative_power
    title: "Low Power"
    text: "Your base is low on power. Build more Power Plants to restore production speed."
    category: economy
    icon: hint_power
    trigger:
      type: resource_threshold
      resource: power
      condition: negative        # power demand &gt; power supply
      sustained_seconds: 10      # must be negative for 10s (not transient during building)
    suppression:
      mastery_action: build_power_plant
      mastery_threshold: 3
      cooldown_seconds: 180
      max_shows: 8
    experience_profiles: [new_to_rts]
    priority: high
    position: near_sidebar       # position near the build queue
    eva_line: low_power           # EVA says "Low power"

  - id: control_groups
    title: "Control Groups"
    text: "Select units and press Ctrl+1 to assign them to group 1. Press 1 to reselect them instantly."
    category: controls
    icon: hint_hotkey
    trigger:
      type: unit_count
      condition: "&gt;= 8"         # suggest control groups when player has 8+ units
      without_action: assign_control_group  # only if they haven't used groups yet
      sustained_seconds: 60      # must have 8+ units for 60s without grouping
    suppression:
      mastery_action: assign_control_group
      mastery_threshold: 1       # one use = mastery for this hint
      cooldown_seconds: 300
      max_shows: 3
    experience_profiles: [new_to_rts]
    priority: medium
    position: screen_top         # general hint, not tied to a unit
    eva_line: commander_tip_control_groups

  - id: tech_tree_reminder
    title: "Tech Up"
    text: "New units become available as you build advanced structures. Check the sidebar for greyed-out options."
    category: strategy
    icon: hint_tech
    trigger:
      type: time_without_action
      action: build_tech_structure
      time_minutes: 5            # 5 minutes into a game with no tech building
      min_game_time_minutes: 3   # don't trigger in the first 3 minutes
    suppression:
      mastery_action: build_tech_structure
      mastery_threshold: 1
      cooldown_seconds: 600
      max_shows: 3
    experience_profiles: [new_to_rts]
    priority: low
    position: near_sidebar

  # Modder-authored hint example (from a hypothetical "Chrono Warfare" mod):
  - id: chrono_shift_intro
    title: "Chrono Shift Ready"
    text: "Your Chronosphere is charged! Select units, then click the Chronosphere and pick a destination."
    category: mod_specific
    icon: hint_chrono
    trigger:
      type: building_ready
      building_type: "chronosphere"
      ability: "chrono_shift"
      first_time: true           # only on the first Chronosphere completion per game
    suppression:
      mastery_action: use_chrono_shift
      mastery_threshold: 1
      cooldown_seconds: 0        # first_time already limits it
      max_shows: 1
    experience_profiles: [all]
    priority: high
    position: near_building
    eva_line: chronosphere_ready
</code></pre>
<h4 id="trigger-types-extensible"><a class="header" href="#trigger-types-extensible">Trigger Types (Extensible)</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Trigger Type</th><th>Parameters</th><th>Fires When</th></tr>
</thead>
<tbody>
<tr><td><code>unit_idle</code></td><td><code>unit_type</code>, <code>idle_duration_seconds</code></td><td>A unit of that type has been idle for N seconds</td></tr>
<tr><td><code>resource_threshold</code></td><td><code>resource</code>, <code>condition</code>, <code>sustained_seconds</code></td><td>A resource exceeds/falls below a threshold for N seconds</td></tr>
<tr><td><code>unit_count</code></td><td><code>condition</code>, <code>without_action</code>, <code>sustained_seconds</code></td><td>Player has N units and hasn’t performed the suggested action</td></tr>
<tr><td><code>time_without_action</code></td><td><code>action</code>, <code>time_minutes</code>, <code>min_game_time_minutes</code></td><td>N minutes pass without the player performing a specific action</td></tr>
<tr><td><code>building_ready</code></td><td><code>building_type</code>, <code>ability</code>, <code>first_time</code></td><td>A building completes construction (or its ability charges)</td></tr>
<tr><td><code>first_encounter</code></td><td><code>entity_type</code></td><td>Player sees an enemy unit/building type for the first time</td></tr>
<tr><td><code>damage_taken</code></td><td><code>damage_source_type</code>, <code>threshold_percent</code></td><td>Player units take significant damage from a specific type</td></tr>
<tr><td><code>area_enter</code></td><td><code>area</code>, <code>unit_types</code></td><td>Player units enter a named map region</td></tr>
<tr><td><code>custom</code></td><td><code>lua_condition</code></td><td>Lua expression evaluates to true (Tier 2 mods only)</td></tr>
</tbody>
</table>
</div>
<p>Modders define new triggers via Lua (Tier 2) or WASM (Tier 3). The <code>custom</code> trigger type is a Lua escape hatch for conditions that don’t fit the built-in types.</p>
<h4 id="hint-history-sqlite"><a class="header" href="#hint-history-sqlite">Hint History (SQLite)</a></h4>
<pre><code class="language-sql">-- In player.db (D034)
CREATE TABLE hint_history (
    hint_id       TEXT NOT NULL,
    show_count    INTEGER NOT NULL DEFAULT 0,
    last_shown    INTEGER,          -- Unix timestamp
    dismissed     BOOLEAN NOT NULL DEFAULT FALSE,  -- "Don't show again"
    mastery_count INTEGER NOT NULL DEFAULT 0,      -- times the mastery_action was performed
    PRIMARY KEY (hint_id)
);
</code></pre>
<p>The hint system queries this table before showing each hint. <code>mastery_count &gt;= mastery_threshold</code> suppresses the hint permanently. <code>dismissed = TRUE</code> suppresses it permanently. <code>last_shown + cooldown_seconds &gt; now</code> suppresses it temporarily.</p>
<h4 id="qol-integration-d033"><a class="header" href="#qol-integration-d033">QoL Integration (D033)</a></h4>
<p>Hints are individually toggleable per category in <code>Settings → QoL → Hints</code>:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Setting</th><th>Default (New to RTS)</th><th>Default (RA Vet)</th><th>Default (OpenRA)</th></tr>
</thead>
<tbody>
<tr><td>Economy hints</td><td>On</td><td>On</td><td>Off</td></tr>
<tr><td>Combat hints</td><td>On</td><td>Off</td><td>Off</td></tr>
<tr><td>Controls hints</td><td>On</td><td>On</td><td>Off</td></tr>
<tr><td>Strategy hints</td><td>On</td><td>Off</td><td>Off</td></tr>
<tr><td>Mod-specific hints</td><td>On</td><td>On</td><td>On</td></tr>
<tr><td>Hint frequency</td><td>Normal</td><td>Reduced</td><td>Minimal</td></tr>
<tr><td>EVA voice on hints</td><td>On</td><td>Off</td><td>Off</td></tr>
</tbody>
</table>
</div>
<p><code>/hints</code> console commands (D058): <code>/hints list</code>, <code>/hints enable &lt;category&gt;</code>, <code>/hints disable &lt;category&gt;</code>, <code>/hints reset</code>, <code>/hints suppress &lt;id&gt;</code>.</p>
<h3 id="layer-3--new-player-pipeline"><a class="header" href="#layer-3--new-player-pipeline">Layer 3 — New Player Pipeline</a></h3>
<p>The first-launch flow (see <code>17-PLAYER-FLOW.md</code>) includes a self-identification step:</p>
<pre><code>Theme Selection (D032) → Self-Identification → Controls Walkthrough (optional) → Tutorial Offer → Main Menu
</code></pre>
<h4 id="self-identification-gate"><a class="header" href="#self-identification-gate">Self-Identification Gate</a></h4>
<pre><code>┌──────────────────────────────────────────────────┐
│  WELCOME, COMMANDER                              │
│                                                  │
│  How familiar are you with real-time strategy?   │
│                                                  │
│  ► New to RTS games                              │
│  ► Played some RTS games before                  │
│  ► Red Alert veteran                             │
│  ► OpenRA / Remastered player                    │
│  ► Skip — just let me play                       │
│                                                  │
└──────────────────────────────────────────────────┘
</code></pre>
<p>This sets the <code>experience_profile</code> used by all five layers. The profile is stored in <code>player.db</code> (D034) and changeable in <code>Settings → QoL → Experience Profile</code>.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Selection</th><th>Experience Profile</th><th>Default Hints</th><th>Tutorial Offer</th></tr>
</thead>
<tbody>
<tr><td>New to RTS</td><td><code>new_to_rts</code></td><td>All on</td><td>“Would you like to start with Commander School?”</td></tr>
<tr><td>Played some RTS</td><td><code>rts_player</code></td><td>Economy + Controls</td><td>“Commander School available in Campaigns”</td></tr>
<tr><td>Red Alert veteran</td><td><code>ra_veteran</code></td><td>Economy only</td><td>Badge on campaign menu</td></tr>
<tr><td>OpenRA / Remastered</td><td><code>openra_player</code></td><td>Mod-specific only</td><td>Badge on campaign menu</td></tr>
<tr><td>Skip</td><td><code>skip</code></td><td>All off</td><td>No offer</td></tr>
</tbody>
</table>
</div>
<h4 id="controls-walkthrough-phase-3-skippable"><a class="header" href="#controls-walkthrough-phase-3-skippable">Controls Walkthrough (Phase 3, Skippable)</a></h4>
<p>A short controls walkthrough is offered immediately after self-identification. It is <strong>platform-specific in presentation</strong> and <strong>shared in intent</strong>:</p>
<ul>
<li><strong>Desktop:</strong> mouse/keyboard prompts (“Right-click to move”, <code>Ctrl+F5</code> to save camera bookmark)</li>
<li><strong>Tablet:</strong> touch prompts with sidebar + on-screen hotbar highlights</li>
<li><strong>Phone:</strong> touch prompts with build drawer, command rail, minimap cluster, and bookmark dock highlights</li>
</ul>
<p>The walkthrough teaches only control fundamentals (camera pan/zoom, selection, context commands, control groups, minimap/radar, camera bookmarks, and build UI basics) and ends with three options:</p>
<ul>
<li><code>Start Commander School</code></li>
<li><code>Practice Sandbox</code></li>
<li><code>Skip to Game</code></li>
</ul>
<p>This keeps D065’s early experience friendly on touch devices without duplicating Commander School missions.</p>
<h4 id="skill-assessment-phase-4"><a class="header" href="#skill-assessment-phase-4">Skill Assessment (Phase 4)</a></h4>
<p>After Commander School Mission 01 (or as a standalone 2-minute exercise accessible from <code>Settings → QoL → Recalibrate</code>), the engine estimates the player’s baseline skill:</p>
<pre><code>┌──────────────────────────────────────────────────┐
│  SKILL CALIBRATION (2 minutes)                   │
│                                                  │
│  Complete these exercises:                       │
│  ✓  Select and move units to waypoints           │
│  ✓  Select specific units from a mixed group     │
│  ►  Camera: pan to each flashing area            │
│  ►  Optional: save/jump a camera bookmark        │
│     Timed combat: destroy targets in order       │
│                                                  │
│  [Skip Assessment]                               │
└──────────────────────────────────────────────────┘
</code></pre>
<p>Measures:</p>
<ul>
<li><strong>Selection speed</strong> — time to select correct units from a mixed group</li>
<li><strong>Camera fluency</strong> — time to pan to each target area</li>
<li><strong>Camera bookmark fluency (optional)</strong> — time to save and jump to a bookmarked location (measured only on platforms where bookmarks are surfaced in the exercise)</li>
<li><strong>Combat efficiency</strong> — accuracy of focused fire on marked targets</li>
<li><strong>APM estimate</strong> — actions per minute during the exercises</li>
</ul>
<p>Results stored in SQLite:</p>
<pre><code class="language-sql">-- In player.db
CREATE TABLE player_skill_estimate (
    player_id        TEXT PRIMARY KEY,
    selection_speed  INTEGER,    -- percentile (0–100)
    camera_fluency   INTEGER,
    bookmark_fluency INTEGER,    -- nullable/0 if exercise omitted
    combat_efficiency INTEGER,
    apm_estimate     INTEGER,    -- raw APM
    input_class      TEXT,       -- 'desktop', 'touch_phone', 'touch_tablet', 'deck'
    screen_class     TEXT,       -- 'Phone', 'Tablet', 'Desktop', 'TV'
    assessed_at      INTEGER,    -- Unix timestamp
    assessment_type  TEXT        -- 'tutorial_01' or 'standalone'
);
</code></pre>
<p>Percentiles are normalized <strong>within input class</strong> (desktop vs touch phone vs touch tablet vs deck) so touch players are not under-rated against mouse/keyboard baselines.</p>
<p>The skill estimate feeds Layers 2 and 4: hint frequency scales with skill (fewer hints for skilled players), the first skirmish AI difficulty recommendation uses the estimate, and touch tempo guidance can widen/narrow its recommended speed band based on demonstrated comfort.</p>
<h3 id="layer-4--adaptive-pacing-engine"><a class="header" href="#layer-4--adaptive-pacing-engine">Layer 4 — Adaptive Pacing Engine</a></h3>
<p>A background system (no direct UI — it shapes the other layers) that continuously estimates player mastery and adjusts the learning experience.</p>
<h4 id="inputs"><a class="header" href="#inputs">Inputs</a></h4>
<ul>
<li><code>hint_history</code> — which hints have been shown, dismissed, or mastered</li>
<li><code>player_skill_estimate</code> — from the skill assessment</li>
<li><code>gameplay_events</code> (D031) — actual in-game actions (build orders, APM, unit losses, idle time)</li>
<li><code>experience_profile</code> — self-identified experience level</li>
<li><code>input_capabilities</code> / <code>screen_class</code> — touch vs mouse/keyboard and phone/tablet layout context</li>
<li>optional touch friction signals — misclick proxies, selection retries, camera thrash, pause frequency (single-player)</li>
</ul>
<h4 id="outputs"><a class="header" href="#outputs">Outputs</a></h4>
<ul>
<li><strong>Hint frequency multiplier</strong> — scales the cooldown on all hints. A player demonstrating mastery gets longer cooldowns (fewer hints). A struggling player gets shorter cooldowns (more hints).</li>
<li><strong>Difficulty recommendation</strong> — suggested AI difficulty for the next skirmish. Displayed as a tooltip in the lobby AI picker: “Based on your recent games, Normal difficulty is recommended.”</li>
<li><strong>Feature discovery pacing</strong> — controls how quickly progressive discovery notifications appear (Layer 5 below).</li>
<li><strong>Touch tutorial prompt density</strong> — controls how much on-screen guidance is shown for touch platforms (e.g., keep command-rail hints visible slightly longer for new phone players).</li>
<li><strong>Recommended tempo band (advisory)</strong> — preferred speed range for the current device/input/skill context. Used by UI warnings only; never changes sim state on its own.</li>
<li><strong>Camera bookmark suggestion eligibility</strong> — enables/disables “save camera location” hints based on camera fluency and map scale.</li>
<li><strong>Tutorial EVA activation</strong> — in the Allied/Soviet campaigns (not Commander School), first encounters with new unit types or buildings trigger a brief EVA line if the player hasn’t completed the relevant Commander School mission. “Construction complete. This is a Radar Dome — it reveals the minimap.” Only triggers once per entity type per campaign playthrough.</li>
</ul>
<h4 id="pacing-algorithm"><a class="header" href="#pacing-algorithm">Pacing Algorithm</a></h4>
<pre><code>skill_estimate = weighted_average(
    0.3 × selection_speed_percentile,
    0.2 × camera_fluency_percentile,
    0.2 × combat_efficiency_percentile,
    0.15 × recent_apm_trend,           -- from gameplay_events
    0.15 × hint_mastery_rate            -- % of hints mastered vs shown
)

hint_frequency_multiplier = clamp(
    2.0 - (skill_estimate / 50.0),      -- range: 0.0 (no hints) to 2.0 (double frequency)
    min = 0.2,
    max = 2.0
)

recommended_difficulty = match skill_estimate {
    0..25   =&gt; "Easy",
    25..50  =&gt; "Normal",
    50..75  =&gt; "Hard",
    75..100 =&gt; "Brutal",
}
</code></pre>
<h4 id="mobile-tempo-advisor-client-only-advisory"><a class="header" href="#mobile-tempo-advisor-client-only-advisory">Mobile Tempo Advisor (Client-Only, Advisory)</a></h4>
<p>The adaptive pacing engine also powers a <strong>Tempo Advisor</strong> for touch-first play. This system is intentionally non-invasive:</p>
<ul>
<li><strong>Single-player:</strong> any speed allowed; warnings shown outside the recommended band; one-tap “Return to Recommended”</li>
<li><strong>Casual multiplayer (host-controlled):</strong> lobby shows a warning if the selected speed is outside the recommended band for participating touch players</li>
<li><strong>Ranked multiplayer:</strong> informational only; speed remains server/queue enforced (D055/D064, see <code>09b-networking.md</code>)</li>
</ul>
<p>Initial default bands (experimental; tune from playtests):</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Context</th><th>Recommended Band</th><th>Default</th></tr>
</thead>
<tbody>
<tr><td>Phone (new/average touch)</td><td><code>slowest</code>-<code>normal</code></td><td><code>slower</code></td></tr>
<tr><td>Phone (high skill estimate + tutorial complete)</td><td><code>slower</code>-<code>faster</code></td><td><code>normal</code></td></tr>
<tr><td>Tablet</td><td><code>slower</code>-<code>faster</code></td><td><code>normal</code></td></tr>
<tr><td>Desktop / Deck</td><td>unchanged</td><td><code>normal</code></td></tr>
</tbody>
</table>
</div>
<p>Commander School on phone/tablet starts at <code>slower</code> by default, but players may override it.</p>
<p>The advisor emits local-only analytics events (D031-compatible) such as <code>mobile_tempo.warning_shown</code> and <code>mobile_tempo.warning_dismissed</code> to validate whether recommendations reduce overload without reducing agency.</p>
<p>This is deterministic and entirely local — no LLM, no network, no privacy concerns. The pacing engine exists in <code>ic-ui</code> (not <code>ic-sim</code>) because it affects presentation, not simulation.</p>
<h4 id="implementation-facing-interfaces-clientui-layer-no-sim-impact"><a class="header" href="#implementation-facing-interfaces-clientui-layer-no-sim-impact">Implementation-Facing Interfaces (Client/UI Layer, No Sim Impact)</a></h4>
<p>These types live in <code>ic-ui</code> / <code>ic-game</code> client codepaths (not <code>ic-sim</code>) and formalize camera bookmarks, semantic prompt resolution, and tempo advice:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct CameraBookmarkSlot {
    pub slot: u8,                    // 1..=9
    pub label: Option&lt;String&gt;,       // local-only label
    pub world_pos: WorldPos,
    pub zoom_level: Option&lt;FixedPoint&gt;, // optional client camera zoom
}

pub struct CameraBookmarkState {
    pub slots: [Option&lt;CameraBookmarkSlot&gt;; 9],
    pub quick_slots: [u8; 4],        // defaults: [1, 2, 3, 4]
}

pub enum CameraBookmarkIntent {
    Save { slot: u8 },
    Jump { slot: u8 },
    Clear { slot: u8 },
    Rename { slot: u8, label: String },
}

pub enum InputPromptAction {
    Select,
    BoxSelect,
    MoveCommand,
    AttackCommand,
    AttackMoveCommand,
    OpenBuildUi,
    QueueProduction,
    UseMinimap,
    SaveCameraBookmark,
    JumpCameraBookmark,
}

pub struct TutorialPromptContext {
    pub input_capabilities: InputCapabilities,
    pub screen_class: ScreenClass,
    pub advanced_mode: bool,
}

pub struct ResolvedInputPrompt {
    pub text: String,             // localized, device-specific wording
    pub icon_tokens: Vec&lt;String&gt;, // e.g. "tap", "f5", "ctrl+f5"
}

pub struct UiAnchorAlias(pub String); // e.g. "primary_build_ui", "minimap_cluster"

pub enum TempoSpeedLevel {
    Slowest,
    Slower,
    Normal,
    Faster,
    Fastest,
}

pub struct TempoComfortBand {
    pub recommended_min: TempoSpeedLevel,
    pub recommended_max: TempoSpeedLevel,
    pub default_speed: TempoSpeedLevel,
    pub warn_above: Option&lt;TempoSpeedLevel&gt;,
    pub warn_below: Option&lt;TempoSpeedLevel&gt;,
}

pub enum InputSourceKind {
    MouseKeyboard,
    TouchPhone,
    TouchTablet,
    Controller,
}

pub struct TempoAdvisorContext {
    pub screen_class: ScreenClass,
    pub has_touch: bool,
    pub primary_input: InputSourceKind, // advisory classification only
    pub skill_estimate: Option&lt;PlayerSkillEstimate&gt;,
    pub mode: MatchMode,            // SP / casual MP / ranked
}

pub enum TempoWarning {
    AboveRecommendedBand,
    BelowRecommendedBand,
    TouchOverloadRisk,
}

pub struct TempoRecommendation {
    pub band: TempoComfortBand,
    pub warnings: Vec&lt;TempoWarning&gt;,
    pub rationale: Vec&lt;String&gt;,     // short UI strings
}
<span class="boring">}</span></code></pre>
<p>The touch/mobile control layer maps these UI intents to normal <code>PlayerOrder</code>s through the existing <code>InputSource</code> pipeline. Bookmarks and tempo advice remain local UI state; they never enter the deterministic simulation.</p>
<h3 id="layer-5--post-game-learning"><a class="header" href="#layer-5--post-game-learning">Layer 5 — Post-Game Learning</a></h3>
<p>After every match, the post-game stats screen (D034) includes a learning section:</p>
<h4 id="rule-based-tips"><a class="header" href="#rule-based-tips">Rule-Based Tips</a></h4>
<p>YAML-driven pattern matching on <code>gameplay_events</code>:</p>
<pre><code class="language-yaml"># tips/base-game-tips.yaml
tips:
  - id: idle_harvesters
    title: "Keep Your Economy Running"
    positive: false
    condition:
      type: stat_threshold
      stat: idle_harvester_seconds
      threshold: 30
    text: "Your harvesters sat idle for {idle_harvester_seconds} seconds. Idle harvesters mean lost income."
    learn_more: tutorial_04  # links to Commander School Mission 04 (Economy)

  - id: good_micro
    title: "Sharp Micro"
    positive: true
    condition:
      type: stat_threshold
      stat: average_unit_efficiency  # damage dealt / damage taken per unit
      threshold: 1.5
      direction: above
    text: "Your units dealt {ratio}× more damage than they took — strong micro."

  - id: no_tech
    title: "Explore the Tech Tree"
    positive: false
    condition:
      type: never_built
      building_types: [radar_dome, tech_center, battle_lab]
      min_game_length_minutes: 8
    text: "You didn't build any advanced structures. Higher-tech units can turn the tide."
    learn_more: tutorial_07  # links to Commander School Mission 07 (Combined Arms)
</code></pre>
<p><strong>Tip selection:</strong> 1–3 tips per game. At least one positive (“you did this well”) and at most one improvement (“you could try this”). Tips rotate — the engine avoids repeating the same tip in consecutive games.</p>
<h4 id="annotated-replay-mode"><a class="header" href="#annotated-replay-mode">Annotated Replay Mode</a></h4>
<p>“Watch the moment” links in post-game tips jump to an annotated replay — the replay plays with an overlay highlighting the relevant moment:</p>
<pre><code>┌────────────────────────────────────────────────────────────┐
│  REPLAY — ANNOTATED                                        │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                                                      │  │
│  │   [Game replay playing at 0.5x speed]               │  │
│  │                                                      │  │
│  │   ┌─────────────────────────────────┐               │  │
│  │   │ 💡 Your harvester sat idle here │               │  │
│  │   │    for 23 seconds while ore was │               │  │
│  │   │    available 3 cells away.      │               │  │
│  │   │    [Return to Stats]            │               │  │
│  │   └─────────────────────────────────┘               │  │
│  │                                                      │  │
│  └──────────────────────────────────────────────────────┘  │
│  ◄◄  ►  ►►  │ 4:23 / 12:01 │ 0.5x │                       │
└────────────────────────────────────────────────────────────┘
</code></pre>
<p>The annotation data is generated at match end (not during gameplay — no sim overhead). It’s a list of <code>(tick, position, text)</code> tuples stored alongside the replay file.</p>
<h4 id="progressive-feature-discovery"><a class="header" href="#progressive-feature-discovery">Progressive Feature Discovery</a></h4>
<p>Milestone-based main menu notifications that surface features over the player’s first weeks:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Milestone</th><th>Feature Suggested</th><th>Notification</th></tr>
</thead>
<tbody>
<tr><td>First game completed</td><td>Replays</td><td>“Your game was saved as a replay. Watch it from the Replays menu.”</td></tr>
<tr><td>3 games completed</td><td>Experience profiles</td><td>“Did you know? You can switch gameplay presets in Settings → QoL.”</td></tr>
<tr><td>First multiplayer game</td><td>Ranked play</td><td>“Ready for a challenge? Ranked matches calibrate your skill rating.”</td></tr>
<tr><td>5 games completed</td><td>Workshop</td><td>“The Workshop has community maps, mods, and campaigns. Browse it anytime.”</td></tr>
<tr><td>Commander School done</td><td>Training mode</td><td>“Try training mode to practice against AI with custom settings.”</td></tr>
<tr><td>10 games completed</td><td>Console</td><td>“Press Enter and type / to access console commands.”</td></tr>
<tr><td>First mod installed</td><td>Mod profiles</td><td>“Create mod profiles to switch between different mod setups quickly.”</td></tr>
</tbody>
</table>
</div>
<p>Maximum one notification per session. Three dismissals of the same category = never again. Discovery state stored in <code>hint_history</code> SQLite table (reuses the same suppression infrastructure as Layer 2).</p>
<p><code>/discovery</code> console commands (D058): <code>/discovery list</code>, <code>/discovery reset</code>, <code>/discovery trigger &lt;milestone&gt;</code>.</p>
<h3 id="tutorial-lua-global-api"><a class="header" href="#tutorial-lua-global-api">Tutorial Lua Global API</a></h3>
<p>The <code>Tutorial</code> global is an IC-exclusive Lua extension available in all game modes (not just Commander School). Modders use it to build tutorial sequences in their own campaigns and scenarios.</p>
<pre><code class="language-lua">-- === Step Management ===

-- Define and activate a tutorial step. The step is displayed as a hint overlay
-- and tracked for completion. Only one step can be active at a time.
-- Calling SetStep while a step is active replaces it.
Tutorial.SetStep(step_id, {
    title = "Step Title",                    -- displayed in the hint overlay header
    hint = "Instructional text for the player", -- main body text
    hint_action = "move_command",            -- optional semantic prompt token; renderer
                                             -- resolves to device-specific wording/icons
    focus_area = position_or_region,         -- optional: camera pans to this location
    highlight_ui = "ui_element_id",          -- optional: logical UI target or semantic alias
    eva_line = "eva_sound_id",               -- optional: play an EVA voice line
    completion = {                           -- when is this step "done"?
        type = "action",                     -- "action", "kill", "kill_all", "build",
                                             -- "select", "move_to", "research", "custom"
        action = "attack_move",              -- specific action to detect
        -- OR:
        count = 3,                           -- for "kill": kill N enemies
        -- OR:
        unit_type = "power_plant",           -- for "build": build this structure
        -- OR:
        lua_condition = "CheckCustomGoal()", -- for "custom": Lua expression
    },
})

-- Query the currently active step ID (nil if no step active)
local current = Tutorial.GetCurrentStep()

-- Manually complete the current step (triggers OnStepComplete)
Tutorial.CompleteStep()

-- Skip the current step without triggering completion
Tutorial.SkipStep()

-- === Hint Display ===

-- Show a one-shot hint (not tied to a step). Useful for contextual tips
-- within a mission script without the full step tracking machinery.
Tutorial.ShowHint(text, {
    title = "Optional Title",        -- nil = no title bar
    duration = 8,                    -- seconds before auto-dismiss (0 = manual dismiss only)
    position = "near_unit",          -- "near_unit", "near_building", "screen_top",
                                     -- "screen_center", "near_sidebar", position_table
    icon = "hint_icon_id",           -- optional icon
    eva_line = "eva_sound_id",       -- optional EVA line
    dismissable = true,              -- show dismiss button (default: true)
})

-- Show a hint anchored to a specific actor (follows the actor on screen)
Tutorial.ShowActorHint(actor, text, options)

-- Show a one-shot hint using a semantic action token. The renderer chooses
-- desktop/touch wording (e.g., "Right-click" vs "Tap") and icon glyphs.
Tutorial.ShowActionHint(action_name, {
    title = "Optional Title",
    highlight_ui = "ui_element_id",   -- logical UI target or semantic alias
    duration = 8,
})

-- Dismiss all currently visible hints
Tutorial.DismissAllHints()

-- === Camera &amp; Focus ===

-- Smoothly pan the camera to a position or region
Tutorial.FocusArea(position_or_region, {
    duration = 1.5,                  -- pan duration in seconds
    zoom = 1.0,                      -- optional zoom level (1.0 = default)
    lock = false,                    -- if true, player can't move camera until unlock
})

-- Release a camera lock set by FocusArea
Tutorial.UnlockCamera()

-- === UI Highlighting ===

-- Highlight a UI element with a pulsing glow effect
Tutorial.HighlightUI(element_id, {
    style = "pulse",                 -- "pulse", "arrow", "outline", "dim_others"
    duration = 0,                    -- seconds (0 = until manually cleared)
    text = "Click here",             -- optional tooltip on the highlight
})

-- Clear a specific highlight
Tutorial.ClearHighlight(element_id)

-- Clear all highlights
Tutorial.ClearAllHighlights()

-- === Restrictions (for teaching pacing) ===

-- Disable sidebar/building (player can't construct until enabled)
Tutorial.RestrictSidebar(enabled)

-- Restrict which unit types the player can build
Tutorial.RestrictBuildOptions(allowed_types)  -- e.g., {"power_plant", "barracks"}

-- Restrict which orders the player can issue
Tutorial.RestrictOrders(allowed_orders)  -- e.g., {"move", "stop", "attack"}

-- Clear all restrictions
Tutorial.ClearRestrictions()

-- === Progress Tracking ===

-- Check if the player has demonstrated a skill (from campaign state flags)
local knows_groups = Tutorial.HasSkill("assign_control_group")

-- Get the number of times a specific hint has been shown (from hint_history)
local shown = Tutorial.GetHintShowCount("idle_harvester")

-- Check if a specific Commander School mission has been completed
local passed = Tutorial.IsMissionComplete("tutorial_04")

-- === Callbacks ===

-- Register a callback for when a step completes
-- (also available as the global OnStepComplete function)
Tutorial.OnStepComplete(function(step_id)
    -- step_id is the string passed to SetStep
end)

-- Register a callback for when the player performs a specific action
Tutorial.OnAction(action_name, function(context)
    -- context contains details: { actor = ..., target = ..., position = ... }
end)
</code></pre>
<h4 id="ui-element-ids-and-semantic-aliases-for-highlightui"><a class="header" href="#ui-element-ids-and-semantic-aliases-for-highlightui">UI Element IDs and Semantic Aliases for HighlightUI</a></h4>
<p>The <code>element_id</code> parameter refers to logical UI element names (not internal Bevy entity IDs). These IDs may be:</p>
<ol>
<li><strong>Concrete logical element IDs</strong> (stable names for a specific surface, e.g. <code>attack_move_button</code>)</li>
<li><strong>Semantic UI aliases</strong> resolved by the active layout profile (desktop sidebar vs phone build drawer)</li>
</ol>
<p>This allows a single tutorial step to say “highlight the primary build UI” while the renderer picks the correct widget for <code>ScreenClass::Desktop</code>, <code>ScreenClass::Tablet</code>, or <code>ScreenClass::Phone</code>.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Element ID</th><th>What It Highlights</th></tr>
</thead>
<tbody>
<tr><td><code>sidebar</code></td><td>The entire build sidebar</td></tr>
<tr><td><code>sidebar_building</code></td><td>The building tab of the sidebar</td></tr>
<tr><td><code>sidebar_unit</code></td><td>The unit tab of the sidebar</td></tr>
<tr><td><code>sidebar_item:&lt;type&gt;</code></td><td>A specific buildable item (e.g., <code>sidebar_item:power_plant</code>)</td></tr>
<tr><td><code>build_drawer</code></td><td>Phone build drawer (collapsed/expanded production UI)</td></tr>
<tr><td><code>minimap</code></td><td>The minimap</td></tr>
<tr><td><code>minimap_cluster</code></td><td>Touch minimap cluster (minimap + alerts + bookmark dock)</td></tr>
<tr><td><code>command_bar</code></td><td>The unit command bar (move, stop, attack, etc.)</td></tr>
<tr><td><code>control_group_bar</code></td><td>Bottom control-group strip (desktop or touch)</td></tr>
<tr><td><code>command_rail</code></td><td>Touch command rail (attack-move/guard/force-fire, etc.)</td></tr>
<tr><td><code>command_rail_slot:&lt;action&gt;</code></td><td>Specific touch command-rail slot (e.g., <code>command_rail_slot:attack_move</code>)</td></tr>
<tr><td><code>attack_move_button</code></td><td>The attack-move button specifically</td></tr>
<tr><td><code>deploy_button</code></td><td>The deploy button</td></tr>
<tr><td><code>guard_button</code></td><td>The guard button</td></tr>
<tr><td><code>money_display</code></td><td>The credits/resource counter</td></tr>
<tr><td><code>power_bar</code></td><td>The power supply/demand indicator</td></tr>
<tr><td><code>radar_toggle</code></td><td>The radar on/off button</td></tr>
<tr><td><code>sell_button</code></td><td>The sell (wrench/dollar) button</td></tr>
<tr><td><code>repair_button</code></td><td>The repair button</td></tr>
<tr><td><code>camera_bookmark_dock</code></td><td>Touch bookmark quick dock (phone/tablet minimap cluster)</td></tr>
<tr><td><code>camera_bookmark_slot:&lt;n&gt;</code></td><td>A specific bookmark slot (e.g., <code>camera_bookmark_slot:1</code>)</td></tr>
</tbody>
</table>
</div>
<p>Modders can register custom UI element IDs for custom UI panels via <code>Tutorial.RegisterUIElement(id, description)</code>.</p>
<p><strong>Semantic UI alias examples (built-in):</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Alias</th><th>Desktop</th><th>Tablet</th><th>Phone</th></tr>
</thead>
<tbody>
<tr><td><code>primary_build_ui</code></td><td><code>sidebar</code></td><td><code>sidebar</code></td><td><code>build_drawer</code></td></tr>
<tr><td><code>minimap_cluster</code></td><td><code>minimap</code></td><td><code>minimap</code></td><td><code>minimap</code> (plus bookmark dock/alerts cluster)</td></tr>
<tr><td><code>bottom_control_groups</code></td><td><code>command_bar</code> / HUD bar region</td><td>touch group bar</td><td>touch group bar</td></tr>
<tr><td><code>command_rail_attack_move</code></td><td><code>attack_move_button</code></td><td>command rail A-move slot</td><td>command rail A-move slot</td></tr>
<tr><td><code>tempo_speed_picker</code></td><td>lobby speed dropdown</td><td>same</td><td>mobile speed picker + advisory chip</td></tr>
</tbody>
</table>
</div>
<p>The alias-to-element mapping is provided by the active UI layout profile (<code>ic-ui</code>) and keyed by <code>ScreenClass</code> + <code>InputCapabilities</code>.</p>
<h3 id="tutorial-achievements-d036"><a class="header" href="#tutorial-achievements-d036">Tutorial Achievements (D036)</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Achievement</th><th>Condition</th><th>Icon</th></tr>
</thead>
<tbody>
<tr><td><strong>Graduate</strong></td><td>Complete Commander School (missions 01–09)</td><td>🎓</td></tr>
<tr><td><strong>Honors Graduate</strong></td><td>Complete Commander School with zero retries</td><td>🏅</td></tr>
<tr><td><strong>Quick Study</strong></td><td>Complete Commander School in under 45 minutes total</td><td>⚡</td></tr>
<tr><td><strong>Helping Hand</strong></td><td>Complete a community-made tutorial campaign</td><td>🤝</td></tr>
</tbody>
</table>
</div>
<p>These are engine-defined achievements (not mod-defined). They use the D036 achievement system and sync with Steam achievements for Steam builds.</p>
<h3 id="multiplayer-onboarding"><a class="header" href="#multiplayer-onboarding">Multiplayer Onboarding</a></h3>
<p>First time clicking <strong>Multiplayer</strong> from the main menu, a welcome overlay appears (see <code>17-PLAYER-FLOW.md</code> for the full layout):</p>
<ul>
<li>Explains relay server model (no host advantage)</li>
<li>Suggests: casual game first → ranked → spectate</li>
<li>“Got it, let me play” dismisses permanently</li>
<li>Stored in <code>hint_history</code> as <code>mp_welcome_dismissed</code></li>
</ul>
<p>After the player’s first multiplayer game, a brief overlay explains the post-game stats and rating system if ranked.</p>
<h3 id="modder-tutorial-api--custom-tutorial-campaigns"><a class="header" href="#modder-tutorial-api--custom-tutorial-campaigns">Modder Tutorial API — Custom Tutorial Campaigns</a></h3>
<p>The entire tutorial infrastructure is available to modders. A modder creating a total conversion or a complex mod with novel mechanics can build their own Commander School equivalent:</p>
<ol>
<li><strong>Campaign YAML:</strong> Use <code>category: tutorial</code> in the campaign definition. The campaign appears under <code>Campaign → Tutorial</code> in the main menu.</li>
<li><strong>Tutorial Lua API:</strong> All <code>Tutorial.*</code> functions work in any campaign or scenario, not just the built-in Commander School. Call <code>Tutorial.SetStep()</code>, <code>Tutorial.ShowHint()</code>, <code>Tutorial.HighlightUI()</code>, etc.</li>
<li><strong>Custom hints:</strong> Add a <code>hints.yaml</code> to the mod directory. Hints are merged with the base game hints at load time. Mod hints can reference mod-specific unit types, building types, and actions.</li>
<li><strong>Custom trigger types:</strong> Define custom triggers via Lua using the <code>custom</code> trigger type in <code>hints.yaml</code>, or register a full trigger type via WASM (Tier 3).</li>
<li><strong>Scenario editor modules:</strong> Use the Tutorial Step and Tutorial Hint modules (D038) to build tutorial sequences visually without writing Lua.</li>
</ol>
<h4 id="end-to-end-example-modder-tutorial-campaign"><a class="header" href="#end-to-end-example-modder-tutorial-campaign">End-to-End Example: Modder Tutorial Campaign</a></h4>
<p>A modder creating a “Chrono Warfare” mod with a time-manipulation mechanic wants a 3-mission tutorial introducing the new features:</p>
<pre><code class="language-yaml"># mods/chrono-warfare/campaigns/tutorial/campaign.yaml
campaign:
  id: chrono_tutorial
  title: "Chrono Warfare — Basic Training"
  description: "Learn the new time-manipulation abilities"
  start_mission: chrono_01
  category: tutorial
  requires_mod: chrono-warfare

  missions:
    chrono_01:
      map: missions/chrono-tutorial/01-temporal-basics
      briefing: briefings/chrono-01.yaml
      outcomes:
        pass: { next: chrono_02 }
        skip: { next: chrono_02 }

    chrono_02:
      map: missions/chrono-tutorial/02-chrono-shift
      briefing: briefings/chrono-02.yaml
      outcomes:
        pass: { next: chrono_03 }
        skip: { next: chrono_03 }

    chrono_03:
      map: missions/chrono-tutorial/03-time-bomb
      briefing: briefings/chrono-03.yaml
      outcomes:
        pass: { description: "Training complete" }
</code></pre>
<pre><code class="language-lua">-- mods/chrono-warfare/missions/chrono-tutorial/01-temporal-basics.lua

function OnMissionStart()
    -- Restrict everything except the new mechanic
    Tutorial.RestrictSidebar(true)
    Tutorial.RestrictOrders({"move", "stop", "chrono_freeze"})

    -- Step 1: Introduce the Chrono Freeze ability
    Tutorial.SetStep("learn_freeze", {
        title = "Temporal Freeze",
        hint = "Your Chrono Trooper can freeze enemies in time. " ..
               "Select the trooper and use the Chrono Freeze ability on the enemy tank.",
        focus_area = enemy_tank_position,
        highlight_ui = "sidebar_item:chrono_freeze",
        eva_line = "chrono_tech_available",
        completion = { type = "action", action = "chrono_freeze" }
    })
end

function OnStepComplete(step_id)
    if step_id == "learn_freeze" then
        Tutorial.ShowHint("The enemy tank is frozen in time for 10 seconds. " ..
                          "Frozen units can't move, shoot, or be damaged.", {
            duration = 6,
            position = "near_unit",
        })

        Trigger.AfterDelay(DateTime.Seconds(8), function()
            Tutorial.SetStep("destroy_frozen", {
                title = "Shatter the Frozen",
                hint = "When the freeze ends, the target takes bonus damage for 3 seconds. " ..
                       "Attack the tank right as the freeze expires!",
                completion = { type = "kill", count = 1 }
            })
        end)

    elseif step_id == "destroy_frozen" then
        Campaign.complete("pass")
    end
end
</code></pre>
<pre><code class="language-yaml"># mods/chrono-warfare/hints/chrono-hints.yaml
hints:
  - id: chrono_freeze_ready
    title: "Chrono Freeze Available"
    text: "Your Chrono Trooper's freeze ability is ready. Use it on high-value targets."
    category: mod_specific
    trigger:
      type: building_ready
      building_type: "chrono_trooper"
      ability: "chrono_freeze"
      first_time: true
    suppression:
      mastery_action: use_chrono_freeze
      mastery_threshold: 3
      cooldown_seconds: 0
      max_shows: 1
    experience_profiles: [all]
    priority: high
    position: near_unit
</code></pre>
<h3 id="campaign-pedagogical-pacing-guidelines"><a class="header" href="#campaign-pedagogical-pacing-guidelines">Campaign Pedagogical Pacing Guidelines</a></h3>
<p>For the built-in Allied and Soviet campaigns (not Commander School), IC follows these pacing guidelines to ensure the official campaigns serve as gentle second-layer tutorials:</p>
<ol>
<li><strong>One new mechanic per mission maximum.</strong> Mission 1 introduces movement. Mission 2 adds combat. Mission 3 adds base building. Never two new systems in the same mission.</li>
<li><strong>Tutorial EVA lines for first encounters.</strong> The first time the player builds a new structure type or encounters a new enemy unit type, EVA provides a brief explanation — but only if the player hasn’t completed the relevant Commander School lesson. This is context-sensitive, not a lecture.</li>
<li><strong>Safe-to-fail early missions.</strong> The first 3 missions of each campaign have generous time limits, weak enemies, and no base-building pressure. The player can explore at their own pace.</li>
<li><strong>No mechanic is required without introduction.</strong> If Mission 7 requires naval combat, Mission 6 introduces shipyards in a low-pressure scenario.</li>
<li><strong>Difficulty progression: linear, not spiked.</strong> No “brick wall” missions. If a mission has a significant difficulty increase, it offers a remedial branch (D021 campaign graph).</li>
</ol>
<p>These guidelines apply to modders creating campaigns intended for the <code>category: campaign</code> (not <code>category: tutorial</code>). They’re documented here rather than enforced by the engine — modders can choose to follow or ignore them.</p>
<h3 id="cross-references"><a class="header" href="#cross-references">Cross-References</a></h3>
<ul>
<li><strong>D004 (Lua Scripting):</strong> <code>Tutorial</code> is a Lua global, part of the IC-exclusive API extension set (see <code>04-MODDING.md</code> § IC-exclusive extensions).</li>
<li><strong>D021 (Branching Campaigns):</strong> Commander School’s branching graph (with remedial branches) uses the standard D021 campaign system. Tutorial campaigns are campaigns — they use the same YAML format, Lua API, and campaign graph engine.</li>
<li><strong>D033 (QoL Toggles):</strong> Experience profiles control hint defaults. Individual hint categories are toggleable. The D033 QoL panel exposes hint frequency settings.</li>
<li><strong>D034 (SQLite):</strong> <code>hint_history</code>, <code>player_skill_estimate</code>, and discovery state in <code>player.db</code>. Tip display history also in SQLite.</li>
<li><strong>D036 (Achievements):</strong> Graduate, Honors Graduate, Quick Study, Helping Hand. Engine-defined, Steam-synced.</li>
<li><strong>D038 (Scenario Editor):</strong> Tutorial Step and Tutorial Hint modules enable visual tutorial creation without Lua. See D038’s module library.</li>
<li><strong>D043 (AI Behavior Presets):</strong> Tutorial AI tier sits below Easy difficulty. It’s Lua-scripted per mission, not a general-purpose AI.</li>
<li><strong>D058 (Command Console):</strong> <code>/hints</code> and <code>/discovery</code> console commands for hint management and discovery milestone control.</li>
<li><strong>D031 (Telemetry):</strong> New player pipeline emits <code>onboarding.step</code> telemetry events. Hint shows/dismissals are tracked in <code>gameplay_events</code> for UX analysis.</li>
<li><strong><code>17-PLAYER-FLOW.md</code>:</strong> Full player flow mockups for all five tutorial layers, including the self-identification screen, Commander School entry, multiplayer onboarding, and post-game tips.</li>
<li><strong><code>08-ROADMAP.md</code>:</strong> Phase 3 deliverables (hint system, new player pipeline, progressive discovery), Phase 4 deliverables (Commander School, skill assessment, post-game learning, tutorial achievements).</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../decisions/09f-tools.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../10-PERFORMANCE.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../decisions/09f-tools.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../10-PERFORMANCE.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>

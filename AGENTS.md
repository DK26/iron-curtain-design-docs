# Iron Curtain — Agent Instructions

> This file is the single source of truth for AI agents working on this project.
> Read this first. Navigate to specific design docs only when you need detail on a topic.

## What This Project Is

**Iron Curtain** is a Rust-native RTS engine built for the C&C community but designed to power any classic RTS (D039). Not a port of OpenRA — a clean-sheet redesign that loads OpenRA's assets, mods, and maps while delivering better performance, modding, and multiplayer. The engine ships with **Red Alert** (default) and **Tiberian Dawn** as built-in game modules; RA2, Tiberian Sun, and community-created games are future modules on the same engine (D018). The project is in pre-development (design phase) as of 2026-02.

- **Language:** Rust
- **Framework:** Bevy (ECS, rendering, audio, asset pipeline)
- **Rendering:** wgpu via Bevy
- **Targets:** Windows, macOS, Linux, Browser (WASM), Steam Deck, Mobile (planned)

## Non-Negotiable Architectural Invariants

Violating any of these is a bug. Do not propose designs that break them.

1. **Simulation is pure and deterministic.** No I/O, no floats, no network awareness in `ic-sim`. Takes orders, produces state. Fixed-point math only (`i32`/`i64`, never `f32`/`f64` in game logic). Same inputs → identical outputs on all platforms.

2. **Network model is pluggable via trait.** `GameLoop<N: NetworkModel, I: InputSource>` is generic over both network model and input source. The sim has zero imports from `ic-net`. They share only `ic-protocol`. Swapping lockstep for rollback touches zero sim code.

3. **Modding is tiered: YAML → Lua → WASM.** Each tier is optional and sandboxed. YAML for data (80% of mods), Lua for scripting (missions, abilities), WASM for power users (total conversions). No C# ever. No recompilation.

4. **Bevy is the framework.** ECS scheduling, rendering, asset pipeline, audio. Custom render passes and SIMD only where profiling justifies it. Pin Bevy version per development phase.

5. **Efficiency-first performance.** Better algorithms → cache-friendly ECS → simulation LOD → amortized work → zero-allocation hot paths → THEN multi-core as a bonus. A 2-core 2012 laptop must run 500 units smoothly (sim target). Render quality tiers down automatically on older GPUs (GL 3.3 fallback → no compute shaders, no post-FX, CPU particles). See `10-PERFORMANCE.md` § "GPU & Hardware Compatibility". Do not reach for `par_iter()` before profiling.

6. **Real YAML, not MiniYAML.** Standard `serde_yaml` with inheritance resolved at load time. A `miniyaml2yaml` converter exists for migration. MiniYAML also loads directly at runtime via auto-conversion (D025) — but all IC-native content uses standard YAML.

7. **OpenRA compatibility is at the data/community layer, not the simulation layer.** Same mods, same maps, shared server browser — but NOT bit-identical simulation. We do not port OpenRA bug-for-bug.

8. **Full resource compatibility.** Every `.mix`, `.shp`, `.pal`, `.aud`, `.oramap`, and YAML rule file from Red Alert and OpenRA must load correctly. The community's existing work is sacred.

9. **Engine core is game-agnostic.** No game-specific enums, resource types, or unit categories in engine core. Positions are 3D (`WorldPos { x, y, z }`). `CellPos` is a game-module convenience for grid-based games, not an engine-core requirement. System pipeline is registered per game module, not hardcoded. Renderer uses a `Renderable` trait. Pathfinding uses a `Pathfinder` trait. Spatial queries use a `SpatialIndex` trait. RA1 sets z=0, registers sprite rendering, multi-layer hybrid pathfinding, and spatial hash — but the engine doesn't know that.

10. **Platform-agnostic by design.** Input is abstracted behind `InputSource` trait (not hardcoded to mouse/keyboard). UI layout is responsive (adapts to screen size via `ScreenClass`). No raw `std::fs` — all assets go through Bevy's asset system. Render quality is runtime-configurable. App lifecycle (suspend/resume) uses sim snapshots. The architecture must not create obstacles for any platform: desktop, browser, mobile, console.

## Crate Structure

```
iron-curtain/
├── ra-formats     # .mix, .shp, .pal, YAML parsing, MiniYAML converter (C&C-specific, keeps ra- prefix)
├── ic-protocol    # PlayerOrder, TimestampedOrder, OrderCodec trait (SHARED boundary)
├── ic-sim         # Deterministic simulation (Bevy FixedUpdate systems)
├── ic-net         # NetworkModel trait + implementations (Bevy plugins)
├── ic-render      # Isometric rendering, shaders, post-FX (Bevy plugin)
├── ic-ui          # Game chrome: sidebar, minimap, build queue (Bevy UI)
├── ic-editor      # SDK: scenario editor, asset studio, campaign editor, Game Master mode (D038+D040, Bevy app)
├── ic-audio       # .aud playback, EVA, music (Bevy audio plugin)
├── ic-script      # Lua + WASM mod runtimes
├── ic-ai          # Skirmish AI, mission scripting
├── ic-llm         # LLM mission/campaign generation, asset generation, adaptive difficulty
└── ic-game        # Top-level Bevy App, ties all game plugins together (NO editor code)
```

> **Naming convention (D039):** Engine crates use `ic-*` (Iron Curtain) to reflect the game-agnostic identity. Exception: `ra-formats` keeps its `ra-` prefix because it reads C&C-family file formats specifically.

**Critical boundaries:**
- `ic-sim` NEVER imports from `ic-net`. `ic-net` NEVER imports from `ic-sim`. They only share `ic-protocol`.
- `ic-game` NEVER imports from `ic-editor`. The game and SDK are separate binaries that share library crates.

## Key Design Decisions (Summary)

These are settled. Don't re-litigate unless the user explicitly wants to revisit one.

| ID   | Decision                                                     | Rationale                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ---- | ------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| D001 | Rust                                                         | No GC, memory safety, WASM target, no competition in Rust RTS space                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| D002 | Bevy (revised from "No Bevy")                                | ECS is our architecture; saves 2-4 months of engine plumbing; plugin system fits pluggable networking                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| D003 | Real YAML, not MiniYAML                                      | `serde_yaml` gives typed deserialization; standard tooling; no custom parser                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| D004 | Lua for scripting (not Python)                               | Tiny runtime, deterministic, sandboxable, industry standard; Python has GC, float non-determinism, unsandboxable                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| D005 | WASM for power mods                                          | Near-native perf, perfectly sandboxed, deterministic, polyglot (Rust/C/Go/AssemblyScript)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| D006 | Pluggable networking via trait                               | Clean sim/net boundary, testable with `LocalNetwork`, community can contribute netcode independently                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| D007 | Relay server as default multiplayer                          | Blocks lag switches, enables sub-tick ordering, NAT traversal, signed replays, cheap to run                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| D008 | Sub-tick timestamps on orders                                | CS2-inspired; fairer edge cases (two players competing for same resource); trivial to implement                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| D009 | Fixed-point math, no floats in sim                           | Required for deterministic lockstep; original RA used integer math; proven approach                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| D010 | Snapshottable sim state                                      | Enables: save games, replays, desync debugging, rollback netcode, cross-engine reconciliation, automated testing                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| D011 | Cross-engine = community layer, not sim layer                | Bit-identical sim is impractical; shared server browser/maps/mods is valuable and achievable                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| D012 | Order validation inside sim                                  | Deterministic validation = all clients agree on rejections; validation IS anti-cheat                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| D013 | Pathfinding via `Pathfinder` trait, multi-layer hybrid first | Trait-abstracted like `NetworkModel`; `IcPathfinder` (JPS + flowfield tiles + ORCA-lite) is RA1 impl; engine core never calls algorithm-specific functions; navmesh slots in without touching sim                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| D014 | Tera templating (Phase 6a, nice-to-have)                     | Eliminates copy-paste for faction variants and bulk generation; load-time only (zero runtime cost); ~50 lines to integrate; optional                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| D015 | Efficiency-first, not thread-first                           | Algorithmic efficiency → cache layout → sim LOD → amortize → zero-alloc → THEN parallelism                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| D016 | LLM-generated missions (Phase 7, optional)                   | Optional BYOLLM enhancement; output is standard YAML+Lua; `ic-llm` crate is optional; game is fully functional without any LLM provider configured; enhances experience, never required                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| D017 | Bevy rendering pipeline                                      | Classic isometric base; post-processing, dynamic lighting, GPU particles, shader effects available as modding infrastructure, not base game goals                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| D018 | Multi-game extensibility (game modules)                      | Engine is game-agnostic; RA1 ships as default module, TD alongside it; RA2/custom are future community goals (not scheduled); `GameModule` trait bundles systems, pathfinder, spatial index, fog, damage resolver, order validator, renderer, experience profiles, render modes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| D019 | Switchable balance presets                                   | Classic RA (default) vs OpenRA vs Remastered; YAML rule sets selectable in lobby; not a mod, a game option                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| D020 | Mod SDK & Creative Toolchain                                 | `ic` CLI (headless mod workflow) + IC SDK application (visual tools: scenario editor, asset studio, campaign editor, Game Master mode); SDK is a separate binary from the game; `ic sdk` launches visual tools, `ic mod *` for CLI workflow                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| D021 | Branching campaigns with persistent state                    | Campaign graph (not linear), named outcomes, unit roster/veterancy/equipment carry over; OFP-inspired                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| D022 | Dynamic weather with terrain surface effects                 | Weather state machine + per-cell terrain surface state; snow/rain/sun change terrain textures; deterministic sim                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| D023 | OpenRA vocabulary compatibility layer                        | Accept OpenRA trait names as YAML aliases; both `Armament` and `combat` resolve to same component; zero migration friction for YAML mods                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| D024 | Lua API superset of OpenRA                                   | IC Lua API is a strict superset of OpenRA's 16 globals; same names, same signatures; OpenRA Lua missions run unmodified                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| D025 | Runtime MiniYAML loading                                     | MiniYAML loads directly at runtime (auto-converts in memory); `miniyaml2yaml` CLI optional, not prerequisite                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| D026 | OpenRA mod manifest compatibility                            | Parse OpenRA `mod.yaml` manifests; point IC at OpenRA mod dir and it loads; `ic mod import` for clean migration                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| D027 | Canonical enum compatibility with OpenRA                     | Match OpenRA's locomotor/armor/target/stance enum names exactly; Versus tables copy-paste without translation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| D028 | Condition & multiplier systems (Phase 2 hard req)            | Condition system + multiplier system + full damage pipeline are Phase 2 exit criteria, not deferred gaps                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| D029 | Cross-game component library (Phase 2)                       | 7 first-party systems (mind control, carriers, teleport, shields, upgrades, delayed weapons, dual assets) are Phase 2 targets; high priority but can slip to early Phase 3 without blocking (D028 is the hard gate)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| D030 | Workshop resource registry & dependency system               | Artifactory-inspired universal resource repository; any asset type publishable individually; semver deps, lockfile, SHA-256 integrity, license required, promotion channels, LLM discovery; federated multi-source with local/remote/virtual repos; CI/CD-friendly publishing with scoped API tokens; Steam Workshop as optional source; in-game browser with search/ratings/reviews; auto-download on lobby join (CS:GO-style); creator reputation system; DMCA/takedown policy with due process; **author AI consent** (`ai_usage` field — allow/metadata_only/deny, separate from license) controls how LLM agents interact with resources; LLM-friendly metadata (`LlmResourceMeta` with content descriptions, resource relationships, composition sets) enables intelligent discovery; **Phased delivery:** minimal Workshop (central server + publish + browse + auto-download) ships Phase 4–5; federation and advanced features in Phase 6a+                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| D031 | Observability & telemetry (OTEL)                             | All servers + engine emit OTEL metrics/traces/logs; zero-cost when disabled; gameplay event stream for AI training; distributed tracing for desync debugging; pre-built Grafana dashboards for self-hosters                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| D032 | Switchable UI themes (main menu, chrome, lobby)              | YAML-driven theme system with built-in presets (Classic/Remastered/Modern); original art inspired by each era's aesthetic; shellmap live backgrounds; per-game-module defaults; community themes via workshop (D030); pairs with D019 balance presets                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| D033 | Toggleable QoL & gameplay behavior presets                   | Every QoL feature from OpenRA/Remastered individually toggleable; built-in presets (Vanilla/OpenRA/Remastered/Iron Curtain); sim-affecting toggles synced in lobby, client-only toggles per-player; experience profiles combine D019+D032+D033+D043+D045+D048                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| D034 | SQLite as embedded storage (services + client)               | `rusqlite` for all persistent state: relay match history, workshop registry, matchmaking ratings, client replay/save/asset indices, gameplay event logs; player-facing analytics (post-game stats, career page, campaign dashboard); when LLM provider configured, `ic-llm` reads player history for personalized missions/briefings/coaching (D016); `ic-ai` reads match history for adaptive difficulty; preserves "just a binary" deployment; no external DB; FTS5 for search; WAL for concurrent reads; WASM-compatible; ad-hoc SQL investigation without OTEL stack                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| D035 | Creator recognition — voluntary tipping & attribution        | Optional tip links in resource metadata; IC never processes payments; links to Ko-fi/Patreon/GitHub Sponsors; no mandatory paywalls on mods (lesson from Skyrim paid mods, ArmA gray zone); infrastructure sustainability via donations + hosting sponsors + optional premium relay tiers                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| D036 | Achievement system                                           | Per-game-module achievements stored in SQLite (D034); built-in achievement infrastructure + campaign achievements in Phase 3; mod-defined achievements via YAML + Lua triggers in Phase 6b; categories: campaign/competitive/exploration/community/modding; Steam achievement sync for Steam builds; no achievements that incentivize griefing                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| D037 | Community governance & platform stewardship                  | Transparent governance with defined roles (maintainers, Workshop moderators, competitive committee, game module stewards, community representatives); RFC process for major decisions; self-hosting independence (no single point of failure); code of conduct; seasonal competitive map pool curation; community-elected representatives with term limits                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| D038 | Scenario editor (OFP/Eden-inspired, SDK)                     | Visual editor for maps AND mission logic; part of the IC SDK (separate application from the game — D040); OFP/Eden-inspired with Simple/Advanced mode; includes campaign editor, Game Master mode, co-op scenario tools, game mode templates; `ic-editor` crate; see `09-DECISIONS.md` § D038 for full design                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| D039 | Engine scope — general-purpose classic RTS platform          | Built for C&C, open to anything; engine crates use `ic-*` naming (except `ra-formats`); ships RA1+TD; non-C&C is architectural capability, not deliverable; C&C remains primary target, roadmap, and compatibility focus                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| D040 | Asset Studio — visual resource editor & generation           | Part of IC SDK; visual browser/viewer/editor for game assets (sprites, palettes, terrain, chrome, 3D models); format-aware (reads/writes C&C formats via ra-formats); cross-game format bridge (.shp/.vxl/.w3d); agentic LLM generation (BYOLLM, Phase 7) for non-artists; chrome/theme visual designer (D032); see `09-DECISIONS.md` § D040                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| D041 | Trait-abstracted subsystem strategy                          | Extends D006/D013 pattern to 5 more subsystems: `AiStrategy` (pluggable AI decision-making), `FogProvider` (pluggable fog of war), `DamageResolver` (pluggable damage pipeline), `RankingProvider` (pluggable rating algorithm), `OrderValidator` (engine-enforced validation); abstract algorithms, not data; zero-overhead via monomorphization; `AiStrategy` includes event callbacks, parameter introspection, engine scaling opt-out, and `AiEventLog` — a fog-filtered event accumulator that any AI can use and that D044 LLM AI consumes as its primary context source                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| D042 | Player behavioral profiles & training system                 | Black-box gameplay event logs (D031) aggregated into `PlayerStyleProfile` per player; `StyleDrivenAi` (`AiStrategy` impl, D041) mimics a specific player's tendencies; quick training mode (no editor required); "Challenge My Weakness" flow; iterative training loop with progress tracking in SQLite (D034); LLM coaching optional (D016); opponent profiles built from local replays only (privacy-first)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| D043 | AI behavior presets (Classic RA, OpenRA, IC Default)         | Switchable AI behavioral styles paralleling D019 balance presets; Classic RA mimics original AI quirks, OpenRA matches its skirmish AI, IC Default is research-informed (Spring Engine, 0 A.D., MicroRTS, academic RTS AI); presets are YAML configs for `PersonalityDrivenAi` (D041); **IC Default implementation**: priority-based manager hierarchy (EconomyManager/ProductionManager/MilitaryManager/AiState), share-based unit composition, influence-map building placement, Lanchester-inspired threat scoring, tick-gated evaluation, fuzzy engagement logic — all techniques validated across surveyed projects (see `research/rts-ai-implementation-survey.md`); integrates into experience profiles (D019+D032+D033+D043+D045+D048); **two-axis difficulty system**: engine-level scaling (resource bonuses, reaction delays — inspired by 0 A.D. + AoE2) separate from implementation-level behavioral params, with opt-out for sophisticated AIs; **modder-selectable and modder-provided** — mods declare which `AiStrategy` to use, Tier 3 WASM mods can implement custom `AiStrategy` trait implementations and distribute via Workshop (D030); modder-addable difficulty levels via YAML (Tier 1); community AI presets and implementations via Workshop; `AiStrategy` trait includes event callbacks (Spring/BWAPI pattern), parameter introspection (MicroRTS pattern), and engine scaling opt-out (AoE2 pattern); see `research/rts-ai-extensibility-survey.md` for extensibility analysis, `research/rts-ai-implementation-survey.md` for decision-making implementation analysis |
| D044 | LLM-enhanced AI (Orchestrator + experimental LLM Player)     | Two new `AiStrategy` implementations: `LlmOrchestratorAi` wraps any existing AI with periodic LLM strategic consultations (async, no latency impact, BYOLLM D016), `LlmPlayerAi` is experimental full LLM control (every decision by LLM); both use `AiEventLog` (D041) as fog-filtered event narrative — the "inner game event log" the LLM reads to understand game state without exposing fog-of-war secrets; orchestrator forwards D041 event callbacks to inner AI + accumulates for LLM prompts; translates `StrategicPlan` into `set_parameter()` calls on inner AI; integrates with D043 two-axis difficulty (orchestrator delegates to inner AI, LLM Player accepts engine scaling); neither allowed in ranked; prompt templates are moddable YAML; architecture doesn't constrain future full-LLM-control as models improve                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| D045 | Pathfinding behavior presets (movement feel)                 | Switchable movement behavior as separate `Pathfinder` trait implementations (D013): `RemastersPathfinder` (from EA Remastered Collection GPL source), `OpenRaPathfinder` (from OpenRA), `IcPathfinder` (IC multi-layer hybrid: JPS + flowfield tiles + ORCA-lite avoidance); progressive disclosure UX (experience profile → per-axis override → parameter tuning); scenarios can require specific pathfinder; sim-affecting (synced in multiplayer); integrates into experience profiles; **modder-selectable and modder-provided** — mods declare which pathfinder they use, Tier 3 WASM mods can implement custom `Pathfinder` trait implementations and distribute via Workshop (D030); Generals-style `LayeredGridPathfinder` is a concrete community example                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| D046 | Community platform — premium content & platform integration  | Extends D035: verified publishers (e.g., EA) can sell premium cosmetic/supplementary content via Workshop; gameplay-affecting paid content prohibited; comprehensive platform services (`PlatformServices` trait) for Steam/GOG/Epic (achievements, friends, cloud saves, overlay, invites); all platforms play together; DRM-free always; backend monetization via publisher fees + premium relay tier + donations                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| D047 | LLM Configuration Manager                                    | Dedicated UI for managing multiple LLM providers with task-specific routing (fast local model for AI orchestrator, quality cloud model for mission generation); community-shareable configs via Workshop (D030) — API keys never exported; achievement integration (D036); SQLite storage (D034) with encrypted API keys; extends D016 BYOLLM with proper UX                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| D048 | Switchable render modes (Classic/HD/3D toggle)               | Render modes as a first-class concept — bundles render backend (`Renderable` impl), camera (`ScreenToWorld` impl), resource pack selection, and visual config into a named, instantly-switchable unit. Game modules register multiple modes; F1 cycles between them (Remastered-style). Same-backend switch (Classic↔HD) is single-frame; cross-backend switch (2D↔3D) loads on first toggle, instant thereafter. Cross-view multiplayer: players use different render modes in the same game. Mods can add render modes (e.g., 3D view) alongside built-in modes. Integrates into experience profiles (D019+D032+D033+D043+D045+D048)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| D049 | Workshop asset formats & P2P distribution                    | Bevy-native modern formats (OGG, PNG, WAV, WebM, KTX2, GLTF) are canonical for new Workshop content; C&C legacy formats (.aud, .shp, .vqa) fully supported for backward compat but not recommended for distribution. Workshop delivery uses BitTorrent/WebTorrent protocol for large packages (>5MB) with HTTP fallback — reduces hosting from CDN costs ($50-450/month per popular mod) to tracker VPS ($5-20/month). `.icpkg` package format (ZIP with `manifest.yaml`). **Git-hosted package index** (`workshop-index` GitHub repo) as Phase 0–3 Workshop: YAML manifests per package, `index.yaml` consolidated listing fetched via HTTP, `.icpkg` files on GitHub Releases (free CDN), community contributes via PR. `git-index` source type in Workshop client alongside `local`/`remote`. Proven pattern (Homebrew, crates.io-index, Winget, Nixpkgs). Official storage servers added later as entries in `sources.yaml` — zero architecture change. Phase 3-4 adds BitTorrent tracker. Phase 4-5: full Workshop server (search, ratings, deps). SHA-256 integrity (D030) provides P2P verification. WebTorrent enables browser-to-browser P2P (WASM compat). Blizzard used same approach for WoW/SC2 patches.                                                                                                                                                                                                                                                                                                                                                                                  |
| D050 | Workshop as cross-project reusable library                   | Workshop core (registry, P2P distribution, federation, integrity) is a standalone, engine-agnostic, game-agnostic Rust library. IC is the first consumer; planned future consumers include XCOM-inspired tactics clone, Civilization-inspired 4X clone, Operation Flashpoint/ArmA-inspired military sim. Two-layer architecture: core library (packages, manifests, publisher identity, dependencies, BitTorrent/WebTorrent, federation, auth) has zero engine dependency; game integration layer (per-project) adds engine plugin, format recommendations, auto-download triggers, project-specific manifest extensions (`game_module`, `engine_version`), CLI wrapping, and deployment configuration. Package extension configurable (`.icpkg` is IC's default). Resource categories are free-form tags, not a hardcoded enum. P2P peer scoring dimension `LobbyContext` generalized to `ApplicationContext` — any project injects its own context-aware peer prioritization. Cross-project infrastructure sharing possible: shared trackers, seed boxes, git-index hosting, even cross-project dependencies. Format recommendations are per-project (D049's Bevy-native table is IC-specific guidance). Non-Bevy engines supported — library has no Bevy dependency; C FFI or CLI integration for non-Rust consumers                                                                                                                                                                                                                                                                                |

## Pending Decisions

| ID   | Topic                                                                      | Needs Resolution By |
| ---- | -------------------------------------------------------------------------- | ------------------- |
| P002 | Fixed-point scale (256? 1024? match OpenRA's 1024?)                        | Phase 2 start       |
| P003 | Audio library choice + music integration design (see `09-DECISIONS.md`)    | Phase 3 start       |
| P004 | Lobby/matchmaking protocol specifics                                       | Phase 5 start       |
| P005 | ~~Map editor architecture~~ — RESOLVED: Scenario editor in SDK (D038+D040) | Resolved            |
| P006 | License (GPL v3 vs MIT/Apache — see tension analysis in `09-DECISIONS.md`) | Phase 0 start       |

## Development Roadmap (36 Months)

```
Phase 0 (Months 1-3)   → Foundation: ra-formats, parse all OpenRA/RA assets, miniyaml2yaml, runtime MiniYAML + alias loading (D023/D025/D026)
Phase 1 (Months 3-6)   → Rendering: Bevy isometric renderer, map loading, visual showcase
Phase 2 (Months 6-12)  → Simulation: ECS sim, movement/combat/harvesting, replay system [CRITICAL]
Phase 3 (Months 12-16) → Game Chrome: sidebar, build queues, audio, first "playable" skirmish
Phase 4 (Months 16-20) → AI & Single Player: Lua scripting, WASM runtime, campaign missions
Phase 5 (Months 20-26) → Multiplayer: lockstep, relay server, desync diagnosis, shared browser
Phase 6a (Months 26-30) → Core Modding + Scenario Editor: full mod compat, in-engine scenario editor (D038), full workshop registry (D030)
Phase 6b (Months 30-34) → Campaign Editor + Game Modes: campaign graph editor, game mode templates, co-op scenario tools, Game Master mode
Phase 7  (Months 34-36) → LLM Missions + Ecosystem + Polish: mission generator, visual effects, ecosystem polish, browser build
```

## Performance Targets

| Metric              | 2-core laptop | 8-core desktop | 16-core workstation | Mobile (phone/tablet) | Browser (WASM) |
| ------------------- | ------------- | -------------- | ------------------- | --------------------- | -------------- |
| Smooth battle       | 500 units     | 2000 units     | 3000+ units         | 200 units             | 300 units      |
| Tick time           | < 40ms        | < 10ms         | < 5ms               | < 50ms                | < 40ms         |
| Render FPS          | 60            | 144            | 240                 | 30                    | 60             |
| RAM (1000 units)    | < 150MB       | < 200MB        | < 200MB             | < 100MB               | < 100MB        |
| Per-tick allocation | 0 bytes       | 0 bytes        | 0 bytes             | 0 bytes               | 0 bytes        |

## Performance Efficiency Pyramid (in order of impact)

1. **Algorithmic** — Multi-layer hybrid pathfinding (JPS + flowfield tiles for mass movement, 10x over per-unit A*), spatial hash (125x over brute-force range checks), hierarchical sector graph
2. **Cache layout** — Hot/warm/cold ECS component separation; hot data (pos+vel+health) fits L1
3. **Simulation LOD** — Full/Reduced/Minimal processing per unit based on game state (not camera)
4. **Amortized work** — Stagger expensive systems: path replan every 4-8 ticks, fog every 1-4 ticks
5. **Zero-allocation** — Pre-allocated `TickScratch` buffers, `.clear()` not `.new()`, zero heap churn
6. **Work-stealing** — rayon via Bevy for costly independent systems (pathfinding yes, movement no)

## Simulation Architecture

- **Deterministic tick:** `Simulation::apply_tick(&mut self, orders: &TickOrders)` — pure function
- **System order (fixed per game module, documented):** RA1 default (21 systems): apply_orders → power → production → harvesting → docking → support_powers → movement → crush → mines → combat → projectiles → capture → cloak → conditions → veterancy → death → crates → transform → triggers → notifications → fog. Other game modules register their own pipeline.
- **Pathfinding and spatial queries are trait-abstracted:** `Pathfinder` trait (multi-layer hybrid for RA1, navmesh for future modules) and `SpatialIndex` trait (spatial hash for RA1, BVH for future modules). Engine core calls traits, never algorithm-specific functions.
- **Five additional subsystems are trait-abstracted (D041):** `AiStrategy` (pluggable AI decision-making), `FogProvider` (pluggable fog of war), `DamageResolver` (pluggable damage pipeline resolution), `RankingProvider` (pluggable matchmaking ratings), `OrderValidator` (engine-enforced order validation per game module). Same philosophy as `NetworkModel`/`Pathfinder`: one trait, one default impl, zero overhead.
- **State hashing:** `state_hash()` every tick for desync detection
- **Snapshots:** `snapshot()` / `restore()` for save games, replays, rollback, desync debugging
- **Order validation:** Every order validated deterministically inside sim before execution (ownership, affordability, prerequisites, placement)

## ECS Component Model (maps from OpenRA Traits)

| OpenRA Trait | ECS Component                       | Purpose                                          |
| ------------ | ----------------------------------- | ------------------------------------------------ |
| Health       | `Health { current, max }`           | Hit points                                       |
| Mobile       | `Mobile { speed, locomotor }`       | Can move                                         |
| Attackable   | `Attackable { armor }`              | Can be damaged                                   |
| Armament     | `Armament { weapon, cooldown }`     | Can attack                                       |
| Building     | `Building { footprint }`            | Occupies cells                                   |
| Buildable    | `Buildable { cost, time, prereqs }` | Can be built                                     |
| Selectable   | `Selectable { bounds, priority }`   | Player can select                                |
| Harvester    | `Harvester { capacity, resource }`  | Gathers ore                                      |
| *(any)*      | `LlmMeta { summary, role, … }`      | LLM-readable context (optional on all resources) |

These are the **RA1 game module's** core components. The full RA1 module registers ~50 additional components — see `02-ARCHITECTURE.md` § "Extended Gameplay Systems (RA1 Module)" for complete definitions including power, transport, capture, stealth, infantry mechanics, veterancy, death, docking, crush, mines, crates, guard, transform, support powers, building mechanics, notifications, cursors, hotkeys, faction, encyclopedia, localization, and more. Other game modules (RA2, TD) register their own additional components — the ECS is open for extension.

> **Design status:** All ~30 gameplay systems identified in the gap analysis (`src/11-OPENRA-FEATURES.md`) are now designed with full component definitions, Rust struct signatures, YAML examples, and system logic descriptions. See the Priority Assessment tables in `src/11-OPENRA-FEATURES.md` for implementation order. The mapping table in that file shows every OpenRA trait's IC equivalent.

## Network Models

Iron Curtain **ships** one netcode: relay-assisted deterministic lockstep with sub-tick order fairness. `LockstepNetwork` and `RelayLockstepNetwork` implement the same protocol — the difference is topology. The `NetworkModel` trait is deliberately pluggable (D006) — the community can contribute entirely different netcode without touching sim code. The last three rows are future first-party architectures; third-party implementations are also possible.

| Implementation            | What It Is                                | When Used                      | Phase  |
| ------------------------- | ----------------------------------------- | ------------------------------ | ------ |
| `LocalNetwork`            | Pass-through — orders go straight to sim  | Single player, automated tests | 2      |
| `ReplayPlayback`          | File reader — feeds saved orders into sim | Watching replays               | 2      |
| `LockstepNetwork`         | P2P deployment (same protocol, no relay)  | LAN, ≤3 players, direct IP     | 5      |
| `RelayLockstepNetwork`    | Relay deployment (recommended for online) | Internet multiplayer, ranked   | 5      |
| `FogAuthoritativeNetwork` | Server runs full sim, partial visibility  | Anti-maphack (future arch)     | Future |
| `RollbackNetwork`         | GGPO-style prediction + rollback          | Experimental (future arch)     | Future |
| `ProtocolAdapter<N>`      | Cross-engine wire format translation      | OpenRA interop (future arch)   | Future |

**Connection methods** (below `NetworkModel`, transport-layer): direct IP, join codes (rendezvous + hole-punch), QR codes, relay fallback. See `src/03-NETCODE.md`.

**Tracking servers** (`TrackingServer` trait): game directory for discovery. Official + community-hosted + OpenRA shared browser. Not a relay — no game data flows through it.

**Backend infrastructure:** Both tracking servers and relay servers are stateless, containerized Rust binaries. Ship as container images with docker-compose.yaml (community self-hosting) and Helm charts (k8s). Federation — client aggregates listings from multiple tracking servers. No single point of failure. Community self-hosting is a first-class use case. See `src/03-NETCODE.md` § "Backend Infrastructure".

**Multi-player scaling:** Architecture supports N players. Relay server recommended for 4+. No hard player limit — practical limit is sim cost (more players = more units) and input delay (worst connection dominates). Team games, FFA, and spectators all supported.

## Security Model

- **Maphack:** Architectural limit in lockstep (all clients have full state). Partial mitigation via memory obfuscation. Real fix: fog-authoritative server.
- **Order injection:** Deterministic validation in sim rejects impossible orders. Relay server also validates.
- **Order forgery (P2P):** Ed25519 per-order signing with ephemeral session keys. Relay mode: relay stamps orders with authenticated sender slot.
- **Lag switch:** Relay server owns the clock. Miss the window → orders dropped. Strikes system.
- **Speed hack:** Relay owns tick cadence — client clock irrelevant.
- **State saturation:** Three-layer rate control — time-budget pool (`OrderBudget`, from Minetest's LagPool) + bandwidth throttle + hard cap (`ProtocolLimits.max_orders_per_tick`) + relay bandwidth arbitration prevent any single player from flooding the order pipeline. Based on Bryant & Saiedian (2021) attack taxonomy.
- **Transport encryption:** DTLS 1.3 / TLS 1.3 for all game traffic. Never custom crypto. Generals used XOR with a fixed key — cautionary example.
- **Protocol hardening:** `BoundedReader` with remaining-bytes tracking, hard size caps on all fields, per-connection memory budgets. Inspired by Generals source code analysis (receive-side parsers had zero bounds checking). See `research/rts-netcode-security-vulnerabilities.md`.
- **Automation/botting:** Relay-side behavioral analysis (APM patterns, reaction times, input entropy). Detection, not prevention. No kernel-level anti-cheat.
- **Match result fraud:** `CertifiedMatchResult` signed by relay server. Only signed results update rankings.
- **Replay tampering:** Ed25519-signed hash chain.
- **WASM mods:** Capability-based API. No `get_all_units()` — only `get_visible_units()`. No filesystem/network access by default.
- **Workshop supply chain:** Defense-in-depth against compromised mod updates (fractureiser lesson). Build provenance, update anomaly detection, 2FA for publishers, scoped API tokens, `ic.lock` pinning, security advisory system. See `src/06-SECURITY.md` § Vulnerability 18.

## Competitive Infrastructure

- **Ranked matchmaking:** Glicko-2 ratings, seasonal leagues, placement matches, per-queue ratings (1v1, 2v2, FFA)
- **Leaderboards:** global, per-faction, per-map, per-game-module
- **Tournament mode:** observer with broadcast delay, bracket API, relay-certified results, server-side replay archive
- **Competitive map pool:** curated per season, community-nominated
- **Competitive committee (D037):** community-elected body curating seasonal map pools and competitive rule sets
- **Competitive achievements (D036):** ranked placement, league promotion, season finish, tournament participation
- **No kernel-level anti-cheat.** Open-source, cross-platform. Architectural defenses only.

## Cross-Engine Compatibility Strategy

NOT bit-identical simulation. Progressive levels:
- **Level 0:** Shared server browser (same community, different executables)
- **Level 1:** Replay viewing (decode OpenRA replays, watch with drift)
- **Level 2:** Casual cross-play with periodic resync (rubber-banding acceptable)
- **Level 3:** Embedded headless OpenRA sim as authority (prediction + reconciliation)
- **Level 4:** True lockstep (effectively a port — probably never)

Built-in seams for future interop: `OrderCodec` trait, `CoordTransform`, `SimReconciler` trait, `ProtocolAdapter<N>`.

## File Formats (ra-formats crate)

**Binary:** `.mix` (archives), `.shp` (sprites), `.tmp` (terrain), `.pal` (palettes), `.aud` (audio), `.vqa` (video)
**Text:** `.ini` (original RA), MiniYAML (OpenRA), YAML (ours), `.oramap` (OpenRA maps, ZIP)

Key insight from EA source: original uses `OutList`/`DoList` pattern for order queuing — same as our `PlayerOrder → TickOrders → apply_tick()`. Integer math everywhere for determinism. LZO compression for save games.

## Document Navigation

When you need deeper detail, read the specific design doc:

| Topic                                                                                                                                  | Read                        |
| -------------------------------------------------------------------------------------------------------------------------------------- | --------------------------- |
| Goals, competitive landscape, why this exists                                                                                          | `src/01-VISION.md`          |
| Crate structure, ECS, sim/render split, game loop, UI themes                                                                           | `src/02-ARCHITECTURE.md`    |
| NetworkModel trait, relay server, CS2 sub-tick, lockstep, adaptive run-ahead                                                           | `src/03-NETCODE.md`         |
| YAML rules, Lua scripting, WASM modules, sandboxing, LLM metadata, Mod SDK, resource packs                                             | `src/04-MODDING.md`         |
| File formats, EA source code insights, coordinate systems                                                                              | `src/05-FORMATS.md`         |
| Threat model, maphack, order validation, replay signing, transport encryption, protocol hardening                                      | `src/06-SECURITY.md`        |
| Cross-engine play, OrderCodec, SimReconciler, ProtocolAdapter                                                                          | `src/07-CROSS-ENGINE.md`    |
| 36-month phased roadmap with exit criteria                                                                                             | `src/08-ROADMAP.md`         |
| Full decision log with rationale and alternatives                                                                                      | `src/09-DECISIONS.md`       |
| Efficiency pyramid, profiling, performance targets, benchmarks                                                                         | `src/10-PERFORMANCE.md`     |
| OpenRA feature catalog (~700 traits), gap analysis, migration mapping                                                                  | `src/11-OPENRA-FEATURES.md` |
| Combined Arms mod migration, Remastered recreation feasibility                                                                         | `src/12-MOD-MIGRATION.md`   |
| Development philosophy, design review principles, lessons from C&C creators and OpenRA                                                 | `src/13-PHILOSOPHY.md`      |
| Development methodology, stages from research to release, context-bounded work units, research rigor & AI-assisted design, agent rules | `src/14-METHODOLOGY.md`     |

## Legal Protections

### Trademark Disclaimer

Red Alert, Tiberian Dawn, Command & Conquer, and C&C are trademarks of Electronic Arts Inc. Iron Curtain is **not** affiliated with, endorsed by, or sponsored by Electronic Arts. These names are used solely to identify the games and formats the engine is designed to be compatible with (nominative fair use). This disclaimer MUST appear in `README.md` and MUST NOT be removed or weakened.

When writing public-facing text that references EA game titles:
- Use the trademark name to identify the game, not as if IC *is* that game
- Never imply EA endorsement, sponsorship, or partnership
- Do not use EA logos or proprietary art assets
- "Red Alert game module" or "compatibility with Red Alert" — not "our Red Alert"

### Asset Distribution Policy

Iron Curtain does **not** distribute any copyrighted game assets (sprites, audio, video, music). The engine loads assets from games users already own — the same model as OpenRA, Wargus, and other open-source engine reimplementations. This is a non-negotiable legal boundary.

- Never commit copyrighted EA assets to any IC repository
- Theme art (D032) must be original creations — never copied from EA or OpenRA
- Format codecs in `ra-formats` reference EA's GPL-licensed source code — this is legal use under GPL. Write support uses the same GPL source as reference
- Workshop resources are user-submitted with mandatory SPDX licensing — IC is not liable for user-uploaded content

### Design Documentation License

All files in `src/` and `research/` are licensed under **CC BY-SA 4.0** (Creative Commons Attribution-ShareAlike 4.0 International). This is separate from the engine code license (P006, unresolved).

### Contributor License

Before accepting code contributions from external contributors, the project requires a **Developer Certificate of Origin (DCO)** — a lightweight attestation that the contributor has the right to submit the code and agrees to the project's license. This follows the same model as the Linux kernel, Bevy, and most Rust ecosystem projects.

**How it works:**
- Contributors add a `Signed-off-by: Name <email>` line to their commit messages (`git commit -s`)
- This certifies compliance with the [DCO v1.1](https://developercertificate.org/)
- A CI check (`DCO bot`) verifies all commits in a PR carry the sign-off
- No legal paperwork, no CLA forms — just a commit trailer

**Why DCO over CLA:** CLAs (Contributor License Agreements) grant the project additional rights (like relicensing) but create friction and distrust. DCO is the community-friendly standard. If P006 needs to be resolved via relicense later, that decision can be made then with contributor consent.

### Privacy & Data Protection

Any IC software that collects, processes, or stores user data must comply with these principles:

- **Local-first by default.** Telemetry, match history, behavioral profiles, and replay data stay on the user's machine unless they explicitly opt in to sharing.
- **No PII in telemetry.** Player IDs are anonymized (hashed). No real names, email addresses, or IP addresses in gameplay telemetry.
- **Right to deletion.** Any server-side data (Workshop profiles, match history, leaderboards) must be deletable on user request. Design a `delete-my-data` endpoint.
- **Data portability.** Users can export their data (match history, replays, Workshop profile) in a standard format.
- **GDPR compliance.** Before deploying any server that processes EU user data, publish a Privacy Policy covering: what data is collected, lawful basis, retention period, third-party sharing, and user rights. See GDPR Articles 13-14 (transparency), 17 (right to erasure), 20 (portability).
- **Relay server data minimization.** The relay processes IP addresses and game traffic. Retain connection logs only as long as needed for abuse prevention; purge after the configured retention window.

### Workshop Legal Requirements

- **Minimum age:** Workshop accounts require users to be 13 years or older (COPPA compliance). Age verification at account creation. No Workshop accounts for users under 13.
- **Third-party content disclaimer:** IC is not liable for Workshop content. Resources are provided by their respective authors under their declared licenses. The platform provides hosting infrastructure, not editorial approval.
- **DMCA safe harbor:** The Workshop operates under DMCA safe harbor provisions. See `src/09-DECISIONS.md` § D030 for the full takedown/counter-claim process.

## Working With This Codebase

### Version Control
- **Never run `git commit`, `git push`, or any command that creates or modifies commits.** A commit is the maintainer's signature that the changes are correct. Only the maintainer can make that determination. Agents edit files; the maintainer reviews, commits, and pushes.
- You may run read-only git commands (`git status`, `git diff`, `git log`, etc.) to understand the current state of the repository.

### mdbook
- **Never run `mdbook build`, `mdbook serve`, or any mdbook command.** The book is built manually by the maintainer when ready. Only edit the markdown source files in `src/`.
- **When linking to design docs from public-facing files (README, etc.), use the hosted mdbook URL:** `https://dk26.github.io/iron-curtain-design-docs/`. Link to `.html` pages (e.g., `01-VISION.html`), not the raw `src/*.md` source files.

### Code Style
- Idiomatic Rust. Use `clippy` and `rustfmt`.
- Prefer zero-allocation patterns in hot paths. Use `Vec::clear()` over `Vec::new()`.
- No floats in `ic-sim`. Fixed-point only.
- Every public type in `ic-sim` must derive `Serialize, Deserialize` (for snapshots).
- System execution order in `ic-sim` is fixed and documented. Adding a new system requires deciding where in the order it runs and documenting why.

### When Adding a New Feature
1. Check `src/09-DECISIONS.md` — has this been decided already?
2. Check the roadmap (`src/08-ROADMAP.md`) — which phase does this belong to?
3. Respect the crate boundaries — especially `ic-sim` ↔ `ic-net` via `ic-protocol` only.
4. If it touches performance, read `src/10-PERFORMANCE.md` and follow the efficiency pyramid (algorithm first, threading last).
5. If it touches networking, ensure the sim remains unaware — work through the `NetworkModel` trait.
6. If it touches modding, respect the tiered model and sandbox constraints.
7. Consider community impact — does this address a known pain point or create new friction? Check `src/01-VISION.md` for documented community needs and `src/11-OPENRA-FEATURES.md` for the gap analysis. Treat community feedback as a design input, not an afterthought.
8. If adding a new resource type (unit, weapon, structure, map), consider including an `llm:` metadata block with `summary`, `role`, and `tactical_notes`. This metadata is always optional — resources work without it. See `src/04-MODDING.md` § "LLM-Readable Resource Metadata".

### Design & Code Review Philosophy

All design and code review should be guided by — but not limited to — the development philosophy documented in `src/13-PHILOSOPHY.md` and the community context documented in `src/01-VISION.md` and `src/11-OPENRA-FEATURES.md`. The philosophy chapter compiles the publicly-stated principles of the original C&C creators (Joe Bostic, Brett Sperry, Louis Castle, Frank Klepacki, and others) and the OpenRA team. The community context documents known pain points, feature gaps, and what the C&C community actually needs. Full quotes and source material are in `research/westwood-ea-development-philosophy.md`.

Key review principles drawn from the original creators:

0. **"Is this the game the community actually wants?"** — The community wants to play Red Alert — the real thing, not a diminished version — forever, on anything, with anyone, and to make it their own. Every design decision, every architecture choice, every feature proposal must answer this question first. If it doesn't serve a playable game that real people want to play, it needs strong justification. See `src/01-VISION.md` § "What Makes People Actually Switch".
1. **"Does this make the toy soldiers come alive?"** (Bostic) — Every feature should serve the core fantasy. If it doesn't, it needs strong justification.
2. **Fun beats documentation** (Bostic) — If something plays well but contradicts the design doc, update the doc. If it's in the doc but plays poorly, cut it.
3. **Separate simulation from I/O** (EA source code) — The sim is the part that survives decades. Keep it pure. Rendering and networking are replaceable.
4. **Data-driven everything** (Westwood INI philosophy) — Game values belong in YAML, not code. If a modder would want to change it, it shouldn't require recompilation.
5. **Encourage experimentation** (Klepacki) — Write good work first, then adapt for constraints. Don't pre-optimize into mediocrity.
6. **Great teams make great games** (Long) — Team dynamics matter more than individual technical skill. Documentation, clear invariants, and respectful collaboration enable great teams.
7. **Scope to what you have** (Legg) — Two less-than-excellent systems are worse than one excellent system. Each phase should focus.
8. **Make temporary compromises explicit** (OpenRA lesson) — Label experiments as experiments. Use toggles (D033) so early-phase decisions don't become irrevocable identity.
10. **Build with the community, not just for them** — Community pain points (OpenRA issue tracker, modder feedback, competitive player needs) are primary design inputs. Before finalizing a decision, ask: *"How does this affect the people who will actually use this?"* Check `src/01-VISION.md` and `src/11-OPENRA-FEATURES.md`.

Game design principles (highlights — full list with rationale in `src/13-PHILOSOPHY.md`):

11. **Immediate feedback — the one-second rule** (Castle) — Every player action produces audible and visible feedback within one second. Silence is a UX bug.
12. **Visual clarity** (Castle) — One-second screenshot test: who's winning, what's on screen, where are the resources? Readability beats aesthetics.
14. **Asymmetric faction identity** (Westwood) — Factions must feel like different games, not stat reskins. Balance through counter-play, not stat parity.
15. **The core loop: Extract → Build → Amass → Crush** (Westwood/EA) — Every game feature should serve one of these steps. Features that bypass the loop need strong justification.

Modding ecosystem principles (from industry lessons — see `src/13-PHILOSOPHY.md` and `src/04-MODDING.md`):

19. **Build for surprise** (WC3/DotA lesson) — The modding system should be powerful enough that modders can create things the engine developers never imagined. Expose primitives, not just parameterized behaviors. If the API can only produce "variations on what shipped," it's too narrow.

These are guidelines, not a rigid checklist. Keep an open mind — the original creators themselves discovered their best ideas by iterating, not by following specifications. When a design decision feels uncertain, the philosophy doc provides grounding but should never prevent innovation.

### Handling External Feedback & Reviews

When someone provides feedback on a design doc — whether from a reviewer, community member, or automated analysis — treat it as input, not instruction. Validate every claim before acting on it.

**Process:**

1. **Verify the factual claim.** Read the text being criticized. Is the reviewer's characterization accurate? If they say "the no-LLM path can't do X," check whether the text actually claims it can. Don't fix things that aren't broken.
2. **Evaluate against project architecture.** Does the suggested fix respect crate boundaries, invariants, and the patterns documented in this file? A fix that introduces a hard dependency between crates that should be decoupled is worse than the original problem.
3. **Assess scope fit.** Is this feedback about *this* section, or does it belong in a different design doc / decision? Don't fix D031 problems inside D038 text. Flag cross-cutting concerns but fix them where they live.
4. **Push back when the fix is imprecise.** If the reviewer's suggested change is directionally correct but too broad, too narrow, or technically wrong, apply the *intent* with better precision. Document what you changed and why it differs from the suggestion.
5. **Accept, adapt, or defer — and be explicit about which.**
   - **Accept:** The feedback is correct and the fix is straightforward. Apply it.
   - **Adapt:** The feedback identifies a real problem but the suggested fix isn't right. Fix the problem differently and explain why.
   - **Defer:** The feedback is valid but belongs to a different phase, doc, or scope. Acknowledge it without making changes.
6. **Classify severity honestly.** Not all feedback is equal. A factual inaccuracy (text claims something the system can't do) is higher priority than a tone preference. An architectural violation (missing crate boundary) is higher priority than a wording nitpick.

**What to watch for:**

- **"This can't do what the text claims"** — highest priority. If the no-LLM path is described as generating human-readable names but has no semantic understanding to do so, that's a factual error. Fix it immediately.
- **"This silently promises something it doesn't cover"** — add explicit scope boundaries. State what the initial implementation targets and what's deferred. Never let silence imply completeness.
- **"The tone is too salesy / too vague / too dramatic"** — legitimate in a design doc. Design docs are technical artifacts, not marketing. Direct statements beat italicized rhetoric.
- **"The crate boundary is unclear"** — always worth fixing. Every cross-crate interaction should name the trait, which crate defines it, which implements it, and which wires them together (usually `ic-game`).
- **"This detail is Phase 7, leave it vague"** — acceptable. Don't over-design features that are 30+ months out. A placeholder sentence is fine.

**What NOT to do:**

- Don't accept all feedback uncritically. Reviewers can be wrong, imprecise, or optimizing for concerns that don't apply to this project.
- Don't reject feedback defensively. If three people flag the same paragraph, the paragraph has a problem even if no individual critique is perfectly worded.
- Don't make changes without reading the current text first. External edits may have occurred between review and fix.

### Known Duplication to Fix
- Performance details appear in both `src/09-DECISIONS.md` (D015) and `src/10-PERFORMANCE.md` — the latter is canonical

### Mistakes to Never Repeat
These are specific errors made by agents on this project. Read them before editing any public-facing file.

1. **Agent wrote "design documents are complete" and "implementation beginning" in README.** Neither was true — design is in progress, no code exists. Never declare project status. Only the maintainer decides that.

2. **Agent added author name to FOREWORD.md and README.md but forgot `book.toml` and `00-INDEX.md`.** User had to point out each missing file. When a change touches multiple files, scan all of them first: `AGENTS.md`, `README.md`, `book.toml`, `src/00-INDEX.md`, `src/SUMMARY.md`, `src/FOREWORD.md`, and any design doc that references the topic. Update everything in one pass.

3. **README used present tense for features that don't exist:** "loads your existing OpenRA mods," "your OpenRA mods just work," "eliminates lag switching," "runs headless for AI training." Nothing is implemented. Use future tense: "will load," "designed to," "targets."

4. **README Resource Compatibility table used ✅ checkmarks for planned features.** ✅ means "done." Nothing is done. Use phase numbers or "planned" labels instead.

5. **FOREWORD used jargon a non-technical reader would need to Google:** "borrow checker," "ECS," "dangling pointers," "segfaults," "use-after-free," "buffer overflows," "data races," "GC pauses," "memory layout," "runtime overhead." Public-facing docs should explain what Rust *does for the user* (fast, safe, reliable), not compiler internals. Technical terms belong in `src/01-VISION.md` through `src/12-MOD-MIGRATION.md`.

6. **Don't romanticize the project or dramatize the author's voice.** The author's tone is direct and honest. Avoid motivational-speaker copy — no "love letters," no dramatic origin stories, no rallying cries. State things plainly.

7. **Don't infer relationships between facts the author shares.** If two things are mentioned separately, don't imply they happened simultaneously, are causally linked, or share a timeline unless the author explicitly says so.

8. **Be honest about what competing projects can do.** Don't downplay or dismiss features of OpenRA or other projects to make Iron Curtain look better. If a competitor does something well, say so accurately.

9. **README architecture diagram showed 8 crates when AGENTS.md lists 11.** Missing: `ic-protocol` (the most critical shared boundary), `ic-audio`, `ic-game`. Diagrams and tables derived from AGENTS.md must match it exactly — if AGENTS.md lists 11 crates, the README diagram shows 11 crates. If P006 lists 3 license options, the README license section mentions all 3.

10. **Docs stated unverified performance numbers and architecture claims about OpenRA and the Remastered Collection as fact.** Example: "Stutters at 300-500 units," "30-60ms tick time," "~2-4KB per unit," "fixed rendering pipeline," "SDL/OpenGL basic rendering." None of these were benchmarked or cited. When comparing to competitors: (a) state what is verified from source code, (b) label estimates as estimates, (c) cite issue tracker numbers when claiming bug frequency, (d) don't speculate about internal architecture unless you've read the code.

### Reference Material

These are the projects we actively study. Each serves a different purpose:

- **EA Red Alert source:** https://github.com/electronicarts/CnC_Red_Alert (GPL v3) — **Canonical gameplay values.** Damage tables, weapon ranges, unit speeds, fire rates. When OpenRA and EA source disagree, EA source wins for our `classic` balance preset. Also: `OutList`/`DoList` order pattern, integer math validation.
- **EA Remastered Collection:** https://github.com/electronicarts/CnC_Remastered_Collection — **UI/UX gold standard.** Source is GPL v3 but covers ONLY the C++ engine DLLs (`TiberianDawn.dll`, `RedAlert.dll`) and Map Editor. The remaster's networking and rendering layers are proprietary C# (not open-sourced). Art/audio/video assets are proprietary EA — users must own the game. Language breakdown: 84% C++, 9% C#, 5% C, 2% Assembly. The C++ engine runs as a headless sim DLL called synchronously by the C# client (`Glyphx_Queue_AI()` bypasses all original networking). Original rendering is software-to-RAM, intercepted via `DLL_Draw_Intercept` for GPU rendering by the C# layer.
- **EA Generals / Zero Hour source:** https://github.com/electronicarts/CnC_Generals_Zero_Hour (GPL v3) — **Netcode reference.** Most sophisticated C&C networking codebase (~500KB). UDP lockstep with adaptive run-ahead (adjusts input delay based on latency AND client FPS), three-state frame readiness with automatic resend, delta-compressed TLV wire format, packet router (star topology — validates our relay server design D007), disconnect blame attribution via pings, debug network simulation tools. See `research/generals-zero-hour-netcode-analysis.md` for full analysis.
- **EA Tiberian Dawn source:** https://github.com/electronicarts/CnC_Tiberian_Dawn — **Shared C&C engine lineage.** Cross-reference with RA source for ambiguous behavior. Future TD game module reference.
- **OpenRA:** https://github.com/OpenRA/OpenRA — **Architecture and UX patterns** (trait system, command interface, mod ecosystem). Also: **issue tracker as community pain point radar** — recurring complaints = our design opportunities. Do NOT copy their unit balance (see D019). **Verified netcode facts:** TCP-based lockstep with server relay (not P2P). Single-threaded game loop with background network I/O threads. Static `OrderLatency` (dynamic buffering is a TODO). Per-frame CRC sync hashing via `[VerifySync]` attribute and runtime IL-generated hash functions. Sync report buffer only 7 frames deep (recurring pain point). 135+ desync issues in tracker. NAT traversal via UPnP/NAT-PMP (`Mono.Nat`). No anti-cheat beyond order ownership validation. March 2025 release added post-processing effects.
- **OpenRA Mod SDK:** https://github.com/OpenRA/OpenRAModSDK — **Mod developer experience reference.** Template repo approach, engine version pinning, packaging pipeline, directory conventions. Studied for D020 (`ic` CLI tool). Pain points we solve: C# requirement, MiniYAML, GPL contamination, no workshop, no hot-reload.
- **Chrono Divide** (TypeScript browser RTS) — architecture reference for WASM target.
- **Stratagus:** https://github.com/Wargus/stratagus (GPL-2.0) — **Game-agnostic RTS engine architecture + Lua AI scripting reference.** C++ engine powering Wargus (WC2), Stargus (SC), War1gus (WC1). Deep Lua integration: `DefineAi()` + step-function AI scripts, force composition targets (`AiForce`), resource ratio allocation (`AiSetCollect`), event callbacks (`AiHelpMe`, `AiUnitKilled`), per-player speed multipliers for difficulty scaling, selective Lua stdlib loading (security), external AI via TCP socket for ML training (`AiProcessorSetup`). Independently confirms D043 manager hierarchy, D041 event callbacks, D043 two-axis difficulty. Priority-based manager pipeline: Script → Units → Resources → Forces → Magic. See `research/stratagus-stargus-opencraft-analysis.md`.
- **Stargus:** https://github.com/Wargus/stargus — **Data extraction + Kaitai Struct reference.** StarCraft data importer for Stratagus. Uses Kaitai Struct (`.ksy` schemas) for formal binary format parsing of StarCraft `.dat` files. Archive abstraction layer (MPQ/CASC/directory). Incomplete/unmaintained but demonstrates format-as-schema approach relevant to `ra-formats`.
